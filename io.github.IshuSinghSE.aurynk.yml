app-id: io.github.IshuSinghSE.aurynk
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
command: aurynk

finish-args:
  # Set scrcpy server path
  - --env=SCRCPY_SERVER_PATH=/app/share/scrcpy/scrcpy-server
  # X11 + XShm access
  - --share=ipc
  - --socket=fallback-x11
  # Wayland access
  - --socket=wayland
  # Network access for ADB wireless
  - --share=network
  # D-Bus access for notifications and system tray
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.ayatana.indicator.service
  # USB device access for ADB
  - --device=all

cleanup:
  - /include
  - /lib/pkgconfig
  - /man
  - /share/doc
  - /share/gtk-doc
  - /share/man
  - /share/pkgconfig
  - '*.la'
  - '*.a'

modules:
  - name: python3-meson-python-pycairo
    buildsystem: simple
    cleanup:
      - "*"
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} meson-python pyproject-metadata
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/28/58/66db620a8a7ccb32633de9f403fe49f1b63c68ca94e5c340ec5cceeb9821/meson_python-0.18.0-py3-none-any.whl
        sha256: 3b0fe051551cc238f5febb873247c0949cd60ded556efa130aa57021804868e2
      - type: file
        url: https://files.pythonhosted.org/packages/7e/b1/8e63033b259e0a4e40dd1ec4a9fee17718016845048b43a36ec67d62e6fe/pyproject_metadata-0.9.1-py3-none-any.whl
        sha256: ee5efde548c3ed9b75a354fc319d5afd25e9585fa918a34f62f904cc731973ad

  - name: python3-poetry-core
    buildsystem: simple
    cleanup:
      - "*"
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} poetry-core
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c7/d8/bb2f602f5e012e177e1c8560125f9770945d36622595990cf1cb794477c2/poetry_core-2.2.1-py3-none-any.whl
        sha256: bdfce710edc10bfcf9ab35041605c480829be4ab23f5bc01202cfe5db8f125ab

  - python-dependencies.json

  - name: adb
    buildsystem: simple
    only-arches: [x86_64]
    build-commands:
      - install -D adb /app/bin/adb
    sources:
      - type: archive
        url: https://dl.google.com/android/repository/platform-tools_r34.0.5-linux.zip
        sha256: 362f8f6218af0f4c61e5aaafb8e255a426c7a0ee00127dfab7371775081d3124

  # Use upstream shared-modules for Ayatana AppIndicator
  - shared-modules/libayatana-appindicator/libayatana-appindicator-gtk3.json

  # scrcpy - use pre-built binary on x86_64, build from source on aarch64
  - name: scrcpy
    buildsystem: simple
    build-commands:
      - |
        if [ "${FLATPAK_ARCH}" = "x86_64" ]; then
          # Install pre-built binary for x86_64
          cd scrcpy-linux-x86_64-v3.3.3
          install -Dm755 scrcpy /app/bin/scrcpy
          install -Dm644 scrcpy-server /app/share/scrcpy/scrcpy-server
        else
          # Build from source for other architectures
          install -Dm644 scrcpy-server /app/share/scrcpy/scrcpy-server
          meson setup builddir --prefix=/app -Dprebuilt_server=/app/share/scrcpy/scrcpy-server
          ninja -C builddir
          ninja -C builddir install
        fi
    sources:
      - type: archive
        url: https://github.com/Genymobile/scrcpy/releases/download/v3.3.3/scrcpy-linux-x86_64-v3.3.3.tar.gz
        sha256: 9b30e813e8191329ba8025dc80cb0f198fb0a318960a3b5c15395cf675c9c638
        only-arches: [x86_64]
      - type: archive
        url: https://github.com/Genymobile/scrcpy/archive/refs/tags/v3.3.3.tar.gz
        sha256: 87fcd360a6bb6ca070ffd217bd33b33fb808b0a1572b464da51dde3fd3f6f60e
        except-arches: [x86_64]
      - type: file
        url: https://github.com/Genymobile/scrcpy/releases/download/v3.3.3/scrcpy-server-v3.3.3
        sha256: 7e70323ba7f259649dd4acce97ac4fefbae8102b2c6d91e2e7be613fd5354be0
        dest-filename: scrcpy-server

  # Main application
  - name: aurynk
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/IshuSinghSE/aurynk/releases/download/v1.0.3/aurynk-1.0.3.tar.gz
        sha256: 571ab63ece57768fa62ade8325ff5074b9b60ccb1c9d6008beba1adec95c0326