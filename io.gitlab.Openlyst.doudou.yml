app-id: io.gitlab.Openlyst.doudou
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: doudou

finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --share=network
  - --device=dri

modules:
  - name: libass
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: https://github.com/libass/libass/releases/download/0.17.1/libass-0.17.1.tar.xz
        sha256: f0da0bbfba476c16ae3e1cfd862256d30915911f7abaa1b16ce62ee653192784

  - name: libplacebo
    buildsystem: meson
    config-opts:
      - -Dvulkan=enabled
      - -Dshaderc=disabled
      - -Dglslang=disabled
      - -Ddemos=false
    sources:
      - type: git
        url: https://code.videolan.org/videolan/libplacebo.git
        tag: v6.338.2
        commit: 64c1954570f1cd57f8570a57e51fb0249b57bb90

  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dlibmpv=true
      - -Dcplayer=true
      - -Dbuild-date=false
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.39.0.tar.gz
        sha256: 2ca92437affb62c2b559b4419ea4785c70d023590500e8a52e95ea3ab4554683
    cleanup:
      - /share/applications
      - /share/icons
      - /share/zsh

  - name: doudou
    buildsystem: simple
    build-commands:
      - install -d /app/bin
      - install -d /app/lib/doudou
      - install -d /app/lib/doudou/lib
      - install -d /app/lib/doudou/data

      - install -Dm755 linux/x64/release/bundle/doudou /app/lib/doudou/doudou
      - cp -r linux/x64/release/bundle/lib/* /app/lib/doudou/lib/
      - cp -r linux/x64/release/bundle/data/* /app/lib/doudou/data/

      - install -Dm644 io.gitlab.Openlyst.doudou.desktop /app/share/applications/io.gitlab.Openlyst.doudou.desktop
      - install -Dm644 io.gitlab.Openlyst.doudou.metainfo.xml /app/share/metainfo/io.gitlab.Openlyst.doudou.metainfo.xml
      - install -Dm644 doudou.svg /app/share/icons/hicolor/scalable/apps/io.gitlab.Openlyst.doudou.svg

      - install -Dm755 doudou-wrapper.sh /app/bin/doudou

    sources:
      - type: archive
        url: https://gitlab.com/Openlyst/doudou/-/jobs/12497814357/artifacts/download
        sha256: ee2e8337b7d9bb5c025b352d4e52a7583d11c3010a4c0c57925640849942ee0e
        dest-filename: artifacts.zip
      - type: file
        url: https://gitlab.com/Openlyst/doudou/-/raw/878e3d32a9a10cd0b8a227b8c8601adf4d2a984e/packaging/linux/io.gitlab.Openlyst.doudou.desktop
        sha256: 2c52cac9129ae86f607d9e8351989621fe0d5487ffc59b6f876b8c09149d84d2
      - type: file
        url: https://gitlab.com/Openlyst/doudou/-/raw/878e3d32a9a10cd0b8a227b8c8601adf4d2a984e/packaging/linux/io.gitlab.Openlyst.doudou.metainfo.xml
        sha256: 324828b23dc7ed87006160b0e158091b66224c31c304310aa9be58ef720b1b6f
      - type: file
        url: https://gitlab.com/Openlyst/doudou/-/raw/878e3d32a9a10cd0b8a227b8c8601adf4d2a984e/assets/icons/doudou.svg
        sha256: 68fd03baa25bc09ba72fd3f4bbd4185003ac3d78e970e39abd10b5100e0808cc
      - type: script
        dest-filename: doudou-wrapper.sh
        commands:
          - export LD_LIBRARY_PATH="/app/lib:/app/lib/doudou/lib:$LD_LIBRARY_PATH"
          - exec /app/lib/doudou/doudou "$@"
