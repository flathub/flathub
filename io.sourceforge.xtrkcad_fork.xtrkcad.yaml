id: io.sourceforge.xtrkcad_fork.xtrkcad
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: run-xtrkcad.sh

finish-args:
  - --socket=x11
  - --socket=cups
  - --socket=pulseaudio
  - --share=ipc
  - --device=dri
  - --filesystem=home

modules:
  - name: libzip
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_DOC=OFF
      - -DBUILD_EXAMPLES=OFF
      - -DBUILD_REGRESS=OFF
      - -DBUILD_TOOLS=OFF
      - -DBUILD_OSSFUZZ=OFF
      - -DBUILD_SHARED_LIBS=OFF
      - -DENABLE_COMMONCRYPTO=OFF
      - -DENABLE_GNUTLS=OFF
      - -DENABLE_MBEDTLS=OFF
      - -DENABLE_OPENSSL=OFF
      - -DENABLE_WINDOWS_CRYPTO=OFF
      - -DENABLE_BZIP2=OFF
      - -DENABLE_LZMA=OFF
      - -DENABLE_ZSTD=OFF
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5
    sources:
      - type: archive
        url: https://github.com/nih-at/libzip/releases/download/v1.8.0/libzip-1.8.0.tar.gz
        sha256: 30ee55868c0a698d3c600492f2bea4eb62c53849bcf696d21af5eb65f3f3839e
    cleanup:
      - '*'

  - shared-modules/gtk2/gtk2.json

  - name: fake-inkscape
    buildsystem: simple
    sources:
      - type: script
        dest-filename: inkscape
        commands:
          - |
            rsvg-convert $*
    build-commands:
      - install -Dm755 inkscape /app/bin/inkscape
    cleanup:
      - '*'

  - name: xtrkcad
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://download.sourceforge.net/project/xtrkcad-fork/XTrackCad/Version%205.3.1/xtrkcad-source-5.3.1GA.tar.gz
        sha256: 5b02a0352c23f90b0011029c7e2c3f12a6f6779425c4c47c1f75d6b8a0db572c
      - type: patch
        paths:
          - patches/common_source.sh.patch
          - patches/run-xtrkcad.sh.patch
          - patches/xtrkcad.desktop.patch
          - patches/xtrkcad.metainfo.xml.patch
          - patches/xtrkcad_logo_128x128.svg.patch
    builddir: true
    post-install:
      - |
        install -Dm644 /app/share/xtrkcad/pixmaps/xtrkcad.png /app/share/icons/hicolor/64x64/apps/io.sourceforge.xtrkcad_fork.xtrkcad.png
        # makes presumption that builddir (when true) is subdirectory of source dir
        install -Dm755 ../distribution/flatpak/common_source.sh /app/bin/common_source.sh
        install -Dm755 ../distribution/flatpak/run-xtrkcad.sh /app/bin/run-xtrkcad.sh
        install -Dm644 ../distribution/flatpak/xtrkcad.desktop /app/share/applications/io.sourceforge.xtrkcad_fork.xtrkcad.desktop
        install -Dm644 ../distribution/flatpak/xtrkcad.metainfo.xml /app/share/metainfo/io.sourceforge.xtrkcad_fork.xtrkcad.metainfo.xml
        rsvg-convert -h 128 -o xtrkcad_logo_128x128.png ../distribution/flatpak/xtrkcad_logo_128x128.svg
        install -Dm644 xtrkcad_logo_128x128.png /app/share/icons/hicolor/128x128/apps/io.sourceforge.xtrkcad_fork.xtrkcad.png
    cleanup:
      - xtrkcad_logo_128x128.png
