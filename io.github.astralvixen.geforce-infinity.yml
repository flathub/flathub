id: io.github.astralvixen.geforce-infinity
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: "24.08"
sdk-extensions:
    - org.freedesktop.Sdk.Extension.node22

command: geforce-infinity

build-options:
    env:
        PATH: /usr/lib/sdk/node22/bin:/app/bin:/usr/bin

finish-args:
    - --share=network
    - --share=ipc
    - --device=dri
    - --socket=wayland
    - --socket=fallback-x11
    - --socket=pulseaudio
    - --system-talk-name=org.freedesktop.UPower # Silences start up errors from Chromium related to /run/dbus/system_bus_socket
    - --filesystem=xdg-run/discord-ipc-0
    - --filesystem=xdg-run/discord

modules:
    - name: geforce-infinity
      buildsystem: simple
      build-options:
          env:
              XDG_CACHE_HOME: /run/build/geforce-infinity/flatpak-node/cache
              npm_config_cache: /run/build/geforce-infinity/flatpak-node/npm-cache
              npm_config_offline: "true"
      build-commands:
          - HOME=$PWD yarn config --offline set yarn-offline-mirror $FLATPAK_BUILDER_BUILDDIR/flatpak-node/yarn-mirror
          - yarn --offline install
          - yarn --offline build:css
          - NODE_ENV=production yarn --offline esbuild src/overlay/index.tsx --bundle --outdir=dist/overlay --format=esm --target=esnext --external:electron --splitting --minify
          - yarn --offline build:electron
          - yarn --offline cpx 'src/assets/**/*' dist/assets
          - . flatpak-node/electron-builder-arch-args.sh; yarn --offline run electron-builder --dir --linux $ELECTRON_BUILDER_ARCH_ARGS
          - cp -a builds/linux*unpacked $FLATPAK_DEST/geforce-infinity
          - install -Dm 644 "flatpak/icon.png" "${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png"
          - install -Dm 644 "flatpak/${FLATPAK_ID}.metainfo.xml" "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
          - install -Dm 755 "geforce-infinity.sh" "/app/bin/geforce-infinity"
          - install -Dm 644 "flatpak/${FLATPAK_ID}.desktop" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"

      sources:
          - type: git
            url: https://github.com/guihkx/GeForce-Infinity.git
            commit: 3cd80767c7d7fdc3d12f4e85d1789cc180047b4d
            # tag: 1.1.1
            x-checker-data:
                type: git
                tag-pattern: ^([\d.]+)$

          - generated-sources.json

          - type: script
            dest-filename: geforce-infinity.sh
            commands:
                - |
                    export TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID"
                    exec zypak-wrapper /app/geforce-infinity/geforce-infinity "$@"
