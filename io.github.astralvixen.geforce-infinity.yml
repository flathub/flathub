id: io.github.astralvixen.geforce-infinity
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: "24.08"
sdk-extensions:
    - org.freedesktop.Sdk.Extension.node22

command: geforce-infinity

build-options:
    env:
        PATH: /usr/lib/sdk/node22/bin:/app/bin:/usr/bin

finish-args:
    - --share=network
    - --share=ipc
    - --device=dri
    - --socket=wayland
    - --socket=fallback-x11
    - --socket=pulseaudio
    - --filesystem=xdg-run/discord-ipc-0
    - --filesystem=xdg-run/discord

modules:
    - name: geforce-infinity
      buildsystem: simple
      build-options:
          env:
              XDG_CACHE_HOME: /run/build/geforce-infinity/flatpak-node/cache
      build-commands:
          - |
              HOME=$PWD yarn config --offline set yarn-offline-mirror $FLATPAK_BUILDER_BUILDDIR/flatpak-node/yarn-mirror
              unzip geforce-infinity.zip
              mv GeForce-Infinity-1.1.1/* .
              yarn --offline
              yarn run --offline build-flatpak -- $ELECTRON_BUILDER_ARCH_ARGS
              cp -a dist/linux*unpacked $FLATPAK_DEST/main
              install -Dm 644 "icon.png" "${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png"
              install -Dm 644 "${FLATPAK_ID}.metainfo.xml" "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
              install -Dm 755 "geforce-infinity.sh" "/app/bin/geforce-infinity"
              install -Dm 644 "${FLATPAK_ID}.desktop" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"

      sources:
          - type: file
            url: https://github.com/AstralVixen/GeForce-Infinity/archive/refs/tags/1.1.1.zip
            dest-filename: geforce-infinity.zip
            sha256: 0a6caa2e362a532c4aa6eb0818a2695d0c222568923213de2273f0747dc2d4c7
            x-checker-data:
                type: json
                url: https://api.github.com/repos/AstralVixen/GeForce-Infinity/releases/latest
                version-query: .tag_name | sub("^v"; "")
                url-query: .assets[] | select(.name=="GeForceInfinity-linux-" + $version + "-x64.zip") | .browser_download_url

          - type: script
            dest-filename: geforce-infinity.sh
            commands:
                - |
                    export TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID"
                    exec zypak-wrapper /app/geforce-infinity/geforce-infinity "$@"
          - type: file
            url: https://raw.githubusercontent.com/AstralVixen/GeForce-Infinity/e2ede34acc5e3b44e52208fd83914d29e387600e/flatpak/icon.png
            dest-filename: icon.png
            sha256: 46fa7f81542f8fa25aa6c91ef4c630e8a9eab5bdfb2f00363528e44d4d031f49
          - type: file
            url: https://raw.githubusercontent.com/AstralVixen/GeForce-Infinity/e2ede34acc5e3b44e52208fd83914d29e387600e/flatpak/io.github.astralvixen.geforce-infinity.desktop
            dest-filename: io.github.astralvixen.geforce-infinity.desktop
            sha256: b5311254754cd4db3b3207c2a2ab8f8998392c9268d443125daf8b05aa6187c8
          - type: file
            url: https://raw.githubusercontent.com/AstralVixen/GeForce-Infinity/e2ede34acc5e3b44e52208fd83914d29e387600e/flatpak/io.github.astralvixen.geforce-infinity.metainfo.xml
            dest-filename: io.github.astralvixen.geforce-infinity.metainfo.xml
            sha256: 4585404e10d5e402d7814fdaa8ffd61b21441ec5c6b9a6e9476cc8e81be1074f
          - generated-sources.json
