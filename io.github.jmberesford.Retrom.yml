id: io.github.jmberesford.Retrom

runtime: org.gnome.Platform
runtime-version: "49"
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node22

command: Retrom
finish-args:
  # Permissions required for launching user-configured emulators/launchers on host via flatpak-spawn
  - --talk-name=org.freedesktop.Flatpak

  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc # Needed for performance reasons if the app fallbacks to X11
  - --socket=pulseaudio # Permissions required for emulator audio
  - --device=all # Need 'input' for gamepad support, but ubuntu flatpak version is old so this is a workaround

  # Permissions required for managing+launching user's game library and finding emulator executables on host
  - --filesystem=host-os

  # Permissions required for managing metadata (covers etc) from external providers, and for accessing optional remote dedicated Retrom server
  - --share=network

  - --env=FLATPAK=1

build-options:
  append-path: /usr/lib/sdk/node22/bin:/usr/lib/sdk/rust-stable/bin:/run/build/retrom/cargo/bin

modules:
  - name: retrom
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/JMBeresford/retrom
        tag: "v0.7.47"
        commit: "7852a2805aedc476083109be82b1ef39cfa913eb"

      # Static web assets
      - type: archive
        url: https://github.com/JMBeresford/retrom/releases/download/v0.7.47/desktop-frontend-dist_ubuntu-24.04.tar.gz
        sha256: "9af1f4b3134b8c09148c9df9bffaacc4a3a2b044b5c719139145b1579af9d268"
        strip-components: 0
        only-arches:
          - x86_64

      - type: archive
        url: https://github.com/JMBeresford/retrom/releases/download/v0.7.47/desktop-frontend-dist_ubuntu-24.04-arm.tar.gz
        sha256: "65302ffbc3d0d6ba8278cd2486c931f63fa80de6210beab84eb3719594d7030d"
        strip-components: 0
        only-arches:
          - aarch64

      # Vendored cargo deps
      - type: archive
        url: https://github.com/JMBeresford/retrom/releases/download/v0.7.47/cargo-vendor_ubuntu-24.04.tar.gz
        sha256: "ba478ae0da0f0e390208601bba882375458c5e477cb835fb3d7c5b8ef8c477bf"
        strip-components: 0
        only-arches:
          - x86_64

      - type: archive
        url: https://github.com/JMBeresford/retrom/releases/download/v0.7.47/cargo-vendor_ubuntu-24.04-arm.tar.gz
        sha256: "f97b5d80c330247b01e259fb8a1fef9bed333bd9383d14b103d825ea68d719bd"
        strip-components: 0
        only-arches:
          - aarch64

    build-options:
      env:
        CARGO_HOME: /run/build/retrom/cargo
        XDG_CACHE_HOME: /run/build/retrom/flatpak-node/cache
        npm_config_cache: /run/build/retrom/flatpak-node/npm-cache
        npm_config_offline: "true"

    build-commands:
      - cargo fetch --offline
        --config source.crates-io.replace-with=\"vendored-sources\"
        --config source.vendored-sources.directory=\"vendor\"
        --manifest-path packages/client/Cargo.toml

      - cargo install --offline --path vendor/tauri-cli
        --config source.crates-io.replace-with=\"vendored-sources\"
        --config source.vendored-sources.directory=\"vendor\"

      - cd packages/client && cargo --offline
        tauri build --no-bundle --config ./tauri.build.conf.json --
        --features "flatpak"
        --offline
        --config source.crates-io.replace-with=\"vendored-sources\"
        --config source.vendored-sources.directory=\"../../vendor\"

      - install -Dm644 -t /app/share/metainfo/ io.github.jmberesford.Retrom.metainfo.xml
      - install -Dm644 -t /app/share/applications/ io.github.jmberesford.Retrom.desktop
      - install -Dm755 -t /app/bin/ target/release/Retrom

      - install -Dm644 packages/client/icons/32x32.png /app/share/icons/hicolor/32x32/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 packages/client/icons/128x128.png /app/share/icons/hicolor/128x128/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 packages/client/icons/128x128@2x.png /app/share/icons/hicolor/256x256/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 packages/client/icons/icon.png /app/share/icons/hicolor/256x256@2/apps/io.github.jmberesford.Retrom.png
      - install -Dm644 LICENSE /app/share/licenses/io.github.jmberesford.Retrom/LICENSE
