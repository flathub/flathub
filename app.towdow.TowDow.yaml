app-id: app.towdow.TowDow
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk

# Run the AppImage launcher via a symlink in /app/bin (required by Flatpak)
command: towdow_app

finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --share=network
  - --env=LD_LIBRARY_PATH=/app/towdow/lib
  - --env=FLUTTER_ICU_DATA_FILE=/app/towdow/data/icudtl.dat

modules:
  - name: towdow
    buildsystem: simple
    build-commands:
      # Extract AppImage
      - chmod +x towdow_app.AppImage
      - ./towdow_app.AppImage --appimage-extract

      # Install the WHOLE extracted tree to preserve relative paths
      - install -d /app/towdow
      - cp -a squashfs-root/. /app/towdow/

      # Create a symlink so Flatpak's command can find it in /app/bin
      - install -d /app/bin
      - ln -s /app/towdow/AppRun /app/bin/towdow_app

      # Desktop entry + icons (must match app-id)
      - install -Dm644 app.towdow.TowDow.desktop /app/share/applications/app.towdow.TowDow.desktop
      - install -Dm644 icons/hicolor/64x64/apps/app.towdow.TowDow.png   /app/share/icons/hicolor/64x64/apps/app.towdow.TowDow.png
      - install -Dm644 icons/hicolor/128x128/apps/app.towdow.TowDow.png /app/share/icons/hicolor/128x128/apps/app.towdow.TowDow.png
      - install -Dm644 icons/hicolor/256x256/apps/app.towdow.TowDow.png /app/share/icons/hicolor/256x256/apps/app.towdow.TowDow.png

      # Metainfo file
      - install -Dm644 app.towdow.TowDow.metainfo.xml /app/share/metainfo/app.towdow.TowDow.metainfo.xml

    sources:
      - type: file
        path: build/linux/x64/release/towdow_app-1.2.1.AppImage
        dest-filename: towdow_app.AppImage
      - type: file
        path: CI_scripts/linux/flatpak/data/app.towdow.TowDow.desktop
        dest-filename: app.towdow.TowDow.desktop
      - type: dir
        path: CI_scripts/linux/flatpak/data/icons
        dest: icons
      - type: file
        path: CI_scripts/linux/flatpak/data/app.towdow.TowDow.metainfo.xml
        dest-filename: app.towdow.TowDow.metainfo.xml
