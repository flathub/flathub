app-id: io.github.lephotographelibre.BlueNotebook
runtime: org.kde.Platform
runtime-version: '5.15-23.08'
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '5.15-23.08' 
command: bluenotebook
finish-args:
  # Accès au serveur d'affichage (X11 et Wayland)
  - --socket=fallback-x11
  - --socket=wayland
  # Requis pour X11 (mémoire partagée)
  - --share=ipc
  # Accès à l'accélération graphique (pour WebEngine)
  - --device=dri
  # Accès au réseau (Météo, YouTube, etc.)
  - --share=network
  # Accès au son (Vidéos YouTube)
  - --socket=pulseaudio
  # Accès aux fichiers utilisateur (pour sauvegarder le journal)
  # On peut restreindre à xdg-documents si on veut être plus strict
    # --filesystem=xdg-documents
  - --filesystem=home
  # Accès au fichier de configuration sur l'hôte (au lieu du dossier privé de la sandbox)
  #- --filesystem=xdg-config/BlueNotebook
  # Accès au portail du bureau pour une meilleure intégration (ouverture de liens)
  #- --talk-name=org.freedesktop.portal.Desktop
  # Permet de lire la liste des applications par défaut pour éviter le sélecteur
  #- --filesystem=xdg-config/mimeapps.list:ro
  # Forcer fontconfig à lire la configuration de la police emoji
  - --env=FONTCONFIG_FILE=/app/etc/fonts/fonts.conf

modules:
  # 1. Dépendances Python générées précédemment
  - python3-requirements.yaml

  # Ajout de la police Noto Color Emoji pour un affichage correct des emojis
  - name: noto-color-emoji
    buildsystem: simple
    build-commands:
      - install -d -m 755 /app/share/fonts/
      - install -m 644 NotoColorEmoji.ttf /app/share/fonts/
      - install -d -m 755 /app/etc/fonts/conf.d/
      - install -m 644 75-noto-color-emoji.conf /app/etc/fonts/conf.d/
      # Installer le fichier maître fonts.conf
      - install -m 644 fonts.conf /app/etc/fonts/fonts.conf
      - fc-cache -f -v /app/share/fonts/
    sources:
      - type: file
        url: https://github.com/googlefonts/noto-emoji/raw/main/fonts/NotoColorEmoji.ttf
        sha256: 72a635cb3d2f3524c51620cdde406b217204e8a6a06c6a096ff8ed4b5fd6e27b
      - type: file
        path: 75-noto-color-emoji.conf
      - type: file
        path: fonts.conf

  # Ajout de la police Noto Sans
  - name: noto-sans
    buildsystem: simple
    build-commands:
      - install -d -m 755 /app/share/fonts/
      - install -m 644 NotoSans-*.ttf /app/share/fonts/
      - fc-cache -f -v /app/share/fonts/
    sources:
      - type: file
        url: https://github.com/notofonts/noto-fonts/raw/main/hinted/ttf/NotoSans/NotoSans-Regular.ttf
        sha256: b85c38ecea8a7cfb39c24e395a4007474fa5a4fc864f6ee33309eb4948d232d5
      - type: file
        url: https://github.com/notofonts/noto-fonts/raw/main/hinted/ttf/NotoSans/NotoSans-Bold.ttf
        sha256: c976e4b1b99edc88775377fcc21692ca4bfa46b6d6ca6522bfda505b28ff9d6a
      - type: file
        url: https://github.com/notofonts/noto-fonts/raw/main/hinted/ttf/NotoSans/NotoSans-Italic.ttf
        sha256: 36cff144df01309dab648bea71baff9bb074026914afe63aeacc8bc90b67a28b
      - type: file
        url: https://github.com/notofonts/noto-fonts/raw/main/hinted/ttf/NotoSans/NotoSans-BoldItalic.ttf
        sha256: 6edf4227ef0fa846aca70e86a307804ca4401741830f5b3af0f2554abe2b8466

  # 2. L'application elle-même
  - name: bluenotebook
    buildsystem: simple
    build-commands:
      # Créer les répertoires de destination
      - mkdir -p /app/share/bluenotebook
      - mkdir -p /app/bin
      - mkdir -p /app/share/applications
      - mkdir -p /app/share/metainfo
      - mkdir -p /app/share/icons/hicolor/128x128/apps
      - mkdir -p /app/share/icons/hicolor/64x64/apps
      - mkdir -p /app/share/icons/hicolor/32x32/apps


      # Copier le code source (tout le contenu actuel vers /app/share/bluenotebook)
      # On exclut .git et venv via le mécanisme de source ci-dessous, mais ici on copie tout ce qui est téléchargé
      - cp -r . /app/share/bluenotebook

      # Installer le script wrapper
      - install -m 755 flatpak/bluenotebook-wrapper.sh /app/bin/bluenotebook

      # Installer le fichier .desktop
      - install -m 644 flatpak/io.github.lephotographelibre.BlueNotebook.desktop /app/share/applications/

      # Installer le fichier AppStream (metainfo)
      - install -m 644 flatpak/io.github.lephotographelibre.BlueNotebook.metainfo.xml /app/share/metainfo/

      # Installer les icônes PNG de différentes tailles
      - install -m 644 flatpak/bluenotebook_128x128.png /app/share/icons/hicolor/128x128/apps/io.github.lephotographelibre.BlueNotebook.png
      - install -m 644 flatpak/bluenotebook_64x64.png /app/share/icons/hicolor/64x64/apps/io.github.lephotographelibre.BlueNotebook.png
      - install -m 644 flatpak/bluenotebook_32x32.png /app/share/icons/hicolor/32x32/apps/io.github.lephotographelibre.BlueNotebook.png


    sources:
      - type: git
        url: https://github.com/lephotographelibre/BlueNotebook.git
        tag: v4.1.3
