app-id: io.github.gamingdoom.Datcord
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
base: org.mozilla.firefox.BaseApp
base-version: '23.08'
command: /app/lib/datcord/launch-datcord
rename-icon: io.github.gamingdoom.Datcord
add-build-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    add-ld-path: .
    version: '23.08'
    autodownload: true
    autodelete: false

finish-args:
    - --allow=devel                                           
    - --share=ipc                                             
    - --share=network                                         
    - --env=GTK_PATH=/app/lib/gtkmodules                      
    - --socket=pulseaudio                                     
    - --socket=wayland                                        
    - --socket=fallback-x11                                            
    - --require-version=0.11.1                                
    - --persist=.datcord                                      
    - --filesystem=xdg-download:rw                            
    - --filesystem=/run/.heim_org.h5l.kcm-socket              
    - --filesystem=/tmp/open-in-default-browser                                       
    - --device=all                                            
    - --talk-name=org.freedesktop.FileManager1                
    - --talk-name=org.a11y.Bus                                
    - --talk-name=org.gnome.SessionManager                    
    - --talk-name=org.freedesktop.ScreenSaver                 
    - --talk-name=org.freedesktop.Notifications               
    - --command=/app/lib/datcord/launch-datcord
    - --filesystem=home:rw
    - --env=GTK_THEME_VARIANT=dark
    - --device=dri
    - --filesystem=~/.config/dconf:ro
    - --env=DCONF_USER_CONFIG_DIR=.config/dconf

modules:
  - name: datcord
    buildsystem: simple
    build-commands:
      - mv policies.json distribution/policies.json

      - chmod +x launch-datcord
      - chmod +x open-in-default-browser
      - mkdir -p /app/lib/datcord
      - cp -r * /app/lib/datcord

      - install -Dm 644 -t /app/share/applications io.github.gamingdoom.Datcord.desktop
      - install -Dm 644 -t /app/share/metainfo io.github.gamingdoom.Datcord.metainfo.xml

      - install -Dm 644 default256.png /app/share/icons/hicolor/256x256/apps/io.github.gamingdoom.Datcord.png
      - install -Dm 644 default128.png /app/share/icons/hicolor/128x128/apps/io.github.gamingdoom.Datcord.png

    sources:
      - type: archive
        url: https://github.com/gamingdoom/datcord/releases/latest/download/datcord-linux-x86_64.tar.bz2
        sha256: 77383f32695a95a2875e49e3084d58f1d571b726c2c8dd7e30a13e2b1f01cf36
        x-checker-data:
          type: json
          url: https://api.github.com/repos/gamingdoom/datcord/releases/latest
          tag-query: ".tag_name"
          version-query: "$tag"
          timestamp-query: ".published-at"
          url-query: ".assets[] | select(.name==\"datcord-linux-x86_64.tar.bz2\") | .browser_download_url"
           
      - type: file
        path: policies.json

      - type: file
        path: io.github.gamingdoom.Datcord.desktop
      
      - type: file
        path: io.github.gamingdoom.Datcord.metainfo.xml

      - type: file
        path: default256.png

      - type: file
        path: default128.png
