app-id: org.avidemux.Avidemux
branch: stable
runtime: org.kde.Platform
runtime-version: 5.10 # fails to build with 5.11
sdk: org.kde.Sdk
command: avidemux3_qt5
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --socket=pulseaudio
  - --filesystem=host # needed for jobs scheduler
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - '*.a'
  - '*.la'
modules:
  - shared-modules/glu/glu-9.0.0.json
  - shared-modules/glew/glew.json
  - shared-modules/lame/lame-3.99.5.json

  - name: fribidi
    sources:
      - type: archive
        url: https://github.com/fribidi/fribidi/releases/download/v1.0.3/fribidi-1.0.3.tar.bz2
        sha256: 8d214b17b6eedcb416e53142c196c2896b9a685fca2a5bddc098a73d2b02ce12

  - name: nasm # x265 needs nasm 2.13
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://www.nasm.us/pub/nasm/releasebuilds/2.13.03/nasm-2.13.03.tar.xz
        sha256: 812ecfb0dcbc5bd409aaa8f61c7de94c5b8752a7b00c632883d15b2ed6452573

  - name: x264
    config-opts:
      - --disable-cli
      - --enable-shared
    sources:
      - type: archive
        url: https://download.videolan.org/x264/snapshots/x264-snapshot-20171223-2245-stable.tar.bz2
        sha256: ee4ba2c3d1caf786ad66d3fa86bdc368a8f827318788a62a9c8444b2c35816bf

  - name: x265
    buildsystem: cmake-ninja
    builddir: true
    subdir: source
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_STATIC_LIBS=OFF
    build-options:
      arch:
        arm:
          cxxflags: -fPIC
        aarch64:
          cxxflags: -fPIC
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://bitbucket.org/multicoreware/x265/downloads/x265_2.7.tar.gz
        sha256: d5e75fa62ffe6ed49e691f8eb8ab8c1634ffcc0725dd553c6fdb4d5443b494a2
  
  - name: avidemux
    buildsystem: simple
    build-commands:
      - bash bootStrap.bash --prefix=${FLATPAK_DEST}
      - cp -R install${FLATPAK_DEST}/* ${FLATPAK_DEST}
      - install -Dm644 avidemux_icon.png ${FLATPAK_DEST}/share/icons/hicolor/64x64/apps/org.avidemux.Avidemux.png
      - desktop-file-edit --set-key=Name --set-value=Avidemux avidemux2.desktop
      - desktop-file-edit --set-key=Exec --set-value=avidemux3_qt5 avidemux2.desktop
      - desktop-file-edit --set-key=Icon --set-value=org.avidemux.Avidemux avidemux2.desktop
      - install -Dm644 avidemux2.desktop ${FLATPAK_DEST}/share/applications/org.avidemux.Avidemux.desktop
      - sed -i 's|<id>avidemux2.desktop</id>|<id>org.avidemux.Avidemux</id>|' avidemux2.appdata.xml
      - sed -i 's|<binary>avidemux2_gtk</binary>|<binary>avidemux3_qt5</binary>|' avidemux2.appdata.xml
      - sed -i '30i <releases><release version=\"2.7.0\" date=\"2017-08-14\"/></releases>' avidemux2.appdata.xml
      - install -Dm644 avidemux2.appdata.xml ${FLATPAK_DEST}/share/metainfo/org.avidemux.Avidemux.appdata.xml
    sources:
      - type: archive
        url: https://github.com/mean00/avidemux2/archive/2.7.0.tar.gz
        sha256: b0941eea6d4bb17c16011fe41624c0117ff024ad6f66cab88673f761b90592c9
 