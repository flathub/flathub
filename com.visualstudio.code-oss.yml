id: com.visualstudio.code-oss
sdk: org.freedesktop.Sdk
runtime: org.freedesktop.Sdk
runtime-version: "19.08"
base: org.electronjs.Electron2.BaseApp
base-version: "19.08"
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --allow=devel
  - --socket=pulseaudio
  - --share=network
  - --socket=ssh-auth
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.Flatpak
  - --filesystem=host
command: code-oss
rename-desktop-file: code-oss.desktop
rename-appdata-file: code-oss.appdata.xml
rename-icon: code-oss
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node10
build-options:
  append-path: /usr/lib/sdk/node10/bin
separate-locales: false
add-extensions:
  com.visualstudio.code.tool:
    directory: tools
    subdirectories: true
    add-ld-path: lib
    no-autodownload: true
modules:

  - shared-modules/libsecret/libsecret.json

  - name: ImageMagick
    cleanup:
      - "*"
    sources:
      - type: archive
        url: "https://github.com/ImageMagick/ImageMagick/archive/7.0.10-14.tar.gz"
        sha256: f2a60abc60fdc5a9c260d84a261cb3ce2500282b4c15f23ffa503848977ad7d1

  - name: yarn
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/yarn/
      - cp -a * /app/share/yarn/
      - ln -s /app/share/yarn/bin/yarn /app/bin/yarn
      - ln -s /app/share/yarn/bin/yarnpkg /app/bin/yarnpkg
    cleanup:
      - "*"
    sources:
      - type: archive
        url: "https://github.com/yarnpkg/yarn/releases/download/v1.22.4/yarn-v1.22.4.tar.gz"
        sha256: bc5316aa110b2f564a71a3d6e235be55b98714660870c5b6b2d2d3f12587fb58

  - name: vscode
    build-options:
      env:
        TMPDIR: /run/build/vscode/flatpak-node/tmp
        XDG_CACHE_HOME: /run/build/vscode/flatpak-node/cache
        ELECTRON_CACHE: /run/build/vscode/flatpak-node/electron-cache
        electron_config_cache: /run/build/vscode/flatpak-node/electron-cache
        npm_config_nodedir: /run/build/vscode/flatpak-node/node-gyp/electron-current
        DEBUG: electron-rebuild,electron-builder
        JOBS: max
        VSCODE_QUALITY: stable
      arch:
        arm: { env: { earch: armv7l, suffix: "-armv7l" } }
        aarch64: { env: { earch: arm64, suffix: "-arm64" } }
        i386: { env: { earch: ia32, suffix: "-ia32" } }
        x86_64: { env: { earch: x64, suffix: "" } }
    buildsystem: simple
    build-commands:
      # Prepare
      - |
        set -e
        mv product.json product.orig.json
        jq "
          .quality=\"${VSCODE_QUALITY}\" |
          .commit=\"$(git rev-parse HEAD)\" |
          .date=\"$(date -u +'%FT%TZ')\" |
          .extensionsGallery.serviceUrl=\"https://marketplace.visualstudio.com/_apis/public/gallery\" |
          .extensionsGallery.cacheUrl=\"https://vscode.blob.core.windows.net/gallery/index\" |
          .extensionsGallery.itemUrl=\"https://marketplace.visualstudio.com/items\" |
          .extensionAllowedProposedApi+=[\"ms-vsliveshare.vsliveshare\"] |
          .builtInExtensions=[]
        " < product.orig.json > product.json
        rm product.orig.json
      # Build
      - yarn --frozen-lockfile
      - yarn run gulp vscode-linux-$earch-min
      # Install
      - cp -a ../VSCode-linux-$earch /app/main
    post-install:
      - install -Dm755 ../code-oss.sh /app/bin/code-oss
      - ../install-data.sh . /app/share
      - mkdir -p /app/tools
    subdir: main
    sources:
      - type: git
        url: "https://github.com/microsoft/vscode.git"
        tag: "1.45.1"
        dest: main

      - type: patch
        paths:
          - patches/ipc-sockets-paths-flatpak.patch
        dest: main

      - type: file
        path: yarnrc
        dest-filename: .yarnrc

      - generated-sources.json

      - type: shell
        commands:
          - mkdir -p flatpak-node/tmp/gulp-electron-cache/atom
          - ln -sr flatpak-node/electron-cache flatpak-node/tmp/gulp-electron-cache/atom/electron

      - type: file
        path: code-oss.sh

      - type: file
        path: install-data.sh
