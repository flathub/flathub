app-id: com.sigil_ebook.Sigil
runtime: org.kde.Platform
runtime-version: 5.15-21.08
sdk: org.kde.Sdk
base: io.qt.qtwebengine.BaseApp
base-version: 5.15-21.08
rename-desktop-file: sigil.desktop
rename-icon: sigil
command: sigil
finish-args:
  - --socket=fallback-x11
  - --socket=wayland
  - --share=ipc
  - --share=network
  - --device=dri
  - --filesystem=home
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess

cleanup-commands:
  - ${FLATPAK_DEST}/cleanup-BaseApp.sh
  - rm -r ${FLATPAK_DEST}/lib/*/site-packages/PyQt5/bindings
  - ls -d -1 ${FLATPAK_DEST}/translations/qtwebengine_locales/* | 
    grep -v en-US | xargs rm

# only global build-options can pass env to modules
# so put the opts here
build-options:
  env:
    pyqt5_opts: >-
      --no-designer-plugin
      --no-qml-plugin
      --enable QtCore
      --enable QtGui
      --enable QtNetwork
      --enable QtWidgets
      --enable QtSvg
      --enable QtWebChannel
      --enable QtPrintSupport 
    # WebChannel,PrintSupport required by pyqtwebengine
 
modules:
  - pyqt5/pyqt5.yml
  - pyqt5/pyqtwebengine.yml

  - name: sigil
    buildsystem: cmake-ninja
    config-opts:
      - -DUSE_SYSTEM_LIBS=0
      - -DDISABLE_UPDATE_CHECK=1
      - -DINSTALL_HICOLOR_ICONS=1
    post-install:
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
    sources:
      - type: git
        url: https://github.com/Sigil-Ebook/Sigil.git
        tag: 1.8.0
        commit: 70f4618dd9138e7769a42592383b710f3e06cfb7
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$
          is-main-source: true

      - type: file
        path: com.sigil_ebook.Sigil.metainfo.xml

    modules:
      - dependencies/sigil-pypi-dependencies.json
      - dependencies/python3-tkinter.yaml
