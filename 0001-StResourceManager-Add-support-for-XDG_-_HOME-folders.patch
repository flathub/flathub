From 55e5a7aa41914cd73cbbf71c85114c8a9a88fc35 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Tue, 19 Nov 2019 11:05:19 +0100
Subject: [PATCH] StResourceManager - Add support for XDG_*_HOME folders

As defined in:
https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html#variables
---
 StShared/StResourceManager.cpp | 33 ++++++++++++++++++++++++---------
 1 file changed, 24 insertions(+), 9 deletions(-)

diff --git a/StShared/StResourceManager.cpp b/StShared/StResourceManager.cpp
index 9f1bf844..472d7f3c 100644
--- a/StShared/StResourceManager.cpp
+++ b/StShared/StResourceManager.cpp
@@ -162,20 +162,35 @@ StResourceManager::StResourceManager(const StString& theAppName)
     StFolder::createFolder(myUserHomeFolder + "Library/Caches");
 #else
     // Linux world
-    myUserDataFolder = myUserHomeFolder + ".local/share/" + myAppName + "/";
-    mySettingsFolder = myUserHomeFolder + ".config/"      + myAppName + "/";
-    myCacheFolder    = myUserHomeFolder + ".cache/"       + myAppName + "/";
+    myUserDataFolder = StProcess::getEnv(StString("XDG_DATA_HOME"));
+    if (myUserDataFolder.isEmpty()) {
+        myUserDataFolder = myUserHomeFolder + ".local/share/" + myAppName + "/";
+        StFolder::createFolder(myUserHomeFolder + ".local");
+        StFolder::createFolder(myUserHomeFolder + ".local/share");
+    } else {
+        myUserDataFolder = myUserDataFolder + "/";
+    }
+
+    mySettingsFolder = StProcess::getEnv(StString("XDG_CONFIG_HOME"));
+    if (mySettingsFolder.isEmpty()) {
+        mySettingsFolder = myUserHomeFolder + ".config/"      + myAppName + "/";
+        StFolder::createFolder(myUserHomeFolder + ".config");
+    } else {
+        mySettingsFolder = mySettingsFolder + "/";
+    }
+
+    myCacheFolder = StProcess::getEnv(StString("XDG_CACHE_HOME"));
+    if (myCacheFolder.isEmpty()) {
+        myCacheFolder = myUserHomeFolder + ".cache/"       + myAppName + "/";
+        StFolder::createFolder(myUserHomeFolder + ".cache");
+    } else {
+        myCacheFolder = myCacheFolder + "/";
+    }
 
     myFolders[FolderId_Downloads] = myUserHomeFolder + "Downloads";
     myFolders[FolderId_Pictures]  = myUserHomeFolder + "Pictures";
     myFolders[FolderId_Music]     = myUserHomeFolder + "Music";
     myFolders[FolderId_Videos]    = myUserHomeFolder + "Videos";
-
-    // make sure parent paths are also exist (on broken home)
-    StFolder::createFolder(myUserHomeFolder + ".local");
-    StFolder::createFolder(myUserHomeFolder + ".local/share");
-    StFolder::createFolder(myUserHomeFolder + ".config");
-    StFolder::createFolder(myUserHomeFolder + ".cache");
 #endif
 
     StFolder::createFolder(myUserDataFolder);
-- 
2.23.0

