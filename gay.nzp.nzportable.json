{
    "app-id": "gay.nzp.nzportable",
    "runtime": "org.freedesktop.Platform",
    "runtime-version": "24.08",
    "sdk": "org.freedesktop.Sdk",
    "command": "nzportable",
    "finish-args": [
        "--share=ipc",
        "--socket=pulseaudio",
        "--socket=x11",
        "--env=SDL_VIDEODRIVER=x11",
        "--env=SDL_AUDIODRIVER=pulseaudio",
        "--share=network",
        "--device=all"
    ],
    "modules": [
        {
            "name": "nzportable-linux64",
            "only-arches": [
                "x86_64"
            ],
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/bin",
                "mkdir -p /app/share/nzportable",
                "# install the game binary",
                "install -Dm755 nzportable64-sdl /app/share/nzportable/nzportable.bin",
                "# install default.fmf",
                "cp default.fmf /app/share/nzportable/",
                "# install game data",
                "mkdir -p /app/share/nzportable/nzp",
                "for f in *; do if [ \"$f\" != \"nzportable64-sdl\" ] && [ \"$f\" != \"default.fmf\" ] && [ \"$f\" != \"nzportable-launcher.sh\" ]; then cp -r \"$f\" /app/share/nzportable/nzp/; fi; done",
                "echo \"nightly\" > /app/share/nzportable/nzp/version.txt",
                "# install the launcher script",
                "install -Dm755 nzportable-launcher.sh /app/bin/nzportable"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/nzp-team/nzportable/releases/download/nightly/nzportable-linux64.zip",
                    "sha256": "5a51f8b6809ce2de2525ae3e1e2004a590f8f5ca226f7a8f0ba634c95c4cc76e"
                },
                {
                    "type": "script",
                    "dest-filename": "nzportable-launcher.sh",
                    "commands": [
                        "#!/bin/bash",
                        "",
                        "DATA_DIR=\"$HOME/.var/app/gay.nzp.nzportable/data\"",
                        "GAME_DIR=\"$DATA_DIR/nzportable\"",
                        "SOURCE_DIR=\"/app/share/nzportable\"",
                        "",
                        "mkdir -p \"$DATA_DIR\"",
                        "",
                        "if [ ! -d \"$GAME_DIR\" ] || [ ! -f \"$GAME_DIR/nzportable.bin\" ]; then",
                        "    echo \"Setting up NZPortable data directory...\"",
                        "    mkdir -p \"$GAME_DIR\"",
                        "    cp -r \"$SOURCE_DIR\"/* \"$GAME_DIR/\"",
                        "    chmod +x \"$GAME_DIR/nzportable.bin\"",
                        "    echo \"Setup complete.\"",
                        "fi",
                        "",
                        "if [ \"$SOURCE_DIR/nzp/version.txt\" -nt \"$GAME_DIR/nzp/version.txt\" ]; then",
                        "    echo \"Updating game data...\"",
                        "    # Preserve user settings",
                        "    if [ -f \"$GAME_DIR/nzp/user_settings.cfg\" ]; then",
                        "        cp \"$GAME_DIR/nzp/user_settings.cfg\" /tmp/nzp_user_settings_backup.cfg",
                        "    fi",
                        "    # Update game files",
                        "    cp -r \"$SOURCE_DIR/nzp\"/* \"$GAME_DIR/nzp/\"",
                        "    # Restore user settings",
                        "    if [ \"/tmp/nzp_user_settings_backup.cfg\" ]; then",
                        "        cp /tmp/nzp_user_settings_backup.cfg \"$GAME_DIR/nzp/user_settings.cfg\"",
                        "        rm /tmp/nzp_user_settings_backup.cfg",
                        "    fi",
                        "    echo \"Update complete.\"",
                        "fi",
                        "",
                        "cd \"$GAME_DIR\"",
                        "exec ./nzportable.bin \"$@\""
                    ]
                }
            ]
        },
        {
            "name": "nzportable-arm64",
            "only-arches": [
                "aarch64"
            ],
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/bin",
                "mkdir -p /app/share/nzportable",
                "# install the game binary",
                "install -Dm755 nzportablearm64-sdl /app/share/nzportable/nzportable.bin",
                "# install default.fmf",
                "cp default.fmf /app/share/nzportable/",
                "# install game data",
                "mkdir -p /app/share/nzportable/nzp",
                "for f in *; do if [ \"$f\" != \"nzportablearm64-sdl\" ] && [ \"$f\" != \"default.fmf\" ] && [ \"$f\" != \"nzportable-launcher.sh\" ]; then cp -r \"$f\" /app/share/nzportable/nzp/; fi; done",
                "echo \"nightly\" > /app/share/nzportable/nzp/version.txt",
                "# install the launcher script",
                "install -Dm755 nzportable-launcher.sh /app/bin/nzportable"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/nzp-team/nzportable/releases/download/nightly/nzportable-linuxarm64.zip",
                    "sha256": "4b190ca180fe65408c89862656421a858f798cbbc22cb2b2815b22253a70f00a"
                },
                {
                    "type": "script",
                    "dest-filename": "nzportable-launcher.sh",
                    "commands": [
                        "#!/bin/bash",
                        "",
                        "DATA_DIR=\"$HOME/.var/app/gay.nzp.nzportable/data\"",
                        "GAME_DIR=\"$DATA_DIR/nzportable\"",
                        "SOURCE_DIR=\"/app/share/nzportable\"",
                        "",
                        "mkdir -p \"$DATA_DIR\"",
                        "",
                        "if [ ! -d \"$GAME_DIR\" ] || [ ! -f \"$GAME_DIR/nzportable.bin\" ]; then",
                        "    echo \"Setting up NZPortable data directory...\"",
                        "    mkdir -p \"$GAME_DIR\"",
                        "    cp -r \"$SOURCE_DIR\"/* \"$GAME_DIR/\"",
                        "    chmod +x \"$GAME_DIR/nzportable.bin\"",
                        "    echo \"Setup complete.\"",
                        "fi",
                        "",
                        "if [ \"$SOURCE_DIR/nzp/version.txt\" -nt \"$GAME_DIR/nzp/version.txt\" ]; then",
                        "    echo \"Updating game data...\"",
                        "    # Preserve user settings",
                        "    if [ -f \"$GAME_DIR/nzp/user_settings.cfg\" ]; then",
                        "        cp \"$GAME_DIR/nzp/user_settings.cfg\" /tmp/nzp_user_settings_backup.cfg",
                        "    fi",
                        "    # Update game files",
                        "    cp -r \"$SOURCE_DIR/nzp\"/* \"$GAME_DIR/nzp/\"",
                        "    # Restore user settings",
                        "    if [ \"/tmp/nzp_user_settings_backup.cfg\" ]; then",
                        "        cp /tmp/nzp_user_settings_backup.cfg \"$GAME_DIR/nzp/user_settings.cfg\"",
                        "        rm /tmp/nzp_user_settings_backup.cfg",
                        "    fi",
                        "    echo \"Update complete.\"",
                        "fi",
                        "",
                        "cd \"$GAME_DIR\"",
                        "exec ./nzportable.bin \"$@\""
                    ]
                }
            ]
        }
    ]
}