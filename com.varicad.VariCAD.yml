app-id: com.varicad.VariCAD
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: varicad.sh
finish-args:
  - --device=dri
  - --share=ipc
  # needed for online license activation
  - --share=network
  - --socket=x11
  - --persist=.varicad
tags:
  - proprietary
modules:
  - shared-modules/gtk2/gtk2.json
  - shared-modules/glu/glu-9.json
  - name: varicad
    buildsystem: simple
    build-commands:
      - ar p varicad.deb data.tar.xz | tar -xJf - --strip-components=2
      - desktop-file-edit --remove-key="FilePatern" --set-icon="${FLATPAK_ID}" VariCAD/desktop/varicad.desktop
      - install -Dm755 VariCAD/bin/varicad                 ${FLATPAK_DEST}/bin/varicad
      - install -Dm755 VariCAD/bin/varicad_runtime         ${FLATPAK_DEST}/bin/varicad_runtime
      - cp -r VariCAD/lib/*                                ${FLATPAK_DEST}/lib
      - install -Dm644 VariCAD/bin/liblibcrypto.so         ${FLATPAK_DEST}/lib/liblibcrypto.so
      - install -Dm644 VariCAD/desktop/varicad_512x512.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - install -Dm644 VariCAD/desktop/varicad.desktop     ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml          ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm755 varicad.sh                          ${FLATPAK_DEST}/bin/varicad.sh
      # A .lck file generated on the first run is required for starting a 30-day trial and activating licenses
      - ln -sf /run/flatpak/app/${FLATPAK_ID}/varicad.lck  ${FLATPAK_DEST}/lib/varicad.lck
    sources:
      - type: file
        url: https://www.varicad.com/userdata/files/release/en/varicad2023-en_2.05_amd64.deb
        dest-filename: varicad.deb
        sha256: 1c94ce5b2ff46baae97651e10acf8aad32fc8280099d65d491b5f60f6256955e
        x-checker-data:
          type: html
          url: https://www.varicad.com/en/home/products/download/
          version-pattern: <a href='../../../../userdata/files/release/en/varicad2023-en_(\d+.\d+)_amd64.deb'>download</a></td></tr><tr><td
            style='width:\ 50%'>RPM Package x64
          url-template: https://www.varicad.com/userdata/files/release/en/varicad2023-en_${version}_amd64.deb
        only-arches: [x86_64]
      - type: file
        path: com.varicad.VariCAD.metainfo.xml
      - type: script
        dest-filename: varicad.sh
        commands:
          - ln -sf "${XDG_DATA_HOME}/varicad.lck" /run/flatpak/app/com.varicad.VariCAD/varicad.lck
          - exec /app/bin/varicad $@
