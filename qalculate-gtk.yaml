name: qalculate-gtk
rm-configure: true
config-opts:
  - --disable-static
  - --enable-maintainer-mode
sources:
  - type: archive
    url: https://github.com/Qalculate/qalculate-gtk/releases/download/v2.9.0/qalculate-gtk-2.9.0.tar.gz
    sha256: db422a6d78ce15407bcbfa255c6ff9b63351c1164ae7a090929d0c15e0efd656
  # There is only 64x64 PNG icon in the above archive.
  - type: file
    url: https://raw.githubusercontent.com/Qalculate/qalculate-gtk/v2.9.0/data/qalculate.ico
    sha256: 27902c8cb7182af9a585628f2f7ee682148b05e3083a14f842638e14a51b9be5
    dest: data
  # GenericName from mate-calc
  # https://koji.fedoraproject.org/koji/buildinfo?buildID=1191979
  - type: file
    path: GenericName.txt
  # Enhance AppData file
  - type: patch
    path: qalculate-gtk-2.9.0-appdata.patch
  - type: shell
    commands:
      - cp -p /usr/share/automake-*/config.{sub,guess} .;
post-install:
  - mkdir "icons";
    icotool -x -o "icons" "data/qalculate.ico";
  - icon_in="$( find "icons" -mindepth 1 -maxdepth 1 -xtype f -name 'qalculate_*_256x256x32.png' | sort -V | tail -n 1 )";
    icon_out="qalculate.png";
    for s in {72,96,128,192}; do
    convert -background none -density 1024 -resize "${s}x${s}" "${icon_in}" "${icon_out}";
    install -p -D -m 0644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
    done;
    install -p -D -m 0644 "${icon_in}" "${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/${icon_out}";
  - icon_in="data/qalculate.png";
    icon_out="qalculate.png";
    for s in {40,48}; do
    convert -background none -density 1024 -resize "${s}x${s}" "${icon_in}" "${icon_out}";
    install -p -D -m 0644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
    done;
    install -p -D -m 0644 "${icon_in}" "${FLATPAK_DEST}/share/icons/hicolor/64x64/apps/${icon_out}";
  - icon_in="$( find "icons" -mindepth 1 -maxdepth 1 -xtype f -name 'qalculate_*_32x32x32.png' | sort -V | tail -n 1 )";
    icon_out="qalculate.png";
    for s in {16,22,24}; do
    convert -background none -density 1024 -resize "${s}x${s}" "${icon_in}" "${icon_out}";
    install -p -D -m 0644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
    done;
    install -p -D -m 0644 "${icon_in}" "${FLATPAK_DEST}/share/icons/hicolor/32x32/apps/${icon_out}";
  - desktop-file-edit --set-key="StartupWMClass" --set-value="qalculate-gtk" "${FLATPAK_DEST}/share/applications/qalculate-gtk.desktop";
    cat "GenericName.txt" >> "${FLATPAK_DEST}/share/applications/qalculate-gtk.desktop";
  - install -p -D -m 0644 "COPYING" -t "${FLATPAK_DEST}/share/licenses/qalculate-gtk/";
modules:
  - libqalculate.yaml
  - gnuplot.yaml
  - icoutils.yaml
  - ImageMagick.yaml
