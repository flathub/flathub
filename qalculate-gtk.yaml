name: qalculate-gtk
rm-configure: true
config-opts:
  - --disable-static
  - --enable-maintainer-mode
sources:
  - type: archive
    url: https://github.com/Qalculate/qalculate-gtk/releases/download/v3.5.0/qalculate-gtk-3.5.0.tar.gz
    sha256: 9cbc391e95274fa5414ae7d0ba7d9a60456734a746337cac6bef9b8bc30b1e69
  # There is only 64x64 PNG icon in the above archive.
  - type: file
    url: https://raw.githubusercontent.com/Qalculate/qalculate-gtk/v3.5.0/data/qalculate.ico
    sha256: 27902c8cb7182af9a585628f2f7ee682148b05e3083a14f842638e14a51b9be5
    dest: data
  # Name (as GenericName) from gnome-calculator
  # GenericName from mate-calc
  # https://koji.fedoraproject.org/koji/buildinfo?buildID=1399423
  # https://koji.fedoraproject.org/koji/buildinfo?buildID=1383173
  - type: file
    path: GenericName.txt
  # Keywords from gnome-calculator
  # https://koji.fedoraproject.org/koji/buildinfo?buildID=1399423
  - type: file
    path: Keywords.txt
  # Update XDG files
  # https://github.com/Qalculate/qalculate-gtk/pull/120
  - type: patch
    path: qalculate-gtk-3.5.0-xdg.patch
  - type: shell
    commands:
      - cp -p /usr/share/automake-*/config.{sub,guess} .;
post-install:
  - mkdir "icons";
    icotool -x -o "icons" "data/qalculate.ico";
  - |
    icon_in="$( find "icons" -mindepth 1 -maxdepth 1 -xtype f -name 'qalculate_*_256x256x32.png' | sort -V | tail -n 1 )";
    icon_out="qalculate.png";
    for s in {72,96,128,192}; do
      convert -background none -density 1024 -resize "${s}x${s}" "${icon_in}" "${icon_out}";
      install -p -D -m 0644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
    done;
    install -p -D -m 0644 "${icon_in}" "${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/${icon_out}";
  - |
    icon_in="data/qalculate.png";
    icon_out="qalculate.png";
    for s in {36,48}; do
      convert -background none -density 1024 -resize "${s}x${s}" "${icon_in}" "${icon_out}";
      install -p -D -m 0644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
    done;
    install -p -D -m 0644 "${icon_in}" "${FLATPAK_DEST}/share/icons/hicolor/64x64/apps/${icon_out}";
  - |
    icon_in="$( find "icons" -mindepth 1 -maxdepth 1 -xtype f -name 'qalculate_*_32x32x32.png' | sort -V | tail -n 1 )";
    icon_out="qalculate.png";
    for s in {16,22,24}; do
      convert -background none -density 1024 -resize "${s}x${s}" "${icon_in}" "${icon_out}";
      install -p -D -m 0644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
    done;
    install -p -D -m 0644 "${icon_in}" "${FLATPAK_DEST}/share/icons/hicolor/32x32/apps/${icon_out}";
  - |
    cat "GenericName.txt" "Keywords.txt" | while IFS='=' read -r key value; do
      awk -F'=' -v "key=${key}" '$1 == key { found = 1; exit(0); } END { if (!found) exit(1); }' "${FLATPAK_DEST}/share/applications/qalculate-gtk.desktop" && continue;
      desktop-file-edit --set-key="${key}" --set-value="${value}" "${FLATPAK_DEST}/share/applications/qalculate-gtk.desktop";
    done;
modules:
  - libqalculate.yaml
  - gnuplot.yaml
  - icoutils.yaml
  - ImageMagick.yaml
