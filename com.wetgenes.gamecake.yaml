app-id: com.wetgenes.gamecake
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: gamecake
finish-args:
  - --socket=fallback-x11
  - --socket=wayland
  - --device=all
  - --socket=pulseaudio
  - --share=ipc
  - --share=network
modules:
  - name: luajit
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    post-install:
      - ln -sf ./luajit-2.1.0-beta3 /app/bin/luajit
    sources:
      - type: archive
        url: https://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz
        sha256: 1ad2e34b111c802f9d0cdf019e986909123237a28c746b21295b63c9e785d9c3

  - name: luafilesystem
    no-autogen: true
    make-args:
      - LUA_VERSION=jit-2.1
      - LUA_INC += -I/app/include/luajit-2.1
    make-install-args:
      - LUA_VERSION=jit-2.1
      - PREFIX=/app
    sources:
      - type: git
        url: https://github.com/lunarmodules/luafilesystem.git
        commit: 912e06714fc276c15b4d5d1b42bd2b11edb8deff

  - name: gamecake_meta
    buildsystem: simple
    sources:
      - type: dir
        path: .
    build-commands:
      - install -D com.wetgenes.gamecake.png --target-directory=/app/share/icons/hicolor/256x256/apps/
      - install -D com.wetgenes.gamecake.metainfo.xml --target-directory=/app/share/metainfo/
      - install -D com.wetgenes.gamecake.desktop --target-directory=/app/share/applications/
      - install -D gamecake.fun --target-directory=/app/bin/

  - name: gamecake
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/xriss/gamecake.git
        tag: V23.5769

    build-commands:
      - ls /app/lib/lua/
      - LUA_CPATH="/app/lib/lua/jit-2.1/?.so;" ./make
      - cp ./exe/gamecake.nix /app/bin/gamecake
