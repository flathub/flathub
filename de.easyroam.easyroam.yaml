id: de.easyroam.easyroam
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
command: easyroam
separate-locales: false
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --share=network

modules:
  - shared-modules/lzo/lzo.json
  - shared-modules/squashfs-tools/squashfs-tools.json

  - name: libndp
    buildsystem: autotools
    sources:
      - type: archive
        url: http://libndp.org/files/libndp-1.6.tar.gz
        sha256: 0c7dfa84e013bd5e569ef2c6292a6f72cfaf14f4ff77a77425e52edc33ffac0e
  - name: NetworkManager
    buildsystem: meson
    build-options:
      cflags: -ltinfo
      cxxflags: -ltinfo
    config-opts:
      - -Dlibaudit=no
      - -Ddbus_conf_dir=/app/etc/dbus-1/system.d
      - -Ddnsmasq=/usr/bin/true
      - -Ddocs=false
      - -Dintrospection=false
      - -Diptables=/usr/bin/true
      - -Dlibpsl=false
      - -Dmodem_manager=false
      - -Dnm_cloud_setup=false
      - -Dnmtui=false
      - -Dnbft=false
      - -Dovs=false
      - -Dppp=false
      - -Dqt=false
      - -Dselinux=false
      - -Dsession_tracking=no
      - -Dsystemdsystemunitdir=/app/lib/systemd/system
      - -Dudev_dir=/app/lib/udev
      - -Dsystemd_journal=false
      - -Dtests=no
      - -Dvapi=false
      - -Dman=false
    sources:
      - type: git
        branch: main
        url: https://gitlab.freedesktop.org/NetworkManager/NetworkManager.git

  - name: easyroam-connect-desktop
    buildsystem: simple
    build-commands:
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm644 ${FLATPAK_ID}.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm644 ${FLATPAK_ID}.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - ln -s ${FLATPAK_DEST}/extra/snap/easyroam_connect_desktop ${FLATPAK_DEST}/bin/easyroam
      - install -Dm755 apply_extra ${FLATPAK_DEST}/bin/apply_extra
    sources:
      - type: extra-data
        filename: easyroam.snap
        only-arches:
          - x86_64
        url: https://api.snapcraft.io/api/v1/snaps/download/K39hKMJWqabSZF9YQ99cdPULXDsUDyXb_1.snap
        sha256: 886f64607e510d2c418a9263319d6b49f1b229c72789046bf1332c1356e983bb
        size: 38699008
      - type: file
        path: de.easyroam.easyroam.metainfo.xml
      - type: file
        path: de.easyroam.easyroam.desktop
      - type: file
        path: de.easyroam.easyroam.png
      - type: script
        dest-filename: apply_extra
        commands:
          - unsquashfs -quiet -no-progress easyroam.snap
          # TODO: Remove unused files from snap
          - mkdir snap
          - mv squashfs-root/* snap/
          - rm -r squashfs-root easyroam.snap