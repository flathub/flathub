id: dev.fredol.fredstalker
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk
sdk-extensions:
    - org.freedesktop.Sdk.Extension.llvm19
build-options:
    append-path: /usr/lib/sdk/flutter/bin
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '24.08'
    add-ld-path: .
base: io.mpv.Mpv
base-version: stable
command: fredstalker
finish-args:
    - --socket=wayland
    - --socket=fallback-x11
    - --device=dri
    - --share=ipc
    - --share=network
    - --socket=pulseaudio
    - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
    - --talk-name=org.gnome.SessionManager
modules:
    - name: mpv-fix
      buildsystem: simple
      build-commands:
          - cp -r mpv-source/include/mpv /app/include
          - install -Dm644 libmpv.pc /app/lib/pkgconfig/mpv.pc
      sources:
          - type: file
            path: libmpv.pc
          - type: archive
            url: https://github.com/mpv-player/mpv/archive/v0.40.0.tar.gz
            sha256: 10a0f4654f62140a6dd4d380dcf0bbdbdcf6e697556863dc499c296182f081a3
            dest: mpv-source
    - name: fredstalker
      buildsystem: simple
      build-options:
          arch:
              x86_64:
                  env:
                      BUNDLE_PATH: build/linux/x64/release/bundle
              aarch64:
                  env:
                      BUNDLE_PATH: build/linux/arm64/release/bundle
          append-path: /usr/lib/sdk/llvm19/bin:/var/lib/flutter/bin
          prepend-ld-library-path: /usr/lib/sdk/llvm19/lib
          env:
              PUB_CACHE: /run/build/fredstalker/.pub-cache
      sources:
          - pubspec-sources.json
          - type: git
            url: https://github.com/Fredolx/fredstalker
            commit: 81066033e3ed9d3fc13daa46ecff1862e8c41685
            tag: v1.0.0
          - type: file
            only-arches:
                - x86_64
            url: https://github.com/microsoft/mimalloc/archive/refs/tags/v2.1.2.tar.gz
            sha256: 2b1bff6f717f9725c70bf8d79e4786da13de8a270059e4ba0bdd262ae7be46eb
            dest: ./build/linux/x64/release
            dest-filename: mimalloc-2.1.2.tar.gz
          - type: file
            only-arches:
                - aarch64
            url: https://github.com/microsoft/mimalloc/archive/refs/tags/v2.1.2.tar.gz
            sha256: 2b1bff6f717f9725c70bf8d79e4786da13de8a270059e4ba0bdd262ae7be46eb
            dest: ./build/linux/arm64/release
            dest-filename: mimalloc-2.1.2.tar.gz
          - type: file
            only-arches:
                - x86_64
            url: https://sqlite.org/2025/sqlite-autoconf-3500100.tar.gz
            sha256: 00a65114d697cfaa8fe0630281d76fd1b77afcd95cd5e40ec6a02cbbadbfea71
            dest: ./build/linux/x64/release/_deps/sqlite3-subbuild/sqlite3-populate-prefix/src
          - type: file
            only-arches:
                - aarch64
            url: https://sqlite.org/2025/sqlite-autoconf-3500100.tar.gz
            sha256: 00a65114d697cfaa8fe0630281d76fd1b77afcd95cd5e40ec6a02cbbadbfea71
            dest: ./build/linux/arm64/release/_deps/sqlite3-subbuild/sqlite3-populate-prefix/src
          - type: patch
            path: sqlite3_flutter_libs/0.5.34-CMakeLists.txt.patch
            dest: .pub-cache/hosted/pub.dev/sqlite3_flutter_libs-0.5.34
      modules:
          - flutter-sdk-3.32.5.json
      build-commands:
          - setup-flutter.sh -C .
          - flutter build linux --release
          - install -D $BUNDLE_PATH/fredstalker /app/bin/fredstalker
          - cp -r $BUNDLE_PATH/lib /app/bin/lib
          - cp -r $BUNDLE_PATH/data /app/bin/data
          - install -Dm755 $BUNDLE_PATH/fredstalker /app/bin/fredstalker
          - install -Dm644 flatpak/fredstalker.desktop /app/share/applications/dev.fredol.fredstalker.desktop
          - install -Dm644 flatpak/dev.fredol.fredstalker.metainfo.xml /app/share/metainfo/dev.fredol.fredstalker.metainfo.xml
          - install -Dm644 flatpak/icons/icon-512.png /app/share/icons/hicolor/256x256@2/apps/dev.fredol.fredstalker.png
          - install -Dm644 flatpak/icons/icon-128.png /app/share/icons/hicolor/128x128/apps/dev.fredol.fredstalker.png
          - install -Dm644 flatpak/icons/icon-32.png /app/share/icons/hicolor/32x32/apps/dev.fredol.fredstalker.png
