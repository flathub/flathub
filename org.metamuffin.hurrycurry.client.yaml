app-id: org.metamuffin.hurrycurry.client
runtime: org.freedesktop.Platform
runtime-version: "23.08"
sdk: org.freedesktop.Sdk
command: hurrycurry
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --device=dri
  - --share=network

build-options:
  arch:
    x86_64:
      env:
        # Only enable link-time optimization when targeting x86_64
        # (causes issues on other architectures)
        SCONS_FLAGS_EXTRA: use_lto=yes

  env:
    BUILD_NAME: hurrycurry

modules:
  - shared-modules/glu/glu-9.json

  - name: scons
    buildsystem: simple
    cleanup: ["*"]

    sources:
      - type: archive
        sha256: 6e928fc97984e719814270f6863f2183b3b72180b0162a5ed09db68c9994100c
        url: https://downloads.sourceforge.net/project/scons/scons/4.8.0/SCons-4.8.0.tar.gz

    build-commands:
      - python3 -m pip install --no-index --no-build-isolation --prefix=/app .

  - name: godot
    buildsystem: simple

    sources:
      - type: archive
        sha256: da14e36448f1efd2955fe85d7ededc9e6ac8c893f76723b4852e7587306c761d
        url: https://downloads.tuxfamily.org/godotengine/4.2.2/godot-4.2.2-stable.tar.xz

      - type: file
        path: custom.py

    build-commands:
      - python3 /app/bin/scons $SCONS_FLAGS_EXTRA profile=custom.py target=editor -j "$FLATPAK_BUILDER_N_JOBS"
      - python3 /app/bin/scons $SCONS_FLAGS_EXTRA profile=custom.py target=template_release -j "$FLATPAK_BUILDER_N_JOBS"
      - install -Dm755 bin/godot.linuxbsd.template_release.* /app/bin/godot
      - install -Dm755 bin/godot.linuxbsd.editor.* /app/bin/godot-editor

  - name: hurrycurry
    buildsystem: simple
    sources:
      - type: archive
        sha256: 89ab3ae4694bc15210b21163d8256a987744c9973ff563d2a15a4b9c90fd9ccd
        url: https://codeberg.org/hurrycurry/hurrycurry/archive/v1.2.1.tar.gz

      - type: file
        sha256: cddc72a740395eaa760c2eb8e757a3f14ec377a286f257df542bd62614c6583a
        url: https://s.metamuffin.org/static/hurrycurry-1.2/book.webp.tar.zst

      - type: archive
        sha256: 872a3b55bff2d3abeb73ba2c9fc680572276e6a4074412f6782834dd02503cb9
        url: https://codeberg.org/hurrycurry/hurrycurry-dist-extra/archive/v1.2.1.tar.gz

    build-commands:
      - tar -xf book.webp.tar.zst -C client/menu/book
      - install -dD /app/share/hurrycurry
      - godot-editor --headless --export-pack wasm32-unknown-unknown /app/share/hurrycurry/client.pck client/project.godot
      - rm /app/bin/godot-editor
      - install -Dm755 hurrycurry /app/bin/hurrycurry
      - install -Dm644 org.metamuffin.hurrycurry.client.desktop /app/share/applications/org.metamuffin.hurrycurry.client.desktop
      - install -Dm644 org.metamuffin.hurrycurry.client.metainfo.xml /app/share/metainfo/org.metamuffin.hurrycurry.client.metainfo.xml
      - >
        for size in {32,64,128,256,512}; do
          ffmpeg -i client/icon.png -vf scale=${size}:${size} "$size.png"
          install -Dm644 "$size.png" "/app/share/icons/hicolor/${size}x${size}/apps/org.metamuffin.hurrycurry.client.png"
        done
