app-id: com.opentabletdriver.OpenTabletDriver
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: start-otd.sh
sdk-extensions:
  - org.freedesktop.Sdk.Extension.dotnet6
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=fallback-x11
  - --share=network
  - --device=all
  - --filesystem=home
modules:
  - name: libnotify
    buildsystem: simple
    sources:
      - type: git
        url: https://gitlab.gnome.org/GNOME/libnotify.git
        commit: 0.8.3
    build-commands:
      - meson _build --prefix=/app -Dtests=false -Dintrospection=enabled -Dgtk_doc=false -Ddocbook_docs=disabled -Dman=false
      - meson compile -C _build
      - meson install -C _build


  - name: libevdev
    sources:
      - type: archive
        url: "https://www.freedesktop.org/software/libevdev/libevdev-1.13.1.tar.xz"
        sha256: "06a77bf2ac5c993305882bc1641017f5bec1592d6d1b64787bad492ab34f2f36"
    buildsystem: simple
    builddir: true
    build-commands:
      - ./configure --prefix=/app/
      - make 
      - make install

  - name: opentabletdriver
    buildsystem: simple
    build-options:
      append-path: "/usr/lib/sdk/dotnet6/bin"
      append-ld-library-path: "/usr/lib/sdk/dotnet6/lib"
      build-args:
        - --share=network
      env:
        PKG_CONFIG_PATH: "/app/lib/pkgconfig:/app/share/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig:/usr/lib/sdk/dotnet6/lib/pkgconfig"
    build-commands:
      - bash build_selfcontained.sh
      - install -Dm644 com.opentabletdriver.OpenTabletDriver.desktop /app/share/applications/com.opentabletdriver.OpenTabletDriver.desktop
      - install -Dm644 512.png /app/share/icons/hicolor/512x512/apps/com.opentabletdriver.OpenTabletDriver.png
      - install -Dm644 256.png /app/share/icons/hicolor/256x256/apps/com.opentabletdriver.OpenTabletDriver.png
      - install -Dm755 start-otd.sh /app/bin/start-otd.sh
      - mv /run/build/opentabletdriver/bin/* /app/bin/
      #- install -Dm755 /run/build/opentabletdriver/bin/OpenTabletDriver.UX.Gtk /run/build/opentabletdriver/bin/OpenTabletDriver.Daemon /run/build/opentabletdriver/bin/OpenTabletDriver.Console /app/bin/
    sources:
      - type: git
        url: https://github.com/OpenTabletDriver/OpenTabletDriver
        commit: v0.6.4.0
      - type: file
        path: com.opentabletdriver.OpenTabletDriver.desktop
      - type: file
        path: 256.png
      - type: file
        path: 512.png
      - type: file
        path: start-otd.sh
      - type: file
        path: build_selfcontained.sh
    post-install:
      - install -Dm644 com.opentabletdriver.OpenTabletDriver.desktop /app/share/applications/com.opentabletdriver.OpenTabletDriver.desktop
      - install -Dm644 512.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/com.opentabletdriver.OpenTabletDriver.png
      - install -Dm644 256.png ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/com.opentabletdriver.OpenTabletDriver.png