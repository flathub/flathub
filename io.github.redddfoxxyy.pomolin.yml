app-id: io.github.redddfoxxyy.pomolin
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk
command: pomolin

modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk/install.sh

  - name: pomolin-add-resources
    buildsystem: simple
    build-commands:
      - install -Dm644 io.github.redddfoxxyy.pomolin.desktop /app/share/applications/io.github.redddfoxxyy.pomolin.desktop
      - install -Dm644 io.github.redddfoxxyy.pomolin.svg /app/share/icons/hicolor/scalable/apps/io.github.redddfoxxyy.pomolin.svg
      - install -Dm644 io.github.redddfoxxyy.pomolin.metainfo.xml /app/share/metainfo/io.github.redddfoxxyy.pomolin.metainfo.xml
    sources:
      - type: file
        path: io.github.redddfoxxyy.pomolin.desktop
      - type: file
        path: io.github.redddfoxxyy.pomolin.svg
      - type: file
        path: io.github.redddfoxxyy.pomolin.metainfo.xml

  - name: pomolin-build
    buildsystem: simple
    build-options:
      env:
        JAVA_HOME: /usr/lib/sdk/openjdk
        PATH: /usr/lib/sdk/openjdk/bin:/usr/bin:/bin
      build-args:
        - --share=network
    sources:
      - type: git
        url: https://github.com/RedddFoxxyy/Pomolin.git
        tag: v1.1.3
        dest: "."
    build-commands:
      - chmod +x ./gradlew
      - ./gradlew createReleaseDistributable
      # Copy the build artifacts to a staging directory for the next module
      - install -d /app/src/pomolin-dist
      - cp -r composeApp/build/compose/binaries/main-release/app/* /app/src/pomolin-dist/

  - name: pomolin-package
    buildsystem: simple
    build-commands:
      # Copy the artifacts from the staging dir to their final location
      - cp -r /app/src/pomolin-dist/* /app/
      # Remove the invalid JVM argument from the app's config file
      - "sed -i '/--illegal-native-access=deny/d' /app/pomolin/lib/app/pomolin.cfg"
      # Create and install the wrapper script
      - |
        cat <<EOF > pomolin-exec.sh
        #!/bin/sh
        exec /app/pomolin/bin/pomolin "\$@"
        EOF
      - install -Dm755 pomolin-exec.sh /app/bin/pomolin

finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --device=dri
  - --filesystem=xdg-documents
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
