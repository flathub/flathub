app-id: dev.lapce.lapce
runtime: org.freedesktop.Platform
runtime-version: 21.08
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: lapce
finish-args:
  - --device=dri
  - --filesystem=home
  - --share=ipc
  - --share=network
  - --socket=wayland
  # Full X11-Support is needed, fallback-x11 doesn't seem to work, yet.
  - --socket=x11
modules:
  - name: lapce
    sources:
      - type: git
        url: https://github.com/lapce/lapce
        tag: v0.1.0
        commit: 8d0b0932b5fa45ea52d1e54d7e57cbf9bca1c490
        x-checker-data:
          type: git
          tag-pattern: "^v([\\d.]+)$"
      # Cargo sources must be updated manually using flatpak-cargo-generator.py.
      # Until https://github.com/lapce/lapce/issues/509 is resolved,
      # '"disable-submodules": true' must be added to these repositories:
      # - https://github.com/lapce/glutin
      # - https://github.com/lapce/winit
      - generated-sources.json
      # Separate .desktop and .metainfo.xml can be deleted with next upstream release.
      - type: file
        url: https://raw.githubusercontent.com/lapce/lapce/db27d5e703fb945a7ca33222de19a06e082f247f/extra/linux/dev.lapce.lapce.desktop
        dest: extra/linux
        dest-filename: dev.lapce.lapce.desktop
        sha256: 07e6b1b685c88b8f23919f58f9e2210a0357836b12026b5a04b0c18b4acfd34a
      - type: file
        url: https://raw.githubusercontent.com/lapce/lapce/db27d5e703fb945a7ca33222de19a06e082f247f/extra/linux/dev.lapce.lapce.metainfo.xml
        dest: extra/linux
        dest-filename: dev.lapce.lapce.metainfo.xml
        sha256: 2de57319ed60f6dc4e11a5f538f7e9ee72caae4a023add84bf3b23e7b579c912
    buildsystem: simple
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml --verbose
      - cargo --offline build --release --verbose
      - install -Dm0755 target/release/lapce /app/bin/lapce
      - install -Dm0644 extra/images/logo.svg /app/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm0644 extra/linux/${FLATPAK_ID}.desktop /app/share/applications/${FLATPAK_ID}.desktop
      - install -Dm0644 extra/linux/${FLATPAK_ID}.metainfo.xml /app/share/metainfo/${FLATPAK_ID}.metainfo.xml
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/lapce/cargo
