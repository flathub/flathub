app-id: org.spyder_ide.spyder
runtime: org.kde.Sdk
runtime-version: '5.15-22.08'
sdk: org.kde.Sdk
command: spyder
rename-desktop-file: spyder.desktop
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '5.15-22.08'
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: spyder
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --share=network
  - --env=PYTHONPATH=/app/lib/python3.10 # Spyder not find zmq
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin # fix QTWEBENGINEPROCESS not found
modules:
  - name: meson
    buildsystem: simple
    build-commands:
      - python3 setup.py build
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/
    sources:
      - type: git
        url: https://github.com/mesonbuild/meson.git
        tag: 1.1.1

  - name: openblas # dependency for scipy
    no-autogen: true
    make-args:
      - DYNAMIC_ARCH=1
      - DYNAMIC_OLDER=1
      - FC=gfortran
      - NO_CBLAS=1
      - NO_LAPACKE=1
      - TARGET=GENERIC
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.3.23.tar.gz
        sha256: 5d9491d07168a5d00116cdc068a40022c3455bf9293c7cb86a65b1054d7e5114
        x-checker-data:
          type: anitya
          project-id: 2540
          url-template: https://github.com/xianyi/OpenBLAS/archive/v$version.tar.gz

    # This generate the dependencies for Spyder, the second part generate recommended dependencies for Spyder and matplotlib
    # Use pyparing 3.0.9, matplotlib could not find it, possibly relate to this https://github.com/matplotlib/matplotlib/issues/26152
    # pipgrip spyder > spyder_pipgrip.txt && sed -i '/^pyqt/d; /^spyder/d' spyder_pipgrip.txt && req2flatpak --requirements-file spyder_pipgrip.txt --target-platforms 310-x86_64 310-aarch64 --outfile spyder_requires.json && python3 flatpak-pip-generator setuptools_scm_git_archive setuptools_scm setuptools_rust pybind11 pyparsing==3.0.9 pillow cppy kiwisolver fonttools cycler meson-python contourpy openpyxl versioneer pandas pythran scipy sympy statsmodels zmq -o spyder_optional && fb
  - spyder_requires.json
  - spyder_optional.json

  - name: python3-matplotlib
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        dest: build/freetype-2.6.1
        url: https://downloads.sourceforge.net/project/freetype/freetype2/2.6.1/freetype-2.6.1.tar.gz
        sha256: 0a3c7dfbda6da1e8fce29232e8e96d987ababbbf71ebc8c75659e4132c367014
      - type: archive
        dest: build/qhull-2020.2
        url: http://www.qhull.org/download/qhull-2020-src-8.0.2.tgz
        sha256: b5c2d7eb833278881b952c8a52d20179eab87766b00b865000469a45c1838b7e
      - type: archive
        url: https://files.pythonhosted.org/packages/e5/59/b859fa2539b4121b016ea85758188203522fc12b0711de8b247cfec3cdac/matplotlib-3.7.2.tar.gz
        sha256: a8cdb91dddb04436bd2f098b8fdf4b81352e68cf4d2c6756fcc414791076569b
        x-checker-data:
          type: pypi
          name: matplotlib

  - name: spyder-kernels
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST} --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/f0/be/c08d65fe5c416a8412415aeb6a5eca482cdc8926a94c1c9a7703508484db/spyder-kernels-2.4.4.tar.gz
        sha256: 363bb0a0e1594cb691637464192f4f19969095469252242b43c092bf305a25dd
        x-checker-data:
          type: pypi
          name: spyder-kernels

  - name: Spyder
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST} --no-build-isolation .
    post-install:
      - install -Dm0644 /app/share/icons/spyder.png /app/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - desktop-file-edit --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/spyder.desktop
    sources:
      - type: git
        url: https://github.com/spyder-ide/spyder
        tag: v5.4.3
        #commit: 2997237948498950406167d9ea1e1b0fa5d06672
        x-checker-data:
          type: pypi
          name: spyder

    # python3 flatpak-pip-generator terminado tornado coloredlogs -o spyder_terminal_deps && fb
  - spyder_terminal_deps.json

  - name: spyder-terminal
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST} --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/00/fe/a89d18983b9f7d881fa16089b418b7febfb9e1a2ea8f5a0ce39e59474859/spyder-terminal-1.2.2.tar.gz
        sha256: 34235070276a0cb255a5c371cbef076a355059a8a8c71fa9805df229ea0335da
        x-checker-data:
          type: pypi
          name: spyder-terminal

  - name: pythonstart
    buildsystem: simple
    build-commands:
      - cp pythonstart ${FLATPAK_DEST}/etc
      - ls -l /app/etc
    sources:
      - type: file
        path: pythonstart

  - name: python3-pyzmq
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST} --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/46/0d/b06cf99a64d4187632f4ac9ddf6be99cd35de06fe72d75140496a8e0eef5/pyzmq-24.0.1.tar.gz
        sha256: 216f5d7dbb67166759e59b0479bca82b8acf9bed6015b526b8eb10143fb08e77
        x-checker-data:
          type: pypi
          name: pyzmq
