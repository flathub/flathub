app-id: org.spyder_ide.spyder
runtime: org.kde.Sdk
runtime-version: 5.15-23.08
sdk: org.kde.Sdk
command: spyder-wrapper
rename-desktop-file: spyder.desktop
base: com.riverbankcomputing.PyQt.BaseApp
base-version: 5.15-23.08
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --filesystem=home
  - --share=network # For installing extra libs
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess # fix QTWEBENGINEPROCESS not found
  - --env=FLATPAK_ISOLATE_PIP=1
  - --env=FLATPAK_IDE_LOGLEVEL=1
  - --env=FLATPAK_PREFER_USER_PACKAGES=1
  - --env=PYTHONPATH=/app/org.spyder_ide.spyder/data/python/lib/python3.11/
modules:
  - name: openblas # dependency for scipy and numpy
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DBUILD_TESTING:BOOL=OFF
      - -DDYNAMIC_ARCH:BOOL=ON
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.3.25.tar.gz
        sha256: 4c25cb30c4bb23eddca05d7d0a85997b8db6144f5464ba7f8c09ce91e2f35543
        x-checker-data:
          type: anitya
          project-id: 2540
          url-template: https://github.com/xianyi/OpenBLAS/archive/v$version.tar.gz

    # For rtree
  - name: libspatialindex
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://github.com/libspatialindex/libspatialindex/releases/download/1.9.3/spatialindex-src-1.9.3.tar.bz2
        sha256: 4a529431cfa80443ab4dcd45a4b25aebbabe1c0ce2fa1665039c80e999dcc50a
        x-checker-data:
          type: anitya
          project-id: 4864
          stable-only: true
          url-template: https://github.com/libspatialindex/libspatialindex/releases/download/$version/spatialindex-src-$version.tar.bz2

  - name: libzmq
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://github.com/zeromq/libzmq/releases/download/v4.3.5/zeromq-4.3.5.tar.gz
        sha256: 6653ef5910f17954861fe72332e68b03ca6e4d9c7160eb3a8de5a5a913bfab43
        x-checker-data:
          type: anitya
          project-id: 16245
          stable-only: true
          url-template: https://github.com/zeromq/libzmq/releases/download/v$version/zeromq-$version.tar.gz

    # Run ./generate_python_deps.sh to generate and update these dependencies
  - spyder_deps_additional.json
  - spyder_deps_1.json
  - spyder_deps_2.json
  - spyder_deps_3.json
  - spyder_deps_rust.json

  - name: python-numpy
    buildsystem: simple
    build-options:
      ldflags: -lgfortran
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/dd/2b/205ddff2314d4eea852e31d53b8e55eb3f32b292efc3dd86bd827ab9019d/numpy-1.26.2.tar.gz
        sha256: f65738447676ab5777f11e6bbbdb8ce11b785e105f690bc45966574816b6d3ea
        x-checker-data:
          type: pypi
          name: numpy

  - spyder_deps_numerical.json

  - name: python3-matplotlib
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        dest: build/freetype-2.6.1
        url: https://downloads.sourceforge.net/project/freetype/freetype2/2.6.1/freetype-2.6.1.tar.gz
        sha256: 0a3c7dfbda6da1e8fce29232e8e96d987ababbbf71ebc8c75659e4132c367014
      - type: archive
        dest: build/qhull-2020.2
        url: http://www.qhull.org/download/qhull-2020-src-8.0.2.tgz
        sha256: b5c2d7eb833278881b952c8a52d20179eab87766b00b865000469a45c1838b7e
      - type: archive
        url: https://files.pythonhosted.org/packages/b4/1b/1b80fcc6b7f33a4c7fa025e944416f8b63fa8d278fad32470c82a2edf319/matplotlib-3.8.1.tar.gz
        sha256: 044df81c1f6f3a8e52d70c4cfcb44e77ea9632a10929932870dfaa90de94365d
        x-checker-data:
          type: pypi
          name: matplotlib

  - name: spyder-kernels
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/0c/66/0411318c99c1de3660e1edf5526fe2b7397253405e6075b7aaf92b136960/spyder-kernels-2.5.0.tar.gz
        sha256: 3368426c04457e0211884e9274fa47eb556252ba4c073df275e83c65df7ba2a1
        x-checker-data:
          type: pypi
          name: spyder-kernels

  - name: spyder-terminal
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/00/fe/a89d18983b9f7d881fa16089b418b7febfb9e1a2ea8f5a0ce39e59474859/spyder-terminal-1.2.2.tar.gz
        sha256: 34235070276a0cb255a5c371cbef076a355059a8a8c71fa9805df229ea0335da
        x-checker-data:
          type: pypi
          name: spyder-terminal

  - name: Spyder
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    post-install:
      - install -Dm0644 /app/share/icons/spyder.png /app/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - desktop-file-edit --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/spyder.desktop
      - desktop-file-edit --set-key=Exec --set-value=spyder-wrapper ${FLATPAK_DEST}/share/applications/spyder.desktop
    sources:
      - type: git
        url: https://github.com/spyder-ide/spyder
        tag: v5.5.0
        commit: b4c4e1a16a2f930e3cce2da1741330cb1f6b5f60
        x-checker-data:
          type: pypi
          name: spyder
      - type: patch
        path: fix_appdata.patch

    # Tk is not included in Sdk and cannot be install with pip. Spyder itself does not require Tk but some libs like PySimpleGUI needs it.
  - name: tkinter
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: git
        url: https://github.com/kevinsmia1939/tkinter-standalone
        commit: 23c793bad2429f4a81eee9f50e2d07ae845b7785
    modules:
      - name: tcl
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod 755 /app/lib/libtcl*.so
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tcl8.6.13-src.tar.gz
            sha256: 43a1fae7412f61ff11de2cfd05d28cfc3a73762f354a417c62370a54e2caf066
            x-checker-data:
              type: anitya
              project-id: 4941
              stable-only: true
              url-template: https://prdownloads.sourceforge.net/tcl/tcl$version-src.tar.gz
      - name: tk
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod 755 /app/lib/libtk*.so
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tk8.6.13-src.tar.gz
            sha256: 2e65fa069a23365440a3c56c556b8673b5e32a283800d8d9b257e3f584ce0675
            x-checker-data:
              type: anitya
              project-id: 11426
              stable-only: true
              url-template: https://prdownloads.sourceforge.net/tcl/tk$version-src.tar.gz

  - name: Spyder-flatpak-wrapper
    buildsystem: meson
    config-opts:
      - -Deditor_binary=/app/bin/spyder
      - -Deditor_args=--new-instance
      - -Dprogram_name=spyder-wrapper
      - -Deditor_title=Spyder IDE
      - -Dsdk_version=23.08
    sources:
      - type: git
        url: https://github.com/flathub/ide-flatpak-wrapper.git
        commit: e42aba9acceceb234216e60bb690705992517907
      - type: patch
        path: ide_first_run.patch

  - name: pythonstart
    buildsystem: simple
    build-commands:
      - cp pythonstart ${FLATPAK_DEST}/etc
    sources:
      - type: file
        path: pythonstart
