app-id: org.spyder_ide.spyder
runtime: org.kde.Sdk
runtime-version: 5.15-23.08
sdk: org.kde.Sdk
command: spyder-wrapper
rename-desktop-file: spyder.desktop
base: com.riverbankcomputing.PyQt.BaseApp
base-version: 5.15-23.08
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --filesystem=home
  - --share=network # For installing extra libs
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess # fix QTWEBENGINEPROCESS not found
  - --env=FLATPAK_ISOLATE_PIP=1
  - --env=FLATPAK_IDE_LOGLEVEL=1
  - --env=FLATPAK_PREFER_USER_PACKAGES=1
  - --env=PYTHONPATH=/app/org.spyder_ide.spyder/data/python/lib/python3.11/
modules:
  - name: openblas # dependency for scipy and numpy
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DBUILD_TESTING:BOOL=OFF
      - -DDYNAMIC_ARCH:BOOL=ON
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.3.26.tar.gz
        sha256: 4e6e4f5cb14c209262e33e6816d70221a2fe49eb69eaf0a06f065598ac602c68
        x-checker-data:
          type: anitya
          project-id: 2540
          url-template: https://github.com/xianyi/OpenBLAS/archive/v$version.tar.gz

    # For rtree
  - name: libspatialindex
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://github.com/libspatialindex/libspatialindex/releases/download/1.9.3/spatialindex-src-1.9.3.tar.bz2
        sha256: 4a529431cfa80443ab4dcd45a4b25aebbabe1c0ce2fa1665039c80e999dcc50a
        x-checker-data:
          type: anitya
          project-id: 4864
          stable-only: true
          url-template: https://github.com/libspatialindex/libspatialindex/releases/download/$version/spatialindex-src-$version.tar.bz2

  - name: libzmq
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://github.com/zeromq/libzmq/releases/download/v4.3.5/zeromq-4.3.5.tar.gz
        sha256: 6653ef5910f17954861fe72332e68b03ca6e4d9c7160eb3a8de5a5a913bfab43
        x-checker-data:
          type: anitya
          project-id: 16245
          stable-only: true
          url-template: https://github.com/zeromq/libzmq/releases/download/v$version/zeromq-$version.tar.gz

    # Run ./generate_python_deps.sh to generate and update these dependencies
  - spyder_deps_additional.json
  - spyder_deps_1.json
  - spyder_deps_2.json
  - spyder_deps_3.json
  - spyder_deps_rust.json
  - spyder_deps_terminal.json

  - name: python-numpy
    buildsystem: simple
    build-options:
      ldflags: -lgfortran
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/65/6e/09db70a523a96d25e115e71cc56a6f9031e7b8cd166c1ac8438307c14058/numpy-1.26.4.tar.gz
        sha256: 2a02aba9ed12e4ac4eb3ea9421c420301a0c6460d9830d74a9df87efa4912010
        x-checker-data:
          type: pypi
          name: numpy

  - spyder_deps_numerical.json

  - name: python3-matplotlib
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        dest: build/freetype-2.6.1
        url: https://downloads.sourceforge.net/project/freetype/freetype2/2.6.1/freetype-2.6.1.tar.gz
        sha256: 0a3c7dfbda6da1e8fce29232e8e96d987ababbbf71ebc8c75659e4132c367014
      - type: archive
        dest: build/qhull-2020.2
        url: http://www.qhull.org/download/qhull-2020-src-8.0.2.tgz
        sha256: b5c2d7eb833278881b952c8a52d20179eab87766b00b865000469a45c1838b7e
      - type: archive
        url: https://files.pythonhosted.org/packages/9a/aa/607a121331d5323b164f1c0696016ccc9d956a256771c4d91e311a302f13/matplotlib-3.8.3.tar.gz
        sha256: 7b416239e9ae38be54b028abbf9048aff5054a9aba5416bef0bd17f9162ce161
        x-checker-data:
          type: pypi
          name: matplotlib

  - name: spyder-kernels
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/bc/5b/ac3567fba88fcd1a9cecdc3ab62c4e9255ad29d1717d835a23b1a91f35a4/spyder-kernels-2.5.1.tar.gz
        sha256: 05042a3f97b25f17cdfa8d75011fd79aaf027523348a9dfff0f5a20bddb0b9b0
        x-checker-data:
          type: pypi
          name: spyder-kernels

  - name: python-lsp-server
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/60/fc/1779454d6fb22dcda94c2b892bdc40cfd448007a68ee57935b491891707b/python-lsp-server-1.10.1.tar.gz
        sha256: ec4c5706af67a265a19173fe4beb3b0a2c1626fa33a15ea952c2f288798b8c0d
        x-checker-data:
          type: pypi
          name: python-lsp-server

  - name: Spyder
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    post-install:
      - install -Dm0644 /app/share/icons/spyder.png /app/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - desktop-file-edit --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/spyder.desktop
      - desktop-file-edit --set-key=Exec --set-value=spyder-wrapper ${FLATPAK_DEST}/share/applications/spyder.desktop
    sources:
      - type: git
        url: https://github.com/spyder-ide/spyder
        tag: v5.5.2
        commit: 1754f9ac9964e9323ac20bd52d3e8b375c6de841
        x-checker-data:
          type: pypi
          name: spyder
      - type: patch
        path: fix_appdata.patch

  - name: spyder-terminal
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/00/fe/a89d18983b9f7d881fa16089b418b7febfb9e1a2ea8f5a0ce39e59474859/spyder-terminal-1.2.2.tar.gz
        sha256: 34235070276a0cb255a5c371cbef076a355059a8a8c71fa9805df229ea0335da
        x-checker-data:
          type: pypi
          name: spyder-terminal

    # Tk is not included in Sdk and cannot be install with pip. Spyder itself does not require Tk but some libs like PySimpleGUI needs it.
  - name: tkinter
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: git
        url: https://github.com/iwalton3/tkinter-standalone
        commit: 88aa05075d90d393a29a484bce676e237d311082
    modules:
      - name: tcl
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod 755 /app/lib/libtcl*.so
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tcl8.6.14-src.tar.gz
            sha256: 5880225babf7954c58d4fb0f5cf6279104ce1cd6aa9b71e9a6322540e1c4de66
            x-checker-data:
              type: anitya
              project-id: 4941
              stable-only: true
              url-template: https://prdownloads.sourceforge.net/tcl/tcl$version-src.tar.gz
      - name: tk
        buildsystem: autotools
        subdir: unix
        post-install:
          - chmod 755 /app/lib/libtk*.so
        cleanup:
          - /bin
          - /lib/pkgconfig
          - /man
        sources:
          - type: archive
            url: https://prdownloads.sourceforge.net/tcl/tk8.6.14-src.tar.gz
            sha256: 8ffdb720f47a6ca6107eac2dd877e30b0ef7fac14f3a84ebbd0b3612cee41a94
            x-checker-data:
              type: anitya
              project-id: 11426
              stable-only: true
              url-template: https://prdownloads.sourceforge.net/tcl/tk$version-src.tar.gz

  - name: Spyder-flatpak-wrapper
    buildsystem: meson
    config-opts:
      - -Deditor_binary=/app/bin/spyder
      - -Deditor_args=--new-instance
      - -Dprogram_name=spyder-wrapper
      - -Deditor_title=Spyder IDE
      - -Dsdk_version=23.08
    sources:
      - type: git
        url: https://github.com/flathub/ide-flatpak-wrapper.git
        commit: e42aba9acceceb234216e60bb690705992517907
      - type: patch
        path: ide_first_run.patch

  - name: pythonstart
    buildsystem: simple
    build-commands:
      - cp pythonstart ${FLATPAK_DEST}/etc
    sources:
      - type: file
        path: pythonstart
