id: md.thomas.shard.launcher
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node20
  - org.freedesktop.Sdk.Extension.openjdk21
command: shard-launcher

finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --share=ipc
  - --share=network
  - --persist=.shard
  - --env=FLATPAK=1
  - --env=PATH=/app/jre/bin:/app/bin:/usr/bin

build-options:
  append-path: /usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/node20/bin
  env:
    CARGO_HOME: /run/build/shard-launcher/cargo
    npm_config_nodedir: /usr/lib/sdk/node20

modules:
  # Install OpenJDK 21 for running Minecraft
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk21/install.sh

  - name: shard-launcher
    buildsystem: simple
    build-options:
      env:
        CARGO_NET_OFFLINE: 'true'
    sources:
      - type: git
        url: https://github.com/th0rgal/shard.git
        tag: v0.1.14
        commit: 17ff30a4048aff4e0b2fd7476211040a94407d59
      # Cargo vendored sources (generated by flatpak-cargo-generator)
      - cargo-sources.json
      # Node vendored sources (generated by flatpak-node-generator)
      - node-sources.json
      # Cargo config to use vendored sources
      - type: inline
        contents: |
          [source.crates-io]
          replace-with = "vendored-sources"
          [source.vendored-sources]
          directory = "cargo-sources"
        dest: .cargo
        dest-filename: config.toml
      # package-lock.json for npm ci
      - type: file
        path: package-lock.json
        dest: desktop
    build-commands:
      # Build frontend
      - cd desktop && npm ci --offline --legacy-peer-deps
      - cd desktop && npm run build
      # Build Tauri/Rust backend
      - cd desktop/src-tauri && cargo build --release --offline
      # Install binary
      - install -Dm755 desktop/src-tauri/target/release/shard-launcher /app/bin/shard-launcher
      # Install desktop file from upstream
      - install -Dm644 packaging/flathub/md.thomas.shard.launcher.desktop /app/share/applications/md.thomas.shard.launcher.desktop
      # Install icons
      - install -Dm644 desktop/src-tauri/icons/icon.png /app/share/icons/hicolor/256x256/apps/md.thomas.shard.launcher.png
      - install -Dm644 desktop/src-tauri/icons/128x128.png /app/share/icons/hicolor/128x128/apps/md.thomas.shard.launcher.png
      - install -Dm644 desktop/src-tauri/icons/32x32.png /app/share/icons/hicolor/32x32/apps/md.thomas.shard.launcher.png
      # Install metainfo from upstream
      - install -Dm644 packaging/flathub/md.thomas.shard.launcher.metainfo.xml /app/share/metainfo/md.thomas.shard.launcher.metainfo.xml
