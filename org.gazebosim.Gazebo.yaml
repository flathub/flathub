app-id: org.gazebosim.Gazebo
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: '5.15'
command: gazebo
#rename-icon: gazebo.png
#rename-desktop-file: gazebo.desktop
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --filesystem=home
cleanup:
  - /include
  - /lib/cmake
  - /share/doc
  - "*.la"
  - "*.a"

modules:
  - shared-modules/glew/glew.json
  - shared-modules/glu/glu-9.json
  
  - name: HDF5
    sources:
      - type: archive
        url: https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.12/hdf5-1.12.0/src/hdf5-1.12.0.tar.gz
        sha256: a62dcb276658cb78e6795dd29bf926ed7a9bc4edf6e77025cd2c689a8f97c17a
    cleanup:
      - "/share/hdf5_examples"

    ## Ignition-msgs need Protobuf with -fPIC flag  
  #- name: Protobuf
    #buildsystem: cmake
    #subdir: cmake
    #config-opts:
      #- -Dprotobuf_BUILD_TESTS:BOOL=OFF
      #- -Dprotobuf_BUILD_EXAMPLES:BOOL=OFF
    #build-options:
      #cflags: '-fPIC'
      #ldflags: '-fpic'
      #cxxflags: '-fpic'
    #sources:
      #- type: archive
        #url: https://github.com/protocolbuffers/protobuf/releases/download/v3.15.6/protobuf-cpp-3.15.6.tar.gz
        #sha256: bbdfb7455431d7d58666e8a2996d14b236718ff238eecde10646581e4c87f168
        
  - name: lapack
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TESTING=OFF
      - -DLAPACKE=ON
      - -DCBLAS=ON
    sources:
      - type: archive
        url: https://github.com/Reference-LAPACK/lapack/archive/v3.9.0.tar.gz
        sha256: 106087f1bb5f46afdfba7f569d0cbe23dacb9a07cd24733765a0e89dbe1ad573
    cleanup:
      - /lib/cmake

  - name: Simbody
    buildsystem: cmake
    config-opts:
      - -DINSTALL_DOCS:BOOL=OFF
      - -DBUILD_TESTS_AND_EXAMPLES_STATIC:BOOL=OFF
    sources:
      - type: archive
        url: https://github.com/simbody/simbody/archive/refs/tags/Simbody-3.7.tar.gz
        sha256: d371a92d440991400cb8e8e2473277a75307abb916e5aabc14194bea841b804a
    #cleanup:
      #- /share/doc
        
  - name: ORGE
    buildsystem: cmake
    config-opts:
      - -DOGRE_INSTALL_DOCS:BOOL=OFF
      - -DOGRE_BUILD_COMPONENT_OVERLAY_IMGUI:BOOL=OFF
      - -DOGRE_BUILD_SAMPLES:BOOL=OFF
      - -DOGRE_BUILD_TESTS:BOOL=OFF
    sources:
      - type: archive
        url: https://github.com/OGRECave/ogre/archive/v1.12.12.zip
        sha256: 87cef6258d65bb03207e150fcd89b9b94ef94609ef657c29ef4991d0777de741
    modules:
      - name: pugixml
        buildsystem: cmake
        sources:
          - type: archive
            url: https://github.com/zeux/pugixml/releases/download/v1.11.4/pugixml-1.11.4.tar.gz
            sha256: 8ddf57b65fb860416979a3f0640c2ad45ddddbbafa82508ef0a0af3ce7061716
            
  - name: gperftools
    sources:
      - type: archive
        url: https://github.com/gperftools/gperftools/archive/refs/tags/gperftools-2.9.1.tar.gz
        sha256: 484a88279d2fa5753d7e9dea5f86954b64975f20e796a6ffaf2f3426a674a06a
        
  - name: Eigen3
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.3.9/eigen-3.3.9.tar.bz2
        sha256: 0fa5cafe78f66d2b501b43016858070d52ba47bd9b1016b0165a7b8e04675677
    cleanup: 
      - "*"
        
  - name: DART
    buildsystem: cmake
    config-opts:
      - -DCMAKE_INSTALL_PREFIX:PATH=/app
      - -DBUILD_SHARED_LIBS:BOOL=ON
    build-options:
      env:
        LIBRARY_PATH: "/app/lib:/usr/lib"
        LD_LIBRARY_PATH: "/app/lib:/usr/lib"
    sources:
      - type: archive
        url: https://github.com/dartsim/dart/archive/refs/tags/v6.10.1.tar.gz
        sha256: bf19cdef8e28dbc4059dcbb11997576d6e1d825791bd756e8272d2ddc5b147ce
    modules:
      - name: libccd
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/danfis/libccd/archive/refs/tags/v2.1.tar.gz
            sha256: 542b6c47f522d581fbf39e51df32c7d1256ac0c626e7c2b41f1040d4b9d50d1e
      - name: libQGLViewer
        buildsystem: qmake
        subdir: QGLViewer
        build-options:
          env:
            LIBRARY_PATH: "/app/lib:/usr/lib"
            LD_LIBRARY_PATH: "/app/lib:/usr/lib"
        config-opts:
          - LIB_DIR=/app/lib
          - INCLUDE_DIR=/app/include
          - PREFIX=/app
        sources:
          - type: archive
            url: http://www.libqglviewer.com/src/libQGLViewer-2.7.2.tar.gz
            sha256: e2d2799dec5cff74548e951556a1fa06a11d9bcde2ce6593f9c27a17543b7c08
        # Optional dep for FCL
        # Dart 6.6.2 does not support newer Octomap yet.
        # https://github.com/dartsim/dart/issues/1078
      - name: OctoMap
        builddir: true
        buildsystem: cmake
        config-opts:
          - -DCMAKE_BUILD_TYPE:STRING=Release
        sources:
          - type: archive
            url: https://github.com/OctoMap/octomap/archive/refs/tags/v1.8.1.tar.gz
            sha256: 8b18ef7693e87f1400b9a8bc41f86e3b28259ac98c0b458037232652380aa6af
      - name: FCL
        buildsystem: cmake
        config-opts:
          - -DBUILD_TESTING:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/flexible-collision-library/fcl/archive/refs/tags/v0.6.1.tar.gz
            sha256: c8a68de8d35a4a5cd563411e7577c0dc2c626aba1eef288cb1ca88561f8d8019
      - name: ASSIMP
        buildsystem: cmake-ninja
        config-opts:
          - -DASSIMP_BUILD_TESTS:BOOL=OFF
          - -DASSIMP_BUILD_DOCS:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/assimp/assimp/archive/refs/tags/v5.0.1.tar.gz
            sha256: 11310ec1f2ad2cd46b95ba88faca8f7aaa1efe9aa12605c55e3de2b977b3dbfc
      - name: Boost
        buildsystem: simple
        build-commands:
          - ./bootstrap.sh --prefix=/app
          - ./b2 install --build-type=complete link=shared --layout=versioned runtime-link=shared cxxflags="$CXXFLAGS" linkflags="$LDFLAGS" -j $FLATPAK_BUILDER_N_JOBS
        sources:
          - type: archive
            url: https://dl.bintray.com/boostorg/release/1.75.0/source/boost_1_75_0.tar.gz
            sha256: aeb26f80e80945e82ee93e5939baebdca47b9dee80a07d3144be1e1a6a66dd6a
      - name: TinyXML2
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/leethomason/tinyxml2/archive/refs/tags/8.0.0.tar.gz
            sha256: 6ce574fbb46751842d23089485ae73d3db12c1b6639cda7721bf3a7ee862012c
      - name: IPOPT 
        sources:
          - type: archive
            url: https://github.com/coin-or/Ipopt/archive/refs/tags/releases/3.13.4.tar.gz
            sha256: 1fdd0f8ea637856d66b1ebdd7d52ad1b8b8c1142d1a4ce0976b200ab280e5683
      - name: NLopt
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/stevengj/nlopt/archive/refs/tags/v2.7.0.tar.gz
            sha256: b881cc2a5face5139f1c5a30caf26b7d3cb43d69d5e423c9d78392f99844499f
      - name: ODE
        buildsystem: cmake-ninja
        builddir: true
        sources:
          - type: archive
            url: https://bitbucket.org/odedevs/ode/downloads/ode-0.16.2.tar.gz
            sha256: b26aebdcb015e2d89720ef48e0cb2e8a3ca77915f89d853893e7cc861f810f22
      - name: Bullet
        buildsystem: cmake-ninja
        config-opts:
          - -DBUILD_UNIT_TESTS:BOOL=OFF
          - -DINCLUDE_INSTALL_DIR:PATH=/app/include/bullet
          - -DBUILD_EXTRAS:BOOL=ON
          - -DBUILD_SHARED_LIBS:BOOL=ON
          - -DINSTALL_EXTRA_LIBS:BOOL=ON
          - -DINSTALL_LIBS:BOOL=ON
        build-options:
          env:
            LIBRARY_PATH: "/app/lib:/usr/lib"
            LD_LIBRARY_PATH: "/app/lib:/usr/lib"
        sources:
          - type: archive
            url: https://github.com/bulletphysics/bullet3/archive/refs/tags/3.09.tar.gz
            sha256: f2feef9322329c0571d9066fede2db0ede92b19f7f7fdf54def3b4651f02af03
      - name: FLANN
        buildsystem: cmake-ninja
        builddir: true
        config-opts:
          - -DFLANN_LIB_INSTALL_DIR:PATH=/app/lib
          - -DBUILD_MATLAB_BINDINGS:BOOL=OFF
          - -DBUILD_EXAMPLES:BOOL=OFF
          - -DBUILD_TESTS:BOOL=OFF
          - -DBUILD_DOC:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/flann-lib/flann/archive/refs/tags/1.9.1.tar.gz
            sha256: b23b5f4e71139faa3bcb39e6bbcc76967fbaf308c4ee9d4f5bfbeceaa76cc5d3
          - type: patch
            path: 0001-src-cpp-fix-cmake-3.11-build.patch
        # urdfdom still use TinyXML
      - name: TinyXML
        sources:
          - type: archive
            url: http://mirrors.kodi.tv/build-deps/sources/tinyxml-2.6.2_2.tar.gz
            sha256: 8164c9ad48b9028667768a584d62f7760cfbfb90d0dd6214ad174403058da10c
          - type: script
            dest-filename: autogen.sh
            commands:
              - 'autoreconf -vfi'
      - name: urdfdom_headers
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ros/urdfdom_headers/archive/refs/tags/1.0.5.tar.gz
            sha256: 76a68657c38e54bb45bddc4bd7d823a3b04edcd08064a56d8e7d46b9912035ac
      - name: console_bridge
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ros/console_bridge/archive/refs/tags/0.3.0.tar.gz
            sha256: 1b43a1b8d3e762415290d4ba9ef68beb3c8412f340aa053d2b1beec660685a69
      - name: urdfdom
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ros/urdfdom/archive/refs/tags/1.0.4.tar.gz
            sha256: 8f3d56b0cbc4b84436d8baf4c8346cd2ee7ffb257bba5ddd9892c41bf516edc4

  - name: Gazebo
    buildsystem: cmake
    config-opts:
      - -DHDF5_INCLUDE_DIRS:PATH=/app/include
      #- -DENABLE_TESTING:BOOL=OFF
      #- -DBUILD_DOCUMENTATION:BOOL=OFF
      #- -DCMAKE_BUILD_TYPE:STRING=Release
    #post-install:
      #- install -Dm644 avogadro/icons/avogadro2_64.png ${FLATPAK_DEST}/share/icons/hicolor/64x64/apps/$FLATPAK_ID.png
      #- install -Dm644 avogadro/icons/avogadro2_128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/$FLATPAK_ID.png
      #- install -Dm644 avogadro/icons/avogadro2_256.png ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/$FLATPAK_ID.png
      #- install -Dm644 avogadro/icons/avogadro2_512.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/$FLATPAK_ID.png
      #- desktop-file-edit --set-key=Icon --set-value=$FLATPAK_ID ${FLATPAK_DEST}/share/applications/avogadro2.desktop
      #- install -Dm644 $FLATPAK_ID.metainfo.xml ${FLATPAK_DEST}/share/metainfo/$FLATPAK_ID.metainfo.xml
    sources:
      - type: archive
        url: https://github.com/osrf/gazebo/archive/refs/tags/gazebo11_11.5.0.tar.gz
        sha256: cd46d85e01aa40ad181a7b0afcbe23dfd13ecdfb6ea37b881655205d8fc1aec0
      - type: file
        path: org.gazebosim.Gazebo.metainfo.xml
    modules:
      - name: libxml2
        config-opts:
          - --without-python
        sources:
          - type: archive
            url: https://gitlab.gnome.org/GNOME/libxml2/-/archive/v2.9.10/libxml2-v2.9.10.tar.gz
            sha256: f07dab13bf42d2b8db80620cce7419b3b87827cc937c8bb20fe13b8571ee9501
      - name: Ignition-CMake
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-cmake/archive/refs/tags/ignition-cmake2_2.5.0.tar.gz
            sha256: 7b8ae0f55c066776f991250f4e84e8af57e76ccf69f9a841a8906a3805e368de
      - name: Ignition-tools
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-tools/archive/refs/tags/ignition-tools_1.1.0.tar.gz
            sha256: 475141593023cb37a05a5eaddee1bb400faa9056272173838df36aef2d982f94
      - name: SWIG
        build-options:
          prefix: ${FLATPAK_DEST}
        sources:
          - type: archive
            url: https://sourceforge.net/projects/swig/files/swig/swig-4.0.2/swig-4.0.2.tar.gz
            sha256: d53be9730d8d58a16bf0cbd1f8ac0c0c3e1090573168bfa151b01eb47fa906fc
      - name: Ignition-math
        builddir: true
        buildsystem: cmake
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-math/archive/refs/tags/ignition-math6_6.8.0.tar.gz
            sha256: 07c4fa9eeaa51fe2b4ee2855ea69bb16571d7e6c315b8b0726fc4383b64303a1
      - name: Ignition-utils
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-utils/archive/refs/tags/ignition-utils1_1.0.0.tar.gz
            sha256: bd024164f12f66e125b544602ec481f6760d5a710aeb62d34a015fb598ee5a0a
      - name: Ignition-plugin
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-plugin/archive/refs/tags/ignition-plugin_1.2.0.tar.gz
            sha256: 476b8a50233c05fec5ab3eb85703a19ff3afcd18c5d55e8de0046dca4940fd42
        # Ignition-msgs need Protobuf with -fPIC flag  
      - name: Protobuf
        buildsystem: cmake
        subdir: cmake
        config-opts:
          - -Dprotobuf_BUILD_TESTS:BOOL=OFF
          - -Dprotobuf_BUILD_EXAMPLES:BOOL=OFF
        build-options:
          cflags: '-fPIC'
          ldflags: '-fPIC'
          cxxflags: '-fPIC'
        sources:
          - type: archive
            url: https://github.com/protocolbuffers/protobuf/releases/download/v3.15.6/protobuf-cpp-3.15.6.tar.gz
            sha256: bbdfb7455431d7d58666e8a2996d14b236718ff238eecde10646581e4c87f168
      - name: Ignition-msgs
        buildsystem: cmake
        builddir: true
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-msgs/archive/refs/tags/ignition-msgs7_7.0.0.tar.gz
            sha256: d303d2060d59f7bf834ece734f83d3b12db906f031ad98a19e694cd67855e691
        # Needed by Ignition-transport
      - name: ZeroMQ
        buildsystem: cmake-ninja
        builddir: true
        sources:
          - type: archive
            url: https://github.com/zeromq/libzmq/releases/download/v4.3.4/zeromq-4.3.4.tar.gz
            sha256: c593001a89f5a85dd2ddf564805deb860e02471171b3f204944857336295c3e5
        # Needed by Ignition-transport
      - name: CppZMQ
        buildsystem: cmake-ninja
        builddir: true
        config-opts:
          - -DCPPZMQ_BUILD_TESTS:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/zeromq/cppzmq/archive/refs/tags/v4.7.1.tar.gz
            sha256: 9853e0437d834cbed5d3c223bf1d755cadee70e7c964c6e42c4c6783dee5d02c
      - name: Ignition-transport
        buildsystem: cmake
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-transport/archive/refs/tags/ignition-transport10_10.0.0.tar.gz
            sha256: 3c0ebe70a4343e5206bd145016350b925be3a0619a10e7dcb6e8d48326dda8f1
            # Without this patch, build fail with error ld cannot find -lstdc++fs, no clue how to fix it properly
          - type: patch
            path: remove_stdc++fs.patch
      - name: Ignition-common
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-common/archive/refs/tags/ignition-common4_4.0.0.tar.gz
            sha256: 06169fd8bccf41cceb08f5590e6c3059797cb85b52686e76c4e93fd7de937ac2
      - name: libzip
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/nih-at/libzip/releases/download/v1.7.3/libzip-1.7.3.tar.gz
            sha256: 0e2276c550c5a310d4ebf3a2c3dfc43fb3b4602a072ff625842ad4f3238cb9cc
      - name: JSONCPP
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/nih-at/libzip/releases/download/v1.7.3/libzip-1.7.3.tar.gz
            sha256: 0e2276c550c5a310d4ebf3a2c3dfc43fb3b4602a072ff625842ad4f3238cb9cc    
      - name: Ignition-fuel-tools
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-fuel-tools/archive/refs/tags/ignition-fuel-tools6_6.0.0.tar.gz
            sha256: 7be5f00cab43127109b598e01ebe76f173e259e3ff4df2e1c220def19a9de9be
        modules:
          - name: libzip
            buildsystem: cmake-ninja
            sources:
              - type: archive
                url: https://github.com/nih-at/libzip/releases/download/v1.7.3/libzip-1.7.3.tar.gz
                sha256: 0e2276c550c5a310d4ebf3a2c3dfc43fb3b4602a072ff625842ad4f3238cb9cc
          - name: JSONCPP
            buildsystem: cmake-ninja
            sources:
              - type: archive
                url: https://github.com/open-source-parsers/jsoncpp/archive/refs/tags/1.9.4.tar.gz
                sha256: e34a628a8142643b976c7233ef381457efad79468c67cb1ae0b83a33d7493999
          - name: yaml-cpp
            buildsystem: cmake
            builddir: true
            config-opts:
              - -DYAML_BUILD_SHARED_LIBS:BOOL=ON
              - -DYAML_CPP_BUILD_TESTS:BOOL=OFF
            sources:
              - type: archive
                url: https://github.com/jbeder/yaml-cpp/archive/refs/tags/yaml-cpp-0.6.3.tar.gz
                sha256: 77ea1b90b3718aa0c324207cb29418f5bced2354c2e483a9523d98c3460af1ed
      - name: Ignition-gui
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-gui/archive/refs/tags/ignition-gui5_5.0.0.tar.gz
            sha256: aa78224fbb86efa5b05a8e12daac9eeea9fd4f568ae3c4cee4e9d571e670e2ca
      - name: Ignition-physics
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-physics/archive/refs/tags/ignition-physics4_4.0.0.tar.gz
            sha256: b7128f5666a2a7ff60bfb03de7f1d08c194bddf3c8e52c6e3e3d05e6b4421494
      - name: Ignition-sensors
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-sensors/archive/refs/tags/ignition-sensors5_5.0.0.tar.gz
            sha256: 2484b82d2122633956fdf3fab9e8a41fd8c18de3055d059ec461c9b9153c3257
      - name: Ignition-rendering
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-rendering/archive/refs/tags/ignition-rendering5_5.0.0.tar.gz
            sha256: 99527b4b96049184a6da53a895b55568093e26008e1fcde6655e8014ab897c74
      - name: SDFormat
        buildsystem: cmake
        sources:
          - type: archive
            url: https://github.com/osrf/sdformat/archive/refs/tags/sdformat11_11.0.0.tar.gz
            sha256: 34c1ac9fdbd15d67a5f4dd94a0f03ea7eb037e2d7aa80ad320ca828509d5cbf7
      - name: Ignition
        buildsystem: cmake
        sources:
          - type: archive
            url: https://github.com/ignitionrobotics/ign-gazebo/archive/refs/tags/ignition-gazebo5_5.0.0.tar.gz
            sha256: 8edb028efb1e61bcf25c10e1961a3575fee2af18334ed66ececc23151c49d42c
