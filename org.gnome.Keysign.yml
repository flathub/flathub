id: org.gnome.Keysign
runtime: org.gnome.Platform
runtime-version: '3.28'
sdk: org.gnome.Sdk
command: gnome-keysign
copy-icon: true
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --share=network
  - --system-talk-name=org.freedesktop.Avahi
  - --device=all
  - --filesystem=~/.gnupg:ro
  - --filesystem=xdg-run/gnupg:ro
# We're waiting for webcam support: https://github.com/flatpak/xdg-desktop-portal/issues/38;
# we use --device=all meanwhile. We do network, because we're opening a port.
build-options:
  cflags: -O2 -g
  cxxflags: -O2 -g
  env:
    V: '1'
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/pkgconfig
  - /share/aclocal
  - /man
  - /share/man
  - /share/gtk-doc
  - /share/vala
  - "*.la"
  - "*.a"
modules:
  - name: setuptools
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - python2 setup.py build
      - python2 setup.py install --prefix=${FLATPAK_DEST}
    sources:
      - type: archive
        url: https://pypi.python.org/packages/32/3c/e853a68b703f347f5ed86585c2dd2828a83252e1216c1201fa6f81270578/setuptools-26.1.1.tar.gz#md5=0744ee90ad266fb117d59f94334185d0
        sha256: 475ce28993d7cb75335942525b9fac79f7431a7f6e8a0079c0f2680641379481

  - name: pip
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - python2 setup.py build
      - python2 setup.py install --prefix=${FLATPAK_DEST}
    sources:
      - type: archive
        url: https://pypi.python.org/packages/e7/a8/7556133689add8d1a54c0b14aeff0acb03c64707ce100ecd53934da1aa13/pip-8.1.2.tar.gz
        sha256: 4d24b03ffa67638a3fa931c09fd9e0273ffa904e95ebebe7d4b1a54c93d7b732

  - name: pycairo
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - python2 setup.py build
      - python2 setup.py install --prefix=${FLATPAK_DEST}
    sources:
      - type: archive
        url: https://github.com/pygobject/pycairo/releases/download/v1.13.4/pycairo-1.13.4.tar.gz
        sha256: 9e1eb50d4b61167cfde585261d93fde6ecda08f0f6c0136d3cf92abc5eb893ed

  - name: python2-pytz
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - pip2 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} pytz
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/10/76/52efda4ef98e7544321fd8d5d512e11739c1df18b0649551aeccfb1c8376/pytz-2018.4.tar.gz
        sha256: c06425302f2cf668f1bba7a0a03f3c1d34d4ebeef2c72003da308b3947c7f749

  - name: pygobject
    build-options:
      env:
        PYTHON: python2
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    sources:
      - type: archive
        url: http://ftp.acc.umu.se/pub/GNOME/sources/pygobject/3.28/pygobject-3.28.2.tar.xz
        sha256: ac443afd14fcb9ff5744b65d6e2b380e70510278404fb8684a9b9fb089e6f2ca

  - name: swig
    config-opts:
      - "--without-boost"
      - "--without-pcre"
    sources:
      - type: archive
        url: http://prdownloads.sourceforge.net/swig/swig-3.0.12.tar.gz
        sha256: 7cf9f447ae7ed1c51722efc45e7f14418d15d7a1e143ac9f09a668999f4fc94d

  - name: dbus-python
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    sources:
      - type: archive
        url: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-1.2.4.tar.gz
        sha256: e2f1d6871f74fba23652e51d10873e54f71adab0525833c19bad9e99b1b2f9cc

  - name: avahi
    # hrm, I don't want to install this, but we need the python module
    disabled: false
    rm-configure: true
    config-opts:
      - "--enable-python"
      - "--disable-static"
      - "--disable-mono"
      - "--disable-monodoc"
      - "--disable-qt3"
      - "--disable-qt4"
      - "--disable-gtk"
      - "--disable-gtk3"
      - "--enable-core-docs"
      - "--with-distro=none"
      - "--with-systemdsystemunitdir=no"
      - "--disable-libdaemon"
      - "--disable-pygtk"
      - "--disable-gdbm"
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    sources:
      - type: archive
        url: http://avahi.org/download/avahi-0.6.31.tar.gz
        sha256: 8372719b24e2dd75de6f59bb1315e600db4fd092805bd1201ed0cb651a2dab48
      - type: script
        commands:
        - autoreconf -fi
        dest-filename: autogen.sh

  - name: gstreamer
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gstreamer/gstreamer-1.12.3.tar.xz
        sha256: d388f492440897f02b01eebb033ca2d41078a3d85c0eddc030cdea5a337a216e

  - name: gst-plugins-base
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gst-plugins-base/gst-plugins-base-1.12.3.tar.xz
        sha256: d3d37b8489d37fa0018973d850bd2067b98af335fef2fa543ee7d40359e3cea5

  - name: gst-plugins-good
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gst-plugins-good/gst-plugins-good-1.12.3.tar.xz
        sha256: 13e7f479296891fef5a686438f20ba7d534680becf2269ecc5ee24aa83b45f03

  - name: gst-plugins-bad
    build-options:
      config-opts:
        - "--enable-zbar"
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gst-plugins-bad/gst-plugins-bad-1.12.3.tar.xz
        sha256: 36d059761852bed0f1a7fcd3ef64a8aeecab95d2bca53cd6aa0f08054b1cbfec
    modules:
      - name: zbar
        build-options:
          config-opts:
            - "--disable-video"
            - "--without-python"
            - "--without-qt"
        sources:
          - type: archive
            url: https://www.linuxtv.org/downloads/zbar/zbar-0.20.tar.bz2
            sha256: b92a130744c907905eb61479a03036569045a08693535c9b630c591ea13ee620
        modules:
          - name: ImageMagick
            sources:
              - type: archive
                url: https://launchpad.net/imagemagick/main/6.9.9-27/+download/ImageMagick-6.9.9-27.tar.gz
                sha256: f561df45ee99505213a39cd1e1056727cefa7dc00bac7c5372bb44448fb5c533

  - name: gst-python
    config-opts:
      - "--with-pygi-overrides-dir=/app/lib/python3.4/site-packages/gi/overrides/"
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gst-python/gst-python-1.9.1.tar.xz
        sha256: 2ab16a84efbabacfcf8f7920ab6c6725c577f08a82bf4cee45edf415a917015f

  - name: python2-babel
    buildsystem: simple
    build-commands:
      - pip2 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} babel
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/0e/d5/9b1d6a79c975d0e9a32bd337a1465518c2519b14b214682ca9892752417e/Babel-2.5.3.tar.gz
        sha256: 8ce4cb6fdd4393edd323227cba3a077bceb2a6ce5201c902c65e730046f41f14

  - name: python2-six
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - pip2 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} six
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/16/d8/bc6316cf98419719bd59c91742194c111b6f2e85abac88e496adefaf7afe/six-1.11.0.tar.gz
        sha256: 70e8a77beed4562e7f14fe23a786b54f6296e34344c23bc42f07b15018ff98e9

  - name: python2-qrcode
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - pip2 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} qrcode
    sources:
      - type: file
        url: https://pypi.python.org/packages/87/16/99038537dc58c87b136779c0e06d46887ff5104eb8c64989aac1ec8cba81/qrcode-5.3.tar.gz
        sha256: 4115ccee832620df16b659d4653568331015c718a754855caf5930805d76924e

  - name: python2-requests
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - pip2 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} requests
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/4d/9c/46e950a6f4d6b4be571ddcae21e7bc846fcbb88f1de3eff0f6dd0a6be55d/certifi-2018.4.16.tar.gz
        sha256: 13e698f54293db9f89122b0581843a782ad0934a4fe0172d2a980ba77fc61bb7
      - type: file
        url: https://files.pythonhosted.org/packages/ee/11/7c59620aceedcc1ef65e156cc5ce5a24ef87be4107c2b74458464e437a5d/urllib3-1.22.tar.gz
        sha256: cc44da8e1145637334317feebd728bd869a35285b93cbb4cca2577da7e62db4f
      - type: file
        url: https://files.pythonhosted.org/packages/f4/bd/0467d62790828c23c47fc1dfa1b1f052b24efdf5290f071c7a91d0d82fd3/idna-2.6.tar.gz
        sha256: 2c6a5de3089009e3da7c5dde64a141dbc8551d5b7f6cf4ed7c2568d0cc520a8f
      - type: file
        url: https://files.pythonhosted.org/packages/fc/bb/a5768c230f9ddb03acc9ef3f0d4a3cf93462473795d18e9535498c8f929d/chardet-3.0.4.tar.gz
        sha256: 84ab92ed1c4d4f16916e05906b6b75a6c0fb5db821cc65e70cbd64a3e2a5eaae
      - type: file
        url: https://files.pythonhosted.org/packages/b0/e1/eab4fc3752e3d240468a8c0b284607899d2fbfb236a56b7377a329aa8d09/requests-2.18.4.tar.gz
        sha256: 9c443e7324ba5b85070c4a818ade28bfabedf16ea10206da1132edaa6dda237e

  - name: gpgme
    sources:
      - type: archive
        url: https://www.gnupg.org/ftp/gcrypt/gpgme/gpgme-1.11.1.tar.bz2
        sha256: 2d1b111774d2e3dd26dcd7c251819ce4ef774ec5e566251eb9308fa7542fbd6f
    modules:
      - name: libassaun
        sources:
          - type: archive
            url: https://www.gnupg.org/ftp/gcrypt/libassuan/libassuan-2.5.1.tar.bz2
            sha256: 47f96c37b4f2aac289f0bc1bacfa8bd8b4b209a488d3d15e2229cb6cc9b26449
        modules:
          - name: libgpg-error
            sources:
              - type: archive
                # this is a mirror because ftp is not yet supported https://github.com/flatpak/flatpak-builder/issues/23
                url: http://mirrors.dotsrc.org/gnupg/libgpg-error/libgpg-error-1.31.tar.bz2
                sha256: 40d0a823c9329478063903192a1f82496083b277265904878f4bc09e0db7a4ef

  - gpg.yml

  - twisted.yml

  - name: python2-lxml
    buildsystem: simple
    build-options:
      env:
        XSLT_CONFIG: pkg-config libxslt
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - pip2 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} lxml
    sources:
      - type: file
        url: https://pypi.python.org/packages/e1/4c/d83979fbc66a2154850f472e69405572d89d2e6a6daee30d18e83e39ef3a/lxml-4.1.1.tar.gz
        sha256: 940caef1ec7c78e0c34b0f6b94fe42d0f2022915ffc78643d28538a5cfd0f40e

  - name: gnome-keysign
    no-autogen: true
    buildsystem: simple
    build-commands:
      - pip2 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: archive
        url: https://gitlab.gnome.org/GNOME/gnome-keysign/-/archive/0.9.7.2/gnome-keysign-0.9.7.2.tar.gz
        sha256: 3418e3bb3484d408a24e79242881c5ad566de1e0bd59c54e7d87aabbe16a6798
