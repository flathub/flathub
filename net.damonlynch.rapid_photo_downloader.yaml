app-id: net.damonlynch.rapid_photo_downloader
runtime: org.kde.Platform
runtime-version: 5.15-23.08
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: 5.15-23.08
cleanup:
  - "/include"
  - /doc
  - /lib/cmake
  - /lib/pkgconfig
  - /man
  - /share/doc
  - /share/gtk-doc
  - /share/man
  - /share/vala
  - "*.a"
  - "*.la"
  - "/lib/*.a"
  - "/lib/*.la"
  - "/lib/pkgconfig"
  - "/include"
  - "/lib/cmake"
cleanup-commands:
  - /app/cleanup-BaseApp.sh
command: rapid-photo-downloader
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio

  #  For USB, until there is a better way in flatpak
  - --device=all

  # XDG commons folders
  - --filesystem=xdg-download
  - --filesystem=xdg-pictures
  - --filesystem=xdg-videos

  # external disk mount
  - --filesystem=/media
  - --filesystem=/run/media
  - --filesystem=/mnt

  # notifications
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher

  # file chooser
  - --talk-name=org.freedesktop.portal.FileChooser

  # App indicator ( not sure if needed)
  - --talk-name=com.canonical.AppMenu.Registrar
  - --talk-name=com.canonical.Unity
  - --talk-name=com.canonical.indicator.application
  - --talk-name=org.ayatana.indicator.application

  # QT and perl libs
  - --env=QT_PLUGIN_PATH=/app/lib64/plugins:/app/lib/plugins
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  - --env=PERL5LIB=/app/lib/perl5/site_perl/5.36.0/

  # access to udisk
  - --system-talk-name=org.freedesktop.UDisks2

  # needed for introspection ?
  - --talk-name=org.freedesktop.DBus.Introspectable.*

  # Needed for gvfs to work and mtp
  - --talk-name=org.gtk.vfs.*
  - --filesystem=xdg-run/gvfs
  - --filesystem=xdg-run/gvfsd

modules:
  - shared-modules/intltool/intltool-0.51.json

  # enable inspection for gudev
  - gudev.json

  # for inspection of gobject
  - python-pygobject.yaml

  # for building
  - python-hatchling.yaml
  - python-hatchling-ext.yaml

  # runtime dep
  - python-arrow.yaml
  # mega runtime dep
  - python-runtimedep.yaml

  # for camaera capacity
  - python-gphoto2.yaml

  # for camaera capacity
  - python-pyzmq.yaml

  # runtime dep for notifications
  - name: libnotify
    buildsystem: meson
    config-opts:
      - -Dman=false
      - -Dtests=false
      - -Dgtk_doc=false
      - -Ddocbook_docs=disabled
    sources:
      - type: archive
        url: https://download.gnome.org/sources/libnotify/0.8/libnotify-0.8.3.tar.xz
        sha256: ee8f3ef946156ad3406fdf45feedbdcd932dbd211ab4f16f75eba4f36fb2f6c0
        x-checker-data:
          project-id: 13149
          type: anitya
          url-template: https://download.gnome.org/sources/libnotify/$major.$minor/libnotify-$version.tar.xz

  # following dependencies are for exif images and metadata
  - python-gexiv2.yaml

  # udisk dependces
  - udisk.yaml

  # exif tool needed
  - exiftool.yaml

  # for info of file
  - libmediainfo.yaml

  # for apple devices
  - ifuse.yaml

  - name: rapid-photo-downloader
    buildsystem: simple
    build-commands:
      - hatch build -t wheel
      - install -Dm444 data/icons/scalable/apps/rapid-photo-downloader.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm444 ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm444 ${FLATPAK_ID}.desktop      ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} . --no-build-isolation
    sources:
      - type: git
        url: https://github.com/damonlynch/rapid-photo-downloader
        tag: v0.9.37a5
        commit: 0790ca2f771da819d32ea2e9cae979bac9d0f490
      - type: file
        path: net.damonlynch.rapid_photo_downloader.desktop
      - type: file
        path: net.damonlynch.rapid_photo_downloader.metainfo.xml
    x-checker-data:
      type: git
      tag-pattern: "^v([\\d.]+)$"
