id: page.codeberg.maerchenfeeimgarten.doors_app

runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  
command: "doors_app"
finish-args:
  - --socket=wayland # Permission needed to show the window
  - --socket=fallback-x11 # Permission needed to show the window
  - --share=ipc
  - --persist=.local/share/page.codeberg.maerchenfeeimgarten.doors_app/
modules:
  - name: doors_app
    buildsystem: simple
    build-options:
        append-path: /usr/lib/sdk/node20/bin:/usr/lib/sdk/rust-stable/bin
        env:
          CARGO_HOME: /run/build/v-extract/doors_app/src-tauri/

    sources:
      # A reference to the previously generated flatpak metainfo file
      - type: file
        url: https://codeberg.org/MaerchenfeeimGarten/doors_app/raw/commit/7137bc0af4ea0bfaeece2e03138a6942fe1c42f4/page.codeberg.maerchenfeeimgarten.doors_app.metainfo.xml
        sha256: 9be371d3da16bdd88c9e6546cbf70fec51498274674ae1fb121e350dc9b51d91
      # If you use Codeberg releases, you can target an existing remote file
      - type: file
        url: https://codeberg.org/MaerchenfeeimGarten/doors_app/archive/v0.1.4.tar.gz
        sha256: 391c1a484c1ab4bbee5e08be58a9e950045f72dd9007838934c438e99ac5bb7f
      - type: file
        url: https://codeberg.org/MaerchenfeeimGarten/doors_app/raw/commit/08c40d84e108cd5be848ea24e938c5bafaa56bd6/page.codeberg.maerchenfeeimgarten.doors_app.desktop
        sha256: 64a39aae2cefc8578592ba098db4858a888df4563df180a56d7c5923b56b0ba7

    build-commands:
    
      #build .deb file
      - mkdir v-extract
      - tar -xzf v0.1.4.tar.gz -C v-extract
      - bash -c " cd v-extract/doors_app/src-tauri     ;     pwd   ;   cargo --offline fetch --manifest-path ./Cargo.toml --verbose    ;    cargo --offline install tauri --version "^2.0.0" --locked--verbose    ;    cargo --list     ;    cargo --offline tauri build -b deb "  # I have to use bash -c because cd is not working otherwise and online search did not reveal a cd alternative inside a build-command: - tag.
      
      # Extract the deb package
      - cp v-extract/doors_app/src-tauri/target/release/bundle/deb/*.deb ./
      - mkdir deb-extract
      - ar -x *.deb --output deb-extract
      - tar -C deb-extract -xf deb-extract/data.tar.gz

      # Copy binary
      - 'install -Dm755 deb-extract/usr/bin/doors_app /app/bin/doors_app'
      
      # Copy desktop file
      - install -Dm644 page.codeberg.maerchenfeeimgarten.doors_app.desktop /app/share/applications/page.codeberg.maerchenfeeimgarten.doors_app.desktop

      # Copy icons
      - install -Dm644 deb-extract/usr/share/icons/hicolor/128x128/apps/doors_app.png /app/share/icons/hicolor/128x128/apps/page.codeberg.maerchenfeeimgarten.doors_app.png
      - install -Dm644 deb-extract/usr/share/icons/hicolor/32x32/apps/doors_app.png /app/share/icons/hicolor/32x32/apps/page.codeberg.maerchenfeeimgarten.doors_app.png
      - install -Dm644 deb-extract/usr/share/icons/hicolor/256x256@2/apps/doors_app.png /app/share/icons/hicolor/256x256@2/apps/page.codeberg.maerchenfeeimgarten.doors_app.png
      - install -Dm644 page.codeberg.maerchenfeeimgarten.doors_app.metainfo.xml /app/share/metainfo/page.codeberg.maerchenfeeimgarten.doors_app.metainfo.xml
