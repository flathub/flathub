# yaml-language-server: $schema=https://raw.githubusercontent.com/flatpak/flatpak-builder/refs/heads/main/data/flatpak-manifest.schema.json
app-id: pro.affine.affine
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: '24.08'
command: start-affine.sh
separate-locales: false
rename-desktop-file: affine.desktop
rename-appdata-file: affine.metainfo.xml
rename-icon: affine
finish-args:
  - --share=ipc
  - --share=network
  - --socket=x11
  - --socket=pulseaudio
  - --device=dri
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
modules:
  - name: affine
    buildsystem: simple
    build-commands:
      - bsdtar -Oxf affine.deb 'data.tar.zst' | bsdtar -xf -
      - desktop-file-edit --set-key=Exec --set-value='start-affine.sh %U' usr/share/applications/affine.desktop
      - install -Dm0644 "usr/share/applications/affine.desktop" "${FLATPAK_DEST}/share/applications/affine.desktop"
      - install -Dm0644 "usr/lib/affine/resources/affine.metainfo.xml" "${FLATPAK_DEST}/share/metainfo/affine.metainfo.xml"
      - install -Dm0644 "usr/share/pixmaps/affine.png" "${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/affine.png"
      - mv "usr/lib/affine" "${FLATPAK_DEST}/lib/affine"
      - install -Dm0755 start-affine.sh "${FLATPAK_DEST}/bin/start-affine.sh"
    sources:
      - type: file
        dest-filename: affine.deb
        url: https://github.com/toeverything/AFFiNE/releases/download/v0.21.3/affine-0.21.3-stable-linux-x64.deb
        sha256: '67075c80edb3b672f83cc4c2e2b9678a23a83bf351418829559f76dbfd7f5e89'
        only-arches:
          - x86_64
        x-checker-data:
          type: json
          url: https://api.github.com/repos/toeverything/AFFiNE/releases/latest
          version-query: '.tag_name | sub("^v"; "")'
          url-query: '.assets[] | select(.name=="affine-" + $version + "-stable-linux-x64.deb") | .browser_download_url'
          timestamp-query: '.published_at'
      - type: script
        dest-filename: start-affine.sh
        commands:
          - zypak-wrapper.sh /app/lib/affine/AFFiNE "$@"
