# Thanks To:
#   https://gitlab.archlinux.org/archlinux/packaging/packages/aegisub/-/blob/main/PKGBUILD
#   https://gitlab.archlinux.org/archlinux/packaging/packages/wxwidgets/-/blob/main/PKGBUILD
#   https://github.com/flathub/io.mpv.Mpv/blob/master/io.mpv.Mpv.yml
#   https://github.com/flathub/org.audacityteam.Audacity/blob/master/org.audacityteam.Audacity.yaml
#   https://github.com/flathub/org.blender.Blender/blob/master/org.blender.Blender.json
#   https://github.com/scx/aegisub-flatpak

id: org.aegisub.Aegisub
runtime: org.gnome.Platform
runtime-version: "45"
sdk: org.gnome.Sdk
command: aegisub
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --socket=pulseaudio
  - --filesystem=home
rename-desktop-file: aegisub.desktop
rename-appdata-file: aegisub.appdata.xml
rename-icon: aegisub
# TODO: Consider separate locales
separate-locales: false
cleanup:
  - "/include"
  - "/lib/pkgconfig"
  - "/share/pkgconfig"
  - "/share/aclocal"
  - "/man"
  - "/share/man"
  - "/share/doc"
  - "/share/gtk-doc"
  - "*.la"
  - "*.a"
modules:
  - name: aegisub
    buildsystem: autotools
    config-opts:
      - --enable-lto
      - --with-boost-libdir=/app/lib
      # FIX: Use system luajit (can't be detected with the used build options).
      # - --with-system-luajit=yes
      - --with-build-credit=zefr0x
      - --disable-update-checker
    sources:
      - type: git
        url: https://github.com/wangqr/Aegisub
        tag: v3.3.3
        commit: a596a88115890a6f8ecd41518f1dbcdea1f6cd61
        x-checker-data:
          type: git
          tag-pattern: ^v(\d.\d.\d)$
          version-scheme: semantic
      - type: patch
        path: fix-and-improve-appstream-file.patch
      - type: patch
        # This commit is needed to enable wayland support.
        # It was disabled since wxwidgets wasn't supporting wayland in older releases.
        # After the v3.3.3 release it was enabled but not released since the developer is not active.
        # Without it the app might crash on XWayland.
        path: enable_wayland.patch
      - type: patch
        # Needed to link with latest version of libboost.
        # Source: https://gitlab.archlinux.org/archlinux/packaging/packages/aegisub/-/blob/fef4a8f94ce2fc2e450b608f926a5fd44215e653/boost-1.81.0.patch
        path: boost-1.81.0.patch
    modules:
      - name: wxwidgets
        buildsystem: cmake-ninja
        config-opts:
        # TODO: Disable more unused features to fast up compiling.
        - -DCMAKE_BUILD_TYPE=Release
        - -DwxBUILD_TOOLKIT=gtk3
        - -DwxUSE_BASE64=OFF
        - -DwxUSE_GIF=OFF
        - -DwxUSE_LIBJPEG=OFF
        - -DwxUSE_SVG=OFF
        - -DwxUSE_TARSTREAM=OFF
        - -DwxUSE_LIBTIFF=OFF
        - -DwxUSE_WEBVIEW_WEBKIT=OFF
        - -DwxUSE_WEBVIEW=OFF
        - -DwxUSE_LIBPNG=sys
        cleanup:
          - /bin
          - /share/bakefile
          - /lib/wx
        sources:
          - type: git
            url: https://github.com/wxWidgets/wxWidgets.git
            tag: v3.2.4
            commit: 085a136dcb11aca5b1102193f006f8056d5f0876
            x-checker-data:
              type: git
              tag-pattern: ^v(\d.\d.\d)$
              version-scheme: semantic
      - name: ffms2
        buildsystem: autotools
        cleanup:
          - /bin
        sources:
          - type: git
            url: https://github.com/FFMS/ffms2.git
            # TODO: Wait for a new release to use it's tag.
            # tag: "2.40"
            commit: f20827cf280b669321cd5b62e01d744bc68c21fc
            # x-checker-data:
            #   type: git
            #   tag-pattern: ^[0-9]+\.[0-9]+$
        modules:
          - name: ffmpeg
            buildsystem: autotools
            config-opts:
              - --prefix=${FLATPAK_DEST}
              # Should be ok, since ffms2 binaries are GPL.
              - --enable-gpl
              # TODO: Consider using GPLv3.
              - --enable-version3
              - --enable-shared
              - --enable-lto
              # No CLI tool is used.
              - --disable-programs
              # No docs are needed in flatpak.
              - --disable-doc
              # Those components are not used in ffms2.
              # TODO: Consider this (libswresample & libavcodec are installed in ffms2's CI build):
              - --disable-avdevice
              - --disable-avcodec
              - --disable-swresample
              - --disable-postproc
              - --disable-avfilter
              - --disable-network
              # FFMS2 doens't do any encoding, hwaccel, muxing, filtering or use devices.
              - --disable-encoders
              - --disable-hwaccels
              - --disable-muxers
              - --disable-filters
              - --disable-devices
              # External library support:
              - --disable-alsa
              - --disable-iconv
              # TODO: Considor using `aom` over `dav1d`.
              # - --enable-libaom # AV1 video decoding via libaom
              - --enable-libdav1d # AV1 decoding via libdav1d
              - --enable-libjxl # JPEG XL decoding via libjxl
              - --enable-libopenjpeg # JPEG 2000 decoding via OpenJPEG
              # FIX: Enable libvpx (can't be detected by ffmpeg)
              # - --enable-libvpx # VP8 and VP9 decoding via libvpx
              # Developer options:
              - --disable-debug
            cleanup:
              - /share/ffmpeg
            sources:
              - type: git
                url: https://github.com/FFmpeg/FFmpeg.git
                mirror-urls:
                  - https://git.ffmpeg.org/ffmpeg.git
                tag: n6.1.1
                commit: e38092ef9395d7049f871ef4d5411eb410e283e0
                x-checker-data:
                  type: git
                  tag-pattern: ^n([\d.]{3,7})$
      - name: boost
        buildsystem: simple
        build-commands:
          - ./bootstrap.sh --prefix=${FLATPAK_DEST} --with-libraries=chrono,container,filesystem,system,locale,regex,thread --with-icu
          - ./b2 install variant=release
        sources:
          - type: archive
            url: https://boostorg.jfrog.io/artifactory/main/release/1.84.0/source/boost_1_84_0.tar.gz
            sha512: 076ef93f14eb2fc956084acf8532459c10877038592c62e0c2afed2d769ccb0cda3c9c4f7112e62fdd59b955dbce037704cbecabf053a634867736d9642aa5cc
            x-checker-data:
              type: anitya
              project-id: 6845
              stable-only: true
              url-template: https://boostorg.jfrog.io/artifactory/main/release/$version/source/boost_${major}_${minor}_${patch}.tar.gz
      # TODO: Install luajit with all needed libraries in the system rathen then using bundled.
      - ./shared-modules/linux-audio/fftw3f.json
      # TODO: Enable AviSynthPlus support after it's properly supported in up-stream.
      # - name: AviSynthPlus
      #   buildsystem: cmake-ninja
      #   config-opts:
      #     - -DENABLE_CUDA=ON
      #   sources:
      #     - type: git
      #       url: https://github.com/AviSynth/AviSynthPlus.git
      #       tag: v3.7.3
      #       commit: fc5b9bc41fd47001b7da39ea777d29c0ede2a2a7
      #       x-checker-data:
      #         type: git
      #         version-scheme: semantic
      - name: libass
        buildsystem: autotools
        sources:
          - type: git
            url: https://github.com/libass/libass.git
            tag: 0.17.1
            commit: e8ad72accd3a84268275a9385beb701c9284e5b3
            x-checker-data:
              type: git
              version-scheme: semantic
      - name: uchardet
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -DBUILD_BINARY=OFF
        sources:
          - type: git
            url: https://gitlab.freedesktop.org/uchardet/uchardet.git
            tag: v0.0.8
            commit: ae6302a016088ad07177f86d417b20010053632b
            x-checker-data:
              type: git
              version-scheme: semantic
      - shared-modules/intltool/intltool-0.51.json
  -  name: AegisubScripts
     modules:
        - name: LuaegisubCollection
          buildsystem: simple
          build-commands:
            - mkdir -p /app/share/aegisub/automation/autoload/
            - cp *.lua /app/share/aegisub/automation/autoload/
          sources:
            - type: git
              url: https://github.com/unanimated/luaegisub
              # There is no verson tags.
              commit: 31ca1da409b2f69c415de4bef2aef2ef328d5655

