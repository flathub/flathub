app-id: io.github.linx_systems.ClamUI
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: clamui

finish-args:
  # Display - use fallback-x11 for X11/Wayland compatibility
  - --socket=fallback-x11
  - --socket=wayland
  - --share=ipc
  - --device=dri

  # Network for virus database updates
  - --share=network

  # Specific D-Bus permissions (instead of full session-bus)
  # - --talk-name=org.freedesktop.Notifications
  # XApp StatusIcon for Cinnamon/MATE/XFCE system tray
  # - --own-name=org.x.StatusIcon.*

  # GVFS for file browser integration
  - --filesystem=xdg-run/gvfsd

modules:
  # System tray uses org.x.StatusIcon D-Bus protocol (no GTK3 required)
  # Supports: Cinnamon, MATE, XFCE, Budgie

  - name: json-c
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5
    sources:
      - type: archive
        url: https://s3.amazonaws.com/json-c_releases/releases/json-c-0.18.tar.gz
        sha256: 876ab046479166b869afc6896d288183bbc0e5843f141200c677b3e8dfb11724

  - name: clamav
    buildsystem: cmake-ninja
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/clamav/cargo
    config-opts:
      - -DENABLE_CLAMONACC=OFF
      - -DENABLE_MILTER=OFF
      - -DENABLE_EXAMPLES=OFF
      - -DENABLE_MAN_PAGES=OFF
      - -DENABLE_TESTS=OFF
      - -DENABLE_SYSTEMD=OFF
    sources:
      - type: archive
        url: https://www.clamav.net/downloads/production/clamav-1.3.1.tar.gz
        sha256: 12a3035bf26f55f71e3106a51a5fa8d7b744572df98a63920a9cff876a7dcce4
        x-checker-data:
          type: anitya
          project-id: 291
          url-template: https://www.clamav.net/downloads/production/clamav-$version.tar.gz

  # Python build dependencies (hatchling for pyproject.toml builds)
  # Generated by: flatpak_pip_generator --runtime='org.gnome.Sdk//49' -r requirements-build.txt -o python3-build-deps --checker-data
  - python3-build-deps.json

  # Python runtime dependencies (matplotlib, psutil, requests, keyring, and their dependencies)
  # Generated by: req2flatpak -r requirements-runtime-pinned.txt -t 313-x86_64 313-aarch64 -o python3-runtime-deps.json
  # Uses binary wheels for faster builds
  - python3-runtime-deps.json

  - name: clamui
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app --no-deps --no-build-isolation .
      - install -Dm644 io.github.linx_systems.ClamUI.desktop /app/share/applications/io.github.linx_systems.ClamUI.desktop
      - install -Dm644 io.github.linx_systems.ClamUI.metainfo.xml /app/share/metainfo/io.github.linx_systems.ClamUI.metainfo.xml
      - install -Dm644 icons/io.github.linx_systems.ClamUI.svg /app/share/icons/hicolor/scalable/apps/io.github.linx_systems.ClamUI.svg
    sources:
      - type: git
        url: https://github.com/linx-systems/clamui.git
        tag: v0.1.0
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$