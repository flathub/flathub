app-id: org.tropy.Tropy
base: org.electronjs.Electron2.BaseApp
base-version: '23.08'
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: tropy

finish-args:
  - --share=ipc
  #- --socket=wayland
  #- --socket=fallback-x11
  - --socket=x11
  - --socket=pulseaudio
  - --share=network
  - --device=dri
  - --filesystem=home
  - --filesystem=xdg-desktop
  - --filesystem=xdg-documents
  - --filesystem=xdg-download
  - --filesystem=xdg-pictures
  - --filesystem=xdg-public-share
  - --filesystem=xdg-run/gvfsd
  - --talk-name=org.gtk.vfs.*
  - --talk-name=com.canonical.AppMenu.Registrar
  - --talk-name=com.canonical.indicator.application
  - --talk-name=com.canonical.Unity.LauncherEntry

modules:
  - name: tropy
    buildsystem: simple
    sources:
      - type: archive
        url: https://github.com/tropy/tropy/releases/download/v1.14.0/tropy-1.14.0-x64.tar.bz2
        sha256: a78f1d725d526bd40f9101c3576e007a41ddc8002776715a332e867cb30bb2b8
        only-arches: [x86_64]
        strip-components: 0
        dest: tropy
      - type: file
        path: org.tropy.Tropy.metainfo.xml
      - type: file
        path: tropy.sh
    build-commands:
      - install -Dm644 -t /app/share/metainfo org.tropy.Tropy.metainfo.xml
      - install -Dm755 tropy.sh /app/bin/tropy
      - sed -i 's/Icon=tropy/Icon=org.tropy.Tropy/' tropy/tropy.desktop
      - install -m644 tropy/tropy.desktop /app/share/applications/org.tropy.Tropy.desktop
      - sed -i 's/application-vnd.tropy/org.tropy.Tropy/' tropy/resources/mime/packages/tropy.xml
      - rm -r tropy/resources/icons/hicolor/1024x1024
      - mv tropy/resources/icons /app/share
      - mv tropy/resources/mime /app/share
      - |
        find /app/share -type f -name "tropy*" -print0 | \
          xargs -I {} -0 rename tropy org.tropy.Tropy "{}"
      - |
        find /app/share/icons -type f -name "application-vnd.tropy*" -print0 | \
          xargs -I {} -0 rename application-vnd.tropy org.tropy.Tropy "{}"
      - cp -r tropy /app
