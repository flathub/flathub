id: org.archivekeep.ArchiveKeep

runtime: org.freedesktop.Platform
runtime-version: '24.08'

sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17

finish-args:
  - --socket=x11
  - --device=dri
  - --share=network
  - --share=ipc
  # access to /dev/disk/by-uuid/ and /dev/mapper/ needed for disk UUID resolution
  - --device=all
  - --filesystem=home
  - --filesystem=/media
  - --filesystem=/run/media
  - --filesystem=/mnt
  - --env=PATH=/usr/bin:/app/bin:/app/jre/bin
  - --env=JAVA_HOME=/app/jre

command: archivekeep-desktop

modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk17/install.sh

  - name: archivekeep-desktop
    buildsystem: simple
    build-options:
      append-path: "/usr/lib/sdk/openjdk17/bin"
    build-commands:
      - "sed -i s/distributionUrl.*/distributionUrl=gradle-bin.zip/ gradle/wrapper/gradle-wrapper.properties"
      - ./gradlew --no-daemon --offline --console=plain createReleaseDistributable
      - mkdir -p /app/bin /app/lib
      - cp -r modules/app-desktop/build/compose/binaries/main-release/app/archivekeep-desktop/bin/* /app/bin/
      - cp -r modules/app-desktop/build/compose/binaries/main-release/app/archivekeep-desktop/lib/* /app/lib/
      - install -Dm644 modules/app-desktop/src/main/composeResources/drawable/ic_app.svg /app/share/icons/hicolor/scalable/apps/$FLATPAK_ID.svg
      - install -Dm644 distribution/resources/$FLATPAK_ID.appdata.xml /app/share/appdata/$FLATPAK_ID.appdata.xml
      - install -Dm644 distribution/resources/$FLATPAK_ID.desktop /app/share/applications/$FLATPAK_ID.desktop
    sources:
      - type: git
        url: https://github.com/archivekeep/archivekeep.git
        commit: 211d2c90370445093f71d5a4c7e9e8f7edaf9fd7
        tag: v0.3.1
        disable-submodules: true
      - type: file
        url: "https://services.gradle.org/distributions/gradle-8.11.1-bin.zip"
        sha256: "f397b287023acdba1e9f6fc5ea72d22dd63669d59ed4a289a29b1a76eee151c6"
        dest: "gradle/wrapper"
        dest-filename: "gradle-bin.zip"
      - "gradle-sources-root.aarch64.json"
      - "gradle-sources-app-core.aarch64.json"
      - "gradle-sources-app-desktop.aarch64.json"
      - "gradle-sources-cli.aarch64.json"
      - "gradle-sources-files.aarch64.json"
      - "gradle-sources-root.x86_64.json"
      - "gradle-sources-app-core.x86_64.json"
      - "gradle-sources-app-desktop.x86_64.json"
      - "gradle-sources-cli.x86_64.json"
      - "gradle-sources-files.x86_64.json"

