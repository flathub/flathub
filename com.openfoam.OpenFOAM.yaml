app-id: com.openfoam.OpenFOAM
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: 24.08
command: openfoam
finish-args:
  - --share=ipc
  - --device=dri
  - --filesystem=home
modules:
  - name: openmpi
    buildsystem: autotools
    config-opts:
      - --enable-mpi-cxx
      - --disable-wrapper-runpath
    sources:
      - type: archive
        url: https://download.open-mpi.org/release/open-mpi/v4.1/openmpi-4.1.4.tar.bz2
        sha256: 92912e175fd1234368c8730c03f4996fe5942e7479bb1d10059405e7f2b3930d

  - name: OpenFOAM
    build-options:
      env:
        WM_PROJECT_DIR: /run/build/OpenFOAM/OpenFOAM-v2506
        WM_THIRD_PARTY_DIR: /run/build/OpenFOAM/ThirdParty-v2506
    buildsystem: simple
    build-commands:
      - bash -lc "cd ThirdParty-v2506 && source ../OpenFOAM-v2506/etc/bashrc && ./Allwmake -j$(nproc)"
      - bash -lc "cd OpenFOAM-v2506 && source etc/bashrc && ./Allwmake -j$(nproc)"
      - install -d /app/OpenFOAM
      - cp -a OpenFOAM-v2506 /app/OpenFOAM
      - cp -a ThirdParty-v2506 /app/OpenFOAM
      - install -d /app/bin
      - cat <<'EOF' > /app/bin/openfoam
#!/usr/bin/env bash
source /app/OpenFOAM/OpenFOAM-v2506/etc/bashrc
if [ $# -eq 0 ]; then
  exec /usr/bin/bash -i
else
  exec "$@"
fi
EOF
      - chmod +x /app/bin/openfoam
    sources:
      - type: archive
        url: https://dl.openfoam.com/source/v2506/OpenFOAM-v2506.tgz
        sha256: 63d26f48ae7ee9a7806a0ceb339ef8a0ba485a4714d54fbfb31e78e1a4849965
      - type: archive
        url: https://dl.openfoam.com/source/v2506/ThirdParty-v2506.tgz
        sha256: 1f1d03e10e66a594f1ed916650f66be844eb5d2862cf73590d2bda9b4c6b9d73
