app-id: com.openfoam.OpenFOAM
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: 24.08
command: openfoam
finish-args:
  - --share=ipc
  - --device=dri
  - --filesystem=home
modules:
  - name: openmpi
    buildsystem: autotools
    config-opts:
      - --enable-mpi-cxx
      - --disable-wrapper-runpath
    sources:
      - type: archive
        url: https://download.open-mpi.org/release/open-mpi/v4.1/openmpi-4.1.4.tar.bz2
        sha256: 92912e175fd1234368c8730c03f4996fe5942e7479bb1d10059405e7f2b3930d

  - name: OpenFOAM
    build-options:
      env:
        GMP_ARCH_PATH: /usr
        MPFR_ARCH_PATH: /usr
        LDFLAGS: "-lmpfr -lgmp"
    buildsystem: simple
    build-commands:
      - cat applications/utilities/mesh/generation/foamyMesh/conformalVoronoiMesh/Make/options
      - bash -lc "source etc/bashrc && cd ThirdParty && ls -l && ./Allwmake -j$(nproc) && ./makeAdios2"
      - bash -lc "source etc/bashrc && ./Allwmake -j$(nproc)"
      - install -d /app/OpenFOAM
      - cp -a . /app/OpenFOAM
      - install -d /app/bin
      - |
        cat <<'EOF' > /app/bin/openfoam
        #!/usr/bin/env bash
        # OpenFOAM runtime environment
        source /app/OpenFOAM/etc/bashrc
        if [ $# -eq 0 ]; then
          exec /usr/bin/bash -i
        else
          exec "$@"
        fi
        EOF
      - chmod +x /app/bin/openfoam
      - install -Dm0644 COPYING -t ${FLATPAK_DEST}/share/licenses/$FLATPAK_ID/OpenFOAM
      - install -Dm0644 $FLATPAK_ID.metainfo.xml ${FLATPAK_DEST}/share/metainfo/$FLATPAK_ID.metainfo.xml
      - install -Dm0644 ${FLATPAK_ID}.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: archive
        url: https://dl.openfoam.com/source/v2506/OpenFOAM-v2506.tgz
        sha256: 63d26f48ae7ee9a7806a0ceb339ef8a0ba485a4714d54fbfb31e78e1a4849965
      - type: patch
        path: fix_undefine_ref.patch
      - type: file
        path: com.openfoam.OpenFOAM.desktop
      - type: file
        path: com.openfoam.OpenFOAM.metainfo.xml
      - type: archive
        dest: ThirdParty
        url: https://dl.openfoam.com/source/v2506/ThirdParty-v2506.tgz
        sha256: f36ab81ba9e94b4771e27ad1c439bfd377d2a16b2919e7d969bc755ddf9eb0cc
      - type: git
        url: https://github.com/scivision/metis
        tag: v5.1.0.4
        commit: e3b7cc43bc15696a06c21d19fd5376d34eb8b3ca
        dest: ThirdParty/sources/metis
      - type: archive
        dest: ThirdParty/sources/petsc
        url: https://web.cels.anl.gov/projects/petsc/download/release-snapshots/petsc-lite-3.21.2.tar.gz
        sha256: a1ac62b6204bdf2f7f9b637abf45e6cff24d372d4d3d3702c50e157bdb56eb21


