name: widelands
buildsystem: cmake-ninja
builddir: true
config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  - -DCMAKE_INSTALL_PREFIX=/app/bin
  - -DWL_INSTALL_BASEDIR=/app/share/widelands
  - -DWL_INSTALL_DATADIR=/app/share/widelands
  - -DBOOST_ROOT=/app
  - -DGLEW_ROOT=/app
  - -DGLEW_INCLUDE_DIR=/app/include/GL
  # https://wl.widelands.org/forum/topic/1343/?page=3 & https://wl.widelands.org/forum/post/9857/
  - -DGLEW_LIBRARY:FILEPATH=/app/lib/libGLEW.a
  - -DOPENGL_glu_LIBRARY=/app/lib/libGLU.a
  - -DOPTION_BUILD_WEBSITE_TOOLS=OFF
sources:
  # Source0
  - type: archive
    url: https://launchpad.net/widelands/build19/build19/+download/widelands-build19-src-gcc7.tar.bz2
    sha256: ef73b8cf5a7c680bad5caade907f1cc6ee88dd3729470b9214a3c72658585458
  # Patch1
  # https://bugs.launchpad.net/widelands/+bug/1760581
  - type: patch
    path: widelands-build19-icu-bidi.patch
post-install:
  - install -p -D -m 0644 "../data/images/logos/wl-ico-128.png" "${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png";
  - install -p -D -m 0644 "../debian/org.widelands.widelands.desktop" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop";
    desktop-file-edit --set-key='Icon' --set-value="${FLATPAK_ID}" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop";
  - install -p -D -m 0644 "../debian/widelands.appdata.xml" "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml";
    PATH="${PATH}:${FLATPAK_DEST}/opt/xmlstarlet/bin";
    xmlstarlet ed --inplace -d '/component/releases/release[position()>1]' "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml";
cleanup:
  - /bin/wl_render_richtext
