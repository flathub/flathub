app-id: org.mozilla.vpn
runtime: org.kde.Platform
runtime-version: '6.6'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: mozillavpn
finish-args:
  - "--share=ipc"
  - "--share=network"
  - "--socket=fallback-x11"
  - "--socket=wayland"
  - "--device=dri"
  - "--talk-name=org.kde.StatusNotifierWatcher"
  - "--system-talk-name=org.freedesktop.NetworkManager"
  - "--env=QML2_IMPORT_PATH=/app/lib64/qml:/app/lib/qml:/app/qml"
build-options:
  append-path: "/usr/lib/sdk/rust-stable/bin"
  env:
    - CARGO_HOME=/run/build/rust-flatpak/cargo
modules:
  - flatpak-rpds.yaml
  - flatpak-glean-parser.yaml
  - flatpak-libnm.yaml
  - flatpak-qt5compat.yaml

  - name: mozillavpn-appstream
    buildsystem: simple
    build-commands:
      - install -Dm644 org.mozilla.vpn.metainfo.xml "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
      - install -Dm644 org.mozilla.vpn.releases.xml "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.releases.xml"
    sources:
      - type: file
        path: org.mozilla.vpn.metainfo.xml
      - type: file
        path: org.mozilla.vpn.releases.xml

  - name: mozillavpn
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_FLATPAK=ON
    sources:
      - type: git
        url: https://github.com/mozilla-mobile/mozilla-vpn-client
        tag: v2.29.0

      # Install vendored Rust crates
      - flatpak-vpn-crates.json
      - type: shell
        commands:
          - mkdir .cargo
          - cp cargo/config .cargo/config.toml
