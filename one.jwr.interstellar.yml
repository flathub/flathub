id: one.jwr.interstellar
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: interstellar
finish-args:
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --share=network
  - --share=ipc
  - --device=dri
modules:
  - name: libmpv
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/man
    buildsystem: simple
    build-commands:
      - python3 waf configure --prefix=/app --enable-libmpv-shared --disable-cplayer --disable-build-date --disable-alsa
      - python3 waf build
      - python3 waf install
    sources:
      - type: git
        url: https://github.com/mpv-player/mpv.git
        tag: v0.35.1
      - type: file
        url: https://waf.io/waf-2.0.25
        sha256: 21199cd220ccf60434133e1fd2ab8c8e5217c3799199c82722543970dc8e38d5
        dest-filename: waf
    modules:
      - name: libass
        cleanup:
          - /include
          - /lib/*.la
          - /lib/pkgconfig
        config-opts:
          - --disable-static
        sources:
          - type: archive
            url: https://github.com/libass/libass/releases/download/0.17.1/libass-0.17.1.tar.xz
            sha256: f0da0bbfba476c16ae3e1cfd862256d30915911f7abaa1b16ce62ee653192784
        modules:
          - name: fribidi
            cleanup:
              - /bin
              - /include
              - /lib/pkgconfig
              - /lib/*.la
              - /share/man
            buildsystem: meson
            config-opts:
              - --buildtype=release
              - -Ddocs=false
            sources:
              - type: git
                url: https://github.com/fribidi/fribidi.git
                tag: v1.0.13
                commit: b54871c339dabb7434718da3fed2fa63320997e5
      - name: x264
        cleanup:
          - /include
          - /lib/pkgconfig
          - /share/man
        config-opts:
          - --disable-cli
          - --enable-shared
        sources:
          - type: git
            url: https://code.videolan.org/videolan/x264.git
            commit: c1c9931dc87289b8aeba78150467f17bdb97d019
      - name: nv-codec-headers
        cleanup:
          - '*'
        no-autogen: true
        make-install-args:
          - PREFIX=/app
        sources:
          - type: git
            url: https://github.com/FFmpeg/nv-codec-headers.git
            commit: 855f8263d97bbdcaeabaaaa2997e1ccad7c52dc3
      - name: ffmpeg
        cleanup:
          - /include
          - /lib/pkgconfig
          - /share/ffmpeg/examples
        config-opts:
          - --enable-shared
          - --disable-static
          - --enable-gnutls
          - --disable-doc
          - --disable-programs
          - --disable-encoders
          - --disable-muxers
          - --enable-encoder=png
          - --enable-libv4l2
          - --enable-libdav1d
        sources:
          - type: git
            url: https://git.ffmpeg.org/ffmpeg.git
            tag: n6.0.1
  - name: interstellar
    buildsystem: simple
    only-arches:
      - x86_64
    build-commands:
      - 'cp -r interstellar/ /app/interstellar/'
      - 'install -Dm644 interstellar/data/flutter_assets/assets/icons/logo.png /app/share/icons/hicolor/512x512/apps/one.jwr.interstellar.png'
      - 'install run.sh /app/bin/interstellar'
      - 'cp /app/lib/libmpv.so /app/lib/libmpv.so.1'
      - 'install -Dm644 one.jwr.interstellar.desktop /app/share/applications/one.jwr.interstellar.desktop'
      - 'install -Dm644 one.jwr.interstellar.metainfo.xml /app/share/appdata/one.jwr.interstellar.metainfo.xml'
    sources:
      - type: archive
        only-arches:
          - x86_64
        url: https://github.com/jwr1/interstellar/releases/download/v0.4.0/interstellar-linux-x86_64.tar.gz
        dest: interstellar
        sha256: b2382f6613da9099505e08887cf03babeafb4f2f4e11042acc95e54743c1d036
        strip-components: 0
        x-checker-data:
          type: json
          url: https://api.github.com/repos/jwr1/interstellar/releases/latest
          version-query: .tag_name | sub("v";"")
          url-query: .assets[] | select(.name=="interstellar-linux-x86_64.tar.gz") | .browser_download_url
      - type: file
        path: run.sh
      - type: file
        path: one.jwr.interstellar.desktop
      - type: file
        path: one.jwr.interstellar.metainfo.xml
