name: nasc
#buildsystem: cmake-ninja
buildsystem: meson
builddir: true
sources:
  - type: archive
    url: https://github.com/parnold-x/nasc/archive/0.5.1.tar.gz
    sha256: 96304085f6082b14d9220c28d7823bcb59317b567f9bcfe09ab905e27f053859
  # Application patches
  # https://github.com/scx/nasc/pull/1
  # Use get_user_data_dir() instead of hardcoded path
  # https://github.com/scx/nasc/commit/b35559bd611335ee9b538d3d5b1e028f5e8d51e9
  - type: patch
    path: nasc-0.5.1-sheet_path.patch
  # XDG patches
  # https://github.com/scx/nasc/pull/2
  # Enhance desktop file: update Categories, change GenericName, add StartupWMClass and StartupNotify
  # https://github.com/scx/nasc/commit/b0719fc779b3d3972ecaeb6bc40cb60b08bd5f55
  - type: patch
    path: nasc-0.5.1-desktop.patch
  # Enhance AppData file: fix release notes, add screenshot captions and kudos
  # https://github.com/scx/nasc/commit/d00ac1002a6a16aca4a57ada0c304eba839a7523
  - type: patch
    path: nasc-0.5.1-appdata.patch
  # CMake patches
  # https://github.com/scx/nasc/pull/3
  # PATCH-FIX-UPSTREAM link.patch -- Build app with 'Wl,--no-undefined' and static library
  # https://build.opensuse.org/package/view_file/openSUSE:Factory/nasc/nasc-0.5.0-link.patch?expand=1
  # https://github.com/scx/nasc/commit/bebce8e7ea33e4479498796346e32afaf0318739
  - type: patch
    path: nasc-0.5.1-link.patch
  # The --thread option is now deprecated
  # Should be ignored, but actually it leads to a build failure
  # https://github.com/GNOME/vala/blob/f7c386eae4a1ab15eb4a21dce540e6298d93436c/compiler/valacompiler.vala#L131
  # Fixes builds on FC >= 28 and EL >= 8
  # https://github.com/scx/nasc/commit/fdf40fa6828af6fffb5976f43c8f331eac8eafe7
  - type: patch
    path: nasc-0.5.1-vala-thread.patch
  # Meson patches
  # https://github.com/scx/nasc/pull/4
  # Reorganize CMake spec
  # Move com.github.parnold-x.nasc.gschema.xml to data subdirectory
  # Rename src/config.vala.cmake to src/config.vala.in
  # https://github.com/scx/nasc/commit/19412dcdf1a9e868566f8030324b1ab903ca0a34
  - type: patch
    path: nasc-0.5.1-cmake.patch
  # Based on: Port to Meson
  # https://github.com/parnold-x/nasc/pull/98
  # Add cln dependency to libqalculatenasc
  # Fixes builds on FC < 28 and EL < 8
  # https://github.com/scx/nasc/commit/989bff9a4cff609d98e564e33e1016762633ffde
  - type: patch
    path: nasc-0.5.1-meson-optional.patch
  # Change Application ID
  # https://github.com/parnold-x/nasc/issues/101
  # https://github.com/parnold-x/nasc/issues/67
  # https://github.com/elementary/houston/issues/566
  # sed_exp='s!com\.github\.parnold-x\.nasc!com.github.parnold_x.nasc!g'; find * -xtype f \( -name '*.vala' -o -name 'com.github.parnold-x.nasc.*' -o -name 'CMakeLists.txt' -o -name 'meson.build' \) | xargs -I{} sed -i -re "${sed_exp}" '{}'; find * -xtype f -name 'com.github.parnold-x.nasc.*' | while read -r file; do d="$( dirname "${file}" )"; f="$( basename "${file}" )"; g="$( sed -re "${sed_exp}" <<< "${f}" )"; git mv "${d}/${f}" "${d}/${g}"; done; desktop-file-edit --set-key='X-Flatpak-RenamedFrom' --set-value='nasc.desktop;com.github.parnold-x.nasc.desktop;' data/*.desktop;
  # https://github.com/scx/nasc/commit/f0142da2ce18e92ed976afcc30712508d946727e
  - type: patch
    path: nasc-0.5.1-change-id.patch
post-install:
  - ln -s "${FLATPAK_ID}" "${FLATPAK_DEST}/bin/nasc";
  - install -p -D -m 0644 "../COPYING" -t "${FLATPAK_DEST}/share/licenses/nasc/";
modules:
  - gtksourceview.yaml
  - libqalculate.yaml
  - gnuplot.yaml
