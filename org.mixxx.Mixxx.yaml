app-id: org.mixxx.Mixxx
runtime: org.kde.Platform
runtime-version: '5.12'
sdk: org.kde.Sdk
command: mixxx
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --filesystem=xdg-music:ro
  - --device=all
  - --env=LADSPA_PATH=${FLATPAK_DEST}/lib/ladspa
  - --system-talk-name=org.freedesktop.UPower
rename-desktop-file: mixxx.desktop
rename-appdata-file: mixxx
rename-icon: mixx_icon
cleanup:
  - /include
  - /share/man
  - '*.a'
  - '*.la'
  - /lib/pkgconfig
modules:
  - shared-modules/glu/glu-9.0.0.json

  - name: protobuf
    config-opts:
      - --with-zlib
      - --with-pic
    sources:
      - type: archive
        url: https://github.com/protocolbuffers/protobuf/releases/download/v3.8.0/protobuf-all-3.8.0.tar.gz
        sha256: b7220b41481011305bf9100847cf294393973e869973a9661046601959b2960b
    cleanup:
      - /bin

  - name: scons
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --optimize=1
    sources:
      - type: archive
        url: http://downloads.sourceforge.net/project/scons/scons/3.0.5/scons-3.0.5.tar.gz
        sha256: df676f23dc6d4bfa384fc389d95dcd21ab907e6349d4c848958ba4befb73c73e
    cleanup:
      - '*'

  - name: portaudio
    config-opts:
      - --disable-static
      - --without-oss
    sources:
      - type: archive
        url: http://www.portaudio.com/archives/pa_stable_v190600_20161030.tgz
        sha256: f5a21d7dcd6ee84397446fa1fa1a0675bb2e8a4a6dceb4305a8404698d8d1513

  - name: portmidi
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_LIBRARY_OUTPUT_DIRECTORY=${LD_LIBRARY_PATH}
      - -DCMAKE_ARCHIVE_OUTPUT_DIRECTORY=${LD_LIBRARY_PATH}
      - -DCMAKE_RUNTIME_OUTPUT_DIRECTORY=${FLATPAK_DEST}/bin
    sources:
      - type: archive
        url: http://downloads.sourceforge.net/project/portmedia/portmidi/217/portmidi-src-217.zip
        sha256: 08e9a892bd80bdb1115213fb72dc29a7bf2ff108b378180586aa65f3cfd42e0f
      - type: patch
        path: patches/portmidi/portmidi-no-java.patch
    cleanup:
      - /bin

  - name: taglib
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_SHARED_LIBS=ON
      - -DWITH_MP4=ON
      - -DWITH_ASF=ON
    sources:
      - type: archive
        url: http://taglib.github.io/releases/taglib-1.11.1.tar.gz
        sha256: b6d1a5a610aae6ff39d93de5efd0fdc787aa9e9dc1e7026fa4c961b26563526b
    cleanup:
      - /bin

  - name: chromaprint
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_SHARED_LIBS=ON
    sources:
      - type: archive
        url: https://github.com/acoustid/chromaprint/releases/download/v1.4.3/chromaprint-1.4.3.tar.gz
        sha256: ea18608b76fb88e0203b7d3e1833fb125ce9bb61efe22c6e169a50c52c457f82

  - name: vamp-plugin-sdk
    sources:
      - type: archive
        url: https://github.com/c4dm/vamp-plugin-sdk/archive/vamp-plugin-sdk-v2.8.tar.gz
        sha256: a64aedfabcaf1349d695b48b1457f90868fa8ecf2a1c49d1743f1943339d709c
    cleanup:
      - /bin

  - name: rubberband
    config-opts:
      - --disable-program
      - --enable-shared
      - --disable-static
      - --with-ladspa
      - --with-vamp
      - --without-jni
    sources:
      - type: archive
        url: https://bitbucket.org/breakfastquay/rubberband/get/v1.8.2.tar.gz
        sha256: 17c67f0aa6fd682e3c5d79bb1bab0f0d93f3d38d9c54424abb0852b66daa2072
      - type: patch
        path: patches/rubberband/improve-flexibility-with-autoconf.patch
    modules: 
      - name: ladspa-sdk
        no-autogen: true
        subdir: src
        make-install-args:
          - INSTALL_PLUGINS_DIR=${LD_LIBRARY_PATH}/ladspa
          - INSTALL_INCLUDE_DIR=${FLATPAK_DEST}/include
          - INSTALL_BINARY_DIR=${FLATPAK_DEST}/bin
        sources:
          - type: archive
            url: https://www.ladspa.org/download/ladspa_sdk_1.15.tgz
            sha256: 4229959b09d20c88c8c86f4aa76427843011705df22d9c28b38359fd1829fded
          - type: patch
            path: patches/ladspa-sdk/fix-memleak-in-plugin-scanning.patch
            strip-components: 0
        cleanup:
          - /bin

  - libmad/libmad.json

  - libid3tag/libid3tag.json

  - name: libusb
    config-opts: 
      - --disable-static
      - --disable-udev
    sources: 
      - type: archive
        url: https://github.com/libusb/libusb/releases/download/v1.0.22/libusb-1.0.22.tar.bz2
        sha256: 75aeb9d59a4fdb800d329a545c2e6799f732362193b465ea198f2aa275518157

  - name: lilv
    buildsystem: simple
    build-commands:
      - python3 waf configure --prefix=${FLATPAK_DEST}
                              --default-lv2-path=${LD_LIBRARY_PATH}/lv2
                              --no-bash-completion
                              --no-utils
      - python3 waf build -j ${FLATPAK_BUILDER_N_JOBS}
      - python3 waf install
    sources:
      - type: archive
        url: 'https://download.drobilla.net/lilv-0.24.4.tar.bz2'
        sha256: c33b84b7a6e8e8fffb412fbcd6f69e59ca297ef3e29d829249b4ccc94f634438
    modules: 
      - name: lv2
        buildsystem: simple
        build-commands:
          - python3 waf configure --prefix=${FLATPAK_DEST}
                                  --lv2dir=${LD_LIBRARY_PATH}/lv2
                                  --no-plugins
          - python3 waf build -j ${FLATPAK_BUILDER_N_JOBS}
          - python3 waf install
        sources:
          - type: git
            url: 'https://github.com/drobilla/lv2.git'
            tag: v1.16.0
            commit: 0fa4d4847eb6d5bb0f58da889933c94c37ecb730
        cleanup:
          - /bin
          - /share/lv2specgen

      - name: serd
        buildsystem: simple
        build-commands:
          - python3 waf configure --prefix=${FLATPAK_DEST} --no-utils
          - python3 waf build -j $FLATPAK_BUILDER_N_JOBS
          - python3 waf install
        sources:
          - type: archive
            url: 'https://download.drobilla.net/serd-0.30.0.tar.bz2'
            sha256: 6efb0efa5c2155e6bbac941cddeeabb7ed26d70a57d24178894ff169d8f6cefb

      - name: sord
        buildsystem: simple
        build-commands:
          - python3 waf configure --prefix=${FLATPAK_DEST} --no-utils
          - python3 waf build -j $FLATPAK_BUILDER_N_JOBS
          - python3 waf install
        sources:
          - type: archive
            url: 'https://download.drobilla.net/sord-0.16.2.tar.bz2'
            sha256: 09f51174dd8f3efbd95f44f0bb0b165f08e066e052d40095de59de787987da8d

      - name: sratom
        buildsystem: simple
        build-commands:
          - python3 waf configure --prefix=${FLATPAK_DEST}
          - python3 waf build -j $FLATPAK_BUILDER_N_JOBS
          - python3 waf install
        sources:
          - type: archive
            url: 'https://download.drobilla.net/sratom-0.6.2.tar.bz2'
            sha256: 0a514a55d6b6cb7b5d6f32d1dcb78a1e6e54537fa22fce533e4ef6adf240e853

  - name: systemd
    buildsystem: meson
    config-opts:
    - --libdir=lib
    - -Drootprefix=${FLATPAK_DEST}
    - -Drootlibdir=${LD_LIBRARY_PATH}
    - -Dsysconfdir=${FLATPAK_DEST}/etc
    - -Dutmp=false
    - -Dhibernate=false
    - -Dldconfig=false
    - -Dresolve=false
    - -Defi=false
    - -Dtpm=false
    - -Denvironment-d=false
    - -Dbinfmt=false
    - -Dcoredump=false
    - -Dlogind=false
    - -Dhostnamed=false
    - -Dlocaled=false
    - -Dmachined=false
    - -Dportabled=false
    - -Dnetworkd=false
    - -Dtimedated=false
    - -Dtimesyncd=false
    - -Dremote=false
    - -Dnss-myhostname=false
    - -Dnss-mymachines=false
    - -Dnss-resolve=false
    - -Dnss-systemd=false
    - -Dfirstboot=false
    - -Drandomseed=false
    - -Dbacklight=false
    - -Dvconsole=false
    - -Dquotacheck=false
    - -Dsysusers=false
    - -Dtmpfiles=false
    - -Dimportd=false
    - -Dhwdb=false
    - -Drfkill=false
    - -Dman=false
    - -Dhtml=false
    - -Dbashcompletiondir=no
    - -Dzshcompletiondir=no
    sources:
    - type: git
      url: https://github.com/systemd/systemd.git
      tag: v242
      commit: 1e5d2d656420d0e755dbcf72aeba3c3aba54e956
    cleanup:
    - /bin
    - /etc
    # - /lib/libudev*
    - /lib/kernel
    - /lib/modprobe.d
    - /lib/rpm
    - /lib/sysctl.d
    - /lib/systemd
    # - /lib/udev
    - /share

  - name: upower
    config-opts: 
      - --disable-static
      - --with-pic
    sources:
      - type: archive
        url: https://upower.freedesktop.org/releases/upower-0.99.7.tar.xz
        sha256: 24bcc2f6ab25a2533bac70b587bcb019e591293076920f5b5e04bdedc140a401
    modules:
    - name: gudev
      config-opts:
        - --disable-umockdev
      sources: 
        - type: archive
          url: https://download.gnome.org/sources/libgudev/232/libgudev-232.tar.xz
          sha256: ee4cb2b9c573cdf354f6ed744f01b111d4b5bed3503ffa956cefff50489c7860

  - name: mixxx
    buildsystem: simple
    build-commands:
      - scons prefix=${FLATPAK_DEST} -j ${FLATPAK_BUILDER_N_JOBS} shoutcast=0 optimize=native
      - scons prefix=${FLATPAK_DEST} install
      - install -t ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps -Dm644 ${FLATPAK_DEST}/share/pixmaps/mixxx_icon.svg
      - icon_in="${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/mixxx_icon.svg";
        icon_out="${FLATPAK_ID}.png";
        for s in {32,64,128,256,512}; do
        rsvg-convert "${icon_in}" -w "${s}" -h "${s}" -a -f png -o "${icon_out}";
        install -p -Dm644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
        done;
    sources:
      - type: archive
        url: https://github.com/mixxxdj/mixxx/archive/release-2.2.1.tar.gz
        sha256: 9011c854014a1ce826fe465d92693800f50fc97b806f6ba8935ebe2d89f05b31
