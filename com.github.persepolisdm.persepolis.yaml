app-id: com.github.persepolisdm.persepolis
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
command: persepolis
rename-icon: persepolis
copy-icon: true
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --share=network
  - --filesystem=xdg-download
  - --talk-name=org.freedesktop.Notifications
modules:
  - pypi-dependencies.json

  - name: pyside2
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_TESTS=OFF
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://download.qt.io/official_releases/QtForPython/pyside2/PySide2-5.15.2-src/pyside-setup-opensource-src-5.15.2.tar.xz
        sha256: b306504b0b8037079a8eab772ee774b9e877a2d84bab2dbefbe4fa6f83941418
      - type: shell
        commands:
          - mkdir -p /app/include/qt5tmp && cp -R /usr/include/Qt* /app/include/qt5tmp # https://bugreports.qt.io/browse/PYSIDE-787
          - sed -i 's|\(--include-paths=\)|\1/app/include/qt5tmp:|' sources/pyside2/cmake/Macros/PySideModules.cmake

  - name: c-ares
    config-opts:
      - --enable-shared
      - --disable-static
    buildsystem: autotools
    no-autogen: true
    sources:
      - type: archive
        url: https://c-ares.org/download/c-ares-1.17.2.tar.gz
        sha256: 4803c844ce20ce510ef0eb83f8ea41fa24ecaae9d280c468c582d2bb25b3913d
    post-install:
      - install -p -D -m 0644 "LICENSE.md" -t "${FLATPAK_DEST}/share/licenses/c-ares/";

  - name: libssh2
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_SHARED_LIBS:BOOL=ON
    sources:
      - type: archive
        url: https://www.libssh2.org/download/libssh2-1.10.0.tar.gz
        sha256: 2d64e90f3ded394b91d3a2e774ca203a4179f69aebee03003e5a6fa621e41d51
    post-install:
      - install -p -D -m 0644 "../COPYING" -t "${FLATPAK_DEST}/share/licenses/libssh2/";

  - name: aria2
    config-opts:
      - --enable-bittorrent
      - --enable-metalink
      - --enable-websocket
      - --enable-epoll
      # GnuTLS has precedence over OpenSSL if both libraries are installed.
      - --without-openssl
      - --with-gnutls
      - --with-libcares
      - --with-libxml2
      - --with-libz
      - --with-sqlite3
      - --enable-gnutls-system-crypto-policy
    sources:
      - type: archive
        url: https://github.com/aria2/aria2/archive/refs/tags/release-1.36.0.tar.gz
        sha256: 782b5dad48cb333e0cbef8795f868f7963455efecfd2a818feb8dab1cfa973f5
      - type: shell
        commands:
          # https://www.mail-archive.com/search?l=bug-automake@gnu.org&q=subject:%22bug%22&o=newest&f=1
          # https://www.mail-archive.com/bug-automake@gnu.org/msg04633.html
          - autoreconf -vfi || autoreconf -vi;
    post-install:
      - install -p -D -m 0644 "COPYING" LICENSE* -t "${FLATPAK_DEST}/share/licenses/aria2/";
      
  - name: chrpath
    sources:
      - type: archive
        url: http://deb.debian.org/debian/pool/main/c/chrpath/chrpath_0.16.orig.tar.gz
        sha256: bb0d4c54bac2990e1bdf8132f2c9477ae752859d523e141e72b3b11a12c26e7b
    cleanup: ["*"]

  - name: ffmpeg
    config-opts:
      - --enable-shared
      - --disable-static
      - --disable-doc
      - --disable-ffplay
      - --disable-devices
      - --enable-gnutls
      - --enable-libmp3lame
      - --enable-libvorbis
    sources:
      - type: archive
        url: https://www.ffmpeg.org/releases/ffmpeg-4.2.1.tar.xz
        sha256: cec7c87e9b60d174509e263ac4011b522385fd0775292e1670ecc1180c9bb6d4
    post-install:
      - install -Dm644 COPYING.LGPLv3 /app/share/licenses/ffmpeg/COPYING
      - chrpath -d /app/bin/ffmpeg
    cleanup:
      - /share/ffmpeg

  - name: youtube-dl
    no-autogen: true
    no-make-install: true
    make-args:
      - youtube-dl
      - PYTHON=/usr/bin/python
    sources:
      - type: archive
        url: >-
          https://github.com/ytdl-org/youtube-dl/releases/download/2020.02.16/youtube-dl-2020.02.16.tar.gz
        sha256: abcd19c109125a69915c6ad70fcc6b02411a64427fbb7b91a6b37217dfb9e0c6
    post-install:
      - install -Dm0755 -t /app/bin youtube-dl

  - name: persepolis
    buildsystem: simple
    build-commands:
      - python3 setup.py install
    sources:
      - type: git
        url: https://github.com/persepolisdm/persepolis.git
        commit: 7ce2d579f8ffa40a9e899ecc304bcea4f94bf195
