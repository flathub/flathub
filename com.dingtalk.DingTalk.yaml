id: com.dingtalk.DingTalk
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk
command: dingtalk
separate-locales: false

finish-args:
  - --share=ipc
  - --share=network
  - --socket=x11
  - --socket=pulseaudio
  - --device=all
  # Notification
  - --talk-name=org.freedesktop.Notifications
  # System tray icon
  - --own-name=org.kde.*
  # Screenshot
  - --talk-name=org.kde.kwin.Screenshot
  # File system
  - --filesystem=xdg-download
  - --filesystem=xdg-run/pipewire-0:ro

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - '*.la'
  - '*.a'

modules:
  - name: libxcrypt
    buildsystem: autotools
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/besser82/libxcrypt/releases/download/v4.4.36/libxcrypt-4.4.36.tar.xz
        sha256: e5e1f4caee0a01de2aee26e3138807d6d3ca2b8e67287966d1fefd65e1fd8943

  - name: dingtalk
    buildsystem: simple
    build-commands:
      - install -Dpm755 apply_extra ${FLATPAK_DEST}/bin/apply_extra
      - install -Dpm755 dingtalk.sh $FLATPAK_DEST/bin/dingtalk
      - install -Dpm644 com.dingtalk.DingTalk.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
      - install -Dpm644 com.dingtalk.DingTalk.png -t ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps
      - install -Dpm644 com.dingtalk.DingTalk.desktop -t ${FLATPAK_DEST}/share/applications
    sources:      
      - type: script
        commands:
          - bsdtar -O -xf dingtalk.deb data.* | bsdtar --no-same-owner -xf -
          - mv opt/apps/com.alibabainc.dingtalk/files/*-Release.* dingtalk
          - rm -rf dingtalk/{libGLdispatch.so*,libGLX.so*,libm.so*,libstdc++.so*,libcurl.so*,libz.so*,Resources/qss/mac}
          - rm -rf dingtalk.deb usr opt
        dest-filename: apply_extra

      - type: file
        path: dingtalk.sh

      - type: file
        path: com.dingtalk.DingTalk.metainfo.xml

      - type: file
        path: com.dingtalk.DingTalk.png

      - type: file
        path: com.dingtalk.DingTalk.desktop

      - type: extra-data
        filename: dingtalk.deb
        only-arches: [x86_64]
        url: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_7.6.45.5041701_amd64.deb
        sha256: 1d7bd5908ad0817580e4d2af71580978eb4afa4483e9adf25c90799f22cdab35
        size: 344105224
        x-checker-data:
          type: rotating-url
          url: https://www.dingtalk.com/win/d/qd=linux_amd64
          pattern: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_([0-9.]+)_amd64.deb
      
      - type: extra-data
        filename: dingtalk.deb
        only-arches: [aarch64]
        url: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_7.6.45.5041701_arm64.deb
        sha256: f253281e23221b0a9ee36691ac7b0f7e063bf77c25dc284abbde667bb8dbcb09
        size: 330853280
        x-checker-data:
          type: rotating-url
          url: https://www.dingtalk.com/win/d/qd=linux_arm64
          pattern: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_([0-9.]+)_arm64.deb