app-id: net.sourceforge.eaglemode.EagleMode

runtime: org.freedesktop.Sdk
runtime-version: '18.08'
sdk: org.freedesktop.Sdk

command: eaglemode
rename-desktop-file: eaglemode.desktop
rename-icon: eaglemode

finish-args:
  # X11 + Xshm
  - --socket=x11
  - --share=ipc
  # Acceleration
  - --device=dri
  # File manager
  - --filesystem=host

modules:
  - shared-modules/gtk2/gtk2.json

  - name: ghostscript
    config-opts:
      - --with-system-libtiff
      - --disable-cups
      - --disable-dbus
      - --disable-gtk
      - --enable-dynamic
      - --with-drivers=FILES
    sources:
      - type: archive
        url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs926/ghostscript-9.26.tar.xz
        sha256: 90ed475f37584f646e9ef829932b2525d5c6fc2e0147e8d611bc50aa0e718598
      - type: shell
        commands:
          - rm -rf libpng/pngread.c
    cleanup:
      - /share/man
      - /share/ghostscript/*/doc
      - /share/ghostscript/*/examples
      - /bin/*.sh
      - /bin/dvipdf
      - /bin/eps2eps
      - /bin/gsbj
      - /bin/gsd*
      - /bin/gsl*
      - /bin/gsnd
      - /bin/p*

  - name: poppler
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_GTK_TESTS=OFF
      - -DBUILD_QT5_TESTS=OFF
      - -DENABLE_CPP=OFF
      - -DENABLE_UTILS=OFF
      - -DENABLE_QT5=OFF
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-0.75.0.tar.xz
        sha256: 3bbaedb0fa2797cac933a0659d144303e4d09eec6892c65600da987d8707199a
    cleanup:
      - /include
      - /lib/pkgconfig
      - '*.la'
    modules:
      - name: openjpeg2
        buildsystem: cmake-ninja
        config-opts:
          - -DBUILD_CODEC=OFF
        sources:
          - type: archive
            url: https://github.com/uclouvain/openjpeg/archive/v2.3.0.tar.gz
            sha256: 3dc787c1bb6023ba846c2a0d9b1f6e179f1cd255172bde9eb75b01f1e6c7d71a
        cleanup:
          - /include
          - /lib/pkgconfig
          - /lib/openjpeg-2.3
          - '*.a'

  - name: eaglemode
    buildsystem: simple
    build-commands:
      - perl make.pl build continue=no projects=not:emAv cpus=$(nproc --all)
      - perl make.pl install root=/app dir=/lib/eaglemode menu=yes
    post-install:
      # Modified from http://eaglemode.sourceforge.net/InstallAndStart.html#3.1
      - |
        mkdir -p /app/{bin,etc,share/doc}

        cd /app/lib/eaglemode
        mv -T doc ../../share/doc/eaglemode
        ln -s ../../share/doc/eaglemode doc
        mv -T res ../../share/eaglemode
        ln -s ../../share/eaglemode res
        mv -T etc ../../etc/eaglemode
        ln -s ../../etc/eaglemode etc

        cd /app/bin
        ln -s ../lib/eaglemode/eaglemode.sh eaglemode

        cd /app/lib
        ln -s eaglemode/lib/*.so .

        cd /app/share/
        for i in {32,48}; do
          mkdir -p icons/hicolor/${i}x${i}/app
          cp eaglemode/icons/eaglemode${i}.png icons/hicolor/${i}x${i}/app/eaglemode.png
        done
        desktop-file-edit --set-key=Exec --set-value=eaglemode applications/eaglemode.desktop
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/eaglemode/eaglemode-0.94.0.tar.bz2
        sha256: 33798753e41f22756a6402efc445729d25ef93982a43de36de5ac8e4535b23eb
      - type: shell
        commands:
          - sed -i "s|/usr||" make.pl
    cleanup:
      - /lib/eaglemode/include
