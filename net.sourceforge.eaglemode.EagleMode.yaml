app-id: net.sourceforge.eaglemode.EagleMode

runtime: org.freedesktop.Sdk
runtime-version: '18.08'
sdk: org.freedesktop.Sdk

command: eaglemode
rename-desktop-file: eaglemode.desktop
rename-icon: eaglemode

finish-args:
  # Edit anything
  - --filesystem=host
  # Plugin updates
  - --share=network
  # Clipboard access
  - --socket=x11
  - --share=ipc

modules:
  - name: eaglemode
    buildsystem: simple
    build-commands:
      - perl make.pl build continue=no projects=not:emAv cpus=$(nproc --all)
      - perl make.pl install root=/app dir=/lib/eaglemode menu=yes
    post-install:
      # Modified from http://eaglemode.sourceforge.net/InstallAndStart.html#3.1
      - |
        mkdir -p /app/{bin,etc,share/doc}

        cd /app/lib/eaglemode
        mv -T doc ../../share/doc/eaglemode
        ln -s ../../share/doc/eaglemode doc
        mv -T res ../../share/eaglemode
        ln -s ../../share/eaglemode res
        mv -T etc ../../etc/eaglemode
        ln -s ../../etc/eaglemode etc

        cd /app/bin
        ln -s ../lib/eaglemode/eaglemode.sh eaglemode

        cd /app/lib
        ln -s eaglemode/lib/*.so .

        cd /app/share/
        for i in {32,48}; do
          mkdir -p icons/hicolor/${i}x${i}/app
          cp eaglemode/icons/eaglemode${i}.png icons/hicolor/${i}x${i}/app/eaglemode.png
        done
        desktop-file-edit --set-key=Exec --set-value=eaglemode applications/eaglemode.desktop
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/eaglemode/eaglemode-0.94.0.tar.bz2
        sha256: 33798753e41f22756a6402efc445729d25ef93982a43de36de5ac8e4535b23eb
      - type: shell
        commands:
          - sed -i "s|/usr||" make.pl
    cleanup:
      - /lib/eaglemode/include
