# SPDX-FileCopyrightText: 2025 Marcin Serwin <marcin@serwin.dev>
#
# SPDX-License-Identifier: CC0-1.0

id: dev.serwin.AbeRE
runtime: org.freedesktop.Platform
runtime-version: "25.08"
sdk: org.freedesktop.Sdk
command: abe-re
finish-args:
  # Video
  - --socket=wayland
  - --socket=fallback-x11
  # Audio
  - --filesystem=xdg-run/pipewire-0:ro
  - --socket=pulseaudio
  # Hardware acceleration
  - --device=dri
  - --share=ipc
modules:
  - name: tinyxxd
    buildsystem: simple
    cleanup:
      - "*"
    sources:
      - type: git
        url: https://github.com/xyproto/tinyxxd
        tag: v1.3.7
    build-options:
      env:
        MAKEFLAGS: PREFIX=${FLATPAK_DEST} -j${FLATPAK_BUILDER_N_JOBS}
    build-commands:
      - make
      - make install

  - name: abe-re
    buildsystem: simple
    sources:
      - type: git
        url: https://git.sr.ht/~marcin-serwin/abe-re
        tag: z1
    build-options:
      env:
        CC: cc
        XXD: /app/bin/tinyxxd
        MAKEFLAGS:
          PREFIX=${FLATPAK_DEST} -j${FLATPAK_BUILDER_N_JOBS}
          VERSION_SUFFIX=-flathub
    build-commands:
      - sed -i '2,10d' dist/icon.svg # Drop with next release
      - make checkdeps
      - make
      - make install
