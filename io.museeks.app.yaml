id: io.museeks.app

runtime: org.gnome.Platform
runtime-version: '46'
sdk: org.gnome.Sdk

command: museeks
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --talk-name=org.freedesktop.Notifications
  - --share=network
  - --socket=pulseaudio
  - --env=WEBKIT_DISABLE_COMPOSITING_MODE=1

modules:
  - name: binary
    buildsystem: simple
    sources:
      - type: file
        url: https://github.com/martpie/museeks/releases/download/0.22.0/Museeks_0.22.0_amd64.deb # make that 0.22
        sha256: a21c0fcb424ce77e0d7a20e2d53bc365ba6a6fdebfb2c0ae039e832d2ccbadb3
        only-arches: [x86_64]
    build-commands:
      - set -e
      # Extract the deb package
      - mkdir deb-extracted
      - ar -x *.deb --output deb-extracted
      - tar -C deb-extracted -xf deb-extracted/data.tar.gz

      # Copy binary
      - 'install -Dm755 deb-extracted/usr/bin/museeks /app/bin/museeks'

      # Copy app files (migrations and icons)
      - mkdir -p /app/lib/Museeks/migrations
      - cp -r deb-extracted/usr/lib/Museeks/. /app/lib/Museeks
      - find /app/lib/Museeks -type f -exec chmod 644 {} \;

      # Copy desktop file + ensure the right icon is set
      - sed -i 's/^Icon=.*/Icon=io.museeks.app/' deb-extracted/usr/share/applications/Museeks.desktop
      - install -Dm644 deb-extracted/usr/share/applications/Museeks.desktop /app/share/applications/io.museeks.app.desktop

      # Copy icons
      - install -Dm644 deb-extracted/usr/share/icons/hicolor/128x128/apps/museeks.png /app/share/icons/hicolor/128x128/apps/io.museeks.app.png
      - install -Dm644 deb-extracted/usr/share/icons/hicolor/32x32/apps/museeks.png /app/share/icons/hicolor/32x32/apps/io.museeks.app.png
      - install -Dm644 deb-extracted/usr/share/icons/hicolor/256x256@2/apps/museeks.png /app/share/icons/hicolor/256x256@2/apps/io.museeks.app.png
      - install -Dm644 deb-extracted/usr/share/metainfo/io.museeks.app.metainfo.xml /app/share/metainfo/io.museeks.app.metainfo.xml
