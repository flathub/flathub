app-id: jp.nonbili.noutube
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: '25.08'
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node22
command: run.sh
separate-locales: false
finish-args:
  - --device=dri
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --share=network
  - --own-name=org.mpris.MediaPlayer2.chromium.*
modules:
  - name: noutube
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node22/bin:/run/build/noutube/bin
      env:
        VITE_SUPABASE_URL: https://pgukcvgypvjwtibzlvhr.supabase.co
        VITE_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBndWtjdmd5cHZqd3RpYnpsdmhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTI0NTIzODQsImV4cCI6MjAyODAyODM4NH0.zoxse4Kay_svHlQOiAINZm1lPIFPJMZAY8RKZUDSQrs
        VITE_BUILD_TARGET: portable
    build-commands:
      - bun run bundle
      - |
        cd desktop
        bun electron-vite build
        bun electron-builder --dir --publish never --config.electronDist=../node_modules/electron/dist2
        cp -a dist/linux*unpacked /app/main

      - install -Dm755 -t /app/bin/ ./run.sh
      - install -Dm644 metadata/flatpak/jp.nonbili.noutube.metainfo.xml -t /app/share/metainfo/
      - install -Dm644 metadata/flatpak/jp.nonbili.noutube.desktop -t /app/share/applications/
      - install -Dm644 desktop/icon.png /app/share/icons/hicolor/512x512/apps/jp.nonbili.noutube.png
    sources:
      - type: archive
        url: https://github.com/nonbili/NouTube-Desktop/releases/download/v0.1.9/source.tar.gz
        sha256: d1e33e9c5d1febd4c41abccb66d093deb206fe4d8f1c632a86d856116b034b7b
        strip-components: 0
        x-checker-data:
          type: json
          url: https://api.github.com/repos/nonbili/NouTube-Desktop/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: .tarball_url
          is-main-source: true

      - type: archive
        url: https://github.com/nonbili/NouTube-Desktop/releases/download/v0.1.9/node_modules-x64.tar.gz
        sha256: 9765e8aea99b76e6ae8bffa650e8c5af8f0f2f83899887a20d7d4df8b7f900da
        dest: node_modules
        only-arches: [x86_64]

      - type: archive
        url: https://github.com/oven-sh/bun/releases/download/bun-v1.3.1/bun-linux-x64.zip
        sha256: 400824c82bfcc0854365bcada11cf53d7384ecb1e2c3da0e2c0a2c6a527d5629
        dest: bin
        only-arches: [x86_64]

      - type: archive
        url: https://github.com/electron/electron/releases/download/v37.2.5/electron-v37.2.5-linux-x64.zip
        sha256: 8fbb9e05130bde60db97a05c07969039a83e7adb9885251f90727ad1e0684be7
        strip-components: 0
        dest: node_modules/electron/dist2
        only-arches: [x86_64]

      - type: archive
        url: https://github.com/nonbili/NouTube-Desktop/releases/download/v0.1.9/node_modules-arm64.tar.gz
        sha256: caf049ee37930650269f7c83bc3bfb4548f8e4100625f124e6a08986bf7610e0
        dest: node_modules
        only-arches: [aarch64]

      - type: archive
        url: https://github.com/oven-sh/bun/releases/download/bun-v1.3.1/bun-linux-aarch64.zip
        sha256: 65666a18439e891e5751b666103fe591a8519f11b66ec4bd8654c5515d4fff8a
        dest: bin
        only-arches: [aarch64]

      - type: archive
        url: https://github.com/electron/electron/releases/download/v37.2.5/electron-v37.2.5-linux-arm64.zip
        sha256: d0651db80a6f7eb047b4eaed3d9b836a48f059c144fc3d86f33a5031033fe6bb
        strip-components: 0
        dest: node_modules/electron/dist2
        only-arches: [aarch64]

      - type: script
        dest-filename: run.sh
        commands:
          - zypak-wrapper.sh /app/main/NouTube "$@"
