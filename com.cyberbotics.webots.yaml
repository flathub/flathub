app-id: com.cyberbotics.webots
runtime: org.kde.Platform
runtime-version: '6.8'
sdk: org.kde.Sdk
command: webots
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk
separate-locales: false

finish-args:
  - --share=ipc
  - --share=network
  - --socket=x11
  - --socket=pulseaudio
  - --device=dri
cleanup:
  - /bin/*swig
  - /bin/distro
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /lib/python*
  - /lib/*.a
  - /share/swig
modules:
  - python3-modules.json
  - name: glu
    buildsystem: meson
    sources:
      - type: archive
        url: https://archive.mesa3d.org/glu/glu-9.0.3.tar.xz
        sha256: bd43fe12f374b1192eb15fe20e45ff456b9bc26ab57f0eee919f96ca0f8a330f

  - name: swig
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/swig/swig.git
        tag: v4.3.1
        commit: f8611c6288dfc38f838e9eab61aa802c46b21189

  - name: webots
    buildsystem: simple
    build-commands:
      - install -Dpm644 scripts/packaging/webots.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dpm644 scripts/packaging/webots.png     ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
      - install -Dpm644 -t ${FLATPAK_DEST}/share/metainfo ${FLATPAK_ID}.metainfo.xml
      - desktop-file-edit --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key="Categories" --set-value="Application;Education;Robotics;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      # Patch
      - for p in *.patch; do patch -p1 < "$p"; done
      # Install deps
      - mv xc16-1.24.zip projects/robots/gctronic/e-puck/transfer
      - tar xfm libpico.tar.bz2 -C .
      - tar xfm libassimp.tar.bz2 -C .
      - tar xfm libOIS.tar.bz2 -C .
      - ln -s /usr/bin/lrelease ${FLATPAK_BUILDER_BUILDDIR}/bin/qt
      - ln -s /usr/lib/libexec/moc ${FLATPAK_BUILDER_BUILDDIR}/bin/qt
      # Enable openjdk & Build webots
      - source /usr/lib/sdk/openjdk/enable.sh &&
        CFLAGS="-Wno-unused-result" make distrib -j${FLATPAK_BUILDER_N_JOBS}
      # Install
      - tar xjf distribution/webots-*.tar.bz2 -C ${FLATPAK_DEST}
      - rm -rf ${FLATPAK_DEST}/webots/bin/{qt,qt.conf}
      - mkdir -p ${FLATPAK_DEST}/bin && ln -s ${FLATPAK_DEST}/webots/webots ${FLATPAK_DEST}/bin
    sources:
      - type: git
        url: https://github.com/cyberbotics/webots.git
        tag: R2025a
        commit: c6793d8f7230a311c4bc2a3101d9f1a8bc0aa01b
        x-checker-data:
          type: json
          url: https://api.github.com/repos/cyberbotics/webots/releases/latest
          version-query: .tag_name
          timestamp-query: .published_at
      - type: dir
        path: patches
      - type: file
        path: com.cyberbotics.webots.metainfo.xml
      - type: file
        url: https://cyberbotics.com/files/repository/dependencies/linux64/release/libpico.tar.bz2
        sha256: 56870e42ce411f4e596b5859d373ae07e86dcca1c308c1226ec5ecd694d6ab56
      - type: file
        url: https://cyberbotics.com/files/repository/dependencies/linux64/release/libassimp-5.2.3.tar.bz2
        sha256: 31c12e4e9f6bf52259dc599c8fcdb77c511c170e18cdc70543b10903aa28c697
        dest-filename: libassimp.tar.bz2
      - type: file
        url: https://cyberbotics.com/files/repository/dependencies/linux64/release/libOIS.1.4.tar.bz2
        sha256: ec13db6efd6901e80e9c4b437319c7949253a47fee768515a3aa1e6ca122225d
        dest-filename: libOIS.tar.bz2
      - type: file
        url: https://www.cyberbotics.com/files/repository/dependencies/linux64/release/xc16-1.24.zip
        sha256: c57816d5aa0ed9da2c4de510a4f3a1cb0c4e16e2d9c191411d0830032c761aee
