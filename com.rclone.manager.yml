id: com.rclone.manager

runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk

command: rclone-manager
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --share=ipc
  - --share=network
  - --talk-name=org.freedesktop.Notifications # When UI not openned, it uses notifications to show status. --talk-name=org.freedesktop.portal.Desktop not working very well.
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.freedesktop.secrets # For storing encrypted config passwords
  - --system-talk-name=org.freedesktop.NetworkManager # For detecting is metered or not/
  - --talk-name=org.freedesktop.Flatpak # Required for flatpak-spawn to access host commands
  - --talk-name=org.freedesktop.portal.Desktop
  - --filesystem=xdg-run/tray-icon:create
  - --filesystem=home # For accessing user rclone config and other files
modules:
  - name: fusermount-wrapper # Need for mount and other rclone operations
    buildsystem: simple
    sources:
      - type: file
        path: fusermount-wrapper.sh
    build-commands:
      - install -Dm755 fusermount-wrapper.sh /app/bin/fusermount3

  - name: lsof-wrapper # Need for track rclone
    buildsystem: simple
    sources:
      - type: file
        path: lsof-wrapper.sh
    build-commands:
      - install -Dm755 lsof-wrapper.sh /app/bin/lsof

  - name: terminal-wrapper # Need for opening terminals from within flatpak
    buildsystem: simple
    sources:
      - type: file
        path: terminal-wrapper.sh
    build-commands:
      - install -Dm755 terminal-wrapper.sh /app/bin/kgx
      - install -Dm755 terminal-wrapper.sh /app/bin/gnome-terminal
      - install -Dm755 terminal-wrapper.sh /app/bin/xterm
      - install -Dm755 terminal-wrapper.sh /app/bin/konsole
      - install -Dm755 terminal-wrapper.sh /app/bin/alacritty

  - shared-modules/libayatana-appindicator/libayatana-appindicator-gtk3.json
  - name: prebuilt-binaries # We already have builded apps so we don't need to build again.
    buildsystem: simple
    sources:
      - type: file
        url: https://github.com/RClone-Manager/rclone-manager/releases/download/v0.1.3-beta/RClone.Manager_0.1.3_amd64.deb
        sha256: dfcf0e7a895c875913d4e70048589496aeb4c6636731d9e8ec2b0d8bf673fbdb
        only-arches: [x86_64]
      - type: file
        url: https://github.com/RClone-Manager/rclone-manager/releases/download/v0.1.3-beta/RClone.Manager_0.1.3_arm64.deb
        sha256: b2117739c54ffc9856c047f125ccf239e4481cc469a8d20d68b50712ad924194
        only-arches: [aarch64]
      - type: file
        path: flatpak.metainfo.xml
    build-commands:
      - mkdir extracted
      - ar -x *.deb --output extracted
      - tar -C extracted -xf extracted/data.tar.gz
      - install -Dm755 extracted/usr/bin/rclone-manager /app/bin/rclone-manager

      # Copy any bundled libraries if they exist
      - test -d "extracted/usr/lib" && mkdir -p /app/lib/com.rclone.manager && cp -r extracted/usr/lib/*. /app/lib/com.rclone.manager/ && find /app/lib/com.rclone.manager -type f -exec chmod 644 {} \; || true

      - install -Dm644 extracted/usr/share/icons/hicolor/128x128/apps/'rclone-manager.png' /app/share/icons/hicolor/128x128/apps/com.rclone.manager.png
      - install -Dm644 extracted/usr/share/icons/hicolor/32x32/apps/'rclone-manager.png' /app/share/icons/hicolor/32x32/apps/com.rclone.manager.png
      - install -Dm644 extracted/usr/share/icons/hicolor/256x256@2/apps/'rclone-manager.png' /app/share/icons/hicolor/256x256@2/apps/com.rclone.manager.png
      - install -Dm644 flatpak.metainfo.xml /app/share/metainfo/com.rclone.manager.metainfo.xml

      - install -Dm644 extracted/usr/share/applications/'RClone Manager.desktop' /app/share/applications/com.rclone.manager.desktop
      - desktop-file-edit --set-icon=com.rclone.manager /app/share/applications/com.rclone.manager.desktop
