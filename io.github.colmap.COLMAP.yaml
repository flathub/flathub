app-id: io.github.colmap.COLMAP
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: '5.15'
command: run.sh
rename-desktop-file: COLMAP.desktop
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --filesystem=home
cleanup:
  - "/bin/cgal*"
  - "/include"
  - "/lib/cmake"
  - "/lib64/cmake"
  - "/share/doc"
  - "*.la"
  - "*.a"

modules:
  - shared-modules/glew/glew.json
  - shared-modules/glu/glu-9.json
  
  - name: Eigen3
    buildsystem: cmake-ninja
    builddir: true
    cleanup: 
      - "*"
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.3.9/eigen-3.3.9.tar.bz2
        sha256: 0fa5cafe78f66d2b501b43016858070d52ba47bd9b1016b0165a7b8e04675677 
  
  - name: Boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app
      - ./b2 install --build-type=complete link=shared --layout=versioned runtime-link=shared cxxflags="$CXXFLAGS" linkflags="$LDFLAGS" -j $FLATPAK_BUILDER_N_JOBS
    sources:
      - type: archive
        url: https://dl.bintray.com/boostorg/release/1.75.0/source/boost_1_75_0.tar.gz
        sha256: aeb26f80e80945e82ee93e5939baebdca47b9dee80a07d3144be1e1a6a66dd6a
        
  - name: MPFR
    sources:
      - type: archive
        url: https://www.mpfr.org/mpfr-current/mpfr-4.1.0.tar.xz
        sha256: 0c98a3f1732ff6ca4ea690552079da9c597872d30e96ec28414ee23c95558a7f
    buildsystem: autotools
    builddir: true
        
  - name: CGAL
    sources:
      - type: archive
        url: https://github.com/CGAL/cgal/releases/download/releases%2FCGAL-4.14/CGAL-4.14.tar.xz
        sha256: 59464b1eaee892f2223ba570a7642892c999e29524ab102a6efd7c29c94a29f7
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCGAL_HEADER_ONLY=ON
      
  - name: openblas
    no-autogen: true
    make-args:
      - DYNAMIC_ARCH=1
      - FC=gfortran
      - NO_CBLAS=1
      - NO_LAPACKE=1
      - USE_OPENMP=0    ## OpenMP off by default, this hack skips 'test_fork' which crashes on i386
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.3.13.tar.gz
        sha256: 79197543b17cc314b7e43f7a33148c308b0807cd6381ee77f77e15acf3e6459e
        x-checker-data:
          type: anitya
          project-id: 2540
          url-template: https://github.com/xianyi/OpenBLAS/archive/v$version.tar.gz
        
  - name: suitesparse
    make-args:
      - BLAS=-lopenblas
      - LAPACK=
      - library
    make-install-args:
      - BLAS=-lopenblas
      - LAPACK=
      - INSTALL_LIB=/app/lib
      - INSTALL_INCLUDE=/app/include
      - library
    no-autogen: true
    sources:
      - type: archive
        url: https://github.com/DrTimothyAldenDavis/SuiteSparse/archive/v5.9.0.tar.gz
        sha256: 7bdd4811f1cf0767c5fdb5e435817fdadee50b0acdb598f4882ae7b8291a7f24
        x-checker-data:
          type: anitya
          project-id: 4908
          url-template: https://github.com/DrTimothyAldenDavis/SuiteSparse/archive/v$version.tar.gz
      - type: patch
        path: suitesparse-reduce-build.patch
   
  - name: freeimage
    no-autogen: true
    make-args:
      - DESTDIR=/app
    sources:
      - type: archive
        url: http://downloads.sourceforge.net/freeimage/FreeImage3180.zip
        sha256: f41379682f9ada94ea7b34fe86bf9ee00935a3147be41b6569c9605a53e438fd
      - type: shell
        commands:
          - sed -i 's|-o root -g root ||' ./Makefile.gnu
          - sed -i 's|/usr|/app|' ./Makefile.gnu
        
    # ceres-solver dependency   
  - name: google-glog
    buildsystem: cmake
    config-opts:
      - -DWITH_GFLAGS=ON
    sources:        
      - type: archive
        url: https://github.com/google/glog/archive/v0.4.0.tar.gz
        sha256: f28359aeba12f30d73d9e4711ef356dc842886968112162bc73002645139c39c     
        
  - name: ceres-solver
    buildsystem: cmake
    config-opts:
      - -DCXSPARSE=ON 
      - -DSUITESPARSE=ON 
      - -DEIGENSPARSE=ON 
      - -DGFLAGS=OFF 
      - -DMINIGLOG=OFF 
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TESTING=OFF
      - -DBUILD_EXAMPLES=OFF
    sources:
      - type: archive
        url: http://ceres-solver.org/ceres-solver-2.0.0.tar.gz
        sha256: 10298a1d75ca884aa0507d1abb0e0f04800a92871cd400d4c361b56a777a7603
        
    #colmap look for libceres.so.2 in lib    
  - name: copy-libceres-to-lib
    buildsystem: simple
    build-commands:
      - cp /app/lib64/libceres.so.2 /app/lib/libceres.so.2
        
  - name: COLMAP
    buildsystem: cmake
    config-opts:
      - -DCMAKE_BUILD_TYPE:STRING=Release
      - -DBOOST_STATIC=OFF
      - -DEIGEN3_VERSION=3.3.9
      - -DCeres_DIR=/app/lib64
    post-install:
      - desktop-file-edit --set-key=Exec --set-value='/app/bin/run.sh' /app/share/applications/COLMAP.desktop
    sources:
      - type: archive
        url: https://github.com/colmap/colmap/archive/3.6.tar.gz
        sha256: ea22d026a3b13d339551319f4562fe1471b7232433695970704669755031a192
        
  - name: COLMAP-wrapper
    buildsystem: simple
    build-commands:
      - install run.sh /app/bin/
    sources:
      - type: script
        dest-filename: run.sh
        commands:
          - colmap gui
