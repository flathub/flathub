app-id: io.github.DamnedAngel.msx-tile-forge
runtime: org.freedesktop.Platform
runtime-version: "25.08"
sdk: org.freedesktop.Sdk

command: msxtileforge

build-options:
  append-path: /usr/lib/sdk/python3/bin
  env:
    PYTHON: /usr/bin/python3
    TAG_NAME: v01.00.00_rc20_5

finish-args:
  - --share=ipc # needed for X11
  - --socket=fallback-x11
  - --socket=wayland
  - --share=network
  - --device=dri
  - --filesystem=xdg-documents

modules:
  - "python-tk.yaml"

  - name: msx-tile-forge
    buildsystem: simple
    build-options:
      build-args:
        - --share=network
    sources:
      - type: git
        url: https://github.com/DamnedAngel/msx-tile-forge.git
        tag: v01.00.00_rc20_5 # tag name
        commit: 9d5ee12897f7cff657c396c8afe05dec1465beaf # exact commit for the tag
      - type: file
        path: io.github.DamnedAngel.msx-tile-forge.desktop
      - type: file
        path: io.github.DamnedAngel.msx-tile-forge.metainfo.xml
      - type: file
        path: io.github.DamnedAngel.msx-tile-forge.png
      - type: file
        path: run.sh
    build-commands:
      # Fix version string
      - find . -type f -name "*.py" -exec sed -i "s/<unreleased>/${TAG_NAME}/g" {} +
      # Install Python dependencies
      - pip3 install --prefix=/app platformdirs
      - pip3 install -r requirements.txt
      # Install Python sources
      - install -Dm644 msxtileforge.py /app/bin/msxtileforge.py
      - install -Dm644 msxtileexport.py /app/bin/msxtileexport.py
      - install -Dm644 msxtilemagic.py /app/bin/msxtilemagic.py
      - install -Dm644 supertilerandomizer.py /app/bin/supertilerandomizer.py
      - install -Dm644 tilerandomizer.py /app/bin/tilerandomizer.py
      # Install wrapper script
      - install -Dm755 run.sh /app/bin/msxtileforge
      # Install icon
      - install -Dm644 io.github.DamnedAngel.msx-tile-forge.png /app/share/icons/hicolor/256x256/apps/io.github.DamnedAngel.msx-tile-forge.png
      # Install desktop entry
      - install -Dm644 io.github.DamnedAngel.msx-tile-forge.desktop /app/share/applications/io.github.DamnedAngel.msx-tile-forge.desktop
      # Install AppStream metadata
      - install -Dm644 io.github.DamnedAngel.msx-tile-forge.metainfo.xml /app/share/metainfo/${FLATPAK_ID}.metainfo.xml
    cleanup:
      - "*.pyc"
      - "*.pyo"
