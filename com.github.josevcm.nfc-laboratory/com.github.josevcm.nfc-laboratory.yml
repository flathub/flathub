id: com.github.josevcm.nfc-laboratory
runtime: org.kde.Platform
runtime-version: '6.8'
sdk: org.kde.Sdk
command: nfc-lab

finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  # - --device=usb  # Requires Flatpak 1.16+ (January 2025), use --device=all for compatibility
  - --device=all  # Required for USB access to SDR receivers and logic analyzers
  - --filesystem=xdg-documents:rw
  - --filesystem=xdg-download:rw
  - --persist=.nfc-lab

cleanup:
  - /include
  - /lib/pkgconfig
  - /lib/cmake
  - /share/man
  - /share/doc
  - '*.a'
  - '*.la'

modules:
  - name: libusb
    buildsystem: autotools
    config-opts:
      - --disable-static
      - --prefix=/app
    sources:
      - type: archive
        url: https://github.com/libusb/libusb/releases/download/v1.0.27/libusb-1.0.27.tar.bz2
        sha256: ffaa41d741a8a3bee244ac8e54a72ea05bf2879663c098c82fc5757853441575
    cleanup:
      - /lib/*.la

  - name: libairspy
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DINSTALL_UDEV_RULES=OFF
    sources:
      - type: git
        url: https://github.com/airspy/airspyone_host.git
        tag: v1.0.10
        commit: 229d5a5045b890621cd9cc200a19b1541c6021ae
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
    cleanup:
      - /lib/*.la

  - name: librtlsdr
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DINSTALL_UDEV_RULES=OFF
      - -DDETACH_KERNEL_DRIVER=ON
    sources:
      - type: git
        url: https://github.com/osmocom/rtl-sdr.git
        tag: v2.0.2
        commit: 619ac3186ea0ffc092615e1f59f7397e5e6f668c
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
    cleanup:
      - /lib/*.la

  - name: nfc-laboratory-metainfo
    buildsystem: simple
    sources:
      - type: file
        path: dat/flatpak/com.github.josevcm.nfc-laboratory.metainfo.xml
    build-commands:
      - install -Dm644 com.github.josevcm.nfc-laboratory.metainfo.xml /app/share/metainfo/com.github.josevcm.nfc-laboratory.metainfo.xml

  - name: nfc-laboratory
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DBUILD_PROJECT_VERSION=3.3.1
      - -DCMAKE_C_FLAGS_RELEASE=-O3 -DNDEBUG
      - -DCMAKE_CXX_FLAGS_RELEASE=-O3 -DNDEBUG
    sources:
      - type: git
        url: https://github.com/josevcm/nfc-laboratory.git
        tag: '3.3.1'
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$
    post-install:
      - ln -sf /app/lib64/librtlsdr.so.0 /app/lib/librtlsdr.so.0
      - test -f /app/share/applications/nfc-lab.desktop && mv /app/share/applications/nfc-lab.desktop /app/share/applications/${FLATPAK_ID}.desktop || true
      - desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID} /app/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key=Categories --set-value="Science;Engineering;" /app/share/applications/${FLATPAK_ID}.desktop
      - test -f /app/share/icons/hicolor/512x512/apps/nfc-lab.png && mv /app/share/icons/hicolor/512x512/apps/nfc-lab.png /app/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png || true
      - rm -f /app/share/icons/hicolor/scalable/apps/nfc-lab.svg
      - mkdir -p /app/share/nfc-lab
      - if [ -d dat/firmware ]; then cp -r dat/firmware /app/share/nfc-lab/; fi
      - if [ -d dat/config ]; then cp -r dat/config /app/share/nfc-lab/; fi
