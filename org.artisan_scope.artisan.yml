id: org.artisan_scope.artisan
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: '6.7'

base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.7'
cleanup-commands:
  # we don't need static libraries
  - find /app/lib -name \*.a | xargs rm -f
  # remove build dependencies
  - python3 -m pip uninstall -y pythran pyproject_hooks pyproject_metadata \
      pycparser meson_python expandvars cppy pybind11
  # deduplicate (matplotlib) fonts already in runtime
  - for f in /usr/share/fonts/dejavu/*.ttf; do find /app -name `basename $f` -execdir ln -sf "$f" \; ; done
  # remove Python test suites
  - find /app/lib/python* -type d -name tests | xargs rm -Rf
  # Yoctupuce includes compiled libraries *sigh*, only keep the ones we may need
  - |
    python3 <<EOF
    from os import listdir, remove
    from os.path import basename, dirname, join
    from yoctopuce.yocto_api import YAPI
    YAPI.yloadYapiCDLL()
    dir = dirname(YAPI._yApiCLibFile)
    keep = [basename(f) for f in [YAPI._yApiCLibFile, YAPI._yApiCLibFileFallback]]
    [remove(join(dir, f)) for f in listdir(dir) if f not in keep]
    EOF
  # cleanup QtWebEngine dictionaries, which we don't need and use quite some space
  - find /app/share/locale -name \*.bdic | xargs rm -f
  - rm -Rf /app/qtwebengine_dictionaries
  # we need no QtWebEngine developer tools, nor automation driver
  - rm -f /app/resources/qtwebengine_devtools_resources.pak
  - rm -Rf /app/libexec/webenginedriver
  # cleanup base
  - /app/cleanup-BaseApp.sh

command: artisan
separate-locales: false
finish-args:
  # Qt
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  #- --device=dri # we already have --device=all
  # USB
  - --device=all
  # allow network access for network devices and artisan.plus
  - --share=network

modules:
  - ./dep-openblas.yml
  - ./dep-qhull.yml
  - ./dep-snap7.yml
  - ./shared-modules/libusb/libusb.json
  - ./dep-python3-artisan.json

  - name: artisan
    buildsystem: simple
    build-commands:
      # install without application bundle with dependencies
      - sed -i 's/^\s*\(pyinstaller\|rm -rf dist\)/#\1/' src/build-linux.sh
      - mkdir -p src/dist/artisan && touch src/dist/artisan/__dummy__
      - cd src && PATH=/var/data/python/bin:$PATH ./build-linux.sh
      - rm -f $FLATPAK_DEST/__dummy__
      # copy all gathered files to the destination
      - mkdir $FLATPAK_DEST/includes
      - cp -Rp src/dist/* $FLATPAK_DEST/includes
      # and also the Python files
      - cp -Rp src/{artisan.py,artisanlib,plus,proto,help,uic,misc} $FLATPAK_DEST
      - chmod a+x $FLATPAK_DEST/artisan.py
      # disable monkey patch for MacOS that breaks loading snap7
      - sed -i 's/\(importlib_metadata\.version = md_version\)/#\1/' $FLATPAK_DEST/artisanlib/main.py
      # then compile all Python files
      - python3 -m compileall $FLATPAK_DEST/{artisanlib,plus,proto,help,uic,misc}
      # desktop integration
      - ln -s /app/artisan.py /app/bin/artisan
      - mkdir -p /app/share/applications && cp src/debian/usr/share/applications/artisan.desktop /app/share/applications/$FLATPAK_ID.desktop
      - sed -i "s/^Icon=.*$/Icon=$FLATPAK_ID/" /app/share/applications/$FLATPAK_ID.desktop
    sources:
      - type: archive
        dest-filename: artisan.tar.gz
        url: https://api.github.com/repos/artisan-roaster-scope/artisan/tarball/v2.10.4
        sha256: 34fb8957fba570f6cdd036c3bec84057c86828a723abfaf74373e011f80b6815
        x-checker-data:
          type: json
          url: https://api.github.com/repos/artisan-roaster-scope/artisan/releases/latest
          version-query: .tag_name | sub("^v"; "")
          url-query: .tarball_url

  # get appstream and icon from upstream, will be part of tarball in next release
  - name: desktop
    buildsystem: simple
    build-commands:
      # translations are Flatpak-specific
      - sed -i 's/^\(\s*\)\(<\/branding>\s*$\)/\1\2\n\n\1<translation type="qt">..\/includes\/translations\/artisan<\/translation>/' org.artisan_scope.artisan.metainfo.xml
      - install -Dm644 org.artisan_scope.artisan.metainfo.xml $FLATPAK_DEST/share/metainfo/$FLATPAK_ID.metainfo.xml
      - install -Dm644 artisan.svg $FLATPAK_DEST/share/icons/hicolor/scalable/apps/$FLATPAK_ID.svg
    sources:
      - type: file
        url: https://github.com/artisan-roaster-scope/artisan/raw/91a7c95d8e1e4cc97e662da8f4c811c6a97c673b/src/debian/usr/share/metainfo/org.artisan_scope.artisan.metainfo.xml
        sha256: 3105e00b13c612e57acaa6cc7a8b23527ed2d7843c16b697e4828653baaeaa97
      - type: file
        url: https://github.com/artisan-roaster-scope/artisan/raw/6dcd2b3eb8a2a3f542770e4b5cb3e3f5dd136b05/src/artisan.svg
        sha256: 807fe16685f98c725a8c7fbde70416fd464150b1f0dd83fe59e8982dbbc7db82

