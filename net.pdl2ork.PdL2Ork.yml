id: net.pdl2ork.PdL2Ork
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
default-branch: stable
command: pd-wrapper.sh
finish-args:
# Display
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri
# Audio
  - --socket=pulseaudio
  - --system-talk-name=org.freedesktop.RealtimeKit1
  - --filesystem=xdg-run/pipewire-0
# Filesystem access (pd doesn't yet work with portals)
  - --filesystem=host
# MIDI access (Flatpak doesn't yet support exposing only MIDI devices)
  - --device=all
# Linux Audio plugins
  - --env=LADSPA_PATH=/app/extensions/Plugins/ladspa:/app/lib/ladspa
add-extensions:
  org.freedesktop.LinuxAudio.Plugins:
    directory: extensions/Plugins
    version: '22.08'
    add-ld-path: lib
    merge-dirs: ladspa
    subdirectories: true
    no-autodownload: true

cleanup:
  - /include/*
  - /lib/pd-l2ork/Makefile.am
  - /lib/pd-l2ork/README.txt
  - /lib/pd-l2ork/bin/todo.txt
  - /lib/pd-l2ork/bin/nw/credits.html

modules:
- name: pd-l2ork
  buildsystem: autotools
  subdir: pd/src
  config-opts: [ '--disable-portaudio', '--enable-alsa', '--disable-oss', '--enable-jack' ]
  sources:
  - type: git
    url: https://github.com/pd-l2ork/pd-l2ork/
    tag: '20231012'
    commit: 27b66ed5efd4de7cb0fd7ad33cf46c60cb8201fc
  #- type: patch
  #  path: patch/build-api.patch
  - type: patch
    path: patch/no-rsync-during-install.patch

# For Gem library
- shared/glu-9.json
# For fluid~ object
- shared-modules/linux-audio/fluidsynth2.json
# For LADSPA support
- shared-modules/linux-audio/ladspa.json
# For pdlua
- shared-modules/lua5.3/lua-5.3.5.json
# For the OSCx library
- name: libtirpc
  config-opts:
    - --disable-gssapi
  sources:
    - type: archive
      url: https://downloads.sourceforge.net/sourceforge/libtirpc/libtirpc-1.3.1.tar.bz2
      sha256: 245895caf066bec5e3d4375942c8cb4366adad184c29c618d97f724ea309ee17
# For bsaylor
- shared-modules/linux-audio/fftw3f.json

- name: pd-externals
  buildsystem: simple
  subdir: externals
  build-commands:
  # run Gem configure, so that iemgui can build, since it depends on it
  # currently disabled, since we build gem below before iemgui
  #- |
  #  make -j ${FLATPAK_BUILDER_N_JOBS} prefix=/app \
  #       gem_configure

  # original, local testing build uses simply
  #make ...
  # for flathub, consider replacing make with this commented out version
  # this needs to be tested. if it proves to work, we will be able to build
  # with multiple cores in parallel.
  #make -j ${FLATPAK_BUILDER_N_JOBS} ...

  - |
    make -j ${FLATPAK_BUILDER_N_JOBS} prefix=/app \
         adaptive arraysize autotune bassemu boids comport creb cxc cyclone \
         disis_flatpak earplug ekext ext13 fftease flatgui freeverb gem ggee hcs \
         iem_ambi iem_bin_ambi iemlib iemguts iem_adaptfilt iemmatrix iemxmlrpc iem_delay \
         iem_roomsim iem_spec2 iem_tab jasch_lib loaders-libdir lyonpotpourri mapping \
         markex maxlib mjlib moonlib motex mrpeach pan pdcontainer pddp pdogg plugin pmpd \
         rjlib sigpack smlib tof unauthorized vbap windowing zexy
  # now onto more temperamental externals
  - |
    export BSAYLOR_FLATPAK_LDFLAGS=-L/app/lib && \
         make -j ${FLATPAK_BUILDER_N_JOBS} prefix=/app \
         bsaylor
  - |
    make -j ${FLATPAK_BUILDER_N_JOBS} prefix=/app LDFLAGS=-L/app/lib \
         fluid
  - |
    export IEMGUI_FLATPAK_LINKER_FLAGS="-Wl,--export-dynamic -shared" && \
         make -j ${FLATPAK_BUILDER_N_JOBS} prefix=/app LDFLAGS=-L/app/lib \
         iemgui
  - |
    export MOOCOW_FLATPAK_CONFIGURE="--host=$(uname -m)-pc-linux-gnu" && \
         make -j ${FLATPAK_BUILDER_N_JOBS} prefix=/app \
         moocow
  - |
    export OSCX_FLATPAK_CONFIGURE_FLAGS="--host=$(uname -m)-pc-linux-gnu" && \
         export OSCX_FLATPAK_LIBS="-ltirpc" && \
         export OSCX_FLATPAK_LDFLAGS="-L/app/lib" && \
         export OSCX_FLATPAK_INCLUDES="-I/app/include/tirpc" && \
         make -j ${FLATPAK_BUILDER_N_JOBS} prefix=/app \
         oscx
  - |
    make -j ${FLATPAK_BUILDER_N_JOBS} prefix=/app LUA_LIBS="-L/app/lib -llua" \
         pdlua
  # now let's install them
  - |
    make -j ${FLATPAK_BUILDER_N_JOBS} DESTDIR=/ prefix=/app \
         adaptive_install arraysize_install autotune_install bassemu_install \
         boids_install bsaylor_install \
         comport_install creb_install cxc_install cyclone_install \
         disis_install earplug_install ekext_install ext13_install fftease_install \
         flatgui_install fluid_install freeverb_install gem_install ggee_install \
         hcs_install iem_ambi_install iem_bin_ambi_install iemlib_install \
         iemguts_install iem_adaptfilt_install iemmatrix_install iemxmlrpc_install \
         iem_delay_install iem_roomsim_install iem_spec2_install iem_tab_install \
         iemgui_install jasch_lib_install loaders-libdir_install lyonpotpourri_install \
         mapping_install markex_install maxlib_install mjlib_install \
         moocow_install moonlib_install motex_install mrpeach_install oscx_install \
         pan_install pdcontainer_install pddp_install pdlua_install pdogg_install \
         plugin_install pmpd_install rjlib_install sigpack_install smlib_install \
         tof_install unauthorized_install vbap_install windowing_install zexy_install

  sources:
  - type: git
    url: https://github.com/pd-l2ork/pd-l2ork/
    tag: '20231012'
    commit: 27b66ed5efd4de7cb0fd7ad33cf46c60cb8201fc

- name: pd-abstractions
  buildsystem: simple
  subdir: abstractions
  build-commands:
  - make -j ${FLATPAK_BUILDER_N_JOBS} DESTDIR=/ prefix=/app install
  sources:
  - type: git
    url: https://github.com/pd-l2ork/pd-l2ork/
    tag: '20231012'
    commit: 27b66ed5efd4de7cb0fd7ad33cf46c60cb8201fc

- name: pd-l2ork-integration
  buildsystem: simple
  build-commands:
  # These commands run in the 'subdir' that we set, but the sources appear at
  # the top level hence the `../..` everywhere.
  - mkdir -p /app/lib/pd-l2ork/bin/nw
  - tar -x -f nwjs.tar.gz -C /app/lib/pd-l2ork/bin/nw --strip-components=1
  # wrapper script
  - install -m 755 pd-wrapper.sh /app/bin
  # .desktop file (so we appear in list of applications)
  - install -d /app/share/applications/
  - install -m 644 net.pdl2ork.PdL2Ork.desktop /app/share/applications/
  # AppStream metadata (for app store / package manager)
  - install -d /app/share/metainfo/
  - install -m 644 net.pdl2ork.PdL2Ork.metainfo.xml /app/share/metainfo
  # icon (for everyone)
  - install -d /app/share/icons/hicolor/scalable/apps
  - install -m 644 net.pdl2ork.PdL2Ork.svg /app/share/icons/hicolor/scalable/apps/
  # add mime type to .pd files
  - install -d /app/share/mime/packages/
  - install -m 644 packages/linux_make/pd-l2ork.xml /app/share/mime/packages/net.pdl2ork.PdL2Ork.xml
  sources:
  - type: git
    url: https://github.com/pd-l2ork/pd-l2ork/
    tag: '20231012'
    commit: 27b66ed5efd4de7cb0fd7ad33cf46c60cb8201fc
  - type: file
    # x86_64 for now only. Still waiting for aarch64.
    url: https://dl.nwjs.io/v0.67.1/nwjs-v0.67.1-linux-x64.tar.gz
    sha256: 98a24a98ca7252ad9d0b56a9fc9518e76f128b436b1555355b808907f7b66bd4
    dest-filename: nwjs.tar.gz
  - type: file
    path: ./pd-wrapper.sh
  - type: file
    path: net.pdl2ork.PdL2Ork.desktop
  - type: file
    path: net.pdl2ork.PdL2Ork.metainfo.xml
  - type: file
    path: net.pdl2ork.PdL2Ork.svg
  - type: file
    path: default.settings
