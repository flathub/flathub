app-id: org.nongnu.enigma
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
appstream-compose: false
command: enigma

finish-args:
  - --filesystem=~/.enigma:create
  # X11 access
  - --share=ipc
  - --socket=x11
  # Needs to talk to pulseaudio
  - --socket=pulseaudio
  # OpenGL redering
  - --device=dri

modules:
  - name: texi2html
    sources:
      - type: archive
        url: https://download.savannah.gnu.org/releases/texi2html/texi2html-5.0.tar.gz
        sha256: e60edd2a9b8399ca615c6e81e06fa61946ba2f2406c76cd63eb829c91d3a3d7d

  - name: graphviz
    sources:
      - type: archive
        url: https://gitlab.com/api/v4/projects/4207231/packages/generic/graphviz-releases/2.49.0/graphviz-2.49.0.tar.gz
        sha256: 17ade6189beade7c0784090f283c1f78f6b286ec38e3d2e927d3e42d625d0e8d

  - name: Xerxes-C
    buildsystem: cmake
    sources:
      - type: archive
        url: https://dlcdn.apache.org//xerces/c/3/sources/xerces-c-3.2.3.tar.gz
        sha256: fb96fc49b1fb892d1e64e53a6ada8accf6f0e6d30ce0937956ec68d39bd72c7e

  - name: imagemagick
    config-opts:
      - --enable-shared
      - --disable-static
      - --with-modules
      - --with-x
      - --with-threads
      - --with-magick_plus_plus
      - --with-gslib
      - --with-wmf
      - --with-webp
      - --with-openexr
      - --with-rsvg
      - --with-xml
      - --with-jbig
      - --with-openjp2
    sources:
      - type: git
        url: https://github.com/ImageMagick/ImageMagick.git
        tag: "7.1.0-5"
        commit: 74f8154136d2f631ca3e0421e6cf6c8dccd548f7

  - name: Enigma-Game
    no-autogen: false
    sources:
      - type: git
        url: https://github.com/MrTarantoga/Enigma.git
        commit: 4f735f5e204e19fa6175c15482db46b2c92ea3c0
    post-install:
      - install -d /app/extra/export/share/applications
      - install -d /app/extra/export/share/icons/hicolor/48x48/apps
      - mv /app/share/applications/enigma.desktop /app/share/applications/org.nongnu.enigma.desktop
      - mv /app/share/icons/hicolor/48x48/apps/enigma.png /app/share/icons/hicolor/48x48/apps/org.nongnu.enigma.png
      - sed -i 's/Icon=enigma/Icon=org.nongnu.enigma.png/g' /app/share/applications/org.nongnu.enigma.desktop

  - name: AppStream.xml
    buildsystem: simple
    build-commands:
      - echo Plot flatpak id ${FLATPAK_ID}
      - install -Dm644 --target-directory=${FLATPAK_DEST}/share/metainfo ${FLATPAK_ID}.metainfo.xml
      - appstream-compose --basename=${FLATPAK_ID} --prefix=${FLATPAK_DEST} --origin=flatpak ${FLATPAK_ID} 
    sources:
      - type: file
        path: org.nongnu.enigma.metainfo.xml

cleanup:
  - '/include'
  - '/share/doc/xerces-c'
  - '/share/doc/ImageMagick-7'
  - '/share/gaphviz/pdf'
  - '/usr/include'
  - '/lib/debug'
  - '*.a'
