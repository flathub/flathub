app-id: org.nongnu.enigma
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
command: enigma
rename-appdata-file: enigma.appdata.xml
rename-desktop-file: enigma.desktop
finish-args:
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri

modules:
  - name: SDL2
    rm-configure: true
    config-opts:
      - --disable-static
    buildsystem: autotools
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share
    sources:
      - type: git
        url: https://github.com/libsdl-org/SDL
        tag: release-2.0.20
    modules:
      - name: libdecor
        config-opts:
          - -Ddemo=false
        buildsystem: meson
        cleanup:
          - /include
          - /lib/pkgconfig
        sources:
          - type: git
            url: https://gitlab.gnome.org/jadahl/libdecor/
            commit: a5e1d87dc80d8a71076f64d0fc33f38cc0fc205a

  - name: SDL_ttf
    buildsystem: autotools
    rm-configure: true
    config-opts:
      - --disable-static
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share
    sources:
      - type: git
        url: https://github.com/libsdl-org/SDL_ttf
        tag: release-2.0.18

  - name: SDL2_mixer
    buildsystem: autotools
    rm-configure: true
    config-opts:
      - --disable-static
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share
    sources:
      - type: git
        url: https://github.com/libsdl-org/SDL_mixer
        tag: release-2.0.4

  - name: libpng
    sources:
      - type: git
        url: https://github.com/glennrp/libpng
        tag: v1.6.35

  - name: imagemagick
    sources:
      - type: git
        url: https://github.com/ImageMagick/ImageMagick
        tag: "7.1.0-19"

  - name: SDL_image
    rm-configure: true
    config-opts:
      - --disable-static
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share
    sources:
      - type: git
        url: https://github.com/libsdl-org/SDL_image
        tag: release-2.0.5
      - type: script
        dest-filename: autogen.sh
        commands:
          - "AUTOMAKE=\"automake --foreign\" autoreconf -vfi"

  - name: Xerces-C
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://github.com/apache/xerces-c
        tag: v3.2.3

  - name: zlib
    sources:
      - type: git
        url: https://github.com/madler/zlib
        tag: v1.2.11

  - name: texi2html
    sources:
      - type: archive
        url: https://download.savannah.gnu.org/releases/texi2html/texi2html-5.0.tar.gz
        sha256: e60edd2a9b8399ca615c6e81e06fa61946ba2f2406c76cd63eb829c91d3a3d7d
        x-checker-data:
          type: anitya
          project-id: 4957
          stable-only: true
          url-template: https://download.savannah.gnu.org/releases/texi2html/texi2html-$version.tar.gz

  - name: enigma
    buildsystem: autotools
    post-install:
      - sed -i -e "s/Icon=enigma/Icon=${FLATPAK_ID}/g" -e "s/Version=1.30/Version=1.3/g" -e "s/Categories=Application;Game;PuzzleGame;/Categories=Game;LogicGame;/g" ${FLATPAK_DEST}/share/applications/enigma.desktop
      - mv ${FLATPAK_DEST}/share/icons/hicolor/48x48/apps/enigma.png ${FLATPAK_DEST}/share/icons/hicolor/48x48/apps/${FLATPAK_ID}.png
    sources:
      - type: git
        url: https://github.com/Enigma-Game/Enigma
        tag: "1.30"
      - type: patch
        path: invalid_pointer_access.patch