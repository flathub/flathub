# https://docs.flatpak.org/en/latest/flatpak-builder-command-reference.html#flatpak-manifest
app-id: io.github.sil_car.SqueezeVid
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: squeeze-vid

finish-args:
  # - --env=PYTHONPATH=$PYTHONPATH:/app/lib/python3.10/site-packages/squeeze_vid
  - --filesystem=home

modules:
  - name: libaom
    sources:
      # https://aomedia.googlesource.com/aom/+/refs/tags/v3.3.0
      - type: git
        url: https://aomedia.googlesource.com/aom
        tag: v3.3.0
        commit: 87460cef80fb03def7d97df1b47bad5432e5e2e4
    buildsystem: cmake
    config-opts:
      - -DCONFIG_AV1_ENCODER=0

  # - name: libass
  #   sources:
  #     - type: archive
  #       url: https://github.com/libass/libass/releases/download/0.17.1/libass-0.17.1.tar.xz
  #       sha256: f0da0bbfba476c16ae3e1cfd862256d30915911f7abaa1b16ce62ee653192784
  #   buildsystem: autotools
  #   config-opts:
  #     - --disable-static

  - name: libsvtav1
    # Ref: https://gitlab.com/AOMediaCodec/SVT-AV1/-/blob/master/Docs/Build-Guide.md#1-build-and-install-svt-av1
    sources:
      - type: git
        url: https://gitlab.com/AOMediaCodec/SVT-AV1.git
        tag: v1.4.1
        commit: 018276d714ce65d9b586f6205ee016cbd8d5425d
    # source-depth: 1 "shallow clone" is used by default
    buildsystem: cmake
    config-opts:
      # - -G"Unix Makefiles"
      - -DCMAKE_BUILD_TYPE=Release
      # - -DCMAKE_INSTALL_PREFIX=/usr

  # - name: libvpx
  #   # https://github.com/webmproject/libvpx
  #   source:
  #     - type: git
  #       url: https://chromium.googlesource.com/webm/libvpx.git
  #       tag: v1.11.0
  #       commit: 626ff35955c2c35b806b3e0ecf551a1a8611cdbf
  #   buildsystem: simple # ?: not sure what else to use with basic "make"
  #   build-commands:
  #     - mkdir build
  #     - cd build
  #     - ../libvpx/configure
  #     - make

  - name: ffmpeg
    # Other prereqs?:
    #   - libsdl1.2: https://github.com/flathub/shared-modules/tree/master/SDL
    sources:
      # - type: git
        # url: https://git.videolan.org/git/ffmpeg.git
        # branch: release/6.0
        # tag: n6.0
        # commit: ea3d24bbe3c58b171e55fe2151fc7ffaca3ab3d2
      - type: archive
        url: http://ffmpeg.org/releases/ffmpeg-6.0.tar.xz
        sha256: 57be87c22d9b49c112b6d24bc67d42508660e6b718b3db89c44e47e289137082
    buildsystem: autotools
    config-opts:
      # - --prefix=/usr
      - --disable-doc # removes all docs --disable-{htmlpages,manpages,txtpages}
      - --disable-ffplay
      - --enable-version3
      - --enable-gpl
      - --enable-libaom         # AV1 video encoder
      - --enable-libass         # subtitles support
      - --enable-libsvtav1      # SVT-AV1 video encoder; requires 22.04+ packages libsvtav1{,-dev}; or build from src
      - --enable-libvpx         # VP9 video encoder
      - --enable-libx264        # H.264 video encoder

  - python3-requirements.yaml

  - name: squeeze-vid
    sources:
      - type: git
        url: https://github.com/sil-car/squeeze-vid.git
        # branch: main
        tag: v0.1
        commit: 1bc9d1f61dea88d3682c16d375f82c1d2a5e3ca4
    buildsystem: simple
    build-commands:
      # Ref: https://github.com/pypa/pip/issues/7730 (use --no-build-isolation to access host setuptools)
      - pip3 install --prefix="${FLATPAK_DEST}" .
