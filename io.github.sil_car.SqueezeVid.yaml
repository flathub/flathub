# https://docs.flatpak.org/en/latest/flatpak-builder-command-reference.html#flatpak-manifest
app-id: io.github.sil_car.SqueezeVid
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: squeeze-vid

finish-args:
  # - --env=PYTHONPATH=$PYTHONPATH:/app/lib/python3.10/site-packages/squeeze_vid
  - --filesystem=home

modules:
  - name: libsvtav1
    # Ref: https://gitlab.com/AOMediaCodec/SVT-AV1/-/blob/master/Docs/Build-Guide.md#1-build-and-install-svt-av1
    sources:
      - type: git
        url: https://gitlab.com/AOMediaCodec/SVT-AV1.git
        tag: v1.4.1
    # source-depth: 1 "shallow clone" is used by default
    buildsystem: cmake
    config-opts:
      # - -G"Unix Makefiles"
      - -DCMAKE_BUILD_TYPE=Release
      # - -DCMAKE_INSTALL_PREFIX=/usr

  - name: ffmpeg
    sources:
      - type: git
        url: https://git.videolan.org/git/ffmpeg.git
        # branch: release/6.0
        tag: n6.0
        commit: ea3d24bbe3c58b171e55fe2151fc7ffaca3ab3d2
    buildsystem: autotools
    config-opts:
      # - --prefix=/usr
      - --disable-doc # removes all docs --disable-{htmlpages,manpages,txtpages}
      - --disable-ffplay
      - --enable-version3
      - --enable-gpl
      - --enable-libass         # subtitles support
      - --enable-libaom         # AV1 video encoder
      - --enable-libsvtav1      # SVT-AV1 video encoder; requires 22.04+ packages libsvtav1{,-dev}; or build from src
      - --enable-libvpx         # VP9 video encoder
      - --enable-libx264        # H.264 video encoder

  - python3-ffmpeg-python.yaml

  - name: squeeze-vid
    sources:
      - type: git
        url: https://github.com/sil-car/squeeze-vid.git
        # branch: main
        tag: v0.1
        commit: 1bc9d1f61dea88d3682c16d375f82c1d2a5e3ca4
    buildsystem: simple
    build-commands:
      # Ref: https://github.com/pypa/pip/issues/7730 (use --no-build-isolation to access setuptools)
      - pip3 install --no-build-isolation --prefix="${FLATPAK_DEST}" .
