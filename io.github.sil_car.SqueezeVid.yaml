# https://docs.flatpak.org/en/latest/flatpak-builder-command-reference.html#flatpak-manifest
app-id: io.github.sil_car.SqueezeVid
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: squeeze-vid

finish-args:
  - --filesystem=home

modules:
  - name: libaom
    sources:
      # https://aomedia.googlesource.com/aom/+/refs/tags/v3.3.0
      - type: git
        url: https://aomedia.googlesource.com/aom.git
        tag: v3.3.0
        commit: 87460cef80fb03def7d97df1b47bad5432e5e2e4
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      # https://aomedia.googlesource.com/aom/+/refs/tags/v3.4.0/build/cmake/aom_config_defaults.cmake
      - -DCONFIG_SHARED=1
      # - -DBUILD_SHARED_LIBS=1
    #   - -DCONFIG_AV1_ENCODER=0

  - name: libass
    sources:
      - type: archive
        url: https://github.com/libass/libass/releases/download/0.17.1/libass-0.17.1.tar.xz
        sha256: f0da0bbfba476c16ae3e1cfd862256d30915911f7abaa1b16ce62ee653192784
    buildsystem: autotools
    config-opts:
      # - --disable-static
      - --disable-bins
      - --disable-doc
      - --enable-shared

  - name: libsvtav1
    # Ref: https://gitlab.com/AOMediaCodec/SVT-AV1/-/blob/master/Docs/Build-Guide.md#1-build-and-install-svt-av1
    sources:
      - type: git
        url: https://gitlab.com/AOMediaCodec/SVT-AV1.git
        tag: v1.4.1
        commit: 018276d714ce65d9b586f6205ee016cbd8d5425d
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      # - -G"Unix Makefiles"
      - -DCMAKE_BUILD_TYPE=Release
      # - -DCMAKE_INSTALL_PREFIX=/usr

  - name: libvpx
    # https://github.com/webmproject/libvpx
    sources:
      - type: git
        url: https://chromium.googlesource.com/webm/libvpx.git
        tag: v1.11.0
        commit: 626ff35955c2c35b806b3e0ecf551a1a8611cdbf
    buildsystem: autotools
    builddir: true
    config-opts:
      # https://github.com/webmproject/libvpx/blob/main/configure
      - --disable-docs
      - --disable-examples
      - --disable-unit-tests
      - --enable-libs
      - --enable-multithread

  - name: libx264
    sources:
      - type: git
        url: https://code.videolan.org/videolan/x264.git
        branch: stable
        commit: baee400fa9ced6f5481a728138fed6e867b0ff7f
    buildsystem: autotools
    config-opts:
      # https://code.videolan.org/videolan/x264/-/blob/master/configure
      - --disable-cli
      - --enable-shared

  - name: ffmpeg
    # Other prereqs?:
    #   - libsdl1.2: https://github.com/flathub/shared-modules/tree/master/SDL
    sources:
      - type: git
        url: https://git.videolan.org/git/ffmpeg.git
        # branch: release/6.0
        tag: n6.0
        commit: ea3d24bbe3c58b171e55fe2151fc7ffaca3ab3d2
      # - type: archive
      #   url: http://ffmpeg.org/releases/ffmpeg-6.0.tar.xz
      #   sha256: 57be87c22d9b49c112b6d24bc67d42508660e6b718b3db89c44e47e289137082
    buildsystem: autotools
    config-opts:
      # - --prefix=/usr
      - --disable-doc # removes all docs --disable-{htmlpages,manpages,txtpages}
      - --disable-ffplay
      - --enable-version3
      - --enable-gpl
      - --enable-libaom         # AV1 video encoder
      - --enable-libass         # subtitles support
      - --enable-libsvtav1      # SVT-AV1 video encoder; requires 22.04+ packages libsvtav1{,-dev}; or build from src
      - --enable-libvpx         # VP9 video encoder
      - --enable-libx264        # H.264 video encoder

  - python3-requirements.yaml

  - name: squeeze-vid
    sources:
      - type: git
        url: https://github.com/sil-car/squeeze-vid.git
        # branch: main
        tag: v0.1.1
        commit: 172a16caa380e5f1ebfe612b66a1814b25ea928b
    buildsystem: simple
    build-commands:
      # Ref: https://github.com/pypa/pip/issues/7730 (use --no-build-isolation to access host setuptools)
      - pip3 install --no-build-isolation --prefix="${FLATPAK_DEST}" .
      # Install metainfo file.
      - mkdir -p ${FLATPAK_DEST}/share/metainfo
      - cp pkg-data/io.github.sil_car.SqueezeVid.metainfo.xml ${FLATPAK_DEST}/share/metainfo
