app-id: io.github.shadowmario.fnf-psychengine
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: io.github.shadowmario.fnf-psychengine.sh

finish-args:
  # gamepad support
  - --device=all
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Audio
  - --socket=pulseaudio

modules:
  - name: fnf-psychengine
    modules:
      - name: gamemode
        buildsystem: meson
        config-opts:
          - -Dwith-sd-bus-provider=no-daemon
          - -Dwith-examples=false
        sources:
          - type: git
            url: https://github.com/FeralInteractive/gamemode
            tag: "1.8.1"
            x-checker-data:
              type: git
              tag-pattern: ^([\\d.]+)$


    sources:
      - type: archive
        url: https://github.com/HaxeFoundation/neko/releases/download/v2-3-0/neko-2.3.0-linux64.tar.gz
        sha256: 26dda28d0a51407f26218ba9c2c355c8eb23cf2b0b617274b00e4b9170fe69eb
        dest: haxe/
        x-checker-data:
          type: anitya
          project-id: 10885
          url-template: https://github.com/HaxeFoundation/neko/releases/download/v$version/neko-$version-linux64.tar.gz
      - type: archive
        url: https://github.com/HaxeFoundation/haxe/releases/download/4.3.3/haxe-4.3.3-linux64.tar.gz
        sha256: ee7dbdad1dbceb0f36a2453cfe36a1310a1b7df4f134f6a8d5d77951edaa18c8
        dest: haxe/
        x-checker-data:
          type: anitya
          project-id: 7883
          url-template: https://github.com/HaxeFoundation/haxe/releases/download/$version/haxe-$version-linux64.tar.gz

      # Haxe library dependencies
      - type: file
        url: https://github.com/openfl/lime/releases/download/8.1.1/lime-haxelib.zip
        sha256: c6736433697f8be37a0d9940ac8d1b448ec6f86daa1a82852787a10d37e07ed7
        dest: psychengine-deps/
        dest-filename: lime-8.1.1.zip
        x-checker-data:
          type: json
          url: https://api.github.com/repos/openfl/lime/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name==\"lime-haxelib.zip\") | .browser_download_url
      - type: file
        url: https://github.com/openfl/openfl/releases/download/9.3.2/openfl-haxelib.zip
        sha256: 9e8cbc475c0cc68075ef4b9a37577c7cb3ae1eab4e594645c7d31908d4a0cbd9
        dest: psychengine-deps/
        dest-filename: openfl-9.3.2.zip
        x-checker-data:
          type: json
          url: https://api.github.com/repos/openfl/openfl/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name==\"openfl-haxelib.zip\") | .browser_download_url
      - type: file
        url: https://github.com/HaxeFlixel/flixel/archive/refs/tags/5.6.2.zip
        sha256: 80581ce6a936c7a42f473d2b8c2c6bb021cab13ba2aeda28ec9f2aab8003eee7
        dest: psychengine-deps/
        dest-filename: flixel-5.6.2.zip
        x-checker-data:
          type: json
          url: https://api.github.com/repos/HaxeFlixel/flixel/tags
          version-query: .[0].name
          url-query: .[0].zipball_url
      - type: file
        url: https://github.com/HaxeFlixel/flixel-addons/archive/refs/tags/3.2.1.zip
        sha256: 6d660d6c5126c20e8e7ff2973d03fef567b09166cf82f2673314df8daa28bd72
        dest: psychengine-deps/
        dest-filename: flixel-addons-3.2.1.zip
        x-checker-data:
          type: json
          url: https://api.github.com/repos/HaxeFlixel/flixel-addons/tags
          version-query: .[0].name
          url-query: .[0].zipball_url
      - type: file
        url: https://github.com/HaxeFlixel/flixel-tools/archive/refs/tags/1.5.1.zip
        sha256: 82254fd98a7c449473e5432303478d20825114832478b97af528ffa953b87fc9
        dest: psychengine-deps/
        dest-filename: flixel-tools-1.5.1.zip
        x-checker-data:
          type: json
          url: https://api.github.com/repos/HaxeFlixel/flixel-tools/tags
          version-query: .[0].name
          url-query: .[0].zipball_url
      - type: file
        url: https://github.com/HaxeFlixel/flixel-ui/archive/refs/tags/2.5.0.zip
        sha256: 1fc2bf4c2eef3560c01bea1d91d21b76f11abeb064c9a6725a254dc1df5911de
        dest: psychengine-deps/
        dest-filename: flixel-ui-2.5.0.zip
        x-checker-data:
          type: json
          url: https://api.github.com/repos/HaxeFlixel/flixel-ui/tags
          version-query: .[0].name
          url-query: .[0].zipball_url
      - type: file
        url: https://github.com/HaxeFoundation/hxcpp/releases/download/v4.3.21/hxcpp-4.3.21.zip
        sha256: 0ba282f6807067055d5c80a74263d7784b1c691a71c3f19f37b932883e466031
        dest: psychengine-deps/
        dest-filename: hxcpp-4.3.21.zip
        x-checker-data:
          type: json
          url: https://api.github.com/repos/HaxeFoundation/hxcpp/releases/latest
          version-query: .tag_name | sub(\"^v\"; \"\")
          url-query: .assets[] | select(.name==\"hxcpp-\" + $version + \".zip\") | .browser_download_url
      - type: file
        url: https://github.com/polybiusproxy/hxCodec/archive/59ce797f28d39dc96fa67ff589d87d16b17d03ef.zip
        sha256: c9b5b7fa07f89b5943a23a031d097cf1e6416d56ab2365fd9ab1405e3c7a6a08
        dest: psychengine-deps/
        dest-filename: hxCodec-3.0.2.zip
      - type: file
        url: https://github.com/ToprakKarabekiroglu/SuperlativeScript/archive/f42a8f1d715d0c6bc601cb41c59470ffe75e6ca2.zip
        sha256: 3707e8070458a29f4bd98ecb418d700e22833eda224a3c98d74bc1075d013c11
        dest: psychengine-deps/
        dest-filename: SScript-10.1.168.zip
      - type: file
        url: https://github.com/JWambaugh/TJSON/archive/e9f93b9cd98e5becd63d219371d5e395b176e6c1.zip
        sha256: 90ea73553b378ac2d64a387dd16ec3c8da1488134da1a613642fe0c46d059ce1
        dest: psychengine-deps/
        dest-filename: tjson-1.4.0.zip
      - type: file
        url: https://github.com/MAJigsaw77/hxdiscord_rpc/archive/c727f84b56a2fc200610a9119add988ee8cce8eb.zip
        sha256: 3a2c32358fb0ccd27458e2078971b57849e2b8217de7b16e70b21c2943b7097d
        dest: psychengine-deps/
        dest-filename: hxdiscord_rpc-3a2c3235.zip
      - type: git
        url: https://github.com/discord/discord-rpc
        commit: 963aa9f3e5ce81a4682c6ca3d136cddda614db33
        x-checker-data:
          type: git
          tag-pattern: ^v([\\d.]+)$
        dest: setup/hxdiscord_rpc/1,1,1/project/discord-rpc/
      - type: git
        url: https://github.com/Tencent/rapidjson
        commit: 6089180ecb704cb2b136777798fa1be303618975
        x-checker-data:
          type: git
          tag-pattern: ^v([\\d.]+)$
        dest: setup/hxdiscord_rpc/1,1,1/project/rapidjson/
      - type: file
        url: https://github.com/ShadowMario/flxanimate/archive/6d11b11f65f822a2a2ad01018fa8bcea0437bf5a.zip
        sha256: 7293d247b5a82abda2c4084922a5513c416d83f1b0857391f45848bbbcad3364
        dest: psychengine-deps/
        dest-filename: flxanimate-7293d247.zip
      - type: file
        url: https://github.com/superpowers04/linc_luajit/archive/633fcc051399afed6781dd60cbf30ed8c3fe2c5a.zip
        sha256: b1c49b0aa526541b4c5aadadc62f2790f43eab50ad4b5da97758e79d7c02c604
        dest: psychengine-deps/
        dest-filename: linc_luajit-b1c49b0a.zip

      # Main PsychEngine repo
      - type: git
        url: https://github.com/ShadowMario/FNF-PsychEngine.git
        # tag: "0.7.3"
        commit: d64912e57120e27dc41304deae48097b6c1355d1
        x-checker-data:
          type: git
          tag-pattern: ^([\\d.]+)$
      # temporary fix for broken build in the repo (https://github.com/ShadowMario/FNF-PsychEngine/pull/14170)
      - type: patch
        path: fnf-psychengine-fixbuild.patch
      # redirect crash logs, mods directory and list to XDG_DATA_HOME
      - type: patch
        path: fnf-psychengine-fix_user_data.patch
      # launcher script
      - type: script
        dest-filename: io.github.shadowmario.fnf-psychengine.sh
        commands:
          # Launch game
          - cd /app/bin`
          - ./PsychEngine
    builddir: true
    buildsystem: simple
    build-commands:
      # build
      - |
        export PATH=$PATH:$(pwd)/haxe
        haxelib setup ./setup
        for filename in psychengine-deps/*; do haxelib install $filename && rm $filename; done
        ./haxe/haxelib run lime build Project.xml linux
        mkdir -p /app/bin && cp -r export/release/linux/bin/* /app/bin/
      # Install launchers
      - |
        install -m755 io.github.shadowmario.fnf-psychengine.sh -t /app/bin/
        desktop-file-edit --set-key=Exec --set-value=io.github.shadowmario.fnf-psychengine.sh assets/meta/io.github.shadowmario.fnf-psychengine.desktop
        install -Dm 644 assets/meta/io.github.shadowmario.fnf-psychengine.desktop -t /app/share/applications
        install -Dm 644 assets/meta/io.github.shadowmario.fnf-psychengine.png -t /app/share/icons/hicolor/512x512/apps
        install -Dm 644 assets/meta/io.github.shadowmario.fnf-psychengine.metainfo.xml -t /app/share/metainfo
