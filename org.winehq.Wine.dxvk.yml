id: org.winehq.Wine.dxvk
build-extension: true
runtime: org.winehq.Wine
sdk: org.freedesktop.Sdk//19.08
sdk-extensions:
  - org.freedesktop.Sdk.Extension.mingw-w64
build-options:
  prefix: /app/dxvk
  prepend-path: /app/dxvk/bin
  append-path: /usr/lib/sdk/mingw-w64/bin
appstream-compose: false
cleanup:
  - "*.a"
  - "*.la"
  - /include
  - /lib/pkgconfig
  - /lib32/pkgconfig
  - /lib/cmake
  - /lib32/cmake
  - /share/man
modules:

  - name: dxvk
    buildsystem: meson
    build-options:
      config-opts:
        - --cross-file=../build-win64.txt
        - --cross-file=../dxvk-ccache-win64.txt
        - --libdir=lib
        - --bindir=lib
      env:
        SUFFIX: ""
    config-opts: &dxvk-config-opts
      - --buildtype=release
      - --strip
      - -Denable_tests=true
      - -Denable_dxgi=true
      - -Denable_d3d9=true
      - -Denable_d3d10=true
      - -Denable_d3d11=true
    post-install: &dxvk-post-install
      - |
        set -e
        for lib in dxgi d3d9 d3d10 d3d10core d3d10_1 d3d11; do
          winebuild --builtin ${FLATPAK_DEST}/lib${SUFFIX}/$lib.dll
        done
      - mkdir -p ${FLATPAK_DEST}/bin${SUFFIX}
      - mv -v ${FLATPAK_DEST}/lib${SUFFIX}/*.exe ${FLATPAK_DEST}/bin${SUFFIX}/
    sources: &dxvk-sources
      - type: archive
        url: "https://github.com/doitsujin/dxvk/archive/v1.7.1.tar.gz"
        sha256: 0904d816394b378e21da50a74e1d11f68eaeee1526deae5e54949248c54fafbc
      - type: file
        path: dxvk-ccache-win32.txt
      - type: file
        path: dxvk-ccache-win64.txt
    modules:

      - name: glslang
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -DBUILD_SHARED_LIBS=ON
          - -DCMAKE_SKIP_BUILD_RPATH=OFF
          - -DCMAKE_INSTALL_RPATH=$ORIGIN:$ORIGIN/../lib
          - -DENABLE_OPT=ON
        sources:
          - type: archive
            url: "https://github.com/KhronosGroup/glslang/archive/8.13.3559.tar.gz"
            sha256: c58fdcf7e00943ba10f9ae565b2725ec9d5be7dab7c8e82cac72fcaa83c652ca
        cleanup: [ "*" ]

  - name: dxvk-32bit
    buildsystem: meson
    build-options:
      config-opts:
        - --cross-file=../build-win32.txt
        - --cross-file=../dxvk-ccache-win32.txt
        - --libdir=lib32
        - --bindir=lib32
      env:
        SUFFIX: "32"
    config-opts: *dxvk-config-opts
    post-install: *dxvk-post-install
    sources: *dxvk-sources

  # Metadata

  - name: metadata
    buildsystem: simple
    build-commands:
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
      - appstream-compose --basename=${FLATPAK_ID} --prefix=${FLATPAK_DEST} --origin=flatpak ${FLATPAK_ID}
    sources:
      - type: file
        path: org.winehq.Wine.dxvk.metainfo.xml
