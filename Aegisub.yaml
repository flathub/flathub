name: Aegisub
config-opts:
  - --disable-update-checker
  - --with-openal
  - --with-libpulse
  - --with-ffms2
  - --with-fftw3
  - --with-hunspell
  - --with-player-audio=PulseAudio
  - --with-boost-libdir=/app/lib
build-options:
  cppflags: -DU_USING_ICU_NAMESPACE=1
  env:
    agi_cv_with_openal: yes
sources:
  - type: archive
    url: https://github.com/Aegisub/Aegisub/archive/v3.2.2.tar.gz
    sha256: 62757dd491455268a240f983b59734a801cc2e899039a7493deeaf5e24a61dcd
  # Remove version postfix
  - type: patch
    path: aegisub-version-postfix.patch
  # Add CFLAGS_PTHREAD/LIBS_PTHREAD to everything needing them
  # https://github.com/Aegisub/Aegisub/commit/ea43700531e3c9d45161d1fa5b30f0871066b011
  # https://github.com/Aegisub/Aegisub/commit/893b08a19c92353ba863ccb18d5d7671e39b602b
  # https://github.com/Aegisub/Aegisub/commit/b6c1bb146bfd8b15c02df40cc84ca2a8ad94d5ab
  - type: patch
    path: aegisub-makefile-pthread.patch
  # Fix compilation against icu 59
  # https://github.com/Aegisub/Aegisub/commit/dd67db47cb2203e7a14058e52549721f6ff16a49
  - type: patch
    path: aegisub-icu-unistr.patch
  # Fix compilation against icu 61
  # https://github.com/Aegisub/Aegisub/commit/d4461f65be5aa440506bd23e90e71aaf8f0ebada
  - type: patch
    path: aegisub-icu-prefix.patch
  # Keep using std::distance after Boost 1.68
  # https://github.com/Aegisub/Aegisub/commit/d8336d2fed73c72d1227b343d6acfb991bc1651b
  - type: patch
    path: aegisub-std-distance.patch
  # Use system luajit
  # Remove vendor luajit dependency
  # https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=892765
  # https://github.com/void-linux/void-packages/blob/63050c4ad3bf1caae352565e07b86e31402e0ee1/srcpkgs/Aegisub/patches/remove-vendor-luajit-dependency.patch
  # https://build.opensuse.org/package/view_file/multimedia:apps/aegisub/remove-vendor-luajit-dependency.patch
  # https://github.com/Aegisub/Aegisub/commit/0ed6dd46fbebdeed9f99ef250b6e2279e6fe17b8
  # https://github.com/Aegisub/Aegisub/commit/4c15d0ba8412055fe01e1ea626e674fa5d98bef1
  - type: patch
    path: aegisub-luajit-system.patch
  #- type: git
  #  url: https://github.com/Aegisub/Aegisub
  #  commit: 2cb92a5f74634764ff5aac7e3ad0d647f98142af
  # https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=873327#10
  # https://build.opensuse.org/package/view_file/multimedia:apps/aegisub/luabins.patch
  - type: patch
    path: aegisub-luabins.patch
  # Respect compiler flags
  # https://github.com/gentoo/gentoo/blob/be23ef21ed508c8e580f3ee8f302ce2abc5c3fbe/media-video/aegisub/files/3.2.2_p20160518/aegisub-3.2.2_p20160518-respect-compiler-flags.patch
  # https://web.archive.org/web/20161027172607/http://devel.aegisub.org/ticket/1899
  # https://web.archive.org/web/20161027171240/http://devel.aegisub.org/ticket/1900
  # https://github.com/Aegisub/Aegisub/pull/29
  - type: patch
    path: aegisub-respect-compiler-flags.patch
  # Fixes for Boost 1.69.0
  # https://github.com/Aegisub/Aegisub/issues/93
  # https://github.com/wangqr/Aegisub/commit/bb1f66a01f6e4661ab9c6610c5c2eee67bd0bd61
  - type: patch
    path: aegisub-boost-gil.patch
  - type: file
    path: org.aegisub.Aegisub.appdata.xml
  # Update AppData file
  # Change the OARS rating due to disabling the update checker
  - type: patch
    path: aegisub-flatpak-appdata.patch
  - type: shell
    commands:
      - cp -p /usr/share/automake-*/config.{sub,guess} .;
      - autoreconf -vfi;
post-install:
  - icon_in="packages/desktop/scalable.svg";
    icon_out="aegisub.png";
    for s in {16,22,24,32,48,64,72,96,128,192,256,512}; do
    rsvg-convert "${icon_in}" -w "${s}" -h "${s}" -a -f png -o "${icon_out}";
    [[ ! -f "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/${icon_out}" ]] || continue;
    install -p -D -m 0644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
    done;
  - install -p -D -m 0644 "org.aegisub.Aegisub.appdata.xml" -t "${FLATPAK_DEST}/share/appdata/";
  - install -p -D -m 0644 "LICENCE" -t "${FLATPAK_DEST}/share/licenses/aegisub/";
