name: Aegisub
config-opts:
  - --disable-update-checker
  - --with-openal
  - --with-libpulse
  - --with-ffms2
  - --with-fftw3
  - --with-hunspell
  - --with-player-audio=PulseAudio
build-options:
  cppflags: -DU_USING_ICU_NAMESPACE=1
  env:
    agi_cv_with_openal: yes
sources:
  - type: archive
    url: https://github.com/Aegisub/Aegisub/archive/v3.2.2.tar.gz
    sha256: 62757dd491455268a240f983b59734a801cc2e899039a7493deeaf5e24a61dcd
  - type: file
    path: org.aegisub.Aegisub.appdata.xml
  # Add CFLAGS_PTHREAD/LIBS_PTHREAD to everything needing them
  # https://github.com/Aegisub/Aegisub/commit/ea43700531e3c9d45161d1fa5b30f0871066b011
  # https://github.com/Aegisub/Aegisub/commit/893b08a19c92353ba863ccb18d5d7671e39b602b
  # https://github.com/Aegisub/Aegisub/commit/b6c1bb146bfd8b15c02df40cc84ca2a8ad94d5ab
  - type: patch
    path: aegisub-makefile-pthread.patch
  # Fix compilation against icu 59
  # https://github.com/Aegisub/Aegisub/commit/dd67db47cb2203e7a14058e52549721f6ff16a49
  - type: patch
    path: aegisub-icu-unistr.patch
  # Fix compilation against icu 61
  # https://github.com/Aegisub/Aegisub/commit/d4461f65be5aa440506bd23e90e71aaf8f0ebada
  - type: patch
    path: aegisub-icu-prefix.patch
  # Keep using std::distance after Boost 1.68
  # https://github.com/Aegisub/Aegisub/commit/d8336d2fed73c72d1227b343d6acfb991bc1651b
  - type: patch
    path: aegisub-std-distance.patch
  # Respect compiler flags
  # https://github.com/gentoo/gentoo/blob/be23ef21ed508c8e580f3ee8f302ce2abc5c3fbe/media-video/aegisub/files/3.2.2_p20160518/aegisub-3.2.2_p20160518-respect-compiler-flags.patch
  # https://web.archive.org/web/20161027172607/http://devel.aegisub.org/ticket/1899
  # https://web.archive.org/web/20161027171240/http://devel.aegisub.org/ticket/1900
  # https://github.com/Aegisub/Aegisub/pull/29
  - type: patch
    path: aegisub-respect-compiler-flags.patch
  # Remove version postfix
  - type: patch
    path: aegisub-version-postfix.patch
  # Update AppData file
  # Change the OARS rating due to disabling the update checker
  - type: patch
    path: aegisub-flatpak-appdata.patch
post-install:
  - icon_in="packages/desktop/scalable.svg";
    icon_out="aegisub.png";
    for s in {16,22,24,32,48,64,72,96,128,192,256,512}; do
    rsvg-convert "${icon_in}" -w "${s}" -h "${s}" -a -f png -o "${icon_out}";
    [[ ! -f "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/${icon_out}" ]] || continue;
    install -p -D -m 0644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
    done;
  - install -p -D -m 0644 "org.aegisub.Aegisub.appdata.xml" -t "${FLATPAK_DEST}/share/appdata/";
  - install -p -D -m 0644 "LICENCE" -t "${FLATPAK_DEST}/share/licenses/aegisub/";
