app-id: me.proton.Authenticator
runtime: org.gnome.Platform
sdk: org.gnome.Sdk
runtime-version: '49'
command: proton-authenticator
finish-args:
  - --share=ipc
  - --share=network
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --talk-name=org.freedesktop.secrets
  - --env=WEBKIT_DISABLE_DMABUF_RENDERER=1
modules:
  - name: proton-authenticator
    buildsystem: simple
    build-commands:
      - bsdtar -Oxf ProtonAuthenticator.deb data.tar.gz | bsdtar -xf -
      - install -Dm 755 "usr/bin/proton-authenticator" ${FLATPAK_DEST}/bin/proton-authenticator
      - install -Dm 644 me.proton.Authenticator.png /app/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - install -Dm644 "usr/share/applications/Proton Authenticator.desktop" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      - desktop-file-edit --set-key=Exec --set-value='proton-authenticator %U' --set-icon=${FLATPAK_ID} --remove-key=Comment
        "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      - install -Dm644 me.proton.Authenticator.metainfo.xml /app/share/metainfo/$FLATPAK_ID.metainfo.xml
    sources:
      - type: file
        dest-filename: ProtonAuthenticator.deb
        only-arches: [x86_64]
        url: https://proton.me/download/authenticator/linux/ProtonAuthenticator_1.1.4_amd64.deb
        # The upstream publishes sha512sum
        sha512: f442dbf6c798586316f0e49cdfec999787cee3a0e1b42d43a868405e4f1f33496eb9e20a15209ad31595b26ac795eb7808bc10c341658c89732727bef5ca55de
        x-checker-data:
          type: json
          # https://github.com/ProtonMail/WebClients/blob/c7909942b6af65fee99a5fca70acf0ba1029afe5/applications/authenticator/src/lib/tauri/update.ts#L21
          url: https://proton.me/download/authenticator/linux/version.json
          version-query: .Releases[0].Version
          url-query: .Releases[0].File[0].Url
          is-main-source: true

      - type: file
        path: me.proton.Authenticator.metainfo.xml
      
      - type: file
        url: https://raw.githubusercontent.com/ProtonMail/WebClients/c7909942b6af65fee99a5fca70acf0ba1029afe5/applications/authenticator/src-tauri/icons/icon.png
        sha256: 01d009f4b1b486d18d9159f8667e75d869745cbc190fcb085a76389436779646
        dest-filename: me.proton.Authenticator.png
