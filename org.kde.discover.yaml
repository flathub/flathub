id: org.kde.discover
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk
command: plasma-discover
base: io.qt.qtwebengine.BaseApp
base-version: '6.9'
finish-args:
    # access to system flatpaks, nothing works without it
    - --filesystem=/var/lib/flatpak
    # access to user flatpaks
    - --filesystem=xdg-data/flatpak
    # Install or upgrade of flatpaks doesn't work without it
    - --filesystem=/var/tmp
    # Needed for cleaning up remaining user data of flatpaks
    - --filesystem=~/.var/app
    # X11
    - --share=ipc
    # download applications from the internet
    - --share=network
    # show a window
    - --socket=fallback-x11
    - --socket=wayland
    # Removing and installing doesn't work without it
    - --system-talk-name=org.freedesktop.Flatpak.SystemHelper
    # fwupd integration
    - --system-talk-name=org.freedesktop.fwupd
    # needed for installing flatpaks
    - --talk-name=org.freedesktop.Flatpak

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - "*.pc"
  - "*.debug"
  - "*.a"
  - "*.la"
  # qtwebengine
  - /resources/*


cleanup-commands:
  # https://github.com/flathub/io.qt.qtwebengine.BaseApp?tab=readme-ov-file#cleanup
  - /app/cleanup-BaseApp.sh

modules:
  - name: discover
    config-opts:
      - -DBUILD_TESTING=OFF
      - -DWITH_KCM=OFF
      - -DWITH_NOTIFIER=OFF
    cleanup:
      - /etc/kr5.conf
      - /etc/xdg/autostart
      - /lib/krb5
      - /lib/plasma-discover/libDiscoverNotifiers.so
      - /lib/plugins/discover-notifier/FlatpakNotifier.so
      - /lib/plugins/discover/kns-backend.so # no idea if this will ever work, removing it for now
      - /share/applications/org.kde.discover.snap.desktop
      - /share/knotifications6/discoverabstractnotifier.notifyrc
      - /share/locale/*/LC_MESSAGES/kcm_updates.mo
      - /share/locale/*/LC_MESSAGES/plasma-discover-notifier.mo
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://download.kde.org/stable/plasma/6.4.5/discover-6.4.5.tar.xz
        sha256: 9208d4e37ad2ae4cd1da7cd3b01ede61071a13898ec4c14edffe983b972f8576
        x-checker-data:
          type: anitya
          project-id: 8761
          stable-only: true
          url-template: https://download.kde.org/stable/plasma/$version/discover-$version.tar.xz

    modules:
    - name: appstream
      config-opts:
        - -Dqt=true
        - -Dstemming=false
        - -Dcompose=false
        - -Ddocs=false
        - -Dman=false
        - -Dapidocs=false
        - -Dinstall-docs=false
      cleanup:
        - /share/metainfo
        - /bin/appstreamcli
        - /share/gir-1.0
        - /share/bash-completion
        - /share/installed-tests
        - /lib/girepository-1.0
        - /share/appstream/appstream.conf
        - /lib/cmake/AppStreamQt/*.cmake
      buildsystem: meson
      sources:
        - type: git
          url: https://github.com/ximion/appstream.git
          commit: d6ce0a8dbdf31a33762009a0e1f364e938470af2
          tag: "v1.1.1"
          x-checker-data:
            type: git
            tag-pattern: "^v([\\d.]+)$"

      # supports cmake now but I can't convinvce appstream to find it then
      modules:
      - name: libfyaml
        #buildsystem: cmake-ninja
        buildsystem: autotools
        make-install-args:
          - PREFIX=/app
        cleanup:
          - /bin/*
        sources:
          - type: git
            url: https://github.com/pantoniou/libfyaml
            commit: 8054c66e0454a09a810f756996d1b280738594e5
            tag: "v0.9"
        x-checker-data:
          type: git
          tag-pattern: "v^([\\d.]+)$"

    - name: fwupd
      buildsystem: meson
      config-opts:
        - -Dbuild=library
        - -Dfish_completion=false
        - -Dbash_completion=false
        - -Dman=false
        - -Dsystemd=disabled
        - -Dpassim=disabled
        - -Ddocs=disabled
        - -Dtests=false
        - -Dvendor_ids_dir=/app/share/hwdata
        - -Dvalgrind=disabled
        - -Dintrospection=disabled
      sources:
        - type: archive
          url: https://github.com/fwupd/fwupd/releases/download/2.0.16/fwupd-2.0.16.tar.xz
          sha256: 79cce6b61d9ea531de0ef3b13e7f2682c699901b11f410b2ed91192618e1620e
          x-checker-data:
            type: anitya
            project-id: 5833
            url-template: https://github.com/fwupd/fwupd/releases/download/$version/fwupd-$version.tar.xz

      modules:
      - jinja2.yaml

      - name: libjcat
        buildsystem: meson
        config-opts:
          - -Dintrospection=false
          - -Dgtkdoc=false
          - -Dtests=false
          - -Dcli=false
          - --sysconfdir=/app/etc
          - --localstatedir=/var/data
        sources:
          - type: archive
            url: https://github.com/hughsie/libjcat/releases/download/0.2.5/libjcat-0.2.5.tar.xz
            sha256: 066e402168c51bffddcf325190e5901402b266fbda2a4eed772fd06a88b941bf
            x-checker-data:
              type: anitya
              project-id: 229583
              url-template: https://github.com/hughsie/libjcat/releases/download/$version/libjcat-$version.tar.xz

    - name: flatpak
      buildsystem: meson
      config-opts:
        - -Dgtkdoc=disabled
        - -Ddocbook_docs=disabled
        - -Dtests=false
        - -Dman=disabled
        - -Dseccomp=disabled
        - -Dselinux_module=disabled
        - -Dmalcontent=disabled
        - -Dsandboxed_triggers=false
        - -Dsystem_helper=enabled # we need polkit for this, so we can install flatpaks from system remote
        - -Dhttp_backend=curl
        - -Dsystemd=disabled
        - -Dsystem_install_dir=/var/lib/flatpak
        - -Dsystem_bubblewrap=bwrap
        - -Dsystem_dbus_proxy=xdg-dbus-proxy
        - --sysconfdir=/var/run/host/etc
      cleanup:
        - /bin/flatpak-bisect
        - /bin/flatpak-coredumpctl
        - /etc/profile.d
        - /lib/systemd
        - /share/dbus-1/interfaces/org.freedesktop.*
        - /share/dbus-1/services/org.freedesktop.*
        - /share/flatpak/triggers
        - /share/gdm
        - /share/fish
        - /share/zsh
        - /share/gir-1.0
        - /share/bash-completion
        - /lib/girepository-1.0
        - /lib/sysusers.d
        - /lib/tmpfiles.d
      post-install:
        - install -Dpm0755 -t /app/bin /usr/bin/update-{mime,desktop}-database
      sources:
        - type: git
          url: https://github.com/flatpak/flatpak/
          commit: b676905d91aa3c4e524ca663784d4cf085c465d7
          tag: 1.16.1
          x-checker-data:
            type: git
            tag-pattern: "^([\\d.]+)$"

      modules:
         - shared-modules/intltool/intltool-0.51.json

         # needed by flatpak system_helper
         - name: polkit
           config-opts:
             - --disable-polkitd
             - --disable-man-pages
             - --disable-introspection
             - --disable-examples
             - --disable-gtk-doc
             - --disable-libelogind
             - --disable-libsystemd-login
             - --with-systemdsystemunitdir=no
             - --with-authdb=dummy
             - --with-authfw=none
           rm-configure: true
           build-options:
             cflags: -Wno-implicit-function-declaration
           cleanup:
             - /bin/*
             - /etc/pam.d
             - /etc/dbus-1
             - /share/dbus-1/system-services/*
             - /share/polkit-1
             - /lib/polkit-1
           sources:
             # TODO: update this version once patch is fully up-to-date with 126+ polkit
             - type: archive
               url: https://www.freedesktop.org/software/polkit/releases/polkit-0.116.tar.gz
               sha256: 88170c9e711e8db305a12fdb8234fac5706c61969b94e084d0f117d8ec5d34b1
             - type: patch
               path: patches/polkit/polkit-build-Add-option-to-build-without-polkitd.patch
             - type: script
               dest-filename: autogen.sh
               commands:
                 - |
                   gtkdocize --flavour no-tmpl
                   autoreconf -if

         - name: libfuse
           build-options:
             env:
               MOUNT_FUSE_PATH: ../tmp/
           config-opts:
             - UDEV_RULES_PATH=/app/etc/udev/rules.d
             - INIT_D_PATH=/app/etc/init.d
           cleanup:
             - /bin/ulockmgr_server
           post-install:
             - install -Dpm0755 ./fusermount-wrapper.sh /app/bin/fusermount
           sources:
             - type: archive
               url: https://github.com/libfuse/libfuse/releases/download/fuse-2.9.9/fuse-2.9.9.tar.gz
               sha256: d0e69d5d608cc22ff4843791ad097f554dd32540ddc9bed7638cc6fea7c1b4b5
             - type: patch
               path: patches/fuse/fuse-2.9.2-namespace-conflict-fix.patch
             - type: patch
               path: patches/fuse/fuse-disable-sys-mount-under-flatpak.patch
             - type: patch
               path: patches/fuse/fuse-2.9.2-closefrom.patch
             - type: file
               path: fusermount-wrapper.sh

         - name: ostree
           build-options:
             env:
               BASH_COMPLETIONSDIR: /app/share/bash-completion/completions
             config-opts:
               - --disable-man
               - --with-curl
               - --without-libsystemd
           cleanup:
             - /bin
             - /etc/grub.d
             - /etc/ostree
             - /share/ostree
             - /libexec
             - /share/gir-1.0
             - /share/bash-completion
             - /lib/girepository-1.0
           sources:
             - type: git
               url: https://github.com/ostreedev/ostree
               tag: v2025.6
               commit: 82185d9aaf0a79b100378f13a54c3d5d3763a971
               x-checker-data:
                 type: anitya
                 project-id: 10899
                 tag-template: v$version

           modules:
             - pyparsing.yaml

         - name: bubblewrap
           buildsystem: meson
           config-opts:
             - -Dman=disabled
             - -Dselinux=disabled
             - -Dtests=false
           cleanup:
             - "*"
#             - /share/zsh
#             - /share/bash-completion
           sources:
             - type: archive
               url: https://github.com/containers/bubblewrap/archive/refs/tags/v0.11.0.tar.gz
               sha256: cfeeb15fcc47d177d195f06fdf0847e93ee3aa6bf46f6ac0a141fa142759e2c3
               x-checker-data:
                 type: anitya
                 project-id: 10937
                 url-template: https://github.com/containers/bubblewrap/archive/refs/tags/v$version.tar.gz

         - name: xdg-dbus-proxy
           buildsystem: meson
           config-opts:
             - -Dman=disabled
             - -Dtests=false
           cleanup:
           - "*"
           sources:
             - type: archive
               url: https://github.com/flatpak/xdg-dbus-proxy/archive/refs/tags/0.1.6.tar.gz
               sha256: ee9c1d665f4e3b025a83d522d478ff7930070f2817fc2cb446db0dca93c990b1
               x-checker-data:
                 type: anitya
                 project-id: 58434
                 url-template: https://github.com/flatpak/xdg-dbus-proxy/archive/refs/tags/$version.tar.gz
