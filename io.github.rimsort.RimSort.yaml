# yaml-language-server: $schema=https://raw.githubusercontent.com/flatpak/flatpak-builder/refs/heads/main/data/flatpak-manifest.schema.json
app-id: io.github.rimsort.RimSort
runtime: org.kde.Platform
runtime-version: "6.9"
sdk: org.kde.Sdk
base: io.qt.PySide.BaseApp
base-version: "6.9"
cleanup-commands:
  - /app/cleanup-BaseApp.sh
cleanup:
  - /cache
  - /man
  - /share/aclocal
  - /share/devhelp
  - /include
  - /lib/pkgconfig
  - /share/gtk-doc
  - /share/man
  - /lib/*.a
  - /lib/*.la
command: RimSort
finish-args:
  - --device=dri
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio

  # Needed for steamcmd download
  - --share=network

  # XDG commons folders
  - --filesystem=xdg-download

  # Needed for autodetect config  /home/yodatak/.config/unity3d/Ludeon Studios/RimWorld by Ludeon Studios/Config
  - --filesystem=~/.config/unity3d/Ludeon Studios/

  # Used for reading SteamID of user
  - --filesystem=~/.steam/
  - --filesystem=~/.local/share/Steam

  # For flatpak steam folder
  - --filesystem=~/.var/app/com.valvesoftware.Steam
  # Read paths to mods on a Steam Deck SD card
  - --filesystem=/run/media

  # to permit the workshop explorer to work
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess

  # to help python run
  - --env=PYTHONPATH=/app

modules:
  # Python dependencies generated from requirements.txt
  - requirements-pypi-dependencies.json

  - name: steamfiles
    buildsystem: simple
    build-commands:
      - "pip3 install --verbose --exists-action=i --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST} . --no-build-isolation"
    sources:
      - type: git
        url: https://github.com/twstagg/steamfiles.git
        commit: 18bb08d5ff8b0e36d4cc14453deaf58d721339e4
      - type: file
        url: https://files.pythonhosted.org/packages/7e/cc/7e77861000a0691aeea8f4566e5d3aa716f2b1dece4a24439437e41d3d25/protobuf-5.29.5-py3-none-any.whl
        sha256: 6cf42630262c59b2d8de33954443d94b746c952b01434fc58a417fdbd2e84bd5
        x-checker-data:
          type: pypi
          name: protobuf
          packagetype: wheel
      - type: file
        url: https://files.pythonhosted.org/packages/6b/55/522bb43539fed463275ee803d79851faaebe86d17e7e3dbc89870d0322b9/protobuf3-to-dict-0.1.5.tar.gz
        sha256: 1e42c25b5afb5868e3a9b1962811077e492c17557f9c66f0fe40d821375d2b5a
        x-checker-data:
          type: pypi
          name: protobuf3-to-dict
          packagetype: sdist
      - type: file
        url: https://files.pythonhosted.org/packages/bf/b9/b0eb3f3cbcb734d930fdf839431606844a825b23eaf9a6ab371edac8162c/psutil-7.0.0-cp36-abi3-manylinux_2_12_x86_64.manylinux2010_x86_64.manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: 4b1388a4f6875d7e2aff5c4ca1cc16c545ed41dd8bb596cefea80111db353a34
        x-checker-data:
          type": "json"
          url": "https://pypi.org/pypi/psutil/json"
          version-query": ".info.version"
          url-query": '.releases | .[$version][] | select(.filename=="psutil-" + $version + "-cp36-abi3-manylinux_2_12_x86_64.manylinux2010_x86_64.manylinux_2_17_x86_64.manylinux2014_x86_64.whl") | .url'
          name": "psutil"
          packagetype": "bdist_wheel"

  - name: steamworkspy
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links=\"file://${PWD}\" --prefix=${FLATPAK_DEST} . --no-build-isolation
    sources:
      - type: git
        url: https://github.com/twstagg/SteamworksPy.git
        commit: 2b14087a0aac1cc589ae7c804567414a6cfdcf1c
      - type: patch
        path: SteamworksPy.cpp.patch
      - type: patch
        path: steamwork.patch

  - name: RimSort
    buildsystem: simple
    build-commands:
      - chmod +x todds && cp todds /app/bin/
      - cp -R app /app/
      - cp -R themes /app/themes
      - install -D app/__main__.py /app/bin/RimSort

    post-install:
      - install -Dm644 -D themes/default-icons/RimSort_Icon_64x64.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644  data/${FLATPAK_ID}.desktop -t ${FLATPAK_DEST}/share/applications/
      - install -Dm644 data/${FLATPAK_ID}.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo/

    sources:
      - type: git
        url: https://github.com/RimSort/RimSort.git
        tag: v1.0.24
        commit: ddafbee18fd5927af730ca3898a46a8e4fb2eab6
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

      - type: file
        url: https://github.com/RimSort/RimSort/raw/steamworks-sdk/steamworks_sdk_155.zip
        sha256: 3d5ab5d2b5538fdbe49fd81abf3b6bc6c18b91bcc6a0fecd4122f22b243ee704

        # add todds binary
      - type: archive
        url: https://github.com/todds-encoder/todds/releases/download/0.4.1/todds_Linux_x86_64_0.4.1.zip
        sha256: 012787f95bca91d00aa5baaad87ace528fa9d39a478d3377107812cf376f1b11
# /usr/bin/flatpak run --branch=master --arch=x86_64 --command=RimSort io.github.rimsort.RimSort
