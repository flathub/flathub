app-id: io.github.sanjai.ProPad
runtime: org.gnome.Platform
runtime-version: "48"
sdk: org.gnome.Sdk
command: propad

finish-args:
  # Graphics 
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --device=all

  # Network 
  - --share=network

  # File system access
  - --filesystem=host
  - --filesystem=xdg-run/gvfsd

  # D-Bus - Basic bus access 
  - --socket=session-bus
  - --socket=system-bus

  # WebKit sandbox permissions
  - --own-name=io.github.sanjai.ProPad.*
  - --allow=per-app-dev-shm

  # Accessibility 
  - --talk-name=org.a11y.Bus

  
  - --env=NO_AT_BRIDGE=1
  - --env=GTK_A11Y=none
  - --env=G_MESSAGES_DEBUG=
  - --env=LIBGL_ALWAYS_SOFTWARE=1
  - --env=MESA_LOADER_DRIVER_OVERRIDE=swrast
  - --env=LIBGL_DRI3_DISABLE=1
  - --env=EGL_PLATFORM=wayland
  - --env=GDK_BACKEND=wayland,x11

  - --env=GTK_USE_PORTAL=0

  - --env=WEBKIT_DISABLE_SANDBOX_THIS_IS_DANGEROUS=1
  - --env=WEBKIT_FORCE_SANDBOX=0

  - --filesystem=xdg-data/icons:ro

  - --socket=pulseaudio
  - --filesystem=xdg-run/dconf
  - --filesystem=~/.config/dconf:ro
  - --talk-name=ca.desrt.dconf
  - --env=DCONF_USER_CONFIG_DIR=.config/dconf

  - --allow=per-app-dev-shm

  - --metadata=X-DConf=migrate-path=/io/github/sanjai/ProPad/

cleanup:
  - /include
  - /lib/pkgconfig
  - /man
  - /share/doc
  - /share/gtk-doc
  - /share/man
  - /share/pkgconfig
  - "*.la"
  - "*.a"

modules:
  - name: python-dependencies
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} --ignore-installed attrs brotli certifi cffi charset-normalizer comrak cssselect2 fonttools h11 html2pdf4doc idna markdown outcome packaging pillow pycparser pydyf pypdf pyphen python-dotenv requests ruff selenium sniffio sortedcontainers tinycss2 tinyhtml5 trio trio-websocket typing-extensions urllib3 weasyprint webdriver-manager webencodings websocket-client wsproto zopfli PySocks chardet rfc3986 hstspreload  --no-build-isolation
    sources:
      - type: file
        path: packages/PySocks-1.7.1-py3-none-any.whl
      - type: file
        path: packages/attrs-25.4.0-py3-none-any.whl
      - type: file
        path: packages/brotli-1.2.0-cp312-cp312-manylinux2014_x86_64.manylinux_2_17_x86_64.whl
      - type: file
        path: packages/certifi-2025.11.12-py3-none-any.whl
      - type: file
        path: packages/cffi-2.0.0-cp312-cp312-manylinux2014_x86_64.manylinux_2_17_x86_64.whl
      - type: file
        path: packages/charset_normalizer-3.4.4-cp312-cp312-manylinux2014_x86_64.manylinux_2_17_x86_64.manylinux_2_28_x86_64.whl
      - type: file
        path: packages/comrak-0.0.9-cp39-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
      - type: file
        path: packages/cssselect2-0.8.0-py3-none-any.whl
      - type: file
        path: packages/fonttools-4.60.1-cp312-cp312-manylinux1_x86_64.manylinux2014_x86_64.manylinux_2_17_x86_64.manylinux_2_5_x86_64.whl
      - type: file
        path: packages/h11-0.16.0-py3-none-any.whl
      - type: file
        path: packages/html2pdf4doc-0.0.22-py3-none-any.whl
      - type: file
        path: packages/idna-3.11-py3-none-any.whl
      - type: file
        path: packages/markdown-3.10-py3-none-any.whl
      - type: file
        path: packages/outcome-1.3.0.post0-py2.py3-none-any.whl
      - type: file
        path: packages/packaging-25.0-py3-none-any.whl
      - type: file
        path: packages/pillow-12.0.0-cp312-cp312-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl
      - type: file
        path: packages/pycparser-2.23-py3-none-any.whl
      - type: file
        path: packages/pydyf-0.11.0-py3-none-any.whl
      - type: file
        path: packages/pypdf-6.3.0-py3-none-any.whl
      - type: file
        path: packages/pyphen-0.17.2-py3-none-any.whl
      - type: file
        path: packages/python_dotenv-1.2.1-py3-none-any.whl
      - type: file
        path: packages/requests-2.32.5-py3-none-any.whl
      - type: file
        path: packages/ruff-0.14.5-py3-none-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
      - type: file
        path: packages/selenium-4.38.0-py3-none-any.whl
      - type: file
        path: packages/sniffio-1.3.1-py3-none-any.whl
      - type: file
        path: packages/sortedcontainers-2.4.0-py2.py3-none-any.whl
      - type: file
        path: packages/tinycss2-1.5.0-py3-none-any.whl
      - type: file
        path: packages/tinyhtml5-2.0.0-py3-none-any.whl
      - type: file
        path: packages/trio-0.32.0-py3-none-any.whl
      - type: file
        path: packages/trio_websocket-0.12.2-py3-none-any.whl
      - type: file
        path: packages/typing_extensions-4.15.0-py3-none-any.whl
      - type: file
        path: packages/urllib3-2.5.0-py3-none-any.whl
      - type: file
        path: packages/weasyprint-66.0-py3-none-any.whl
      - type: file
        path: packages/webdriver_manager-4.0.2-py2.py3-none-any.whl
      - type: file
        path: packages/webencodings-0.5.1-py2.py3-none-any.whl
      - type: file
        path: packages/websocket_client-1.9.0-py3-none-any.whl
      - type: file
        path: packages/wsproto-1.3.2-py3-none-any.whl
      - type: file
        path: packages/zopfli-0.4.0-cp310-abi3-manylinux2014_x86_64.manylinux_2_17_x86_64.whl

      - type: file
        path: packages/chardet-3.0.4-py2.py3-none-any.whl
      - type: file
        path: packages/hstspreload-2025.1.1-py3-none-any.whl
      - type: file
        path: packages/idna-2.10-py2.py3-none-any.whl
      - type: file
        path: packages/rfc3986-1.5.0-py2.py3-none-any.whl

  - name: propad
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/propad/ui
      - mkdir -p /app/share/propad/data
      - mkdir -p /app/share/propad/propad
      - mkdir -p /app/share/propad/scripts
      - mkdir -p /app/share/propad/po
      - mkdir -p /app/share/locale

      - cp ui/*.ui /app/share/propad/ui/

      - cp -r propad /app/share/propad/
      - cp main.py /app/share/propad/

      - cp -r po /app/share/propad/ || true
      - cp -r locale /app/share/locale/ || true
      - cp -r scripts /app/share/propad/ || true

      - mkdir -p /app/share/propad/data
      - mkdir -p /app/share/propad/lib
      - mkdir -p /app/share/propad/icons
      - |
        # Copy everything from data directory
        if [ -d "data" ]; then
          cp -r data/* /app/share/propad/data/ 2>/dev/null || true
        fi
      - |
        # Copy lib directory (for .blp files if needed)
        if [ -d "lib" ]; then
          cp -r lib/* /app/share/propad/lib/ 2>/dev/null || true
        fi
      - |
        # Copy icons directory
        if [ -d "icons" ]; then
          cp -r icons/* /app/share/propad/icons/ 2>/dev/null || true
        fi
      - |
        # Copy any CSS files
        find . -maxdepth 2 -name "*.css" -exec cp {} /app/share/propad/data/ \; 2>/dev/null || true

      - |
        cat > /app/bin/propad << 'EOF'
        #!/bin/bash
        # Suppress accessibility bus warnings
        export NO_AT_BRIDGE=1
        export GTK_A11Y=none
        export PYTHONPATH=/app/share/propad:$PYTHONPATH

        # Graphics environment variables
        export LIBGL_ALWAYS_SOFTWARE=1
        export MESA_LOADER_DRIVER_OVERRIDE=swrast
        export LIBGL_DRI3_DISABLE=1
        export EGL_PLATFORM=wayland
        export GDK_BACKEND=wayland,x11

        # CRITICAL: Disable document portal for direct file access
        export GTK_USE_PORTAL=0

        # WebKit sandbox fix - disable sandboxing to avoid crashes
        export WEBKIT_DISABLE_SANDBOX_THIS_IS_DANGEROUS=1
        export WEBKIT_FORCE_SANDBOX=0

        # Suppress all common warnings
        export G_MESSAGES_DEBUG=

        # Redirect errors to filter out graphics and WebKit warnings
        exec 2> >(grep -v "Fontconfig error" | \
                  grep -v "MESA-INTEL: warning" | \
                  grep -v "Can't connect to a11y bus" | \
                  grep -v "kmsro: driver missing" | \
                  grep -v "libEGL warning" | \
                  grep -v "egl: failed to create dri2 screen" | \
                  grep -v "DRI2: failed to create screen" | \
                  grep -v "Portal call failed" | \
                  grep -v "Invalid sandbox" | \
                  grep -v "readPIDFromPeer" | \
                  grep -v "auxiliary process crashed" >&2)

        cd /app/share/propad
        exec python3 -u main.py "$@"
        EOF
      - chmod +x /app/bin/propad
      # Install desktop file
      - install -Dm644 io.github.sanjai.ProPad.desktop /app/share/applications/io.github.sanjai.ProPad.desktop

      # Install full icon theme support (Adwaita + all themes)
      - |
        if [ -d "icons/hicolor" ]; then
          for size in 16 22 24 32 48 64 128 256 512; do
            if [ -f "icons/hicolor/${size}x${size}/apps/io.github.sanjai.ProPad.png" ]; then
              install -Dm644 "icons/hicolor/${size}x${size}/apps/io.github.sanjai.ProPad.png" \
                "/app/share/icons/hicolor/${size}x${size}/apps/io.github.sanjai.ProPad.png"
            fi
          done

          # SVG (scalable icon)
          if [ -f "icons/hicolor/scalable/apps/io.github.sanjai.ProPad.svg" ]; then
            install -Dm644 "icons/hicolor/scalable/apps/io.github.sanjai.ProPad.svg" \
              "/app/share/icons/hicolor/scalable/apps/io.github.sanjai.ProPad.svg"
          fi

          # Symbolic icon
          if [ -f "icons/hicolor/symbolic/apps/io.github.sanjai.ProPad-symbolic.svg" ]; then
            install -Dm644 "icons/hicolor/symbolic/apps/io.github.sanjai.ProPad-symbolic.svg" \
              "/app/share/icons/hicolor/symbolic/apps/io.github.sanjai.ProPad-symbolic.svg"
          fi
        fi

      # Update icon cache
      - gtk-update-icon-cache -q -t -f /app/share/icons/hicolor || true

      # Copy any additional icon resources
      - |
        if [ -d "data/icons" ]; then
          cp -r data/icons /app/share/propad/
        fi
      - |
        if [ -d "icons" ]; then
          cp -r icons /app/share/propad/
        fi

      # Update icon cache
      - gtk-update-icon-cache -q -t -f /app/share/icons/hicolor || true

      # Validate desktop file
      - desktop-file-validate /app/share/applications/io.github.sanjai.ProPad.desktop || true

    sources:
      - type: dir
        path: .
        skip:
          - .git
          - .github
          - .vscode
          - .idea
          - build-dir
          - .flatpak-builder
          - __pycache__
          - "*.pyc"
          - "*.pyo"
          - .venv
          - .venv-translate
          - venv
          - .pytest_cache
          - .ruff_cache
          - "*.flatpak"
