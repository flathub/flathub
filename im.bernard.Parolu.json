{
  "id": "im.bernard.Parolu",
  "runtime": "org.gnome.Platform",
  "runtime-version": "48",
  "sdk": "org.gnome.Sdk",
  "command": "parolu",
  "finish-args": [
    "--share=network",
    "--share=ipc",
    "--socket=fallback-x11",
    "--device=dri",
    "--socket=wayland",
    "--socket=pulseaudio"
  ],
  "cleanup": [
    "/include",
    "/lib/pkgconfig",
    "/man",
    "/share/doc",
    "/share/gtk-doc",
    "/share/man",
    "/share/pkgconfig",
    "*.la",
    "*.a"
  ],
  "modules": [
		{
			"name": "python3-requests",
			"buildsystem": "simple",
			"build-commands": [
				"pip3 install --verbose --exists-action=i --no-index --find-links=\"file://${PWD}\" --prefix=${FLATPAK_DEST} \"requests\" --no-build-isolation",
				"mkdir -p /app/include/python3.12",
        "cp -r /usr/include/python3.12/* /app/include/python3.12/"
			],
			"sources": [
				{
				  "type": "file",
				  "url": "https://files.pythonhosted.org/packages/4a/7e/3db2bd1b1f9e95f7cddca6d6e75e2f2bd9f51b1246e546d88addca0106bd/certifi-2025.4.26-py3-none-any.whl",
				  "sha256": "30350364dfe371162649852c63336a15c70c6510c2ad5015b21c2345311805f3"
				},
				{
				  "type": "file",
				  "url": "https://files.pythonhosted.org/packages/e4/33/89c2ced2b67d1c2a61c19c6751aa8902d46ce3dacb23600a283619f5a12d/charset_normalizer-3.4.2.tar.gz",
				  "sha256": "5baececa9ecba31eff645232d59845c07aa030f0c81ee70184a90d35099a0e63"
				},
				{
				  "type": "file",
				  "url": "https://files.pythonhosted.org/packages/76/c6/c88e154df9c4e1a2a66ccf0005a88dfb2650c1dffb6f5ce603dfbd452ce3/idna-3.10-py3-none-any.whl",
				  "sha256": "946d195a0d259cbba61165e88e65941f16e9b36ea6ddb97f00452bae8b1287d3"
				},
				{
				  "type": "file",
				  "url": "https://files.pythonhosted.org/packages/f9/9b/335f9764261e915ed497fcdeb11df5dfd6f7bf257d4a6a2a686d80da4d54/requests-2.32.3-py3-none-any.whl",
				  "sha256": "70761cfe03c773ceb22aa2f671b4757976145175cdfca038c02654d061d6dcc6"
				},
				{
				  "type": "file",
				  "url": "https://files.pythonhosted.org/packages/6b/11/cc635220681e93a0183390e26485430ca2c7b5f9d33b15c74c2861cb8091/urllib3-2.4.0-py3-none-any.whl",
				  "sha256": "4e16665048960a0900c702d4a66415956a584919c03361cac9f1df5c5dd7e813"
				}
			]
		},
		{
			"name": "numpy",
			"buildsystem": "simple",
			"build-commands": [
				"pip3 install --prefix=/app numpy"
			],
			"build-options": {
				"env": {
				  "PIP_DISABLE_PIP_VERSION_CHECK": "1",
				  "PIP_NO_CACHE_DIR": "off"
				},
				"build-args": [
				  "--share=network"
				]
			},
			"sources": [
				{
				  "type": "script",
				  "commands": []
				}
			]
		},
    {
      "name": "espeak",
      "buildsystem": "autotools",
      "sources": [
        {
          "type": "archive",
          "url": "https://github.com/rhasspy/espeak-ng/archive/8593723f10cfd9befd50de447f14bf0a9d2a14a4.zip",
          "sha256": "cc8092f23a28ccd79b1c5e62984a4c4ac1959d2d0b8193ac208d728c620bd5ed"
        }
      ]
    },
    {
      "name": "onnxruntime",
      "buildsystem": "simple",
      "build-commands": [
        "mkdir -p /app/lib /app/include",
        "cp -v lib/libonnxruntime.so* /app/lib/",
        "ln -sf /app/lib/libonnxruntime.so.1.16.1 /app/lib/libonnxruntime.so",
        "mkdir -p /app/include/onnxruntime",
        "cp -v include/*.h /app/include/"
      ],
      "sources": [
        {
          "type": "archive",
          "url": "https://github.com/microsoft/onnxruntime/releases/download/v1.16.1/onnxruntime-linux-x64-1.16.1.tgz",
          "sha256": "53a0f03f71587ed602e99e82773132fc634b74c2d227316fbfd4bf67181e72ed",
          "strip-components": 1
        }
      ]
    },
    {
      "name": "piperphonemize",
      "buildsystem": "cmake-ninja",
      "config-opts": [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DCMAKE_POSITION_INDEPENDENT_CODE=ON",
        "-DCMAKE_INSTALL_PREFIX=/app",
        "-DCMAKE_INSTALL_INCLUDEDIR=/app/include",
        "-DBUILD_SHARED_LIBS=ON"
      ],
      "build-commands": [
        "cmake --install . --prefix=/app",
        "ln -sf /app/lib/libpiper_phonemize.so.1 /app/lib/libpiper_phonemize.so"
      ],
      "sources": [
        {
          "type": "archive",
          "url": "https://github.com/rhasspy/piper-phonemize/archive/7f7b5bd4de22f7fe24341c5bedda0dc1e33f3666.zip",
          "sha256": "6bdcb21f6c5ae0deff7c9ae26bf07b994791dc800c1962fd216727e66a409929"
        },
        {
          "type": "patch",
          "path": "./patches/piperphonemize.patch"
        }
      ]
    },
    {
      "name": "spdlog",
      "buildsystem": "cmake-ninja",
      "config-opts": [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DCMAKE_POSITION_INDEPENDENT_CODE=ON"
      ],
      "sources": [
        {
          "type": "archive",
          "url": "https://github.com/gabime/spdlog/archive/refs/tags/v1.11.0.tar.gz",
          "sha256": "ca5cae8d6cac15dae0ec63b21d6ad3530070650f68076f3a4a862ca293a858bb"
        }
      ]
    },
    {
      "name": "pybind11",
      "buildsystem": "cmake",
      "config-opts": [
        "-DPYBIND11_TEST=OFF"
      ],
      "sources": [
        {
          "type": "git",
          "url": "https://github.com/pybind/pybind11.git",
          "tag": "v2.13.5"
        }
      ]
    },
    {
      "name": "piper",
      "buildsystem": "cmake-ninja",
      "build-options": {
        "env": {
          "PKG_CONFIG_PATH": "/app/lib/pkgconfig",
          "CMAKE_PREFIX_PATH": "/app",
          "LD_LIBRARY_PATH": "/app/lib",
          "CPLUS_INCLUDE_PATH": "/app/include/piper-phonemize:/app/include",
          "C_INCLUDE_PATH": "/app/include/piper-phonemize:/app/include"
        }
      },
      "config-opts": [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DCMAKE_INSTALL_PREFIX=/app",
        "-DCMAKE_POSITION_INDEPENDENT_CODE=ON",
        "-DPIPER_PHONEMIZE_INCLUDE=/app/include/piper-phonemize",
        "-Donnxruntime_LIBRARY=/app/lib/libonnxruntime.so.1.16.1",
        "-Donnxruntime_INCLUDE_DIR=/app/include/onnxruntime"
      ],
      "build-commands": [
        "mkdir -p /app/include/piper",
        "cp src/cpp/piper.hpp /app/include/piper/"
      ],
      "sources": [
        {
          "type": "archive",
          "url": "https://github.com/rhasspy/piper/archive/e268564deb779af984ac8f632c98727447632124.zip",
          "sha256": "213a31c23c862cbcd9de4231c07d32de35f4ee0b5b5dec52e9ae6dd3aa70ac12",
          "strip-components": 1
        },
        {
          "type": "file",
          "path": "patches/piper_api.cpp",
          "dest-filename": "piper_api.cpp"
        },
        {
          "type": "file",
          "path": "patches/piper_api.h",
          "dest-filename": "piper_api.h"
        },
        {
          "type": "file",
          "path": "patches/CMakeLists.txt",
          "dest-filename": "CMakeLists.txt"
        }
      ]
    },
    {
      "name": "piper-python",
      "buildsystem": "simple",
      "build-options": {
        "env": {
          "CXXFLAGS": "-O3 -Wall -shared -std=c++17 -fPIC"
        }
      },
      "build-commands": [
        "mkdir -p /app/lib/python3.12/site-packages",
        "g++ $CXXFLAGS -I/app/include -I/app/include/python3.12 -I/app/include/piper-phonemize piper.cpp -o /app/lib/python3.12/site-packages/piper.so -L/app/lib -lpiper_api -lpiper_phonemize -lespeak-ng -lonnxruntime -Wl,-rpath=/app/lib"
      ],
      "sources": [
        {
          "type": "file",
          "path": "src/piper.cpp"
        }
      ]
    },
    {
      "name": "piper-model-darkman",
      "buildsystem": "simple",
      "build-commands": [
        "mkdir -p /app/share/piper/eo/eo-darkman-medium",
        "cp eo-darkman-medium.onnx /app/share/piper/eo/eo-darkman-medium/",
        "cp eo-darkman-medium.onnx.json /app/share/piper/eo/eo-darkman-medium/"
      ],
      "sources": [
        {
          "type": "file",
          "path": "models/eo/eo-darkman-medium/eo-darkman-medium.onnx"
        },
        {
          "type": "file",
          "path": "models/eo/eo-darkman-medium/eo-darkman-medium.onnx.json"
        }
      ]
    },
    {
      "name": "piper-model-gosia",
      "buildsystem": "simple",
      "build-commands": [
        "mkdir -p /app/share/piper/eo/eo-gosia-medium",
        "cp eo-gosia-medium.onnx /app/share/piper/eo/eo-gosia-medium/",
        "cp eo-gosia-medium.onnx.json /app/share/piper/eo/eo-gosia-medium/"
      ],
      "sources": [
        {
          "type": "file",
          "path": "models/eo/eo-gosia-medium/eo-gosia-medium.onnx"
        },
        {
          "type": "file",
          "path": "models/eo/eo-gosia-medium/eo-gosia-medium.onnx.json"
        }
      ]
    },
    {
      "name": "desktop-file",
      "buildsystem": "simple",
      "build-commands": [
        "mkdir -p /app/share/applications",
        "install -Dm644 ../data/im.bernard.Parolu.desktop /app/share/applications/im.bernard.Parolu.desktop || true",
        "mkdir -p /app/share/icons/hicolor/scalable/apps",
        "install -Dm644 ../data/icons/im.bernard.Parolu.svg /app/share/icons/hicolor/scalable/apps/im.bernard.Parolu.svg || true",
        "mkdir -p /app/share/metainfo",
        "install -Dm644 ../data/im.bernard.Parolu.metainfo.xml /app/share/metainfo/im.bernard.Parolu.metainfo.xml || true"
      ]
    },
    {
      "name": "icons",
      "buildsystem": "simple",
      "build-commands": [
        "mkdir -p /app/share/icons/hicolor/scalable/actions/",
        "install -Dm644 data/icons/hicolor/scalable/actions/im.bernard.Parolu.speed-symbolic.svg /app/share/icons/hicolor/scalable/actions/im.bernard.Parolu.speed-symbolic.svg || true",
        "install -Dm644 data/icons/hicolor/scalable/actions/im.bernard.Parolu.pitch-symbolic.svg /app/share/icons/hicolor/scalable/actions/im.bernard.Parolu.pitch-symbolic.svg || true"
      ],
      "sources": [
        {
          "type": "dir",
          "path": "."
        }
      ]
    },
    {
      "name": "gst-plugins",
      "buildsystem": "simple",
      "build-commands": [
        "mkdir -p /app/lib/gstreamer-1.0",
        "cp /usr/lib/x86_64-linux-gnu/gstreamer-1.0/libgstcoreelements.so /app/lib/gstreamer-1.0/"
      ],
      "sources": [
        {
          "type": "shell",
          "commands": [
            "echo 'Using system GStreamer plugins'"
          ]
        }
      ]
    },
    {
      "name": "parolu",
      "builddir": true,
      "buildsystem": "meson",
      "build-commands": [
        "install -d /app/lib/parolu",
        "cp -v src/main.py src/window.py src/reader.py /app/lib/parolu/",
        "touch /app/lib/parolu/__init__.py",
        "install -Dm755 bin/parolu /app/bin/parolu",
        "glib-compile-resources src/parolu.gresource.xml --target=parolu.gresource --sourcedir=src",
        "install -Dm644 parolu.gresource /app/share/parolu.gresource"
      ],
      "build-options": {
        "env": {
          "PYTHONPATH": "/app/lib:/app/lib/python3.12/site-packages"
        }
      },
      "sources": [
        {
          "type": "dir",
          "path": "."
        }
      ]
    }
  ]
}