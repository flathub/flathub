app-id: net.sonobus.SonoBus
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: '20.08'
command: sonobus
#rename-desktop-file: sonobus.desktop
#rename-icon:
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --share=network
  - --socket=pulseaudio
  - --filesystem=home
# Jack
  - --filesystem=xdg-run/pipewire-0
  - --system-talk-name=org.freedesktop.RealtimeKit1

modules:
  - name: jack2
    buildsystem: simple
    build-commands:
      - ./waf configure --prefix=/app --htmldir=/app/share/doc/jack/ --classic
      - ./waf build -j $FLATPAK_BUILDER_N_JOBS
      - ./waf install
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://github.com/jackaudio/jack2/archive/refs/tags/v1.9.17.tar.gz
        sha256: 38f674bbc57852a8eb3d9faa1f96a0912d26f7d5df14c11005ad499c8ae352f2

  - name: SonoBus
    buildsystem: simple
    build-commands:
      - CONFIG=Release make -j$(nproc) -C Builds/LinuxMakefile Standalone VST3
      - install -Dm755 -t ${FLATPAK_DEST}/bin/ Builds/LinuxMakefile/build/sonobus
      - install -d ${FLATPAK_DEST}/lib/vst3/
      - cp -a Builds/LinuxMakefile/build/sonobus.vst3 ${FLATPAK_DEST}/lib/vst3/
      - install -Dm644 "Builds/LinuxMakefile/sonobus.desktop" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      - desktop-file-edit --set-icon=${FLATPAK_ID} /app/share/applications/${FLATPAK_ID}.desktop
      - install -D "${FLATPAK_BUILDER_BUILDDIR}/images/SonoBus-Icon.svg" "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/$FLATPAK_ID.svg"
      - install -Dm644 "${FLATPAK_BUILDER_BUILDDIR}/$FLATPAK_ID.metainfo.xml" "${FLATPAK_DEST}/share/metainfo/$FLATPAK_ID.metainfo.xml"
    sources:
      - type: git
        url: https://github.com/sonosaurus/sonobus/
        tag: 1.4.3
        commit: 0fae9ff1fa157646748bb9f93ca068ec691e4fb2
      - type: file
        path: net.sonobus.SonoBus.metainfo.xml
