id: org.quelea.Quelea

runtime: org.freedesktop.Platform
runtime-version: '24.08'

sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk21

command: quelea

finish-args:
  # X11
  - --socket=x11
  - --share=ipc
  # GPU acceleration if needed
  - --device=dri
  # Needs to talk to the network:
  - --share=network
  # Needs to save files locally
  - --filesystem=home
  # Environment variables for running Java apps
  - --env=PATH=/app/jre/bin:/app/bin:/usr/bin
  - --env=JAVA_HOME=/app/jre

modules:
  - name: openjdk-jre24
    buildsystem: simple
    build-commands:
      - cp -a . /app/jre
    sources:
      - type: archive
        url: https://cdn.azul.com/zulu/bin/zulu24.28.85-ca-fx-jre24.0.0-linux_x64.tar.gz
        sha256: 74fd6b44281319ca228a194122acf0ed1d7cc6f3b64d6293ba9ee69795174913
        strip-components: 1

  - name: quelea
    buildsystem: simple
    build-commands:
      - install -Dm755 -t /app/bin quelea
      - install -Dm644 org.quelea.Quelea.desktop /app/share/applications/org.quelea.Quelea.desktop
      - install -Dm644 icons/logo512.png /app/share/icons/hicolor/512x512/apps/org.quelea.Quelea.png
      - install -Dm644 org.quelea.Quelea.metainfo.xml /app/share/metainfo/org.quelea.Quelea.metainfo.xml
      - cp -a ./ /app/
    sources:
      - type: archive
        url: https://github.com/quelea-projection/Quelea/releases/download/CI-RELEASE/quelea-CI-UNSTABLE-java-app.tar.gz
        sha256: 76a3d9c5e912bf74972852fb78507d81da8be8d3a0eaed81638e42e0728febd5
        strip-components: 1

      - type: file
        url: https://raw.githubusercontent.com/quelea-projection/Quelea/5d299d3658b38bc311e9e92e893c36cf7d797cf2/flatpak/org.quelea.Quelea.metainfo.xml
        sha256: 60d430715e9ad846ebebac8a835d6ab977533d0b1008b6d031d8283a74745a46
        
      - type: file
        url: https://raw.githubusercontent.com/quelea-projection/Quelea/5d299d3658b38bc311e9e92e893c36cf7d797cf2/flatpak/org.quelea.Quelea.desktop
        sha256: 95876f0c627b4e527a294ed12c73f4b3a232c51d59d433ae24ac0fd10a992eef
        
      - type: script
        dest-filename: quelea
        commands:
          - cd /app
          - java
            --add-opens java.base/java.nio=ALL-UNNAMED 
            --add-opens java.base/java.lang=ALL-UNNAMED
            --add-exports=javafx.graphics/com.sun.javafx.scene.traversal=ALL-UNNAMED 
            --add-exports=javafx.graphics/com.sun.javafx.scene=ALL-UNNAMED 
            --add-exports=javafx.graphics/com.sun.javafx.css=ALL-UNNAMED 
            --add-exports=javafx.base/com.sun.javafx.runtime=ALL-UNNAMED 
            --add-exports=javafx.base/com.sun.javafx.event=ALL-UNNAMED 
            --add-opens javafx.controls/javafx.scene.control=ALL-UNNAMED 
            -Djdk.gtk.verbose=true 
            -DVLCJ_INITX=no 
            -Dfile.encoding=UTF-8 
            -Dprism.dirtyopts=false
            -jar Quelea.jar
