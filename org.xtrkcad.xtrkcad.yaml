id: org.xtrkcad.xtrkcad
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
command: /app/bin/run-xtrkcad.sh

modules:
  - name: libzip
    buildsystem: cmake
    config-opts:
      - -DBUILD_DOC=OFF
      - -DBUILD_EXAMPLES=OFF
      - -DBUILD_REGRESS=OFF
      - -DBUILD_TOOLS=OFF
      - -DBUILD_OSSFUZZ=OFF
      - -DCMAKE_INSTALL_PREFIX=/app/libzip
      - -DBUILD_SHARED_LIBS=OFF
      - -DENABLE_COMMONCRYPTO=OFF
      - -DENABLE_GNUTLS=OFF
      - -DENABLE_MBEDTLS=OFF
      - -DENABLE_OPENSSL=OFF
      - -DENABLE_WINDOWS_CRYPTO=OFF
      - -DENABLE_BZIP2=OFF
      - -DENABLE_LZMA=OFF
      - -DENABLE_ZSTD=OFF
    sources:
      - type: archive
        url: https://github.com/nih-at/libzip/releases/download/v1.8.0/libzip-1.8.0.tar.gz
        sha256: 30ee55868c0a698d3c600492f2bea4eb62c53849bcf696d21af5eb65f3f3839e
    post-install:
      - mkdir -p /app/include
      - mkdir -p /app/lib
      - ln -s /app/libzip/include/* /app/include
      - ln -s /app/libzip/lib/libzip.a /app/lib
  - name: mxml
    buildsystem: simple
    build-commands:
      - ./configure --exec_prefix=/app/mxml --prefix=/app/mxml
      - make
      - make install
      - mkdir -p /app/include
      - mkdir -p /app/lib
      - ln -s /app/mxml/include/* /app/include
      - ln -s /app/mxml/lib/* /app/lib
    sources:
      - type: archive
# v4 changes names from mxml to mxml4 whch we haven't migrated yet
        url: https://github.com/michaelrsweet/mxml/archive/refs/tags/v3.3.1.tar.gz
        sha256: 59eba16ce43765f2e2a6cf4873a58d317be801f1e929647d85da9f171e41e9ac
  - name: gtk2
    buildsystem: autotools
    build-options:
      env:
        CFLAGS: "-Wno-incompatible-pointer-types -Wno-implicit-int"
        CXXFLAGS: "-Wno-incompatible-pointer-types -Wno-implicit-int"
    sources:
      - type: archive
        url: "https://gitlab.gnome.org/GNOME/gtk/-/archive/2.24.33/gtk-2.24.33.tar.gz"
        sha256: dedfaf04952434c5e3e1ce4de373ac7474d12da2d99b0afc947ef1983df64601
    config-opts:
      - "--prefix=/app"
      - "--disable-introspection"
      - "--enable-shared"
      - "--disable-static"
      - "--enable-gtk-doc-html=no"
  - name: fake-inkscape
    buildsystem: simple
    sources:
      - type: inline
        dest-filename: inkscape
        contents: |
            #!/usr/bin/env bash
            rsvg-convert $*
    build-commands:
      - install -Dm755 inkscape /app/bin/inkscape
  - name: xtrkcad
    buildsystem: simple
    sources:
      - type: file
        url: https://sourceforge.net/projects/xtrkcad-fork/files/XTrackCad/Version%205.3.1/xtrkcad-source-5.3.1GA.tar.gz/download
        sha256: 5b02a0352c23f90b0011029c7e2c3f12a6f6779425c4c47c1f75d6b8a0db572c
        dest-filename: xtrkcad-source.tar.gz
      - type: inline
        dest-filename: common_source.sh
        contents: |
          echo
          echo "XTrackCAD 5.3.1GA (flatpak)"
          echo
          export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.var/app/org.xtrkcad.xtrkcad/config}"
          export XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.var/app/org.xtrkcad.xtrkcad/cache}"
          export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.var/app/org.xtrkcad.xtrkcad/data}"
          mkdir -p ${XDG_CACHE_HOME}
          rm -rf ${XDG_CACHE_HOME}/*
          cp -pr /app/share/xtrkcad/* ${XDG_CACHE_HOME}
          export XTRKCADLIB=${XDG_CACHE_HOME}
          #export XTRKCADBETALIB=${XDG_CACHE_HOME}
          #export XTRKCAD_GTKLIB=${XDG_CACHE_HOME}
          #export XTRKCAD_GTKBETALIB=${XDG_CACHE_HOME}
          # there is no access to host gtk3 modules
          unset GTK3_MODULES
          unset GTK_MODULES
          BOOKMARK="file://$XTRKCADLIB xtrkcad-lib"
          # gtk2 bookmarks
          FILE="$HOME/.gtk-bookmarks"
          touch $FILE
          sed "/xtrkcad-lib$/d" $FILE > ${FILE}_
          cp ${FILE}_ $FILE
          rm ${FILE}_
          echo "$BOOKMARK" >> $FILE
          # gtk3 bookmarks
          FILE="$XDG_CONFIG_HOME/gtk-3.0/bookmarks"
          mkdir -p $(dirname $FILE)
          touch $FILE
          sed "/xtrkcad-lib$/d" $FILE > ${FILE}_
          cp ${FILE}_ $FILE
          rm ${FILE}_
          echo "$BOOKMARK" >> $FILE
          #export GTK_USE_PORTAL=1
          #export XDG_CURRENT_DESKTOP=GNOME
          env | sort | grep -E "DISPLAY|XTRK|XDG"
          echo
      - type: inline
        dest-filename: run-xtrkcad.sh
        contents: |
          #!/bin/sh
          source $(dirname $0)/common_source.sh
          exec /app/bin/xtrkcad "$@"
      - type: inline
        dest-filename: run-xtrkcad-debug.sh
        contents: |
          #!/bin/sh
          source $(dirname $0)/common_source.sh
          # set up for logging by day the app started
          DOW=$(date '+%a')
          LOGFILE="$HOME/.xtrkcad/xtrkcad_${DOW}.log"
          LOG_ALLMODULES=" \
              -d Bezier=1 \
              -d block=1 \
              -d carDlgList=1 \
              -d carDlgState=1 \
              -d carInvList=1 \
              -d carList=1 \
              -d command=1 \
              -d control=1 \
              -d Cornu=1 \
              -d cornuturnoutdesigner=1 \
              -d curve=1 \
              -d curveSegs=1 \
              -d dumpElev=1 \
              -d ease=1 \
              -d endPt=1 \
              -d group=1 \
              -d init=1 \
              -d join=1 \
              -d locale=1 \
              -d malloc=0 \
              -d mapsize=1 \
              -d modify=1 \
              -d mouse=0 \
              -d pan=1 \
              -d paraminput=1 \
              -d paramlayout=1 \
              -d params=1 \
              -d paramupdate=1 \
              -d playbackcursor=1 \
              -d print=1 \
              -d profile=1 \
              -d readTracks=1 \
              -d redraw=1 \
              -d regression=1 \
              -d scale=1 \
              -d sensor=1 \
              -d shortPath=1 \
              -d signal=1 \
              -d splitturnout=1 \
              -d Structure=1 \
              -d suppresscheckpaths=1 \
              -d switchmotor=1 \
              -d timedrawgrid=1 \
              -d timedrawtracks=1 \
              -d timemainredraw=1 \
              -d timereadfile=1 \
              -d track=1 \
              -d trainMove=1 \
              -d trainPlayback=1 \
              -d traverseBezier=1 \
              -d traverseBezierSegs=1 \
              -d traverseCornu=1 \
              -d traverseJoint=1 \
              -d traverseTurnout=1 \
              -d turnout=1 \
              -d undo=1 \
              -d zoom=1 \
          "
          rm -f $LOGFILE
          touch $LOGFILE
          set -x
          exec /app/bin/xtrkcad -v -l $LOGFILE $LOG_ALLMODULES "$@"
      - type: file
        path: ./org.xtrkcad.xtrkcad.desktop
        dest-filename: org.xtrkcad.xtrkcad.desktop
      - type: file
        path: ./org.xtrkcad.xtrkcad.metainfo.xml
        dest-filename: org.xtrkcad.xtrkcad.metainfo.xml
    build-options:
      env:
        PKG_CONFIG_PATH: "/app/lib/pkgconfig:/app/libzip/lib/pkgconfig:/app/libzip/lib64/pkgconfig:/app/mxml/lib/pkgconfig:/app/inkscape/lib/pkgconfig:/usr/lib/pkgconfig"
        LD_LIBRARY_PATH: "/app/lib:/app/inkscape/lib:/app/libzip/lib:/app/libzip/lib64:/app/mxml/lib:/usr/lib:/usr/lib/x86_64-linux-gnu"
        PATH: "/app/bin:/app/inkscape/bin:/usr/bin:/var/data/python/bin"
#      build-args:
#        - --share=network
    build-commands: 
      - |
        install -Dm755 common_source.sh /app/bin/common_source.sh
        install -Dm755 run-xtrkcad-debug.sh /app/bin/run-xtrkcad-debug.sh
        install -Dm755 run-xtrkcad.sh /app/bin/run-xtrkcad.sh
        install -Dm644 org.xtrkcad.xtrkcad.desktop /app/share/applications/org.xtrkcad.xtrkcad.desktop
        mkdir src
        mkdir build
        install -Dm644 org.xtrkcad.xtrkcad.metainfo.xml /app/share/metainfo/org.xtrkcad.xtrkcad.metainfo.xml
        XTRKCAD_CMAKE_DEBUG="-DCMAKE_TARGET_PROPERTIES=1 -DCMAKE_FIND_DEBUG_MODE=1"
        XTRKCAD_CMAKE_DEBUG=""
        cd src
        tar -xz --strip-components=1 -f ../xtrkcad-source.tar.gz
        cd ../build
        cmake -G Ninja $XTRKCAD_CMAKE_DEBUG -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX=/app -DCMAKE_C_FLAGS="-I/app/include -Wpointer-sign" ../src || exit 1
        mkdir -p /app/share/icons/hicolor/64x64/apps/
        ninja -v || { echo "***   B U I L D   F A I L E D   ***"; exit; }
        ninja -v install || { echo "***   I N S T A L L   F A I L E D   ***"; exit; }
        cp /app/share/xtrkcad/pixmaps/xtrkcad.png /app/share/icons/hicolor/64x64/apps/org.xtrkcad.xtrkcad.png
        #cp /run/build/xtrkcad/src/app/lib/xtrkcad.png /app/share/icons/hicolor/64x64/apps/org.xtrkcad.xtrkcad.png
        cd ..
        # what is not needed in final flatpak
        rm -rf /app/inkscape
        rm -rf /app/include
        rm -rf /app/share/man
        rm -rf /app/lib64/cmake
        rm -rf /app/share/doc
        rm -rf /app/share/gtk-2.0/demo
        rm -f /app/lib/libmxml*
        rm -f /app/lib/pkgconfig
        rm -rf /app/mxml
        rm -rf /app/libzip
        rm -f /app/lib/libzip.a
        rm -f /app/bin/gtk*
        rm -rf /app/share/aclocal
        rm -rf /app/lib/debug
        rm -f /app/lib/cmake /app/lib/libFreeImage*
        rm -rf /app/freeimage
        rm -f /app/bin/oex /app/bin/ovi /app/bin/oview /app/bin/vi
        rm -f /app/bin/fusermount* /app/bin/ostree /app/bin/rofiles*
        rm -f /app/etc/fuse.conf
        rm -rf /app/etc/grub.d /app/etc/ostree
        rm -rf /app/lib/*ostree*
        rm -rf /app/lib/girepos* /app/lib/tmpfile*
        rm -rf /app/lib64 /app/sbin
        rm -rf /app/share/bash-complet* /app/share/gir* /app/share/ostree
        rm -rf /app/share/licenses/org.xtrkcad.xtrkcad/vim
        rm -rf /app/libexec
        rm -f /app/bin/inkscape /app/bin/hg
        rm -rf /app/lib/python*
        rm -rf /app/share/zsh
        rm -rf /app/lib/debug

finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=cups
  - --socket=pulseaudio
  - --share=ipc
  - --device=dri
  - --filesystem=~/.xtrkcad:create
  - --filesystem=~/.gtk-bookmarks
  - --filesystem=~/Downloads
  - --filesystem=home
  - --talk-name=org.gnome.portal.Flatpak
  - --env=PS1=\[\e[1;33;41m\](org.xtrkcad.xtrkcad) $ \[\e[0m\]
