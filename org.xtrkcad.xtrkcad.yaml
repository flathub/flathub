id: org.xtrkcad.xtrkcad
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: run-xtrkcad.sh

finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=cups
  - --socket=pulseaudio
  - --share=ipc
  - --device=dri
  - --filesystem=home

cleanup-commands:
  - |
    rm -f /app/bin/inkscape
    rm -rf /app/lib/debug

modules:
  - name: libzip
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_DOC=OFF
      - -DBUILD_EXAMPLES=OFF
      - -DBUILD_REGRESS=OFF
      - -DBUILD_TOOLS=OFF
      - -DBUILD_OSSFUZZ=OFF
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DBUILD_SHARED_LIBS=OFF
      - -DENABLE_COMMONCRYPTO=OFF
      - -DENABLE_GNUTLS=OFF
      - -DENABLE_MBEDTLS=OFF
      - -DENABLE_OPENSSL=OFF
      - -DENABLE_WINDOWS_CRYPTO=OFF
      - -DENABLE_BZIP2=OFF
      - -DENABLE_LZMA=OFF
      - -DENABLE_ZSTD=OFF
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5
    sources:
      - type: archive
        url: https://github.com/nih-at/libzip/releases/download/v1.8.0/libzip-1.8.0.tar.gz
        sha256: 30ee55868c0a698d3c600492f2bea4eb62c53849bcf696d21af5eb65f3f3839e
    cleanup:
      - '*'

  - shared-modules/gtk2/gtk2.json

  - name: fake-inkscape
    buildsystem: simple
    sources:
      - type: script
        dest-filename: inkscape
        commands:
          - |
            #!/usr/bin/env bash
            rsvg-convert $*
    build-commands:
      - install -Dm755 inkscape /app/bin/inkscape

  - name: supporting-files
    buildsystem: simple
    sources:
      - type: file
        url: "https://cytranet-dal.dl.sourceforge.net/project/xtrkcad-fork/Images/logos/xtrkcad_logo_128x128.png?viasf=1"
        sha256: ccbc5a5dd014b3f9238e0920aec2b354e9549ccd62003130e28b34ff758908fd
        dest-filename: logo-128x128.png
      - type: inline
        dest-filename: common_source.sh
        contents: |
          if [ -n "$XDG_CACHE_HOME" ]; then
            rm -rf ${XDG_CACHE_HOME}/*
            cp -pr /app/share/xtrkcad/* ${XDG_CACHE_HOME}
          fi
          export XTRKCADLIB=${XDG_CACHE_HOME}
          # there is no access to host gtk3 modules
          unset GTK3_MODULES
          unset GTK_MODULES
          BOOKMARK="file://$XTRKCADLIB xtrkcad-lib"
          # gtk2 bookmarks
          FILE="$HOME/.gtk-bookmarks"
          touch $FILE
          sed "/xtrkcad-lib$/d" $FILE > ${FILE}_
          cp ${FILE}_ $FILE
          rm ${FILE}_
          echo "$BOOKMARK" >> $FILE
          env | sort | grep -E "DISPLAY|XTRK|XDG"
          echo
      - type: inline
        dest-filename: run-xtrkcad.sh
        contents: |
          #!/bin/sh
          source $(dirname $0)/common_source.sh
          exec /app/bin/xtrkcad "$@"
      - type: inline
        dest-filename: run-xtrkcad-debug.sh
        contents: |
          #!/bin/sh
          source $(dirname $0)/common_source.sh
          # set up for logging by day the app started
          DOW=$(date '+%a')
          LOGFILE="$HOME/.xtrkcad/xtrkcad_${DOW}.log"
          LOG_ALLMODULES=" \
              -d Bezier=1 \
              -d block=1 \
              -d carDlgList=1 \
              -d carDlgState=1 \
              -d carInvList=1 \
              -d carList=1 \
              -d command=1 \
              -d control=1 \
              -d Cornu=1 \
              -d cornuturnoutdesigner=1 \
              -d curve=1 \
              -d curveSegs=1 \
              -d dumpElev=1 \
              -d ease=1 \
              -d endPt=1 \
              -d group=1 \
              -d init=1 \
              -d join=1 \
              -d locale=1 \
              -d malloc=0 \
              -d mapsize=1 \
              -d modify=1 \
              -d mouse=0 \
              -d pan=1 \
              -d paraminput=1 \
              -d paramlayout=1 \
              -d params=1 \
              -d paramupdate=1 \
              -d playbackcursor=1 \
              -d print=1 \
              -d profile=1 \
              -d readTracks=1 \
              -d redraw=1 \
              -d regression=1 \
              -d scale=1 \
              -d sensor=1 \
              -d shortPath=1 \
              -d signal=1 \
              -d splitturnout=1 \
              -d Structure=1 \
              -d suppresscheckpaths=1 \
              -d switchmotor=1 \
              -d timedrawgrid=1 \
              -d timedrawtracks=1 \
              -d timemainredraw=1 \
              -d timereadfile=1 \
              -d track=1 \
              -d trainMove=1 \
              -d trainPlayback=1 \
              -d traverseBezier=1 \
              -d traverseBezierSegs=1 \
              -d traverseCornu=1 \
              -d traverseJoint=1 \
              -d traverseTurnout=1 \
              -d turnout=1 \
              -d undo=1 \
              -d zoom=1 \
          "
          rm -f $LOGFILE
          touch $LOGFILE
          set -x
          exec /app/bin/xtrkcad -v -l $LOGFILE $LOG_ALLMODULES "$@"
      - type: file
        path: ./org.xtrkcad.xtrkcad.desktop
        dest-filename: org.xtrkcad.xtrkcad.desktop
      - type: file
        path: ./org.xtrkcad.xtrkcad.metainfo.xml
        dest-filename: org.xtrkcad.xtrkcad.metainfo.xml
    build-commands:
      - |
        install -Dm755 common_source.sh /app/bin/common_source.sh
        install -Dm755 run-xtrkcad-debug.sh /app/bin/run-xtrkcad-debug.sh
        install -Dm755 run-xtrkcad.sh /app/bin/run-xtrkcad.sh
        install -Dm644 org.xtrkcad.xtrkcad.desktop /app/share/applications/org.xtrkcad.xtrkcad.desktop
        install -Dm644 org.xtrkcad.xtrkcad.metainfo.xml /app/share/metainfo/org.xtrkcad.xtrkcad.metainfo.xml
        install -Dm644 logo-128x128.png /app/share/icons/hicolor/128x128/apps/org.xtrkcad.xtrkcad.png
  - name: xtrkcad
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://sourceforge.net/projects/xtrkcad-fork/files/XTrackCad/Version%205.3.1/xtrkcad-source-5.3.1GA.tar.gz/download
        sha256: 5b02a0352c23f90b0011029c7e2c3f12a6f6779425c4c47c1f75d6b8a0db572c
        dest-filename: xtrkcad-source.tar.gz
        strip-components: 0
    config-opts:
      - -DCMAKE_BUILD_TYPE=Debug
      - -DCMAKE_C_FLAGS="-Wpointer-sign"
    builddir: true
    subdir: xtrkcad-source-5.3.1GA
  - name: xtrkcad-png
    buildsystem: simple
    build-commands:
      - |
        install -Dm644 /app/share/xtrkcad/pixmaps/xtrkcad.png /app/share/icons/hicolor/64x64/apps/org.xtrkcad.xtrkcad.png
