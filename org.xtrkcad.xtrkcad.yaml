id: org.xtrkcad.xtrkcad
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
#runtime: org.freedesktop.Platform
#runtime-version: '24.08'
#sdk: org.freedesktop.Sdk
command: /app/bin/run-xtrkcad.sh
#metadata: |
#  [Context]
#  portals=gtk

modules:
  - name: freeimage
    buildsystem: cmake
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app/freeimage
      - -DBUILD_SHARED_LIBS=ON
    sources:
      - type: archive
        url: https://github.com/danoli3/FreeImage/archive/refs/tags/3.19.10.tar.gz
        sha256: 7dd22eeb95e967e541d864da8b3bc03e3050983f2de2cb1c09a60d28e679c6f2
    post-install:
      - mkdir -p /app/include
      - mkdir -p /app/lib
      - ln -s /app/freeimage/include/* /app/include
      - ln -s /app/freeimage/lib/* /app/lib
  - name: libzip
    buildsystem: cmake
    config-opts:
      - -DBUILD_DOC=OFF
      - -DBUILD_EXAMPLES=OFF
      - -DBUILD_REGRESS=OFF
      - -DBUILD_TOOLS=OFF
      - -DBUILD_OSSFUZZ=OFF
      - -DCMAKE_INSTALL_PREFIX=/app/libzip
      - -DBUILD_SHARED_LIBS=OFF
      - -DENABLE_COMMONCRYPTO=OFF
      - -DENABLE_GNUTLS=OFF
      - -DENABLE_MBEDTLS=OFF
      - -DENABLE_OPENSSL=OFF
      - -DENABLE_WINDOWS_CRYPTO=OFF
      - -DENABLE_BZIP2=OFF
      - -DENABLE_LZMA=OFF
      - -DENABLE_ZSTD=OFF
    sources:
      - type: archive
        url: https://github.com/nih-at/libzip/releases/download/v1.8.0/libzip-1.8.0.tar.gz
        sha256: 30ee55868c0a698d3c600492f2bea4eb62c53849bcf696d21af5eb65f3f3839e
    post-install:
      - mkdir -p /app/include
      - mkdir -p /app/lib
      - ln -s /app/libzip/include/* /app/include
      - ln -s /app/libzip/lib/libzip.a /app/lib
  - name: mxml
    buildsystem: simple
    build-commands:
      - ./configure --exec_prefix=/app/mxml --prefix=/app/mxml
      - make
      - make install
      - mkdir -p /app/include
      - mkdir -p /app/lib
      - ln -s /app/mxml/include/* /app/include
      - ln -s /app/mxml/lib/* /app/lib
    sources:
      - type: archive
# v4 changes names from mxml to mxml4 whch we haven't migrated yet
        url: https://github.com/michaelrsweet/mxml/archive/refs/tags/v3.3.1.tar.gz
        sha256: 59eba16ce43765f2e2a6cf4873a58d317be801f1e929647d85da9f171e41e9ac
  - name: gtk2
    buildsystem: autotools
    build-options:
      env:
        CFLAGS: "-Wno-incompatible-pointer-types -Wno-implicit-int"
        CXXFLAGS: "-Wno-incompatible-pointer-types -Wno-implicit-int"
    sources:
      - type: archive
        url: "https://gitlab.gnome.org/GNOME/gtk/-/archive/2.24.33/gtk-2.24.33.tar.gz"
        sha256: dedfaf04952434c5e3e1ce4de373ac7474d12da2d99b0afc947ef1983df64601
    config-opts:
      - "--prefix=/app"
      - "--disable-introspection"
      - "--enable-shared"
      - "--disable-static"
      - "--enable-gtk-doc-html=no"
#    make-args:
#      - "V=1"
#      - "-j 1"
#  add in tiny vim for debug purposes (removed later)
  - name: vim
    buildsystem: simple
    sources:
      - type: git
        url: "https://github.com/johnsonjh/OpenVi.git"
    build-commands:
      - sed -i "s/root:bin/$USER:$USER/" GNUmakefile
      - make
      - make install
      - ln -s /app/bin/ovi /app/bin/vi
    build-options:
      env:
        PREFIX: "/app"
#  - name: fuse
#    buildsystem: simple
#    sources:
#      - type: archive
#        url: "https://github.com/libfuse/libfuse/releases/download/fuse-3.17.4/fuse-3.17.4.tar.gz"
#        sha256: df9e40ae927b73dc702d0bce7925c0c618af47ad0b13204fbf2be66e54d8528b
#    build-commands:
#      - |
#        mkdir build
#        cd build
#        meson setup --prefix /app ..
#        meson configure -D prefix=/app -D useroot=false --no-pager
#        meson setup --prefix /app --reconfigure ..
#        ninja
#        ninja install
#  - name: ostree
#    buildsystem: simple
#    sources:
#      - type: git
#        url: "https://github.com/ostreedev/ostree.git"
#        tag: v2025.6
#    build-options:
#      env:
#        PKG_CONFIG_PATH: "/app/lib64/pkgconfig"
#        LD_LIBRARY_PATH: "/app/lib64"
#        BASH_COMPLETIONSDIR: "/app/share/bash-completion/completions/"
#    build-commands:
#      - |
#        env NOCONFIGURE=1 ./autogen.sh
#        ./configure --prefix=/app
#        make
#        make install
#  - name: inkscape
#    buildsystem: simple
#    build-options:
#      env:
#        OSTREE_REPO: "tmp-repo"
#        APP_ID: "org.inkscape.Inkscape"
#        CHECKOUT_DIR: "/app/inkscape"
#      secret-env:
#        - DISPLAY
#      build-args:
#        - --socket=x11
#        - --socket=wayland
#        - --socket=session-bus
#        - --share=network
#        - --share=ipc
#        - --device=dri
#        - --filesystem=host-etc
#    build-commands:
#      - |
#        ostree init --repo=$OSTREE_REPO --mode=bare-user
#        ostree remote add flathub https://dl.flathub.org/repo/ --no-gpg-verify
#        ostree pull flathub app/${APP_ID}/x86_64/stable
#        ostree checkout --union --user-mode --subpath=files app/${APP_ID}/x86_64/stable $CHECKOUT_DIR
  - name: fake-inkscape
    buildsystem: simple
    sources:
      - type: inline
        dest-filename: inkscape
        contents: |
            #!/usr/bin/env bash
            rsvg-convert $*
    build-commands:
      - install -Dm755 inkscape /app/bin/inkscape
#  - name: debug
#    buildsystem: simple
#    no-make-install: true
#    build-commands:
#      - echo "D E B U G   B E G I N"
#      - find /app -type f -o -type l
#      - echo "D E B U G   E N D"
#  - name: wheel
#    buildsystem: simple
#    sources:
#      - type: shell
#        commands:
#          - |
#            pip3 install --no-index --upgrade pip setuptools wheel
#    build-commands:
#      - pip3 install --no-index --upgrade pip setuptools wheel
  - name: mercurial
    buildsystem: simple
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/1d/7d/70c62fe69a43d47eb09c95451249b3b2b3733bfc2a4c1ca3ca82c82ec476/mercurial-7.1.2-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.manylinux_2_28_x86_64.whl
        sha256: c311d37115ffd62b6cb04f6c90100cc237309e43657b9dc32d130b91ef6b5d62
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=/app mercurial
  - name: xtrkcad
    buildsystem: simple
    sources:
      - type: file
        url: https://sourceforge.net/projects/xtrkcad-fork/files/XTrackCad/Version%205.3.1/xtrkcad-source-5.3.1GA.tar.gz/download
        sha256: 5b02a0352c23f90b0011029c7e2c3f12a6f6779425c4c47c1f75d6b8a0db572c
        dest-filename: xtrkcad-source.tar.gz
      - type: inline
        dest-filename: common_source.sh
        contents: |
          echo
          echo "XTrackCAD (flatpak) built Sun Nov 23 21:31:25 UTC 2025 changeset (6148)"
          echo
          export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.var/app/org.xtrkcad.xtrkcad/config}"
          export XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.var/app/org.xtrkcad.xtrkcad/cache}"
          export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.var/app/org.xtrkcad.xtrkcad/data}"
          # a copy was requested, a file chooser/picker is using the host for access
          echo "  cp -pr /app/share/xtrkcad/* ${XDG_CACHE_HOME}"
          echo
          mkdir -p ${XDG_CACHE_HOME}
          rm -rf ${XDG_CACHE_HOME}/*
          cp -pr /app/share/xtrkcad/* ${XDG_CACHE_HOME}
          export XTRKCADLIB=${XDG_CACHE_HOME}
          export XTRKCADBETALIB=${XDG_CACHE_HOME}
          export XTRKCAD_GTKLIB=${XDG_CACHE_HOME}
          export XTRKCAD_GTKBETALIB=${XDG_CACHE_HOME}
          # there is no access to host gtk3 modules
          unset GTK3_MODULES
          unset GTK_MODULES
          BOOKMARK="file://$XTRKCADLIB xtrkcad-lib"
          # gtk2 bookmarks
          FILE="$HOME/.gtk-bookmarks"
          touch $FILE
          sed "/xtrkcad-lib$/d" $FILE > $FILE
          echo "$BOOKMARK" >> "$FILE"
          # gtk3 bookmarks
          FILE="$XDG_CONFIG_HOME/gtk-3.0/bookmarks"
          mkdir -p $(dirname $FILE)
          touch $FILE
          sed "/xtrkcad-lib$/d" $FILE > $FILE
          echo "$BOOKMARK" >> "$FILE"
          #export GTK_USE_PORTAL=1
          #export XDG_CURRENT_DESKTOP=GNOME
          env | sort | grep -E "DISPLAY|XTRK|XDG"
          echo
      - type: inline
        dest-filename: run-xtrkcad.sh
        contents: |
          #!/bin/sh
          source $(dirname $0)/common_source.sh
          exec /app/bin/xtrkcad "$@"
      - type: inline
        dest-filename: run-xtrkcad-debug.sh
        contents: |
          #!/bin/sh
          source $(dirname $0)/common_source.sh
          # set up for logging by day the app started
          DOW=$(date '+%a')
          LOGFILE="$HOME/.xtrkcad/xtrkcad_${DOW}.log"
          LOG_ALLMODULES=" \
              -d Bezier=1 \
              -d block=1 \
              -d carDlgList=1 \
              -d carDlgState=1 \
              -d carInvList=1 \
              -d carList=1 \
              -d command=1 \
              -d control=1 \
              -d Cornu=1 \
              -d cornuturnoutdesigner=1 \
              -d curve=1 \
              -d curveSegs=1 \
              -d dumpElev=1 \
              -d ease=1 \
              -d endPt=1 \
              -d group=1 \
              -d init=1 \
              -d join=1 \
              -d locale=1 \
              -d malloc=0 \
              -d mapsize=1 \
              -d modify=1 \
              -d mouse=0 \
              -d pan=1 \
              -d paraminput=1 \
              -d paramlayout=1 \
              -d params=1 \
              -d paramupdate=1 \
              -d playbackcursor=1 \
              -d print=1 \
              -d profile=1 \
              -d readTracks=1 \
              -d redraw=1 \
              -d regression=1 \
              -d scale=1 \
              -d sensor=1 \
              -d shortPath=1 \
              -d signal=1 \
              -d splitturnout=1 \
              -d Structure=1 \
              -d suppresscheckpaths=1 \
              -d switchmotor=1 \
              -d timedrawgrid=1 \
              -d timedrawtracks=1 \
              -d timemainredraw=1 \
              -d timereadfile=1 \
              -d track=1 \
              -d trainMove=1 \
              -d trainPlayback=1 \
              -d traverseBezier=1 \
              -d traverseBezierSegs=1 \
              -d traverseCornu=1 \
              -d traverseJoint=1 \
              -d traverseTurnout=1 \
              -d turnout=1 \
              -d undo=1 \
              -d zoom=1 \
          "
          rm -f $LOGFILE
          touch $LOGFILE
          set -x
          exec /app/bin/xtrkcad -v -l $LOGFILE $LOG_ALLMODULES "$@"
      - type: file
        path: ./org.xtrkcad.xtrkcad.desktop
        dest-filename: org.xtrkcad.xtrkcad.desktop
      - type: file
        path: ./org.xtrkcad.xtrkcad.metainfo.xml
        dest-filename: org.xtrkcad.xtrkcad.metainfo.xml
    build-options:
      env:
        PKG_CONFIG_PATH: "/app/lib/pkgconfig:/app/libzip/lib/pkgconfig:/app/libzip/lib64/pkgconfig:/app/mxml/lib/pkgconfig:/app/inkscape/lib/pkgconfig:/usr/lib/pkgconfig"
        LD_LIBRARY_PATH: "/app/lib:/app/inkscape/lib:/app/libzip/lib:/app/libzip/lib64:/app/mxml/lib:/usr/lib:/usr/lib/x86_64-linux-gnu"
        PATH: "/app/bin:/app/inkscape/bin:/usr/bin:/var/data/python/bin"
#      build-args:
#        - --share=network
    build-commands: 
      - |
        set -x
        BUILD_DATE=$(date '+%Y-%m-%d')
        BUILD_TIMESTAMP="$(date -u)"
        install -Dm755 run-xtrkcad-debug.sh /app/bin/run-xtrkcad-debug.sh
        install -Dm755 run-xtrkcad.sh /app/bin/run-xtrkcad.sh
        install -Dm644 org.xtrkcad.xtrkcad.desktop /app/share/applications/org.xtrkcad.xtrkcad.desktop
        mkdir src
        mkdir build
        cd src
        tar -xz --strip-components=1 -f ../xtrkcad-source.tar.gz
        CHANGESET=$(hg log -r . '{rev}')
        cd ..
        if [ -n "$CHANGESET" ]; then
          sed "2s/built.*/built $BUILD_TIMESTAMP changeset ($CHANGESET)/" common_source.sh > common_source.sh
        else
          sed "2s/built.*/built $BUILD_TIMESTAMP/" common_source.sh > common_source.sh
        fi
        install -Dm755 common_source.sh /app/bin/common_source.sh
        sed "s/date=\".*\"/date=\"$BUILD_DATE\"/" org.xtrkcad.xtrkcad.metainfo.xml > org.xtrkcad.xtrkcad.metainfo.xml
        install -Dm644 org.xtrkcad.xtrkcad.metainfo.xml /app/share/metainfo/org.xtrkcad.xtrkcad.metainfo.xml
        XTRKCAD_CMAKE_DEBUG="-DCMAKE_TARGET_PROPERTIES=1 -DCMAKE_FIND_DEBUG_MODE=1"
        XTRKCAD_CMAKE_DEBUG=""
        cd build
        cmake -G Ninja $XTRKCAD_CMAKE_DEBUG -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX=/app -DCMAKE_C_FLAGS="-I/app/include -Wpointer-sign" ../src || exit 1
        mkdir -p /app/share/icons/hicolor/64x64/apps/
        if false; then
          ninja -v
          ninja -v install
          echo "DEBUG: install complete"
          echo "XTRKCADPREFIX=/app"
          echo "XTRKCADSHARE=share/xtrkcad"
          cp /app/share/xtrkcad/pixmaps/xtrkcad.png /app/share/icons/hicolor/64x64/apps/org.xtrkcad.xtrkcad.png
          #cp /run/build/xtrkcad/src/app/lib/xtrkcad.png /app/share/icons/hicolor/64x64/apps/org.xtrkcad.xtrkcad.png
          cd ..
          # debug:
          echo -e "\nSLEEPING for debug purposes"
          echo -e "\nin another window, run\n  flatpak enter \$(flatpak ps | grep Sdk | cut -f1) bash\n"
          echo "export PKG_CONFIG_PATH=\"/app/lib/pkgconfig:/app/libzip/lib/pkgconfig:/app/libzip/lib64/pkgconfig:/app/mxml/lib/pkgconfig:/app/inkscape/lib/pkgconfig:/usr/lib/pkgconfig\""
          echo "export LD_LIBRARY_PATH=\"/app/lib:/app/inkscape/lib:/app/libzip/lib:/app/libzip/lib64:/app/mxml/lib:/usr/lib:/usr/lib/x86_64-linux-gnu\""
          echo "export PATH=\"/app/bin:/app/inkscape/bin:/usr/bin:\$PATH\""
          echo "cd /run/build/xtrkcad/build  # to check build environment or build with ninja"
          echo "cd /run/build/xtrkcad/src    # the source"
          sleep 3600
        else
          ninja -v
          ninja -v install
          cp /app/share/xtrkcad/pixmaps/xtrkcad.png /app/share/icons/hicolor/64x64/apps/org.xtrkcad.xtrkcad.png
          #cp /run/build/xtrkcad/src/app/lib/xtrkcad.png /app/share/icons/hicolor/64x64/apps/org.xtrkcad.xtrkcad.png
          cd ..
          # what is not needed in final flatpak
          rm -rf /app/inkscape
          rm -rf /app/include
          rm -rf /app/share/man
          rm -rf /app/lib64/cmake
          rm -rf /app/share/doc
          rm -rf /app/share/gtk-2.0/demo
          rm -f /app/lib/libmxml*
          rm -f /app/lib/pkgconfig
          rm -rf /app/mxml
          rm -rf /app/libzip
          rm -f /app/lib/libzip.a
          rm -f /app/bin/gtk*
          rm -rf /app/share/aclocal
          rm -rf /app/lib/debug
          rm -f /app/lib/cmake /app/lib/libFreeImage*
          rm -rf /app/freeimage
          rm -f /app/bin/oex /app/bin/ovi /app/bin/oview /app/bin/vi
          rm -f /app/bin/fusermount* /app/bin/ostree /app/bin/rofiles*
          rm -f /app/etc/fuse.conf
          rm -rf /app/etc/grub.d /app/etc/ostree
          rm -rf /app/lib/*ostree*
          rm -rf /app/lib/girepos* /app/lib/tmpfile*
          rm -rf /app/lib64 /app/sbin
          rm -rf /app/share/bash-complet* /app/share/gir* /app/share/ostree
          rm -rf /app/share/licenses/org.xtrkcad.xtrkcad/vim
          rm -rf /app/libexec
        fi
finish-args:
  # order matters: wayland first if have wayland host
  - --socket=wayland
  #- --socket=x11
  - --socket=fallback-x11
  - --socket=session-bus
  - --socket=cups
  - --socket=pulseaudio
  - --share=ipc
  - --device=dri
  - --filesystem=~/.xtrkcad:create
  #- --filesystem=~/.themes
  #- --filesystem=~/.icons
  #- --filesystem=~/.config/gtk-3.0/:create
  #- --filesystem=~/.config/gtk-4.0/:create
  - --filesystem=~/.gtk-bookmarks
  - --filesystem=~/.local/share:create
  - --filesystem=~/.local/state:create
  # if home directory access not allowed, define some common ones for plans
  #- --filesystem=~/.local/share/xtrkcad:create
  #- --filesystem=~/Documents:create
  #- --filesystem=~/xtrkcad:create
  #- --filesystem=~/XtrackCAD:create
  - --filesystem=~/Downloads
  - --filesystem=xdg-data/applications
  - --filesystem=xdg-data/icons
  - --filesystem=xdg-config/gtk-3.0:create
  - --filesystem=xdg-config/gtk-4.0:create
  # home directory access
  - --filesystem=home
  # full system access
  #- --filesystem=host
  #- --talk-name=org.gnome.portal.*
  #- --talk-name=org.gnome.*
  - --talk-name=org.gnome.portal.Flatpak
  #- --system-talk-name=org.gnome.*
  #- --talk-name=org.freedesktop.portal.Flatpak
  #- --env=GTK_USE_PORTAL=1
  #- --env=XDG_CURRENT_DESKTOP=GNOME
  #- --env=GDK_BACKEND=wayland
  #- --env=QT_QPA_PLATFORMTHEME=gtk3
  - --env=PS1=\[\e[1;33;41m\](org.xtrkcad.xtrkcad) $ \[\e[0m\]
