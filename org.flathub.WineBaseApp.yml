id: org.flathub.WineBaseApp
branch: "20.08"
sdk: org.freedesktop.Sdk
runtime: org.freedesktop.Platform
runtime-version: "20.08"
sdk-extensions:
  - org.freedesktop.Sdk.Compat.i386
  - org.freedesktop.Sdk.Extension.toolchain-i386
separate-locales: false
cleanup:
  - /lib/*.a
  - /lib/*.la
  - /lib32/*.a
  - /lib32/*.la
  - /share/man
  - /share/doc
cleanup-commands:
  - mkdir -p ${FLATPAK_DEST}/lib{,32}/ffmpeg
add-extensions:
  org.freedesktop.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: "20.08"

  org.freedesktop.Platform.Compat.i386.Debug:
    directory: lib/debug/lib/i386-linux-gnu
    version: "20.08"
    no-autodownload: true

  org.freedesktop.Platform.GL32:
    directory: lib/i386-linux-gnu/GL
    version: "1.4"
    versions: "20.08;1.4"
    subdirectories: true
    no-autodownload: true
    autodelete: false
    add-ld-path: lib
    merge-dirs: vulkan/icd.d;glvnd/egl_vendor.d;OpenCL/vendors;lib/dri;lib/d3d;vulkan/explicit_layer.d
    download-if: active-gl-driver
    enable-if: active-gl-driver

  org.freedesktop.Platform.VAAPI.Intel.i386:
    directory: lib/i386-linux-gnu/dri/intel-vaapi-driver
    version: "20.08"
    subdirectories: true
    no-autodownload: true
    autodelete: false
    add-ld-path: lib
    download-if: active-gl-driver
    enable-if: active-gl-driver

  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    add-ld-path: "."
    version: "20.08"
    autodelete: false

  org.freedesktop.Platform.ffmpeg_full.i386:
    directory: lib32/ffmpeg
    add-ld-path: "."
    version: "20.08"
    autodelete: false

modules:
  - name: bundle-setup
    buildsystem: simple
    build-commands:
      - mkdir -p /app{,/lib/debug}/lib/i386-linux-gnu
      - install -D -m 0644 ld.so.conf -t /app/etc
    sources:
      - type: file
        path: ld.so.conf

  - generated/gl-libs.json
  - generated/wine-deps.json

  - name: winetricks
    no-autogen: true
    make-args:
      - PREFIX=/app
    make-install-args:
      - PREFIX=/app
    sources:
      - type: git
        url: "https://github.com/Winetricks/winetricks.git"
        tag: "20200412"
    modules:

      - name: p7zip
        no-autogen: true
        make-args:
          - all2
          - OPTFLAGS=-O2 -g
          - DEST_HOME=/app
          - DEST_BIN=/app/bin
          - DEST_SHARE=/app/lib/p7zip
          - DEST_MAN=/app/share/man
        make-install-args:
          - DEST_HOME=/app
          - DEST_BIN=/app/bin
          - DEST_SHARE=/app/lib/p7zip
          - DEST_MAN=/app/share/man
        sources:
          - type: archive
            url: "https://downloads.sourceforge.net/p7zip/p7zip_16.02_src_all.tar.bz2"
            sha256: 5eb20ac0e2944f6cb9c2d51dd6c4518941c185347d4089ea89087ffdd6e2341f
          - type: patch
            paths:
              - patches/p7zip/gcc10-conversion.patch
          - type: shell
            only-arches:
              - "x86_64"
            commands:
              - ln -sf makefile.linux_amd64_asm makefile.machine
          - type: shell
            only-arches:
              - "i386"
            commands:
              - ln -sf makefile.linux_x86_asm_gcc_4.X makefile.machine
        modules:

          - name: yasm
            buildsystem: cmake-ninja
            sources:
              - type: archive
                url: "https://github.com/yasm/yasm/archive/v1.3.0.tar.gz"
                sha256: f708be0b7b8c59bc1dbe7134153cd2f31faeebaa8eec48676c10f972a1f13df3
            cleanup:
              - "*"

      - name: cabextract
        sources:
          - type: archive
            url: "https://www.cabextract.org.uk/cabextract-1.9.1.tar.gz"
            sha256: afc253673c8ef316b4d5c29cc4aa8445844bee14afffbe092ee9469405851ca7

  - name: check-build
    buildsystem: simple
    build-commands:
      - bash check.sh
    sources:
      - type: file
        path: check.sh
