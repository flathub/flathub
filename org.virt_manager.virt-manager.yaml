app-id: org.virt_manager.virt-manager
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: virt-manager
rename-icon: virt-manager
rename-desktop-file: virt-manager.desktop
rename-appdata-file: virt-manager.appdata.xml
finish-args:
  - --device=dri
  # TODO: thoroughly test usb redirection, it seems to work somehow without workarounds.
  #       are workaround are still needed?
  #         * udev rules and group membership for user?
  #         * an suid helper on the host and flatpak-spawn wrapper in sandbox? polkit?
  #         * polkit rules can't work in the sandbox, need to document all the polkit helpers, those
  #           probably should be available on the host with their polkit rules,
  #         * supply hardlinked binaries to run on the host? rules can be dropped into /etc
  #         * handling usbredirserver calls? or spice-client-glib-usb-acl-helper from spice-gtk?
  # usb device redirection
  - --device=all
  - --filesystem=xdg-documents
  - --filesystem=xdg-download
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --filesystem=xdg-public-share
  - --filesystem=xdg-videos
  # unix socket access
  - --filesystem=/run/libvirt
  # ssh configuration dir access, includes config, known_hosts, and etc.
  #   not xdg dirs spec compliant, so without the proper filesystem access permission the ssh
  #     configuration won't be saved between running sessions.
  #   enabled by default, if you don't like giving the sandbox this access then override it with
  #     flatpak-override or flatseal and add a `--persist=.ssh` to keep the ssh config dir in
  #     HOME/.var/app/org.virt_manager.virt-manager/.ssh
  #   using persist also means that the sandbox won't have access to your private key files so it
  #     won't be able to change them, if this is even something to be concerned about
  #     instead of giving access to the keys, give access to the ssh-agent
  #   i'm using a patched openssh build on the host to set the ssh config folder in .config/ssh so
  #     i'm forced to set `--persist=.ssh`
  - --filesystem=~/.ssh
  #- --persist=.ssh
  # ssh-agent pid and socket
  #   access to the running ssh-agent on the host
  #   it's presumed that SSH_AGENT_PID and SSH_AUTH_SOCK are known in the sandbox, and that
  #     SSH_AUTH_SOCK is accessible in the sandbox
  #   the default, `--socket=ssh-auth`, bind-mounts the xdg-run/ssh-auth, only used by gnome-keyring's
  #     ssh agent but it's a good location as any to put the ssh-agent file socket
  #   if you're not using gnome-keyring's ssh agent then you gonna need to force your ssh-agent to create
  #     the socket in this mentioned dir, that you will also need to create before starting the app,
  #     or in another location, and then you should add the suitable filesystem permission.
  #     just make sure to only bind-mount an existing folder, and don't directly bind-mount the socket.
  #   see example in the ssh-agents section in the archwiki ssh keys page
  #     https://wiki.archlinux.org/index.php/SSH_keys#SSH_agents
  - --socket=ssh-auth
  #   custom ssh socket location
  #- --filesystem=xdg-run/ssh
  - --own-name=org.kde.*
  - --own-name=org.virt-manager.virt-manager
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=wayland
  # virt-manager implements fetching secrets over dbus without importing libsecret, so no added dependency
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.StatusNotifierWatcher
  # TODO: figure out if notifications is needed
  #- --talk-name=org.freedesktop.Notifications
  # TODO: also enable pcsc and cups?
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/applications/mimeinfo.cache
  - /share/bash-completion
  - /share/icons/hicolor/icon-theme.cache
  - /share/man
  - '*.la'
modules:
  - name: virt-manager
    buildsystem: simple
    build-commands:
      - python setup.py configure --prefix=${FLATPAK_DEST}
      - python setup.py build
      - python setup.py --no-update-icon-cache --no-compile-schemas install --root=/
      - python -m compileall ${FLATPAK_DEST}/share/virt-manager
      - python -O -m compileall ${FLATPAK_DEST}/share/virt-manager
      - glib-compile-schemas ${FLATPAK_DEST}/share/glib-2.0/schemas
    sources:
      - type: archive
        url: https://github.com/virt-manager/virt-manager/archive/v4.1.0.tar.gz
        sha256: 2440f5517a5d3684a8e4858d87e5a946c54e5b918d52bf80ac7a9f05ea41f1b8
        x-checker-data:
          type: anitya
          project-id: 8183
          stable-only: true
          url-template: https://github.com/virt-manager/virt-manager/archive/v$version.tar.gz
      - type: patch
        path: virt-manager-disable-man-pages.patch
      - type: patch
        path: virt-manager-systray-icon-use-reverse-dns-naming-convention.patch

    modules:
      - shared-modules/intltool/intltool-0.51.json
      - shared-modules/libappindicator/libappindicator-gtk3-introspection-12.10.json

      - name: libvirt
        buildsystem: meson
        build-options:
          cflags: -I/app/include/tirpc
        config-opts:
          - --libexec=/app/lib/libvirt
          - --sbindir=/app/bin
          - --localstatedir=/var
          - -Drunstatedir=/run
          - -Drpath=enabled
          - -Dqemu_group=kvm
          - -Ddocs=enabled
          - -Dtests=disabled
          - -Dstorage_mpath=disabled
          - -Dfirewalld=disabled
          - -Dfirewalld_zone=disabled
          - -Dinit_script=none
          - -Dsysctl_config=disabled
        sources:
          - type: archive
            url: https://libvirt.org/sources/libvirt-10.9.0.tar.xz
            sha256: 2473db10bb9b9992c02897cef4b26ae58885ff357cea5f9ce3ec9e008f6b5b3a
            x-checker-data:
              type: anitya
              project-id: 13830
              stable-only: true
              url-template: https://libvirt.org/sources/libvirt-$version.tar.xz
        cleanup:
          - /etc/logrotate.d
          - /share/doc
        modules:
          - name: libnl
            config-opts:
              - --enable-cli=no
              - --disable-static
            sources:
              - type: archive
                url: https://github.com/thom311/libnl/releases/download/libnl3_11_0/libnl-3.11.0.tar.gz
                sha256: 2a56e1edefa3e68a7c00879496736fdbf62fc94ed3232c0baba127ecfa76874d
                x-checker-data:
                  type: json
                  url: https://api.github.com/repos/thom311/libnl/releases/latest
                  version-query: .tag_name | ( sub("^libnl"; "") | gsub("_"; ".") )
                  url-query: .assets[] | select(.name=="libnl-" + $version + ".tar.gz") |
                    .browser_download_url
            cleanup:
              - /etc
              - /share/man
          - name: libtirpc
            config-opts:
              - --disable-gssapi
            sources:
              - type: archive
                url: https://downloads.sourceforge.net/sourceforge/libtirpc/libtirpc-1.3.6.tar.bz2
                sha256: bbd26a8f0df5690a62a47f6aa30f797f3ef8d02560d1bc449a83066b5a1d3508
                x-checker-data:
                  type: anitya
                  project-id: 1740
                  stable-only: true
                  url-template: https://downloads.sourceforge.net/sourceforge/libtirpc/libtirpc-$version.tar.bz2
          - name: python-docutils
            buildsystem: simple
            build-commands:
              - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
            sources:
              - type: archive
                url: https://files.pythonhosted.org/packages/6b/5c/330ea8d383eb2ce973df34d1239b3b21e91cd8c865d21ff82902d952f91f/docutils-0.19.tar.gz
                sha256: 33995a6753c30b7f577febfc2c50411fec6aac7f7ffeb7c4cfe5991072dcf9e6
                x-checker-data:
                  type: pypi
                  name: docutils
            # cleanup:
            #   - '*'
          - name: rpcsvc-proto
            sources:
              - type: archive
                url: https://github.com/thkukuk/rpcsvc-proto/archive/v1.4.4/rpcsvc-proto-1.4.4.tar.gz
                sha256: 7988641deae8463303b6273d7af98ece09111c385d4c9134a142a5fad3cdfef8
                x-checker-data:
                  type: anitya
                  project-id: 155452
                  stable-only: true
                  url-template: https://github.com/thkukuk/rpcsvc-proto/archive/v$version/rpcsvc-proto-$version.tar.gz
              - type: shell
                commands:
                  - autoreconf -ifv
            cleanup:
              - '*'

      - name: libvirt-glib
        buildsystem: meson
        config-opts:
          - -Drpath=enabled
          - -Ddocs=disabled
          - -Dtests=disabled
          - -Dintrospection=enabled
          - -Dvapi=disabled
        sources:
          - type: archive
            url: https://libvirt.org/sources/glib/libvirt-glib-5.0.0.tar.xz
            sha256: 9bfec346382416a3575d87299bc641b2a464aa519fd9b1287e318aa43a2f3b8b
            x-checker-data:
              type: anitya
              project-id: 11560
              stable-only: true
              url-template: https://libvirt.org/sources/glib/libvirt-glib-$version.tar.xz
        cleanup:
          - /share/gtk-doc
        modules:
          - name: libcap-ng
            config-opts:
              - --enable-static=no
            sources:
              - type: archive
                url: https://github.com/stevegrubb/libcap-ng/archive/v0.8.5.tar.gz
                sha256: e4be07fdd234f10b866433f224d183626003c65634ed0552b02e654a380244c2
                x-checker-data:
                  type: anitya
                  project-id: 1570
                  stable-only: true
                  url-template: https://github.com/stevegrubb/libcap-ng/archive/v$version.tar.gz
            cleanup:
              - /bin
              - /share/aclocal

      - name: libvirt-python
        buildsystem: simple
        build-commands:
          - python3 setup.py build
          - python3 setup.py install --skip-build --prefix=/app --root=/ --optimize=1
        sources:
          - type: archive
            url: https://libvirt.org/sources/python/libvirt-python-10.9.0.tar.gz
            sha256: 44833fc6017fc88e43586a78c028a89fa1e1c1bae5089160c62356308ac9a37a
            x-checker-data:
              type: anitya
              project-id: 13829
              stable-only: true
              url-template: https://libvirt.org/sources/python/libvirt-python-$version.tar.gz

      - name: gtk-vnc
        buildsystem: meson
        sources:
          - type: archive
            url: https://download.gnome.org/sources/gtk-vnc/1.3/gtk-vnc-1.3.1.tar.xz
            sha256: 512763ac4e0559d0158b6682ca5dd1a3bd633f082f5e4349d7158e6b5f80f1ce
            x-checker-data:
              type: anitya
              project-id: 13142
              stable-only: true
              url-template: https://download.gnome.org/sources/gtk-vnc/$version0.$version1/gtk-vnc-$version.tar.xz

      - name: spice-gtk
        buildsystem: meson
        config-opts:
          - -Dgtk_doc=disabled
          - -Dvapi=disabled
          - -Dusb-acl-helper-dir=/app/lib
        sources:
          - type: archive
            url: https://www.spice-space.org/download/gtk/spice-gtk-0.42.tar.xz
            sha256: 9380117f1811ad1faa1812cb6602479b6290d4a0d8cc442d44427f7f6c0e7a58
            x-checker-data:
              type: anitya
              project-id: 11576
              stable-only: true
              url-template: https://www.spice-space.org/download/gtk/spice-gtk-$version.tar.xz
        modules:
          - name: python-pyparsing
            buildsystem: simple
            build-commands:
              - pip3 install --verbose --exists-action=i --no-index --find-links=file://${PWD}
                --prefix=${FLATPAK_DEST} pyparsing --no-build-isolation
            sources:
              - type: file
                url: https://files.pythonhosted.org/packages/be/ec/2eb3cd785efd67806c46c13a17339708ddc346cbb684eade7a6e6f79536a/pyparsing-3.2.0-py3-none-any.whl
                sha256: 93d9577b88da0bbea8cc8334ee8b918ed014968fd2ec383e868fb8afb1ccef84
                x-checker-data:
                  type: pypi
                  name: pyparsing
                  packagetype: bdist_wheel
            cleanup:
              - '*'
          - name: libcacard
            sources:
              - type: archive
                url: https://www.spice-space.org/download/libcacard/libcacard-2.8.1.tar.xz
                sha256: fbbf4de8cb7db5bdff5ecb672ff0dbe6939fb9f344b900d51ba6295329a332e7
                x-checker-data:
                  type: anitya
                  project-id: 18776
                  stable-only: true
                  url-template: https://www.spice-space.org/download/libcacard/libcacard-$version.tar.xz
          - name: phodav
            buildsystem: meson
            config-opts:
              - -Dgtk_doc=disabled
              - -Dsbindir=bin
            sources:
              - type: archive
                url: https://download.gnome.org/sources/phodav/3.0/phodav-3.0.tar.xz
                sha256: 392ec2d06d50300dcff1ef269a2a985304e29bce3520002fca29f2edc1d138d1
                x-checker-data:
                  type: anitya
                  project-id: 9670
                  stable-only: true
                  url-template: https://download.gnome.org/sources/phodav/$version0.$version1/phodav-$version.tar.xz
          - shared-modules/libusb/libusb.json
          - name: usbredir
            buildsystem: meson
            config-opts:
              - --sbindir=/app/bin
            sources:
              - type: archive
                url: https://spice-space.org/download/usbredir/usbredir-0.14.0.tar.xz
                sha256: 924dfb5c78328fae45a4c93a01bc83bb72c1310abeed119109255627a8baa332
                x-checker-data:
                  type: anitya
                  project-id: 16012
                  stable-only: true
                  url-template: https://spice-space.org/download/usbredir/usbredir-$version.tar.xz
          - name: usbutils
            buildsystem: meson
            # config-opts:
            #   - --datadir=/app/share/hwdata
            #   - --disable-zlib
            sources:
              - type: archive
                url: https://www.kernel.org/pub/linux/utils/usb/usbutils/usbutils-018.tar.xz
                sha256: 83f68b59b58547589c00266e82671864627593ab4362d8c807f50eea923cad93
                x-checker-data:
                  type: anitya
                  project-id: 5061
                  stable-only: true
                  url-template: https://www.kernel.org/pub/linux/utils/usb/usbutils/usbutils-$version.tar.xz
            modules:
              - name: hwids
                buildsystem: simple
                build-commands:
                  - for ids in pci.ids usb.ids; do install -Dm644 "$ids" /app/share/hwdata/${ids};
                    done
                sources:
                  - type: archive
                    url: https://github.com/gentoo/hwids/archive/hwids-20210613.tar.gz
                    sha256: e28f1787290e9ea17426aa4090bbf6aca9bbc9e6cd14da232778bfaef4938bc1
                    x-checker-data:
                      type: anitya
                      project-id: 233488
                      stable-only: true
                      url-template: https://github.com/gentoo/hwids/archive/hwids-$version.tar.gz
          - name: spice-protocol
            buildsystem: meson
            sources:
              - type: archive
                url: https://gitlab.freedesktop.org/spice/spice-protocol/-/archive/v0.14.4/spice-protocol-v0.14.4.tar.gz
                sha256: 9c31fa533ad531d1b816ffd0c24b4785d133e7bb397f72d35f7a6d59bcd7d53a
                x-checker-data:
                  type: anitya
                  project-id: 14892
                  stable-only: true
                  url-template: https://gitlab.freedesktop.org/spice/spice-protocol/-/archive/v$version/spice-protocol-v$version.tar.gz

      - name: python-gobject
        buildsystem: meson
        config-opts:
          - -Dpycairo=enabled
        sources:
          - type: archive
            url: https://download.gnome.org/sources/pygobject/3.50/pygobject-3.50.0.tar.xz
            sha256: 8d836e75b5a881d457ee1622cae4a32bcdba28a0ba562193adb3bbb472472212
            x-checker-data:
              type: anitya
              project-id: 83477
              stable-only: true
              url-template: https://download.gnome.org/sources/pygobject/$major.$minor/pygobject-$version.tar.xz
        modules:
          - name: python-cairo
            buildsystem: meson
            # config-opts:
            #   - -Doption=false
            sources:
              - type: archive
                url: https://github.com/pygobject/pycairo/archive/v1.27.0.tar.gz
                sha256: ce10721e4a5d74c53c8b7241e5ccfd4627fadb2830ecdae72524c077067ca247
                x-checker-data:
                  type: anitya
                  project-id: 13166
                  stable-only: true
                  url-template: https://github.com/pygobject/pycairo/archive/v$version.tar.gz

      - name: gtksourceview4
        buildsystem: meson
        config-opts:
          - -Dvapi=false
        sources:
          - type: archive
            url: https://download.gnome.org/sources/gtksourceview/4.8/gtksourceview-4.8.4.tar.xz
            sha256: 7ec9d18fb283d1f84a3a3eff3b7a72b09a10c9c006597b3fbabbb5958420a87d
            x-checker-data:
              type: gnome
              name: gtksourceview
              versions:
                <: 5.0.0
              stable-only: true

      - name: vte291
        buildsystem: meson
        config-opts:
          - -Dgtk4=false
          - -D_systemd=false
          - -Dvapi=false
        sources:
          - type: archive
            url: https://download.gnome.org/sources/vte/0.78/vte-0.78.1.tar.xz
            sha256: 6499d25179315255f9bcfce03c66fb84c03ad325dea23d0e372178521eca42b5
            x-checker-data:
              type: gnome
              name: vte
              stable-only: true
        cleanup:
          - /bin
          - /etc
          - /lib/systemd
          - /libexec
          - /share/gir-1.0
          - /share/vala

      - name: python3-requests
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "requests" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/ce/d9/5f4c13cecde62396b0d3fe530a50ccea91e7dfc1ccf0e09c228841bb5ba8/urllib3-2.2.3-py3-none-any.whl
            sha256: ca899ca043dcb1bafa3e262d73aa25c465bfb49e0bd9dd5d59f1d0acba2f8fac
            x-checker-data:
              type: pypi
              name: urllib3
              packagetype: bdist_wheel
          - type: file
            url: https://files.pythonhosted.org/packages/76/c6/c88e154df9c4e1a2a66ccf0005a88dfb2650c1dffb6f5ce603dfbd452ce3/idna-3.10-py3-none-any.whl
            sha256: 946d195a0d259cbba61165e88e65941f16e9b36ea6ddb97f00452bae8b1287d3
            x-checker-data:
              type: pypi
              name: idna
              packagetype: bdist_wheel
          - type: file
            url: https://files.pythonhosted.org/packages/bf/9b/08c0432272d77b04803958a4598a51e2a4b51c06640af8b8f0f908c18bf2/charset_normalizer-3.4.0-py3-none-any.whl
            sha256: fe9f97feb71aa9896b81973a7bbada8c49501dc73e58a10fcef6663af95e5079
            x-checker-data:
              type: pypi
              name: charset_normalizer
              packagetype: bdist_wheel
          - type: file
            url: https://files.pythonhosted.org/packages/12/90/3c9ff0512038035f59d279fddeb79f5f1eccd8859f06d6163c58798b9487/certifi-2024.8.30-py3-none-any.whl
            sha256: 922820b53db7a7257ffbda3f597266d435245903d80737e34f8a45ff3e3230d8
            x-checker-data:
              type: pypi
              name: certifi
              packagetype: bdist_wheel
          - type: file
            url: https://files.pythonhosted.org/packages/f9/9b/335f9764261e915ed497fcdeb11df5dfd6f7bf257d4a6a2a686d80da4d54/requests-2.32.3-py3-none-any.whl
            sha256: 70761cfe03c773ceb22aa2f671b4757976145175cdfca038c02654d061d6dcc6
            x-checker-data:
              type: pypi
              name: requests
              packagetype: bdist_wheel

      - name: libosinfo
        buildsystem: meson
        config-opts:
          - -Dwith-usb-ids-path=/app/share/hwdata/usb.ids
          - -Dwith-pci-ids-path=/app/share/hwdata/pci.ids
        sources:
          - type: archive
            url: https://releases.pagure.org/libosinfo/libosinfo-1.12.0.tar.xz
            sha256: ad8557ece26793da43d26de565e3d68ce2ee6bfb8d0113b7cc7dfe07f6bfc6b6
            x-checker-data:
              type: anitya
              project-id: 155460
              stable-only: true
              url-template: https://releases.pagure.org/libosinfo/libosinfo-$version.tar.xz
        cleanup:
          - /share/gtk-doc
          - /share/vala
        modules:
          - name: osinfo-db
            buildsystem: simple
            build-commands:
              - osinfo-db-import --system osinfo-db.tar.xz
            sources:
              - type: file
                url: https://releases.pagure.org/libosinfo/osinfo-db-20240701.tar.xz
                sha256: 1d7381a72f0c45f473befa4a92fa010a37fc4f7b2bb5d1f68e06da440ef6905d
                dest-filename: osinfo-db.tar.xz
                x-checker-data:
                  type: anitya
                  project-id: 226784
                  stable-only: true
                  url-template: https://releases.pagure.org/libosinfo/osinfo-db-$version.tar.xz
            modules:
              - name: osinfo-db-tools
                buildsystem: meson
                sources:
                  - type: archive
                    url: https://releases.pagure.org/libosinfo/osinfo-db-tools-1.12.0.tar.xz
                    sha256: f3315f675d18770f25dea8ed04b20b8fc80efb00f60c37ee5e815f9c3776e7f3
                    x-checker-data:
                      type: anitya
                      project-id: 226782
                      stable-only: true
                      url-template: https://releases.pagure.org/libosinfo/osinfo-db-tools-$version.tar.xz
                cleanup:
                  - '*'
