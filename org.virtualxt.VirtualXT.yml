app-id: org.virtualxt.VirtualXT
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.golang
command: virtualxt.freedos
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --filesystem=home
  - --filesystem=/dev
  - --filesystem=/media
  - --filesystem=/run/media
  - --device=all
build-options:
  env:
    - GOROOT=/usr/lib/sdk/golang

modules:
  - name: SDL2
    buildsystem: autotools
    config-opts:
      - --disable-video-wayland
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share
    sources:
      - type: archive
        url: https://www.libsdl.org/release/SDL2-2.0.20.tar.gz
        sha256: c56aba1d7b5b0e7e999e4a7698c70b63a3394ff9704b5f6e1c57e0c16f04dd06

  - name: virtualxt
    buildsystem: simple
    build-commands:
    
      # Fix for 0.6.1. Remove later.
      - cp _go.mod go.mod
      - cp _go.sum go.sum
      - cp _modules.txt vendor/modules.txt

      - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/lib
      - export C_INCLUDE_PATH=$C_INCLUDE_PATH:/include
      - $GOROOT/bin/go build -tags sdl

      - install -Dm00755 virtualxt $FLATPAK_DEST/bin/virtualxt
      - install -Dm00644 bios/pcxtbios.bin $FLATPAK_DEST/share/virtualxt/pcxtbios.bin
      - install -Dm00644 bios/vxtx.bin $FLATPAK_DEST/share/virtualxt/vxtx.bin
      - install -Dm00644 boot/freedos.img $FLATPAK_DEST/share/virtualxt/freedos.img
      - install -Dm00644 boot/freedos_hd.img $FLATPAK_DEST/share/virtualxt/freedos_hd.img
      - install -Dm00644 doc/manual/index.md.html doc/manual/markdeep.min.js doc/manual/style.css -t $FLATPAK_DEST/share/virtualxt/manual

      - install -Dm00644 doc/icon/icon.png $FLATPAK_DEST/share/icons/hicolor/128x128/apps/$FLATPAK_ID.png
      
      - install -Dm00755 virtualxt.freedos $FLATPAK_DEST/bin/virtualxt.freedos
      - install -Dm00644 $FLATPAK_ID.desktop $FLATPAK_DEST/share/applications/$FLATPAK_ID.desktop
      - install -Dm00644 $FLATPAK_ID.appdata.xml $FLATPAK_DEST/share/appdata/$FLATPAK_ID.appdata.xml
    sources:
      - type: archive
        url: https://github.com/andreas-jonsson/virtualxt/archive/refs/tags/v0.6.1.tar.gz
        sha256: 6619e16925ab488bc7ee09852d05c98f758050aef9c115eec70a283c9bdc04dc

      - type: file
        path: org.virtualxt.VirtualXT.appdata.xml
        sha256: 34faca1836729bdad6e10d5d5aa860cff9bc03216b9f13e95eb31605d33b08a5

      - type: file
        path: org.virtualxt.VirtualXT.desktop
        sha256: 8a323c9f99709e33a02f6b28f020d018deabac2ff0fafb7c0a1031606aa7c323

      - type: file
        path: virtualxt.freedos
        sha256: f773b37e685f4157056d490c811a6ac28c0be3732c70e29e6636efa362f9e3a2

      - type: file
        path: _modules.txt
        sha256: 85a7cba91445efb3137b225c12260fe6f1d2695ea8953bcd830f79beda2a8723

      - type: file
        path: _go.sum
        sha256: 602f0d310a5f54b0235940912d0ff41e30fa6548f9fedc062eab3acb81e6a277

      - type: file
        path: _go.mod
        sha256: c150c0979717a7279a8344ab6bcac5d3ce3aef5a7e1aaaea44d9a38d9c443d4c
