id: ch.dragondreams.deigde
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: deigde

finish-args:
  - --device=dri
  - --share=network
  - --socket=pulseaudio
  - --socket=x11
  - --share=ipc
  - --filesystem=host
  # required for input devices (gamepad) 
  - --device=all

modules:
  - name: scons
    buildsystem: simple
    cleanup: ['*']
    sources:
      - type: archive
        sha256: 61e2fc42e0e2c750105d61f26cc1dfebcae9f4103d3dc0e9aeb373016b0d208c
        url: https://downloads.sourceforge.net/project/scons/scons/4.10.0/SCons-4.10.0.tar.gz
    build-commands:
      - pip3 install --no-index --no-build-isolation --prefix=${FLATPAK_DEST} .

  - name: patchelf
    buildsystem: autotools
    cleanup: ['*']
    sources:
      - type: archive
        sha256: b94cd3ce2361fbbbf7bb055a9d90d1a33878a594191a7c4a60370b7c320fde08
        url: https://github.com/NixOS/patchelf/releases/download/0.15.5/patchelf-0.15.5.tar.gz

  - name: deigde
    buildsystem: simple
    build-options:
      env:
        ReleaseVersion: '%VERSION%'
    only-arches:
      - x86_64

    build-commands:
      - |
          scons \
            -j $FLATPAK_BUILDER_N_JOBS \
            prefix=$FLATPAK_DEST \
            with_debug=no \
            with_debug_symbols=yes \
            with_verbose=no \
            with_threads=$FLATPAK_BUILDER_N_JOBS \
            with_engine_module_checks=no \
            version="$ReleaseVersion" \
              install_engine_runtime \
              install_igde_runtime \
              delauncher_runtime \
              deigde_data \
              deigde_shared_runtime \
              deigde
    
    cleanup:
      - '/bin/delauncher*'
      - '/share/applications/ch.dragondreams.delauncher.desktop'
      - '/share/icons/hicolor/*/apps/ch.dragondreams.delauncher.png'
      - '/share/icons/hicolor/*/mimetypes/ch.dragondreams.delauncher-*.png'
      - '/share/man/man1/delauncher-*.1'
      - '/share/metainfo/ch.dragondreams.delauncher.metainfo.xml'
      - '/share/mime/packages/ch.dragondreams.delauncher-mime.xml'
      - '/share/mime/packages/dragonscript-dragonscript.xml'
      - '/share/pixmaps/ch.dragondreams.delauncher.png'
      - '/share/katepart5/syntax'

    sources:
      - type: git
        url: https://github.com/LordOfDragons/dragengine.git
        tag: '%TAG%'
