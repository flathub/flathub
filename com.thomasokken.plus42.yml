id: com.thomasokken.plus42
command: plus42dec

runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk

finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=fallback-x11
  # Wayland access
  - --socket=wayland
  # GPU acceleration if needed
  - --device=dri
  # For now it does not support portals, until code is patched allow loading/saving through docs folder:
  - --filesystem=xdg-documents

modules:
- name: plus42
  sources:
  - type: archive
    url: https://thomasokken.com/plus42/upstream/plus42-upstream-1.1.13.tgz
    sha256: b8d1ca156b8ade58673cd7fd99d3e7f04f09c9cfaaa475283a893001337e5fa1
  - type: file
    path: com.thomasokken.plus42.desktop
  - type: file
    path: com.thomasokken.plus42.metainfo.xml
  # XPM is no longer supported, convert it to more modern formats:
  - type: shell
    commands:
    - for r in 48 128; do ffmpeg -i gtk/icon-${r}x${r}.xpm gtk/icon-${r}x${r}.png; done
    - for r in 48 128; do gdk-pixbuf-csource --name=icon_${r}_pixbuf gtk/icon-${r}x${r}.png > gtk/icon-${r}x${r}.h; done
  - type: patch
    path: xpm.patch
  buildsystem: simple
  build_commands:
  - cd gtk && make -j BCD_MATH=1 AUDIO_ALSA=1
  - install -Dm755 -s gtk/plus42dec ${FLATPAK_DEST}/bin/plus42dec
  - install -Dm644 gtk/icon-48x48.png ${FLATPAK_DEST}/share/icons/hicolor/48x48/apps/${FLATPAK_ID}.png
  - install -Dm644 gtk/icon-128x128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
  - install -Dm644 ${FLATPAK_ID}.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
  - install -Dm644 ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
