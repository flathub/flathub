{
    "app-id": "org.jamovi.jamovi",
    "runtime": "org.freedesktop.Platform",
    "runtime-version": "1.6",
    "base": "io.atom.electron.BaseApp",
    "base-version": "stable",
    "sdk": "org.freedesktop.Sdk",
    "command": "jamovi",
    "sdk-extensions": [
        "org.freedesktop.Sdk.Extension.gfortran-62"
    ],
    "finish-args":[
        "--share=network",
        "--share=ipc",
        "--socket=x11",
        "--socket=wayland",
        "--socket=pulseaudio",
        "--device=dri",
        "--filesystem=home"
    ],
    "build-options": {
        "cflags": "-O2",
        "cxxflags": "-O2",
        "env": {
            "PATH": "/app/bin:/usr/bin:/usr/lib/sdk/gfortran-62/bin",
            "R_HOME": "/app/lib64/R"
        },
        "arch": {
            "i386": {
                "env": {
                    "R_HOME": "/app/lib/R"
                }
            }
        }
    },
    "cleanup": [
        "/include",
        "/bin/chardetect",
        "/bin/cygdb",
        "/bin/cython",
        "/bin/cythonize",
        "/bin/nanocat",
        "/lib/cmake",
        "/lib/debug",
        "/lib/pkgconfig",
        "/lib/*.a",
        "/lib/*.la"
    ],
    "modules":[
        {
            "name": "gfortran",
            "buildsystem": "simple",
            "build-commands": [ "/usr/lib/sdk/gfortran-62/install.sh" ]
        },
        {
            "name": "boost",
            "buildsystem": "simple",
            "build-commands": [
                "./bootstrap.sh --with-libraries=filesystem,system",
                "./b2 -j4 install --prefix=/app"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://dl.bintray.com/boostorg/release/1.66.0/source/boost_1_66_0.tar.bz2",
                    "sha256": "5721818253e6a0989583192f96782c4a98eb6204965316df9f5ad75819225ca9"
                }
            ],
            "cleanup": [
                "/include"
            ]
        },
        {
            "name": "lapack",
            "buildsystem": "cmake",
            "builddir": true,
            "config-opts": [
                "-DCMAKE_INSTALL_PREFIX=/app",
                "-DCMAKE_INSTALL_LIBDIR=lib",
                "-DCMAKE_BUILD_TYPE=Release",
                "-DBUILD_SHARED_LIBS=ON",
                "-DBUILD_TESTING=OFF",
                "-DCMAKE_Fortran_COMPILER=/usr/lib/sdk/gfortran-62/bin/gfortran",
                "-DLAPACKE=ON",
                "-DCBLAS=ON"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "http://www.netlib.org/lapack/lapack-3.8.0.tar.gz",
                    "sha512": "17786cb7306fccdc9b4a242de7f64fc261ebe6a10b6ec55f519deb4cb673cb137e8742aa5698fd2dc52f1cd56d3bd116af3f593a01dcf6770c4dcc86c50b2a7f"
                }
            ],
            "cleanup": [ "/lib/cmake" ]
        },
        {
            "name": "R",
            "config-opts": [
                "--enable-R-shlib",
                "--disable-BLAS-shlib"
            ],
            "build-options": {
                "ldflags": "-L/usr/lib/sdk/gfortran-62/lib"
            },
            "sources": [
                {
                    "type":"archive",
                    "url": "https://cran.r-project.org/src/base/R-3/R-3.4.3.tar.gz",
                    "sha256":"7a3cb831de5b4151e1f890113ed207527b7d4b16df9ec6b35e0964170007f426"
                }
            ],
            "cleanup": [
                "/app/lib64/R/doc",
                "/app/lib/R/doc"
            ]
        },
        {
            "name": "nlopt",
            /* needed by nloptr (R package) */
            "build-options": {
                "cflags": "-fPIC"
            },
            "sources": [
                {
                    "type":"archive",
                    "url": "http://ab-initio.mit.edu/nlopt/nlopt-2.4.2.tar.gz",
                    "sha256":"8099633de9d71cbc06cd435da993eb424bbcdbded8f803cdaa9fb8c6e09c8e89"
                }
            ]
        },
        {
            "name": "ProtoBuf",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/google/protobuf/releases/download/v3.5.1/protobuf-all-3.5.1.tar.gz",
                    "sha256": "72d43863f58567a9ea2054671fdb667867f9cf7865df623c7be630978ff97dff"
                }
            ],
            "cleanup": [
                "/bin/protoc"
            ]
        },
        {
            "name": "nanomsg",
            /* needed by python3-nanomsg */
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/nanomsg/nanomsg/archive/1.1.2.tar.gz",
                    "sha256": "3c52165a735c2fb597d2306593ae4b17900688b90113d4115ad8480288f28ccb"
                }
            ]
        },
        {
            "name": "nodejs",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://nodejs.org/dist/v8.9.4/node-v8.9.4.tar.gz",
                    "sha256": "729b44b32b2f82ecd5befac4f7518de0c4e3add34e8fe878f745740a66cbbc01"
                }
            ],
            "cleanup": [
                "/include",
                "/share",
                "/lib/node_modules",
                "/bin/node",
                "/bin/npm",
                "/bin/npx"
            ]
        },
        "python-deps.json",
        {
            "name": "python3-numpy",
            "buildsystem": "simple",
            "build-commands": [
                "python3 setup.py build -j 0",
                "python3 setup.py install --prefix=/app --root=/ --optimize=1"
            ],
            "build-options": {
                "env": {
                    "ATLAS": "None",
                    "BLAS": "/app/lib",
                    "LAPACK": "/app/lib"
                }
            },
            "sources": [
                {
                    "type": "archive",
                    "url": "https://pypi.python.org/packages/a3/99/74aa456fc740a7e8f733af4e8302d8e61e123367ec660cd89c53a3cd4d70/numpy-1.14.1.zip",
                    "sha512": "d423fa1db5da488de8bfcfc86cf44da96492bec4a05022b79c568d33ad5a3fecebc66408a5fde1c31dac639280c7544cb09417e845ec79c729e3885f3af98ae1"
                }
            ]
        },
        {
            "name": "python3-scipy",
            "buildsystem": "simple",
            "build-commands": [
                "python3 setup.py build -j 0",
                "python3 setup.py install --prefix=/app --root=/ --optimize=1"
            ],
            "build-options": {
                "env": {
                    "ATLAS": "None",
                    "BLAS": "/app/lib",
                    "LAPACK": "/app/lib",
                    "LDFLAGS": "-shared"
                }
            },
            "sources": [
                {
                    "type": "archive",
                    "url": "https://pypi.python.org/packages/d0/73/76fc6ea21818eed0de8dd38e1e9586725578864169a2b31acdeffb9131c8/scipy-1.0.0.tar.gz",
                    "sha512": "7d55c5660ac606933d517171a229b288fd0ea8d9fdd8e30fac3d294545a26b2700c7b100b014a93231c4122dee0f1ddd741c00f5902643a6ccc287cdf581da7a"
                }
            ]
        },
        {
            "name": "electron-x86_64",
            "only-arches": [ "x86_64" ],
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/bin/resources",
                "cp *.so  /app/bin",
                "cp *.bin /app/bin",
                "cp *.dat /app/bin",
                "cp *.pak /app/bin",
                "cp electron /app/bin/",
                "cp -r resources/ /app/bin/"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/electron/electron/releases/download/v1.8.3/electron-v1.8.3-linux-x64.zip",
                    "sha512": "59bbb7f2a77fb8a97a3583a8468f65aaf3e41a6c443a9c6df4920a846a8beada23063905672b3bc1f3abf93d34bf92fcecf67b417ea409f70eddb38fc91bddff",
                    "strip-components": 0
                }
            ]
        },
        {
            "name": "electron-i386",
            "only-arches": [ "i386" ],
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/bin/resources",
                "cp *.so  /app/bin",
                "cp *.bin /app/bin",
                "cp *.dat /app/bin",
                "cp *.pak /app/bin",
                "cp electron /app/bin/",
                "cp -r resources/ /app/bin/"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/electron/electron/releases/download/v1.8.3/electron-v1.8.3-linux-ia32.zip",
                    "sha512": "4ef2504c30c1b7c739e981113d899a4f65d0d16b640c0b5c26e02cf8770b37d35d8c65e09fbf460fdb89a8e17def35762f830150433648d830811a0481c15da4",
                    "strip-components": 0
                }
            ]
        },
        {
            "name": "jmvcore",
            "buildsystem": "simple",
            "build-commands": [
                "/app/bin/R CMD INSTALL *.Rpkg  --no-docs --no-html --no-help --no-demo --no-multiarch",
                "/app/bin/R CMD INSTALL jmvcore --no-docs --no-html --no-help --no-demo --no-multiarch"
            ],
            "build-options": {
                "env": {
                    "PATH": "/app/bin:/usr/bin:/usr/lib/sdk/gfortran-62/bin"
                }
            },
            "sources": [
                {
                    "type": "script",
                    "dest-filename": "xml2-config",
                    /* providing our own xml2-config saves us from having to */
                    /* patch a *lot* of packages */
                    "commands": [
                        "#!/bin/bash",
                        "if [ \"$1\" == \"--version\" ]",
                        "then",
                        "    pkg-config --modversion libxml-2.0",
                        "else",
                        "    pkg-config $* libxml-2.0",
                        "fi"
                    ]
                },
                {
                        "type": "shell",
                        "commands": [
                            "mv xml2-config /app/bin"
                        ]
                },
                "base-deps-sources.json",
                {
                    "type": "git",
                    "url": "https://github.com/jamovi/jmvcore.git",
                    "tag": "v0.8.2",
                    "commit": "06978e718c52c728a1cfd0c5e7dab4c551a68a07",
                    "dest": "jmvcore"
                }
            ],
            "cleanup": [
                "/bin/xml2-config"
            ]
        },
        {
            "name": "jamovi-electron-app",
            "buildsystem": "simple",
            "build-options": {
                "env": {
                    "npm_config_cache": "../npm-cache"
                }
            },
            "build-commands": [
                "cp jamovi /app/bin/jamovi",
                "cd electron && npm install --offline",
                "cd electron && npm run deploy",
                "mv electron/default_app.asar /app/bin/resources"
            ],
            "sources":[
                "electron-app-deps-sources.json",
                "jamovi-source.json",
                {
                    "type": "script",
                    "dest-filename": "jamovi",
                    /* we handle the call to --version here so it doesn't */
                    /* need electron (or a display server) */
                    "commands": [
                        "#!/bin/bash",
                        "SCRIPT=`realpath $0`",
                        "HERE=`dirname $SCRIPT`",
                        "if [[ \"$1\" == \"--version\" ]]; then",
                        "    cat $HERE/../lib/jamovi/version",
                        "else",
                        "    $HERE/electron $@",
                        "fi"
                    ]
                }
            ]
        },
        {
            "name": "jamovi-server",
            "buildsystem": "simple",
            "build-commands": [
                "cd server && python3 setup.py build_ext",
                "cd server && python3 setup.py install --prefix=/app",
                "mkdir -p /app/lib/jamovi",
                "cp -r examples/ /app/lib/jamovi/",
                "cp version /app/lib/jamovi/version"
            ],
            "sources":[
                "jamovi-source.json"
            ]
        },
        {
            "name": "jamovi-client",
            "buildsystem": "simple",
            "build-options": {
                "env": {
                    "npm_config_cache": "../npm-cache"
                }
            },
            "build-commands": [
                "cd client && npm install --offline",
                "cd client && npm run prepublish",
                "mkdir -p              /app/lib/jamovi/client",
                "cp client/*.js        /app/lib/jamovi/client",
                "cp client/*.html      /app/lib/jamovi/client",
                "cp client/*.css       /app/lib/jamovi/client",
                "cp client/favicon.ico /app/lib/jamovi/client",
                "cp -r client/assets   /app/lib/jamovi/client"
            ],
            "sources":[
                "client-deps-sources.json",
                "jamovi-source.json"
            ]
        },
        {
            "name": "env.conf",
            "buildsystem": "simple",
            "build-commands": [
                "sed -E -e \"s|R_HOME=.*|R_HOME=$R_HOME|g\" -e \"s|R_LIBS=.*|R_LIBS=$R_HOME/library|g\" env.conf > /app/bin/env.conf"
            ],
            "sources":[
                {
                    "type": "file",
                    "path": "env.conf"
                }
            ]
        },
        {
            "name": "jmv",
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/lib/jamovi/modules",
                "mkdir -p jmv/build/R",
                "/app/bin/R CMD INSTALL *.Rpkg --library=jmv/build/R --no-docs --no-html --no-data --no-help --no-demo --no-multiarch",
                "cd jamovi-compiler && npm install --offline",
                "./jamovi-compiler.sh --install jmv --to /app/lib/jamovi/modules --home /app"
            ],
            "build-options": {
                "env": {
                    "npm_config_cache": "../npm-cache"
                }
            },
            "sources": [
                "jmc-deps-sources.json",
                "jmv-deps-sources.json",
                {
                    "type": "git",
                    "url": "https://github.com/jamovi/jmv.git",
                    "tag": "v0.8.3.1",
                    "commit": "e3943e988ec66f1b857bf4bb13f04e0dd0863305",
                    "dest": "jmv"
                },
                {
                    "type": "git",
                    "url": "https://github.com/jamovi/jamovi-compiler.git",
                    "tag": "v0.8.3",
                    "commit": "435545f8841b1374495a3176b16ed0a11a203a47",
                    "dest": "jamovi-compiler"
                },
                {
                    "type": "script",
                    "dest-filename": "xml2-config",
                    /* providing our own xml2-config saves us from having to */
                    /* patch a *lot* of packages */
                    "commands": [
                        "#!/bin/bash",
                        "if [ \"$1\" == \"--version\" ]",
                        "then",
                        "    pkg-config --modversion libxml-2.0",
                        "else",
                        "    pkg-config $* libxml-2.0",
                        "fi"
                    ]
                },
                {
                    "type": "shell",
                    "commands": [
                        "mv xml2-config /app/bin"
                    ]
                },
                {
                    "type": "script",
                    "dest-filename": "jamovi-compiler.sh",
                    "commands": [
                        "node jamovi-compiler/index.js --rhome $R_HOME $*"
                    ]
                }
            ],
            "cleanup": [
                "/bin/xml2-config"
            ]
        },
        {
            "name": "jamovi-engine",
            "build-options": {
                "config-opts": [
                    "--rhome=/app/lib64/R",
                    "--base-module-path=/app/lib64/R/library",
                    "--rpath=/app/lib64/R/library/RInside/lib",
                    "--rpath=/app/lib64/R/lib"
                ],
                "arch": {
                    "i386": {
                        "config-opts": [
                            "--rhome=/app/lib/R",
                            "--base-module-path=/app/lib/R/library",
                            "--rpath=/app/lib/R/library/RInside/lib",
                            "--rpath=/app/lib/R/lib"
                        ]
                    }
                }
            },
            "sources":[
                "jamovi-source.json"
            ]
        },
        {
            "name": "jamovi-meta",
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/share/menu",
                "cp platform/menu /app/share/menu/org.jamovi.jamovi",
                "mkdir -p /app/share/icons/hicolor/scalable/apps",
                "cp platform/app-icon.svg /app/share/icons/hicolor/scalable/apps/org.jamovi.jamovi.svg",
                "mkdir -p /app/share/applications",
                "sed -E -e 's|Icon=.*|Icon=/app/share/icons/hicolor/scalable/apps/org.jamovi.jamovi.svg|g' platform/jamovi.desktop > /app/share/applications/org.jamovi.jamovi.desktop",
                "mkdir -p /app/share/appdata",
                "cp jamovi.appdata.xml /app/share/appdata/org.jamovi.jamovi.appdata.xml"
            ],
            "sources":[
                "jamovi-source.json",
                {
                    "type": "file",
                    "path": "jamovi.appdata.xml"
                }
            ]
        }
    ]
}
