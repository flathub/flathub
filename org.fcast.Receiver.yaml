app-id: org.fcast.Receiver
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk

base: org.electronjs.Electron2.BaseApp
base-version: '24.08'

command: run.sh
finish-args:
  - --share=network
  - --socket=pulseaudio
  - --socket=x11
  - --share=ipc
  - --device=dri
  - --system-talk-name=org.fcast.Receiver
  - --env=ELECTRON_TRASH=gio
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node22
build-options:
  append-path: /usr/lib/sdk/node22/bin
  env:
    NPM_CONFIG_LOGLEVEL: info
modules:
  - name: fcast-receiver
    buildsystem: simple
    build-options:
      env:
        XDG_CACHE_HOME: /run/build/fcast-receiver/flatpak-node/cache
        npm_config_cache: /run/build/fcast-receiver/flatpak-node/npm-cache
        npm_config_nodedir: /usr/lib/sdk/node22
        npm_config_offline: 'true'
    subdir: receivers/electron/
    build-commands:
      # Install npm dependencies
      - npm install --offline
      # run the build
      - npm run build
      - ../../deploy_flatpak.sh
      # Bundle app and dependencies
      - cp -a out/fcast-receiver-linux*64 /app/fcast-receiver
      # Install app wrapper
      - install -Dm755 -t /app/bin/ ../../run.sh
      # Install metadata
      - install -Dm 0644 ../../org.fcast.Receiver.desktop ${FLATPAK_DEST}/share/applications/org.fcast.Receiver.desktop
      - install -Dm 0644 ../../org.fcast.Receiver.metainfo.xml  ${FLATPAK_DEST}/share/metainfo/org.fcast.Receiver.metainfo.xml
      # Install icons
      # assets/icons/app/icon1024.png is the icon I think would best meet the store guidelines
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps
      - ffmpeg -width 128 -i assets/icons/app/icon1024.png -vf scale=128:-1 ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/org.fcast.Receiver.png
     
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps
      - ffmpeg -width 256 -i assets/icons/app/icon1024.png -vf scale=256:-1 ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/org.fcast.Receiver.png
      
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps
      - ffmpeg -width 512 -i assets/icons/app/icon1024.png -vf scale=512:-1 ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/org.fcast.Receiver.png
    post-install:
      - install -Dm0644 ../../LICENSE -t ${FLATPAK_DEST}/share/licenses/$FLATPAK_ID/fcast-receiver
      - install -Dm0644 /app/fcast-receiver/LICENSE -t ${FLATPAK_DEST}/share/licenses/$FLATPAK_ID/electron
      - install -Dm0644 /app/fcast-receiver/LICENSES.chromium.html -t ${FLATPAK_DEST}/share/licenses/$FLATPAK_ID/chromium
    sources:
      - type: git
        url: https://gitlab.futo.org/videostreaming/fcast.git
        commit: c3bedbb1d7a9c7c1c399cd69f654512f435316ef
        x-checker-data:
          type: git
          url: https://gitlab.futo.org/videostreaming/fcast/-/tags
          tag-pattern: ^electron-v([0-9.]+)$
          is-main-source: true

      - type: patch
        path: patches/nonetwork.patch
      
      - npm-sources.json

      - type: file
        path: deploy_flatpak.sh
      
      - type: file
        path: org.fcast.Receiver.metainfo.xml

      - type: file
        path: org.fcast.Receiver.desktop

      - type: script
        dest-filename: run.sh
        commands:
          - zypak-wrapper /app/fcast-receiver/fcast-receiver.app  --no-sandbox --password-store=basic "$@"
  