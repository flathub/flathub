app-id: com.github.xournalpp.xournalpp
runtime: org.freedesktop.Platform
runtime-version: "18.08"
sdk: org.freedesktop.Sdk
command: xournalpp
rename-icon: xournalpp
rename-desktop-file: xournalpp.desktop
finish-args:
  # X11 + XShm access
  - "--share=ipc"
  - "--socket=x11"
  # Wayland access
  - "--socket=wayland"
  # Needs to save files locally
  # Why are portals not used? Does the app re-implement the open dialogue?
  - "--filesystem=xdg-documents"
  - "--socket=pulseaudio"
  # Allow dconf
  - "--filesystem=xdg-run/dconf"
  - "--filesystem=~/.config/dconf:ro"
  - "--talk-name=ca.desrt.dconf"
  - "--env=DCONF_USER_CONFIG_DIR=.config/dconf"
  - "--persist=.xournalpp"

cleanup:
  - "/include"
  - "/lib/pkgconfig"
  - "/man"
  - "/share/doc"
  - "/share/gtk-doc"
  - "/share/man"
  - "/share/pkgconfig"
  - "*.la"
  - "*.a"
modules:
  - name: poppler
    buildsystem: cmake-ninja
    config-opts:
      - "-DCMAKE_INSTALL_LIBDIR=/app/lib"
      - "-DCMAKE_INSTALL_INCLUDEDIR=/app/include"
      - "-DENABLE_LIBOPENJPEG=none"
    cleanup:
      - "/bin"
    sources:
      - type: archive
        url: https://poppler.freedesktop.org/poppler-0.69.0.tar.xz
        sha256: 637ff943f805f304ff1da77ba2e7f1cbd675f474941fd8ae1e0fc01a5b45a3f9
  - name: libzip
    buildsystem: cmake-ninja
    config-opts:
      - "-DCMAKE_INSTALL_LIBDIR=/app/lib"
      - "-DCMAKE_INSTALL_INCLUDEDIR=/app/include"
    cleanup:
      - "/bin"
    sources:
      - type: archive
        url: https://libzip.org/download/libzip-1.5.2.tar.xz
        sha256: b3de4d4bd49a01e0cab3507fc163f88e1651695b6b9cb25ad174dbe319d4a3b4

  - name: libportaudiocpp
    buildsystem: autotools
    config-opts:
      - "--enable-cxx" # compile with c++ headers!!!
    make-args:
        # seem parallel build is broken. At least it breaks for me, locally
        - -j1
    sources:
      - type: git
        url: https://git.assembla.com/portaudio.git
        commit: 396fe4b6699ae929d3a685b3ef8a7e97396139a4
    cleanup:
      - "/include"
      - "/lib/*.a"
      - "/lib/*.la"
      - "/lib/pkgconfig"
      - "/man"
      - "/share/aclocal"
      - "/share/doc"
      - "/share/gtk-doc"
      - "/share/man"
      - "/share/pkgconfig"

  - name: libsndfile
    buildsystem: autotools
    sources:
      - type: archive
        url: http://www.mega-nerd.com/libsndfile/files/libsndfile-1.0.27.tar.gz
        sha256: a391952f27f4a92ceb2b4c06493ac107896ed6c76be9a613a4731f076d30fac0

  - name: xournallpp
    buildsystem: cmake-ninja
    post-install:
      - sed -i s,xournalpp.desktop,com.github.xournalpp.xournalpp.desktop,g  xournalpp.appdata.xml
      - install -Dma+r xournalpp.appdata.xml /app/share/metainfo/com.github.xournalpp.xournalpp.appdata.xml
      - install -Dma+r /app/share/mime/packages/xournalpp.xml  /app/share/mime/packages/com.github.xournalpp.xournalpp.xml

    sources:
      - type: git
        url: https://github.com/xournalpp/xournalpp
        commit: 14e9012b94e005112387dbb7d2ed59274d542885
        tag: 1.0.10
      - type: file
        path: xournalpp.appdata.xml
