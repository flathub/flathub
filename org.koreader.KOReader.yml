app-id: org.koreader.KOReader
runtime: org.freedesktop.Platform
runtime-version: "22.08"
sdk: org.freedesktop.Sdk
base-version: "22.08"
command: koreader
separate-locales: false
finish-args:
  - --device=dri
  - --share=ipc
  - --share=network
  - --socket=x11
  - --talk-name=org.freedesktop.Notifications
  - --filesystem=host
modules:
  - name: koreader
    buildsystem: simple
    sources:
      - type: file
        only-arches: [x86_64]
        url: https://github.com/koreader/koreader/releases/download/v2022.11/koreader-appimage-x86_64-linux-gnu-v2022.11.AppImage
        sha512: 033ee57fd9d719e0f10c1a53a2e7dfc9841d642f1401b7c0a83dbfbdfa66f0b6d8f30ac2b6ba24cfcb0c3203566d301c27e3d8f08f13686f8f2bbc8507c99731
        dest_filename: koreader.AppImage
        x-checker-data:
          type: json
          url: https://api.github.com/repos/koreader/koreader/releases/latest
          version-query: .tag_name
          url-query:
            .assets[] | select(.name == "koreader-appimage-x86_64-linux-gnu-" + $version + ".AppImage")
            | .browser_download_url

      - type: script
        dest-filename: koreader.sh
        commands:
          - |
            export APPIMAGE=1

            cd /app/koreader

            exec '/app/koreader/reader.lua' "$@"

      - type: file
        path: org.koreader.KOReader.metainfo.xml

    build-commands:
      - install -Dm755 koreader.sh ${FLATPAK_DEST}/bin/koreader
      - install -Dm644 org.koreader.KOReader.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml

      - chmod +x koreader.AppImage
      - ./koreader.AppImage --appimage-extract

      - desktop-file-edit --set-icon ${FLATPAK_ID} --set-key Exec --set-value 'koreader %u' squashfs-root/koreader.desktop
      - install -Dm644 squashfs-root/koreader.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm644 squashfs-root/resources/koreader.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg

      - sed -i "s,!./luajit,!${FLATPAK_DEST}/koreader/luajit,g" squashfs-root/reader.lua
      - mv squashfs-root ${FLATPAK_DEST}/koreader
