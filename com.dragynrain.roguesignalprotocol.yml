# Flatpak manifest for Rogue Signal Protocol
# Flathub Beta submission for v0.9.0-beta

app-id: com.dragynrain.roguesignalprotocol
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: rogue-signal-protocol

# Beta channel
x-flathub:
  default-branch: beta

# Sandbox permissions
finish-args:
  # Display (Wayland preferred, X11 fallback)
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc

  # Audio
  - --socket=pulseaudio

  # Gamepad support (required for controller input)
  - --device=all

  # Save files in XDG user data directory
  - --persist=.local/share/RogueSignalProtocol

modules:
  - name: RogueSignalProtocol
    buildsystem: simple
    build-commands:
      # Create installation directories
      - install -dm755 /app/lib/rogue-signal-protocol
      - install -dm755 /app/bin
      - install -dm755 /app/share/applications
      - install -dm755 /app/share/icons/hicolor/512x512/apps
      - install -dm755 /app/share/icons/hicolor/256x256/apps
      - install -dm755 /app/share/icons/hicolor/128x128/apps
      - install -dm755 /app/share/metainfo

      # Install main executable
      - install -Dm755 RogueSignalProtocol /app/lib/rogue-signal-protocol/RogueSignalProtocol

      # Install game assets
      - cp -r graphics /app/lib/rogue-signal-protocol/
      - cp -r sound /app/lib/rogue-signal-protocol/
      - cp -r music /app/lib/rogue-signal-protocol/

      # Install configuration files
      - install -Dm644 game_content.json /app/lib/rogue-signal-protocol/
      - install -Dm644 game_rules.json /app/lib/rogue-signal-protocol/
      - install -Dm644 graphics_tiles.json /app/lib/rogue-signal-protocol/
      - install -Dm644 narrative_content.json /app/lib/rogue-signal-protocol/
      - install -Dm644 default_bindings.json /app/lib/rogue-signal-protocol/
      - install -Dm644 KreativeSquare.ttf /app/lib/rogue-signal-protocol/

      # Install optional files if present
      - test -f README.txt && install -Dm644 README.txt /app/lib/rogue-signal-protocol/ || true
      - test -f LICENSE && install -Dm644 LICENSE /app/lib/rogue-signal-protocol/ || true
      - test -f debug_mode.flag && install -Dm644 debug_mode.flag /app/lib/rogue-signal-protocol/ || true

      # Create wrapper script (game expects assets in CWD)
      - |
        cat > /app/bin/rogue-signal-protocol << 'WRAPPER'
        #!/bin/sh
        cd /app/lib/rogue-signal-protocol
        exec ./RogueSignalProtocol "$@"
        WRAPPER
      - chmod +x /app/bin/rogue-signal-protocol

      # Install desktop entry
      - install -Dm644 com.dragynrain.roguesignalprotocol.desktop /app/share/applications/com.dragynrain.roguesignalprotocol.desktop

      # Install icons
      - install -Dm644 logo.png /app/share/icons/hicolor/512x512/apps/com.dragynrain.roguesignalprotocol.png
      - install -Dm644 logo.png /app/share/icons/hicolor/256x256/apps/com.dragynrain.roguesignalprotocol.png
      - install -Dm644 logo.png /app/share/icons/hicolor/128x128/apps/com.dragynrain.roguesignalprotocol.png

      # Install AppStream metainfo
      - install -Dm644 com.dragynrain.roguesignalprotocol.metainfo.xml /app/share/metainfo/

    sources:
      # Game binary and assets from GitHub release
      - type: archive
        url: https://github.com/Dragynrain/RogueSignalProtocol/releases/download/v0.9.0-beta/RogueSignalProtocol-Linux.tar.gz
        sha256: 6b50e04ac2b20bd336d9b8b7570e6693905bfc03de4a1df4019b642258bd9a21

      # Desktop entry from repo
      - type: file
        url: https://raw.githubusercontent.com/Dragynrain/RogueSignalProtocol/main/packaging/linux/rogue-signal-protocol.desktop
        sha256: 9b1e88f1f78cfa404daf04f8a7bdba29178d300eac83db0214a913194661f9d9
        dest-filename: com.dragynrain.roguesignalprotocol.desktop

      # Icon from repo
      - type: file
        url: https://raw.githubusercontent.com/Dragynrain/RogueSignalProtocol/main/logo.png
        sha256: b94070ba12992fba0e2a64db175b6a1b9b6e024c27fab966bb6dd4a3c3f24462
        dest-filename: logo.png

      # AppStream metainfo from repo
      - type: file
        url: https://raw.githubusercontent.com/Dragynrain/RogueSignalProtocol/main/packaging/linux/com.dragynrain.roguesignalprotocol.metainfo.xml
        sha256: 7acb6ab84ea4a7feab4043adbb40390f6ff6fc760282f2f21a48a74b4ff54534
