{
    "name": "widelands",
    "buildsystem": "cmake",
    // remove configure script to run autoreconf
    //"rm-configure": true,
    //"no-autogen": true,
    //"no-parallel-make": true,
    "builddir": true,
    "config-opts": [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DCMAKE_INSTALL_PREFIX=/app/bin",
        "-DWL_INSTALL_BASEDIR=/app/share/widelands",
        "-DWL_INSTALL_DATADIR=/app/share/widelands",
        "-DBOOST_ROOT=/app",
        "-DGLEW_ROOT=/app",
        "-DGLEW_GLEW_LIBRARY=/app/lib/libGLEW.so",
        "-DGLEW_INCLUDE_DIR=/app/include/GL",
        // https://wl.widelands.org/forum/topic/1343/?page=3 & https://wl.widelands.org/forum/post/9857/
        "-DGLEW_LIBRARY:FILEPATH=/app/lib/libGLEW.a",
        //"-DOPTION_USE_GLBINDING:BOOL=ON",
        "-DOPENGL_glu_LIBRARY=/app/lib/libGLU.a",
        "-DOPTION_BUILD_WEBSITE_TOOLS=OFF"
    ],
    "sources": [
        // Sources and Prepare:
        // Source0
        {
            "type": "archive",
            "url": "https://launchpad.net/widelands/build19/build19/+download/widelands-build19-src-gcc7.tar.bz2",
            "sha256": "ef73b8cf5a7c680bad5caade907f1cc6ee88dd3729470b9214a3c72658585458"
        },
        // Source1 - Numix-Circle - numix-icon-theme-circle-0.1.0-13.git5a11140.el7.src.rpm
        {
            "type": "file",
            "path": "widelands.svg",
            "sha256": "4f860318acb3271b7cf6dcc6ba53fa265977d66894597195bea3b82d35b22335"
        },
        /*// Patch0
        {
            "type": "patch",
            "path": "widelands-build19-ppc64le.patch",
            "strip-components": 1,
            "sha256": "6ecebb71541c726c591e15ea693a01beb0173fa2040283153d958df456ce735b"
        },//*/
        // Patch1
        {
            "type": "patch",
            "path": "widelands-build19-icu-bidi.patch",
            "strip-components": 1,
            "sha256": "651f6d7ea6843752032872c4a20014418d52c5fa01dc72d4ede1d4f030206742"
        },
        {
            "type": "script",
            "commands": [
                "app_name='widelands';",
                "app_id='org.widelands.widelands';"
            ],
            "dest-filename": "flatpak_setup"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'create icons';
                imagemagick_home='/app/opt/imagemagick';
                imagemagick_lib=\"${imagemagick_home}/lib\";
                imagemagick_bin=\"${imagemagick_home}/bin\";
                if [[ -n \"${LD_LIBRARY_PATH}\" ]]; then
                    LD_LIBRARY_PATH=\"${LD_LIBRARY_PATH}:${imagemagick_lib}\";
                else
                    LD_LIBRARY_PATH=\"${imagemagick_lib}\";
                fi;
                export LD_LIBRARY_PATH;
                if [[ -n \"${PATH}\" ]]; then
                    PATH=\"${PATH}:${imagemagick_bin}\";
                else
                    PATH=\"${imagemagick_bin}\";
                fi;
                export PATH;
                icon=\"${app_name}.svg\";
                for s in {16,22,24,32,48,64,72,96,128,192,256,512}; do
                    size=\"${s}x${s}\";
                    echo \"- ${size}\";
                    mkdir -p \"icons/${size}/\";
                    convert -background none -density 1024 -resize \"${size}\" \"${icon}\" \"icons/${size}/${app_name}.png\";
                done;
                echo;"
            ],
            "dest-filename": "flatpak_create_icons"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'create desktop';
                cp \"debian/${app_id}.desktop\" \"${app_name}.desktop\";
                echo;"
            ],
            "dest-filename": "flatpak_create_desktop"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'create appdata';
                cp \"debian/${app_name}.appdata.xml\" \"${app_name}.appdata.xml\";
                echo;"
            ],
            "dest-filename": "flatpak_create_appdata"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'edit desktop';
                desktop-file-edit --set-key='Icon' --set-value=\"${app_name}\" \"${app_name}.desktop\";
                echo;"
            ],
            "dest-filename": "flatpak_edit_desktop"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'edit appdata';
                xmlstarlet_home='/app/opt/xmlstarlet';
                xmlstarlet_bin=\"${xmlstarlet_home}/bin\";
                if [[ -n \"${PATH}\" ]]; then
                    PATH=\"${PATH}:${xmlstarlet_bin}\";
                else
                    PATH=\"${xmlstarlet_bin}\";
                fi;
                export PATH;
                xmlstarlet ed --inplace -d '/component/releases/release[position()>1]' \"${app_name}.appdata.xml\";
                echo;"
            ],
            "dest-filename": "flatpak_edit_appdata"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'install icons';
                find 'icons' -mindepth 2 -maxdepth 2 -type f -name \"${app_name}.png\" | sort -V | xargs -I{} dirname '{}' | xargs -I{} basename '{}' | while read -r size ; do
                    install -p -D -m 0644 \"icons/${size}/${app_name}.png\" \"/app/share/icons/hicolor/${size}/apps/${app_name}.png\";
                done;
                echo;"
            ],
            "dest-filename": "flatpak_install_icons"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'install pixmaps';
                install -d \"/app/share/pixmaps\";
                ln -s \"../${app_name}/images/logos/wl-logo-64.png\" \"/app/share/pixmaps/${app_name}.png\";
                echo;"
            ],
            "dest-filename": "flatpak_install_pixmaps"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'install desktop';
                install -p -D -m 0644 \"${app_name}.desktop\" \"/app/share/applications/${app_name}.desktop\";
                echo;"
            ],
            "dest-filename": "flatpak_install_desktop"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'install appdata';
                install -p -D -m 0644 \"${app_name}.appdata.xml\" \"/app/share/metainfo/${app_name}.appdata.xml\";
                echo;"
            ],
            "dest-filename": "flatpak_install_appdata"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'install docs';
                install -d \"/app/share/doc/${app_name}\";
                install -p -m 0644 \"ChangeLog\" \"CREDITS\" \"WL_RELEASE\" \"/app/share/doc/${app_name}/\";
                echo;"
            ],
            "dest-filename": "flatpak_install_docs"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'install licenses';
                install -d \"/app/share/licenses/${app_name}\";
                install -p -m 0644 \"COPYING\" \"/app/share/licenses/${app_name}/\";
                echo;"
            ],
            "dest-filename": "flatpak_install_licenses"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'check desktop';
                desktop-file-validate \"/app/share/applications/${app_name}.desktop\";
                echo \"status: ${?}\";
                echo;"
            ],
            "dest-filename": "flatpak_check_desktop"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'check appdata';
                appstream-util validate-relax --nonet \"/app/share/metainfo/${app_name}.appdata.xml\";
                echo \"status: ${?}\";
                echo;"
            ],
            "dest-filename": "flatpak_check_appdata"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'create';
                ./flatpak_create_icons;
                ./flatpak_create_desktop;
                ./flatpak_create_appdata;
                echo;"
            ],
            "dest-filename": "flatpak_create"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'edit';
                ./flatpak_edit_desktop;
                ./flatpak_edit_appdata;
                echo;"
            ],
            "dest-filename": "flatpak_edit"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'install';
                ./flatpak_install_icons;
                ./flatpak_install_pixmaps;
                ./flatpak_install_desktop;
                ./flatpak_install_appdata;
                ./flatpak_install_docs;
                ./flatpak_install_licenses;
                echo;"
            ],
            "dest-filename": "flatpak_install"
        },
        {
            "type": "script",
            "commands": [
                "cd \"$( dirname \"$( readlink -f \"${0}\" )\" )\";",
                "source './flatpak_setup';",
                "echo 'check';
                ./flatpak_check_desktop;
                ./flatpak_check_appdata;
                echo;"
            ],
            "dest-filename": "flatpak_check"
        },
        {
            "type": "shell",
            "commands": [
                "echo 'flatpak scripts: create & edit';
                ./flatpak_create;
                ./flatpak_edit;
                echo;"
            ]
        }
    ],
    "post-install": [
        "echo 'flatpak scripts: install & check';
        [[ \"$( basename \"$( readlink -f . )\" )\" != \"_flatpak_build\" ]] || cd ..;
        pwd;
        ./flatpak_install;
        ./flatpak_check;
        echo;"
    ],
    "cleanup": [
        "bin/wl_render_richtext"
    ]
}
