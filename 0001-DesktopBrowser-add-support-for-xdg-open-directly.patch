From fb139e7099a7187f49e359338856775a57690077 Mon Sep 17 00:00:00 2001
From: Wade Berrier <wberrier@gmail.com>
Date: Sat, 13 Oct 2018 18:10:21 -0600
Subject: [PATCH] DesktopBrowser: add support for xdg-open directly

---
 .../davmail/ui/browser/DesktopBrowser.java    | 10 +++++
 .../davmail/ui/browser/XdgDesktopBrowser.java | 41 +++++++++++++++++++
 2 files changed, 51 insertions(+)
 create mode 100644 src/java/davmail/ui/browser/XdgDesktopBrowser.java

diff --git a/src/java/davmail/ui/browser/DesktopBrowser.java b/src/java/davmail/ui/browser/DesktopBrowser.java
index b0626b07..a341e826 100644
--- a/src/java/davmail/ui/browser/DesktopBrowser.java
+++ b/src/java/davmail/ui/browser/DesktopBrowser.java
@@ -68,6 +68,16 @@ public final class DesktopBrowser {
                     DavGatewayTray.error(new BundleMessage("LOG_UNABLE_TO_OPEN_LINK"), e2);
                 }
             }
+        } catch (java.lang.UnsupportedOperationException e) {
+            if (System.getProperty("os.name").toLowerCase().startsWith("linux")) {
+                try {
+                    XdgDesktopBrowser.browse(location);
+                } catch (Exception e2) {
+                    DavGatewayTray.error(new BundleMessage("LOG_UNABLE_TO_OPEN_LINK"), e2);
+                }
+            } else {
+                DavGatewayTray.error(new BundleMessage("LOG_UNABLE_TO_OPEN_LINK"), e);
+            }
         } catch (Exception e) {
             DavGatewayTray.error(new BundleMessage("LOG_UNABLE_TO_OPEN_LINK"), e);
         }
diff --git a/src/java/davmail/ui/browser/XdgDesktopBrowser.java b/src/java/davmail/ui/browser/XdgDesktopBrowser.java
new file mode 100644
index 00000000..7bb02e75
--- /dev/null
+++ b/src/java/davmail/ui/browser/XdgDesktopBrowser.java
@@ -0,0 +1,41 @@
+/*
+ * DavMail POP/IMAP/SMTP/CalDav/LDAP Exchange Gateway
+ * Copyright (C) 2009  Mickael Guessant
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
+ */
+package davmail.ui.browser;
+
+import java.io.IOException;
+import java.net.URI;
+
+/**
+ * Failover: Runtime.exec open URL
+ */
+public final class XdgDesktopBrowser {
+    private XdgDesktopBrowser() {
+    }
+
+    /**
+     * Open default browser at location URI.
+     * Use xdg-open to open browser url
+     *
+     * @param location location URI
+     * @throws IOException on error
+     */
+    public static void browse(URI location) throws IOException {
+        Runtime.getRuntime().exec("xdg-open " + location.toString());
+    }
+}
-- 
2.17.2

