id: de.bwravencl.ControllerBuddy
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: launch.sh
finish-args:
  - --device=all
  - --env=JAVA_TOOL_OPTIONS=-Dawt.useSystemAAFontSettings=gasp
  - --filesystem=xdg-documents
  - --persist=.java
  - --share=network
  - --socket=x11
  - --share=ipc
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.Flatpak
modules:
  - name: ControllerBuddy
    buildsystem: simple
    build-commands:
      - |
        cp -R ControllerBuddy/* /app/ &&
        install -Dm 755 launch.sh -t /app/bin &&
        install -Dm 644 icon.svg "/app/share/icons/hicolor/scalable/apps/$FLATPAK_ID.svg" &&
        install -Dm 644 "$FLATPAK_ID.desktop" -t /app/share/applications &&
        install -Dm 644 "$FLATPAK_ID.metainfo.xml" -t /app/share/metainfo &&
        cp -R ControllerBuddy-Profiles /app/share/
    sources:
      - type: archive
        only-arches:
          - x86_64
        url: https://github.com/bwRavencl/ControllerBuddy/releases/download/1.3.66-639d789/ControllerBuddy-linux-x86-64-1.3.66-639d789.tgz
        sha256: f139aecc5f16575d32b614b0abed585a28b2e27c9b89d8918cc1ed044bbbda79
        strip-components: 0
        x-checker-data:
          type: anitya
          project-id: 376393
          stable-only: false
          url-template: https://github.com/bwRavencl/ControllerBuddy/releases/download/$version/ControllerBuddy-linux-x86-64-$version.tgz
      - type: archive
        only-arches:
          - aarch64
        url: https://github.com/bwRavencl/ControllerBuddy/releases/download/1.3.66-639d789/ControllerBuddy-linux-aarch64-1.3.66-639d789.tgz
        sha256: b9896700fd131ce78295020bea5b6e2e71ce158099552b0155d1f21b1c6a8b30
        strip-components: 0
        x-checker-data:
          type: anitya
          project-id: 376393
          stable-only: false
          url-template: https://github.com/bwRavencl/ControllerBuddy/releases/download/$version/ControllerBuddy-linux-aarch64-$version.tgz
      - type: file
        url: https://raw.githubusercontent.com/bwRavencl/ControllerBuddy/refs/tags/1.3.66-639d789/icon.svg
        sha256: 22cb081b000a30f248e6c5f842a9519d933339d01449fe2889e3379cc5628523
        x-checker-data:
          type: anitya
          project-id: 376393
          stable-only: false
          url-template: https://raw.githubusercontent.com/bwRavencl/ControllerBuddy/refs/tags/$version/icon.svg
      - type: script
        dest-filename: launch.sh
        commands:
          - |
            script=$(cat << 'EOF'
            function check_pkexec_installed() {
                which pkexec >/dev/null 2>/dev/null
                check_retval 'pkexec is not installed. Please restart this script after manually installing pkexec.'
            }

            function show_message() {
                flatpak run --command=zenity "$FLATPAK_ID" --window-icon /app/share/icons/hicolor/scalable/apps/"$FLATPAK_ID".svg --"$1" --text "$2" --width 450
            }

            function check_retval() {
                if [ "$?" -ne 0 ]
                then
                    show_message error "<b>Error:</b> $1"
                    exit 1
                fi
            }

            function add_line_if_missing() {
                if [ ! -f "$1" ] || ! grep -qxF "$2" "$1"
                then
                    show_message info "Please authenticate to add missing line\n<tt><small>$2</small></tt>\nto file <tt><small>$1</small></tt>."
                    check_pkexec_installed
                    echo "$2" | pkexec tee -a "$1" >/dev/null 2>/dev/null
                    check_retval "Failed to write file <tt><small>$1</small></tt>."
                    reboot_required=true
                fi
            }

            cb_group=controllerbuddy
            if ! getent group "$cb_group" >/dev/null
            then
                show_message info "Please authenticate to create the '$cb_group' group."
                check_pkexec_installed
                pkexec groupadd -f "$cb_group"
                check_retval "Failed to create the '$cb_group' group."
                reboot_required=true
            fi

            if ! id -nGz "$USER" | grep -qzxF "$cb_group"
            then
                show_message info "Please authenticate to add user '$USER' to the '$cb_group' group."
                check_pkexec_installed
                pkexec gpasswd -a "$USER" "$cb_group"
                check_retval "Failed to add user '$USER' to the '$cb_group' group."
                reboot_required=true
            fi

            add_line_if_missing '/etc/udev/rules.d/99-controllerbuddy.rules' 'KERNEL=="uinput", SUBSYSTEM=="misc", MODE="0660", GROUP="controllerbuddy"'
            add_line_if_missing '/etc/udev/rules.d/99-controllerbuddy.rules' 'KERNEL=="hidraw*", SUBSYSTEM=="hidraw", ATTRS{idVendor}=="054c", ATTRS{idProduct}=="05c4", MODE="0660", GROUP="controllerbuddy"'
            add_line_if_missing '/etc/udev/rules.d/99-controllerbuddy.rules' 'KERNEL=="hidraw*", SUBSYSTEM=="hidraw", ATTRS{idVendor}=="054c", ATTRS{idProduct}=="09cc", MODE="0660", GROUP="controllerbuddy"'
            add_line_if_missing '/etc/udev/rules.d/99-controllerbuddy.rules' 'KERNEL=="hidraw*", SUBSYSTEM=="hidraw", ATTRS{idVendor}=="054c", ATTRS{idProduct}=="0ba0", MODE="0660", GROUP="controllerbuddy"'
            add_line_if_missing '/etc/udev/rules.d/99-controllerbuddy.rules' 'KERNEL=="hidraw*", SUBSYSTEM=="hidraw", ATTRS{idVendor}=="054c", ATTRS{idProduct}=="0ce6", MODE="0660", GROUP="controllerbuddy"'
            add_line_if_missing '/etc/modules-load.d/uinput.conf' 'uinput'

            if [ "$reboot_required" = true ]
            then
                show_message warning '<b>Important:</b> System configuration has been modified.\nPlease reboot your system!'
                exit 1
            fi
            EOF
            )

            if ! flatpak-spawn --host /bin/bash -c "FLATPAK_ID=$FLATPAK_ID ; $script"
            then
                exit "$?"
            fi

            CONTROLLER_BUDDY_PROFILES_DIR=/app/share/ControllerBuddy-Profiles ControllerBuddy "$@"
      - type: file
        path: de.bwravencl.ControllerBuddy.desktop
      - type: file
        path: de.bwravencl.ControllerBuddy.metainfo.xml
      - type: git
        url: https://github.com/bwRavencl/ControllerBuddy-Profiles.git
        branch: 1.3
        commit: 0e2deb591d6695aba4d4ae51ddc6bc43572a8359
        dest: ControllerBuddy-Profiles
