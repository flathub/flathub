app-id: io.github.sigmasd.pingmonitor

runtime: org.gnome.Platform
runtime-version: "48"
sdk: org.gnome.Sdk

command: run.sh

finish-args:
  - --share=network
  # display
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  # gtk4 wants to access gpu
  - --device=dri

modules:
  - name: pingmonitor
    buildsystem: simple
    build-options:
      env:
        DENO_DIR: deno_dir
        DENORT_BIN: denort
    build-commands:
      - mkdir node_modules # why is this neeeded? TODO fix it
      - ./deno compile --no-check --cached-only --vendor -o pingmon -A --include src/frontend/ --include src/backend  src/webview/main.ts

      - install -Dm755 pingmon /app/bin/pingmon
      - install -Dm755 run.sh /app/bin/run.sh
      - install -D libwebview.*.so -t /app/bin/

      - install -Dm644 distro/io.github.sigmasd.pingmonitor.desktop -t /app/share/applications/
      - install -Dm644 distro/io.github.sigmasd.pingmonitor.svg -t /app/share/icons/hicolor/scalable/apps/
      - install -Dm644 distro/io.github.sigmasd.pingmonitor.metainfo.xml -t /app/share/metainfo/

    sources:
      # app
      - type: archive
        url: https://github.com/sigmaSd/pingmonitor/archive/refs/tags/0.2.0.tar.gz
        sha256: caf8f16ca7ee167b589aef46f1fe93046814e0504913af62e8acc434739021af

      # deno
      - type: archive
        url: https://github.com/denoland/deno/releases/download/v2.3.1/deno-x86_64-unknown-linux-gnu.zip
        sha256: b2920265e633215959b09a32b67f46c93362842bbfd27c96e8acc2d24b66f563
        only-arches:
          - x86_64
      - type: archive
        url: https://github.com/denoland/deno/releases/download/v2.3.1/denort-x86_64-unknown-linux-gnu.zip
        sha256: 611c72c6e3de743c3f04eeb5f43cfb94dee7a232c7142d63f1967478bd220d11
        only-arches:
          - x86_64
      - type: archive
        url: https://github.com/denoland/deno/releases/download/v2.3.1/deno-aarch64-unknown-linux-gnu.zip
        sha256: 3771ede34037694591846166f6211e7a8ab5cd77a1e7143e637d4457e8708dc7
        only-arches:
          - aarch64
      - type: archive
        url: https://github.com/denoland/deno/releases/download/v2.3.1/denort-aarch64-unknown-linux-gnu.zip
        sha256: bec92b837f50d0330a532a53fcbcf8383eed3d5e4575d893cca59c50d4724c1f
        only-arches:
          - aarch64

      # libwebview ffi library
      - type: file
        url: https://github.com/webview/webview_deno/releases/download/0.9.0/libwebview.x86_64.so
        sha256: 5a66b75e14e9360d5c24ba53574e5ed5b1b476843623721aae8fc47a15a69a42
        only-arches:
          - x86_64
      - type: file
        url: https://github.com/webview/webview_deno/releases/download/0.9.0/libwebview.aarch64.so
        sha256: e9ee12c1fe6f0c587c37cca827586bf5c202fd7e04afcd01b780c993878d132a
        only-arches:
          - aarch64

      # run script
      - type: script
        dest-filename: run.sh
        commands:
          # https://discourse.gnome.org/t/how-to-fix-evolution-not-starting-after-update/25389
          - WEBKIT_DISABLE_SANDBOX_THIS_IS_DANGEROUS=1 PLUGIN_URL=/app/bin exec pingmon "$@"

      - deno-sources.json
