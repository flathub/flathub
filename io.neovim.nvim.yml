app-id:              io.neovim.nvim

runtime:             org.freedesktop.Sdk
runtime-version:     '18.08'
sdk:                 org.freedesktop.Sdk

command:             nvim
rename-desktop-file: nvim.desktop
rename-icon:         nvim

finish-args:
  # Edit anything
  - --filesystem=host
  # Plugin updates
  - --share=network


modules:
  - name: libuv
    sources:
      - type: archive
        url: https://github.com/libuv/libuv/archive/v1.23.1.tar.gz
        sha256: c3386003522502d712010b852008b22b37f827e207e184e3d53f0431389299c3
    cleanup:
      - /include
      - /lib/pkgconfig
      - "*.a"
      - "*.la"


  - name: msgpack-c
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/msgpack/msgpack-c/releases/download/cpp-3.1.1/msgpack-3.1.1.tar.gz
        sha256: 8592d12e19ac3796889b8358bc8f78df9272e6aa7a9ea1834bafd68e4073549a
    cleanup:
      - /include
      - /lib/cmake
      - /lib/pkgconfig
      - "*.a"


  - name: LuaJIT
    no-autogen: true
    sources:
      - type: archive
        url: http://luajit.org/download/LuaJIT-2.1.0-beta2.tar.gz
        sha256: 713924ca034b9d99c84a0b7b701794c359ffb54f8e3aa2b84fad52d98384cf47
      - type: shell
        commands:
          - sed -i 's|/usr/local|/app|' ./Makefile
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
      - "*.a"


  - name: lpeg
    no-autogen: true
    no-make-install: true
    make-args:
      - LUADIR=/app/include/luajit-2.0/
    post-install:
      - install -Dm755 -t /app/lib/lua/5.1/ lpeg.so
      - install -Dm644 -t /app/share/lua/5.1/ re.lua
    sources:
      - type: archive
        url: http://www.inf.puc-rio.br/~roberto/lpeg/lpeg-1.0.1.tar.gz
        sha256: 62d9f7a9ea3c1f215c77e0cadd8534c6ad9af0fb711c3f89188a8891c72f026b


  - name: mpack-lua
    no-autogen: true
    make-args:
      - USE_SYSTEM_MPACK=yes
      - LUA_INCLUDE=-I/app/include/luajit-2.0/
    make-install-args:
      - USE_SYSTEM_MPACK=yes
    sources:
      - type: archive
        url: https://github.com/libmpack/libmpack-lua/archive/1.0.7.tar.gz
        sha256: 2ebe9c8972c378040c9b8505f5fb40a0c64d990cd68be6a62989362b18294d0a
      - type: shell
        commands:
          - sed -i "s|/usr/lib|/app/lib|" ./Makefile
    modules:
      - name: mpack
        no-autogen: true
        make-install-args:
          - PREFIX=/app
        sources:
          - type: archive
            url: https://github.com/libmpack/libmpack/archive/1.0.5.tar.gz
            sha256: 4ce91395d81ccea97d3ad4cb962f8540d166e59d3e2ddce8a22979b49f108956
        cleanup:
          - /include
          - /lib/pkgconfig
          - "*.la"


  - name: libvterm
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/neovim/libvterm/archive/cfde7f2095f00fe3b54418af0b77d3f69c20f71e.tar.gz
        sha256: 2c48681a691e565a9d7801de0e43d0bfd1f09a3c3196b1e4d07cc81d1b118946
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - "*.a"
      - "*.la"


  - name: jemalloc
    sources:
      - type: archive
        url: https://github.com/jemalloc/jemalloc/releases/download/5.1.0/jemalloc-5.1.0.tar.bz2
        sha256: 5396e61cc6103ac393136c309fae09e44d74743c86f90e266948c50f3dbb7268
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
      - /share/doc
      - "*.a"


  - name: unibilium
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/mauke/unibilium/archive/v2.0.0.tar.gz
        sha256: 78997d38d4c8177c60d3d0c1aa8c53fd0806eb21825b7b335b1768d7116bc1c1
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/man
      - "*.la"


  - name: libtermkey
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: http://www.leonerd.org.uk/code/libtermkey/libtermkey-0.20.tar.gz
        sha256: 6c0d87c94ab9915e76ecd313baec08dedf3bd56de83743d9aa923a081935d2f5
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/man
      - "*.la"


  - name: neovim
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    post-install:
      - mkdir -p /app/share/icons/hicolor/128x128
      - mv /app/share/pixmaps /app/share/icons/hicolor/128x128/apps
      - install -Dm644 ../neovim-mark.svg /app/share/icons/hicolor/scalable/apps/nvim.svg
    sources:
      - type: archive
        url: https://github.com/neovim/neovim/archive/v0.3.1.tar.gz
        sha256: bc5e392d4c076407906ccecbc283e1a44b7832c2f486cad81aa04cc29973ad22
      - type: archive
        url: https://neovim.io/logos/neovim-logos.zip
        sha256: c899d052fb8c31b124746fc33bde5a23ff8b02d323b42a0dd8dd66b57b81d20d
