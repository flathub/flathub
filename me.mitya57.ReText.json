{
    "app-id": "me.mitya57.ReText",
    "base": "io.qt.qtwebkit.BaseApp",
    "base-version": "stable",
    "runtime": "org.kde.Platform",
    "runtime-version": "5.9",
    "sdk": "org.kde.Sdk",
    "command": "retext",
    "rename-icon": "retext",
    "finish-args": [
        "--share=ipc",
        "--socket=x11",
        "--socket=wayland",
        "--socket=pulseaudio",
        "--share=network",
        "--filesystem=host",
        "--filesystem=xdg-run/dconf", "--filesystem=~/.config/dconf:ro",
        "--talk-name=ca.desrt.dconf", "--env=DCONF_USER_CONFIG_DIR=.config/dconf",
        "--env=QTWEBENGINE_DISABLE_SANDBOX=1",
        "--env=PYTHONPATH=/app/lib/python3/dist-packages",
        "--device=dri"
    ],
    "build-options" : {
        "cflags": "-O2 -g -Wno-deprecated-declarations -fstack-protector-strong -D_FORTIFY_SOURCE=2",
        "cxxflags": "-O2 -g -Wno-deprecated-declarations -fstack-protector-strong -D_FORTIFY_SOURCE=2",
        "ldflags": "-fstack-protector-strong -Wl,-z,relro,-z,now",
        "env": {
            "V": "1"
        }
    },
    "modules": [
        {
            "name": "xmlstarlet",
            "config-opts": [
                "--prefix=/app/opt/xmlstarlet",
                "--exec-prefix=/app/opt/xmlstarlet",
                "--disable-static-libs",
                "--with-libxml-libs-prefix=/usr/lib",
                "--with-libxml-include-prefix=/usr/include/libxml2"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "http://downloads.sourceforge.net/xmlstar/xmlstarlet-1.6.1.tar.gz",
                    "sha256": "15d838c4f3375332fd95554619179b69e4ec91418a3a5296e7c631b7ed19e7ca"
                },
                {
                    "type": "shell",
                    "commands": [
                        "sed -r -i 's/^([[:blank:]]*XSTAR_LIB_CHECK[[:blank:]]*\\(\\[LIBXML\\],[[:blank:]]*\\[)xml2-config(\\]\\))/\\1pkg-config libxml-2.0\\2/' 'configure.ac';",
                        "sed -r -i 's/^([[:blank:]]*XSTAR_LIB_CHECK[[:blank:]]*\\(\\[LIBXSLT\\],[[:blank:]]*\\[)xslt-config(\\]\\))/\\1pkg-config libxslt\\2/' 'configure.ac';",
                        "grep -Ei 'XSTAR_LIB_CHECK' 'configure.ac' || :;"
                    ]
                },
                {
                    "type": "shell",
                    "commands": [
                        "sed -r -i 's/^(\\[LIBXML_REQUIRED_VERSION=)/#\\1/' 'configure.ac';",
                        "sed -r -i 's/^(\\[LIBXSLT_REQUIRED_VERSION=)/#\\1/' 'configure.ac';",
                        "grep -Ei '_REQUIRED_VERSION' 'configure.ac' || :;"
                    ]
                },
                {
                    "type": "shell",
                    "commands": [
                        "autoreconf -i;"
                    ]
                }
            ],
            "post-install": [
                "echo 'post-install: symlink';",
                "[[ -f '/app/opt/xmlstarlet/bin/xmlstarlet' ]] || ln -s 'xml' '/app/opt/xmlstarlet/bin/xmlstarlet';"
            ],
            "cleanup": [
                "/opt/xmlstarlet/share/doc",
                "/opt/xmlstarlet/share/man"
            ]
        },
        {
            "name": "imagemagick",
            "config-opts": [
                "--prefix=/app/opt/imagemagick",
                "--exec-prefix=/app/opt/imagemagick",
                "--with-rsvg",
                "--disable-static"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://www.imagemagick.org/download/ImageMagick-6.9.9-43.tar.xz",
                    "sha256": "66c2937728ae3f385d84691a360d74993675f43ae16236773daa3a49c3ea6e27"
                }
            ],
            "cleanup": [
                "/opt/imagemagick/share/doc",
                "/opt/imagemagick/share/man"
            ]
        },
        {
            "name": "python3-qt5",
            "no-autogen": true,
            "modules": [
                {
                    "name": "python3-sip",
                    "no-autogen": true,
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://downloads.sourceforge.net/pyqt/sip-4.19.8.tar.gz",
                            "sha256": "7eaf7a2ea7d4d38a56dd6d2506574464bddf7cf284c960801679942377c297bc"
                        },
                        {
                            "type": "shell",
                            "commands": [
                                "python3 configure.py --bindir=/app/bin --destdir=/app/lib/python3/dist-packages --incdir=/app/include/python3 --sipdir=/app/share/sip --stubsdir=/app/lib/python3/dist-packages;"
                            ]
                        }
                    ]
                }
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://downloads.sourceforge.net/pyqt/PyQt5_gpl-5.9.2.tar.gz",
                    "sha256": "c190dac598c97b0113ca5e7a37c71c623f02d1d713088addfacac4acfa4b8394"
                },
                {
                    "type": "shell",
                    "commands": [
                        "QMAKEPATH=/app/lib python3 configure.py PREFIX=/app --verbose --confirm-license --sip-incdir=/app/include/python3 --bindir=/app/bin --destdir=/app/lib/python3/dist-packages --designer-plugindir=/app/lib/plugins/designer --qml-plugindir=/app/lib/plugins/PyQt5 --sipdir=/app/share/sip --stubsdir=/app/lib/python3/dist-packages/PyQt5;"
                    ]
                }
            ],
            "cleanup": [
                "/bin"
            ]
        },
        {
            "name": "python3-docutils",
            "no-autogen": true,
            "sources": [
                {
                    "type": "file",
                    "url": "https://pypi.python.org/packages/36/fa/08e9e6e0e3cbd1d362c3bbee8d01d0aedb2155c4ac112b19ef3cae8eed8d/docutils-0.14-py3-none-any.whl",
                    "sha256": "02aec4bd92ab067f6ff27a38a38a41173bf01bed8f89157768c1573f53e474a6"
                },
                {
                    "type": "shell",
                    "commands": [
                        "echo 'all:\n\ninstall:\n\tpip3 install --prefix=/app docutils-*.whl;\n' > makefile;"
                    ]
                }
            ]
        },
        {
            "name": "python3-pyenchant",
            "no-autogen": true,
            "modules": [
                {
                    "name": "enchant",
                    "config-opts": ["--disable-static", "--with-myspell-dir=/usr/share/hunspell"],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://www.abisource.com/downloads/enchant/1.6.0/enchant-1.6.0.tar.gz",
                            "sha256": "2fac9e7be7e9424b2c5570d8affe568db39f7572c10ed48d4e13cddf03f7097f"
                        },
                        {
                            "type": "shell",
                            "commands": [
                                "cp -f /usr/share/gnu-config/config.sub .;",
                                "cp -f /usr/share/gnu-config/config.guess .;"
                            ]
                        }
                   ]
                }
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://pypi.python.org/packages/9e/54/04d88a59efa33fefb88133ceb638cdf754319030c28aadc5a379d82140ed/pyenchant-2.0.0.tar.gz",
                    "sha256": "fc31cda72ace001da8fe5d42f11c26e514a91fa8c70468739216ddd8de64e2a0"
                },
                {
                    "type": "shell",
                    "commands": [
                        "echo 'all:\n\ninstall:\n\tpython3 setup.py build; python3 setup.py install -O1 --skip-build --prefix=/app --root=/;\n' > makefile;"
                    ]
                }
            ]
        },
        {
            "name": "python3-markdown",
            "no-autogen": true,
            "sources": [
                {
                    "type": "file",
                    "url": "https://pypi.python.org/packages/6d/7d/488b90f470b96531a3f5788cf12a93332f543dbab13c423a5e7ce96a0493/Markdown-2.6.11-py2.py3-none-any.whl",
                    "sha256": "9ba587db9daee7ec761cfc656272be6aabe2ed300fece21208e4aab2e457bc8f"
                },
                {
                    "type": "shell",
                    "commands": [
                        "echo 'all:\n\ninstall:\n\tpip3 install --prefix=/app Markdown-*.whl;\n' > makefile;"
                    ]
                }
            ]
        },
        {
            "name": "python3-markdown-math",
            "no-autogen": true,
            "sources": [
                {
                    "type": "file",
                    "url": "https://pypi.python.org/packages/67/40/dcee47c6be5218a4c740e7404089885d384c878987ec8d790ea291bf685d/python_markdown_math-0.5-py2.py3-none-any.whl",
                    "sha256": "2c3225794b40375445d1949e427ee549edfcc0a534740b3245ff70f177c40f1e"
                },
                {
                    "type": "shell",
                    "commands": [
                        "echo 'all:\n\ninstall:\n\tpip3 install --prefix=/app python_markdown_math-*.whl;\n' > makefile;"
                    ]
                }
            ]
        },
        {
            "name": "python3-markups",
            "no-autogen": true,
            "sources": [
                {
                    "type": "file",
                    "url": "https://pypi.python.org/packages/56/c0/d77c6af4f43c00268372fcbaee715dc798ce70c6c6a93ae30bec32af94ed/Markups-3.0.0-py2.py3-none-any.whl",
                    "sha256": "dd00c7f082d375bb63d6eb6873b1f984c9b474829a3ff1f9518202c64538d539"
                },
                {
                    "type": "shell",
                    "commands": [
                        "echo 'all:\n\ninstall:\n\tpip3 install --prefix=/app Markups-*.whl;\n' > makefile;"
                    ]
                }
            ]
        },
        {
            "name": "retext",
            "no-autogen": true,
            "sources": [
                {
                    "type": "archive",
                    "url": "https://pypi.python.org/packages/2a/ba/581591a8a8d48d02236b57633ae5f55247424885e143fe1d21fba904a1ed/ReText-7.0.1.tar.gz",
                    "sha256": "f5a2dbfb32b96423fd3e5ef00488440c36a2bcecbc6356f5c17674b265316eea"
                },
                {
                    "type": "archive",
                    "url": "https://github.com/mquinson/po4a/archive/v0.52.tar.gz",
                    "sha256": "547c410ad3bb8e5fd3939a6acdd39713529187be05fca7235095d57d3f0c6cfc",
                    "strip-components": 0
                },
                {
                    "type": "file",
                    "path": "retext-man-de.po",
                    "sha256": "9b00b30a693a3023b2f5619ab0586ddf9bd8f5bc9b75c2dabd5d6493558bb6f7"
                },
                {
                    "type": "file",
                    "path": "retext.1",
                    "sha256": "300f04c1f808f63351b16ed0fa0f2d01b857c4d096ed71dcf54ab95281727d9a"
                },
                {
                    "type": "shell",
                    "commands": [
                        "echo 'disabling external renderer';",
                        "cp 'ReText/window.py' 'ReText/window.py.bak';",
                        "cp 'ReText/tab.py' 'ReText/tab.py.bak';",
                        "sed -r -i 's/^([[:blank:]]*)(menuEdit\\.addAction\\(self\\.(actionWebKit|actionWebEngine)\\))([[:blank:]]*)$/\\1pass #\\2\\4/' 'ReText/window.py';",
                        "sed -r -i 's/^([[:blank:]]*)(globalSettings\\.(useWebKit|useWebEngine)[[:blank:]]*=[[:blank:]]*)(enable)([[:blank:]]*)$/\\1\\2False\\5/' 'ReText/window.py';",
                        "sed -r -i 's/^(([[:blank:]]*)(if ReTextWebKitPreview and globalSettings\\.useWebKit:)([[:blank:]]*))$/\\2return ReTextPreview\\(self\\)\\n\\1/' 'ReText/tab.py';",
                        "echo 'ReText/window.py';",
                        "diff 'ReText/window.py.bak' 'ReText/window.py' -C 4 || :;",
                        "echo 'ReText/tab.py';",
                        "diff 'ReText/tab.py.bak' 'ReText/tab.py' -C 4 || :;",
                        "rm -f 'ReText/window.py.bak' 'ReText/tab.py.bak';"
                    ]
                },
                {
                    "type": "shell",
                    "commands": [
                        "echo 'all:\n\ninstall:\n\tpython3 setup.py build; python3 setup.py install -O1 --skip-build --prefix=/app --root=/;\n' > makefile;"
                    ]
                }
            ],
            "post-install": [
                "echo 'post-install: manuals';",
                "mkdir -p '/app/share/man/man1'; install -p -m 0644 'retext.1' '/app/share/man/man1/';",
                "appname='retext';
                mkdir -p 'man/de';
                perllib_path=\"$( find po4a-*/lib -mindepth 0 -maxdepth 0 -xtype d | sort -V | head -n 1 )\";
                echo \"${perllib_path}\";
                PERLLIB=\"${perllib_path}\" ./po4a-0.52/po4a-updatepo -v -M utf-8 -f man -m 'retext.1' -p 'retext-man-de.po';
                PERLLIB=\"${perllib_path}\" ./po4a-0.52/po4a-translate -M utf-8 -f man --option groff_code=verbatim -m 'retext.1' -p 'retext-man-de.po' -l \"man/de/${appname}.1\";
                mkdir -p '/app/share/man/de/man1';
                install -p -m 0644 \"man/de/${appname}.1\" '/app/share/man/de/man1/';",
                "echo 'post-install: icons';",
                "appname='retext';
                imagemagick_home='/app/opt/imagemagick';
                imagemagick_lib=\"${imagemagick_home}/lib\";
                imagemagick_bin=\"${imagemagick_home}/bin\";
                if [[ -n \"${LD_LIBRARY_PATH}\" ]]; then
                  LD_LIBRARY_PATH=\"${LD_LIBRARY_PATH}:${imagemagick_lib}\";
                else
                  LD_LIBRARY_PATH=\"${imagemagick_lib}\";
                fi;
                export LD_LIBRARY_PATH;
                if [[ -n \"${PATH}\" ]]; then
                  PATH=\"${PATH}:${imagemagick_bin}\";
                else
                  PATH=\"${imagemagick_bin}\";
                fi;
                export PATH;
                icon='icons/retext.svg';
                for s in {16,22,24,32,48,64,72,96,128,192,256,512}; do
                    size=\"${s}x${s}\";
                    echo \"- ${size}\";
                    mkdir -p \"icons/${size}/\";
                    convert -background none -density 1024 -resize \"${size}\" \"${icon}\" \"icons/${size}/${appname}.png\";
                done;
                find 'icons' -mindepth 2 -maxdepth 2 -xtype f -name \"${appname}.png\" | sort -V | xargs -I{} dirname '{}' | xargs -I{} basename '{}' | while read -r size; do
                    install -p -D -m 0644 \"icons/${size}/${appname}.png\" \"/app/share/icons/hicolor/${size}/apps/${appname}.png\";
                done;
                install -p -D -m 0644 \"${icon}\" \"/app/share/icons/hicolor/scalable/apps/${appname}.svg\"",
                "echo 'post-install: desktop files';",
                "desktop-file-edit --set-key=Icon --set-value='me.mitya57.ReText' data/*.desktop;",
                "desktop-file-install --dir='/app/share/applications' data/*.desktop;",
                "echo 'post-install: metainfo/appdata';",
                "[[ -d /app/share/metainfo ]] || mv /app/share/appdata /app/share/metainfo;",
                "echo 'updating release info';
                xmlstarlet_home='/app/opt/xmlstarlet';
                xmlstarlet_bin=\"${xmlstarlet_home}/bin\";
                if [[ -n \"${PATH}\" ]]; then
                  PATH=\"${PATH}:${xmlstarlet_bin}\";
                else
                  PATH=\"${xmlstarlet_bin}\";
                fi;
                export PATH;
                app_version=\"$( grep -Ei \"^[[:blank:]]*VERSION[[:blank:]]*=[[:blank:]]*'([^']*)'*[[:blank:]]*$\" 'setup.py' 2>/dev/null | tail -n 1 2>/dev/null | sed -re \"s/^[[:blank:]]*VERSION[[:blank:]]*=[[:blank:]]*'([^']*)'*[[:blank:]]*$/\\1/\" 2>/dev/null )\";
                app_date=\"$( date --reference 'changelog.md' -u '+%Y-%m-%d' 2>/dev/null )\";
                find '/app/share/metainfo' -mindepth 1 -maxdepth 1 -xtype f -name '*.appdata.xml' | sort -V | while read -r filename; do
                    if [[ -n \"${app_version}\" && -n \"${app_date}\" ]]; then
                        xmlstarlet sel -t -v '/component/releases/release/@version' \"${filename}\";
                        if [[ \"${?}\" -ne \"0\" ]]; then
                            xmlstarlet ed --inplace -d '/component/releases' -s '/component' -t elem -n 'releases' -s '/component/releases' -t elem -n 'release' -s '/component/releases/release' -t attr -n 'date' -v \"${app_date}\" -s '/component/releases/release' -t attr -n 'version' -v \"${app_version}\" \"${filename}\";
                            xmlstarlet sel -t -c '/component/releases/release' \"${filename}\" | sed -re 's/$/\\n/' || :;
                        fi
                    fi;
                    app_id=\"$( xmlstarlet sel -t -v '/component/id' \"${filename}\" 2>/dev/null | head -n 1 2>/dev/null )\";
                    if [[ -n \"${app_id}\" ]]; then
                        xmlstarlet sel -t -v '/component/launchable' \"${filename}\";
                        if [[ \"${?}\" -ne \"0\" ]]; then
                            xmlstarlet ed --inplace -d '/component/launchable' -s '/component' -t elem -n 'launchable' -v \"${app_id}\" -s '/component/launchable' -t attr -n 'type' -v 'desktop-id' \"${filename}\";
                            xmlstarlet sel -t -c '/component/launchable' \"${filename}\" | sed -re 's/$/\\n/' || :;
                        fi
                    fi;
                done;",
                "echo 'post-install: validate data';",
                "cat /app/share/applications/*.desktop;",
                "desktop-file-validate /app/share/applications/*.desktop || :;",
                "cat /app/share/metainfo/*.appdata.xml;",
                "appstream-util validate-relax --nonet /app/share/metainfo/*.appdata.xml || :;"
            ]
        }
    ],
    "cleanup": [
        "/include",
        "/lib/pkgconfig",
        "/share/cmake",
        "/man",
        "/share/man",
        "/lib/systemd",
        "/opt",
        "*.la",
        "*.a"
    ]
}
