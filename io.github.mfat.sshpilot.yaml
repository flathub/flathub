app-id: io.github.mfat.sshpilot
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
command: sshpilot
finish-args:
  - --share=network
  # - --share=ipc
  - --filesystem=~/.ssh
  - --filesystem=~/.config/sshpilot
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=ssh-auth
  #- --device=dri
  - --persist=.ssh
  - --persist=.config
  #- --filesystem=/tmp
  - --filesystem=xdg-run/gvfs:rw
  - --filesystem=xdg-run/gvfsd
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.freedesktop.Flatpak
  #- --talk-name=org.freedesktop.portal.*
  - --talk-name=org.gtk.vfs.*
  #- --system-talk-name=org.freedesktop.login1
  #- --env=TERM=xterm-256color
  #- --env=SHELL=/bin/bash
  #- --env=PATH=/app/bin:/usr/bin:/bin

cleanup:
  - '/include'
  - '/lib/pkgconfig'
  - '/share/gtk-doc'
  - '/share/man'
  - '*.la'
  - '*.a'

modules:
  - name: sshpass
    buildsystem: autotools
    build-commands:
      - ./configure --prefix=/app
      - make
      - make install
    sources:
      - type: archive
        url: https://sourceforge.net/projects/sshpass/files/sshpass/1.09/sshpass-1.09.tar.gz
        sha256: 71746e5e057ffe9b00b44ac40453bf47091930cba96bbea8dc48717dedc49fb7


  - name: ssh-copy-id
    buildsystem: simple
    build-commands:
    - install -Dm755 ssh-copy-id /app/bin/ssh-copy-id
    sources:
    - type: file
      url: https://raw.githubusercontent.com/openssh/openssh-portable/V_9_6_P1/contrib/ssh-copy-id
      sha256: b625120eeff8b0e64e4e8c71e5ed3a7878fd69d318a88ce0a22e115725f6b815
      dest-filename: ssh-copy-id

      
  - name: libvte
    buildsystem: meson
    config-opts:
      - '-Dvapi=false'
      - '-Dgir=true'
      - '-Ddocs=false'
      - '-Dgnutls=true'
      - '-Dgtk3=false'
      - '-Dgtk4=true'
    sources:
      - type: archive
        url: https://download.gnome.org/sources/vte/0.78/vte-0.78.5.tar.xz
        sha256: bab93bff8d8acb05fc7c81a469e0d17c853da3851ce4be2a66d4d18772163a46

  # Python dependencies - using pre-built wheels to avoid compilation issues
  - name: python3-deps
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} cryptography==42.0.8 paramiko==3.4.1 secretstorage==3.3.3 --no-build-isolation
    sources:
      # cryptography (pre-built wheel)
      - type: file
        url: https://files.pythonhosted.org/packages/49/1c/9f6d13cc8041c05eebff1154e4e71bedd1db8e174fff999054435994187a/cryptography-42.0.8-cp39-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: a0608251135d0e03111152e41f0cc2392d1e74e35703960d4190b2e0f4ca9c70
        only-arches:
          - x86_64

      - type: file
        url: https://files.pythonhosted.org/packages/43/c2/4a3eef67e009a522711ebd8ac89424c3a7fe591ece7035d964419ad52a1d/cryptography-42.0.8-cp39-abi3-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
        sha256: c4783183f7cb757b73b2ae9aed6599b96338eb957233c58ca8f49a49cc32fd5e
        only-arches:
          - aarch64

      # paramiko
      - type: file
        url: https://files.pythonhosted.org/packages/96/6e/4a52a8923d840107024b844d83502dfa6a1e5399ad31cf9d1a4ddbaaa7e5/paramiko-3.4.1-py3-none-any.whl
        sha256: 8e49fd2f82f84acf7ffd57c64311aa2b30e575370dc23bdb375b10262f7eac32
      # PyNaCl
      - type: file
        url: https://files.pythonhosted.org/packages/ee/87/f1bb6a595f14a327e8285b9eb54d41fef76c585a0edef0a45f6fc95de125/PyNaCl-1.5.0-cp36-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.manylinux_2_24_x86_64.whl
        sha256: 0c84947a22519e013607c9be43706dd42513f9e6ae5d39d3613ca1e142fba44d
        only-arches:
          - x86_64

      - type: file
        url: https://files.pythonhosted.org/packages/5d/70/87a065c37cca41a75f2ce113a5a2c2aa7533be648b184ade58971b5f7ccc/PyNaCl-1.5.0-cp36-abi3-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
        sha256: a36d4a9dda1f19ce6e03c9a784a2921a4b726b02e1c736600ca9c22029474394
        only-arches:
          - aarch64

      # bcrypt (pre-built wheel)
      - type: file
        url: https://files.pythonhosted.org/packages/d6/53/ac084b7d985aee1a5f2b086d501f550862596dbf73220663b8c17427e7f2/bcrypt-4.2.1-cp37-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: 8dbd0747208912b1e4ce730c6725cb56c07ac734b3629b60d4398f082ea718ad
        only-arches:
          - x86_64

      - type: file
        url: https://files.pythonhosted.org/packages/8e/ab/b8710a3d6231c587e575ead0b1c45bb99f5454f9f579c9d7312c17b069cc/bcrypt-4.2.1-cp37-abi3-manylinux_2_28_aarch64.whl
        sha256: aaa2e285be097050dba798d537b6efd9b698aa88eef52ec98d23dcd6d7cf6fea
        only-arches:
          - aarch64

      # secretstorage
      - type: file
        url: https://files.pythonhosted.org/packages/54/24/b4293291fa1dd830f353d2cb163295742fa87f179fcc8a20a306a81978b7/SecretStorage-3.3.3-py3-none-any.whl
        sha256: f356e6628222568e3af06f2eba8df495efa13b3b63081dafd4f7d9a7b7bc9f99
      # cffi
      - type: file
        url: https://files.pythonhosted.org/packages/b2/d5/da47df7004cb17e4955df6a43d14b3b4ae77737dff8bf7f8f333196717bf/cffi-1.17.1-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: b62ce867176a75d03a665bad002af8e6d54644fad99a3c70905c543130e39d93
        only-arches:
          - x86_64

      - type: file
        url: https://files.pythonhosted.org/packages/1a/df/f8d151540d8c200eb1c6fba8cd0dfd40904f1b0682ea705c36e6c2e97ab3/cffi-1.17.1-cp312-cp312-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
        sha256: da95af8214998d77a98cc14e3a3bd00aa191526343078b530ceb0bd710fb48a5
        only-arches:
          - aarch64

      # pycparser
      - type: file
        url: https://files.pythonhosted.org/packages/13/a3/a812df4e2dd5696d1f351d58b8fe16a405b234ad2886a0dab9183fb78109/pycparser-2.22-py3-none-any.whl
        sha256: c3702b6d3dd8c7abc1afa565d7e63d53a1d0bd86cdc24edd75470f4de499cfcc
      # jeepney
      - type: file
        url: https://files.pythonhosted.org/packages/b2/a3/e137168c9c44d18eff0376253da9f1e9234d0239e0ee230d2fee6cea8e55/jeepney-0.9.0-py3-none-any.whl
        sha256: 97e5714520c16fc0a45695e5365a2e11b81ea79bba796e26f9f1d178cb182683

  - name: sshpilot
    buildsystem: simple
    build-commands:
      # Install Python package structure
      - install -d /app/lib/python3/site-packages/sshpilot
      - cp -a sshpilot/*.py /app/lib/python3/site-packages/sshpilot/
      - cp -a sshpilot/resources /app/lib/python3/site-packages/sshpilot/
      
      # Install desktop files
      - install -Dm644 sshpilot/resources/sshpilot.svg /app/share/icons/hicolor/scalable/apps/io.github.mfat.sshpilot.svg
      - install -Dm644 io.github.mfat.sshpilot.desktop /app/share/applications/io.github.mfat.sshpilot.desktop
      - install -Dm644 io.github.mfat.sshpilot.metainfo.xml /app/share/metainfo/io.github.mfat.sshpilot.metainfo.xml
      
      # Create launcher script
      - mkdir -p /app/bin
      - install -Dm755 sshpilot-launcher.sh /app/bin/sshpilot


    sources:
      - type: git
        url: "https://github.com/mfat/sshpilot.git"
        tag: v3.8.3
        commit: 9537d3ffac2372a6dd8f8f1adbb747690bf154be
      - type: file
        path: sshpilot-launcher.sh

