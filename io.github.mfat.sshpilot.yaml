app-id: io.github.mfat.sshpilot
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
command: sshpilot
finish-args:
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --filesystem=home
  - --filesystem=/tmp
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.freedesktop.Flatpak
  - --system-talk-name=org.freedesktop.login1
  - --env=TERM=xterm-256color
  - --env=SHELL=/bin/bash

cleanup:
  - '/include'
  - '/lib/pkgconfig'
  - '/share/gtk-doc'
  - '/share/man'
  - '*.la'
  - '*.a'

modules:
  - name: libvte
    buildsystem: meson
    config-opts:
      - '-Dvapi=false'
      - '-Dgir=true'
      - '-Ddocs=false'
      - '-Dgnutls=true'
      - '-Dgtk3=false'
      - '-Dgtk4=true'
    sources:
      - type: archive
        url: https://download.gnome.org/sources/vte/0.78/vte-0.78.5.tar.xz
        sha256: bab93bff8d8acb05fc7c81a469e0d17c853da3851ce4be2a66d4d18772163a46

  - name: python3-deps
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} cryptography==42.0.8 paramiko==3.4.0 secretstorage==3.3.3 --no-build-isolation
    sources:
      # cryptography (pre-built wheel)
      - type: file
        url: https://files.pythonhosted.org/packages/35/66/2d87e9ca95c82c7ee5f2c09716fc4c4242c1ae6647b9bd27e55e920e9f10/cryptography-42.0.8-cp37-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: e599b53fd95357d92304510fb7bda8523ed1f79ca98dce2f43c115950aa78801
      # paramiko
      - type: file
        url: https://files.pythonhosted.org/packages/1a/70/e5c75da44037eea2877deaa4a67b5c50dc93eed8dbe65e87a8e8ce16c6dd/paramiko-3.4.0-py3-none-any.whl
        sha256: 43f0b51115a896f9c00f59618023484cb3a14b98bbceab43394a39c6739b7ee7
      # PyNaCl
      - type: file
        url: https://files.pythonhosted.org/packages/ee/87/f1bb6a595f14a327e8285b9eb54d41fef76c585a0edef0a45f6fc95de125/PyNaCl-1.5.0-cp36-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.manylinux_2_24_x86_64.whl
        sha256: 0c84947a22519e013607c9be43706dd42513f9e6ae5d39d3613ca1e142fba44d
      # bcrypt (pre-built wheel)
      - type: file
        url: https://files.pythonhosted.org/packages/d6/53/ac084b7d985aee1a5f2b086d501f550862596dbf73220663b8c17427e7f2/bcrypt-4.2.1-cp37-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: 8dbd0747208912b1e4ce730c6725cb56c07ac734b3629b60d4398f082ea718ad
      # secretstorage
      - type: file
        url: https://files.pythonhosted.org/packages/54/24/b4293291fa1dd830f353d2cb163295742fa87f179fcc8a20a306a81978b7/SecretStorage-3.3.3-py3-none-any.whl
        sha256: f356e6628222568e3af06f2eba8df495efa13b3b63081dafd4f7d9a7b7bc9f99
      # cffi
      - type: file
        url: https://files.pythonhosted.org/packages/b2/d5/da47df7004cb17e4955df6a43d14b3b4ae77737dff8bf7f8f333196717bf/cffi-1.17.1-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: b62ce867176a75d03a665bad002af8e6d54644fad99a3c70905c543130e39d93
      # pycparser
      - type: file
        url: https://files.pythonhosted.org/packages/f7/3f/01c8b82017c199075f8f788d0d906d9ffbbc5a103e00bd5aa01fd69b2ee6f/pycparser-2.22-py3-none-any.whl
        sha256: c3702b6d3dd8c7abc1afa565d7e63d53a1d0bd86cdc24edd75470f4de499cfcc
      # jeepney
      - type: file
        url: https://files.pythonhosted.org/packages/b2/a3/e137168c9c44d18eff0376253da9f1e9234d0239e0ee230d2fee6cea8e55/jeepney-0.9.0-py3-none-any.whl
        sha256: 97e5714520c16fc0a45695e5365a2e11b81ea79bba796e26f9f1d178cb182683

  - name: sshpilot
    buildsystem: simple
    build-commands:
      # Install Python package structure
      - install -d /app/lib/python3/site-packages/sshpilot
      - cp -a sshpilot/*.py /app/lib/python3/site-packages/sshpilot/
      - cp -a sshpilot/resources /app/lib/python3/site-packages/sshpilot/
      - cp -a sshpilot/ui /app/lib/python3/site-packages/sshpilot/
      
      # Install desktop files
      - install -Dm644 sshpilot/resources/sshpilot.svg /app/share/icons/hicolor/scalable/apps/io.github.mfat.sshpilot.svg
      - install -Dm644 io.github.mfat.sshpilot.desktop /app/share/applications/io.github.mfat.sshpilot.desktop
      - install -Dm644 io.github.mfat.sshpilot.metainfo.xml /app/share/metainfo/io.github.mfat.sshpilot.metainfo.xml
      
      # Create launcher script
      - mkdir -p /app/bin
      - |
        cat > /app/bin/sshpilot << 'EOF'
        #!/usr/bin/env bash
        export PYTHONPATH="/app/lib/python3/site-packages:${PYTHONPATH}"
        export TERM="${TERM:-xterm-256color}"
        export SHELL="${SHELL:-/bin/bash}"
        export SSHPILOT_FLATPAK=1
        exec python3 -m sshpilot.main "${@}"
        EOF
      - chmod +x /app/bin/sshpilot
    sources:
      - type: dir
        path: .