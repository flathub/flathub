# Flatpak manifest for PearPass Desktop Application
# A secure, decentralized and fully local password manager
#
# This manifest builds the application from source.
# Requires network access during build for npm and cmake-pear dependencies.
#
# Build with: flatpak-builder --allow-network --force-clean build-dir com.pear.pass.yml

id: com.pear.pass
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node20
  - org.freedesktop.Sdk.Extension.llvm18
command: pearpass
base: org.electronjs.Electron2.BaseApp
base-version: '24.08'
build-options:
  append-path: /usr/lib/sdk/node20/bin:/usr/lib/sdk/llvm18/bin
  env:
    CC: clang
    CXX: clang++
finish-args:
  # Inter-process communication (required for Electron)
  - --share=ipc
  # Network access (required for peer-to-peer sync functionality)
  - --share=network
  # X11 display (required for GUI)
  - --socket=x11
  # Audio (for notification sounds)
  - --socket=pulseaudio
  # Device access (may be needed for hardware security keys)
  - --device=all
  # System tray support
  - --talk-name=org.kde.StatusNotifierWatcher
  # Cursor theme support
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
  # Screen saver interaction (prevent idle during sensitive operations)
  - --talk-name=org.freedesktop.ScreenSaver
  # Secrets service for keyring integration
  - --talk-name=org.freedesktop.secrets
  # Persistent storage for Pear configuration
  - --persist=.config/pear
  # Persistent storage for PearPass vault data
  - --persist=.pearpass
modules:
  - name: pearpass-x64
    only-arches:
      - x86_64
    buildsystem: simple
    build-commands:
      # Install bare-make build tool globally
      - npm install -g bare-make
      # Install appling build dependencies
      - cd appling && npm install --legacy-peer-deps
      # Generate CMake build files for Linux x64
      - cd appling && bare-make generate --platform linux --arch x64
      # Build the application
      - cd appling && bare-make build
      # Find and install the built binary (AppImage or executable)
      - |
        BINARY=$(find . -type f -name "*.AppImage" | head -1)
        if [ -n "$BINARY" ]; then
          chmod +x "$BINARY"
          "$BINARY" --appimage-extract
          cp -r squashfs-root/usr/* /app/ 2>/dev/null || true
          install -Dm755 squashfs-root/AppRun /app/bin/pearpass
        else
          BINARY=$(find . -type f -name "pearpass" -executable | head -1)
          install -Dm755 "$BINARY" /app/bin/pearpass
        fi
      # Install AppStream metainfo
      - install -Dm644 com.pear.pass.metainfo.xml /app/share/metainfo/com.pear.pass.metainfo.xml
      # Install application icon (512x512)
      - install -Dm644 com.pear.pass.png /app/share/icons/hicolor/512x512/apps/com.pear.pass.png
      # Install desktop entry
      - install -Dm644 com.pear.pass.desktop /app/share/applications/com.pear.pass.desktop
    sources:
      # Source code from GitHub repository
      - type: archive
        url: https://github.com/tetherto/pearpass-app-desktop/archive/refs/tags/v1.0.1.tar.gz
        sha512: 5974afe2acb4b0263f5da90106da7e513a561c73a9fd80375d6de589668e55eaec6f91dcf1d8ae6644137a2635e485baf70e969734e18c387e57d026b3779fa2
        strip-components: 1
      # Application icon
      - type: file
        url: https://pass.pears.com/wp-content/uploads/downloads/pearpass-logo-512x512.png
        sha512: 08dcb60ad2671e1c3218c7fbd2323a9cf7a97a80ab460307bd1c85d91334b2052033d7ad8651ef4e88e0b31af59ffc002785ac76f0945108ef317a242f1bd040
        dest-filename: com.pear.pass.png
      # AppStream metainfo XML (from GitHub repository)
      - type: file
        url: https://raw.githubusercontent.com/tetherto/pearpass-app-desktop/main/flatpak/com.pear.pass.metainfo.xml
        sha512: ebb3dd7d499e2390fa9105dfaa0717b6c85e2d31329b32a36d325d43d7edbf84b1f7363ae81ac0326addcacd5fe7d4322e83bd4d5c3049cc2c92bb103ae1035c
      # Desktop entry file (from GitHub repository)
      - type: file
        url: https://raw.githubusercontent.com/tetherto/pearpass-app-desktop/main/flatpak/com.pear.pass.desktop
        sha512: 961567834706eb09a8c45009c828ee0d1ec04d9969eafb87502855f408e9fd0e84b6c02ae4bea9671601f47878495b5d3398324aeba4f640f8617441b18931a2
