From 727e6857c8e820091642fdc7c1a45e9f23745b64 Mon Sep 17 00:00:00 2001
From: Keeyou <keeyou-cn@outlook.com>
Date: Thu, 8 Aug 2024 12:04:36 +0800
Subject: [PATCH] flatpak: fix aarch64 build

similar issue seen in https://github.com/nodejs/node/issues/48008
---
 CMakeLists.txt                  | 5 +++++
 third_party/zlib/CMakeLists.txt | 2 ++
 2 files changed, 7 insertions(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index bbf0cf48..dd4fc42d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -1837,6 +1837,11 @@ if (FREEBSD AND OS_X86)
   add_compile_options(-msse2)
 endif()
 
+# make boringssl capable on aarch64
+if (LINUX AND OS_AARCH64)
+  add_compile_options($<$<COMPILE_LANGUAGE:ASM>:-march=armv8-a+crypto>)
+endif()
+
 # *****************************************************************************************
 #           Libc++ Library
 # *****************************************************************************************
diff --git a/third_party/zlib/CMakeLists.txt b/third_party/zlib/CMakeLists.txt
index 9e28f07b..a571bedc 100644
--- a/third_party/zlib/CMakeLists.txt
+++ b/third_party/zlib/CMakeLists.txt
@@ -160,6 +160,8 @@ elseif(ZLIB_USE_ARM_NEON)
     target_compile_definitions(zlib PUBLIC "ARMV8_OS_ANDROID")
   elseif (CMAKE_SYSTEM_NAME STREQUAL "Linux")
     target_compile_definitions(zlib PUBLIC "ARMV8_OS_LINUX")
+    target_compile_options(zlib PRIVATE -march=armv8-a+crypto)
+    target_compile_options(zlib PRIVATE -Wa,-march=armv8-a+crypto)
   elseif (APPLE AND NOT IOS)
     target_compile_definitions(zlib PUBLIC "ARMV8_OS_MACOS")
   elseif (IOS)
-- 
2.46.0

