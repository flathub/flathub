From 382e3ee495b3302c9e572d9b09f5732127a1d86d Mon Sep 17 00:00:00 2001
From: Keeyou <keeyou-cn@outlook.com>
Date: Thu, 8 Aug 2024 12:04:36 +0800
Subject: [PATCH] flatpak: fix aarch64 build

reference: https://gcc.gnu.org/onlinedocs/gcc/AArch64-Options.html
---
 CMakeLists.txt                | 5 +++++
 third_party/zlib/crc32_simd.c | 2 +-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index bbf0cf48..dd4fc42d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -1837,6 +1837,11 @@ if (FREEBSD AND OS_X86)
   add_compile_options(-msse2)
 endif()
 
+# make boringssl capable on aarch64
+if (LINUX AND OS_AARCH64)
+  add_compile_options($<$<COMPILE_LANGUAGE:ASM>:-march=armv8-a+crypto>)
+endif()
+
 # *****************************************************************************************
 #           Libc++ Library
 # *****************************************************************************************
diff --git a/third_party/zlib/crc32_simd.c b/third_party/zlib/crc32_simd.c
index cbe97395..1c60ae9b 100644
--- a/third_party/zlib/crc32_simd.c
+++ b/third_party/zlib/crc32_simd.c
@@ -398,7 +398,7 @@ uint32_t ZLIB_INTERNAL crc32_sse42_simd_(  /* SSE4.2+PCLMUL */
  */
 #include <arm_acle.h>
 #include <arm_neon.h>
-#define TARGET_ARMV8_WITH_CRC __attribute__((target("arch=armv8-a+crc")))
+#define TARGET_ARMV8_WITH_CRC __attribute__((target("arch=armv8-a+crc+crypto")))
 #else  // !defined(__GNUC__) && !defined(_aarch64__)
 #error ARM CRC32 SIMD extensions only supported for Clang and GCC
 #endif
-- 
2.46.0

