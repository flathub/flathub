{
  "app-id": "cx.ring.RingGnome",
  "branch": "1.0.0",
  "runtime": "org.gnome.Platform",
  "runtime-version": "3.26",
  "sdk": "org.gnome.Sdk",
  "command": "ring.cx",
  "finish-args": [
    "--socket=x11",
    "--socket=wayland",
    "--socket=pulseaudio",
    "--share=network",
    "--device=all",
    "--share=ipc",
    "--talk-name=org.freedesktop.secrets",
    "--talk-name=org.freedesktop.Notifications",
    "--talk-name=org.gnome.SettingsDaemon",
    "--talk-name=org.gnome.SettingsDaemon.MediaKeys",
    "--talk-name=org.mate.SettingsDaemon",
    "--talk-name=org.gnome.ScreenSaver",
    "--talk-name=org.cinnamon.ScreenSaver",
    "--talk-name=org.freedesktop.ScreenSaver",
    "--talk-name=com.canonical.Unity.Session",
    "--talk-name=org.kde.StatusNotifierWatcher",
    "--talk-name=com.canonical.indicator.application",
    "--filesystem=xdg-run/dconf",
    "--filesystem=~/.config/dconf:ro",
    "--talk-name=ca.desrt.dconf",
    "--own-name=cx.ring.Ring",
    "--env=DCONF_USER_CONFIG_DIR=.config/dconf"
  ],
  "build-options":{
    "strip":true
  },
  "cleanup": [
    "*.a",
    "*.la",
    "*.prl",
    "/doc",
    "/include",
    "/libexec",
    "/mkspecs",
    "/etc",
    "/lib/pkgconfig",
    "/lib/cmake",
    "/lib/debug",
    "/lib/cmake",
    "/lib/systemd",
    "/lib/udev",
    "/share/man",
    "/share/pkgconfig",
    "/share/vala"
  ],
  "cleanup-commands":[
    "mkdir /app/tmp",
    "cp /app/bin/{gnome-ring,ring.cx} /app/tmp",
    "rm -rf /app/bin/*",
    "mv /app/tmp/* /app/bin",
    "rm -rf /app/share/dbus-1/services/org.gnome.evolution.dataserver.*",
    "rm -rf /app/tmp"
  ],
  "rename-desktop-file":"gnome-ring.desktop",
  "rename-appdata-file":"gnome-ring.appdata.xml",
  "rename-icon":"ring",
    "modules": [
    {
      "name":"ring-client-gnome",
      "buildsystem":"cmake",
      "config-opts":[
        "-DCMAKE_INSTALL_PREFIX=/app",
        "-DCMAKE_BUILD_TYPE=Release",
        "-DUSE_APPINDICATOR=off"
      ],
      "sources":[
        {
          "type":"git",
          "url":"https://github.com/savoirfairelinux/ring-client-gnome.git",
          "commit": "96c0b8bf8105973b223bbcccc609554deca1d0c2"
        }
      ],
      "modules":[
        {
          "name":"libRingClient",
          "buildsystem":"cmake",
          "config-opts":["-DCMAKE_INSTALL_PREFIX=/app","-DCMAKE_BUILD_TYPE=Release"],
          "sources":[
            {
              "type":"git",
              "url":"https://github.com/savoirfairelinux/ring-lrc.git",
              "commit": "7bf0da949c796bc804c33cf642048ae84bfedf5e"
            }
          ],
          "modules":[
            {
              "name": "ring-deamon",
              "config-opts":["--enable-static","--enable-ipv6"],
              "sources": [
                {
                  "type": "git",
                  "url": "https://github.com/savoirfairelinux/ring-daemon.git",
                  "commit": "102dabcf1e7c180ea40210a08c0baf5d7ff68fd3"
                }
              ],
              "modules":[
                {
                  "name":"pjproject",
                  "build-options":{
                    "cflags":  "-fPIC",
                    "cxxflags":"-fPIC",
                    "ldflags": "-fPIC"
                  },
                  "sources": [
                    {
                      "type":"archive",
                      "url": "http://www.pjsip.org/release/2.6/pjproject-2.6.tar.bz2",
                      "sha256":"2f5a1da1c174d845871c758bd80fbb580fca7799d3cfaa0d3c4e082b5161c7b4"
                    },
                    {
                      "type":"patch",
                      "path":"pjproject_patches/add_dtls_transport.patch"
                    },
                    {
                      "type":"patch",
                      "path":"pjproject_patches/endianness.patch"
                    },
                    {
                      "type":"patch",
                      "path":"pjproject_patches/fix_ioqueue_ipv6_sendto.patch"
                    },
                    {
                      "type":"patch",
                      "path":"pjproject_patches/fix_turn_fallback.patch"
                    },
                    {
                      "type":"patch",
                      "path":"pjproject_patches/gnutls.patch"
                    },
                    {
                      "type":"patch",
                      "path":"pjproject_patches/fix_base64.patch"
                    },
                    {
                      "type":"patch",
                      "path":"pjproject_patches/ice_config.patch"
                    },
                    {
                      "type":"patch",
                      "path":"pjproject_patches/notestsapps.patch"
                    },
                    {
                      "type":"patch",
                      "path":"pjproject_patches/ipv6.patch"
                    },
                    {
                      "type":"patch",
                      "path":"pjproject_patches/multiple_listeners.patch"
                    },
                    {
                      "type":"patch",
                      "path":"pjproject_patches/pj_ice_sess.patch"
                    }
                  ]
                },
                {
                  "name":"yaml-cpp",
                  "buildsystem":"cmake",
                  "build-options":{
                    "cflags":  "-fPIC",
                    "cxxflags":"-fPIC",
                    "ldflags": "-fPIC"
                  },
                  "sources":[
                    {
                      "type":"git",
                      "url":"https://github.com/jbeder/yaml-cpp.git",
                      "commit":"beb44b872c07c74556314e730c6f20a00b32e8e5"
                    }
                  ]
                },
                {
                  "name":"json-cpp",
                  "buildsystem":"cmake",
                  "config-opts":["-DBUILD_STATIC_LIBS=ON -DBUILD_SHARED_LIBS=ON","-DCMAKE_INSTALL_LIBDIR=lib","-DCMAKE_CXX_FLAGS=-fPIC", "-DCMAKE_C_FLAGS=-fPIC"],
                  "sources":[
                    {
                      "type":"git",
                      "url":"https://github.com/open-source-parsers/jsoncpp",
                      "branch":"1.8.3"
                    }
                  ]
                },
                {
                  "name":"dbus-c++",
                  "config-opts":["--disable-examples","--disable-ecore","--enable-glib", "--disable-static"],
                  "build-options":{
                    "env":{
                    "LIBS":"-lpthread"
                    },
                    "cflags":  "-fPIC",
                    "cxxflags":"-fPIC",
                    "ldflags": "-fPIC"
                  },
                  "sources":[
                    {
                      "type":"archive",
                      "url":"https://iweb.dl.sourceforge.net/project/dbus-cplusplus/dbus-c++/0.9.0/libdbus-c++-0.9.0.tar.gz",
                      "sha256":"bc11ac297b3cb010be904c72789695543ee3fdf3d75cdc8225fd371385af4e61"
                    },
                    {
                      "type":"patch",
                      "path":"dbus-cplusplus_patches/gcc47.patch"
                    },
                    {
                      "type":"patch",
                      "path":"dbus-cplusplus_patches/disable-threading.patch"
                    },
                    {
                      "type":"patch",
                      "path":"dbus-cplusplus_patches/fix-writechar.patch"
                    }
                  ]
                },
                {
                  "name":"restbed",
                  "buildsystem":"cmake",
                  "build-options":{
                    "cflags":  "-fPIC",
                    "cxxflags":"-fPIC",
                    "ldflags": "-fPIC"
                  },
                  "config-opts":["-DCMAKE_INSTALL_LIBDIR=lib","-DBUILD_SHARED=on"],
                  "sources":[
                    {
                      "type":"archive",
                      "url":"https://github.com/Corvusoft/restbed/archive/4.6/restbed-4.6.tar.gz",
                      "sha256":"b2b75c39129bf667a3e1a9494b9cf0e3dcf6d2b081746918f0f6ba202f14a7e4"
                    },
                    {
                      "type":"patch",
                      "path":"restbed_patches/strand.patch"
                    }
                  ],
                  "modules": [
                    {
                      "name":"asio",
                      "sources":[
                        {
                          "type":"archive",
                          "url": "http://downloads.sourceforge.net/asio/asio-1.10.8.tar.bz2",
                          "sha256": "26deedaebbed062141786db8cfce54e77f06588374d08cccf11c02de1da1ed49"
                        }
                      ],
                      "modules":[
                        {
                          "name":"boost",
                          "buildsystem":"simple",
                          "build-commands":["./bootstrap.sh --with-toolset=gcc --with-icu --with-python=/usr/bin/python2 --prefix=/app","./b2 install --prefix=/app"],
                          "sources":[
                          {
                            "type":"archive",
                            "url":"https://dl.bintray.com/boostorg/release/1.65.1/source/boost_1_65_1.tar.gz",
                            "sha256":"a13de2c8fbad635e6ba9c8f8714a0e6b4264b60a29b964b940a22554705b6b60"
                          }
                          ]
                        }
                      ]
                    },
                    {
                      "name":"kashmir",
                      "buildsystem":"simple",
                      "build-commands":["mkdir /app/include/kashmir","cp -a kashmir/* /app/include/kashmir"],
                      "sources":[
                        {
                          "type":"git",
                          "url":"https://github.com/Corvusoft/kashmir-dependency.git"
                        }
                      ]
                    }
                  ]
                },
                {
                  "name":"ffmpeg",
                  "config-opts":[  "--prefix=/app",
                          "--disable-debug",
                          "--enable-fontconfig",
                          "--enable-gnutls",
                          "--enable-gpl",
                          "--enable-libspeex",
                          "--disable-doc",
                          "--disable-programs"
                  ],
                  "build-options":{
                    "cflags":  "-fPIC",
                    "cxxflags":"-fPIC",
                    "ldflags": "-fPIC"
                  },
                  "sources": [
                    {
                      "type":"archive",
                      "url":"https://ffmpeg.org/releases/ffmpeg-3.3.4.tar.xz",
                      "sha256":"98b97e1b908dfeb6aeb6d407e5a5eacdfc253a40c2d195f5867ed2d1d46ea957"
                    }
                  ],
                  "modules": [
                    {
                      "name":"ladspa",
                      "buildsystem":"simple",
                      "build-commands":["./autogen.sh"],
                      "sources":[
                        {
                          "type":"archive",
                          "url":"http://www.ladspa.org/download/ladspa_sdk_1.13.tgz",
                          "sha256": "b5ed3f4f253a0f6c1b7a1f4b8cf62376ca9f51d999650dd822650c43852d306b"
                        },
                        {
                          "type":"patch",
                          "path":"ladspa_patches/fix-memleak-in-plugin-scanning.patch",
                          "strip-components": 0
                        },
                        {
                          "type":"patch",
                          "path":"ladspa_patches/fallback-ladspa-path.patch"
                        },
                        {
                          "type":"script",
                          "commands":[
                                  "cd src",
                                  "sed -e 's/mkdirhier/mkdir -p/' -e \"s#-O3#${CFLAGS} ${LDFLAGS/,--as-needed/}#\" -i makefile",
                                  "make targets",
                                  "make INSTALL_PLUGINS_DIR=/app/lib/ladspa INSTALL_INCLUDE_DIR=/app/include INSTALL_BINARY_DIR=/app/bin install"
                          ]
                        }
                      ]
                    }
                  ]
                },
                "shared-modules/udev/udev-175.json",
                {
                  "name":"gsm",
                  "no-autogen":true,
                  "make-args":[
                    "CCFLAGS=-c -fPIC"
                  ],
                  "make-install-args":[
                    "INSTALL_ROOT=/app",
					"GSM_INSTALL_INC=/app/include/gsm",
                    "GSM_INSTALL_MAN=/app/share/man/man3",
                    "TOAST_INSTALL_MAN=/app/share/man/man1"
                  ],
                  "build-commands":[
                    "mkdir -p /app/include/gsm",
                    "mkdir -p /app/share/man/man1",
                    "mkdir -p /app/share/man/man3/"
                  ],
                  "sources":[
                    {
                      "type":"archive",
                      "url":"http://www.quut.com/gsm/gsm-1.0.17.tar.gz",
                      "sha256":"855a57d1694941ddf3c73cb79b8d0b3891e9c9e7870b4981613b734e1ad07601"
                    },
                    {
                      "type":"patch",
                      "path":"gsm_patches/gsm-shared.patch",
                      "strip-components": 0
                    }
                  ]
                },
                {
                  "name":"opendht",
                  "buildsystem":"cmake",
                  "config-opts":[
                    "-DCMAKE_BUILD_TYPE=Release",
                    "-DCMAKE_INSTALL_PREFIX=/app",
                    "-DCMAKE_INSTALL_LIBDIR=lib"
                  ],
                  "sources":[
                    {
                      "type":"archive",
                      "url":"https://github.com/savoirfairelinux/opendht/archive/1.3.6/opendht-1.3.6.tar.gz",
                      "sha256":"7e888748741a0a2cc44639c580f29fa4c58cddbf08622626b754f0c9b99a4392"
                    }
                  ],
                  "modules": [
                    {
                      "name":"argon2",
                      "no-autogen":true,
                      "post-install":[
                        "cp libargon2.pc /app/lib/pkgconfig/libargon2.pc"
                      ],
                      "make-install-args":[
                        "PREFIX=/app"
                      ],                
                      "sources":[
                        {
                          "type":"git",
                          "url":"https://github.com/P-H-C/phc-winner-argon2.git",
                          "branch":"20161029"
                        },
                        {
                          "type":"file",
                          "path":"argon2_pc/libargon2.pc"
                        }
                      ]
                    },
                    {
                      "name":"msgpack",
                      "buildsystem":"cmake",
                      "config-opts":[
                        "-DCMAKE_INSTALL_PREFIX=/app",
                        "-DMSGPACK_CXX11=ON",
                        "-DMSGPACK_BUILD_EXAMPLES=OFF",
                        "-DCMAKE_BUILD_TYPE=Release"
                      ],
                      "sources":[
                        {
                          "type":"archive",
                          "url":"https://github.com/msgpack/msgpack-c/releases/download/cpp-2.1.5/msgpack-2.1.5.tar.gz",
                          "sha256":"6126375af9b204611b9d9f154929f4f747e4599e6ae8443b337915dcf2899d2b"
                        }
                      ]            
                    }
                  ]
                },
                {
                  "name":"libcrypto++",
                  "buildsystem":"simple",
                  "build-commands":[
                    "sed -i 's/^CXXFLAGS/#CXXFLAGS/' GNUmakefile",
                    "CXXFLAGS+=\" -DNDEBUG -fPIC\" make -f GNUmakefile",
                    "make dynamic static",
                    "make PREFIX=/app install",
                    "cp libcrypto++.pc /app/lib/pkgconfig/libcrypto++.pc"
                  ],
                  "sources":[
                    {
                      "type":"archive",
                      "url": "https://github.com/weidai11/cryptopp/archive/CRYPTOPP_5_6_5.tar.gz",
                      "sha256":"79fd5514b3b191a1c6d934cd989d5e058f4726a72a3dad2444bd1274a6aae686"
                    },
                    {
                      "type":"file",
                      "path":"cryptocpp_pc/libcrypto++.pc"
                    }
                  ]
                },
                {
                  "name":"libnatpmp",
                  "buildsystem":"simple",
                  "build-commands":[
                    "sed -e 's/CFLAGS = /CFLAGS += /' -i Makefile",
                    "make INSTALLPREFIX=/app INSTALLDIRINC=/app/include install"
                  ],
                  "sources":[
                    {
                      "type":"archive",
                      "url":"http://miniupnp.tuxfamily.org/files/libnatpmp-20150609.tar.gz",
                      "sha256":"e1aa9c4c4219bc06943d6b2130f664daee213fb262fcb94dd355815b8f4536b0"
                    }
                  ]
                },
                {
                  "name":"libupnp",
                  "build-options":{
                    "cflags":  "-fPIC",
                    "cxxflags":"-fPIC",
                    "ldflags": "-fPIC"
                  },
                  "sources":[
                    {
                      "type":"archive",
                      "url":"http://downloads.sourceforge.net/sourceforge/pupnp/libupnp-1.6.22.tar.bz2",
                      "sha256":"0bdfacb7fa8d99b78343b550800ff193264f92c66ef67852f87f042fd1a1ebbc"
                    }
                  ]
                }
              ]
            },
            {
              "name": "qt5-qtbase",
              "config-opts": [
                "-prefix /app",
                "-confirm-license",
                "-opensource",
                "-shared",
                      "-platform", "linux-g++",
                      "-optimized-qmake",
                      "-nomake examples",
                      "-nomake tests",
                      "-system-harfbuzz",
                      "-system-sqlite",
                      "-accessibility",
                      "-dbus-linked",
                      "-fontconfig",
                      "-glib",
                      "-icu",
                      "-openssl-linked",
                      "-no-pch",
                      "-no-rpath",
                      "-no-separate-debug-info",
                      "-reduce-relocations",
                      "-no-directfb",
                      "-no-linuxfb",
                      "-no-kms",
                      "-no-cups",
                      "-system-proxies",
                      "-gtk"
              ],
              "sources": [
                { 
                  "type": "archive",
                  "url": "https://download.qt.io/official_releases/qt/5.9/5.9.2/submodules/qtbase-opensource-src-5.9.2.tar.xz",
                  "sha256": "7fe2bb468955f633c71b3ddd3c269e68a2c4137a4e5b8dd12dcdb34cbc6d609b"
                },
                {
                    "type": "shell",
                    "commands": [ "mv configure configure.qt" ]
                },
                {
                    "type": "script",
                    "commands": [
                        "processed=`sed -e 's/--/-/g ; s/=/ /g' <<< $@`",
                        "./configure.qt $processed"
                    ],
                    "dest-filename": "configure"
                }
              ]
            }
          ]
        },
        {
          "name":"evolution-data-server",
          "buildsystem":"cmake",
          "config-opts":[
            "-DCMAKE_INSTALL_PREFIX=/app",
            "-DENABLE_UOA=OFF",
            "-DENABLE_VALA_BINDINGS=ON",
            "-DENABLE_INSTALLED_TESTS=OFF",
            "-DENABLE_GOOGLE=OFF",
            "-DENABLE_GOOGLE_AUTH=OFF",
            "-DWITH_OPENLDAP=OFF",
            "-DWITH_KRB5=OFF",
            "-DENABLE_INTROSPECTION=ON",
            "-DENABLE_GOA=OFF",
            "-DENABLE_WEATHER=OFF",
            "-DENABLE_EXAMPLES=OFF"
          ],
          "sources":[
            {
              "type":"git",
              "url":"https://git.gnome.org/browse/evolution-data-server",
              "commit":"cfd2bdb29f5bbb8b6cad90072011b23753122616"
            }
          ],
          "modules":[
            {
              "name":"libical",
              "buildsystem":"cmake",
              "config-opts":[
                "-DCMAKE_BUILD_TYPE=Release",
                "-DSHARED_ONLY=true",
                "-DCMAKE_INSTALL_PREFIX=/app",
                "-DCMAKE_INSTALL_LIBDIR=/app/lib"
              ],
              "sources":[
                {
                  "type":"archive",
                  "url":"https://github.com/libical/libical/archive/v2.0.0.tar.gz",
                  "sha256":"20f4a98475052e1200d2691ba50b27969e4bedc6e50bffd5e2fa81f4ac90de9a"
                }
              ]
            }
          ]
        },
        {
          "name":"qrencode",
          "config-opts":[
            "--prefix=/app"
          ],
          "sources":[
            {
              "type":"archive",
              "url":"https://fukuchi.org/works/qrencode/qrencode-4.0.0.tar.gz",
              "sha256":"5b621b22931264c7e96c1f9597c3d507d79e059b8207b159fff7547f0b26aa81"
            }
          ]
        }
      ]
    }
  ]
}
