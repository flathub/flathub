app-id: edu.wpi.first.Shuffleboard
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: shuffleboard
finish-args:
  - --share=network
  # RESTORED: Explicit x11 is required for JavaFX stability
  - --socket=x11
  - --socket=wayland
  - --share=ipc
  - --device=dri
  # LINTER FIX: Instead of full 'home' access, we only ask for the specific folder
  # Shuffleboard uses (plus Documents for saving layouts).
  - --filesystem=~/Shuffleboard
  - --filesystem=xdg-documents

sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17

modules:
  - name: shuffleboard
    buildsystem: simple
    build-commands:
      # 1. Install the Jar
      - install -D Shuffleboard.jar /app/share/java/Shuffleboard.jar
      
      # 2. Install the Icon
      - install -D wpilib-icon-128.png /app/share/icons/hicolor/128x128/apps/edu.wpi.first.Shuffleboard.png

      # 3. Install Metadata
      - install -D edu.wpi.first.Shuffleboard.desktop /app/share/applications/edu.wpi.first.Shuffleboard.desktop
      - install -D edu.wpi.first.Shuffleboard.metainfo.xml /app/share/metainfo/edu.wpi.first.Shuffleboard.metainfo.xml

      # 4. BUNDLE JAVA
      - cp -rL /usr/lib/sdk/openjdk17/jvm/openjdk-17 /app/jre
      - chmod -R +x /app/jre/bin
      
      # 5. Launch Script
      - mkdir -p /app/bin
      - |
        cat > /app/bin/shuffleboard <<EOF
        #!/bin/bash
        export JAVA_HOME=/app/jre
        # We force GTK3. This combined with --socket=x11 ensures XWayland is used.
        exec /app/jre/bin/java -Djdk.gtk.version=3 -jar /app/share/java/Shuffleboard.jar "$@"
        EOF
      - chmod +x /app/bin/shuffleboard

    sources:
      # Main Jar
      - type: file
        url: https://frcmaven.wpi.edu/artifactory/release/edu/wpi/first/tools/Shuffleboard/2026.1.1-beta-1/Shuffleboard-2026.1.1-beta-1-linuxx64.jar
        sha256: 1792285b573fa59a4e2a9d85d8b5b8790d64d3034b6852535271f0e19e38a0c6
        dest-filename: Shuffleboard.jar

      # Icon
      - type: file
        url: https://github.com/wpilibsuite/branding/raw/main/export/png/wpilib-icon-128.png
        sha256: 40e08b0d1f78b5bcb468ff35aa6349cdba695b3207d66da40f90e61eacff1146
        dest-filename: wpilib-icon-128.png

      # Metadata
      - type: file
        path: edu.wpi.first.Shuffleboard.desktop
      - type: file
        path: edu.wpi.first.Shuffleboard.metainfo.xml
