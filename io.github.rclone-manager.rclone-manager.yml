id: io.github.rclone-manager.rclone-manager

runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node20
  - org.freedesktop.Sdk.Extension.rust-stable

command: rclone-manager
build-options:
  append-path: /usr/lib/sdk/node20/bin:/usr/lib/sdk/rust-stable/bin
  env:
    CARGO_HOME: /run/build/rclone-manager/cargo
    NPM_CONFIG_LOGLEVEL: info
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --share=ipc
  - --share=network
  - --talk-name=org.freedesktop.Notifications # When UI not openned, it uses notifications to show status. --talk-name=org.freedesktop.portal.Desktop not working very well.
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.freedesktop.secrets # For storing encrypted config passwords
  - --system-talk-name=org.freedesktop.NetworkManager # For detecting is metered or not/
  - --filesystem=xdg-run/tray-icon:create
  - --filesystem=xdg-config/rclone:rw # Access to the shared rclone configuration
  - --filesystem=xdg-download # Allow exporting backups to the user's Downloads folder
  - --filesystem=xdg-documents # Permit access to user-selected document directories
  - --persist=.config/rclone # Keep an internal copy of the configuration available for sandboxed runs
modules:
  - name: fusermount-wrapper # Need for mount and other rclone operations
    buildsystem: simple
    sources:
      - type: file
        path: fusermount-wrapper.sh
    build-commands:
      - install -Dm755 fusermount-wrapper.sh /app/bin/fusermount3

  - name: terminal-wrapper # Need for opening terminals from within flatpak
    buildsystem: simple
    sources:
      - type: file
        path: terminal-wrapper.sh
    build-commands:
      - install -Dm755 terminal-wrapper.sh /app/bin/kgx
      - install -Dm755 terminal-wrapper.sh /app/bin/gnome-terminal
      - install -Dm755 terminal-wrapper.sh /app/bin/xterm
      - install -Dm755 terminal-wrapper.sh /app/bin/konsole
      - install -Dm755 terminal-wrapper.sh /app/bin/alacritty

  - name: 7zip # For Encrypt and Decrypt exported settings
    buildsystem: simple
    cleanup:
      - /app/bin/7z
    sources:
      - type: file
        url: https://github.com/ip7z/7zip/releases/download/25.01/7z2501-linux-x64.tar.xz
        sha256: "4ca3b7c6f2f67866b92622818b58233dc70367be2f36b498eb0bdeaaa44b53f4"
        dest: 7z
        dest-filename: 7z.tar.xz
        only-arches:
          - x86_64
      - type: file
        url: https://github.com/ip7z/7zip/releases/download/25.01/7z2501-linux-arm64.tar.xz
        sha256: "39c5140f02ce4436599303c59a149f654cb1bbc47cdc105a942120d747ae040d"
        dest: 7z
        dest-filename: 7z.tar.xz
        only-arches:
          - aarch64
    build-commands:
          - tar -xf 7z/7z.tar.xz -C 7z
          - mv 7z/7zz 7z/7z # Rename 7zz to 7z for compatibility
          - install -Dm755 7z/7z -t ${FLATPAK_DEST}/bin/

  - shared-modules/libayatana-appindicator/libayatana-appindicator-gtk3.json
  - name: rclone-manager
    buildsystem: simple
    cleanup:
      - /app/lib/io.github.rclone-manager.rclone-manager/*
      - /app/bin/rclone-manager
      - /app/share/icons/hicolor/128x128/apps/io.github.rclone-manager.rclone-manager.png
      - /app/share/icons/hicolor/32x32/apps/io.github.rclone-manager.rclone-manager.png
      - /app/share/icons/hicolor/256x256@2/apps/io.github.rclone-manager.rclone-manager.png
      - /app/share/metainfo/io.github.rclone-manager.rclone-manager.metainfo.xml
      - /app/share/applications/io.github.rclone-manager.rclone-manager.desktop
    build-options:
      append-path: /usr/lib/sdk/node20/bin:/usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/rclone-manager/cargo
        NPM_CONFIG_LOGLEVEL: info
        npm_config_cache: /run/build/rclone-manager/flatpak-node/npm-cache
        npm_config_nodedir: /usr/lib/sdk/node20
        npm_config_offline: 'true'
    sources:
      - type: git
        url: https://github.com/RClone-Manager/rclone-manager.git
        commit: 979e7eeb37df3b60252e71ac62b296fe584b95a9
        tag: v0.1.4
      
      - npm-sources.json
      - cargo-sources.json
    
    build-commands:
      # Install npm dependencies offline
      - npm ci --offline

      - cargo --offline fetch --manifest-path src-tauri/Cargo.toml --verbose
      
      # Disable font inlining to avoid network requests during build
      - jq '.projects."rclone-manager".architect.build.options.optimization = {"fonts":false} | .projects."rclone-manager".architect.build.configurations.production.optimization = {"fonts":false, "scripts":true, "styles":true}' angular.json > angular.json.tmp && mv angular.json.tmp angular.json
      
      # Disable updater artifacts in Tauri config for Flatpak builds
      - npm run --offline tauri build -- --bundles deb --config '{"bundle":{"createUpdaterArtifacts":false}}' --features flatpak
      
      # Extract and install from the generated .deb
      - mkdir extracted
      - ar -x src-tauri/target/release/bundle/deb/*.deb --output extracted
      - tar -C extracted -xf extracted/data.tar.gz
      - install -Dm755 extracted/usr/bin/rclone-manager /app/bin/rclone-manager
      
      # Copy any bundled libraries if they exist
      - test -d "extracted/usr/lib" && mkdir -p /app/lib/io.github.rclone-manager.rclone-manager && cp -r extracted/usr/lib/*. /app/lib/io.github.rclone-manager.rclone-manager/ && find /app/lib/io.github.rclone-manager.rclone-manager -type f -exec chmod 644 {} \; || true
      
      # Install icons
      - install -Dm644 extracted/usr/share/icons/hicolor/128x128/apps/'rclone-manager.png' /app/share/icons/hicolor/128x128/apps/io.github.rclone-manager.rclone-manager.png
      - install -Dm644 extracted/usr/share/icons/hicolor/32x32/apps/'rclone-manager.png' /app/share/icons/hicolor/32x32/apps/io.github.rclone-manager.rclone-manager.png
      - install -Dm644 extracted/usr/share/icons/hicolor/256x256@2/apps/'rclone-manager.png' /app/share/icons/hicolor/256x256@2/apps/io.github.rclone-manager.rclone-manager.png
      
      # Install metadata
      - install -Dm644 extracted/usr/share/flatpak.metainfo.xml /app/share/metainfo/io.github.rclone-manager.rclone-manager.metainfo.xml
      
      # Install and modify desktop file
      - install -Dm644 extracted/usr/share/applications/'RClone Manager.desktop' /app/share/applications/io.github.rclone-manager.rclone-manager.desktop
      - desktop-file-edit --set-icon=io.github.rclone-manager.rclone-manager /app/share/applications/io.github.rclone-manager.rclone-manager.desktop
      - desktop-file-edit --set-key=Comment --set-value='Cross-platform User Friendly UI for rclone' /app/share/applications/io.github.rclone-manager.rclone-manager.desktop