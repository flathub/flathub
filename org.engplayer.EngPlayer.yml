app-id: org.engplayer.EngPlayer
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
command: engplayer
finish-args:
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --device=dri
  - --filesystem=home
  - --filesystem=xdg-run/dconf
  - --filesystem=~/.config/dconf:ro
  - --filesystem=/mnt
  - --filesystem=/run/media
  - --filesystem=xdg-run/gvfs
  - --filesystem=xdg-run/gvfsd
  - --talk-name=org.gtk.vfs.*
  - --talk-name=ca.desrt.dconf
  - --env=DCONF_USER_CONFIG_DIR=.config/dconf
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.Flatpak

modules:
  - python3-requirements.json

  - name: engplayer
    buildsystem: simple
    build-commands:
      - |
        for dir in resources/locale/*/; do
          lang=$(basename "$dir")
          if [ -f "resources/locale/$lang/LC_MESSAGES/engplayer.po" ]; then
            echo "Compiling language: $lang"
            msgfmt "resources/locale/$lang/LC_MESSAGES/engplayer.po" -o "resources/locale/$lang/LC_MESSAGES/engplayer.mo"
          fi
        done
      - mkdir -p /app/share/engplayer
      - cp -r . /app/share/engplayer
      - rm -rf /app/share/engplayer/__pycache__
      - rm -rf /app/share/engplayer/venv
      - rm -rf /app/share/engplayer/.git
      - mkdir -p /app/bin
      - echo '#!/bin/sh' > /app/bin/engplayer
      - echo 'export PYTHONPATH=/app/share/engplayer:' >> /app/bin/engplayer
      - echo 'exec python3 /app/share/engplayer/main.py ""' >> /app/bin/engplayer
      - chmod +x /app/bin/engplayer
      - echo '#!/bin/sh' > /app/bin/engplayer-daemon
      - echo 'export PYTHONPATH=/app/share/engplayer:' >> /app/bin/engplayer-daemon
      - echo 'exec python3 /app/share/engplayer/recorder_daemon.py' >> /app/bin/engplayer-daemon
      - chmod +x /app/bin/engplayer-daemon
      - mkdir -p /app/share/icons/hicolor/512x512/apps
      - mkdir -p /app/share/applications
      - mkdir -p /app/share/metainfo
      - install -D -m644 org.engplayer.EngPlayer.metainfo.xml /app/share/metainfo/org.engplayer.EngPlayer.metainfo.xml
      - install -D -m644 resources/icons/EngPlayer.png /app/share/icons/hicolor/512x512/apps/org.engplayer.EngPlayer.png
      - install -D -m644 engplayer.desktop.in /app/share/applications/org.engplayer.EngPlayer.desktop
      - sed -i 's|@EXEC_PATH@|/app/bin/engplayer|g' /app/share/applications/org.engplayer.EngPlayer.desktop
      - sed -i 's|Icon=engplayer|Icon=org.engplayer.EngPlayer|g' /app/share/applications/org.engplayer.EngPlayer.desktop
    sources:
      - type: git
        url: https://github.com/Falldaemon/EngPlayer.git
        tag: v0.1.0
        commit: bfc4e2d74b08ec2576e1b4f680ba1df10e565805
