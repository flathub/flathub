id: com.rcloneui.RcloneUI

runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node22
  - org.freedesktop.Sdk.Extension.rust-stable

command: rclone-ui
finish-args:
  - --socket=wayland 
  - --socket=fallback-x11 
  - --device=dri 
  - --share=ipc
  - --share=network 
  - --talk-name=org.freedesktop.Notifications 
  - --talk-name=org.kde.StatusNotifierWatcher
  - --filesystem=xdg-run/tray-icon:create

modules:
  - name: node22
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/node22/install-sdk.sh
  - shared-modules/libayatana-appindicator/libayatana-appindicator-gtk3.json
  - name: rclone-ui
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/rclone-ui/rclone-ui.git
        tag: v2.7.0
        commit: 91dbed13805d1d2e2ddc8ce3572590e5516f6c3f
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - node-sources.json
      - cargo-sources.json

    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin/:/usr/lib/sdk/node22/bin
      env:
        CARGO_HOME: /run/build/rclone-ui/cargo
        XDG_CACHE_HOME: /run/build/rclone-ui/flatpak-node/cache
        npm_config_cache: /run/build/rclone-ui/flatpak-node/npm-cache
        npm_config_nodedir: /usr/lib/sdk/node22
        TAURI_CLI_NO_DEV_SERVER_WAIT: "true"
        TAURI_LINUX_AYATANA_APPINDICATOR: "true"
        
    build-commands:
      - npm ci --offline
      - cargo --offline fetch --manifest-path src-tauri/Cargo.toml --verbose
      - npm run --offline tauri build -- --bundles deb --config '{"bundle":{"createUpdaterArtifacts":false}}'

      - VERSION="2.7.0" && ARCH=$([ $FLATPAK_ARCH == "x86_64" ] && echo "amd64" || echo "arm64") && cp "src-tauri/target/release/bundle/deb/Rclone UI_${VERSION}_${ARCH}.deb" rcloneui.deb

      - mkdir extracted
      - ar -x rcloneui.deb --output extracted
      - tar -C extracted -xf extracted/data.tar.gz

      - install -Dm755 extracted/usr/bin/'Rclone UI' /app/bin/rclone-ui

      - mkdir -p /app/lib/com.rcloneui.RcloneUI
      - cp -r extracted/usr/lib/'Rclone UI'/. /app/lib/com.rcloneui.RcloneUI
      - find /app/lib/com.rcloneui.RcloneUI -type f -exec chmod 644 {} \;

      - install -Dm644 extracted/usr/lib/'Rclone UI'/icons/favicon/icon.png /app/lib/'Rclone UI'/icons/favicon/icon.png

      - install -Dm644 extracted/usr/share/icons/hicolor/128x128/apps/'Rclone UI.png' /app/share/icons/hicolor/128x128/apps/com.rcloneui.RcloneUI.png
      - install -Dm644 extracted/usr/share/icons/hicolor/32x32/apps/'Rclone UI.png' /app/share/icons/hicolor/32x32/apps/com.rcloneui.RcloneUI.png
      - install -Dm644 extracted/usr/share/icons/hicolor/256x256@2/apps/'Rclone UI.png' /app/share/icons/hicolor/256x256@2/apps/com.rcloneui.RcloneUI.png
      - install -Dm644 extracted/usr/share/flatpak.metainfo.xml /app/share/metainfo/com.rcloneui.RcloneUI.metainfo.xml

      - install -Dm644 extracted/usr/share/applications/'Rclone UI.desktop' /app/share/applications/com.rcloneui.RcloneUI.desktop
      - desktop-file-edit --set-key=Exec --set-value=rclone-ui /app/share/applications/com.rcloneui.RcloneUI.desktop
      - desktop-file-edit --set-key=Icon --set-value=com.rcloneui.RcloneUI /app/share/applications/com.rcloneui.RcloneUI.desktop
      - desktop-file-edit --set-key=Comment --set-value='Cross-platform desktop GUI for rclone & S3.' /app/share/applications/com.rcloneui.RcloneUI.desktop