app-id: com.oracle.VirtualBox
runtime: org.kde.Platform
runtime-version: "6.9"
sdk: org.kde.Sdk
command: VirtualBox
rename-icon: virtualbox
rename-desktop-file: virtualbox.desktop
finish-args:
  # Default path that VirtualBox places files at
  - "--persist=~/VirtualBox VMs"
  - --device=all
  - --share=ipc
  - --share=network
  # Wayland backend (currently!) makes it so you have an infinite screen on VBoxSVGA
  # TODO: move to wayland socket once issues are solved upstream
  - --socket=x11
  - --socket=pulseaudio
cleanup:
  - "*.a"
  - "*.la"
  - /include
  - /lib/pkgconfig
  - /share/applications/mimeinfo.cache
  - /share/bash-completion
  - /share/icons/hicolor/icon-theme.cache
  - /share/man
  - /share/pkgconfig
modules:
  - name: virtualbox
    buildsystem: simple
    build-options:
      env:
        LIBRARY_PATH: /app/lib/X11:/app/lib
    build-commands:
      - echo "VBOX_GCC_OPT=$CXXFLAGS" >> LocalConfig.kmk
      - patch -p1 -N -i ./virtualbox-kvm/patches/0001-NEM-Implement-KVM-backend.patch
      # Disabling hardening is not recommended but EUID manipulation is not possible inside the flatpak sandbox yet
      # Same-ish situation with the firefox flatpak
      - |
        ./configure \
          --disable-docs \
          --disable-extpack \
          --disable-hardening \
          --disable-java \
          --disable-kmods \
          --disable-vmmraw \
          --enable-vde \
          --ose \
          --with-kvm \
          --with-makeself=/usr/bin/echo
      - source ./env.sh ; kmk
      - install -Dm0644 -t "/app/share/licenses/${FLATPAK_ID}/" COPYING
      - install -Dm0644 -t "/app/share/licenses/${FLATPAK_ID}/" COPYING.CDDL
      - install -Dm0644 -t "${FLATPAK_DEST}/share/metainfo/" com.oracle.VirtualBox.metainfo.xml
      - |
        cd out/linux.*/release/bin
        sed -i "s@\/usr@/app@g ; /PATH\=/d" VBox.sh
        for i in vbox-img vboximg-mount; do ln -s ../lib/virtualbox/"${i}" "${FLATPAK_DEST}/bin/${i}" ; done
        pushd icons
          for i in *; do
            install -d "${FLATPAK_DEST}/share/icons/hicolor/${i}/mimetypes" "${FLATPAK_DEST}/share/icons/hicolor/${i}/apps"
            cp "${i}/"* "${FLATPAK_DEST}/share/icons/hicolor/${i}/mimetypes"
            cp "${i}/"* "${FLATPAK_DEST}/share/icons/hicolor/${i}/apps"
          done
        popd
        install -Dm0644 -t "${FLATPAK_DEST}/share/applications/" virtualbox.desktop
        install -Dm0644 -t "${FLATPAK_DEST}/share/mime/packages/" virtualbox.xml
        install -Dm0644 -t "${FLATPAK_DEST}/share/pixmaps/" VBox.png 
        install -Dm0755 -t "${FLATPAK_DEST}/bin/" VBox.sh
        install -Dm0644 -t "${FLATPAK_DEST}/lib/virtualbox/" *.r0 VBoxEFI*.fd
        install -Dm0755 -t "${FLATPAK_DEST}/lib/virtualbox" VirtualBoxVM VBoxSDL VBoxHeadless VBoxNetAdpCtl VBoxNetDHCP VBoxNetNAT VirtualBox VBoxManage VBoxSVC VBoxExtPackHelperApp VBoxBalloonCtrl vbox-img vboximg-mount vboxwebsrv webtest *.so
        install -Dm0755 -t "${FLATPAK_DEST}/lib/virtualbox/components/" components/*
        install -Dm0755 -t "${FLATPAK_DEST}/lib/virtualbox/nls/" nls/*.qm
        install -Dm0755 -t "${FLATPAK_DEST}/lib/virtualbox/" VBoxCreateUSBNode.sh VBoxSysInfo.sh
        mv 'UnattendedTemplates' "${FLATPAK_DEST}/lib/virtualbox/"
        ln -s VBox.sh ${FLATPAK_DEST}/bin/VBox
        for i in \
          VBoxAutostart \
          VBoxBalloonCtrl \
          VBoxBugReport \
          VBoxHeadless \
          VBoxManage \
          VBoxSDL \
          VirtualBox \
          VirtualBoxVM \
          vboxwebsrv; do \
            ln -sf VBox "${FLATPAK_DEST}/bin/${i}" ; \
            ln -sf VBox "${FLATPAK_DEST}/bin/${i,,}" ; \
        done
    sources:
      - type: archive
        url: https://download.virtualbox.org/virtualbox/7.2.4/VirtualBox-7.2.4.tar.bz2
        sha256: d281ec981b5f580211a0cedd1b75a1adcb0fbfcbb768d8c2bf4429f4763e8bbd
        x-checker-data:
          type: anitya
          project-id: 14449
          stable-only: true
          url-template: https://download.virtualbox.org/virtualbox/$version/VirtualBox-$version.tar.bz2
      - type: git
        url: https://github.com/cyberus-technology/virtualbox-kvm.git
        tag: dev-20251103
        dest: virtualbox-kvm
        x-checker-data:
          type: git
          tag-pattern: ^dev-([\d]*)$
      - type: file
        path: LocalConfig.kmk
      - type: file
        path: com.oracle.VirtualBox.metainfo.xml
    modules:
      - shared-modules/SDL/SDL-1.2.15.json
      - shared-modules/glu/glu-9.json
      - name: pam
        buildsystem: meson
        cleanup:
          - "/bin"
          - "/sbin"
          - "/share/doc"
          - "/lib/systemd"
          - "/etc"
        sources:
          - type: archive
            url: https://github.com/linux-pam/linux-pam/archive/refs/tags/v1.7.1.tar.gz
            sha256: 82aadd97eb697965b577069c12046a4dd1be68361a9978c708698d2a1ee9b6d1
            x-checker-data:
              type: anitya
              stable-only: true
              project-id: 12244
              url-template: https://github.com/linux-pam/linux-pam/archive/refs/tags/v$version.tar.gz
      - name: gsoap
        cleanup:
          - "/bin"
        build-options:
          make-args:
            # Necessary because dependency resolution is not declared properly upstream
            - -j1
          env:
            SOAPCPP2_IMPORTPATH: -DSOAPCPP2_IMPORT_PATH="${FLATPAK_DEST}/share/gsoap/import:${FLATPAK_DEST}/share/gsoap"
        config-opts:
          - --disable-static
          - --enable-ipv6
          - --enable-samples
        sources:
          - type: archive
            url: https://downloads.sourceforge.net/gsoap2/gsoap_2.8.139.zip
            sha256: 74d1d7854c8ff500729a3003fd07536e417f3e900aee2eeb2d9300d70e4c047b
            x-checker-data:
              type: anitya
              stable-only: true
              project-id: 1260
              url-template: https://downloads.sourceforge.net/gsoap2/gsoap_$version.zip
      - name: yasm
        cleanup:
          - "*"
        sources:
          - type: archive
            url: https://www.tortall.net/projects/yasm/releases/yasm-1.3.0.tar.gz
            sha256: 3dce6601b495f5b3d45b59f7d2492a340ee7e84b5beca17e48f862502bd5603f
            x-checker-data:
              type: anitya
              project-id: 5286
              url-template: https://www.tortall.net/projects/yasm/releases/yasm-$version.tar.gz
      - name: xmu
        buildsystem: autotools
        cleanup:
          - "/share/doc"
        sources:
          - type: archive
            url: https://xorg.freedesktop.org/releases/individual/lib/libXmu-1.2.1.tar.xz
            sha256: fcb27793248a39e5fcc5b9c4aec40cc0734b3ca76aac3d7d1c264e7f7e14e8b2
            x-checker-data:
              type: anitya
              project-id: 1785
              stable-only: true
              url-template: https://xorg.freedesktop.org/releases/individual/lib/libXmu-$version.tar.xz
      - name: lvm2
        cleanup:
          - "/bin"
          - "/sbin"
          - "/libexec"
        buildsystem: autotools
        # Prevents strip permission issues
        post-install:
          - chmod 755 "${FLATPAK_DEST}/lib"/libdevmapper*
          - chmod 755 "${FLATPAK_DEST}/bin"/*
          - chmod 755 "${FLATPAK_DEST}/sbin"/*
        sources:
          - type: git
            url: https://gitlab.com/lvmteam/lvm2.git
            tag: v2_03_35
            x-checker-data:
              type: git
              tag-pattern: ^v([\d_]+)$
        modules:
          - name: libaio
            no-autogen: true
            make-install-args:
              - prefix=${FLATPAK_DEST}
            sources:
              - type: archive
                url: https://releases.pagure.org/libaio/libaio-0.3.113.tar.gz
                sha256: 2c44d1c5fd0d43752287c9ae1eb9c023f04ef848ea8d4aafa46e9aedb678200b
                x-checker-data:
                  type: anitya
                  project-id: 1557
                  stable-only: true
                  url-template: https://releases.pagure.org/libaio/libaio-$version.tar.gz
