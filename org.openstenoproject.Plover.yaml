app-id: org.openstenoproject.Plover
runtime: org.kde.Platform
runtime-version: "6.9"
sdk: org.kde.Sdk
base: io.qt.PySide.BaseApp
base-version: "6.9"
command: plover
finish-args:
  - --share=network
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --device=all
cleanup-commands:
  - /app/cleanup-BaseApp.sh
rename-desktop-file: plover.desktop
rename-icon: plover
modules:
  # This file was generated with (from reqs/dist.txt):
  # ../flatpak-builder-tools/pip/flatpak-pip-generator appdirs pkginfo plover-stroke Pygments pyserial python-xlib evdev packaging psutil readme-renderer[md] requests-cache requests-futures rtf_tokenize setuptools wcwidth Babel --yaml --checker-data
  - modules/python3-modules.yaml
  # plover needs pygments & pip, but pygments is already installed in SDK but not in a runtime, so just copying to /app
  - name: python3-sdk-modules
    buildsystem: simple
    build-commands:
      build-commands:
        - PYTHON_VERSION=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
        - mkdir -p /app/lib/python${PYTHON_VERSION}/site-packages
        - cp -r /usr/lib/python${PYTHON_VERSION}/site-packages/pip{,-*} /app/lib/python${PYTHON_VERSION}/site-packages
        - cp -r /usr/lib/python${PYTHON_VERSION}/site-packages/pygments{,-*} /app/lib/python${PYTHON_VERSION}/site-packages
  - name: plover
    buildsystem: simple
    build-commands:
      - pip3 install --no-build-isolation --prefix=/app .

      - install -Dm 644 linux/plover.desktop --target-directory ${FLATPAK_DEST}/share/applications
      - install -Dm 644 plover/assets/plover.png --target-directory ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps
      - install -Dm 644 ${FLATPAK_ID}.metainfo.xml --target-directory ${FLATPAK_DEST}/share/metainfo
    sources:
      - type: archive
        url: https://github.com/openstenoproject/plover/archive/refs/tags/v5.0.0.dev3.tar.gz
        sha256: d0e9ba0214a66dcac54c4f2666ba72fe25151f77fd3277c7ad72ba9fe8064b31
        x-checker-data:
          type: anitya
          project-id: 194337
          url-template: https://github.com/openstenoproject/plover/archive/refs/tags/v$version.tar.gz
          is-main-source: true
          # should be changed when v5 is stable
          stable-only: false
      - type: file
        path: org.openstenoproject.Plover.metainfo.xml
