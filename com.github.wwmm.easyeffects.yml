# see https://github.com/wwmm/easyeffects/blob/master/PKGBUILD for dependencies
# If you get errors like 137, you might need pass --jobs=1 to flatpak-builder to limit cpu threads.
# discussion at here https://github.com/flathub/com.github.wwmm.pulseeffects/pull/53

id: com.github.wwmm.easyeffects
runtime: org.gnome.Platform
runtime-version: '40'
sdk: org.gnome.Sdk
command: easyeffects
rename-icon: easyeffects
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --filesystem=xdg-run/pipewire-0:ro
    # LADSPA Plugin PATH
  - --env=LADSPA_PATH=/app/lib/ladspa:/app/extensions/Plugins/ladspa
    # LV2 Plugin PATH
  - --env=LV2_PATH=/app/lib/lv2:/app/extensions/Plugins/lv2
cleanup:
  - '*.a'
  - '*.h'
  - '*.la'
  - /bin/analyseplugin
  - /bin/applyplugin
  - /bin/listplugins
  - /include
  - /lib/pkgconfig
  - /lib/python*
  - /share/info

add-extensions:
  org.freedesktop.LinuxAudio.Plugins:
    directory: extensions/Plugins
    version: "20.08"
    add-ld-path: lib
    merge-dirs: ladspa;lv2
    subdirectories: true
    no-autodownload: true
    
  org.freedesktop.LinuxAudio.Plugins.LSP:
    directory: extensions/Plugins/LSP
    version: "20.08"
    add-ld-path: lib
    merge-dirs: ladspa;lv2
    autodelete: false
    subdirectories: true

  org.freedesktop.LinuxAudio.Plugins.ZamPlugins:
    directory: extensions/Plugins/ZamPlugins
    version: "20.08"
    add-ld-path: lib
    merge-dirs: ladspa;lv2
    autodelete: false
    subdirectories: true

modules:
  
  - name: easyeffects
    buildsystem: meson
    build-options:
      env: # remove this variable when meson from pip is removed.
        PYTHONPATH: /app/utils/lib/python3.8/site-packages:/app/lib/python3.8/site-packages:/usr/lib/python3.8/site-packages
    sources:
      - type: git
        url: 'https://github.com/wwmm/easyeffects.git'
        # tag: v6.0.3
        commit: 6ef38aabd1817368a3030a260e09396bc236bec0 # use latest master with AppData fixes until release is tagged
        x-checker-data:
          type: git
          tag-pattern: "^v([\\d.]+)"
      - type: patch
        path: patch/easyeffects/001-fix-about-page-icon.patch
    post-install:
      - install -Dm644 -t $FLATPAK_DEST/share/licenses/com.github.wwmm.easyeffects ../LICENSE.md
      - mkdir -pm755 /app/extensions/Plugins
      
    modules:
      
      # Since easyeffects 6.0.0 need meson 0.57 or newer, and the gnome 40 runtime has an older one. 
      # When the gnome 41 runtime is released this can be removed, as well as PYTHONPATH from above.
      - name: meson
        buildsystem: simple
        build-commands:
          - 'pip3 install --ignore-installed --exists-action=i --no-index --find-links="file://${PWD}" --prefix=/$FLATPAK_DEST "meson"'
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/ed/46/e298a50dde405e1c202e316fa6a3015ff9288423661d7ea5e8f22f589071/wheel-0.36.2.tar.gz
            sha256: e11eefd162658ea59a60a0f6c7d493a7190ea4b9a85e335b33489d9f17e0245e
          - type: file
            url: https://files.pythonhosted.org/packages/cf/79/1a19c2f792da00cbead7b6caa176afdddf517522cb9163ce39576025b050/setuptools-57.1.0.tar.gz
            sha256: cfca9c97e7eebbc8abe18d5e5e962a08dcad55bb63afddd82d681de4d22a597b
          - type: file
            url: https://files.pythonhosted.org/packages/e6/e4/11fc433adb18567dcf90041c54e5e65b03e9451bc1a45f9cd2dac9e9bb05/meson-0.58.1.tar.gz
            sha256: 3144a3da662fcf79f1e5602fa929f2821cba4eba28c2c923fe0a7d3e3db04d5d
      
      - name: glibmm
        buildsystem: meson
        config-opts:
        - -Dbuild-documentation=false
        sources:
        - type: git
          url: 'https://gitlab.gnome.org/GNOME/glibmm.git'
          tag: "2.68.1"
          commit: 31b40adefc0d916246e60bd03a78b6ccae19f8a2
          x-checker-data:
            type: git
            tag-pattern: "^([\\d.]+)"
          cleanup:
          - '/lib/glibmm*'
          - '/lib/giomm*'
        modules:

          - name: mm-common
            buildsystem: meson
            sources:
              - type: archive
                url: 'https://download.gnome.org/sources/mm-common/1.0/mm-common-1.0.3.tar.xz'
                sha256: e81596625899aacf1d0bf27ccc2fcc7f373405ec48735ca1c7273c0fbcdc1ef5
                # gnome download source missing json file that f-e-d-c needs
                # git source results in "Error: libstdc++.tag does not exist."
            cleanup:
              - '*'

          - name: libsigc++
            buildsystem: meson
            config-opts:
              - -Dbuild-examples=false
            sources:
              - type: archive
                url: 'https://download.gnome.org/sources/libsigc++/3.0/libsigc++-3.0.7.tar.xz' # git release doesn't provide dot dependency
                sha256: bfbe91c0d094ea6bbc6cbd3909b7d98c6561eea8b6d9c0c25add906a6e83d733
                x-checker-data:
                  type: gnome
                  name: libsigc++
                  stable-only: true
                  
            cleanup:
              - '/lib/sigc++*'
      
      - name: gtkmm
        buildsystem: meson
        config-opts:
        - -Dbuild-documentation=false
        sources:
        - type: git
          url: 'https://gitlab.gnome.org/GNOME/gtkmm.git'
          tag: 4.2.0
          commit: e0e280baf48b9899b1870a3308ea8fb31c83ebb5
          x-checker-data:
            type: git
            tag-pattern: "^([\\d.]+)"

          cleanup:
          - '/lib/gdkmm*'
          - '/lib/gtkmm*'
        modules:

          - name: atkmm
            buildsystem: meson
            config-opts:
              - -Dbuild-documentation=false
            sources:
              - type: archive
                url: 'https://download.gnome.org/sources/atkmm/2.36/atkmm-2.36.1.tar.xz'
                sha256: e11324bfed1b6e330a02db25cecc145dca03fb0dff47f0710c85e317687da458
                x-checker-data:
                  type: gnome
                  name: atkmm
                  stable-only: true
            cleanup:
              - '/lib/atkmm*'

          - name: cairomm
            build-options:
              - git config fsck.skiplist "$PWD/.git/skiplist" # Necessary to skip git fsck check for a commit in the cairomm repo
              - echo "016c362e95d96e129374b07258b246bc2412c526" >> .git/skiplist # See https://gitlab.freedesktop.org/cairo/cairomm/-/issues/28
            config-opts:
              - --disable-documentation
            sources:
              # cairomm >= 1.14.0 requires sigc++ 3.0 and other modules require cairomm < 1.13.0
              - type: git
                url: 'https://gitlab.freedesktop.org/cairo/cairomm.git'
                tag: 1.16.1
                commit: 61286896d11ed961add217ff4a209d10d9efb700
                x-checker-data:
                  type: git
                  tag-pattern: "^([\\d.]+)"
                
            post-install:
              - install -Dm644 -t /app/share/licenses/cairomm COPYING
            cleanup:
              - '/lib/cairomm*'

          - name: pangomm
            buildsystem: meson
            config-opts:
              - -Dbuild-documentation=false
            sources:
              - type: git
                url: 'https://gitlab.gnome.org/GNOME/pangomm.git'
                tag: 2.49.1
                commit: 73a834196de6e3b016a16fab299865c0caffad26
                x-checker-data:
                  type: git
                  tag-pattern: "^([\\d.]+)"
            cleanup:
              - '/lib/pangomm*'

      - name: libebur128
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -DBUILD_STATIC_LIBS=OFF
          - -DCMAKE_INSTALL_LIBDIR=lib
        sources:
          - type: git
            url: 'https://github.com/jiixyj/libebur128.git'
            tag: v1.2.6
            commit: 67b33abe1558160ed76ada1322329b0e9e058b02
            x-checker-data:
              type: git
              tag-pattern: "^v([\\d.]+)"
        post-install:
          - install -Dm644 -t $FLATPAK_DEST/share/licenses/libebur128 COPYING

      - name: zita-convolver
        no-autogen: true
        subdir: source
        make-install-args:
          - "PREFIX=${FLATPAK_DEST}"
          - "LIBDIR=${FLATPAK_DEST}/lib"
        sources:
          - type: archive
            url: 'https://kokkinizita.linuxaudio.org/linuxaudio/downloads/zita-convolver-4.0.3.tar.bz2'
            sha512: 62d7841757f10c094e43ed755e187f947c5743f302ed2a1ee6064a850c18921466f4505d8a2a7b3ad23619db7f1ad7307e1dfb2e8a1e7685e60ece2ffff4f6ca
          - type: patch
            path: patch/zita-convolver/0001-Fix-makefile.patch
            # still necessary as of 2021-08-04
        modules:
          - "shared-modules/linux-audio/fftw3f.json"
          - "shared-modules/linux-audio/ladspa.json"
          - "shared-modules/linux-audio/lv2.json"
          - "shared-modules/linux-audio/lilv.json" # Required by libgstlv2.so

          - name: bs2b
            rm-configure: true
            sources:
              - type: archive
                url: 'https://downloads.sourceforge.net/sourceforge/bs2b/libbs2b-3.1.0.tar.gz' # was last updated in 2009 so x-checker-data probably not too helpful
                sha256: 6aaafd81aae3898ee40148dd1349aab348db9bfae9767d0e66e0b07ddd4b2528
              - type: script
                dest-filename: autogen.sh
                commands:
                  - cp -p /usr/share/automake-*/config.{sub,guess} build-aux
                  - autoreconf -vfi
              - type: patch
                path: patch/bs2b/001-fix-automake-dist-lzma.patch
                # still necessary as of 2021-08-04
            post-install:
              - install -Dm644 -t $FLATPAK_DEST/share/licenses/bs2b COPYING
            cleanup:
              - /bin

          - name: speexdsp
            buildsystem: autotools
            sources:
              - type: git
                url: 'https://gitlab.xiph.org/xiph/speexdsp'
                tag: 'SpeexDSP-1.2.0'
                commit: 64cbfa9bca7479a758351aa02bb4abdd76baa9e7
                x-checker-data:
                  type: git
                  tag-pattern: "^SpeexDSP-([\\d.]+)"
                # Note to future Flatpakers: webrtc-audio-processing has a module in the pulseeffects manifest that could replace speexdsp.
                # Why it was removed: https://github.com/flathub/com.github.wwmm.pulseeffects/issues/44#issuecomment-885999963
                # Original module: https://github.com/flathub/com.github.wwmm.pulseeffects/blob/81e34d9bf6ee08610ac8bf79454412c3eaaa83ce/com.github.wwmm.pulseeffects.yml#L225
                # You might also need the patch from that repo: https://github.com/flathub/com.github.wwmm.pulseeffects/blob/81e34d9bf6ee08610ac8bf79454412c3eaaa83ce/patch/webrtc-audio-processing/0001-build-Use-cmake-to-look-up-abseil-dependency.patch
          
          # Ladspa & LV2 Plugins
          
          # manifest module from: https://github.com/flathub/io.mpv.Mpv/blob/73681476e1abde88770804c497f03c4bfea027f6/io.mpv.Mpv.yml#L223
          - name: rubberband
            buildsystem: meson
            cleanup:
              - /include
              - /lib/*.a
              - /lib/pkgconfig
            sources:
              - type: archive
                url: https://breakfastquay.com/files/releases/rubberband-1.9.2.tar.bz2
                sha256: b3cff5968517141fcf9e1ef6b5a1fdb06a5511f148000609216cf182ff4ab612
                x-checker-data:
                  type: html
                  url: https://www.breakfastquay.com/rubberband/
                  version-pattern: Rubber Band Library v(\d\.\d+\.?\d*) source
                  url-template: https://breakfastquay.com/files/releases/rubberband-$version.tar.bz2

          - name: calf
            sources:
              - type: git
                url: 'https://github.com/calf-studio-gear/calf.git'
                tag: "0.90.3"
                commit: 41a2b7fb029cf0099fc05b7a9c569208034018de
                x-checker-data:
                  type: git
                  tag-pattern: "^([\\d.]+)" 
                  
            post-install:
              - install -Dm644 -t $FLATPAK_DEST/share/licenses/calf COPYING
            cleanup:
              - /bin
              - /share/applications
              - /share/bash-completion
              - /share/calf
              - /share/doc
              - /share/icons
              - /share/man
            modules:
              - "shared-modules/linux-audio/fluidsynth2.json"

      - name: rnnoise
        sources:
          - type: git
            url: 'https://github.com/xiph/rnnoise.git'
            commit: 1cbdbcf1283499bbb2230a6b0f126eb9b236defd
          #  x-checker-data: might not work properly since no tags upstream: https://github.com/xiph/rnnoise/issues/137

        cleanup:
          - /share/doc/rnnoise

      # Easyeffects 6.0.0 depends on pipewire >=0.3.31, gnome 40 runtime has 0.3.25
      - name: pipewire
        buildsystem: meson
        config-opts:
          - -Dgstreamer=disabled
          - -Dman=disabled
          - -Dsystemd=disabled
          - -Dudev=disabled
          - -Dudevrulesdir=disabled
        sources:
          - type: git
            url: https://gitlab.freedesktop.org/pipewire/pipewire.git
            tag: "0.3.32"
            commit: 41ce3092756ab27106881f4246e54bf32ea5adbe
            x-checker-data:
              type: git
              tag-pattern: "^([\\d.]+)"
            
      - name: nlohmann-json
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
        sources:
          - type: archive
            url: https://github.com/nlohmann/json/archive/v3.9.1.tar.gz
            sha256: 4cf0df69731494668bdd6460ed8cb269b68de9c19ad8c27abc24cd72605b2d5b
            x-checker-data:
              type: anitya
              project-id: 141453
              url-template: https://github.com/nlohmann/json/archive/v$version.tar.gz