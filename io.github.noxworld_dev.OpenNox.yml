app-id: io.github.noxworld_dev.OpenNox
command: opennox

runtime-version: &runtime-version '22.08'
x-gl-version: &gl-version '1.4'
x-gl-versions: &gl-versions 22.08;1.4

sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Compat.i386
  - org.freedesktop.Sdk.Extension.toolchain-i386
  - org.freedesktop.Sdk.Extension.golang

runtime: org.freedesktop.Platform
add-extensions:
  org.freedesktop.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: *runtime-version

  # This is not strictly required, but needed for debugging 32-bit programs
  org.freedesktop.Platform.Compat.i386.Debug:
    directory: lib/debug/lib/i386-linux-gnu
    version: *runtime-version
    no-autodownload: true

  org.freedesktop.Platform.GL32:
    directory: lib/i386-linux-gnu/GL
    version: *gl-version
    versions: *gl-versions
    subdirectories: true
    no-autodownload: true
    autodelete: false
    add-ld-path: lib
    merge-dirs: vulkan/icd.d;glvnd/egl_vendor.d;OpenCL/vendors;lib/dri;lib/d3d;vulkan/explicit_layer.d;vulkan/implicit_layer.d
    download-if: active-gl-driver
    enable-if: active-gl-driver

finish-args:
  - --allow=multiarch
  # X11 + XShm access
  - --share=ipc
  - --socket=fallback-x11
  # Wayland access
  - --socket=wayland
  # Needs to talk to the network:
  - --share=network
  # OpenGL acceleration
  - --device=dri
  # Sound access
  - --socket=pulseaudio
  # Needs to load Nox data from somewhere:
  - --filesystem=home # TODO: list all dirs that we usually scan?

modules:
  - name: bundle-setup
    buildsystem: simple
    build-commands:
      - mkdir -p /app/lib/i386-linux-gnu
      - mkdir -p /app/lib/debug/lib/i386-linux-gnu
      - mkdir -p /app/lib/i386-linux-gnu/GL
      - install -Dm644 ld.so.conf /app/etc/ld.so.conf
    sources:
      - type: inline
        dest-filename: ld.so.conf
        contents: |
          /app/lib32
          /app/lib/i386-linux-gnu
  - name: opennox
    buildsystem: simple
    build-options:
#      build-args:
#        - --share=network
      prepend-pkg-config-path: /app/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig
      ldflags: -L/app/lib32
      prepend-path: /usr/lib/sdk/golang/bin:/usr/lib/sdk/toolchain-i386/bin
    build-commands:
      - install -Dm 644 ./app/io.github.noxworld_dev.OpenNox.metainfo.xml /app/share/metainfo/io.github.noxworld_dev.OpenNox.metainfo.xml
      - install -Dm 644 ./res/app/opennox_256.png /app/share/icons/hicolor/256x256/apps/io.github.noxworld_dev.OpenNox.png
      - install -Dm 644 ./app/io.github.noxworld_dev.OpenNox.desktop /app/share/applications/io.github.noxworld_dev.OpenNox.desktop
      - install -Dm 644 ./app/io.github.noxworld_dev.OpenNox.HD.desktop /app/share/applications/io.github.noxworld_dev.OpenNox.HD.desktop
      - cd src && GOARCH=386 CC=i686-unknown-linux-gnu-gcc go run ./internal/noxbuild client client-hd
      - install -Dm 755 ./src/opennox /app/bin/opennox
      - install -Dm 755 ./src/opennox-hd /app/bin/opennox-hd
    sources:

      # Main engine source
      - type: git
        url: https://github.com/noxworld-dev/opennox
        # tag: v1.8.12 # TODO: release
        commit: 0a8352cafef2619ebb2534f69b4f0013aafff493

      # Resources
      - type: git
        url: https://github.com/noxworld-dev/opennox-content
        commit: c262619501e6c76b208adbf66d604de07ddbddaa
        dest: ./res

      # Workaround for Go modules generated by github.com/dennwc/flatpak-go-mod
      - type: file
        path: modules.txt
        dest: src/vendor

      - type: archive
        url: https://proxy.golang.org/github.com/noxworld-dev/lobby/@v/v0.0.0-20220306183851-3877f0a7002d.zip
        strip-components: 3
        dest: src/vendor/github.com/noxworld-dev/lobby
        sha256: 30a7c393c0237f0afb04dd49b3125d2dca60845492038d6c3b14aa397db4a283

      - type: archive
        url: https://proxy.golang.org/github.com/noxworld-dev/nat/@v/v0.1.0.zip
        strip-components: 3
        dest: src/vendor/github.com/noxworld-dev/nat
        sha256: 9cf47d9161b2f0205fddacc27f75ab3adb3827554e0474b1d4884db5cc12c9c7

      - type: archive
        url: https://proxy.golang.org/github.com/noxworld-dev/noxcrypt/@v/v0.0.0-20220809211245-2c69b67c4ae9.zip
        strip-components: 3
        dest: src/vendor/github.com/noxworld-dev/noxcrypt
        sha256: de268f0e977de6a7abcce980f5abf4dfc277ddca23aacc8b2362d55ece7f603e

      - type: archive
        url: https://proxy.golang.org/github.com/noxworld-dev/opennox-lib/@v/v0.0.0-20221231150548-07fe5c19848c.zip
        strip-components: 3
        dest: src/vendor/github.com/noxworld-dev/opennox-lib
        sha256: 823712c6816820b32ba3263fc9e48b1b9c29f12688dcf7be1815fbb4e01673cb

      - type: archive
        url: https://proxy.golang.org/github.com/noxworld-dev/vqa-decode/@v/v0.0.0-20220408200150-8bbbe7a064f7.zip
        strip-components: 3
        dest: src/vendor/github.com/noxworld-dev/vqa-decode
        sha256: 367d0084e69ff088faa23c8cfb8888eaf6997f2c94a34244ae52127b92639a98

      - type: archive
        url: https://proxy.golang.org/github.com/noxworld-dev/xwis/@v/v0.0.0-20220204182326-c5d2fc18e75e.zip
        strip-components: 3
        dest: src/vendor/github.com/noxworld-dev/xwis
        sha256: 353072d292d2ecf4c9687d16c30f6ee6a61b2e51a6e7070bc7018976ca737d40

      - type: archive
        url: https://proxy.golang.org/github.com/prometheus/client_golang/@v/v1.12.1.zip
        strip-components: 3
        dest: src/vendor/github.com/prometheus/client_golang
        sha256: d9bbfcdcb5f63812b6766884a0f5ad5b1f9a675375d28e307573f49e2ef96b7b

      - type: archive
        url: https://proxy.golang.org/github.com/spf13/cobra/@v/v1.5.0.zip
        strip-components: 3
        dest: src/vendor/github.com/spf13/cobra
        sha256: 3b0a43f96d85d4370b6ed69e61b0871b4f2dddf77e92597eb964703560ccee92

      - type: archive
        url: https://proxy.golang.org/github.com/spf13/viper/@v/v1.8.1.zip
        strip-components: 3
        dest: src/vendor/github.com/spf13/viper
        sha256: 3223fb4fb8308f36d504b12653027403fa277cc03f49141e6539edb6991f7fef

      - type: archive
        url: https://proxy.golang.org/github.com/stretchr/testify/@v/v1.8.0.zip
        strip-components: 3
        dest: src/vendor/github.com/stretchr/testify
        sha256: d880adf449449120b459a2220f539c69648fd797ded5b745cf3add60ec84081e

      - type: archive
        url: https://proxy.golang.org/github.com/szhublox/opennoxcontrol/@v/v0.0.0-20211214215120-c4bc4281312f.zip
        strip-components: 3
        dest: src/vendor/github.com/szhublox/opennoxcontrol
        sha256: 8ce766c2cc36414f521edcfeb927a2fc64fcd884b17d84300ea654998d767dbd

      - type: archive
        url: https://proxy.golang.org/github.com/noxworld-dev/go-openal/@v/v0.0.0-20220410091615-164a70f24e7c.zip
        strip-components: 3
        dest: src/vendor/github.com/timshannon/go-openal
        sha256: 950c75b2f94faa549c915e9ea4c4be7b5fe3191131c204e3b9499f05217bca55

      - type: archive
        url: https://proxy.golang.org/github.com/youpy/go-wav/@v/v0.3.2.zip
        strip-components: 3
        dest: src/vendor/github.com/youpy/go-wav
        sha256: 2ebb37b9c845a59ee99b89bd7ac1495eedb3e4c06332dcb55fc7324782c07517

      - type: archive
        url: https://proxy.golang.org/golang.org/x/crypto/@v/v0.1.0.zip
        strip-components: 3
        dest: src/vendor/golang.org/x/crypto
        sha256: d3931b10979096640867809147e8c7d0f1c8bc0dd3d400947e01c29eefa6898e

      - type: archive
        url: https://proxy.golang.org/golang.org/x/image/@v/v0.0.0-20220902085622-e7cb96979f69.zip
        strip-components: 3
        dest: src/vendor/golang.org/x/image
        sha256: 0169cad235a87dc82f3b24303bcc7f1c25b9d4993d9a503ce7310815dba86f0f

      - type: archive
        url: https://proxy.golang.org/golang.org/x/mod/@v/v0.6.0.zip
        strip-components: 3
        dest: src/vendor/golang.org/x/mod
        sha256: 3f45c4fd992e55f087484632cb6bf19f5bba68e51bd18a2f3e10c88771eec268

      - type: archive
        url: https://proxy.golang.org/golang.org/x/sync/@v/v0.0.0-20210220032951-036812b2e83c.zip
        strip-components: 3
        dest: src/vendor/golang.org/x/sync
        sha256: 92a8663af035a6831dcc9cc9d895a1f4bb51fc21efe97f04fa0676fc14992a46

      - type: archive
        url: https://proxy.golang.org/golang.org/x/sys/@v/v0.4.0.zip
        strip-components: 3
        dest: src/vendor/golang.org/x/sys
        sha256: efa9354fcaa709825bbb1c86b83e2347cebb5349f4326cc4c8ccb972ad32032c

      - type: archive
        url: https://proxy.golang.org/gopkg.in/yaml.v2/@v/v2.4.0.zip
        strip-components: 2
        dest: src/vendor/gopkg.in/yaml.v2
        sha256: ede49e27c4cca6cdd2ec719aed8ea4d363710cceb3d411e7a786fbdec0d391fd

      - type: archive
        url: https://proxy.golang.org/github.com/!joshua!does/adpcm-go/@v/v0.0.0-20190311011514-2274d526c08b.zip
        strip-components: 3
        dest: src/vendor/github.com/JoshuaDoes/adpcm-go
        sha256: a2853c8e9b414ce170f3031a70f2b0c25165423aefb9a59f044265b313b553bc

      - type: archive
        url: https://proxy.golang.org/github.com/alessio/shellescape/@v/v1.4.1.zip
        strip-components: 3
        dest: src/vendor/github.com/alessio/shellescape
        sha256: e28d444e73b803a15cf83e6179149d34c6c132baa60cb8137e5f0aea50a543bf

      - type: archive
        url: https://proxy.golang.org/github.com/beorn7/perks/@v/v1.0.1.zip
        strip-components: 3
        dest: src/vendor/github.com/beorn7/perks
        sha256: 25bd9e2d94aca770e6dbc1f53725f84f6af4432f631d35dd2c46f96ef0512f1a

      - type: archive
        url: https://proxy.golang.org/github.com/cespare/xxhash/v2/@v/v2.1.2.zip
        strip-components: 4
        dest: src/vendor/github.com/cespare/xxhash/v2
        sha256: ac641ac8330df61f677c87448fc679c47886087d2933a1e431556f423782ea38

      - type: archive
        url: https://proxy.golang.org/github.com/davecgh/go-spew/@v/v1.1.1.zip
        strip-components: 3
        dest: src/vendor/github.com/davecgh/go-spew
        sha256: 6b44a843951f371b7010c754ecc3cabefe815d5ced1c5b9409fb2d697e8a890d

      - type: archive
        url: https://proxy.golang.org/github.com/fsnotify/fsnotify/@v/v1.4.9.zip
        strip-components: 3
        dest: src/vendor/github.com/fsnotify/fsnotify
        sha256: fe48f570801de16bfe973dc74e7e5923ae689ba8c274437f65dbc8a63537f759

      - type: archive
        url: https://proxy.golang.org/github.com/go-gl/gl/@v/v0.0.0-20211210172815-726fda9656d6.zip
        strip-components: 3
        dest: src/vendor/github.com/go-gl/gl
        sha256: 25f3f14188565565b95bef7b955e1c6e0d06bccb90b2c598a078e9c73b6f66dd

      - type: archive
        url: https://proxy.golang.org/github.com/golang/protobuf/@v/v1.5.2.zip
        strip-components: 3
        dest: src/vendor/github.com/golang/protobuf
        sha256: 5d1c817bebc1202ab3b42a418e584e0008e8027baf212ce69c2ae3e9e7b8c64b

      - type: archive
        url: https://proxy.golang.org/github.com/hashicorp/hcl/@v/v1.0.0.zip
        strip-components: 3
        dest: src/vendor/github.com/hashicorp/hcl
        sha256: 54149a2e5121b3e81f961c79210e63d6798eb63de28d2599ee59ade1fa76c82b

      - type: archive
        url: https://proxy.golang.org/github.com/huin/goupnp/@v/v1.0.2.zip
        strip-components: 3
        dest: src/vendor/github.com/huin/goupnp
        sha256: 80f1654b8d334740e7a79feace96ac3669508c45c18083890d7cfb6e164b79e6

      - type: archive
        url: https://proxy.golang.org/github.com/icza/bitio/@v/v1.1.0.zip
        strip-components: 3
        dest: src/vendor/github.com/icza/bitio
        sha256: a0d9b47492a3fdad12aeeb0a3d508b587a8b13650fbe43d43d0a3eafc33fcbcb

      - type: archive
        url: https://proxy.golang.org/github.com/inconshreveable/mousetrap/@v/v1.0.1.zip
        strip-components: 3
        dest: src/vendor/github.com/inconshreveable/mousetrap
        sha256: af6f61a00f42d025f195ea272620bbddb045552a9badcf97d8a837980017dbfc

      - type: archive
        url: https://proxy.golang.org/github.com/jpillora/backoff/@v/v1.0.0.zip
        strip-components: 3
        dest: src/vendor/github.com/jpillora/backoff
        sha256: f856692c725143c49b9cceabfbca8bc93d3dbde84a0aaa53fb26ed3774c220cc

      - type: archive
        url: https://proxy.golang.org/github.com/julienschmidt/httprouter/@v/v1.3.0.zip
        strip-components: 3
        dest: src/vendor/github.com/julienschmidt/httprouter
        sha256: e457dccd7015f340664e3b8cfd41997471382da2f4a743ee55be539abc6ca1f9

      - type: archive
        url: https://proxy.golang.org/github.com/magiconair/properties/@v/v1.8.5.zip
        strip-components: 3
        dest: src/vendor/github.com/magiconair/properties
        sha256: fa056b3c72df6a36c991e9f22285818b07e377bf07c7beb441d9a097b2d6263e

      - type: archive
        url: https://proxy.golang.org/github.com/matttproud/golang_protobuf_extensions/@v/v1.0.1.zip
        strip-components: 3
        dest: src/vendor/github.com/matttproud/golang_protobuf_extensions
        sha256: e64dc58023f4b8c4472d05a44f2719b84d6c2cc364cc682820c9f72b233c9cdc

      - type: archive
        url: https://proxy.golang.org/github.com/mitchellh/mapstructure/@v/v1.4.1.zip
        strip-components: 3
        dest: src/vendor/github.com/mitchellh/mapstructure
        sha256: bfe856861145c25f6f26c2985760e86a4634e2a28bb9b4582ff0e8a9d2621e10

      - type: archive
        url: https://proxy.golang.org/github.com/pelletier/go-toml/@v/v1.9.3.zip
        strip-components: 3
        dest: src/vendor/github.com/pelletier/go-toml
        sha256: a52f4a0d5d8f6e98bbfc493ec947e1be44b8f304005d2059ecc4c5938b712961

      - type: archive
        url: https://proxy.golang.org/github.com/pmezard/go-difflib/@v/v1.0.0.zip
        strip-components: 3
        dest: src/vendor/github.com/pmezard/go-difflib
        sha256: de04cecc1a4b8d53e4357051026794bcbc54f2e6a260cfac508ce69d5d6457a0

      - type: archive
        url: https://proxy.golang.org/github.com/prometheus/client_model/@v/v0.2.0.zip
        strip-components: 3
        dest: src/vendor/github.com/prometheus/client_model
        sha256: c3e0c48e8786a8cc4ff2de3d0fe3097f07f0e3882f827981c6371bf9cb449b5d

      - type: archive
        url: https://proxy.golang.org/github.com/prometheus/common/@v/v0.32.1.zip
        strip-components: 3
        dest: src/vendor/github.com/prometheus/common
        sha256: 9630b9bbfcf1746a01c8aff0262271c60cf891fa1cd48a8ed9149de557dc98d6

      - type: archive
        url: https://proxy.golang.org/github.com/prometheus/procfs/@v/v0.7.3.zip
        strip-components: 3
        dest: src/vendor/github.com/prometheus/procfs
        sha256: 3e37c9f62738a493dd28283179d802749050353df0bca161df7cec4ed43e6f1a

      - type: archive
        url: https://proxy.golang.org/github.com/spf13/afero/@v/v1.6.0.zip
        strip-components: 3
        dest: src/vendor/github.com/spf13/afero
        sha256: 234791203d4bb7405bf5ef7f5cecc6e64fdfa9fc5a12d85b6ec7ecdb86cc0834

      - type: archive
        url: https://proxy.golang.org/github.com/spf13/cast/@v/v1.3.1.zip
        strip-components: 3
        dest: src/vendor/github.com/spf13/cast
        sha256: 9431fba3679d68cb98976c0f87e20520555835ecf772182991a37831426f219e

      - type: archive
        url: https://proxy.golang.org/github.com/spf13/jwalterweatherman/@v/v1.1.0.zip
        strip-components: 3
        dest: src/vendor/github.com/spf13/jwalterweatherman
        sha256: 43cc5f056caf66dc8225dca36637bfc18509521b103a69ca76fbc2b6519194a3

      - type: archive
        url: https://proxy.golang.org/github.com/spf13/pflag/@v/v1.0.5.zip
        strip-components: 3
        dest: src/vendor/github.com/spf13/pflag
        sha256: fc6e704f2f6a84ddcdce6de0404e5340fa20c8676181bf5d381b17888107ba84

      - type: archive
        url: https://proxy.golang.org/github.com/subosito/gotenv/@v/v1.2.0.zip
        strip-components: 3
        dest: src/vendor/github.com/subosito/gotenv
        sha256: 21474df92536f36de6f91dfbf466995289445cc4e5a5900d9c40ae8776b8b0cf

      - type: archive
        url: https://proxy.golang.org/github.com/tawesoft/golib/v2/@v/v2.6.1.zip
        strip-components: 4
        dest: src/vendor/github.com/tawesoft/golib/v2
        sha256: b9e8a794d4d1a0914dd36fdd4c2982bf96b2b97500055f03a5e4780b2a910c4c

      - type: archive
        url: https://proxy.golang.org/github.com/traefik/yaegi/@v/v0.14.4-0.20221213104605-eee72d1aae66.zip
        strip-components: 3
        dest: src/vendor/github.com/traefik/yaegi
        sha256: a71d1414cefe65971e2a1c694dca95130da6bb7d76bcdf47ee69003d9a143aba

      - type: archive
        url: https://proxy.golang.org/github.com/veandco/go-sdl2/@v/v0.4.25.zip
        strip-components: 3
        dest: src/vendor/github.com/veandco/go-sdl2
        sha256: 64f4f14601398d823f3865961c8cd5a170086771fc1abfc496def205b5f637d8

      - type: archive
        url: https://proxy.golang.org/github.com/youpy/go-riff/@v/v0.1.0.zip
        strip-components: 3
        dest: src/vendor/github.com/youpy/go-riff
        sha256: 199da76e62d23d328336168582389ae503267967ff4e7a7000cb611c49cb1aac

      - type: archive
        url: https://proxy.golang.org/github.com/yuin/gopher-lua/@v/v0.0.0-20220504180219-658193537a64.zip
        strip-components: 3
        dest: src/vendor/github.com/yuin/gopher-lua
        sha256: e2bcfda5f6a59d8d7052f1dfe972d0339d2f8a595229ebbdb98cbd8a93a5c6b2

      - type: archive
        url: https://proxy.golang.org/github.com/zaf/g711/@v/v0.0.0-20190814101024-76a4a538f52b.zip
        strip-components: 3
        dest: src/vendor/github.com/zaf/g711
        sha256: f1ddb8d83fb1b68ac35d881e29cedc34798662c67ba4ce9fa532061012d70092

      - type: archive
        url: https://proxy.golang.org/golang.org/x/exp/@v/v0.0.0-20230111222715-75897c7a292a.zip
        strip-components: 3
        dest: src/vendor/golang.org/x/exp
        sha256: 515198509caaae206ebee90d78407c9555d442b9d9c3d86524585c64c702ca1e

      - type: archive
        url: https://proxy.golang.org/golang.org/x/text/@v/v0.6.0.zip
        strip-components: 3
        dest: src/vendor/golang.org/x/text
        sha256: 9ec73e8442436b333e7d0920dc046e8d71da71de5866f26d4476207946a6df83

      - type: archive
        url: https://proxy.golang.org/google.golang.org/protobuf/@v/v1.27.1.zip
        strip-components: 2
        dest: src/vendor/google.golang.org/protobuf
        sha256: 93180890add31a55b56d9c083a397c1dacc3571afa83981d0daa16f0afaf51d0

      - type: archive
        url: https://proxy.golang.org/gopkg.in/ini.v1/@v/v1.62.0.zip
        strip-components: 2
        dest: src/vendor/gopkg.in/ini.v1
        sha256: 9cbe2a2bdd30dd07d98f431307e66607cbfcf344fc11cd29e592753015c2d77e

      - type: archive
        url: https://proxy.golang.org/gopkg.in/irc.v3/@v/v3.1.4.zip
        strip-components: 2
        dest: src/vendor/gopkg.in/irc.v3
        sha256: 1e8b18a2987662b64a869a2a71a01f3746db5db4337afdc6bed62093b6b61dd9

      - type: archive
        url: https://proxy.golang.org/gopkg.in/yaml.v3/@v/v3.0.1.zip
        strip-components: 2
        dest: src/vendor/gopkg.in/yaml.v3
        sha256: aab8fbc4e6300ea08e6afe1caea18a21c90c79f489f52c53e2f20431f1a9a015
