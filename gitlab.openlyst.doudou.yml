app-id: gitlab.openlyst.doudou
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: doudou

finish-args:
  # X11 + XShm access (fallback)
  - --share=ipc
  - --socket=fallback-x11
  # Wayland access
  - --socket=wayland
  # Audio playback
  - --socket=pulseaudio
  # Network access (for streaming)
  - --share=network
  # OpenGL access
  - --device=dri

modules:
  # FFmpeg - required by mpv
  - name: ffmpeg
    config-opts:
      - --enable-shared
      - --disable-static
      - --disable-doc
      - --disable-programs
      - --enable-gpl
      - --enable-version3
      - --enable-libvorbis
      - --enable-libopus
      - --enable-libvpx
      - --enable-libmp3lame
    sources:
      - type: archive
        url: https://ffmpeg.org/releases/ffmpeg-7.0.2.tar.xz
        sha256: 8646515b638a3ad303e23af6a3587734447cb8fc0a0c064ecdb8e95c4fd8b389
    cleanup:
      - /share/ffmpeg/examples

  # libass - subtitle rendering
  - name: libass
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: https://github.com/libass/libass/releases/download/0.17.1/libass-0.17.1.tar.xz
        sha256: f0da0bbfba476c16ae3e1cfd862256d30915911f7abaa1b16ce62ee653192784

  # libplacebo - required by mpv for GPU video output
  - name: libplacebo
    buildsystem: meson
    config-opts:
      - -Dvulkan=enabled
      - -Dshaderc=disabled
      - -Dglslang=disabled
      - -Ddemos=false
    sources:
      - type: git
        url: https://code.videolan.org/videolan/libplacebo.git
        tag: v6.338.2
        commit: 64c1954570f1cd57f8570a57e51fb0249b57bb90

  # MPV
  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dlibmpv=true
      - -Dcplayer=true
      - -Dbuild-date=false
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.39.0.tar.gz
        sha256: 2ca92437affb62c2b559b4419ea4785c70d023590500e8a52e95ea3ab4554683
    cleanup:
      - /share/applications
      - /share/icons
      - /share/zsh

  # Doudou application
  - name: doudou
    buildsystem: simple
    build-commands:
      # Create app directory structure
      - install -d /app/bin
      - install -d /app/lib/doudou
      - install -d /app/lib/doudou/lib
      - install -d /app/lib/doudou/data
      - install -d /app/share/metainfo
      - install -d /app/share/applications
      
      # Copy the application files
      - cp doudou /app/lib/doudou/
      - cp -r flutter_assets icudtl.dat /app/lib/doudou/data/
      - cp *.so /app/lib/doudou/lib/
      
      # Install desktop file and metainfo
      - install -Dm644 gitlab.openlyst.doudou.desktop /app/share/applications/gitlab.openlyst.doudou.desktop
      - install -Dm644 gitlab.openlyst.doudou.xml /app/share/metainfo/gitlab.openlyst.doudou.metainfo.xml
      
      # Install icon
      - install -Dm644 flutter_assets/assets/icons/doudou.svg /app/share/icons/hicolor/scalable/apps/gitlab.openlyst.doudou.svg
      
      # Create wrapper script to set library paths
      - |
        cat > /app/bin/doudou <<EOF
        #!/bin/bash
        export LD_LIBRARY_PATH="/app/lib:/app/lib/doudou/lib:\$LD_LIBRARY_PATH"
        exec /app/lib/doudou/doudou "\$@"
        EOF
      - chmod +x /app/bin/doudou
      
      # Make the main executable runnable
      - chmod +x /app/lib/doudou/doudou
      
    sources:
      - type: archive
        url: https://files.catbox.moe/ghrg4g.zip
        sha256: d7a1b63d553d8918317feb5bd52738a027d706f0d45460385cf6e7112b5caebc
      - type: file
        path: gitlab.openlyst.doudou.desktop
      - type: file
        path: gitlab.openlyst.doudou.xml