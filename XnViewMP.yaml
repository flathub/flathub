name: XnViewMP
buildsystem: simple
sources:
  - type: archive
    url: https://download.xnview.com/old_versions/XnViewMP-093-linux-x64.tgz
    sha256: 08f2b2d9a6d652a298a4b718e64d02c2e01e81bc3aaa2c08a7eec5fd1d0a01c9
    strip-components: 0
  # Hi-res icon
  - type: file
    path: app-xnviewmp-512.png
    #url: https://www.xnview.com/assets/img/app-xnviewmp-512.png
    #sha256: d96e58b8e58e1b0b47dc3fd1e674115985c214223fac6fd4915158fdd0a1b637
  # GenericName, Comment, Keywords from gThumb
  # https://koji.fedoraproject.org/koji/buildinfo?buildID=1183283
  - type: file
    path: XnViewMP-desktop.txt
  # AppData file
  - type: file
    path: com.xnview.XnViewMP.appdata.xml
build-commands:
  - |
    find "XnView" -xtype f -executable \( -iname '*.jpg' -o -iname '*.png' -o -iname '*.txt' -o -iname '*.zip' \) -exec chmod -x {} +;
    cp -a "XnView" "${FLATPAK_DEST}/";
    ln -s "${FLATPAK_DEST}/XnView/xnview.sh" "${FLATPAK_DEST}/bin/xnview";
  - |
    for file in "XnView"/*.png; do
      install -p -D -m 0644 "${file}" -t "${FLATPAK_DEST}/share/pixmaps/";
    done;
  - |
    icon_in="app-xnviewmp-512.png";
    icon_out="${FLATPAK_ID}.png";
    for s in {16,22,24,32,36,48,64,72,96,128,192,256}; do
      convert -background none -density 1024 -resize "${s}x${s}" "${icon_in}" "${icon_out}";
      install -p -D -m 0644 "${icon_out}" -t "${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/";
    done;
    install -p -D -m 0644 "${icon_in}" "${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${icon_out}";
  - > 
    desktop-file-edit
    --remove-key="Value"
    --set-key="TryExec" --set-value="xnview"
    --set-key="Exec" --set-value="xnview %F"
    --set-key="Icon" --set-value="${FLATPAK_ID}"
    --set-key="StartupWMClass" --set-value="XnView"
    --set-key="Terminal" --set-value="false"
    --add-category="Viewer"
    --add-category="RasterGraphics"
    --add-category="2DGraphics"
    --add-category="Photography"
    --add-category="Qt"
    --add-mime-type="image/g3fax"
    --add-mime-type="image/pcx"
    --add-mime-type="image/svg+xml"
    --add-mime-type="image/x-compressed-xcf"
    --add-mime-type="image/x-fits"
    --add-mime-type="image/x-icon"
    --add-mime-type="image/x-portable-anymap"
    --add-mime-type="image/x-portable-bitmap"
    --add-mime-type="image/x-portable-graymap"
    --add-mime-type="image/x-portable-pixmap"
    --add-mime-type="image/x-psd"
    --add-mime-type="image/x-sgi"
    --add-mime-type="image/x-tga"
    --add-mime-type="image/x-wmf"
    --add-mime-type="image/x-xbitmap"
    --add-mime-type="image/x-xcf"
    --add-mime-type="image/x-xpixmap"
    --add-mime-type="image/x-xwindowdump"
    --remove-key="GenericName"
    "XnView/XnView.desktop";
    cat "XnViewMP-desktop.txt" >> "XnView/XnView.desktop";
    install -p -D -m 0644 "XnView/XnView.desktop" -t "${FLATPAK_DEST}/share/applications/";
post-install:
  - install -p -D -m 0644 "XnView"/*.txt -t "${FLATPAK_DEST}/share/doc/XnViewMP/";
  - install -p -D -m 0644 "XnView/license.txt" -t "${FLATPAK_DEST}/share/licenses/XnViewMP/";
