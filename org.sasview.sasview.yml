id: org.sasview.sasview
runtime: org.kde.Sdk
runtime-version: "6.7"
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.llvm15
base: com.riverbankcomputing.PyQt.BaseApp
base-version: 6.7
command: sasview
finish-args:
  - "--socket=fallback-x11"
  - "--share=ipc"
  - "--socket=wayland"
  - "--device=dri"
  - "--persist=."
build-options:
  append-path: /usr/lib/sdk/llvm15/bin
  append-ld-library-path: /usr/lib/sdk/llvm15/lib
modules:
  - name: hdf5
    buildsystem: autotools
    sources:
      - type: archive
        strip-components: 2
        url: https://support.hdfgroup.org/releases/hdf5/v1_14/v1_14_5/downloads/hdf5-1.14.5.tar.gz
        sha256: ec2e13c52e60f9a01491bb3158cb3778c985697131fc6a342262d32a26e58e44
  - name: qhull
    buildsystem: cmake-ninja
    config-opts:
      - "-DBUILD_STATIC_LIBS=OFF"
    sources:
      - type: archive
        url: https://github.com/qhull/qhull/archive/refs/tags/2020.2.tar.gz
        sha256: 59356b229b768e6e2b09a701448bfa222c37b797a84f87f864f97462d8dbc7c5
    cleanup:
      - "/bin"
      - "/share/man"
      - "/share/doc"
  - shared-modules/glu/glu-9.json
  - python3-requirements.json
  - name: pyside
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      cxxflags: -I/run/build/pyside/sources/shiboken6/libshiboken/signature -I/usr/include/python3.11
      cflags: -I/usr/include/python3.11
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_TESTS=OFF
      - -DCMAKE_SKIP_RPATH:BOOL=YES
      - -DFORCE_LIMITED_API=OFF
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://download.qt.io/official_releases/QtForPython/pyside6/PySide6-6.7.2-src/pyside-setup-everywhere-src-6.7.2.tar.xz
        sha256: 3a2b0d0d6e78c9aa5ddc7f06ca4b6f11a3fe14560baeb148eea53b5d98e368c7
      - type: shell
        commands:
          - cp -R /usr/include/Qt* sources/pyside6/PySide6/
    modules:
      # needed as the cmake super project doesn't find the shiboken python module
      - name: shiboken
        buildsystem: cmake-ninja
        builddir: true
        subdir: sources/shiboken6
        config-opts:
          - -DBUILD_TESTS=OFF
          - -DFORCE_LIMITED_API=OFF
        sources:
          - type: archive
            url: https://download.qt.io/official_releases/QtForPython/pyside6/PySide6-6.7.2-src/pyside-setup-everywhere-src-6.7.2.tar.xz
            sha256: 3a2b0d0d6e78c9aa5ddc7f06ca4b6f11a3fe14560baeb148eea53b5d98e368c7

  - name: sasview
    buildsystem: simple
    build-commands:
      - pip3 install  --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "." --global-option rebuild_ui --no-build-isolation
    post-install:
      - install -Dm0644 build_tools/application_metadata/org.sasview.sasview.metainfo.xml -t /app/share/metainfo/
      - install -Dm0644 build_tools/application_metadata/org.sasview.sasview.png -t /app/share/icons/hicolor/512x512/apps/
      - install -Dm0644 build_tools/application_metadata/org.sasview.sasview.desktop -t /app/share/applications/
    sources:
      - type: git
        url: https://github.com/SasView/sasview.git
        commit: 76030a6fa4a30266644ed57cc5a84983b42045da
      - type: file
        url: https://raw.githubusercontent.com/SasView/sasview/2e519c48373a4ebe3266225c5fccb3870f6403b2/build_tools/application_metadata/org.sasview.sasview.png
        sha256: fa4e310c68c88ad7f6ebdd4cf4b4e91fac1b729c71624fe6c971970640e5766d
