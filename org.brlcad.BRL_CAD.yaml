app-id: org.brlcad.BRL_CAD
runtime: org.kde.Sdk
runtime-version: 6.5
sdk: org.kde.Sdk
command: mged
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
cleanup:
  - /share/doc
  - /include
  - '*.la'
  - '*.a'

modules:
    # For OSL
  - name: Boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=${FLATPAK_DEST} --with-toolset=gcc --with-libraries=all
      - ./b2  variant=release -j $FLATPAK_BUILDER_N_JOBS install
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.81.0/source/boost_1_81_0.tar.bz2
        sha256: 71feeed900fbccca04a3b4f2f84a7c217186f28a940ed8b7ed4725986baf99fa
        x-checker-data:
          type: anitya
          project-id: 6845
          stable-only: true
          url-template: https://boostorg.jfrog.io/artifactory/main/release/$version/source/boost_${major}_${minor}_${patch}.tar.bz2
  #
  # - name: Imath
  #   buildsystem: cmake-ninja
  #   config-opts:
  #     - -DBUILD_TESTING:BOOL=OFF
  #   sources:
  #     - type: git
  #       url: https://github.com/AcademySoftwareFoundation/Imath.git
  #       tag: v3.1.9
  #       x-checker-data:
  #         type: git
  #         tag-pattern: ^(v[\d.]+)$
  #
  # - name: openEXR
  #   buildsystem: cmake-ninja
  #   config-opts:
  #     - -DBUILD_TESTING:BOOL=OFF
  #   sources:
  #     - type: git
  #       url: https://github.com/AcademySoftwareFoundation/openexr.git
  #       tag: v3.1.9
  #       commit: 45da397ca89527a5aa65d8d3aaf163aad58dfec9
  #       x-checker-data:
  #         type: git
  #         tag-pattern: ^(v[\d.]+)$
  #
  - name: TBB
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DTBB_TEST=OFF
    sources:
      - type: archive
        url: https://github.com/oneapi-src/oneTBB/archive/refs/tags/v2021.9.0.tar.gz
        sha256: 1ce48f34dada7837f510735ff1172f6e2c261b09460e3bf773b49791d247d24e
        x-checker-data:
          type: anitya
          project-id: 227581
          stable-only: true
          url-template: https://github.com/oneapi-src/oneTBB/archive/refs/tags/v$version.tar.gz
  #
  # - name: fmt
  #   buildsystem: cmake-ninja
  #   sources:
  #     - type: git
  #       url: https://github.com/fmtlib/fmt.git
  #       tag: 10.0.0
  #       x-checker-data:
  #         type: git
  #         tag-pattern: ^(v[\d.]+)$
  #
  # - name: robin-map
  #   buildsystem: cmake-ninja
  #   sources:
  #     - type: git
  #       url: https://github.com/Tessil/robin-map.git
  #       tag: v1.2.1
  #       x-checker-data:
  #         type: git
  #         tag-pattern: ^(v[\d.]+)$
  #
  # - name: pybind11
  #   buildsystem: simple
  #   build-commands:
  #     - python3 setup.py build
  #     - cmake -DPYBIND11_INSTALL=ON -DPYBIND11_TEST=OFF -DCMAKE_INSTALL_INCLUDEDIR:PATH=${FLATPAK_DEST}/include
  #       -DCMAKE_INSTALL_LIBDIR:PATH=${FLATPAK_DEST}/lib -DCMAKE_INSTALL_DATAROOTDIR:PATH=${FLATPAK_DEST}/share
  #       .
  #     - python3 setup.py install --prefix=${FLATPAK_DEST}
  #     - cmake --build .
  #     - cmake --install .
  #   sources:
  #     - type: archive
  #       url: https://github.com/pybind/pybind11/archive/v2.10.4.tar.gz
  #       sha256: 832e2f309c57da9c1e6d4542dedd34b24e4192ecb4d62f6f4866a737454c9970
  #       x-checker-data:
  #         type: anitya
  #         project-id: 13384
  #         stable-only: true
  #         url-template: https://github.com/pybind/pybind11/archive/v$version.tar.gz
  #
  # - shared-modules/glew/glew.json
  # - shared-modules/glu/glu-9.json
  #
  # - name: yaml-cpp
  #   buildsystem: cmake-ninja
  #   config-opts:
  #     - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  #     - -DBUILD_SHARED_LIBS=ON
  #     - -DYAML_BUILD_SHARED_LIBS=ON
  #     - -DYAML_CPP_BUILD_TOOLS=OFF
  #     - -DYAML_CPP_BUILD_TESTS=OFF
  #     - -DYAML_CPP_BUILD_CONTRIB=OFF
  #   sources:
  #     - type: archive
  #       url: https://github.com/jbeder/yaml-cpp/archive/refs/tags/yaml-cpp-0.7.0.tar.gz
  #       sha256: 43e6a9fcb146ad871515f0d0873947e5d497a1c9c60c58cb102a97b47208b7c3
  #       x-checker-data:
  #         type: anitya
  #         project-id: 5284
  #         stable-only: true
  #         url-template: https://github.com/jbeder/yaml-cpp/archive/refs/tags/yaml-cpp-$version.tar.gz
  #
  # - name: pystring
  #   buildsystem: cmake-ninja
  #   config-opts:
  #     - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  #   sources:
  #     - type: archive
  #       url: https://github.com/imageworks/pystring/archive/refs/tags/v1.1.4.tar.gz
  #       sha256: 49da0fe2a049340d3c45cce530df63a2278af936003642330287b68cefd788fb
  #     - type: file
  #       path: CMakeLists.txt
  #
  # - name: minizip-ng
  #   buildsystem: cmake-ninja
  #   builddir: true
  #   config-opts:
  #     - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  #     - -DBUILD_SHARED_LIBS=ON
  #   cleanup:
  #     - /bin
  #   sources:
  #     - type: archive
  #       url: https://github.com/zlib-ng/minizip-ng/archive/refs/tags/3.0.10.tar.gz
  #       sha256: d4a549731d8c7074e421dbab6d8b8ad0a93067752fe767c464f0f40fa5f0a80d
  #       x-checker-data:
  #         type: anitya
  #         project-id: 301509
  #         stable-only: true
  #         # versions:
  #         #   <: 4.0.0
  #         url-template: https://github.com/zlib-ng/minizip-ng/archive/refs/tags/$version.tar.gz
  #
  # - name: expat
  #   buildsystem: cmake-ninja
  #   config-opts:
  #     - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  #   cleanup:
  #     - /bin
  #   sources:
  #     - type: archive
  #       url: https://github.com/libexpat/libexpat/releases/download/R_2_5_0/expat-2.5.0.tar.gz
  #       sha256: 6b902ab103843592be5e99504f846ec109c1abb692e85347587f237a4ffa1033
  #       x-checker-data:
  #         type: anitya
  #         project-id: 770
  #         stable-only: true
  #         url-template: https://github.com/libexpat/libexpat/releases/download/R_${major}_${minor}_${patch}/expat-$version.tar.gz
  #
  # - name: opencolorio
  #   buildsystem: cmake-ninja
  #   builddir: true
  #   config-opts:
  #     - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  #     - -DOCIO_BUILD_NUKE=OFF
  #     - -DOCIO_BUILD_DOCS=OFF
  #     - -DOCIO_BUILD_TESTS=OFF
  #     - -DOCIO_BUILD_GPU_TESTS=OFF
  #     - -DOCIO_BUILD_PYTHON=OFF
  #     - -DOCIO_INSTALL_EXT_PACKAGES=NONE
  #     - -Dminizip-ng_LIBRARY=/app/lib/libminizip.so
  #   cleanup:
  #     - /bin
  #   sources:
  #     - type: archive
  #       url: https://github.com/AcademySoftwareFoundation/OpenColorIO/archive/refs/tags/v2.2.1.tar.gz
  #       sha256: 36f27c5887fc4e5c241805c29b8b8e68725aa05520bcaa7c7ec84c0422b8580e

  - name: blosc
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: git
        url: https://github.com/Blosc/c-blosc.git
        tag: v1.21.4
        x-checker-data:
          type: git
          tag-pattern: ^(v[\d.]+)$

  - name: openvdb
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: git
        url: https://github.com/AcademySoftwareFoundation/openvdb.git
        tag: v10.0.1
        x-checker-data:
          type: git
          tag-pattern: ^(v[\d.]+)$

  - name: BRL-CAD
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      cflags: -Wno-error=stringop-overflow -Wno-error=format-truncation -Wno-error=inline
        -Wno-error=format-overflow -Wno-error=dangling-pointer -Wno-error=array-bounds -Wno-error=nonnull -Wno-error=maybe-uninitialized -Wno-error=alloc-size-larger-than=
      cxxflags: -Wno-error=stringop-overflow -Wno-error=format-truncation -Wno-error=inline
        -Wno-error=format-overflow -Wno-error=dangling-pointer -Wno-error=array-bounds -Wno-error=nonnull -Wno-error=maybe-uninitialized -Wno-error=alloc-size-larger-than=
    config-opts:
      - -DBRLCAD_BUNDLED_LIBS=ON
      - -DBUILD_STATIC_LIBS:BOOL=OFF
      - -DBRLCAD_EXTRADOCS:BOOL=OFF
      - -DBUILD_TESTING:BOOL=OFF
      - -DBRLCAD_OPTIMIZED:BOOL=ON
      - -DBRLCAD_ENABLE_QT:BOOL=ON
      - -DBRLCAD_ENABLE_OPENVDB:BOOL=ON
    post-install:
      - install -Dm0644 ../${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm0644 ../misc/debian/mged.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm0644 ../misc/debian/rtwizard.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.rtwizard.desktop
      - install -Dm0644 ../misc/debian/archer.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.archer.desktop
      - install -Dm0644 ../misc/debian/brlcad-db.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-db.desktop

      - install -Dm0644 ../misc/debian/icons/256x256/mged.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png
      - install -Dm0644 ../misc/debian/icons/256x256/rtwizard.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.rtwizard.png
      - install -Dm0644 ../misc/debian/icons/256x256/brlcad-db.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.brlcad-db.png
      - install -Dm0644 ../misc/debian/icons/256x256/archer.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.archer.png

      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop # Replace "BRL-CAD" category
      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.rtwizard.desktop
      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-db.desktop
      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.archer.desktop

      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop # Rename icon
      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}.rtwizard" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.rtwizard.desktop
      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}.brlcad-db" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-db.desktop
      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}.archer" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.archer.desktop

      - desktop-file-edit --set-key=Exec --set-value="xdg-open /app/share/db" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-db.desktop
    sources:
      - type: git
        url: https://github.com/BRL-CAD/brlcad.git
        commit: dc7c0b221cd74c13a3a4a6c74c679bf91cc8da42
        tag: rel-7-34-2
        x-checker-data:
          type: git
          tag-pattern: ^rel-([\d-]+)$
      - type: file
        path: org.brlcad.BRL_CAD.metainfo.xml
