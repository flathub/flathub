app-id: org.brlcad.BRL_CAD
runtime: org.kde.Sdk
runtime-version: 6.5
sdk: org.kde.Sdk
command: mged
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
cleanup:
  - /include
  - '*.la'
  - '*.a'

modules:
  - name: BRL-CAD
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      cflags: -Wno-error=stringop-overflow -Wno-error=format-truncation -Wno-error=inline
        -Wno-error=format-overflow -Wno-error=dangling-pointer -Wno-error=array-bounds -Wno-error=nonnull -Wno-error=maybe-uninitialized -Wno-error=alloc-size-larger-than=
      cxxflags: -Wno-error=stringop-overflow -Wno-error=format-truncation -Wno-error=inline
        -Wno-error=format-overflow -Wno-error=dangling-pointer -Wno-error=array-bounds -Wno-error=nonnull -Wno-error=maybe-uninitialized -Wno-error=alloc-size-larger-than=
    config-opts:
      - -DBRLCAD_BUNDLED_LIBS=ON
      - -DBUILD_STATIC_LIBS:BOOL=OFF
      - -DBRLCAD_EXTRADOCS:BOOL=ON
      - -DBUILD_TESTING:BOOL=OFF
      - -DBRLCAD_OPTIMIZED:BOOL=ON
      - -DBRLCAD_ENABLE_QT:BOOL=ON
    post-install:
      - install -Dm0644 ../${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm0644 ../misc/debian/mged.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm0644 ../misc/debian/rtwizard.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.rtwizard.desktop
      - install -Dm0644 ../misc/debian/archer.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.archer.desktop
      - install -Dm0644 ../misc/debian/brlcad-db.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-db.desktop
      - install -Dm0644 ../misc/debian/brlcad-doc-mged.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-doc-mged.desktop
      - install -Dm0644 ../misc/debian/brlcad-doc.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-doc.desktop

      - install -Dm0644 ../misc/debian/icons/256x256/mged.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png
      - install -Dm0644 ../misc/debian/icons/256x256/rtwizard.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.rtwizard.png
      - install -Dm0644 ../misc/debian/icons/256x256/brlcad-db.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.brlcad-db.png
      - install -Dm0644 ../misc/debian/icons/256x256/archer.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.archer.png
      - install -Dm0644 ../misc/debian/icons/256x256/brlcad-doc.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.brlcad-doc.png

      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop # Replace "BRL-CAD" category
      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.rtwizard.desktop
      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-db.desktop
      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.archer.desktop
      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-doc-mged.desktop
      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-doc.desktop

      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop # Rename icon
      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}.rtwizard" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.rtwizard.desktop
      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}.brlcad-db" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-db.desktop
      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}.archer" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.archer.desktop
      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}.brlcad-doc" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-doc-mged.desktop
      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}.brlcad-doc" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-doc.desktop

      - desktop-file-edit --set-key=Exec --set-value="xdg-open /app/share/db" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-db.desktop
      - desktop-file-edit --set-key=Exec --set-value="xdg-open /app/share/doc/html/manuals/mged/index.html" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-doc-mged.desktop
      - desktop-file-edit --set-key=Exec --set-value="xdg-open /app/share/doc/html/toc.html" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-doc.desktop
    sources:
      - type: git
        url: https://github.com/BRL-CAD/brlcad.git
        commit: dc7c0b221cd74c13a3a4a6c74c679bf91cc8da42
        tag: rel-7-34-2
        x-checker-data:
          type: git
          tag-pattern: ^rel-([\d-]+)$
      - type: file
        path: org.brlcad.BRL_CAD.metainfo.xml
