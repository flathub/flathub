app-id: org.brlcad.BRL_CAD
runtime: org.kde.Sdk
runtime-version: 6.5
sdk: org.kde.Sdk
command: mged
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
cleanup:
  - /share/doc
  - /include
  - '*.la'
  - '*.a'

modules:
  - name: Boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=${FLATPAK_DEST} --with-toolset=gcc --with-libraries=all
      - ./b2  variant=release -j $FLATPAK_BUILDER_N_JOBS install
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.81.0/source/boost_1_81_0.tar.bz2
        sha256: 71feeed900fbccca04a3b4f2f84a7c217186f28a940ed8b7ed4725986baf99fa
        x-checker-data:
          type: anitya
          project-id: 6845
          stable-only: true
          url-template: https://boostorg.jfrog.io/artifactory/main/release/$version/source/boost_${major}_${minor}_${patch}.tar.bz2

  - name: TBB
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DTBB_TEST=OFF
    sources:
      - type: archive
        url: https://github.com/oneapi-src/oneTBB/archive/refs/tags/v2021.9.0.tar.gz
        sha256: 1ce48f34dada7837f510735ff1172f6e2c261b09460e3bf773b49791d247d24e
        x-checker-data:
          type: anitya
          project-id: 227581
          stable-only: true
          url-template: https://github.com/oneapi-src/oneTBB/archive/refs/tags/v$version.tar.gz

  - name: blosc
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: git
        url: https://github.com/Blosc/c-blosc.git
        tag: v1.21.4
        x-checker-data:
          type: git
          tag-pattern: ^(v[\d.]+)$

  - name: openvdb
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: git
        url: https://github.com/AcademySoftwareFoundation/openvdb.git
        tag: v10.0.1
        x-checker-data:
          type: git
          tag-pattern: ^(v[\d.]+)$

  - name: BRL-CAD
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      cflags: -Wno-error=stringop-overflow -Wno-error=format-truncation -Wno-error=inline
        -Wno-error=format-overflow -Wno-error=dangling-pointer -Wno-error=array-bounds -Wno-error=nonnull -Wno-error=maybe-uninitialized -Wno-error=alloc-size-larger-than=
      cxxflags: -Wno-error=stringop-overflow -Wno-error=format-truncation -Wno-error=inline
        -Wno-error=format-overflow -Wno-error=dangling-pointer -Wno-error=array-bounds -Wno-error=nonnull -Wno-error=maybe-uninitialized -Wno-error=alloc-size-larger-than=
    config-opts:
      - -DBRLCAD_BUNDLED_LIBS=ON
      - -DBUILD_STATIC_LIBS:BOOL=OFF
      - -DBRLCAD_EXTRADOCS:BOOL=OFF
      - -DBUILD_TESTING:BOOL=OFF
      - -DBRLCAD_OPTIMIZED:BOOL=ON
      - -DBRLCAD_ENABLE_QT:BOOL=ON
      - -DBRLCAD_ENABLE_OPENVDB:BOOL=ON
      - -DOpenVDB_INCLUDE_DIR=/app/include
      - -DOpenVDB_LIB_COMPONENTS=/app/lib
    post-install:
      - install -Dm0644 ../${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm0644 ../misc/debian/mged.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm0644 ../misc/debian/rtwizard.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.rtwizard.desktop
      - install -Dm0644 ../misc/debian/archer.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.archer.desktop
      - install -Dm0644 ../misc/debian/brlcad-db.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-db.desktop

      - install -Dm0644 ../misc/debian/icons/256x256/mged.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png
      - install -Dm0644 ../misc/debian/icons/256x256/rtwizard.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.rtwizard.png
      - install -Dm0644 ../misc/debian/icons/256x256/brlcad-db.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.brlcad-db.png
      - install -Dm0644 ../misc/debian/icons/256x256/archer.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.archer.png

      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop # Replace "BRL-CAD" category
      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.rtwizard.desktop
      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-db.desktop
      - desktop-file-edit --set-key=Categories --set-value="Graphics;Science;Education;Engineering;" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.archer.desktop

      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop # Rename icon
      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}.rtwizard" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.rtwizard.desktop
      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}.brlcad-db" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-db.desktop
      - desktop-file-edit --set-key=Icon --set-value="${FLATPAK_ID}.archer" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.archer.desktop

      - desktop-file-edit --set-key=Exec --set-value="xdg-open /app/share/db" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.brlcad-db.desktop
    sources:
      - type: git
        url: https://github.com/BRL-CAD/brlcad.git
        commit: dc7c0b221cd74c13a3a4a6c74c679bf91cc8da42
        tag: rel-7-34-2
        x-checker-data:
          type: git
          tag-pattern: ^rel-([\d-]+)$
      - type: file
        path: org.brlcad.BRL_CAD.metainfo.xml
