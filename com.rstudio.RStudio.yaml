app-id: com.rstudio.RStudio
runtime: org.kde.Sdk
runtime-version: '5.15-21.08'
#runtime-version: '5.15-21.08'does not work, no clue
sdk: org.kde.Sdk
base: io.qt.qtwebengine.BaseApp
base-version: '5.15-21.08'
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk11
  - org.freedesktop.Sdk.Extension.llvm12
  - org.freedesktop.Sdk.Extension.node16
# openjdk17 does not work, no clue why
command: rstudio
rename-icon: rstudio
rename-desktop-file: rstudio.desktop
finish-args:
  - --socket=x11
  - --share=ipc
  - --share=network
  - --filesystem=home
  - --talk-name=org.gnome.SessionManager
  - --device=dri
  - --env=PATH=/app/jre/bin:/usr/bin:/app/bin:/app/bin/x86_64-linux:/app/bin/aarch64-linux:/usr/lib/sdk/node14/bin
  - --env=QTWEBENGINE_DISABLE_SANDBOX=1
  - --env=QT_QPA_PLATFORM=xcb
build-options:
  append_path: /usr/lib/sdk/node16/bin
  cflags: -O2 -g
  cxxflags: -O2 -g
  env:
    PATH: $PATH:/usr/bin:/app/bin:/usr/lib/sdk/openjdk11/bin
    npm_config_nodedir: /usr/lib/sdk/node14
    npm_config_offline: true
    NPM_CONFIG_LOGLEVEL: info
cleanup:
  #- /include

modules:
  - name: Boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app
      - ./b2 install --build-type=complete link=shared --layout=versioned runtime-link=shared
        cxxflags="$CXXFLAGS" linkflags="$LDFLAGS" -j $FLATPAK_BUILDER_N_JOBS
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.78.0/source/boost_1_78_0.tar.bz2
        sha256: 8681f175d4bdb26c52222665793eef08490d7758529330f98d3b29dd0735bccc
        x-checker-data:
          type: anitya
          project-id: 6845
          stable-only: true
          url-template: https://boostorg.jfrog.io/artifactory/main/release/$version/source/boost_${major}_${minor}_${patch}.tar.bz2

  - name: R
    buildsystem: autotools
    config-opts:
      - --enable-R-shlib
      #- LIBnn=/lib
    cleanup:
      - '/lib/R/doc'
    sources:
      - type: archive
        url: https://cloud.r-project.org/src/base/R-4/R-4.1.3.tar.gz
        sha256: 15ff5b333c61094060b2a52e9c1d8ec55cc42dd029e39ca22abdaa909526fed6
        x-checker-data:
          type: anitya
          project-id: 4150
          stable-only: true
          url-template: https://cloud.r-project.org/src/base/R-4/R-$version.tar.gz

  #- name: test
    #cleanup:
      #- '*'
    #buildsystem: simple
    #build-commands:
      #- fsdfkdshf

  - name: ant
    cleanup:
      - '*'
    buildsystem: simple
    build-commands:
      - mv ./bin/* /app/bin/
      - mkdir -p /app/etc
      - mv ./etc/* /app/etc/
      - mv ./lib/* /app/lib/
    sources:
      - type: archive
        url: https://downloads.apache.org/ant/binaries/apache-ant-1.10.12-bin.tar.bz2
        sha256: 276ea73f267a5b1a58f02e2eb5ef594a9b2885e33afb05ef995251d4d18377a6
        x-checker-data:
          type: anitya
          project-id: 50
          stable-only: true
          url-template: https://downloads.apache.org/ant/binaries/apache-ant-$version-bin.tar.bz2

#RStudio use this specific version
  - name: yaml-cpp
    buildsystem: cmake
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DYAML_BUILD_SHARED_LIBS=ON
      - -DYAML_CPP_BUILD_TOOLS=OFF
      - -DYAML_CPP_BUILD_TESTS=OFF
      - -DYAML_CPP_BUILD_CONTRIB=OFF
    sources:
      - type: archive
        url: https://github.com/jbeder/yaml-cpp/archive/refs/tags/yaml-cpp-0.6.3.tar.gz
        sha256: 77ea1b90b3718aa0c324207cb29418f5bced2354c2e483a9523d98c3460af1ed

  #- name: sqlite
    #buildsystem: simple
    #build-commands:
       #- ./configure --prefix=/app --enable-fts5 --enable-fts3 --enable-rtree
       #- make
       #- make install
    #sources:
      #- type: archive
        #url: https://www.sqlite.org/2021/sqlite-autoconf-3360000.tar.gz
        #sha256: bd90c3eb96bee996206b83be7065c9ce19aef38c3f4fb53073ada0d0b69bbce3

  - name: postgresql
    config-opts:
      - --disable-rpath
      - --with-openssl
    sources:
      - type: archive
        url: https://ftp.postgresql.org/pub/source/v12.2/postgresql-12.2.tar.bz2
        sha256: ad1dcc4c4fc500786b745635a9e1eba950195ce20b8913f50345bb7d5369b5de
        x-checker-data:
          type: anitya
          project-id: 5601
          stable-only: true
          url-template: https://ftp.postgresql.org/pub/source/v$major.$minor/postgresql-$major.$minor.tar.bz2

  - name: SOCI
    buildsystem: cmake
    config-opts:
      - -DWITH_BOOST=ON
      - -DWITH_EMPTY=ON
      - -DWITH_SQLITE3=ON
      - -DWITH_POSTGRESQL=ON
      - -DWITH_MYSQL=ON
      - -DWITH_ODBC=ON
      - -DWITH_FIREBIRD=OFF
      - -DWITH_DB2=OFF
      - -DWITH_ORACLE=OFF
      - -DSOCI_CXX11=ON
      - -DSOCI_STATIC=OFF
      - -DSOCI_TESTS=OFF
    sources:
      - type: git
        url: https://github.com/SOCI/soci.git
        tag: v4.0.2
        x-checker-data:
          type: git
          tag-pattern: ^(v[\d.]+)$

  - name: rapidjson
    buildsystem: cmake-ninja
    config-opts:
      - -DRAPIDJSON_BUILD_DOC=OFF
      - -DRAPIDJSON_BUILD_EXAMPLES=OFF
      - -DRAPIDJSON_BUILD_TESTS=OFF
      - -DRAPIDJSON_BUILD_THIRDPARTY_GTEST=OFF
    sources:
      - type: archive
        url: https://github.com/miloyip/rapidjson/archive/v1.1.0.tar.gz
        sha256: bf7ced29704a1e696fbccf2a2b4ea068e7774fa37f6d7dd4039d0787f8bed98e
        x-checker-data:
          type: git
          tag-pattern: ^(v[\d.]+)$

  - name: node
    buildsystem: simple
    build-options:
      prepend-path: /usr/lib/sdk/node16/bin
    build-commands:
      - ls -l /usr/lib/sdk/node16
      - /usr/lib/sdk/node16/install.sh
      - ls -l /usr/bin
      - whereis node
      #- jvjvhjjjhvjh

  - name: pandoc-arm64
    cleanup:
      - '*.a'
    only-arches:
      - aarch64
    buildsystem: simple
    build-commands:
      - mv -v bin/pandoc /app/bin/pandoc
    sources:
      - type: archive
        url: https://github.com/jgm/pandoc/releases/download/2.13/pandoc-2.13-linux-arm64.tar.gz
        sha256: 4f87bfe8a0a626ad0e17d26d42e99a1c0ed7d369cca00366c1b3d97525f57db5

  - name: RStudio
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DRSTUDIO_USE_SYSTEM_YAML_CPP=Yes
      - -DRSTUDIO_USE_SYSTEM_BOOST=Yes
      - -DRSTUDIO_USE_SYSTEM_SOCI=Yes
      - -DRSTUDIO_TARGET=Desktop
      - -DRSTUDIO_DESKTOP=TRUE
      - -DQT_QMAKE_EXECUTABLE=/usr/bin/qmake
      - -DSOCI_CORE_LIB=/app/lib/libsoci_core.so
      - -DSOCI_SQLITE_LIB=/app/lib/libsoci_sqlite3.so
      - -DSOCI_POSTGRESQL_LIB=/app/lib/libsoci_postgresql.so
      - -DRSTUDIO_INSTALL_FREEDESKTOP=Yes
      - -DRSTUDIO_BUNDLE_QT=FALSE
    build-options:
      cflags: -O2 -Wall -D_FORTIFY_SOURCE=2 -fstack-protector-strong -funwind-tables -fasynchronous-unwind-tables -fstack-clash-protection -Werror=return-type -g -DNDEBUG
      cxxflags: -O2 -Wall -D_FORTIFY_SOURCE=2 -fstack-protector-strong -funwind-tables -fasynchronous-unwind-tables -fstack-clash-protection -Werror=return-type -g -DNDEBUG
      env:
        ANT_HOME: /app
        JAVA_HOME: /usr/lib/sdk/openjdk11/
      npm_config_nodedir: /usr/lib/sdk/node16
      append-path: $JAVA_HOME/bin:/usr/bin:/usr/lib/sdk/node16/bin
      append-ld-library-path: /usr/lib/x86_64-linux-gnu:/usr/lib/aarch64-linux-gnu
      prepend-path: /usr/lib/sdk/llvm12/bin:/usr/lib/node_modules/npm/bin/
    cleanup:
      - share/icons/hicolor/*/mimetypes
      - share/mime
    sources:
      - type: archive
        url: https://github.com/rstudio/rstudio/archive/refs/tags/v2022.02.1+461.tar.gz
        sha256: 41e48e21ddc0a9c1ebf06ff16d846b0389720f2ee66d3fcfd5ff0707578b597d
      - type: archive
        url: https://s3.amazonaws.com/rstudio-buildtools/dictionaries/core-dictionaries.zip
        sha256: 4341a9630efb9dcf7f215c324136407f3b3d6003e1c96f2e5e1f9f14d5787494
        dest: dependencies/common/dictionaries
      - type: archive
        url: https://s3.amazonaws.com/rstudio-buildtools/mathjax-27.zip
        sha256: c56cbaa6c4ce03c1fcbaeb2b5ea3c312d2fb7626a360254770cbcb88fb204176
        dest: dependencies/common/mathjax-26
      - type: archive
        only-arches:
          - x86_64
        url: https://s3.amazonaws.com/rstudio-buildtools/pandoc/2.16.2/pandoc-2.16.2-linux-amd64.tar.gz
        sha256: f053aa621130383c9166db3a3a09fa5de95090e165711011607f84b285609bd1
        dest: dependencies/common/pandoc
      - type: archive
        only-arches:
          - aarch64
        url: https://github.com/jgm/pandoc/releases/download/2.16.2/pandoc-2.16.2-linux-arm64.tar.gz
        sha256: ec5eb2ebfc067f90cc4c86624f57505cfe2f8a2b882010f496a1abd1743a4672
        dest: dependencies/common/pandoc
      - type: patch
        path: 0000-unbundle-dependencies-common.patch
      #- type: patch
        #path: 0001-unbundle-qtsingleapplication.patch
      - type: patch
        path: 0002-fix-rstudio-exec-path.patch
      - type: patch
        path: 0003-fix-resources-path.patch
      - type: patch
        path: 0004-use-system-node.patch
      - type: patch
        path: 0005-disable-quarto.patch
      - type: patch
        path: install-desktop-icon-dest.patch
      #- type: patch
        #path: node.patch
      - type: file
        path: com.rstudio.RStudio.metainfo.xml

  #- name: RStudio
    #buildsystem: simple
    #build-commands:
      #- install -Dm644 ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      #- sed -i 's@gwt_build ALL@gwt_build@g' src/gwt/CMakeLists.txt
      #- mkdir build
      #- cd build && cmake -DCMAKE_BUILD_TYPE=Release -DRSTUDIO_USE_SYSTEM_YAML_CPP=Yes -DRSTUDIO_USE_SYSTEM_BOOST=Yes -DRSTUDIO_USE_SYSTEM_SOCI=Yes -DCMAKE_INSTALL_PREFIX=/app -DRSTUDIO_TARGET=Desktop -DRSTUDIO_DESKTOP=TRUE -DQT_QMAKE_EXECUTABLE=/usr/bin/qmake -DSOCI_CORE_LIB=/app/lib/libsoci_core.so -DSOCI_SQLITE_LIB=/app/lib/libsoci_sqlite3.so -DSOCI_POSTGRESQL_LIB=/app/lib/libsoci_postgresql.so -DRSTUDIO_INSTALL_FREEDESKTOP=Yes -DRSTUDIO_BUNDLE_QT=FALSE ..
      #- cd build && cmake -B build .
      #- make -C build
      #- make -C build gwt_build
      #- make install -C build
    #build-options:
      #env:
        #ANT_HOME: /app
        #JAVA_HOME: /usr/lib/sdk/openjdk11/
      #npm_config_nodedir: /usr/lib/sdk/node16
      #append-path: $JAVA_HOME/bin:/usr/bin:/usr/lib/sdk/node16/bin
      #append-ld-library-path: /usr/lib/x86_64-linux-gnu:/usr/lib/aarch64-linux-gnu
      #prepend-path: /usr/lib/sdk/llvm12/bin:/usr/lib/node_modules/npm/bin/
    #cleanup:
      #- share/icons/hicolor/*/mimetypes
      #- share/mime
    #sources:
      #- type: archive
        #url: https://github.com/rstudio/rstudio/archive/refs/tags/v2022.02.1+461.tar.gz
        #sha256: 41e48e21ddc0a9c1ebf06ff16d846b0389720f2ee66d3fcfd5ff0707578b597d
      #- type: archive
        #url: https://s3.amazonaws.com/rstudio-buildtools/dictionaries/core-dictionaries.zip
        #sha256: 4341a9630efb9dcf7f215c324136407f3b3d6003e1c96f2e5e1f9f14d5787494
        #dest: dependencies/common/dictionaries
      #- type: archive
        #url: https://s3.amazonaws.com/rstudio-buildtools/mathjax-27.zip
        #sha256: c56cbaa6c4ce03c1fcbaeb2b5ea3c312d2fb7626a360254770cbcb88fb204176
        #dest: dependencies/common/mathjax-26
      #- type: archive
        #only-arches:
          #- x86_64
        #url: https://s3.amazonaws.com/rstudio-buildtools/pandoc/2.16.2/pandoc-2.16.2-linux-amd64.tar.gz
        #sha256: f053aa621130383c9166db3a3a09fa5de95090e165711011607f84b285609bd1
        #dest: dependencies/common/pandoc
      #- type: archive
        #only-arches:
          #- aarch64
        #url: https://github.com/jgm/pandoc/releases/download/2.16.2/pandoc-2.16.2-linux-arm64.tar.gz
        #sha256: ec5eb2ebfc067f90cc4c86624f57505cfe2f8a2b882010f496a1abd1743a4672
        #dest: dependencies/common/pandoc
      #- type: patch
        #path: 0000-unbundle-dependencies-common.patch
      ##- type: patch
        ##path: 0001-unbundle-qtsingleapplication.patch
      #- type: patch
        #path: 0002-fix-rstudio-exec-path.patch
      #- type: patch
        #path: 0003-fix-resources-path.patch
      #- type: patch
        #path: 0004-use-system-node.patch
      #- type: patch
        #path: 0005-disable-quarto.patch
      #- type: patch
        #path: install-desktop-icon-dest.patch
      ##- type: patch
        ##path: node.patch
      #- type: file
        #path: com.rstudio.RStudio.metainfo.xml

  #- name: RStudio
    #buildsystem: simple
    #build-commands:
      #- install -Dm644 ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      #- sed -i 's@gwt_build ALL@gwt_build@g' src/gwt/CMakeLists.txt
      #- mkdir build
      #- cd build && cmake -DRSTUDIO_USE_SYSTEM_YAML_CPP=Yes -DRSTUDIO_USE_SYSTEM_BOOST=Yes  -DRSTUDIO_TARGET=Desktop -DRSTUDIO_USE_SYSTEM_SOCI=Yes -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/app -DYAML_CPP_INCLUDE_DIR=/app/include-DBoost_INCLUDE_DIR=/app/include -DBOOST_ROOT=/app -DQT_QMAKE_EXECUTABLE=/usr/bin/qmake -DSOCI_CORE_LIB=/app/lib/libsoci_core.so -DSOCI_SQLITE_LIB=/app/lib/libsoci_sqlite3.so -DSOCI_POSTGRESQL_LIB=/app/lib/libsoci_postgresql.so -DRSTUDIO_INSTALL_FREEDESKTOP=Yes ..
      #- cd build && cmake -B build .
      #- make -C build
      #- make -C build gwt_build
      #- make install -C build
      #- desktop-file-edit --set-key="Exec" --set-value="rstudio %F" "${FLATPAK_DEST}/share/applications/rstudio.desktop"
    #build-options:
      #env:
        #ANT_HOME: /app
        #JAVA_HOME: /usr/lib/sdk/openjdk11/
      #npm_config_nodedir: /usr/lib/sdk/node14
      #append-path: $JAVA_HOME/bin:/usr/bin:/usr/lib/sdk/node14/bin
      #append-ld-library-path: /usr/lib/x86_64-linux-gnu:/usr/lib/aarch64-linux-gnu
      #prepend-path: /usr/lib/sdk/llvm12/bin:/usr/lib/node_modules/npm/bin/
    #cleanup:
      #- share/icons/hicolor/*/mimetypes
      #- share/mime
    #sources:
      #- type: git
        #url: https://github.com/rstudio/rstudio
        #tag: v2022.02.1+461
      #- type: archive
        #url: https://s3.amazonaws.com/rstudio-buildtools/dictionaries/core-dictionaries.zip
        #sha256: 4341a9630efb9dcf7f215c324136407f3b3d6003e1c96f2e5e1f9f14d5787494
        #dest: dependencies/common/dictionaries
      #- type: archive
        #url: https://s3.amazonaws.com/rstudio-buildtools/mathjax-27.zip
        #sha256: c56cbaa6c4ce03c1fcbaeb2b5ea3c312d2fb7626a360254770cbcb88fb204176
        #dest: dependencies/common/mathjax-26
      #- type: archive
        #only-arches:
          #- x86_64
        #url: https://s3.amazonaws.com/rstudio-buildtools/pandoc/2.16.2/pandoc-2.16.2-linux-amd64.tar.gz
        #sha256: 1a0548b15255b1c11722f3d4e12fc7a652edf8c9a329a8458f1e765517aec1be
        #dest: dependencies/common/pandoc
      #- type: archive
        #only-arches:
          #- aarch64
        #url: https://github.com/jgm/pandoc/releases/download/2.14.2/pandoc-2.14.2-linux-arm64.tar.gz
        #sha256: ec5eb2ebfc067f90cc4c86624f57505cfe2f8a2b882010f496a1abd1743a4672
        #dest: dependencies/common/pandoc
      #- type: patch
        #path: 0000-unbundle-dependencies-common.patch
      #- type: patch
        #path: 0001-unbundle-qtsingleapplication.patch
      #- type: patch
        #path: 0002-fix-rstudio-exec-path.patch
      #- type: patch
        #path: 0003-fix-resources-path.patch
      #- type: patch
        #path: 0004-use-system-node.patch
      #- type: patch
        #path: 0005-disable-quarto.patch
      #- type: patch
        #path: install-desktop-icon-dest.patch
      #- type: file
        #path: com.rstudio.RStudio.metainfo.xml

  #- plugins-dependencies.json
