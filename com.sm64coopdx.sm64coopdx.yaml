app-id: com.sm64coopdx.sm64coopdx
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: sm64coopdx

finish-args:
  # Wayland with fallback
  - --socket=wayland
  - --socket=fallback-x11
  # X11 performance fix
  - --share=ipc
  # Needed for online functionality
  - --share=network
  # Requirement for sound
  - --socket=pulseaudio
  # For controller support
  # Can't use `--device=input` until more widely adopted
  # See: https://docs.flatpak.org/en/latest/sandbox-permissions.html#device-access
  - --device=all
  # Discord SDK support
  - --filesystem=xdg-run/app/com.discordapp.Discord:create

modules:
  - name: sm64coopdx
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/coop-deluxe/sm64coopdx.git
        commit: ff31ae55fa3a81487545a439faa2c5bf332d3d77
        tag: v1.3.2  # Latest version
    build-commands:
      - make -j$FLATPAK_BUILDER_N_JOBS
      # Game executable
      - install -Dm755 build/us_pc/sm64coopdx ${FLATPAK_DEST}/bin/sm64coopdx
      # Discord SDK
      - install -Dm644 build/us_pc/libdiscord_game_sdk.so ${FLATPAK_DEST}/lib/libdiscord_game_sdk.so
      # Default assets not bundled in the executable
      - cp -r build/us_pc/dynos ${FLATPAK_DEST}/bin
      - cp -r build/us_pc/lang ${FLATPAK_DEST}/bin
      - cp -r build/us_pc/mods ${FLATPAK_DEST}/bin
      - cp -r build/us_pc/palettes ${FLATPAK_DEST}/bin

  - name: desktop-entry
    buildsystem: simple
    sources:
      - type: file
        path: entry.desktop
    build-commands:
      - install -Dm644 entry.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop

  - name: icon
    buildsystem: simple
    sources:
      - type: file
        path: icon.png
    build-commands:
      - install -Dm644 icon.png ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png

  - name: matainfo
    buildsystem: simple
    sources:
      - type: file
        path: metainfo.xml
    build-commands:
      - install -Dm644 metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}}.metainfo.xml