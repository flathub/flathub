app-id: org.alicevision.Meshroom
runtime: org.kde.Platform
runtime-version: "5.15"
sdk: org.kde.Sdk
command: meshroom
finish-args:
  - --share=ipc
  - --socket=x11

modules:
  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app
      - ./b2 install --prefix=/app link=shared runtime-link=shared cxxflags="$CXXFLAGS" linkflags="$LDFLAGS" -j $FLATPAK_BUILDER_N_JOBS
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.76.0/source/boost_1_76_0.tar.bz2
        sha256: f0397ba6e982c4450f27bf32a2a83292aba035b827a5623a14636ea583318c41

  - name: openexr
    buildsystem: cmake-ninja
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/AcademySoftwareFoundation/openexr/archive/v2.5.7.tar.gz
        sha256: 36ecb2290cba6fc92b2ec9357f8dc0e364b4f9a90d727bf9a57c84760695272d
    modules:
      - name: imath
        buildsystem: cmake-ninja
        config-opts:
          - -DPYTHON=ON
        sources:
          - type: archive
            url: https://github.com/AcademySoftwareFoundation/Imath/archive/v3.1.2/imath-3.1.2.tar.gz
            sha256: f21350efdcc763e23bffd4ded9bbf822e630c15ece6b0697e2fcb42737c08c2d

  - name: openimageio
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DUSE_PYTHON=ON
      - -DOIIO_BUILD_TESTS=OFF
      - -DOIIO_BUILD_TOOLS=ON
      - -DBUILD_MISSING_FMT=OFF
      - -DCMAKE_LIBRARY_PATH=/app/lib
      - -DSTOP_ON_WARNING=OFF
    build-options:
      env: 
        pybind11_DIR: /app/lib/python3.8/site-packages/pybind11/share/cmake
    cleanup:
      - /bin
      - /share/doc
    sources:
      - type: archive
        url: https://github.com/OpenImageIO/oiio/archive/v2.2.17.0.tar.gz
        sha256: b570da8928c3e8cde29bdb0e0320e727789e141c48375fb69a2548d642462396
    modules:
      - name: fmt
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/fmtlib/fmt/archive/8.0.1.tar.gz
            sha256: b06ca3130158c625848f3fb7418f235155a4d389b2abc3a6245fb01cb0eb1e01
            
      - name: robin-map
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/Tessil/robin-map/archive/v0.6.3.tar.gz
            sha512: 485557f300d33bda62bb8accdf246819ee8ffe956bc022e7ddca54ff6ad1a9fdb8db8d80690add3ef238e834d1eb8e2905920cb0a0674e7df010f6946d01297b

      - name: pybind11
        buildsystem: simple
        build-commands:
         - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "pybind11"
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/66/99/fc60e2287bb2309b8db4d0f080770ecc8d37dc64911e37b86698ec4b6a51/pybind11-2.7.1.tar.gz
            sha256: 8950aac5e5f4d505f7a0f067c5cb3893dcf098ff29cedfcb4ccf1e9e44d0bd9a
          - type: file
            url: https://files.pythonhosted.org/packages/db/e2/c0ced9ccffb61432305665c22842ea120c0f649eec47ecf2a45c596707c4/setuptools-57.4.0.tar.gz
            sha256: 6bac238ffdf24e8806c61440e755192470352850f3419a52f26ffe0a1a64f465
          - type: file
            url: https://files.pythonhosted.org/packages/ed/46/e298a50dde405e1c202e316fa6a3015ff9288423661d7ea5e8f22f589071/wheel-0.36.2.tar.gz
            sha256: e11eefd162658ea59a60a0f6c7d493a7190ea4b9a85e335b33489d9f17e0245e

  - name: eigen
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.3.9/eigen-3.3.9.tar.bz2
        sha256: 0fa5cafe78f66d2b501b43016858070d52ba47bd9b1016b0165a7b8e04675677
        x-checker-data:
          type: anitya
          project-id: 13751
          stable-only: true
          url-template: https://gitlab.com/libeigen/eigen/-/archive/$version/eigen-$version.tar.bz2
    # cleanup:
    #   - '*'

  - name: ceres-solver
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DEIGENSPARSE=ON
      - -DBUILD_TESTING=OFF
      - -DBUILD_EXAMPLES=OFF
      - -DBUILD_BENCHMARKS=OFF
    sources:
      - type: archive
        url: http://ceres-solver.org/ceres-solver-2.0.0.tar.gz
        sha256: 10298a1d75ca884aa0507d1abb0e0f04800a92871cd400d4c361b56a777a7603
    modules:
      - name: glog
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/google/glog/archive/v0.5.0.tar.gz
            sha512: 445e4338f3d81cd0b065f2da9c6ce343c243263ca144cea424ef97531a4e9e09c06ffd6942ac01c5213a8003c75cfbbede3c4028d12f0134f23ff29314769c1a
          - type: patch
            path: glog-0b3d4cb4.patch

      - name: openblas
        no-autogen: true
        make-args:
          - DYNAMIC_ARCH=1
          - DYNAMIC_OLDER=1
          - FC=gfortran
          - NO_CBLAS=1
          - NO_LAPACKE=1
          - TARGET=GENERIC
          - USE_OPENMP=0    ## OpenMP off by default, this hack skips 'test_fork' which crashes on i386
        make-install-args:
          - PREFIX=/app
        sources:
          - type: archive
            url: https://github.com/xianyi/OpenBLAS/archive/v0.3.17.tar.gz
            sha256: df2934fa33d04fd84d839ca698280df55c690c86a5a1133b3f7266fce1de279f
            x-checker-data:
              type: anitya
              project-id: 2540
              url-template: https://github.com/xianyi/OpenBLAS/archive/v$version.tar.gz

      - name: mpfr
        config-opts:
          - --enable-thread-safe
          - --enable-shared
        sources:
          - type: archive
            url: https://ftp.gnu.org/gnu/mpfr/mpfr-4.1.0.tar.xz
            sha512: 1bd1c349741a6529dfa53af4f0da8d49254b164ece8a46928cdb13a99460285622d57fe6f68cef19c6727b3f9daa25ddb3d7d65c201c8f387e421c7f7bee6273
          - type: patch
            path: mpfr-patches.diff

      - name: suitesparse
        make-args:
          - BLAS=-lopenblas
          - LAPACK=
          - library
        make-install-args:
          - BLAS=-lopenblas
          - LAPACK=
          - INSTALL_INCLUDE=/app/include/suitesparse
          - INSTALL_LIB=/app/lib
          - library
        no-autogen: true
        sources:
          - type: archive
            url: https://github.com/DrTimothyAldenDavis/SuiteSparse/archive/v5.10.1.tar.gz
            sha256: acb4d1045f48a237e70294b950153e48dce5b5f9ca8190e86c2b8c54ce00a7ee
            x-checker-data:
              type: anitya
              project-id: 4908
              url-template: https://github.com/DrTimothyAldenDavis/SuiteSparse/archive/v$version.tar.gz
          - type: patch
            path: suitesparse-no-demo.patch

  - name: alembic
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/alembic/alembic/archive/1.8.2.tar.gz
        sha512: 23fec3d51cfd8ac8bc02749550de53a7b699ebe67654336864a8208a6a1d4f69e8e1a2c8e07832665c203788cbabbb65f346582741bac10ceb0d56c16d6b4217

  - name: opengv
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_SHARED_LIBS=ON
      # - -DBUILD_PYTHON=ON
      - -DBUILD_POSITION_INDEPENDENT_CODE=ON
      # - -DINSTALL_OPENGV=ON
    sources:
      - type: git
        url: https://github.com/laurentkneip/opengv.git
        commit: 91f4b19c73450833a40e463ad3648aae80b3a7f3

  - shared-modules/glu/glu-9.json

  - name: geogram
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_SHARED_LIBS=ON 
      - -DGEOGRAM_LIB_ONLY=ON 
      - -DVORPALINE_PLATFORM=Linux64-gcc-dynamic
    sources:
      - type: git
        url: https://github.com/alicevision/geogram.git
        commit: 8b2ae6148c7ab1564fa2700673b4275296ce80d3
        tag: v1.7.6

  - name: ghostscript
    config-opts:
      - --enable-dynamic
      - --disable-cups
      - --disable-dbus
      - --disable-gtk
      # - --with-system-libtiff
      - --with-drivers=FILES
    build-options:
      arch:
        aarch64:
          cppflags: -DPNG_ARM_NEON_OPT=0
    sources:
      - type: archive
        url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9540/ghostscript-9.54.0.tar.xz
        sha256: c2b7b43cde600f4e70efb2cd95865f6d884a67315c3de235914697d8ccde6e3b

  # - name: cuda
  #   buildsystem: simple
  #   build-commands: 
  #     - chmod +x cuda_11.4.1_470.57.02_linux.run
  #     - ./cuda_11.4.1_470.57.02_linux.run --toolkit --installpath=/app/cuda --no-man-page --override --silent
  #   sources:
  #     - type: file
  #       url: https://developer.download.nvidia.com/compute/cuda/11.4.1/local_installers/cuda_11.4.1_470.57.02_linux.run
  #       md5: 0ceda24534455fa06d95f3dbd5125c94
        
  - name: alicevision
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DALICEVISION_BUILD_DOC=OFF
      - -DALICEVISION_BUILD_TESTS=OFF
      - -DALICEVISION_BUILD_EXAMPLES=OFF
      - -DALICEVISION_USE_ALEMBIC=OFF
      # - -DCUDA_TOOLKIT_ROOT_DIR=/app/cuda
      - -DALICEVISION_USE_CUDA=OFF
    sources:
      - type: git
        tag: v2.4.0
        commit: 38d899f54910f98164ccbbdf950750eb10ae8a65
        url: https://github.com/alicevision/AliceVision.git
      - type: shell
        commands: 
          - grep -lR "std::numeric_limits"|xargs sed -i '1 i\#include <limits>'

  - name: meshroom
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
      - install meshroom.sh /app/bin/meshroom
    sources:
      - type: git
        url: https://github.com/alicevision/meshroom.git
        commit: ad9f1e874af5a6da47d5bb947b018b509925ddf5
        tag: v2021.1.0
      - type: script
        dest-filename: meshroom.sh
        commands:
          - python app/bin/meshroom/ui "$@"
