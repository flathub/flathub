{
    "app-id": "com.dhsdevelopments.Climaxima",
    "runtime": "org.freedesktop.Platform",
    "runtime-version": "18.08",
    "sdk": "org.freedesktop.Sdk",
    "command": "clim-maxima",
    "modules": [
        {
            "name": "sbcl",
            "buildsystem": "simple",
            "sources": [
                {
                    "type": "archive",
                    "url": "http://prdownloads.sourceforge.net/sbcl/sbcl-1.5.3-x86-64-linux-binary.tar.bz2",
                    "sha256": "6fbd04e6fc81bc3b755372ba02410bc52466301b571337ff0a5f2b0ede6d76dc"
                }
            ],
            "build-options": {
                "env": {
                    "BUILD_ROOT": "/app/sbcl"
                }
            },
            "build-commands": [
                "sh install.sh"
            ]
        },
        {
            "name": "gnuplot",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://downloads.sourceforge.net/project/gnuplot/gnuplot/5.2.7/gnuplot-5.2.7.tar.gz",
                    "sha256": "97fe503ff3b2e356fe2ae32203fc7fd2cf9cef1f46b60fe46dc501a228b9f4ed"
                }
            ]
        },
        {
            "name": "mupdf",
            "buildsystem": "simple",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://mupdf.com/downloads/archive/mupdf-1.15.0-source.tar.xz",
                    "sha1": "dc5b40405b9a497e37370e26b2a8b115c944fe8a"
                }
            ],
            "build-commands": [
                "make HAVE_X11=no HAVE_GLUT=no prefix=/app/mupdf",
                "make HAVE_X11=no HAVE_GLUT=no prefix=/app/mupdf install"
            ]
        },
        {
            "name": "mcclim",
            "buildsystem": "simple",
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/McCLIM/McCLIM",
                    "commit": "e0dafe84596a156d410dbed1254d3a038442921b"
                },
                {
                    "type": "file",
                    "path": "quicklisp.lisp"
                },
                {
                    "type": "file",
                    "path": "sbclrc"
                }
            ],
            "build-options": {
                "env": {
                    "SBCL_HOME": "/app/sbcl/usr/local/lib/sbcl"
                },
                "build-args": [
                    "--share=network"
                ]
            },
            "build-commands": [
                "/app/sbcl/usr/local/bin/sbcl --load quicklisp.lisp --quit --eval '(quicklisp-quickstart:install :path \"/app/quicklisp/\")'",
                "mkdir /app/tools",
                "cp sbclrc /app/tools/sbcl-init.lisp",
                "cp -ar . /app/McCLIM",
                "ln -s /app/McCLIM /app/quicklisp/local-projects",
                "sed -i 's/\"libfontconfig\\.so\"/(:or \"libfontconfig\\.so\\.1\" \"libfontconfig\\.so\")/' /app/McCLIM/Extensions/fontconfig/src/functions.lisp",
                "sed -i 's/\"libharfbuzz\\.so\"/(:or \"libharfbuzz\\.so\\.0\" \"libharfbuzz\\.so\")/' /app/McCLIM/Extensions/harfbuzz/src/functions.lisp"
            ]
        },
        {
            "name": "cl-freetype2",
            "buildsystem": "simple",
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/lokedhs/cl-freetype2",
                    "commit": "fe9d8108154cb4f4e46622bcaea4ba6155a3b5af"
                }
            ],
            "build-commands": [
                "cp -ar . /app/cl-freetype2",
                "ln -s /app/cl-freetype2 /app/quicklisp/local-projects"
            ]
        },
        {
            "name": "maxima-code",
            "sources": [
                {
                    "type": "git",
                    "url": "https://git.code.sf.net/p/maxima/code",
                    "commit": "0721ffcd43de13fd288362373edc9681929abed9"
                }
            ],
            "build-options": {
                "env": {
                    "SBCL_HOME": "/app/sbcl/usr/local/lib/sbcl"
                }
            },
            "config-opts": [ "--enable-sbcl", "--with-sbcl=/app/sbcl/usr/local/bin/sbcl" ],
            "build-commands": [ "cp -ar . /app/maxima-code",
                                "ln -s /app/maxima-code /app/quicklisp/local-projects/maxima-code" ]
        },
        {
            "name": "climaxima",
            "buildsystem": "simple",
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/lokedhs/maxima-client",
                    "commit": "3c198d28f5b036a7b584387a2e2480869026a664"
                },
                { "type": "file", "path": "startup.lisp" },
                { "type": "file", "path": "build.sh" }
            ],
            "build-options": {
                "env": {
                    "SBCL_HOME": "/app/sbcl/usr/local/lib/sbcl"
                },
                "build-args": [
                    "--share=network"
                ]
            },
            "build-commands": [
                "cp -ar . /app/maxima-client-build",
                "ln -s /app/maxima-client-build /app/quicklisp/local-projects/maxima-client-build",
                "cd /app/maxima-client-build && sh build.sh",
                "mkdir /app/maxima-client",
                "cp /app/maxima-client-build/clim-maxima /app/maxima-client",
                "cp -ar /app/maxima-client-build/fonts /app/maxima-client-build/images /app/maxima-client",
                "mkdir /app/maxima-client/infoparser",
                "cp -ar /app/maxima-client-build/infoparser/docs /app/maxima-client-build/infoparser/figures /app/maxima-client/infoparser",
                "mkdir -p /app/bin",
                "ln -s /app/maxima-client/clim-maxima /app/bin/clim-maxima"
            ]
        },
        {
            "name": "desktop-integration",
            "buildsystem": "simple",
            "sources": [ { "type": "file", "path": "com.dhsdevelopments.Climaxima.appdata.xml" },
                         { "type": "file", "path": "com.dhsdevelopments.Climaxima.desktop" } ],
            "build-commands": [
                "mkdir -p /app/share/metainfo",
                "cp com.dhsdevelopments.Climaxima.appdata.xml /app/share/metainfo/com.dhsdevelopments.Climaxima.appdata.xml",
                "mkdir -p /app/share/applications",
                "cp com.dhsdevelopments.Climaxima.desktop /app/share/applications/com.dhsdevelopments.Climaxima.desktop"
            ]
        }
    ],
    "finish-args": [
        "--socket=x11",
        "--share=ipc",
        "--share=network"
    ],
    "cleanup-commands": [
        "rm -fr /app/mupdf",
        "rm -fr /app/McCLIM",
        "rm -fr /app/cl-freetype2",
        "rm -fr /app/quicklisp",
        "rm -fr /app/sbcl",
        "rm -fr /app/tools",
        "rm -fr /app/maxima-client-build"
    ]
}
