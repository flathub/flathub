{
  "app-id": "org.fundacionzt.undina",
  "runtime": "org.freedesktop.Platform",
  "runtime-version": "24.08",
  "sdk": "org.freedesktop.Sdk",

  "base": "org.godotengine.godot.BaseApp",
  "base-version": "4.4",
  "command": "godot-runner",

  "build-options": {
    "append-path": "/app/bin"
  },

  "finish-args": [
    "--share=ipc",
    "--socket=wayland",
    "--socket=fallback-x11",
    "--device=dri",
    "--socket=pulseaudio"
  ],

  "modules": [
    {
      "name": "scons-local",
      "buildsystem": "simple",
      "build-commands": [
        "mkdir -p /app/scons-local",
        "tar -xzf scons-local-4.9.1.tar.gz -C /app/scons-local",
        "printf '%s\\n' '#!/usr/bin/env bash' 'exec python3 /app/scons-local/scons.py \"$@\"' > /app/bin/scons",
        "chmod +x /app/bin/scons",
        "scons --version"
      ],
      "sources": [
        {
          "type": "file",
          "url": "https://prdownloads.sourceforge.net/scons/scons-local-4.9.1.tar.gz",
          "sha256": "5010a86dd03e395cff0b10ee4b6746fce9930d768c49a80ee83ffabfc6711e9a"
        }
      ]
    },

    {
      "name": "godot-editor",
      "buildsystem": "simple",
      "build-commands": [
        "scons -j${FLATPAK_BUILDER_N_JOBS} platform=linuxbsd target=editor production=yes",
        "scons -j${FLATPAK_BUILDER_N_JOBS} platform=linuxbsd target=template_debug production=yes",
        "install -Dm755 bin/godot.linuxbsd.editor.* /app/bin/godot-editor",
        "install -Dm755 bin/godot.linuxbsd.template_debug.* /app/bin/godot"
      ],
      "sources": [
        {
          "type": "archive",
          "url": "https://github.com/godotengine/godot/releases/download/4.4.1-stable/godot-4.4.1-stable.tar.xz",
          "sha256": "ddbd6527cdb3ddb02910b383301a5c9117b1c33c777ef1c86d1b1eea43dcb651"
        }
      ]
    },

    {
      "name": "undina",
      "buildsystem": "simple",
      "build-commands": [
        "mkdir -p build",
        "if [ ! -f export_presets.cfg ]; then cat > export_presets.cfg << 'EOF'\n[preset.0]\nname=\"Linux/X11\"\nplatform=\"Linux/X11\"\nrunnable=true\ncustom_features=\"\"\nexport_filter=\"all_resources\"\ninclude_filter=\"\"\nexclude_filter=\"\"\nexport_path=\"build/game.pck\"\nencryption_include_filters=\"\"\nencryption_exclude_filters=\"\"\nscript_encryption_key=\"\"\nEOF\nfi",
        "/app/bin/godot-editor --headless --path . --export-pack \"Linux/X11\" build/game.pck",
        "install -Dm644 build/game.pck /app/bin/game.pck",
        "printf '#!/bin/sh\\nexec /app/bin/godot --main-pack /app/bin/game.pck \"$@\"' > godot-runner",
        "install -Dm755 godot-runner /app/bin/godot-runner",
        "install -Dm644 org.fundacionzt.undina.desktop /app/share/applications/org.fundacionzt.undina.desktop",
        "install -Dm644 org.fundacionzt.undina.appdata.xml /app/share/metainfo/org.fundacionzt.undina.appdata.xml",
        "install -Dm644 org.fundacionzt.undina.png /app/share/icons/hicolor/256x256/apps/org.fundacionzt.undina.png"
      ],
      "sources": [
        {
          "type": "git",
          "url": "https://github.com/WERNSA/undina-game.git",
          "tag": "v1.0.0"
        },
        { "type": "file", "path": "org.fundacionzt.undina.desktop" },
        { "type": "file", "path": "org.fundacionzt.undina.appdata.xml" },
        { "type": "file", "path": "org.fundacionzt.undina.png" }
      ]
    }
  ]
}

