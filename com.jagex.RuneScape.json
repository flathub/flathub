{
    "app-id": "com.jagex.RuneScape",
    "runtime": "org.gnome.Platform",
    "runtime-version": "3.24",
    "sdk": "org.gnome.Sdk",
    "command": "runescape",
    "separate-locales": false,
    "tags": ["proprietary"],
    "finish-args": [
        /* X11 + XShm access */
        "--share=ipc", "--socket=x11",
        /* Sound access */
        "--socket=pulseaudio",
        /* Network access */
        "--share=network",
        /* OpenGL */
        "--device=dri",
        "--persist=Jagex",
        "--extra-data=runescape.deb:0265f6c12711e90299cb3793e9dab45a9de6194f7400d3c7c855c176f209b2b8:3014960::https://content.runescape.com/downloads/ubuntu/pool/non-free/r/runescape-launcher/runescape-launcher_2.2.4_amd64.deb"
    ],
    "build-options" : {
        "cflags": "-O2 -g",
        "cxxflags": "-O2 -g",
        "env": {
            "V": "1"
        }
    },
    "cleanup": [
        "*.a",
        "*.la",
        "/lib/libXmuu*",
        "/lib/libXmu.so",
        "/lib/libGLEW.so",
        "/lib/libpng.*"
    ],
    "modules": [
        {
            "name": "libpng",
            "config-opts": ["--disable-static"],
            "cleanup": ["/bin", "/include", "/lib/debug", "/lib/pkgconfig", "/share"],
            "sources": [
                {
                    /* Must be version 1.2 */
                    "type": "archive",
                    "url": "https://downloads.sourceforge.net/project/libpng/libpng12/1.2.56/libpng-1.2.56.tar.xz",
                    "sha256": "24ce54581468b937734a6ecc86f7e121bc46a90d76a0d948dca08f32ee000dbe"
                }
            ]
        },
        {
            /* Required to build glew 1.10 */
            "name": "libxmu",
            "cleanup": ["/include", "/lib/debug", "/lib/pkgconfig", "/share"],
            "sources": [
                {
                    /* Use latest version */
                    "type": "archive",
                    "url": "https://xorg.freedesktop.org/releases/individual/lib/libXmu-1.1.2.tar.bz2",
                    "sha256": "756edc7c383254eef8b4e1b733c3bf1dc061b523c9f9833ac7058378b8349d0b"
                }
            ]
        },
        {
            /* No textures will be displayed without this */
            "name": "s2tc",
            "config-opts": ["--disable-tools"],
            "cleanup": ["/include", "/lib/debug", "/lib/pkgconfig"],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/divVerent/s2tc.git",
                    "commit": "f6ec862d7594e29ae80a6e49f66ad4c76cf09abc"
                }
            ]
        },
        {
            "name": "glew",
            "no-autogen": true,
            "make-args": [
                "GLEW_PREFIX=/app",
                "GLEW_DEST=/app",
                "LIBDIR=/app/lib"
            ],
            "make-install-args": [
                "GLEW_PREFIX=/app",
                "GLEW_DEST=/app",
                "LIBDIR=/app/lib"
            ],
            "cleanup": ["/include", "/lib/debug", "/lib/pkgconfig"],
            "sources": [
                {
                    /* Must be version 1.10 */
                    "type": "archive",
                    "url": "https://downloads.sourceforge.net/project/glew/glew/1.10.0/glew-1.10.0.tgz",
                    "sha256": "99c41320b63f6860869b5fb9af9a1854b15582796c64ee3dfd7096dc0c89f307"
                },
                {
                    "type": "patch",
                    "path": "glew-no-static-lib.patch"
                }
            ]
        },
        {
            "name": "runescape",
            "buildsystem": "simple",
            "build-commands": [
                "install apply_extra /app/bin",
                "install runescape.sh /app/bin/runescape",
                "cp /usr/bin/ar /app/bin",
                "cp /usr/lib/libbfd-*.so /app/lib"
            ],
            "sources": [
                {
                    "type": "script",
                    "dest-filename": "apply_extra",
                    "commands": [
                        "ar x runescape.deb",
                        "tar xf data.tar.xz",
                        "rm -f runescape.deb control.tar.gz data.tar.xz debian-binary _gpgbuilder",
                        "mv usr/share/games/runescape-launcher/runescape .",

                        "mkdir -p export/share/applications",
                        "sed -i 's|/usr/bin/runescape-launcher %u|runescape|g' usr/share/applications/runescape-launcher.desktop",
                        "sed s/Icon=runescape/Icon=com.jagex.RuneScape/ usr/share/applications/runescape-launcher.desktop > export/share/applications/com.jagex.RuneScape.desktop",

                        "mv usr/share/icons export/share/",
                        "for d in export/share/icons/hicolor/*; do mv $d/apps/runescape.png $d/apps/com.jagex.RuneScape.png; done;",

                        "rm -rf usr"
                    ]
                },
                {
                    /* This is based on runescape-launcher script from .deb */
                    "type": "script",
                    "commands": [
                        "configURI=http://www.runescape.com/k=5/l=\$\(Language:0\)/jav_config.ws",
                        "export PULSE_PROP_OVERRIDE=\"application.name='RuneScape' application.icon_name='runescape' media.role='game'\"",
                        "export SDL_VIDEO_X11_WMCLASS=\"RuneScape\"",
                        "export MESA_GL_VERSION_OVERRIDE=3.0",
                        "unset XMODIFIERS",
                        "/app/extra/runescape --configURI $configURI $@"
                    ],
                    "dest-filename": "runescape.sh"
                }
            ]
        }
    ]
}
