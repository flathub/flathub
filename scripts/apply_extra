#!/usr/bin/env bash
set -euo pipefail

EXTRA="/app/extra"
TARBALL="$EXTRA/launcher.tar.gz"

# Ensure the tarball exists (downloaded by flatpak during install)
[ -f "$TARBALL" ] || { echo "Missing $TARBALL"; exit 1; }

# Extract into /app/extra
tar -xf "$TARBALL" -C "$EXTRA"

# Find the unpacked directory (adjust the pattern if needed)
APPDIR="$(find "$EXTRA" -maxdepth 1 -mindepth 1 -type d -iname '*launcher*' -print -quit)"
if [ -z "$APPDIR" ]; then
  # If the archive unpacks files directly (no top-level folder), use /app/extra itself
  APPDIR="$EXTRA"
fi

# Stable pointer used by run.sh
rm -f "$EXTRA/current"
ln -s "$APPDIR" "$EXTRA/current"

# Make top-level files executable (harmless if none)
chmod +x "$APPDIR"/* 2>/dev/null || true

# (Optional) remove the tarball to save space
# rm -f "$TARBALL"