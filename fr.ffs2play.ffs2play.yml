app-id: fr.ffs2play.ffs2play

runtime: org.freedesktop.Platform
runtime-version: "18.08"
sdk: org.freedesktop.Sdk

base: org.electronjs.Electron2.BaseApp
base-version: "18.08"

command: ffs2play

finish-args:
  # X11/Wayland
  - --socket=x11
  - --share=ipc
  - --socket=wayland
  - --device=dri
  # Sync
  - --share=network
  # Filesystem access
  - --filesystem=host
  # Allow access to keyring
  - --talk-name=org.freedesktop.secrets

modules:

  - name: ffs2play
    buildsystem: simple
    build-commands:
        - install -Dm755 termius-app.sh /app/bin/termius-app
        - install -Dm755 apply_extra.sh /app/bin/apply_extra
        - install -Dm644 ${FLATPAK_ID}.appdata.xml -t /app/share/metainfo/
        - install -Dm755 /usr/bin/desktop-file-edit -t /app/bin/
        - install -Dm755 /usr/bin/ar -t /app/bin/
        - install -Dm755 /usr/lib/$(gcc -print-multiarch)/libbfd-*.so -t /app/lib/
        - install -Dm644 ${FLATPAK_ID}.appdata.xml -t /app/share/appdata
    sources:
        - type: file
          path: fr.ffs2play.ffs2play.appdata.xml

        - type: archive
          only-arches:
            - "x86_64"
          filename: FFS2-ffs2play-c6fa99db2eaf.zip
          url: https://bitbucket.org/FFS2/ffs2play/get/c6fa99db2eaf.zip
          sha256: 3ef0b5d47ae05b49a775afa6112062a34870ff68caf7da2122db4ae68c0a7b3d
          size: 2669622

        - type: script
          dest-filename: apply_extra.sh
          commands:
            - FLATPAK_ID=fr.ffs2play.ffs2play
            - set -e
            - unzip FFS2-ffs2play-c6fa99db2eaf.zip
            - pushd FFS2-ffs2play-c6fa99db2eaf/ || exit
            - bash build-release.sh
            - mv build-release/ffs2play ./
            - mkdir -p export/share
            - mv ./{icons,applications} export/share
            - rename ffs2play-app ${FLATPAK_ID}
                export/share/icons/hicolor/*/*/*.png
                export/share/applications/*.desktop
            - desktop-file-edit
                --set-key=Exec --set-value=ffs2play-app
                --set-key=Icon --set-value=${FLATPAK_ID}
                export/share/applications/${FLATPAK_ID}.desktop
            - popd || exit
            - rm -r FFS2-ffs2play-c6fa99db2eaf.zip FFS2-ffs2play-c6fa99db2eaf

        - type: script
          dest-filename: ffs2play-app.sh
          commands:
            - exec /app/extra/ffs2play/ffs2play-app "$@"
