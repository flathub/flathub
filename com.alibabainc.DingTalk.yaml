id: com.alibabainc.DingTalk
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: dingtalk
separate-locales: false

finish-args:
  - --share=ipc
  - --share=network
  - --socket=x11
  - --socket=pulseaudio
  - --device=dri
  # Notification
  - --talk-name=org.freedesktop.Notifications
  # System tray icon
  - --talk-name=org.kde.StatusNotifierWatcher
  - --own-name=org.kde.*
  # Screenshot
  - --talk-name=org.kde.kwin.Screenshot
  # File system
  - --filesystem=xdg-download
  - --filesystem=xdg-run/pipewire-0:ro
  # Hidpi scale
  - --env=QT_AUTO_SCREEN_SCALE_FACTOR=1
  - --env=QT_ENABLE_HIGHDPI_SCALING=1
  # QT Platform
  - --env=QT_QPA_PLATFORM=xcb

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - '*.la'
  - '*.a'

modules:
  - name: libxcrypt
    buildsystem: autotools
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/besser82/libxcrypt/releases/download/v4.4.36/libxcrypt-4.4.36.tar.xz
        sha256: e5e1f4caee0a01de2aee26e3138807d6d3ca2b8e67287966d1fefd65e1fd8943

  - name: dingtalk
    buildsystem: simple
    build-commands:
      - install -Dpm755 apply_extra ${FLATPAK_DEST}/bin/apply_extra
      - install -Dpm755 dingtalk.sh $FLATPAK_DEST/bin/dingtalk
      - install -Dpm644 com.alibabainc.DingTalk.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
      - install -Dpm644 com.alibabainc.DingTalk.png -t ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps
      - install -Dpm644 com.alibabainc.DingTalk.desktop -t ${FLATPAK_DEST}/share/applications
    sources:      
      - type: script
        commands:
          - bsdtar -O -xf dingtalk.deb data.* | bsdtar --no-same-owner -xf -
          - mv opt/apps/com.alibabainc.dingtalk/files/*-Release.* dingtalk
          - rm -rf dingtalk/{libGLdispatch.so*,libGLX.so*,libm.so*,libstdc++.so*}
          - rm -rf dingtalk.deb usr opt
        dest-filename: apply_extra

      - type: file
        path: dingtalk.sh

      - type: file
        path: com.alibabainc.DingTalk.metainfo.xml

      - type: file
        path: com.alibabainc.DingTalk.png

      - type: file
        path: com.alibabainc.DingTalk.desktop

      - type: extra-data
        filename: dingtalk.deb
        only-arches: [x86_64]
        url: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/signed_com.alibabainc.dingtalk_7.6.45.5041701_amd64.deb
        sha256: 1f811afd111d79030e8c641d709187dfba4b23e92661717a90eb0b4a1a4f559f
        size: 344637180
        x-checker-data:
          type: rotating-url
          url: https://www.dingtalk.com/win/d/qd=linux_amd64
          pattern: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_([0-9.]+)_amd64.deb
      
      - type: extra-data
        filename: dingtalk.deb
        only-arches: [aarch64]
        url: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/signed_com.alibabainc.dingtalk_([0-9.]+)_arm64.deb
        sha256: a7294d8bc2d672ec3de63864617e0489d33c8a5ffb110d46d7d0871107d85372
        size: 331202892
        x-checker-data:
          type: rotating-url
          url: https://www.dingtalk.com/win/d/qd=linux_arm64
          pattern: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_([0-9.]+)_arm64.deb