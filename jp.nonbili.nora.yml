app-id: jp.nonbili.nora
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: '25.08'
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node22
command: run.sh
separate-locales: false
finish-args:
  - --device=dri
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --share=network
  - --own-name=org.mpris.MediaPlayer2.chromium.*
modules:
  - name: nora
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node22/bin:/run/build/nora/bin
      env:
        VITE_BUILD_TARGET: portable
    build-commands:
      - bun run bundle
      - |
        cd desktop
        bun electron-vite build
        bun electron-builder --dir --publish never --config.electronDist=../node_modules/electron/dist2
        cp -a dist/linux*unpacked /app/main

      - install -Dm755 -t /app/bin/ ./run.sh
      - install -Dm644 metadata/flatpak/jp.nonbili.nora.metainfo.xml -t /app/share/metainfo/
      - install -Dm644 metadata/flatpak/jp.nonbili.nora.desktop -t /app/share/applications/
      - install -Dm644 desktop/icon.png /app/share/icons/hicolor/512x512/apps/jp.nonbili.nora.png
    sources:
      - type: archive
        url: https://github.com/nonbili/Nora-Desktop/releases/download/v0.1.3/source.tar.gz
        sha256: 1fea3aa41d6c8820bd104e51626140dff5bee2b6353b4c4adade2c08b450ac56
        strip-components: 0

      - type: archive
        url: https://github.com/nonbili/Nora-Desktop/releases/download/v0.1.3/node_modules-x64.tar.gz
        sha256: 45b6200d8dcd47975d5f98e06584b285c33b422ef37b78b75a5c02556afc2144
        dest: node_modules
        only-arches: [x86_64]

      - type: archive
        url: https://github.com/oven-sh/bun/releases/download/bun-v1.3.1/bun-linux-x64.zip
        sha256: 400824c82bfcc0854365bcada11cf53d7384ecb1e2c3da0e2c0a2c6a527d5629
        dest: bin
        only-arches: [x86_64]

      - type: archive
        url: https://github.com/electron/electron/releases/download/v39.2.7/electron-v39.2.7-linux-x64.zip
        sha256: 2f5285ef563dca154aa247696dddef545d3d895dd9b227ed423ea0d43737c22c
        strip-components: 0
        dest: node_modules/electron/dist2
        only-arches: [x86_64]

      - type: archive
        url: https://github.com/nonbili/Nora-Desktop/releases/download/v0.1.3/node_modules-arm64.tar.gz
        sha256: 370610165226def32d14011c22fcdd86f8ad7daac7a62cc07dedc1c931addfd5
        dest: node_modules
        only-arches: [aarch64]

      - type: archive
        url: https://github.com/oven-sh/bun/releases/download/bun-v1.3.1/bun-linux-aarch64.zip
        sha256: 65666a18439e891e5751b666103fe591a8519f11b66ec4bd8654c5515d4fff8a
        dest: bin
        only-arches: [aarch64]

      - type: archive
        url: https://github.com/electron/electron/releases/download/v39.2.7/electron-v39.2.7-linux-arm64.zip
        sha256: 445465a43bd2ffaec09877f4ed46385065632a4683c2806cc6211cc73c110024
        strip-components: 0
        dest: node_modules/electron/dist2
        only-arches: [aarch64]

      - type: script
        dest-filename: run.sh
        commands:
          - zypak-wrapper.sh /app/main/Nora "$@"
