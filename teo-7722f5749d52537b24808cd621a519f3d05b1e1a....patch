From 63963cb013099ab92bfe38d4ad2081a4ebb19bf7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Sat, 11 Nov 2017 18:32:35 +0100
Subject: [PATCH 01/33] Right side of the keyboard for joystick 0

Keys : i o p k l m ; : !
---
 doc/teo_en.htm       |  4 ++--
 doc/teo_fr.htm       |  4 ++--
 doc/wiki/teo_en      |  4 ++--
 doc/wiki/teo_fr      |  4 ++--
 src/media/keyboard.c | 29 +++++++++++++++++++----------
 5 files changed, 27 insertions(+), 18 deletions(-)

diff --git a/doc/teo_en.htm b/doc/teo_en.htm
index f5c1aec..cd0481a 100644
--- a/doc/teo_en.htm
+++ b/doc/teo_en.htm
@@ -75,9 +75,9 @@
 <p>In addition to being possibly detected materially, they can be controlled from the keyboard, <code>Lock. Num.</code> or <code>NumLock</code> off:</p>
 
 <table width="100%" border="1">
-<tr><td>Directions joystick 0</td><td>Key pad 7, 8, 9, 4, 5, 6, 1, 2, 3</td></tr>
+<tr><td>Directions joystick 0</td><td>Key pad 7 8 9 4 5 6 1 2 3 or keyboard i o p k l m ; : ! (French keyboard)</td></tr>
 <tr><td>Button joystick 0</td><td>>Ctrl right (or Shift right)</td></tr>
-<tr><td>Directions joystick 1</td><td>A, Z, E, Q, S, D, W, X, C (French keyboard)</td></tr>
+<tr><td>Directions joystick 1</td><td>A Z E Q S D W X C (French keyboard)</td></tr>
 <tr><td>Button joystick 1</td><td>Ctrl left</td></tr>
 </table>
 
diff --git a/doc/teo_fr.htm b/doc/teo_fr.htm
index 1ab0bdd..6586271 100644
--- a/doc/teo_fr.htm
+++ b/doc/teo_fr.htm
@@ -74,9 +74,9 @@
 <p>En plus d'&ecirc;tre &eacute;ventuellement reconnus mat&eacute;riellement, il peuvent &ecirc;tre contr&ocirc;l&eacute;s au clavier, <em><code>Verr. Num.</code></em> ou <em><code>NumLock</code></em> &eacute;teint :</p>
 
 <table width="100%" border="1">
-<tr><td>Directions joystick 0</td><td>Pav&eacute; num&eacute;rique 7, 8, 9, 4, 5, 6, 1, 2, 3</td></tr>
+<tr><td>Directions joystick 0</td><td>Pav&eacute; num&eacute;rique 7 8 9 4 5 6 1 2 3 ou clavier i o  p k l m ; : !</td></tr>
 <tr><td>Bouton joystick 0</td><td>Ctrl droit (ou Shift droit)</td></tr>
-<tr><td>Directions joystick 1</td><td>A, Z, E, Q, S, D, W, X, C</td></tr>
+<tr><td>Directions joystick 1</td><td>A Z E Q S D W X C</td></tr>
 <tr><td>Bouton joystick 1</td><td>Ctrl gauche</td></tr>
 </table>
 
diff --git a/doc/wiki/teo_en b/doc/wiki/teo_en
index 6546683..baf18b5 100644
--- a/doc/wiki/teo_en
+++ b/doc/wiki/teo_en
@@ -63,9 +63,9 @@ If you have some keyboard response problems, don't hesitate to play with the num
 In addition to being possibly detected materially, they can be controlled from the keyboard, `Lock. Num.` or `NumLock` off:
 
 <table width="100%" border="1">
-<tr><td>Directions joystick 0</td><td>Key pad 7, 8, 9, 4, 5, 6, 1, 2, 3</td></tr>
+<tr><td>Directions joystick 0</td><td>Key pad 7 8 9 4 5 6 1 2 3 or keyboard i o p k l m ; : ! (French keyboard)</td></tr>
 <tr><td>Button joystick 0</td><td>>Ctrl right (or Shift right)</td></tr>
-<tr><td>Directions joystick 1</td><td>A, Z, E, Q, S, D, W, X, C (French keyboard)</td></tr>
+<tr><td>Directions joystick 1</td><td>A Z E Q S D W X C (French keyboard)</td></tr>
 <tr><td>Button joystick 1</td><td>Ctrl left</td></tr>
 </table>
 
diff --git a/doc/wiki/teo_fr b/doc/wiki/teo_fr
index da0086e..62d3ba2 100644
--- a/doc/wiki/teo_fr
+++ b/doc/wiki/teo_fr
@@ -62,9 +62,9 @@ Si vous avez des probl&egrave;mes de r&eacute;ponse clavier, n'h&eacute;sitez pa
 En plus d'&ecirc;tre &eacute;ventuellement reconnus mat&eacute;riellement, il peuvent &ecirc;tre contr&ocirc;l&eacute;s au clavier, *`Verr. Num.`* ou *`NumLock`* &eacute;teint :
 
 <table width="100%" border="1">
-<tr><td>Directions joystick 0</td><td>Pav&eacute; num&eacute;rique 7, 8, 9, 4, 5, 6, 1, 2, 3</td></tr>
+<tr><td>Directions joystick 0</td><td>Pav&eacute; num&eacute;rique 7 8 9 4 5 6 1 2 3 ou clavier i o  p k l m ; : !</td></tr>
 <tr><td>Bouton joystick 0</td><td>Ctrl droit (ou Shift droit)</td></tr>
-<tr><td>Directions joystick 1</td><td>A, Z, E, Q, S, D, W, X, C</td></tr>
+<tr><td>Directions joystick 1</td><td>A Z E Q S D W X C</td></tr>
 <tr><td>Bouton joystick 1</td><td>Ctrl gauche</td></tr>
 </table>
 
diff --git a/src/media/keyboard.c b/src/media/keyboard.c
index e9bef1e..fa7abca 100644
--- a/src/media/keyboard.c
+++ b/src/media/keyboard.c
@@ -105,7 +105,7 @@ static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 #define TOKEY_6                    TOKEY_UNDERSCORE|TOKEY_SHIFT  /* 6 */
 #define TOKEY_E_GRAVE_LOWER_CASE   0x31  /* è */
 #define TOKEY_7                    TOKEY_E_GRAVE_LOWER_CASE|TOKEY_SHIFT  /* 7 */
-#define TOKEY_EXCLAMATION_MARK     0x39  /* ! */
+#define TOKEY_EXCLAMATION_MARK     0x39|SPECIAL_PAD  /* ! */
 #define TOKEY_8                    TOKEY_EXCLAMATION_MARK|TOKEY_SHIFT  /* 8 */
 #define TOKEY_C_CEDILLA_LOWER_CASE 0x41  /* ç */
 #define TOKEY_9                    TOKEY_C_CEDILLA_LOWER_CASE|TOKEY_SHIFT  /* 9 */
@@ -116,7 +116,7 @@ static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 #define TOKEY_MINUS                0x44  /* - */
 #define TOKEY_BACKSLASH            TOKEY_MINUS|TOKEY_SHIFT  /* \ */
 #define TOKEY_EQUAL                0x0c  /* = */
-#define TOKEY_PLUS                 TOKEY_EQUAL|TOKEY_SHIFT  /* \ */
+#define TOKEY_PLUS                 TOKEY_EQUAL|TOKEY_SHIFT  /* + */
 #define TOKEY_ACC                  0x14  /* ACC */
 #define TOKEY_ARROW_UP             0x04  /* arrow up */
 #define TOKEY_PAD_7                0x1c|SPECIAL_PAD  /* 7 numeric pad */
@@ -138,11 +138,11 @@ static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 #define TOKEY_Y_UPPER_CASE         TOKEY_Y_LOWER_CASE|TOKEY_SHIFT  /* Y */
 #define TOKEY_U_LOWER_CASE         0x32|SPECIAL_UPC  /* u */
 #define TOKEY_U_UPPER_CASE         TOKEY_U_LOWER_CASE|TOKEY_SHIFT  /* U */
-#define TOKEY_I_LOWER_CASE         0x3a|SPECIAL_UPC  /* i */
+#define TOKEY_I_LOWER_CASE         0x3a|SPECIAL_UPC|SPECIAL_PAD  /* i */
 #define TOKEY_I_UPPER_CASE         TOKEY_I_LOWER_CASE|TOKEY_SHIFT  /* I */
-#define TOKEY_O_LOWER_CASE         0x42|SPECIAL_UPC  /* o */
+#define TOKEY_O_LOWER_CASE         0x42|SPECIAL_UPC|SPECIAL_PAD  /* o */
 #define TOKEY_O_UPPER_CASE         TOKEY_O_LOWER_CASE|TOKEY_SHIFT  /* O */
-#define TOKEY_P_LOWER_CASE         0x4a|SPECIAL_UPC  /* p */
+#define TOKEY_P_LOWER_CASE         0x4a|SPECIAL_UPC|SPECIAL_PAD  /* p */
 #define TOKEY_P_UPPER_CASE         TOKEY_P_LOWER_CASE|TOKEY_SHIFT  /* P */
 #define TOKEY_CIRCUMFLEX           0x4d  /* ^ */
 #define TOKEY_DIAERESIS            TOKEY_CIRCUMFLEX|TOKEY_SHIFT  /* " */
@@ -171,11 +171,11 @@ static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 #define TOKEY_H_UPPER_CASE         TOKEY_H_LOWER_CASE|TOKEY_SHIFT  /* H */
 #define TOKEY_J_LOWER_CASE         0x33|SPECIAL_UPC  /* j */
 #define TOKEY_J_UPPER_CASE         TOKEY_J_LOWER_CASE|TOKEY_SHIFT  /* J */
-#define TOKEY_K_LOWER_CASE         0x3b|SPECIAL_UPC  /* k */
+#define TOKEY_K_LOWER_CASE         0x3b|SPECIAL_UPC|SPECIAL_PAD  /* k */
 #define TOKEY_K_UPPER_CASE         TOKEY_K_LOWER_CASE|TOKEY_SHIFT  /* K */
-#define TOKEY_L_LOWER_CASE         0x43|SPECIAL_UPC  /* l */
+#define TOKEY_L_LOWER_CASE         0x43|SPECIAL_UPC|SPECIAL_PAD  /* l */
 #define TOKEY_L_UPPER_CASE         TOKEY_L_LOWER_CASE|TOKEY_SHIFT  /* L */
-#define TOKEY_M_LOWER_CASE         0x4b|SPECIAL_UPC  /* m */
+#define TOKEY_M_LOWER_CASE         0x4b|SPECIAL_UPC|SPECIAL_PAD  /* m */
 #define TOKEY_M_UPPER_CASE         TOKEY_M_LOWER_CASE|TOKEY_SHIFT  /* M */
 #define TOKEY_U_GRAVE_LOWER_CASE   0x45  /* ù */
 #define TOKEY_PERCENT              TOKEY_U_GRAVE_LOWER_CASE|TOKEY_SHIFT  /* % */
@@ -201,9 +201,9 @@ static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 #define TOKEY_N_UPPER_CASE         TOKEY_N_LOWER_CASE|TOKEY_SHIFT  /* N */
 #define TOKEY_COMMA                0x37  /* , */
 #define TOKEY_QUESTION_MARK        TOKEY_COMMA|TOKEY_SHIFT  /* ? */
-#define TOKEY_SEMICOLON            0x3f  /* ; */
+#define TOKEY_SEMICOLON            0x3f|SPECIAL_PAD  /* ; */
 #define TOKEY_DOT                  TOKEY_SEMICOLON|TOKEY_SHIFT  /* . */
-#define TOKEY_COLON                0x47  /* : */
+#define TOKEY_COLON                0x47|SPECIAL_PAD  /* : */
 #define TOKEY_SLASH                TOKEY_COLON|TOKEY_SHIFT  /* / */
 #define TOKEY_GREATER_THAN         0x4f  /* > */
 #define TOKEY_LOWER_THAN           TOKEY_GREATER_THAN|TOKEY_SHIFT  /* < */
@@ -813,38 +813,47 @@ void keyboard_Press (int key, int release)
                     switch (code & JOYSTICK_MASK)
                     {
                         case TOKEY_PAD_1 :
+                        case TOKEY_SEMICOLON :
                             joycode = TEO_JOYSTICK_LEFT|TEO_JOYSTICK_UP;
                             break;
 
                         case TOKEY_PAD_2 :
+                        case TOKEY_COLON :
                             joycode = TEO_JOYSTICK_UP;
                             break;
 
                         case TOKEY_PAD_3 :
+                        case TOKEY_EXCLAMATION_MARK :
                             joycode = TEO_JOYSTICK_RIGHT|TEO_JOYSTICK_UP;
                             break;
 
                         case TOKEY_PAD_4 :
+                        case TOKEY_K_LOWER_CASE :
                             joycode = TEO_JOYSTICK_LEFT;
                             break;
 
                         case TOKEY_PAD_5 :
+                        case TOKEY_L_LOWER_CASE :
                             joycode = TEO_JOYSTICK_CENTER;
                             break;
 
                         case TOKEY_PAD_6 :
+                        case TOKEY_M_LOWER_CASE :
                             joycode = TEO_JOYSTICK_RIGHT;
                             break;
 
                         case TOKEY_PAD_7 :
+                        case TOKEY_I_LOWER_CASE :
                             joycode = TEO_JOYSTICK_LEFT|TEO_JOYSTICK_DOWN;
                             break;
 
                         case TOKEY_PAD_8 :
+                        case TOKEY_O_LOWER_CASE :
                             joycode = TEO_JOYSTICK_DOWN;
                             break;
 
                         case TOKEY_PAD_9 :
+                        case TOKEY_P_LOWER_CASE :
                             joycode = TEO_JOYSTICK_RIGHT|TEO_JOYSTICK_DOWN;
                             break;
 
-- 
2.17.1


From 3b26df360c0bbc2fb7f9ae74242cebae01681d8e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Sun, 19 Nov 2017 23:04:25 +0100
Subject: [PATCH 02/33] Try to avoid other applications sound interference when
 Teo is running

- Mute is activated at reset
- last_data is reset to 128 as often as possible
Still a problem with PLAY "RE" (for example) under Basic 512, but a PLAY "DO" remove the interference
---
 include/teo.h      |  1 +
 src/alleg/asound.c | 16 ++++++++++++++++
 src/hardware.c     | 20 ++++++++++++--------
 src/linux/usound.c | 17 +++++++++++++++++
 src/teo.c          |  8 ++++++++
 5 files changed, 54 insertions(+), 8 deletions(-)

diff --git a/include/teo.h b/include/teo.h
index 7c555f1..7062ca9 100644
--- a/include/teo.h
+++ b/include/teo.h
@@ -204,6 +204,7 @@ extern int frame;
 extern void (*teo_SetColor)(int index, int r, int g, int b);
 extern void (*teo_DrawGPL)(int mode, int addr, int pt, int col);
 extern void (*teo_PutSoundByte)(unsigned long long int time, unsigned char value);
+extern void (*teo_SoundReset)(void);
 extern void (*teo_SetPointer)(int pointer);
 
 /* fonctions importables optionnelles */
diff --git a/src/alleg/asound.c b/src/alleg/asound.c
index 6f6ac84..3395be3 100644
--- a/src/alleg/asound.c
+++ b/src/alleg/asound.c
@@ -61,6 +61,19 @@ static int last_index;
 static unsigned char last_data;
 
 
+/* sound_reset:
+ *  Reset the streaming audio module.
+ */
+static void sound_reset (void)
+{
+    /* last_data must be properly initialized, otherwise
+     * the sound of other applications is altered */
+    last_data = 128;
+    last_index = 0;
+}
+
+
+
 /* voice_get_position_callback:
  *  Helper pour détecter le bon fonctionnement du streaming audio.
  */
@@ -166,6 +179,7 @@ void asound_Init(int freq)
     sound_buffer = malloc(sizeof(unsigned char)*sound_buffer_size);
 
     teo_PutSoundByte=PutSoundByte;
+    teo_SoundReset=sound_reset;
 
     teo.sound_enabled=FALSE;
 
@@ -182,5 +196,7 @@ void asound_Init(int freq)
          voice_stop(stream->voice);
     }
 
+    sound_reset ();
+
     printf(teo.sound_enabled ? "ok\n" : (is_fr?"erreur\n":"error\n"));
 }
diff --git a/src/hardware.c b/src/hardware.c
index f39e86d..a1986d6 100644
--- a/src/hardware.c
+++ b/src/hardware.c
@@ -311,7 +311,6 @@ static void SetDeviceRegister(int addr, int val)
             break;
 
         case 0xE7CD:
-            data = mc6821_ReadData(&pia_ext.portb);
             mc6821_WriteData(&pia_ext.portb, val);
 
             if ((mc6846.crc&8) == 0)  /* MUTE son inactif */
@@ -319,12 +318,12 @@ static void SetDeviceRegister(int addr, int val)
                 /* When the bit 2 of $e7cf is set to 0, the value put
                    into $e7cd is for the PIA direction register.
                    It is always possible to generate sound that way,
-                   but only if b2-b3-b4-b5 state changes. It gives
-                   then the opportunity to set some special codes
-                   noiselessly (like $fc for the joystick) even
-                   if the sound line is full open. */
+                   but only if b2, b3, b4 or b5 are not set to 1 all
+                   together. It gives then the opportunity to set some
+                   special codes noiselessly (like $fc for the joystick)
+                   even if the sound line is full open. */
                 if (((mc6821_ReadCommand(&pia_ext.portb)&0x04) != 0)
-                 || ((data&0x3c) != (mc6821_ReadData(&pia_ext.portb)&0x3c)))
+                 || ((val&0x3c) != 0x3c))
                 {
                     teo_PutSoundByte(
                         mc6809_clock(),
@@ -781,11 +780,16 @@ static int BiosCall(struct MC6809_REGS *regs)
             cass_Event(&regs->br,&regs->cc);
             break;
 
- 	/* Imprimante */
-        case 0xFB66:
+        case 0xFB66: /* Printer */
             printer_Close();
             return 0x8a; /* ORA immédiat */
 
+        case 0xFDC9: /* Reset */
+            mc6846.crc |= 8;
+            if (teo_SoundReset != NULL)
+                teo_SoundReset();
+            return 0x1a;  /* ORCC immediate */
+
     } /* end of switch */
     return 0x12;  /* NOP */
 }
diff --git a/src/linux/usound.c b/src/linux/usound.c
index 936ea96..fbf3cbf 100644
--- a/src/linux/usound.c
+++ b/src/linux/usound.c
@@ -85,6 +85,19 @@ void usound_Close (void);
 
 
 
+/* sound_reset:
+ *  Reset the streaming audio module.
+ */
+static void sound_reset (void)
+{
+    /* last_data must be properly initialized, otherwise
+     * the sound of other applications is altered */
+    last_data = 128;
+    last_index=0;
+}
+
+
+
 /* sound_error:
  *  Erreur d'initialisation du module de streaming audio.
  */
@@ -259,6 +272,7 @@ int usound_Init(void)
     int sound_buffer_size;
 
     teo_PutSoundByte=put_sound_byte;
+    teo_SoundReset=sound_reset;
 
     if (teo.setting.sound_enabled)
     {
@@ -293,6 +307,9 @@ int usound_Init(void)
 
         printf("ok\n");
     }
+    
+    sound_reset ();
+    
     return 0;
 }
 
diff --git a/src/teo.c b/src/teo.c
index a7e3da3..10f7608 100644
--- a/src/teo.c
+++ b/src/teo.c
@@ -76,6 +76,7 @@ int is_fr=0;
 void (*teo_SetColor)(int, int, int, int);
 void (*teo_DrawGPL)(int, int, int, int);
 void (*teo_PutSoundByte)(unsigned long long int, unsigned char);
+void (*teo_SoundReset)(void);
 void (*teo_SetPointer)(int);
 
 /* fonctions importables optionnelles */
@@ -185,10 +186,14 @@ static int InitMemory(void)
     mem.rom.bank[3][0x396F]=0x12;
     mem.rom.bank[3][0x3970]=0x12;
 
+    /* special treatement for the reset */
+    mem.mon.bank[0][0x1DC8]=TEO_TRAP_CODE;
+
     LOCK_DATA(mem.ram.bank[0], sizeof(uint8)*mem.ram.size);
     LOCK_DATA(mem.ram.bank[1], sizeof(uint8)*mem.ram.size);
     LOCK_DATA(mem.ram.bank[2], sizeof(uint8)*mem.ram.size);
     LOCK_DATA(mem.ram.bank[3], sizeof(uint8)*mem.ram.size);
+    LOCK_DATA(mem.mon.bank[0], sizeof(uint8)*mem.rom.size);
     LOCK_DATA(mem.mon.bank[1], sizeof(uint8)*mem.rom.size);
 
     return 0;
@@ -343,6 +348,9 @@ void teo_Reset(void)
     mode_page.lgamod=0x00;
     teo_new_video_params=TRUE;
 
+    if (teo_SoundReset != NULL)
+        teo_SoundReset();
+
     mc6809_Reset();
 }
 
-- 
2.17.1


From 507c3e833e10f7be50690f0348d8fe6fb9d2b8cd Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Mon, 20 Nov 2017 14:14:38 +0100
Subject: [PATCH 03/33] Fix PLAY interference

---
 include/teo.h      |  2 +-
 src/alleg/asound.c | 14 +++++++-------
 src/hardware.c     |  7 +++++--
 src/linux/usound.c | 14 +++++++-------
 src/teo.c          |  6 +++---
 5 files changed, 23 insertions(+), 20 deletions(-)

diff --git a/include/teo.h b/include/teo.h
index 7062ca9..048fc3e 100644
--- a/include/teo.h
+++ b/include/teo.h
@@ -204,7 +204,7 @@ extern int frame;
 extern void (*teo_SetColor)(int index, int r, int g, int b);
 extern void (*teo_DrawGPL)(int mode, int addr, int pt, int col);
 extern void (*teo_PutSoundByte)(unsigned long long int time, unsigned char value);
-extern void (*teo_SoundReset)(void);
+extern void (*teo_SilenceSound)(void);
 extern void (*teo_SetPointer)(int pointer);
 
 /* fonctions importables optionnelles */
diff --git a/src/alleg/asound.c b/src/alleg/asound.c
index 3395be3..30af92b 100644
--- a/src/alleg/asound.c
+++ b/src/alleg/asound.c
@@ -38,7 +38,7 @@
  *  Créé par   : Eric Botcazou avril 1999
  *  Modifié par: Eric Botcazou 24/09/2001
  *               Samuel Devulder 23/03/2010
- *               François Mouret 08/2011 19/10/2012 28/12/2012
+ *               François Mouret 08/2011 19/10/2012 28/12/2012 20/11/2017
  *
  *  Gestion de l'émulation sonore du TO8.
  */
@@ -61,15 +61,14 @@ static int last_index;
 static unsigned char last_data;
 
 
-/* sound_reset:
- *  Reset the streaming audio module.
+/* silence_sound:
+ *  Silence the sound.
  */
-static void sound_reset (void)
+static void silence_sound (void)
 {
     /* last_data must be properly initialized, otherwise
      * the sound of other applications is altered */
     last_data = 128;
-    last_index = 0;
 }
 
 
@@ -179,7 +178,7 @@ void asound_Init(int freq)
     sound_buffer = malloc(sizeof(unsigned char)*sound_buffer_size);
 
     teo_PutSoundByte=PutSoundByte;
-    teo_SoundReset=sound_reset;
+    teo_SilenceSound=silence_sound;
 
     teo.sound_enabled=FALSE;
 
@@ -196,7 +195,8 @@ void asound_Init(int freq)
          voice_stop(stream->voice);
     }
 
-    sound_reset ();
+    silence_sound ();
+    last_index = 0;
 
     printf(teo.sound_enabled ? "ok\n" : (is_fr?"erreur\n":"error\n"));
 }
diff --git a/src/hardware.c b/src/hardware.c
index a1986d6..ff68855 100644
--- a/src/hardware.c
+++ b/src/hardware.c
@@ -338,6 +338,9 @@ static void SetDeviceRegister(int addr, int val)
 
         case 0xE7CF:
             mc6821_WriteCommand(&pia_ext.portb, val);
+            /* To avoid other programs sound interferences */
+            if (((val & 4) != 0) && (teo_SilenceSound != NULL))
+                teo_SilenceSound();
             break;
 
         /* Gate Array lecteur de disquettes */
@@ -786,8 +789,8 @@ static int BiosCall(struct MC6809_REGS *regs)
 
         case 0xFDC9: /* Reset */
             mc6846.crc |= 8;
-            if (teo_SoundReset != NULL)
-                teo_SoundReset();
+            if (teo_SilenceSound != NULL)
+                teo_SilenceSound();
             return 0x1a;  /* ORCC immediate */
 
     } /* end of switch */
diff --git a/src/linux/usound.c b/src/linux/usound.c
index fbf3cbf..3d4e1fd 100644
--- a/src/linux/usound.c
+++ b/src/linux/usound.c
@@ -39,7 +39,7 @@
  *  Modifié par: Eric Botcazou 24/10/2003
  *               Gilles Fétis 07/2011
  *               François Mouret 08/2011 24/01/2012 15/06/2012
- *                               19/10/2012
+ *                               19/10/2012 20/11/2017
  *
  *  Gestion de l'émulation sonore du TO8.
  */
@@ -85,15 +85,14 @@ void usound_Close (void);
 
 
 
-/* sound_reset:
- *  Reset the streaming audio module.
+/* silence_sound:
+ *  Silence the sound.
  */
-static void sound_reset (void)
+static void silence_sound (void)
 {
     /* last_data must be properly initialized, otherwise
      * the sound of other applications is altered */
     last_data = 128;
-    last_index=0;
 }
 
 
@@ -272,7 +271,7 @@ int usound_Init(void)
     int sound_buffer_size;
 
     teo_PutSoundByte=put_sound_byte;
-    teo_SoundReset=sound_reset;
+    teo_SilenceSound=silence_sound;
 
     if (teo.setting.sound_enabled)
     {
@@ -308,7 +307,8 @@ int usound_Init(void)
         printf("ok\n");
     }
     
-    sound_reset ();
+    silence_sound ();
+    last_index=0;
     
     return 0;
 }
diff --git a/src/teo.c b/src/teo.c
index 10f7608..4889480 100644
--- a/src/teo.c
+++ b/src/teo.c
@@ -76,7 +76,7 @@ int is_fr=0;
 void (*teo_SetColor)(int, int, int, int);
 void (*teo_DrawGPL)(int, int, int, int);
 void (*teo_PutSoundByte)(unsigned long long int, unsigned char);
-void (*teo_SoundReset)(void);
+void (*teo_SilenceSound)(void);
 void (*teo_SetPointer)(int);
 
 /* fonctions importables optionnelles */
@@ -348,8 +348,8 @@ void teo_Reset(void)
     mode_page.lgamod=0x00;
     teo_new_video_params=TRUE;
 
-    if (teo_SoundReset != NULL)
-        teo_SoundReset();
+    if (teo_SilenceSound != NULL)
+        teo_SilenceSound();
 
     mc6809_Reset();
 }
-- 
2.17.1


From 9545ab057de4ef5e71c255c02099d97e3c270419 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Fri, 6 Apr 2018 14:01:39 +0200
Subject: [PATCH 04/33] Restore unconditional running for protected diskette
 (thanks to emulix75)

The gaps of the track are set to 0xf7 instead of 0x4e to avoid the disk
protection for SAP/FD/Floppy disks even if this protection is not required.
---
 include/media/disk.h             |  5 +++
 src/media/disk.c                 | 12 +++---
 src/media/disk/controlr/thmfc1.c | 63 +++++++++-----------------------
 src/media/disk/daccess.c         |  2 +-
 src/media/disk/fd.c              |  2 +-
 src/media/disk/sap.c             |  2 +-
 6 files changed, 31 insertions(+), 55 deletions(-)

diff --git a/include/media/disk.h b/include/media/disk.h
index 2a6d389..0d8931c 100644
--- a/include/media/disk.h
+++ b/include/media/disk.h
@@ -59,6 +59,11 @@
 #define MFM_CRC_INFO_INIT       0xb230
 #define MFM_CRC_DATA_INIT       0xe295
 
+/* special code for SAP, FD, Direct Access files.
+   Some programs need to have all the gap bytes set to 0xF7
+   to avoid protection (for example : Avenger, Marche à l'ombre). */
+#define MFM_PROT_GAP_DATA_VALUE 0xf7
+
 #define FM_GAP_DATA_VALUE       0xff
 #define FM_PRE_SYNC_DATA_VALUE  0x00
 #define FM_SYNCHRO_CLOCK_VALUE  0xc7
diff --git a/src/media/disk.c b/src/media/disk.c
index ebf4893..1d9724a 100644
--- a/src/media/disk.c
+++ b/src/media/disk.c
@@ -112,8 +112,7 @@ static int is_dd_floppy_sector (int track, uint8 *data, uint8 *clck)
 
     /* check gap field of sector */
     for (i=22; i<44; i++)
-        if ((clck[i]>=SYNCHRO_CLOCK_MARK)
-         || (data[i] != MFM_GAP_DATA_VALUE))
+        if (clck[i]>=SYNCHRO_CLOCK_MARK)
             return -1;
 
     /* check pre-synchro field of sector */
@@ -184,8 +183,7 @@ static int is_sd_floppy_sector (int track, uint8 *data, uint8 *clck)
      
     /* check gap field of sector */
     for (i=13; i<25; i++)
-        if ((clck[i]>=SYNCHRO_CLOCK_MARK)
-         || (data[i] != FM_GAP_DATA_VALUE))
+        if (clck[i]>=SYNCHRO_CLOCK_MARK)
             return -1;
 
     /* check pre-synchro field */
@@ -341,7 +339,7 @@ void disk_CreateDDFloppySector (int track, int sector, uint8 *sector_buffer,
     int crc;
 
     /* write start of sector field */
-    memset (data, MFM_GAP_DATA_VALUE, 32);
+    memset (data, MFM_PROT_GAP_DATA_VALUE, 32);
     memset (data+32, MFM_PRE_SYNC_DATA_VALUE, 12);
     memset (data+44, MFM_SYNCHRO_DATA_VALUE, 3);
     memset (clck+44, SYNCHRO_CLOCK_MARK, 3);
@@ -357,7 +355,7 @@ void disk_CreateDDFloppySector (int track, int sector, uint8 *sector_buffer,
     *(data+53) = (uint8)crc;
 
     /* write start of sector field */
-    memset (data+54, MFM_GAP_DATA_VALUE, 22);
+    memset (data+54, MFM_PROT_GAP_DATA_VALUE, 22);
     memset (data+76, MFM_PRE_SYNC_DATA_VALUE, 12);
     memset (data+88, MFM_SYNCHRO_DATA_VALUE, 3);
     memset (clck+88, SYNCHRO_CLOCK_MARK, 3);
@@ -372,7 +370,7 @@ void disk_CreateDDFloppySector (int track, int sector, uint8 *sector_buffer,
     *(data+349) = (uint8)crc;
 
     /* write sector gap */
-    memset (data+350, MFM_GAP_DATA_VALUE, 12);
+    memset (data+350, MFM_PROT_GAP_DATA_VALUE, 12);
 }
 
 
diff --git a/src/media/disk/controlr/thmfc1.c b/src/media/disk/controlr/thmfc1.c
index 7a86cf3..3b855f9 100644
--- a/src/media/disk/controlr/thmfc1.c
+++ b/src/media/disk/controlr/thmfc1.c
@@ -254,7 +254,6 @@
 #define DO_PRINT  1      /* if output wanted */
 #endif
 
-static struct MC6809_REGS regs;
 static int disk_led = FALSE;
 
 
@@ -1073,51 +1072,25 @@ static void set_reg0 (int val)
         disk[dkcurr].dkc->write_door = (val & CMD0_WRITE) >> 2;
     }
 
-    switch (disk[dkcurr].state)
+    if (disk[dkcurr].state == TEO_DISK_ACCESS_DIRECT)
     {
-        /* special management for SAP files.
-           Some programs need to have the post-sector bytes (at
-           least the first 4 bytes) set to 0xF7 (for example :
-           Avenger, Marche à l'ombre) */
-        case TEO_DISK_ACCESS_SAP :
-            if ((val == 0x1b) && (disk[dkcurr].sector_size == 256))
-            {
-                mc6809_GetRegs(&regs);
-                if ((regs.pc < 0xe004)
-                 && (disk[dkcurr].dkc->wr5 >= 0)
-                 && (disk[dkcurr].dkc->wr5 <= TEO_DISK_SECTOR_PER_TRACK))
-                {
-                    memset (disk[dkcurr].data
-                                +DDSECTORPOS(disk[dkcurr].dkc->wr5)
-                                +MFM_SECTOR_SIZE-12,
-                            0xf7, 12);
-                }
-            }
-            break;
-
-        /* special management for direct access.
-           Reading/writing a sector and formatting a track are
-           immediately done */
-        case TEO_DISK_ACCESS_DIRECT :
-            mc6809_GetRegs(&regs);
-            if (regs.pc > 0xe004)
-            {
-                switch (val)
-                {
-                    case 0x19 :   /* write sector */
-                        disk_WriteSector (dkcurr);
-                        break;
-
-                    case 0x1b :   /* read sector */
-                        disk_ReadSector (dkcurr);
-                        break;
-
-                    case 0x04 :   /* format track */
-                        disk_FormatTrack (dkcurr);
-                        break;
-                }
-            }
-            break;
+        switch (val)
+        {
+            /* special management for direct access.
+               Reading/writing a sector and formatting a track are
+               immediately done */
+            case 0x19 :   /* write sector */
+                disk_WriteSector (dkcurr);
+                break;
+ 
+            case 0x1b :   /* read sector */
+                disk_ReadSector (dkcurr);
+                break;
+ 
+            case 0x04 :   /* format track */
+                disk_FormatTrack (dkcurr);
+                break;
+        }
     }
 }
 
diff --git a/src/media/disk/daccess.c b/src/media/disk/daccess.c
index fddde0e..0af3917 100644
--- a/src/media/disk/daccess.c
+++ b/src/media/disk/daccess.c
@@ -82,7 +82,7 @@ static void create_sector (int drive, uint8 *sector_buffer)
 
     /* clear track */
     memset (disk[drive].clck, DATA_CLOCK_MARK, disk[drive].track_size);
-    memset (disk[drive].data, MFM_GAP_DATA_VALUE, disk[drive].track_size);
+    memset (disk[drive].data, MFM_PROT_GAP_DATA_VALUE, disk[drive].track_size);
 
     /* compute sector offset (interleave 7) */
     pos = DDSECTORPOS (disk[drive].drv->sector);
diff --git a/src/media/disk/fd.c b/src/media/disk/fd.c
index 4654261..58fb255 100644
--- a/src/media/disk/fd.c
+++ b/src/media/disk/fd.c
@@ -181,7 +181,7 @@ static int read_mfm_track (int drive, int track)
     size_t secsiz = (size_t)TEO_DISK_DD_SECTOR_SIZE;
 
     /* initialize track */
-    memset (disk[drive].data, MFM_GAP_DATA_VALUE, TEO_DISK_TRACK_SIZE_MAX);
+    memset (disk[drive].data, MFM_PROT_GAP_DATA_VALUE, TEO_DISK_TRACK_SIZE_MAX);
     memset (disk[drive].clck, DATA_CLOCK_MARK, TEO_DISK_TRACK_SIZE_MAX);
 
     /* read-open FD file */
diff --git a/src/media/disk/sap.c b/src/media/disk/sap.c
index 2a97bee..9f03cc5 100644
--- a/src/media/disk/sap.c
+++ b/src/media/disk/sap.c
@@ -244,7 +244,7 @@ static int read_mfm_track (int drive, int track)
     size_t secsiz = (size_t)SAP_DD_SECT_SIZE;
 
     /* initialize track */
-    memset (disk[drive].data, MFM_GAP_DATA_VALUE, TEO_DISK_TRACK_SIZE_MAX);
+    memset (disk[drive].data, MFM_PROT_GAP_DATA_VALUE, TEO_DISK_TRACK_SIZE_MAX);
     memset (disk[drive].clck, DATA_CLOCK_MARK, TEO_DISK_TRACK_SIZE_MAX);
 
     /* read-open SAP file */
-- 
2.17.1


From c30acf0ae752a59073ca020a80dd900ded7560c1 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Fri, 6 Apr 2018 20:10:36 +0200
Subject: [PATCH 05/33] Left keypad used as joystick must return the
 corresponding key

... otherwise, it's a big surprise if the whole keyboard doesn't
work when NumLock is off.
---
 src/media/keyboard.c | 133 ++++++++++++++++++++++++++++++++-----------
 1 file changed, 99 insertions(+), 34 deletions(-)

diff --git a/src/media/keyboard.c b/src/media/keyboard.c
index fa7abca..5396690 100644
--- a/src/media/keyboard.c
+++ b/src/media/keyboard.c
@@ -67,14 +67,15 @@ static int njoy;
 static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 
 #define SPECIAL_NULL   -1      /* key not mapped */
-#define SPECIAL_KBD    0x1000  /* special key of main keyboard */
-#define SPECIAL_PAD    0x2000  /* special key of numeric pad */
+#define SPECIAL_KB0    0x0800  /* special key for joystick 0 (keyboard right) */
+#define SPECIAL_KB1    0x1000  /* special key for joystick 1 (keyboard left) */
+#define SPECIAL_PAD    0x2000  /* special key for joystick 0 (numeric pad) */
 #define SPECIAL_UPC    0x4000  /* upper case if CAPS LOCK */
 #define SPECIAL_KEY    0x8000  /* special key (not defined) */
 
 #define TOKEY_SHIFT    0x80
 #define TOKEY_CTRL     0x100
-#define JOYSTICK_MASK  (0x7f|SPECIAL_KBD|SPECIAL_PAD|SPECIAL_UPC)
+#define JOYSTICK_MASK  (0x7f|SPECIAL_KB0|SPECIAL_KB1|SPECIAL_PAD|SPECIAL_UPC)
 
 /* List of Thomson scancodes */
 /* 1st row */
@@ -105,7 +106,7 @@ static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 #define TOKEY_6                    TOKEY_UNDERSCORE|TOKEY_SHIFT  /* 6 */
 #define TOKEY_E_GRAVE_LOWER_CASE   0x31  /* è */
 #define TOKEY_7                    TOKEY_E_GRAVE_LOWER_CASE|TOKEY_SHIFT  /* 7 */
-#define TOKEY_EXCLAMATION_MARK     0x39|SPECIAL_PAD  /* ! */
+#define TOKEY_EXCLAMATION_MARK     0x39|SPECIAL_KB1  /* ! */
 #define TOKEY_8                    TOKEY_EXCLAMATION_MARK|TOKEY_SHIFT  /* 8 */
 #define TOKEY_C_CEDILLA_LOWER_CASE 0x41  /* ç */
 #define TOKEY_9                    TOKEY_C_CEDILLA_LOWER_CASE|TOKEY_SHIFT  /* 9 */
@@ -124,11 +125,11 @@ static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 #define TOKEY_PAD_9                0x35|SPECIAL_PAD  /* 9 numeric pad */
 /* 3rd row */
 #define TOKEY_STOP                 0x30  /* STOP */
-#define TOKEY_A_LOWER_CASE         0x2a|SPECIAL_KBD|SPECIAL_UPC  /* a */
+#define TOKEY_A_LOWER_CASE         0x2a|SPECIAL_KB0|SPECIAL_UPC  /* a */
 #define TOKEY_A_UPPER_CASE         TOKEY_A_LOWER_CASE|TOKEY_SHIFT  /* A */
-#define TOKEY_Z_LOWER_CASE         0x22|SPECIAL_KBD|SPECIAL_UPC  /* z */
+#define TOKEY_Z_LOWER_CASE         0x22|SPECIAL_KB0|SPECIAL_UPC  /* z */
 #define TOKEY_Z_UPPER_CASE         TOKEY_Z_LOWER_CASE|TOKEY_SHIFT  /* Z */
-#define TOKEY_E_LOWER_CASE         0x1a|SPECIAL_KBD|SPECIAL_UPC  /* e */
+#define TOKEY_E_LOWER_CASE         0x1a|SPECIAL_KB0|SPECIAL_UPC  /* e */
 #define TOKEY_E_UPPER_CASE         TOKEY_E_LOWER_CASE|TOKEY_SHIFT  /* E */
 #define TOKEY_R_LOWER_CASE         0x12|SPECIAL_UPC  /* r */
 #define TOKEY_R_UPPER_CASE         TOKEY_R_LOWER_CASE|TOKEY_SHIFT  /* R */
@@ -138,11 +139,11 @@ static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 #define TOKEY_Y_UPPER_CASE         TOKEY_Y_LOWER_CASE|TOKEY_SHIFT  /* Y */
 #define TOKEY_U_LOWER_CASE         0x32|SPECIAL_UPC  /* u */
 #define TOKEY_U_UPPER_CASE         TOKEY_U_LOWER_CASE|TOKEY_SHIFT  /* U */
-#define TOKEY_I_LOWER_CASE         0x3a|SPECIAL_UPC|SPECIAL_PAD  /* i */
+#define TOKEY_I_LOWER_CASE         0x3a|SPECIAL_UPC|SPECIAL_KB1  /* i */
 #define TOKEY_I_UPPER_CASE         TOKEY_I_LOWER_CASE|TOKEY_SHIFT  /* I */
-#define TOKEY_O_LOWER_CASE         0x42|SPECIAL_UPC|SPECIAL_PAD  /* o */
+#define TOKEY_O_LOWER_CASE         0x42|SPECIAL_UPC|SPECIAL_KB1  /* o */
 #define TOKEY_O_UPPER_CASE         TOKEY_O_LOWER_CASE|TOKEY_SHIFT  /* O */
-#define TOKEY_P_LOWER_CASE         0x4a|SPECIAL_UPC|SPECIAL_PAD  /* p */
+#define TOKEY_P_LOWER_CASE         0x4a|SPECIAL_UPC|SPECIAL_KB1  /* p */
 #define TOKEY_P_UPPER_CASE         TOKEY_P_LOWER_CASE|TOKEY_SHIFT  /* P */
 #define TOKEY_CIRCUMFLEX           0x4d  /* ^ */
 #define TOKEY_DIAERESIS            TOKEY_CIRCUMFLEX|TOKEY_SHIFT  /* " */
@@ -157,11 +158,11 @@ static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 /* 4th row */
 #define TOKEY_OPEN_SQUARE_BRACKET  0x2c  /* [ */
 #define TOKEY_OPEN_BRACES          TOKEY_OPEN_SQUARE_BRACKET|TOKEY_SHIFT  /* [ */
-#define TOKEY_Q_LOWER_CASE         0x2b|SPECIAL_KBD|SPECIAL_UPC  /* q */
+#define TOKEY_Q_LOWER_CASE         0x2b|SPECIAL_KB0|SPECIAL_UPC  /* q */
 #define TOKEY_Q_UPPER_CASE         TOKEY_Q_LOWER_CASE|TOKEY_SHIFT  /* Q */
-#define TOKEY_S_LOWER_CASE         0x23|SPECIAL_KBD|SPECIAL_UPC  /* s */ 
+#define TOKEY_S_LOWER_CASE         0x23|SPECIAL_KB0|SPECIAL_UPC  /* s */ 
 #define TOKEY_S_UPPER_CASE         TOKEY_S_LOWER_CASE|TOKEY_SHIFT  /* S */
-#define TOKEY_D_LOWER_CASE         0x1b|SPECIAL_KBD|SPECIAL_UPC  /* d */ 
+#define TOKEY_D_LOWER_CASE         0x1b|SPECIAL_KB0|SPECIAL_UPC  /* d */ 
 #define TOKEY_D_UPPER_CASE         TOKEY_D_LOWER_CASE|TOKEY_SHIFT  /* D */
 #define TOKEY_F_LOWER_CASE         0x13|SPECIAL_UPC  /* f */
 #define TOKEY_F_UPPER_CASE         TOKEY_F_LOWER_CASE|TOKEY_SHIFT  /* F */
@@ -171,11 +172,11 @@ static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 #define TOKEY_H_UPPER_CASE         TOKEY_H_LOWER_CASE|TOKEY_SHIFT  /* H */
 #define TOKEY_J_LOWER_CASE         0x33|SPECIAL_UPC  /* j */
 #define TOKEY_J_UPPER_CASE         TOKEY_J_LOWER_CASE|TOKEY_SHIFT  /* J */
-#define TOKEY_K_LOWER_CASE         0x3b|SPECIAL_UPC|SPECIAL_PAD  /* k */
+#define TOKEY_K_LOWER_CASE         0x3b|SPECIAL_UPC|SPECIAL_KB1  /* k */
 #define TOKEY_K_UPPER_CASE         TOKEY_K_LOWER_CASE|TOKEY_SHIFT  /* K */
-#define TOKEY_L_LOWER_CASE         0x43|SPECIAL_UPC|SPECIAL_PAD  /* l */
+#define TOKEY_L_LOWER_CASE         0x43|SPECIAL_UPC|SPECIAL_KB1  /* l */
 #define TOKEY_L_UPPER_CASE         TOKEY_L_LOWER_CASE|TOKEY_SHIFT  /* L */
-#define TOKEY_M_LOWER_CASE         0x4b|SPECIAL_UPC|SPECIAL_PAD  /* m */
+#define TOKEY_M_LOWER_CASE         0x4b|SPECIAL_UPC|SPECIAL_KB1  /* m */
 #define TOKEY_M_UPPER_CASE         TOKEY_M_LOWER_CASE|TOKEY_SHIFT  /* M */
 #define TOKEY_U_GRAVE_LOWER_CASE   0x45  /* ù */
 #define TOKEY_PERCENT              TOKEY_U_GRAVE_LOWER_CASE|TOKEY_SHIFT  /* % */
@@ -187,11 +188,11 @@ static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 #define TOKEY_PAD_3                0x4e|SPECIAL_PAD  /* 3 numeric pad */
 /* 5th row */
 #define TOKEY_CAPS_LOCK            0x40  /* CAPS LOCK */
-#define TOKEY_W_LOWER_CASE         0x2f|SPECIAL_KBD|SPECIAL_UPC  /* w */
+#define TOKEY_W_LOWER_CASE         0x2f|SPECIAL_KB0|SPECIAL_UPC  /* w */
 #define TOKEY_W_UPPER_CASE         TOKEY_W_LOWER_CASE|TOKEY_SHIFT  /* W */
-#define TOKEY_X_LOWER_CASE         0x27|SPECIAL_KBD|SPECIAL_UPC  /* x */
+#define TOKEY_X_LOWER_CASE         0x27|SPECIAL_KB0|SPECIAL_UPC  /* x */
 #define TOKEY_X_UPPER_CASE         TOKEY_X_LOWER_CASE|TOKEY_SHIFT  /* X */
-#define TOKEY_C_LOWER_CASE         0x1f|SPECIAL_KBD|SPECIAL_UPC  /* c */
+#define TOKEY_C_LOWER_CASE         0x1f|SPECIAL_KB0|SPECIAL_UPC  /* c */
 #define TOKEY_C_UPPER_CASE         TOKEY_C_LOWER_CASE|TOKEY_SHIFT  /* C */
 #define TOKEY_V_LOWER_CASE         0x17|SPECIAL_UPC  /* v */
 #define TOKEY_V_UPPER_CASE         TOKEY_V_LOWER_CASE|TOKEY_SHIFT  /* V */
@@ -201,9 +202,9 @@ static volatile int j0_dir[2], j1_dir[2]; /* buffer direction des manettes */
 #define TOKEY_N_UPPER_CASE         TOKEY_N_LOWER_CASE|TOKEY_SHIFT  /* N */
 #define TOKEY_COMMA                0x37  /* , */
 #define TOKEY_QUESTION_MARK        TOKEY_COMMA|TOKEY_SHIFT  /* ? */
-#define TOKEY_SEMICOLON            0x3f|SPECIAL_PAD  /* ; */
+#define TOKEY_SEMICOLON            0x3f|SPECIAL_KB1  /* ; */
 #define TOKEY_DOT                  TOKEY_SEMICOLON|TOKEY_SHIFT  /* . */
-#define TOKEY_COLON                0x47|SPECIAL_PAD  /* : */
+#define TOKEY_COLON                0x47|SPECIAL_KB1  /* : */
 #define TOKEY_SLASH                TOKEY_COLON|TOKEY_SHIFT  /* / */
 #define TOKEY_GREATER_THAN         0x4f  /* > */
 #define TOKEY_LOWER_THAN           TOKEY_GREATER_THAN|TOKEY_SHIFT  /* < */
@@ -732,8 +733,8 @@ void keyboard_Press (int key, int release)
                 code = key_code[key];
             }
 
-            /* special key of the main keyboard */
-            if ((code & SPECIAL_KBD) != 0)
+            /* special key for joystick 0 (keyboard right) */
+            if ((code & SPECIAL_KB0) != 0)
             {
                 if ((njoy>1) && ((kb_state&TEO_KEY_F_NUMLOCK) == 0))
                 {
@@ -801,11 +802,84 @@ void keyboard_Press (int key, int release)
                     }
 
                     joystick_Move (njoy-1, j1_dir[0]);
-                    /* pas de break */
+                    /* no break */
                 }
             }
             else
-            /* special key of the numeric pad */
+            /* special key for joystick 1 (keyboard left) */
+            if ((code & SPECIAL_KB1) != 0)
+            {
+                if ((njoy>0) && ((kb_state&TEO_KEY_F_NUMLOCK) == 0))
+                {
+                    switch (code & JOYSTICK_MASK)
+                    {
+                        case TOKEY_SEMICOLON :
+                            joycode = TEO_JOYSTICK_LEFT|TEO_JOYSTICK_UP;
+                            break;
+
+                        case TOKEY_COLON :
+                            joycode = TEO_JOYSTICK_UP;
+                            break;
+
+                        case TOKEY_EXCLAMATION_MARK :
+                            joycode = TEO_JOYSTICK_RIGHT|TEO_JOYSTICK_UP;
+                            break;
+
+                        case TOKEY_K_LOWER_CASE :
+                            joycode = TEO_JOYSTICK_LEFT;
+                            break;
+
+                        case TOKEY_L_LOWER_CASE :
+                            joycode = TEO_JOYSTICK_CENTER;
+                            break;
+
+                        case TOKEY_M_LOWER_CASE :
+                            joycode = TEO_JOYSTICK_RIGHT;
+                            break;
+
+                        case TOKEY_I_LOWER_CASE :
+                            joycode = TEO_JOYSTICK_LEFT|TEO_JOYSTICK_DOWN;
+                            break;
+
+                        case TOKEY_O_LOWER_CASE :
+                            joycode = TEO_JOYSTICK_DOWN;
+                            break;
+
+                        case TOKEY_P_LOWER_CASE :
+                            joycode = TEO_JOYSTICK_RIGHT|TEO_JOYSTICK_DOWN;
+                            break;
+
+                        default :
+                            joycode = TEO_JOYSTICK_CENTER;
+                            break;
+                    }
+
+                    if (release != 0)
+                    {
+                        if (joycode == j0_dir[0])
+                        {
+                            j0_dir[0]=j0_dir[1];
+                            j0_dir[1]=TEO_JOYSTICK_CENTER;
+                        }
+                        else
+                        if (joycode == j0_dir[1])
+                        {
+                            j0_dir[1]=TEO_JOYSTICK_CENTER;
+                        }
+                    }
+                    else
+                    if (joycode != j0_dir[0])
+                    {
+                        j0_dir[1]=j0_dir[0];
+                        j0_dir[0]=joycode;
+                    }
+
+                    joystick_Move (TEO_NJOYSTICKS-njoy, j0_dir[0]);
+                    /* no break */
+                }
+            }
+            else
+            /* special key for joystick 0 (numeric pad) */
             if ((code & SPECIAL_PAD) != 0)
             {
                 if ((njoy>0) && ((kb_state&TEO_KEY_F_NUMLOCK) == 0))
@@ -813,47 +887,38 @@ void keyboard_Press (int key, int release)
                     switch (code & JOYSTICK_MASK)
                     {
                         case TOKEY_PAD_1 :
-                        case TOKEY_SEMICOLON :
                             joycode = TEO_JOYSTICK_LEFT|TEO_JOYSTICK_UP;
                             break;
 
                         case TOKEY_PAD_2 :
-                        case TOKEY_COLON :
                             joycode = TEO_JOYSTICK_UP;
                             break;
 
                         case TOKEY_PAD_3 :
-                        case TOKEY_EXCLAMATION_MARK :
                             joycode = TEO_JOYSTICK_RIGHT|TEO_JOYSTICK_UP;
                             break;
 
                         case TOKEY_PAD_4 :
-                        case TOKEY_K_LOWER_CASE :
                             joycode = TEO_JOYSTICK_LEFT;
                             break;
 
                         case TOKEY_PAD_5 :
-                        case TOKEY_L_LOWER_CASE :
                             joycode = TEO_JOYSTICK_CENTER;
                             break;
 
                         case TOKEY_PAD_6 :
-                        case TOKEY_M_LOWER_CASE :
                             joycode = TEO_JOYSTICK_RIGHT;
                             break;
 
                         case TOKEY_PAD_7 :
-                        case TOKEY_I_LOWER_CASE :
                             joycode = TEO_JOYSTICK_LEFT|TEO_JOYSTICK_DOWN;
                             break;
 
                         case TOKEY_PAD_8 :
-                        case TOKEY_O_LOWER_CASE :
                             joycode = TEO_JOYSTICK_DOWN;
                             break;
 
                         case TOKEY_PAD_9 :
-                        case TOKEY_P_LOWER_CASE :
                             joycode = TEO_JOYSTICK_RIGHT|TEO_JOYSTICK_DOWN;
                             break;
 
-- 
2.17.1


From c44c5622d8a7b97b8f0a0dd9088581089dbdeaf2 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Fri, 6 Apr 2018 20:11:14 +0200
Subject: [PATCH 06/33] Documentation update

---
 change-en.log           | 12 +++++++++++-
 change-fr.log           | 12 +++++++++++-
 doc/teo_changes_en.htm  | 12 +++++++++++-
 doc/teo_changes_fr.htm  | 10 ++++++++++
 doc/wiki/teo_changes_en | 11 ++++++++++-
 doc/wiki/teo_changes_fr |  8 ++++++++
 6 files changed, 61 insertions(+), 4 deletions(-)

diff --git a/change-en.log b/change-en.log
index 0070477..6ada4d5 100644
--- a/change-en.log
+++ b/change-en.log
@@ -1,3 +1,13 @@
+========================================================================
+=== Version 1.8.5 (November 2017 - April 2018)                       ===
+========================================================================
+
+- teo
+   - Reduction of the sound interferences with other applications
+   - Keys iopklm;:! for joystick 0
+   - Restoration of the automatic unprotecting for SAP, FD and direct access
+    (thanks to emulix75)
+   
 ========================================================================
 === Version 1.8.4 (August 2015 - October 2017)                      ===
 ========================================================================
@@ -12,7 +22,7 @@
      (no more disk conversion error)
 
 - under Linux :
-   - Impovement of the debugger window
+   - Improvement of the debugger window
    - Increasing of the fast speed
 
 ========================================================================
diff --git a/change-fr.log b/change-fr.log
index 6b3fa17..6717af6 100644
--- a/change-fr.log
+++ b/change-fr.log
@@ -1,5 +1,15 @@
 ========================================================================
-=== Version 1.8.4 (Août 2015 - Octobre 2017)                        ===
+=== Version 1.8.5 (Novembre 2017 - Avril 2018)                       ===
+========================================================================
+
+- teo
+   - Réduction des interférences sonores avec les autres applications
+   - Touches iopklm;:! pour le joystick 0
+   - Restauration de déprotection automatique pour SAP, FD et accès direct
+    (merci à emulix75)
+
+========================================================================
+=== Version 1.8.4 (Août 2015 - Octobre 2017)                         ===
 ========================================================================
 
 - teo
diff --git a/doc/teo_changes_en.htm b/doc/teo_changes_en.htm
index 6005550..b025b45 100644
--- a/doc/teo_changes_en.htm
+++ b/doc/teo_changes_en.htm
@@ -10,6 +10,16 @@
 
 <h3>Changes</h3>
 
+<h5>Version 1.8.5 (November 2017 - April 2018)</h5>
+
+<p>TEO</p>
+
+<ul>
+<li>Reduction of the sound interferences with other applications</li>
+<li>Keys iopklm;:! for joystick 0</li>
+<li>Restoration of the automatic unprotecting for SAP, FD and direct access (thanks to emulix75)</li>
+</ul>
+
 <h5>Version 1.8.4 (July 2015-october 2017)</h5>
 
 <p>TEO</p>
@@ -25,7 +35,7 @@
 <p>under Linux :</p>
 
 <ul>
-<li>Impovement of the debugger window</li>
+<li>Improvement of the debugger window</li>
 <li>Increasing of the fast speed</li>
 </ul>
 
diff --git a/doc/teo_changes_fr.htm b/doc/teo_changes_fr.htm
index 5ecccf6..28648a2 100644
--- a/doc/teo_changes_fr.htm
+++ b/doc/teo_changes_fr.htm
@@ -10,6 +10,16 @@
 
 <h3>Changements</h3>
 
+<h5>Version 1.8.5 (Novembre 2017 - Avril 2018)</h5>
+
+<p>TEO</p>
+
+<ul>
+<li>R&eacute;duction des interf&eacute;rences sonores avec les autres applications</li>
+<li>Touches iopklm;:! pour le joystick 0</li>
+<li>Restauration de d&eacute;protection automatique pour SAP, FD et acc&egrave;s direct (merci &agrave; emulix75)</li>
+</ul>
+
 <h5>Version 1.8.4 (Juillet 2015 - Octobre 2017)</h5>
 
 <p>TEO</p>
diff --git a/doc/wiki/teo_changes_en b/doc/wiki/teo_changes_en
index 8af8f0f..a26aacf 100644
--- a/doc/wiki/teo_changes_en
+++ b/doc/wiki/teo_changes_en
@@ -1,5 +1,14 @@
 ###Changes
 
+#####Version 1.8.5 (November 2017 - April 2018)
+
+TEO
+
+- Reduction of the sound interferences with other applications
+- Keys iopklm;:! for joystick 0
+- Restoration of the automatic unprotecting for SAP, FD and direct access (thanks to emulix75)
+
+
 #####Version 1.8.4 (July 2015-october 2017)
 
 TEO
@@ -12,7 +21,7 @@ TEO
 
 under Linux :
 
-- Impovement of the debugger window
+- Improvement of the debugger window
 - Increasing of the fast speed
 
 
diff --git a/doc/wiki/teo_changes_fr b/doc/wiki/teo_changes_fr
index e7816c4..008f06d 100644
--- a/doc/wiki/teo_changes_fr
+++ b/doc/wiki/teo_changes_fr
@@ -1,5 +1,13 @@
 ###Changements
 
+#####Version 1.8.5 (Novembre 2017 - Avril 2018)
+
+TEO
+
+- R&eacute;duction des interf&eacute;rences sonores avec les autres applications
+- Touches iopklm;:! pour le joystick 0
+- Restauration de d&eacute;protection automatique pour SAP, FD et acc&egrave;s direct (merci &agrave; emulix75)
+
 #####Version 1.8.4 (Juillet 2015 - Octobre 2017)
 
 TEO
-- 
2.17.1


From 7c89fae751940d5728e324e46bf0f49d695b49e3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Fri, 6 Apr 2018 20:11:48 +0200
Subject: [PATCH 07/33] Version update

---
 misc/fixver.sh | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/misc/fixver.sh b/misc/fixver.sh
index feec46f..5395765 100755
--- a/misc/fixver.sh
+++ b/misc/fixver.sh
@@ -2,7 +2,7 @@
 #
 # Bash script to adjust the version number and dates of files.
 
-./misc/fixver/teo.sh 1 8 4
+./misc/fixver/teo.sh 1 8 5
 ./misc/fixver/cc90hfe.sh 0 7 0
 
 echo "Done!"
-- 
2.17.1


From e3eef01749f9cecebc4a7dec8f3c58d6e70b7c91 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Fri, 6 Apr 2018 20:14:00 +0200
Subject: [PATCH 08/33] Update version number in every files

---
 LISEZMOI.txt                                           |  4 ++--
 README.txt                                             |  4 ++--
 doc/wiki/teo_dos_en                                    |  2 +-
 doc/wiki/teo_dos_fr                                    |  2 +-
 doc/wiki/teo_linux_en                                  |  4 ++--
 doc/wiki/teo_linux_fr                                  |  4 ++--
 doc/wiki/teo_windows_en                                |  4 ++--
 doc/wiki/teo_windows_fr                                |  4 ++--
 include/alleg/color8.h                                 |  4 ++--
 include/alleg/gfxdrv.h                                 |  4 ++--
 include/alleg/gui.h                                    |  4 ++--
 include/alleg/joyint.h                                 |  4 ++--
 include/alleg/mouse.h                                  |  4 ++--
 include/alleg/sound.h                                  |  4 ++--
 include/debug.h                                        |  4 ++--
 include/debug/debug.h                                  |  4 ++--
 include/defs.h                                         |  4 ++--
 include/dos/debug.h                                    |  4 ++--
 include/dos/floppy.h                                   |  4 ++--
 include/dos/keybint.h                                  |  4 ++--
 include/dos/memmng.h                                   |  4 ++--
 include/errors.h                                       |  4 ++--
 include/file/bmp.h                                     |  4 ++--
 include/file/png.h                                     |  4 ++--
 include/hardware.h                                     |  4 ++--
 include/image.h                                        |  4 ++--
 include/ini.h                                          |  4 ++--
 include/linux/display.h                                |  4 ++--
 include/linux/floppy.h                                 |  4 ++--
 include/linux/graphic.h                                |  4 ++--
 include/linux/gui.h                                    |  4 ++--
 include/linux/sound.h                                  |  4 ++--
 include/main.h                                         |  4 ++--
 include/media/cass.h                                   |  4 ++--
 include/media/disk.h                                   |  4 ++--
 include/media/disk/daccess.h                           |  4 ++--
 include/media/disk/dirdisk.h                           |  4 ++--
 include/media/disk/fd.h                                |  4 ++--
 include/media/disk/hfe.h                               |  4 ++--
 include/media/disk/sap.h                               |  4 ++--
 include/media/joystick.h                               |  4 ++--
 include/media/keyboard.h                               |  4 ++--
 include/media/memo.h                                   |  4 ++--
 include/media/mouse.h                                  |  4 ++--
 include/media/printer.h                                |  4 ++--
 include/media/printer/pr90042.h                        |  4 ++--
 include/media/printer/pr90055.h                        |  4 ++--
 include/media/printer/pr90582.h                        |  4 ++--
 include/media/printer/pr906xx.h                        |  4 ++--
 include/option.h                                       |  4 ++--
 include/std.h                                          |  4 ++--
 include/teo.h                                          |  8 ++++----
 include/to8keys.h                                      |  4 ++--
 include/win/dialog.rh                                  |  4 ++--
 include/win/gui.h                                      |  4 ++--
 include/win/keybint.h                                  |  4 ++--
 misc/pack/pack.sh                                      |  2 +-
 misc/pack/repo/linux/debian/teo/DEBIAN/control         |  2 +-
 .../debian/teo/usr/share/applications/teo.desktop      |  2 +-
 misc/pack/repo/windows/inno/teo-setup.iss              |  2 +-
 src/alleg/acolor8.c                                    |  4 ++--
 src/alleg/agfxdrv.c                                    |  4 ++--
 src/alleg/agui.c                                       |  4 ++--
 src/alleg/agui/aabout.c                                |  4 ++--
 src/alleg/agui/acass.c                                 |  4 ++--
 src/alleg/agui/adisk.c                                 |  4 ++--
 src/alleg/agui/amemo.c                                 |  4 ++--
 src/alleg/agui/aprinter.c                              |  4 ++--
 src/alleg/agui/asetting.c                              |  4 ++--
 src/alleg/ajoyint.c                                    |  4 ++--
 src/alleg/amode40.c                                    |  4 ++--
 src/alleg/amode80.c                                    |  4 ++--
 src/alleg/amouse.c                                     |  4 ++--
 src/alleg/asound.c                                     |  4 ++--
 src/alleg/atruecol.c                                   |  4 ++--
 src/debug/dacc.c                                       |  4 ++--
 src/debug/dbkpt.c                                      |  4 ++--
 src/debug/ddisass.c                                    |  4 ++--
 src/debug/dmem.c                                       |  4 ++--
 src/debug/dreg.c                                       |  4 ++--
 src/dos/ddebug.c                                       |  4 ++--
 src/dos/dfloppy.c                                      |  4 ++--
 src/dos/dkeybint.c                                     |  4 ++--
 src/dos/dmain.c                                        |  4 ++--
 src/dos/dmemmng.c                                      |  4 ++--
 src/dos/dvga.c                                         |  4 ++--
 src/errors.c                                           |  4 ++--
 src/file/bmp.c                                         |  4 ++--
 src/file/png.c                                         |  4 ++--
 src/hardware.c                                         |  4 ++--
 src/image.c                                            |  4 ++--
 src/ini.c                                              |  4 ++--
 src/linux/udebug.c                                     |  4 ++--
 src/linux/udebug/udacc.c                               |  4 ++--
 src/linux/udebug/udbkpt.c                              |  4 ++--
 src/linux/udebug/uddisass.c                            |  4 ++--
 src/linux/udebug/udmem.c                               |  4 ++--
 src/linux/udebug/udreg.c                               |  4 ++--
 src/linux/udebug/udstatus.c                            |  4 ++--
 src/linux/udebug/udtoolb.c                             |  4 ++--
 src/linux/udisplay.c                                   |  4 ++--
 src/linux/ufloppy.c                                    |  4 ++--
 src/linux/ugraphic.c                                   |  4 ++--
 src/linux/ugui.c                                       |  4 ++--
 src/linux/ugui/uabout.c                                |  4 ++--
 src/linux/ugui/ucass.c                                 |  4 ++--
 src/linux/ugui/udisk.c                                 |  4 ++--
 src/linux/ugui/umemo.c                                 |  4 ++--
 src/linux/ugui/uprinter.c                              |  4 ++--
 src/linux/ugui/usetting.c                              |  4 ++--
 src/linux/umain.c                                      |  6 +++---
 src/linux/usound.c                                     |  4 ++--
 src/media/cass.c                                       |  4 ++--
 src/media/disk.c                                       |  4 ++--
 src/media/disk/controlr/thmfc1.c                       |  4 ++--
 src/media/disk/daccess.c                               |  4 ++--
 src/media/disk/fd.c                                    |  4 ++--
 src/media/disk/hfe.c                                   |  4 ++--
 src/media/disk/sap.c                                   |  4 ++--
 src/media/joystick.c                                   |  4 ++--
 src/media/keyboard.c                                   |  4 ++--
 src/media/memo.c                                       |  4 ++--
 src/media/mouse.c                                      |  4 ++--
 src/media/printer.c                                    |  4 ++--
 src/media/printer/pr90042.c                            |  4 ++--
 src/media/printer/pr90055.c                            |  4 ++--
 src/media/printer/pr90582.c                            |  4 ++--
 src/media/printer/pr906xx.c                            |  4 ++--
 src/option.c                                           |  4 ++--
 src/readme.txt                                         |  4 ++--
 src/std.c                                              |  4 ++--
 src/teo.c                                              |  4 ++--
 src/win/wdebug.c                                       |  4 ++--
 src/win/wdebug/wdacc.c                                 |  4 ++--
 src/win/wdebug/wdbkpt.c                                |  4 ++--
 src/win/wdebug/wddisass.c                              |  4 ++--
 src/win/wdebug/wdmem.c                                 |  4 ++--
 src/win/wdebug/wdreg.c                                 |  4 ++--
 src/win/wdebug/wdstatus.c                              |  4 ++--
 src/win/wdebug/wdtoolb.c                               |  4 ++--
 src/win/wdialog.rc                                     | 10 +++++-----
 src/win/wgui.c                                         |  4 ++--
 src/win/wgui/wabout.c                                  |  4 ++--
 src/win/wgui/wcass.c                                   |  4 ++--
 src/win/wgui/wdisk.c                                   |  4 ++--
 src/win/wgui/wmemo.c                                   |  4 ++--
 src/win/wgui/wprinter.c                                |  4 ++--
 src/win/wgui/wsetting.c                                |  4 ++--
 src/win/wkeybint.c                                     |  4 ++--
 src/win/wmain.c                                        |  4 ++--
 tools/cc90hfe/include/cc90.h                           |  2 +-
 tools/cc90hfe/include/defs.h                           |  6 +++---
 tools/cc90hfe/include/encode.h                         |  2 +-
 tools/cc90hfe/include/errors.h                         |  2 +-
 tools/cc90hfe/include/hfe.h                            |  2 +-
 tools/cc90hfe/include/ini.h                            |  2 +-
 tools/cc90hfe/include/linux/gui.h                      |  2 +-
 tools/cc90hfe/include/linux/progress.h                 |  2 +-
 tools/cc90hfe/include/main.h                           |  2 +-
 tools/cc90hfe/include/option.h                         |  2 +-
 tools/cc90hfe/include/port.h                           |  2 +-
 tools/cc90hfe/include/serial.h                         |  2 +-
 tools/cc90hfe/include/std.h                            |  2 +-
 tools/cc90hfe/include/win/gui.h                        |  2 +-
 tools/cc90hfe/include/win/progress.h                   |  2 +-
 tools/cc90hfe/include/win/resource.h                   |  2 +-
 tools/cc90hfe/src/cc90.c                               |  2 +-
 tools/cc90hfe/src/encode.c                             |  2 +-
 tools/cc90hfe/src/errors.c                             |  2 +-
 tools/cc90hfe/src/hfe.c                                |  2 +-
 tools/cc90hfe/src/ini.c                                |  2 +-
 tools/cc90hfe/src/linux/gui.c                          |  2 +-
 tools/cc90hfe/src/linux/gui/about.c                    |  4 ++--
 tools/cc90hfe/src/linux/gui/archive.c                  |  2 +-
 tools/cc90hfe/src/linux/gui/extract.c                  |  2 +-
 tools/cc90hfe/src/linux/gui/install.c                  |  2 +-
 tools/cc90hfe/src/linux/port.c                         |  2 +-
 tools/cc90hfe/src/linux/progress.c                     |  2 +-
 tools/cc90hfe/src/linux/serial.c                       |  2 +-
 tools/cc90hfe/src/main.c                               |  2 +-
 tools/cc90hfe/src/option.c                             |  2 +-
 tools/cc90hfe/src/std.c                                |  2 +-
 tools/cc90hfe/src/win/gui.c                            |  2 +-
 tools/cc90hfe/src/win/gui/about.c                      |  2 +-
 tools/cc90hfe/src/win/gui/archive.c                    |  2 +-
 tools/cc90hfe/src/win/gui/extract.c                    |  2 +-
 tools/cc90hfe/src/win/gui/install.c                    |  2 +-
 tools/cc90hfe/src/win/port.c                           |  2 +-
 tools/cc90hfe/src/win/progress.c                       |  2 +-
 tools/cc90hfe/src/win/resource.rc                      |  2 +-
 tools/cc90hfe/src/win/serial.c                         |  2 +-
 191 files changed, 344 insertions(+), 344 deletions(-)

diff --git a/LISEZMOI.txt b/LISEZMOI.txt
index 412ceb5..d6b6910 100644
--- a/LISEZMOI.txt
+++ b/LISEZMOI.txt
@@ -13,9 +13,9 @@
                   TT        EEEEEEEEEEEEEE  OOOOOOOOOOOOOO
 
                         L'émulateur Thomson TO8
-                              version 1.8.4
+                              version 1.8.5
 
-    Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+    Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
                             Jérémie Guillaume, François Mouret,
                             Samuel Devulder
 
diff --git a/README.txt b/README.txt
index 2afd1ad..b171d2e 100644
--- a/README.txt
+++ b/README.txt
@@ -13,9 +13,9 @@
                   TT        EEEEEEEEEEEEEE  OOOOOOOOOOOOOO
 
                         The Thomson TO8 emulator
-                              version 1.8.4
+                              version 1.8.5
 
-    Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+    Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
                             Jérémie Guillaume, François Mouret,
                             Samuel Devulder
 
diff --git a/doc/wiki/teo_dos_en b/doc/wiki/teo_dos_en
index 1b9077e..a6e0e3a 100644
--- a/doc/wiki/teo_dos_en
+++ b/doc/wiki/teo_dos_en
@@ -10,7 +10,7 @@
 
 To run the emulator, you need at least a 80386 with 2MB of RAM, a VGA card, and MS-DOS version 5.0 or greater or Windows version 3.1 or greater (Windows 95/98/Me). A Sound Blaster compatible sound-card is necessary to emulate sound.
 
-To install the emulator, you just have to unzip *`teo-1.8.4-dosexe.zip`*. The executable will be *`teo.exe`*.
+To install the emulator, you just have to unzip *`teo-1.8.5-dosexe.zip`*. The executable will be *`teo.exe`*.
 
 The file *`cwsdpmi.exe`* is only useful for running in protected mode under MS-DOS.
 
diff --git a/doc/wiki/teo_dos_fr b/doc/wiki/teo_dos_fr
index 17fe18a..64df719 100644
--- a/doc/wiki/teo_dos_fr
+++ b/doc/wiki/teo_dos_fr
@@ -10,7 +10,7 @@
 
 Pour faire fonctionner l'&eacute;mulateur, vous devez disposer au minimum d'un 80386 muni de 2 Mo de RAM, d'une carte graphique VGA et de MS-DOS version 5.0 ou sup&eacute;rieure, ou de Windows version 3.1 ou sup&eacute;rieure (Windows 95/98/Me); une carte son compatible Sound Blaster est n&eacute;cessaire pour l'&eacute;mulation sonore.
 
-Pour installer l'&eacute;mulateur, il suffit de d&eacute;sarchiver *`teo-1.8.4-dosexe.zip`*. Le programme &eacute;x&eacute;cutable se nomme *`teo.exe`*.
+Pour installer l'&eacute;mulateur, il suffit de d&eacute;sarchiver *`teo-1.8.5-dosexe.zip`*. Le programme &eacute;x&eacute;cutable se nomme *`teo.exe`*.
 
 Le fichier *`cwsdpmi.exe`* n'est n&eacute;cessaire que pour une utilisation en mode MS-DOS r&eacute;el.
 
diff --git a/doc/wiki/teo_linux_en b/doc/wiki/teo_linux_en
index 30fe9fe..39cf209 100644
--- a/doc/wiki/teo_linux_en
+++ b/doc/wiki/teo_linux_en
@@ -13,8 +13,8 @@ The required configuration to run the emulator is the standard configuration of
 
 You can install the emulator in two ways:
 
-* Launch *`teo-1.8.4-i586.deb`*.
-* Unzip *`teo-1.8.4-i586.tar.gz`*. The executable is named *`teo`*.
+* Launch *`teo-1.8.5-i586.deb`*.
+* Unzip *`teo-1.8.5-i586.tar.gz`*. The executable is named *`teo`*.
 
 #####Launching<a name="launching"></a>
 
diff --git a/doc/wiki/teo_linux_fr b/doc/wiki/teo_linux_fr
index 5d4f398..29bbab9 100644
--- a/doc/wiki/teo_linux_fr
+++ b/doc/wiki/teo_linux_fr
@@ -13,8 +13,8 @@ La configuration n&eacute;cessaire pour faire tourner l'&eacute;mulateur est la
 
 Vous pouvez installer l'&eacute;mulateur de deux fa&ccedil;ons:
 
-* Ex&eacute;cuter *`teo-1.8.4-i586.deb`*. Le lancement de *`Teo`* se fera par le menu *`Application/Jeux/Emulateur Teo`*.
-* Extraire *`teo-1.8.4-i586.tar.gz`*. Le programme &eacute;x&eacute;cutable se nomme *`teo`*.
+* Ex&eacute;cuter *`teo-1.8.5-i586.deb`*. Le lancement de *`Teo`* se fera par le menu *`Application/Jeux/Emulateur Teo`*.
+* Extraire *`teo-1.8.5-i586.tar.gz`*. Le programme &eacute;x&eacute;cutable se nomme *`teo`*.
 
 #####Lancement<a name="launching"></a>
 
diff --git a/doc/wiki/teo_windows_en b/doc/wiki/teo_windows_en
index eef39da..e0e687f 100644
--- a/doc/wiki/teo_windows_en
+++ b/doc/wiki/teo_windows_en
@@ -11,8 +11,8 @@ To run the emulator, you need at least a 80486 with 8MB of RAM running under Win
 
 You can install the emulator in two ways:
 
-* Launch *`teow-1.8.4-setup.exe`*.
-* Unzip *`teo-1.8.4-winexe.zip`*. The executable is named *`teow.exe`*.
+* Launch *`teow-1.8.5-setup.exe`*.
+* Unzip *`teo-1.8.5-winexe.zip`*. The executable is named *`teow.exe`*.
 
 #####Launching<a name="launching"></a>
 
diff --git a/doc/wiki/teo_windows_fr b/doc/wiki/teo_windows_fr
index b094cb1..3354bd1 100644
--- a/doc/wiki/teo_windows_fr
+++ b/doc/wiki/teo_windows_fr
@@ -11,8 +11,8 @@ Pour faire fonctionner l'&eacute;mulateur, vous devez disposer au minimum d'un 8
 
 Vous pouvez installer l'&eacute;mulateur de deux fa&ccedil;ons:
 
-* Ex&eacute;cutez *`teow-1.8.4-setup.exe`*.
-* D&eacute;sarchivez *`teo-1.8.4-winexe.zip`*. Le programme &eacute;x&eacute;cutable se nomme *`teow.exe`*.
+* Ex&eacute;cutez *`teow-1.8.5-setup.exe`*.
+* D&eacute;sarchivez *`teo-1.8.5-winexe.zip`*. Le programme &eacute;x&eacute;cutable se nomme *`teow.exe`*.
 
 #####Lancement<a name="launching"></a>
 
diff --git a/include/alleg/color8.h b/include/alleg/color8.h
index 4f94de4..c0d60ed 100644
--- a/include/alleg/color8.h
+++ b/include/alleg/color8.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/color8.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou mai 2000
  *  Modifié par: François Mouret 01/11/2012
  *
diff --git a/include/alleg/gfxdrv.h b/include/alleg/gfxdrv.h
index 66bffce..ccc513c 100644
--- a/include/alleg/gfxdrv.h
+++ b/include/alleg/gfxdrv.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/gfxdrv.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: Eric Botcazou 29/11/2000
  *               Samuel Devulder 30/07/2011
diff --git a/include/alleg/gui.h b/include/alleg/gui.h
index da28bea..8e83adf 100644
--- a/include/alleg/gui.h
+++ b/include/alleg/gui.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/gui.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis 1998
  *  Modifié par: Jérémie GUILLAUME alias "JnO" 1998
  *               Eric Botcazou 24/10/2003
diff --git a/include/alleg/joyint.h b/include/alleg/joyint.h
index fb2142b..9049f60 100644
--- a/include/alleg/joyint.h
+++ b/include/alleg/joyint.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/joyint.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 14/02/2001
  *  Modifié par: François Mouret 01/11/2012
  *
diff --git a/include/alleg/mouse.h b/include/alleg/mouse.h
index 06a5684..987c165 100644
--- a/include/alleg/mouse.h
+++ b/include/alleg/mouse.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/mouse.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 1998
  *  Modifié par: Eric Botcazou octobre 1999
  *               François Mouret 01/11/2012
diff --git a/include/alleg/sound.h b/include/alleg/sound.h
index 330e4f7..f58053a 100644
--- a/include/alleg/sound.h
+++ b/include/alleg/sound.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/sound.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou avril 1999
  *  Modifié par: Eric Botcazou 24/09/2001
  *               François Mouret 01/11/2012
diff --git a/include/debug.h b/include/debug.h
index a7f39f1..585cb0d 100644
--- a/include/debug.h
+++ b/include/debug.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : to8dbg.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: Eric Botcazou 23/11/2000
  *               François Mouret 10/05/2014 14/07/2016
diff --git a/include/debug/debug.h b/include/debug/debug.h
index 19547ef..51d9365 100644
--- a/include/debug/debug.h
+++ b/include/debug/debug.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : debug/debug.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou juillet 1999
  *  Modifié par: Eric Botcazou 19/11/2006
  *               Gilles Fétis 30/07/2011
diff --git a/include/defs.h b/include/defs.h
index 7dd7dc8..69f8f23 100644
--- a/include/defs.h
+++ b/include/defs.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : intern/defs.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: Eric Botcazou 19/11/2006
  *               François Mouret 28/04/2012 20/09/2013 10/05/2014
diff --git a/include/dos/debug.h b/include/dos/debug.h
index fbf7b33..97a10e2 100644
--- a/include/dos/debug.h
+++ b/include/dos/debug.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : dos/debug.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis
  *  Modifié par: Eric Botcazou octobre 1999
  *               François Mouret 01/11/2012 14/04/2014
diff --git a/include/dos/floppy.h b/include/dos/floppy.h
index 352dc2f..763b30a 100644
--- a/include/dos/floppy.h
+++ b/include/dos/floppy.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : dos/floppy.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Alexandre Pukall mai 1998
  *  Modifié par: Eric Botcazou 03/1/2003
  *               François Mouret 06/11/2012
diff --git a/include/dos/keybint.h b/include/dos/keybint.h
index 4e71bb4..313a9ad 100644
--- a/include/dos/keybint.h
+++ b/include/dos/keybint.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : dos/keybint.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: François Mouret 01/11/2012
  *
diff --git a/include/dos/memmng.h b/include/dos/memmng.h
index e18a816..2977ec8 100644
--- a/include/dos/memmng.h
+++ b/include/dos/memmng.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : dos/memmng.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 1998
  *  Modifié par: Eric Botcazou octobre 1999
  *
diff --git a/include/errors.h b/include/errors.h
index ca02a72..25010ac 100644
--- a/include/errors.h
+++ b/include/errors.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : error.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 22/11/2000
  *  Modifié par: François Mouret 01/11/2012 23/08/2015
  *
diff --git a/include/file/bmp.h b/include/file/bmp.h
index c5f192f..6874ca0 100644
--- a/include/file/bmp.h
+++ b/include/file/bmp.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : file/bmp.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Mouret François 24/11/2012
  *  Modifié par:
  *
diff --git a/include/file/png.h b/include/file/png.h
index 0e291f2..938a55f 100644
--- a/include/file/png.h
+++ b/include/file/png.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : file/png.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Mouret François 24/11/2012
  *  Modifié par:
  *
diff --git a/include/hardware.h b/include/hardware.h
index 0f2045b..fbfd262 100644
--- a/include/hardware.h
+++ b/include/hardware.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : intern/hardware.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis
  *  Modifié par: Eric Botcazou 1/12/2000
  *               François Mouret 18/09/2006 02/11/2012
diff --git a/include/image.h b/include/image.h
index 87db7af..868f282 100644
--- a/include/image.h
+++ b/include/image.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : intern/image.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 02/11/2012
  *  Modifié par:
  *
diff --git a/include/ini.h b/include/ini.h
index 5854b19..0683c41 100644
--- a/include/ini.h
+++ b/include/ini.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : intern/ini.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 09/05/2012
  *  Modifié par: François Mouret 29/09/2012
  *
diff --git a/include/linux/display.h b/include/linux/display.h
index ec95207..55b3adb 100644
--- a/include/linux/display.h
+++ b/include/linux/display.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/display.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: Eric Botcazou 24/10/2003
  *               François Mouret 30/07/2011 02/06/2012 29/09/2012
diff --git a/include/linux/floppy.h b/include/linux/floppy.h
index 5bca2a1..8299bea 100644
--- a/include/linux/floppy.h
+++ b/include/linux/floppy.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/floppy.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 29/07/2000
  *  Modifié par: Eric Botcazou 03/11/2003
  *
diff --git a/include/linux/graphic.h b/include/linux/graphic.h
index 3954d15..dd16b48 100644
--- a/include/linux/graphic.h
+++ b/include/linux/graphic.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/graphic.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: François Mouret 06/11/2012
  *
diff --git a/include/linux/gui.h b/include/linux/gui.h
index 996cb62..f0af60c 100644
--- a/include/linux/gui.h
+++ b/include/linux/gui.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/gui.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou juillet 1999
  *  Modifié par: Eric Botcazou 19/11/2006
  *               Gilles Fétis 30/07/2011
diff --git a/include/linux/sound.h b/include/linux/sound.h
index 149170f..e615a5b 100644
--- a/include/linux/sound.h
+++ b/include/linux/sound.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/sound.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou août 1999
  *  Modifié par: Eric Botcazou 4/12/2000
  *               François Mouret 08/2011 24/02/2012 06/11/2012
diff --git a/include/main.h b/include/main.h
index 9e67b56..ea3ff83 100644
--- a/include/main.h
+++ b/include/main.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : intern/main.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 28/09/2012
  *  Modifié par:
  *
diff --git a/include/media/cass.h b/include/media/cass.h
index 45e0293..aee20c1 100644
--- a/include/media/cass.h
+++ b/include/media/cass.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : intern/cass.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou avril 1999
  *  Modifié par: Eric Botcazou 15/05/2000
  *               François Mouret 05/10/2012 01/11/2012
diff --git a/include/media/disk.h b/include/media/disk.h
index 0d8931c..ea18f73 100644
--- a/include/media/disk.h
+++ b/include/media/disk.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/disk.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Alexandre Pukall mai 1998
  *  Modifié par: Eric Botcazou 24/10/2003
  *               François Mouret 05/10/2012 31/08/2013 31/07/2016
diff --git a/include/media/disk/daccess.h b/include/media/disk/daccess.h
index 1a59674..bb9da45 100644
--- a/include/media/disk/daccess.h
+++ b/include/media/disk/daccess.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/disk/daccess.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 20/11/2012
  *  Modifié par:
  *
diff --git a/include/media/disk/dirdisk.h b/include/media/disk/dirdisk.h
index 0a6cb07..5db8dc4 100644
--- a/include/media/disk/dirdisk.h
+++ b/include/media/disk/dirdisk.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/disk/dirdisk.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Samuel Devulder 30/07/2011
  *  Modifié par: François Mouret 20/11/2012
  *
diff --git a/include/media/disk/fd.h b/include/media/disk/fd.h
index eec1d85..7169029 100644
--- a/include/media/disk/fd.h
+++ b/include/media/disk/fd.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/disk/fd.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 20/11/2012
  *  Modifié par:
  *
diff --git a/include/media/disk/hfe.h b/include/media/disk/hfe.h
index 1cfc74c..edd5f4d 100644
--- a/include/media/disk/hfe.h
+++ b/include/media/disk/hfe.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/disk/hfe.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 20/01/2013
  *  Modifié par:
  *
diff --git a/include/media/disk/sap.h b/include/media/disk/sap.h
index 5d44ce9..2c3d936 100644
--- a/include/media/disk/sap.h
+++ b/include/media/disk/sap.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/disk/sap.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 20/11/2012
  *  Modifié par:
  *
diff --git a/include/media/joystick.h b/include/media/joystick.h
index 1f3bb69..c7fd338 100644
--- a/include/media/joystick.h
+++ b/include/media/joystick.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : intern/joystick.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 12/02/2001
  *  Modifié par: François Mouret 01/11/2012 02/11/2012
  *
diff --git a/include/media/keyboard.h b/include/media/keyboard.h
index cc11232..15c06d3 100644
--- a/include/media/keyboard.h
+++ b/include/media/keyboard.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : intern/keyboard.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 1998
  *  Modifié par: Eric Botcazou 14/02/2001
  *               François Mouret 01/11/2012
diff --git a/include/media/memo.h b/include/media/memo.h
index 85d2e2a..32af8f6 100644
--- a/include/media/memo.h
+++ b/include/media/memo.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : intern/cass.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 05/10/2012
  *  Modifié par: 
  *
diff --git a/include/media/mouse.h b/include/media/mouse.h
index d213e06..caf8ec1 100644
--- a/include/media/mouse.h
+++ b/include/media/mouse.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : intern/mouse.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 1999
  *  Modifié par: Eric Botcazou 15/05/2000
  *               François Mouret 02/11/2012
diff --git a/include/media/printer.h b/include/media/printer.h
index 63f1dfd..1231c3f 100644
--- a/include/media/printer.h
+++ b/include/media/printer.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/printer.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 22/03/2001
  *  Modifié par: Eric Botcazou 24/03/2001
  *               François Mouret 18/04/2012 01/11/2012
diff --git a/include/media/printer/pr90042.h b/include/media/printer/pr90042.h
index cf9fe0e..e21f489 100644
--- a/include/media/printer/pr90042.h
+++ b/include/media/printer/pr90042.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Sanuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/printer/pr90042.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 26/11/2012
  *  Modifié par:
  *
diff --git a/include/media/printer/pr90055.h b/include/media/printer/pr90055.h
index 3dbd437..618f60c 100644
--- a/include/media/printer/pr90055.h
+++ b/include/media/printer/pr90055.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Sanuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/printer/pr90055.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 26/11/2012
  *  Modifié par:
  *
diff --git a/include/media/printer/pr90582.h b/include/media/printer/pr90582.h
index 8c38093..a2281a5 100644
--- a/include/media/printer/pr90582.h
+++ b/include/media/printer/pr90582.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Sanuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/printer/pr90582.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 26/11/2012
  *  Modifié par:
  *
diff --git a/include/media/printer/pr906xx.h b/include/media/printer/pr906xx.h
index f173b5e..f4a7f46 100644
--- a/include/media/printer/pr906xx.h
+++ b/include/media/printer/pr906xx.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Sanuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/printer/pr906xx.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 26/11/2012
  *  Modifié par:
  *
diff --git a/include/option.h b/include/option.h
index ce540f2..746f13a 100644
--- a/include/option.h
+++ b/include/option.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : options.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 07/10/2012
  *  Modifié par: François Mouret 31/05/2015
  *
diff --git a/include/std.h b/include/std.h
index 488ca9f..1bd48d8 100644
--- a/include/std.h
+++ b/include/std.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : intern/std.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 28/09/2012
  *  Modifié par:
  *
diff --git a/include/teo.h b/include/teo.h
index 048fc3e..3675c41 100644
--- a/include/teo.h
+++ b/include/teo.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret,
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : teo.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis
  *  Modifié par: Eric Botcazou 26/10/2003
  *               François Mouret 30/01/2010 07/08/2011 05/03/2012
@@ -63,8 +63,8 @@
 
 /* paramètres et symboles de l'émulation */
 #define APPLICATION_DIR "teo"
-#define TEO_YEAR_STRING "2017"
-#define TEO_VERSION_STR "1.8.4"
+#define TEO_YEAR_STRING "2018"
+#define TEO_VERSION_STR "1.8.5"
 #define PROG_NAME   "teo"
 #define PROG_CLASS  "EmuTO"
 
diff --git a/include/to8keys.h b/include/to8keys.h
index bd3e362..8b46751 100644
--- a/include/to8keys.h
+++ b/include/to8keys.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : key.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou
  *  Modifié par: Eric Botcazou 13/02/2001
  *               François Mouret 21/04/2013 20/10/2017
diff --git a/include/win/dialog.rh b/include/win/dialog.rh
index 6ee6a23..7192295 100644
--- a/include/win/dialog.rh
+++ b/include/win/dialog.rh
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/dialog.rh
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 14/09/2000
  *  Modifié par: Eric Botcazou 26/10/2003
  *               François Mouret 10/08/2011 17/03/2012 20/09/2012
diff --git a/include/win/gui.h b/include/win/gui.h
index 3c8f49c..ca60381 100644
--- a/include/win/gui.h
+++ b/include/win/gui.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/gui.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 28/11/2000
  *  Modifié par: Eric Botcazou 04/12/2000
  *               François Mouret 01/04/2012 10/05/2014
diff --git a/include/win/keybint.h b/include/win/keybint.h
index f9f70e1..2198a90 100644
--- a/include/win/keybint.h
+++ b/include/win/keybint.h
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/keybint.h
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: François Mouret 01/11/2012
  *
diff --git a/misc/pack/pack.sh b/misc/pack/pack.sh
index ed19244..a906d3a 100755
--- a/misc/pack/pack.sh
+++ b/misc/pack/pack.sh
@@ -19,7 +19,7 @@ if [ -z $TMPDIR ]; then
    TMPDIR="/tmp"
 fi
 
-teo_version='1.8.4'
+teo_version='1.8.5'
 cc90hfe_version='0.7.0'
 pack_dir="teoemulator-code/misc/pack"
 tmp_pack_dir="teoemulator-code/misc/pack"
diff --git a/misc/pack/repo/linux/debian/teo/DEBIAN/control b/misc/pack/repo/linux/debian/teo/DEBIAN/control
index 9013d16..badfab5 100644
--- a/misc/pack/repo/linux/debian/teo/DEBIAN/control
+++ b/misc/pack/repo/linux/debian/teo/DEBIAN/control
@@ -1,5 +1,5 @@
 Package: teo
-Version: 1.8.4
+Version: 1.8.5
 Architecture: i386
 Section: base
 Priority: optional
diff --git a/misc/pack/repo/linux/debian/teo/usr/share/applications/teo.desktop b/misc/pack/repo/linux/debian/teo/usr/share/applications/teo.desktop
index e22dfd4..5b9d8bd 100644
--- a/misc/pack/repo/linux/debian/teo/usr/share/applications/teo.desktop
+++ b/misc/pack/repo/linux/debian/teo/usr/share/applications/teo.desktop
@@ -1,5 +1,5 @@
 [Desktop Entry]
-Version=1.8.4
+Version=1.8.5
 Name=Teo emulator
 Name[fr]=Emulateur Teo
 GenericName=Teo emulator
diff --git a/misc/pack/repo/windows/inno/teo-setup.iss b/misc/pack/repo/windows/inno/teo-setup.iss
index 1aac901..e642146 100644
--- a/misc/pack/repo/windows/inno/teo-setup.iss
+++ b/misc/pack/repo/windows/inno/teo-setup.iss
@@ -3,7 +3,7 @@
 
 #define OUTPUTDIR  'misc\pack\repo'
 #define SOURCEDIR  '..\..\..\..\..'
-#define TEOVERSION  '1.8.4'
+#define TEOVERSION  '1.8.5'
 #define WEBSITE "https://sourceforge.net/projects/teoemulator/"
 
 [Setup]
diff --git a/src/alleg/acolor8.c b/src/alleg/acolor8.c
index e9d0563..87ed7d1 100644
--- a/src/alleg/acolor8.c
+++ b/src/alleg/acolor8.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/color8.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou mai 2000
  *  Modifié par: Eric Botcazou 24/10/2003
  *               François Mouret 24/10/2012
diff --git a/src/alleg/agfxdrv.c b/src/alleg/agfxdrv.c
index 6629d56..9729bca 100644
--- a/src/alleg/agfxdrv.c
+++ b/src/alleg/agfxdrv.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret,
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : alleg/gfxdrv.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: Eric Botcazou 23/09/2000
  *               Samuel Devulder 12/08/2011
diff --git a/src/alleg/agui.c b/src/alleg/agui.c
index 4134937..eac1d57 100644
--- a/src/alleg/agui.c
+++ b/src/alleg/agui.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/agui.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis 1998
  *  Modifié par: Jérémie GUILLAUME alias "JnO" 1998
  *               Eric Botcazou 28/10/2003
diff --git a/src/alleg/agui/aabout.c b/src/alleg/agui/aabout.c
index f58d223..af44e88 100644
--- a/src/alleg/agui/aabout.c
+++ b/src/alleg/agui/aabout.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/agui/aabout.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis 1998
  *  Modifié par: Jérémie GUILLAUME alias "JnO" 1998
  *               Eric Botcazou 28/10/2003
diff --git a/src/alleg/agui/acass.c b/src/alleg/agui/acass.c
index 75ef934..cde374f 100644
--- a/src/alleg/agui/acass.c
+++ b/src/alleg/agui/acass.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/agui/acass.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis 1998
  *  Modifié par: Jérémie GUILLAUME alias "JnO" 1998
  *               Eric Botcazou 28/10/2003
diff --git a/src/alleg/agui/adisk.c b/src/alleg/agui/adisk.c
index 656b8c8..98082f7 100644
--- a/src/alleg/agui/adisk.c
+++ b/src/alleg/agui/adisk.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/agui/adisk.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis 1998
  *  Modifié par: Jérémie GUILLAUME alias "JnO" 1998
  *               Eric Botcazou 28/10/2003
diff --git a/src/alleg/agui/amemo.c b/src/alleg/agui/amemo.c
index 541d28f..a19eeab 100644
--- a/src/alleg/agui/amemo.c
+++ b/src/alleg/agui/amemo.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/agui/amemo.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis 1998
  *  Modifié par: Jérémie GUILLAUME alias "JnO" 1998
  *               Eric Botcazou 28/10/2003
diff --git a/src/alleg/agui/aprinter.c b/src/alleg/agui/aprinter.c
index d115c3d..5ce0741 100644
--- a/src/alleg/agui/aprinter.c
+++ b/src/alleg/agui/aprinter.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/agui/aprinter.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis 1998
  *  Modifié par: Jérémie GUILLAUME alias "JnO" 1998
  *               Eric Botcazou 28/10/2003
diff --git a/src/alleg/agui/asetting.c b/src/alleg/agui/asetting.c
index dd0770f..b1bcf7a 100644
--- a/src/alleg/agui/asetting.c
+++ b/src/alleg/agui/asetting.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/agui/asetting.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis 1998
  *  Modifié par: Jérémie GUILLAUME alias "JnO" 1998
  *               Eric Botcazou 28/10/2003
diff --git a/src/alleg/ajoyint.c b/src/alleg/ajoyint.c
index e52dbdd..9dcc29a 100644
--- a/src/alleg/ajoyint.c
+++ b/src/alleg/ajoyint.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/joyint.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 14/02/2001
  *  Modifié par: Eric Botcazou 22/03/2001
  *               François Mouret 08/2011 02/11/2012
diff --git a/src/alleg/amode40.c b/src/alleg/amode40.c
index 7073268..bcdc38c 100644
--- a/src/alleg/amode40.c
+++ b/src/alleg/amode40.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, 
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : alleg/mode40.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis
  *  Modifié par: Eric Botcazou 24/0/2003
  *               Samuel Devulder 30/07/2011
diff --git a/src/alleg/amode80.c b/src/alleg/amode80.c
index 9c44589..170b564 100644
--- a/src/alleg/amode80.c
+++ b/src/alleg/amode80.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret,
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : alleg/mode80.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis
  *  Modifié par: Eric Botcazou 24/10/2003
  *               Samuel Devulder 30/07/2011
diff --git a/src/alleg/amouse.c b/src/alleg/amouse.c
index 0e11f38..d128f36 100644
--- a/src/alleg/amouse.c
+++ b/src/alleg/amouse.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/mouse.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 1998
  *  Modifié par: Eric Botcazou 14/10/2000
  *               François Mouret 01/11/2012
diff --git a/src/alleg/asound.c b/src/alleg/asound.c
index 30af92b..553187c 100644
--- a/src/alleg/asound.c
+++ b/src/alleg/asound.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/asound.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou avril 1999
  *  Modifié par: Eric Botcazou 24/09/2001
  *               Samuel Devulder 23/03/2010
diff --git a/src/alleg/atruecol.c b/src/alleg/atruecol.c
index 7d4386d..a875257 100644
--- a/src/alleg/atruecol.c
+++ b/src/alleg/atruecol.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : alleg/truecol.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis
  *  Modifié par: Eric Botcazou 24/10/2003
  *               Samuel Devulder 30/07/2011 10/02/2013
diff --git a/src/debug/dacc.c b/src/debug/dacc.c
index 016cbbc..4b6add3 100644
--- a/src/debug/dacc.c
+++ b/src/debug/dacc.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : debug/dacc.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 10/05/2014
  *  Modifié par: François Mouret 04/06/2015 16/11/2015 14/07/2016
  *
diff --git a/src/debug/dbkpt.c b/src/debug/dbkpt.c
index 2fd15a4..c8906cf 100644
--- a/src/debug/dbkpt.c
+++ b/src/debug/dbkpt.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : debug/dbkpt.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 10/05/2014
  *  Modifié par: François Mouret 16/11/2015 08/03/2016 14/07/2016
  *
diff --git a/src/debug/ddisass.c b/src/debug/ddisass.c
index ecabf84..9f58382 100644
--- a/src/debug/ddisass.c
+++ b/src/debug/ddisass.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : debug/ddisass.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 10/05/2014
  *  Modifié par: François Mouret 04/06/2015 14/07/2016
  *
diff --git a/src/debug/dmem.c b/src/debug/dmem.c
index 082103f..93f9208 100644
--- a/src/debug/dmem.c
+++ b/src/debug/dmem.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : debug/dmem.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 10/05/2014
  *  Modifié par: François Mouret 16/11/2015 14/07/2016
  *
diff --git a/src/debug/dreg.c b/src/debug/dreg.c
index b8cac29..081dc01 100644
--- a/src/debug/dreg.c
+++ b/src/debug/dreg.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : debug/dreg.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 10/05/2014
  *  Modifié par: François Mouret 16/11/2015 09/03/2016 14/07/2016
  *
diff --git a/src/dos/ddebug.c b/src/dos/ddebug.c
index 857e317..7add70c 100644
--- a/src/dos/ddebug.c
+++ b/src/dos/ddebug.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : dos/debug.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis 1998
  *  Modifié par: Eric Botcazou 27/11/2002
  *               François Mouret 08/2011 01/11/2012 02/06/2014 28/10/2017
diff --git a/src/dos/dfloppy.c b/src/dos/dfloppy.c
index a4463f9..747739e 100644
--- a/src/dos/dfloppy.c
+++ b/src/dos/dfloppy.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : dos/disk.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Alexandre Pukall mai 1998
  *  Modifié par: Eric Botcazou 03/11/2003
  *               François Mouret 20/09/2013
diff --git a/src/dos/dkeybint.c b/src/dos/dkeybint.c
index c2efa88..75eb3b7 100644
--- a/src/dos/dkeybint.c
+++ b/src/dos/dkeybint.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : dos/keybint.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: Eric Botcazou 23/09/2001
  *               François Mouret 28/12/2012 20/09/2013
diff --git a/src/dos/dmain.c b/src/dos/dmain.c
index a00f93e..4176978 100644
--- a/src/dos/dmain.c
+++ b/src/dos/dmain.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : dos/main.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis 1998
  *  Modifié par: Eric Botcazou 04/11/2003
  *               Samuel Devulder 08/2011
diff --git a/src/dos/dmemmng.c b/src/dos/dmemmng.c
index 1fd8ac8..6373565 100644
--- a/src/dos/dmemmng.c
+++ b/src/dos/dmemmng.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8D
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : dos/memmng.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 1998
  *  Modifié par: Eric Botcazou 23/11/2000
  *               François Mouret 08/2011 20/09/2013 02/06/2014
diff --git a/src/dos/dvga.c b/src/dos/dvga.c
index 9bacf84..0f0af62 100644
--- a/src/dos/dvga.c
+++ b/src/dos/dvga.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : dos/vga.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis
  *  Modifié par: Eric Botcazou 22/09/2001
  *               Samuel Devulder 07/2011
diff --git a/src/errors.c b/src/errors.c
index 4accaac..482bdd1 100644
--- a/src/errors.c
+++ b/src/errors.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : errors.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 22/11/2000
  *  Modifié par: Eric Botcazou 06/03/2001
  *               François Mouret 08/2011 13/01/2012 17/11/2012
diff --git a/src/file/bmp.c b/src/file/bmp.c
index 94965eb..9548e27 100644
--- a/src/file/bmp.c
+++ b/src/file/bmp.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : bmp.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 24/11/2012
  *  Modifié par:
  *
diff --git a/src/file/png.c b/src/file/png.c
index 9cc6b39..3d8a168 100644
--- a/src/file/png.c
+++ b/src/file/png.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : png.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 24/11/2012
  *  Modifié par: Samuel Devulder 10/02/2013
  *
diff --git a/src/hardware.c b/src/hardware.c
index ff68855..4cad8fd 100644
--- a/src/hardware.c
+++ b/src/hardware.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : hardware.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis
  *  Modifié par: Eric Botcazou 24/10/2003
  *               François Mouret 18/09/2006 02/02/2012 29/09/2012
diff --git a/src/image.c b/src/image.c
index 6b543cd..4e58bcb 100644
--- a/src/image.c
+++ b/src/image.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : image.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 30/11/2000
  *  Modifié par: François Mouret 26/01/2010 05/10/2012 02/11/2012
  *                               20/09/2013 31/07/2016
diff --git a/src/ini.c b/src/ini.c
index 392bd26..e3f7207 100644
--- a/src/ini.c
+++ b/src/ini.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : ini.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 24/09/2001
  *  Modifié par: Eric Botcazou 26/10/2003
  *               François Mouret 28/01/2010 14/09/2011 17/01/2012 25/04/2012
diff --git a/src/linux/udebug.c b/src/linux/udebug.c
index 6f1893b..776dddc 100644
--- a/src/linux/udebug.c
+++ b/src/linux/udebug.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/udebug.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 08/10/2013
  *  Modifié par: François Mouret 04/06/2015 14/07/2016
  *
diff --git a/src/linux/udebug/udacc.c b/src/linux/udebug/udacc.c
index 37995ab..01364cf 100644
--- a/src/linux/udebug/udacc.c
+++ b/src/linux/udebug/udacc.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/udebug/udacc.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 14/07/2016
  *  Modifié par:
  *
diff --git a/src/linux/udebug/udbkpt.c b/src/linux/udebug/udbkpt.c
index 56e9410..9f9bf82 100644
--- a/src/linux/udebug/udbkpt.c
+++ b/src/linux/udebug/udbkpt.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/udebug/udbkpt.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 14/07/2016
  *  Modifié par:
  *
diff --git a/src/linux/udebug/uddisass.c b/src/linux/udebug/uddisass.c
index a27f342..833f75c 100644
--- a/src/linux/udebug/uddisass.c
+++ b/src/linux/udebug/uddisass.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/udebug/uddisass.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 14/07/2016
  *  Modifié par:
  *
diff --git a/src/linux/udebug/udmem.c b/src/linux/udebug/udmem.c
index dc19707..3734e6f 100644
--- a/src/linux/udebug/udmem.c
+++ b/src/linux/udebug/udmem.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/udebug/udmem.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 14/07/2016
  *  Modifié par:
  *
diff --git a/src/linux/udebug/udreg.c b/src/linux/udebug/udreg.c
index 555f844..bb0de4b 100644
--- a/src/linux/udebug/udreg.c
+++ b/src/linux/udebug/udreg.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/udebug/udreg.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 14/07/2016
  *  Modifié par:
  *
diff --git a/src/linux/udebug/udstatus.c b/src/linux/udebug/udstatus.c
index affc846..bb63aee 100644
--- a/src/linux/udebug/udstatus.c
+++ b/src/linux/udebug/udstatus.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/udebug/udstatus.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 14/07/2016
  *  Modifié par:
  *
diff --git a/src/linux/udebug/udtoolb.c b/src/linux/udebug/udtoolb.c
index c5b9774..effd4f5 100644
--- a/src/linux/udebug/udtoolb.c
+++ b/src/linux/udebug/udtoolb.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/udebug/udstatus.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 14/07/2016
  *  Modifié par:
  *
diff --git a/src/linux/udisplay.c b/src/linux/udisplay.c
index bac7826..e124d0c 100644
--- a/src/linux/udisplay.c
+++ b/src/linux/udisplay.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/udisplay.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: Eric Botcazou 24/11/2003
  *               François Mouret 26/01/2010 08/2011 02/06/2012 28/12/2012
diff --git a/src/linux/ufloppy.c b/src/linux/ufloppy.c
index 53b77be..60e4dcf 100644
--- a/src/linux/ufloppy.c
+++ b/src/linux/ufloppy.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/disk.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 29/07/2000
  *  Modifié par: Eric Botcazou 05/11/2003
  *               Gilles Fétis 07/09/2011
diff --git a/src/linux/ugraphic.c b/src/linux/ugraphic.c
index 03e89e8..591b02e 100644
--- a/src/linux/ugraphic.c
+++ b/src/linux/ugraphic.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret,
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : linux/graphic.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: Eric Botcazou 24/10/2003
  *               François Mouret 26/01/2010 08/2011 25/04/2012
diff --git a/src/linux/ugui.c b/src/linux/ugui.c
index 5746641..0efa545 100644
--- a/src/linux/ugui.c
+++ b/src/linux/ugui.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/ugui.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou juillet 1999
  *  Modifié par: Eric Botcazou 19/11/2006
  *               Gilles Fétis 07/2011
diff --git a/src/linux/ugui/uabout.c b/src/linux/ugui/uabout.c
index d703b92..22b5ac3 100644
--- a/src/linux/ugui/uabout.c
+++ b/src/linux/ugui/uabout.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/ugui/uabout.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 21/03/2012
  *  Modifié par: François Mouret 22/09/2012
  *
diff --git a/src/linux/ugui/ucass.c b/src/linux/ugui/ucass.c
index 28806bd..c9657f1 100644
--- a/src/linux/ugui/ucass.c
+++ b/src/linux/ugui/ucass.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/ugui/ucass.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou juillet 1999
  *  Modifié par: Eric Botcazou 19/11/2006
  *               Gilles Fétis 27/07/2011
diff --git a/src/linux/ugui/udisk.c b/src/linux/ugui/udisk.c
index 640ea73..d06f066 100644
--- a/src/linux/ugui/udisk.c
+++ b/src/linux/ugui/udisk.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/ugui/udisk.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou juillet 1999
  *  Modifié par: Eric Botcazou 19/11/2006
  *               Gilles Fétis 27/07/2011
diff --git a/src/linux/ugui/umemo.c b/src/linux/ugui/umemo.c
index b3d342a..067e451 100644
--- a/src/linux/ugui/umemo.c
+++ b/src/linux/ugui/umemo.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/ugui/umemo.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou juillet 1999
  *  Modifié par: Eric Botcazou 19/11/2006
  *               Gilles Fétis 27/07/2011
diff --git a/src/linux/ugui/uprinter.c b/src/linux/ugui/uprinter.c
index 7627f3d..f37bfdc 100644
--- a/src/linux/ugui/uprinter.c
+++ b/src/linux/ugui/uprinter.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/ugui/uprinter.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 18/04/2012
  *  Modifié par: François Mouret 29/10/2012 13/04/2014 31/05/2015
  *
diff --git a/src/linux/ugui/usetting.c b/src/linux/ugui/usetting.c
index 93459a0..db0e57d 100644
--- a/src/linux/ugui/usetting.c
+++ b/src/linux/ugui/usetting.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/ugui/usetting.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou juillet 1999
  *  Modifié par: Eric Botcazou 19/11/2006
  *               Gilles Fétis 27/07/2011
diff --git a/src/linux/umain.c b/src/linux/umain.c
index e2a1383..208fbdd 100644
--- a/src/linux/umain.c
+++ b/src/linux/umain.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : linux/main.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: Eric Botcazou 19/11/2006
  *               François Mouret 26/01/2010 08/2011 23/03/2012
@@ -315,7 +315,7 @@ int main(int argc, char *argv[])
     printf((is_fr?"Voici %s l'Ã©mulateur Thomson TO8.\n"
                  :"Here's %s the thomson TO8 emulator.\n"),
                  "Teo "TEO_VERSION_STR" (Linux/X11)");
-    printf("Copyright (C) 1997-2017 Gilles FÃ©tis, Eric Botcazou, "
+    printf("Copyright (C) 1997-2018 Gilles FÃ©tis, Eric Botcazou, "
            "Alexandre Pukall, FranÃ§ois Mouret, Samuel Devulder.\n\n");
     printf((is_fr?"Touches: [ESC] Panneau de contrÃ´le\n"
                  :"Keys : [ESC] Control pannel\n"));
diff --git a/src/linux/usound.c b/src/linux/usound.c
index 3d4e1fd..79e44c3 100644
--- a/src/linux/usound.c
+++ b/src/linux/usound.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : linux/sound.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou août 1999
  *  Modifié par: Eric Botcazou 24/10/2003
  *               Gilles Fétis 07/2011
diff --git a/src/media/cass.c b/src/media/cass.c
index e06de24..f935fbb 100644
--- a/src/media/cass.c
+++ b/src/media/cass.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret,
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : cass.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou avril 1999
  *  Modifié par: Eric Botcazou 28/10/2003
  *               Samuel Devulder 05/02/2012
diff --git a/src/media/disk.c b/src/media/disk.c
index 1d9724a..ff07dc2 100644
--- a/src/media/disk.c
+++ b/src/media/disk.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret,
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : media/disk.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Alexandre Pukall mai 1998
  *  Modifié par: Eric Botcazou 03/11/2003
  *               François Mouret 15/09/2006 26/01/2010 12/01/2012 25/04/2012
diff --git a/src/media/disk/controlr/thmfc1.c b/src/media/disk/controlr/thmfc1.c
index 3b855f9..31c455a 100644
--- a/src/media/disk/controlr/thmfc1.c
+++ b/src/media/disk/controlr/thmfc1.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret,
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : media/disk/controlr/thmfc1.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Francois Mouret 24/05/2012
  *  Modifié par: François Mouret 31/08/2013 31/07/2016
  *
diff --git a/src/media/disk/daccess.c b/src/media/disk/daccess.c
index 0af3917..8d8c80c 100644
--- a/src/media/disk/daccess.c
+++ b/src/media/disk/daccess.c
@@ -14,7 +14,7 @@
  *
  *                  L'Ã©mulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles FÃ©tis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles FÃ©tis, Eric Botcazou, Alexandre Pukall,
  *                          JÃ©rÃ©mie Guillaume, FranÃ§ois Mouret,
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : media/disk/daccess.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  CrÃ©Ã© par   : FranÃ§ois Mouret 21/01/2013
  *  ModifiÃ© par: FranÃ§ois Mouret & Eric Botcazou 31/07/2016
  *
diff --git a/src/media/disk/fd.c b/src/media/disk/fd.c
index 58fb255..ad296a1 100644
--- a/src/media/disk/fd.c
+++ b/src/media/disk/fd.c
@@ -14,7 +14,7 @@
  *
  *                  L'Ã©mulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles FÃ©tis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles FÃ©tis, Eric Botcazou, Alexandre Pukall,
  *                          JÃ©rÃ©mie Guillaume, FranÃ§ois Mouret,
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : media/disk/fd.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  CrÃ©Ã© par   : FranÃ§ois Mouret 21/01/2013
  *  ModifiÃ© par: FranÃ§ois Mouret 23/08/2015 31/07/2016
  *
diff --git a/src/media/disk/hfe.c b/src/media/disk/hfe.c
index b6fb270..20c6ae7 100644
--- a/src/media/disk/hfe.c
+++ b/src/media/disk/hfe.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/disk/hfe.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 08/11/2012
  *  Modifié par: François Mouret 31/07/2016
  *
diff --git a/src/media/disk/sap.c b/src/media/disk/sap.c
index 9f03cc5..0fbe4fc 100644
--- a/src/media/disk/sap.c
+++ b/src/media/disk/sap.c
@@ -14,7 +14,7 @@
  *
  *                  L'Ã©mulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles FÃ©tis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles FÃ©tis, Eric Botcazou, Alexandre Pukall,
  *                          JÃ©rÃ©mie Guillaume, FranÃ§ois Mouret,
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : media/disk/sap.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  CrÃ©Ã© par   : Alexandre Pukall mai 1998
  *  ModifiÃ© par: Eric Botcazou 03/11/2003
  *               FranÃ§ois Mouret 15/09/2006 26/01/2010 12/01/2012 25/04/2012
diff --git a/src/media/joystick.c b/src/media/joystick.c
index f6c5458..06d74dd 100644
--- a/src/media/joystick.c
+++ b/src/media/joystick.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : joystick.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 12/02/2001
  *  Modifié par: Eric Botcazou 06/03/2001
  *
diff --git a/src/media/keyboard.c b/src/media/keyboard.c
index 5396690..3e08c27 100644
--- a/src/media/keyboard.c
+++ b/src/media/keyboard.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : keyboard.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 1998
  *  Modifié par: Eric Botcazou 17/09/2001
  *               François Mouret 02/11/2012 20/10/2017
diff --git a/src/media/memo.c b/src/media/memo.c
index 7b207d4..92ddb28 100644
--- a/src/media/memo.c
+++ b/src/media/memo.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret,
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : memo.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis
  *  Modifié par: Eric Botcazou 03/11/2003
  *               François Mouret 25/09/2006 26/01/2010 18/03/2012
diff --git a/src/media/mouse.c b/src/media/mouse.c
index 6e37e69..bc3ae24 100644
--- a/src/media/mouse.c
+++ b/src/media/mouse.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, 
  *                          Samuel Devulder
  *
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : mouse.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 1999
  *  Modifié par: Eric Botcazou 13/02/2001
  *               Samuel Devulder 05/02/2012
diff --git a/src/media/printer.c b/src/media/printer.c
index b5d98d4..3850e47 100644
--- a/src/media/printer.c
+++ b/src/media/printer.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : printer.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 22/03/2001
  *  Modifié par: Eric Botcazou 30/03/2001
  *               François Mouret 14/04/2012 02/11/2012
diff --git a/src/media/printer/pr90042.c b/src/media/printer/pr90042.c
index 3f1ef12..7db9029 100644
--- a/src/media/printer/pr90042.c
+++ b/src/media/printer/pr90042.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/printer/pr90042.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 26/11/2012
  *  Modifié par:
  *
diff --git a/src/media/printer/pr90055.c b/src/media/printer/pr90055.c
index 8458e82..d1461a8 100644
--- a/src/media/printer/pr90055.c
+++ b/src/media/printer/pr90055.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/printer/pr90055.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 26/11/2012
  *  Modifié par:
  *
diff --git a/src/media/printer/pr90582.c b/src/media/printer/pr90582.c
index 0542273..5348329 100644
--- a/src/media/printer/pr90582.c
+++ b/src/media/printer/pr90582.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/printer/pr90582.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 26/11/2012
  *  Modifié par:
  *
diff --git a/src/media/printer/pr906xx.c b/src/media/printer/pr906xx.c
index 8e23adb..aae56b2 100644
--- a/src/media/printer/pr906xx.c
+++ b/src/media/printer/pr906xx.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : media/printer/pr906xx.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 26/11/2012
  *  Modifié par:
  *
diff --git a/src/option.c b/src/option.c
index dc98145..16221ac 100644
--- a/src/option.c
+++ b/src/option.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : option.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 02/10/2012 & Samuel Devulder 30/07/2011
  *  Modifié par: François Mouret 31/07/2016
  *
diff --git a/src/readme.txt b/src/readme.txt
index 673282d..ab54fd8 100644
--- a/src/readme.txt
+++ b/src/readme.txt
@@ -13,9 +13,9 @@
                   TT        EEEEEEEEEEEEEE  OOOOOOOOOOOOOO
 
                         L'émulateur Thomson TO8
-                              version 1.8.4
+                              version 1.8.5
 
-    Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+    Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
                             Jérémie Guillaume, François Mouret,
                             Samuel Devulder
 
diff --git a/src/std.c b/src/std.c
index 663f2bb..03f8523 100644
--- a/src/std.c
+++ b/src/std.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : std.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 28/09/2012
  *  Modifié par:
  *
diff --git a/src/teo.c b/src/teo.c
index 4889480..ba0df67 100644
--- a/src/teo.c
+++ b/src/teo.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret,
  *                          Samuel Devulder
  *  
@@ -35,7 +35,7 @@
 
 /*
  *  Module     : to8.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis
  *  Modifié par: Eric Botcazou 03/11/2003
  *               François Mouret 25/09/2006 26/01/2010 18/03/2012
diff --git a/src/win/wdebug.c b/src/win/wdebug.c
index abf865a..522db51 100644
--- a/src/win/wdebug.c
+++ b/src/win/wdebug.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wgui/wdebug.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 08/10/2013
  *  Modifié par: François Mouret 04/06/2015 15/07/2016
  *
diff --git a/src/win/wdebug/wdacc.c b/src/win/wdebug/wdacc.c
index 027927b..f9f4dbd 100644
--- a/src/win/wdebug/wdacc.c
+++ b/src/win/wdebug/wdacc.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wdebug/wdacc.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 10/05/2014
  *  Modifié par: François Mouret 04/06/2015 15/07/2016
  *
diff --git a/src/win/wdebug/wdbkpt.c b/src/win/wdebug/wdbkpt.c
index 88f3668..ee44fbf 100644
--- a/src/win/wdebug/wdbkpt.c
+++ b/src/win/wdebug/wdbkpt.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wdebug/wdbkpt.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 10/05/2014
  *  Modifié par: François Mouret 15/07/2016
  *
diff --git a/src/win/wdebug/wddisass.c b/src/win/wdebug/wddisass.c
index 5b7b89b..2542ab0 100644
--- a/src/win/wdebug/wddisass.c
+++ b/src/win/wdebug/wddisass.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wdebug/wddisass.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 10/05/2014
  *  Modifié par: François Mouret 04/06/2015 15/07/2016
  *
diff --git a/src/win/wdebug/wdmem.c b/src/win/wdebug/wdmem.c
index de0cae5..f04c5d5 100644
--- a/src/win/wdebug/wdmem.c
+++ b/src/win/wdebug/wdmem.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wdebug/wdmem.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 10/05/2014
  *  Modifié par: François Mouret 15/07/2016
  *
diff --git a/src/win/wdebug/wdreg.c b/src/win/wdebug/wdreg.c
index cc2746e..8da6476 100644
--- a/src/win/wdebug/wdreg.c
+++ b/src/win/wdebug/wdreg.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wdebug/wdreg.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 10/05/2014
  *  Modifié par: François Mouret 15/07/2016
  *
diff --git a/src/win/wdebug/wdstatus.c b/src/win/wdebug/wdstatus.c
index a48e2b4..c3bd2ff 100644
--- a/src/win/wdebug/wdstatus.c
+++ b/src/win/wdebug/wdstatus.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wdebug/wdstatus.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 10/05/2014
  *  Modifié par: François Mouret 15/07/2016
  *
diff --git a/src/win/wdebug/wdtoolb.c b/src/win/wdebug/wdtoolb.c
index c507a90..77b8498 100644
--- a/src/win/wdebug/wdtoolb.c
+++ b/src/win/wdebug/wdtoolb.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wdebug/wdstatus.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Gilles Fétis & François Mouret 10/05/2014
  *  Modifié par: 
  *
diff --git a/src/win/wdialog.rc b/src/win/wdialog.rc
index 4e52608..bac21d1 100644
--- a/src/win/wdialog.rc
+++ b/src/win/wdialog.rc
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/dialog.rc
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 14/09/2000
  *  Modifié par: Eric Botcazou 26/10/2003
  *               François Mouret 27/09/2006 26/01/2010 10/08/2011
@@ -71,8 +71,8 @@ leave_ico    ICON   "src/win/wdebug/leave.ico"
 
 
 1 VERSIONINFO 
-FILEVERSION 1, 8, 4, 0
-PRODUCTVERSION 1, 8, 4, 0
+FILEVERSION 1, 8, 5, 0
+PRODUCTVERSION 1, 8, 5, 0
 FILEOS VOS__WINDOWS32
 FILETYPE VFT_APP
 {
@@ -89,7 +89,7 @@ FILETYPE VFT_APP
             VALUE "FileDescription", "Teo - l'émulateur TO8"
             VALUE "FileVersion", TEO_VERSION_STR
             VALUE "InternalName", "TEOW.EXE"
-            VALUE "LegalCopyright", "Copyright © 1997-2017 Teo Developers"
+            VALUE "LegalCopyright", "Copyright © 1997-2018 Teo Developers"
             VALUE "OriginalFilename", "TEOW.EXE"
             VALUE "ProductName", "Teo"
             VALUE "ProductVersion", TEO_VERSION_STR
diff --git a/src/win/wgui.c b/src/win/wgui.c
index 975c5a9..c0a69b4 100644
--- a/src/win/wgui.c
+++ b/src/win/wgui.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/gui.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 28/11/2000
  *  Modifié par: Eric Botcazou 28/10/2003
  *               François Mouret 17/09/2006 28/08/2011 18/03/2012
diff --git a/src/win/wgui/wabout.c b/src/win/wgui/wabout.c
index 559fce6..e6d012c 100644
--- a/src/win/wgui/wabout.c
+++ b/src/win/wgui/wabout.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wgui/wabout.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 28/11/2000
  *  Modifié par: Eric Botcazou 28/10/2003
  *               François Mouret 17/09/2006 28/08/2011 18/03/2012
diff --git a/src/win/wgui/wcass.c b/src/win/wgui/wcass.c
index e68839f..0ed05de 100644
--- a/src/win/wgui/wcass.c
+++ b/src/win/wgui/wcass.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wcass.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 28/11/2000
  *  Modifié par: Eric Botcazou 28/10/2003
  *               François Mouret 17/09/2006 28/08/2011 18/03/2012
diff --git a/src/win/wgui/wdisk.c b/src/win/wgui/wdisk.c
index fa0b285..6f4ae65 100644
--- a/src/win/wgui/wdisk.c
+++ b/src/win/wgui/wdisk.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wgui/wdisk.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 28/11/2000
  *  Modifié par: Eric Botcazou 28/10/2003
  *               François Mouret 17/09/2006 28/08/2011 18/03/2012
diff --git a/src/win/wgui/wmemo.c b/src/win/wgui/wmemo.c
index 18f1c19..a63ac1f 100644
--- a/src/win/wgui/wmemo.c
+++ b/src/win/wgui/wmemo.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wgui/wmemo.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 28/11/2000
  *  Modifié par: Eric Botcazou 28/10/2003
  *               François Mouret 17/09/2006 28/08/2011 18/03/2012
diff --git a/src/win/wgui/wprinter.c b/src/win/wgui/wprinter.c
index 6fe22e1..2fa51b2 100644
--- a/src/win/wgui/wprinter.c
+++ b/src/win/wgui/wprinter.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/wgui/wprinter.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : François Mouret 22/04/2012
  *  Modifié par: François Mouret 24/10/2012 20/09/2013 10/05/2014
  *
diff --git a/src/win/wgui/wsetting.c b/src/win/wgui/wsetting.c
index a647372..a9fe57b 100644
--- a/src/win/wgui/wsetting.c
+++ b/src/win/wgui/wsetting.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : wsetting.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou 28/11/2000
  *  Modifié par: Eric Botcazou 28/10/2003
  *               François Mouret 17/09/2006 28/08/2011 18/03/2012
diff --git a/src/win/wkeybint.c b/src/win/wkeybint.c
index ce0c75b..1e21a48 100644
--- a/src/win/wkeybint.c
+++ b/src/win/wkeybint.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/keybint.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou octobre 1999
  *  Modifié par: Eric Botcazou 17/09/2001
  *               François Mouret 01/11/2012 10/05/2014
diff --git a/src/win/wmain.c b/src/win/wmain.c
index ab2ba2e..47081fd 100644
--- a/src/win/wmain.c
+++ b/src/win/wmain.c
@@ -14,7 +14,7 @@
  *
  *                  L'émulateur Thomson TO8
  *
- *  Copyright (C) 1997-2017 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
+ *  Copyright (C) 1997-2018 Gilles Fétis, Eric Botcazou, Alexandre Pukall,
  *                          Jérémie Guillaume, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 
 /*
  *  Module     : win/main.c
- *  Version    : 1.8.4
+ *  Version    : 1.8.5
  *  Créé par   : Eric Botcazou septembre 2000
  *  Modifié par: Eric Botcazou 24/10/2003
  *               Samuel Devulder 30/07/2011
diff --git a/tools/cc90hfe/include/cc90.h b/tools/cc90hfe/include/cc90.h
index 1efd26a..0784d61 100644
--- a/tools/cc90hfe/include/cc90.h
+++ b/tools/cc90hfe/include/cc90.h
@@ -2,7 +2,7 @@
  * cc90hfe - Disk image maker for Thomson
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/defs.h b/tools/cc90hfe/include/defs.h
index 695b90d..9fa154b 100644
--- a/tools/cc90hfe/include/defs.h
+++ b/tools/cc90hfe/include/defs.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -53,8 +53,8 @@
 #define PROG_VERSION_MICRO "0"
 #define PROG_VERSION_STRING PROG_VERSION_MAJOR"."PROG_VERSION_MINOR
 
-#define PROG_CREATION_MONTH "January"
-#define PROG_CREATION_YEAR "2017"
+#define PROG_CREATION_MONTH "April"
+#define PROG_CREATION_YEAR "2018"
 #define PROG_WEB_SITE       "http://sourceforge.net/projects/teoemulator/"
 #define PROG_WEB_FORUM      "http://www.logicielsmoto.com/"
 #define PROG_DESCRIPTION    "Serial transfers for CC90-232"
diff --git a/tools/cc90hfe/include/encode.h b/tools/cc90hfe/include/encode.h
index 7189471..1bb8a4d 100644
--- a/tools/cc90hfe/include/encode.h
+++ b/tools/cc90hfe/include/encode.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/errors.h b/tools/cc90hfe/include/errors.h
index 194842f..b87c78c 100644
--- a/tools/cc90hfe/include/errors.h
+++ b/tools/cc90hfe/include/errors.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/hfe.h b/tools/cc90hfe/include/hfe.h
index 1dce3af..2029d0d 100644
--- a/tools/cc90hfe/include/hfe.h
+++ b/tools/cc90hfe/include/hfe.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/ini.h b/tools/cc90hfe/include/ini.h
index 4607d7d..c2479f8 100644
--- a/tools/cc90hfe/include/ini.h
+++ b/tools/cc90hfe/include/ini.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/linux/gui.h b/tools/cc90hfe/include/linux/gui.h
index ea82d85..f8585fc 100644
--- a/tools/cc90hfe/include/linux/gui.h
+++ b/tools/cc90hfe/include/linux/gui.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/linux/progress.h b/tools/cc90hfe/include/linux/progress.h
index 5ff3f17..27f79e5 100644
--- a/tools/cc90hfe/include/linux/progress.h
+++ b/tools/cc90hfe/include/linux/progress.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/main.h b/tools/cc90hfe/include/main.h
index 1e5f463..cbdbda7 100644
--- a/tools/cc90hfe/include/main.h
+++ b/tools/cc90hfe/include/main.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/option.h b/tools/cc90hfe/include/option.h
index a9b4159..f66bd38 100644
--- a/tools/cc90hfe/include/option.h
+++ b/tools/cc90hfe/include/option.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/port.h b/tools/cc90hfe/include/port.h
index fb6c72a..b76017e 100644
--- a/tools/cc90hfe/include/port.h
+++ b/tools/cc90hfe/include/port.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/serial.h b/tools/cc90hfe/include/serial.h
index 91836be..aeb5c3c 100644
--- a/tools/cc90hfe/include/serial.h
+++ b/tools/cc90hfe/include/serial.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/std.h b/tools/cc90hfe/include/std.h
index f95eddd..2a06d70 100644
--- a/tools/cc90hfe/include/std.h
+++ b/tools/cc90hfe/include/std.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/win/gui.h b/tools/cc90hfe/include/win/gui.h
index ae6ed8c..3e08c46 100644
--- a/tools/cc90hfe/include/win/gui.h
+++ b/tools/cc90hfe/include/win/gui.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/win/progress.h b/tools/cc90hfe/include/win/progress.h
index 839dc46..0299bc1 100644
--- a/tools/cc90hfe/include/win/progress.h
+++ b/tools/cc90hfe/include/win/progress.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/include/win/resource.h b/tools/cc90hfe/include/win/resource.h
index 8dc0285..a4aa29a 100644
--- a/tools/cc90hfe/include/win/resource.h
+++ b/tools/cc90hfe/include/win/resource.h
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/cc90.c b/tools/cc90hfe/src/cc90.c
index 55d07e9..a3cb4db 100644
--- a/tools/cc90hfe/src/cc90.c
+++ b/tools/cc90hfe/src/cc90.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 François Mouret
+ *  Copyright (C) 2012-2018 François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/encode.c b/tools/cc90hfe/src/encode.c
index 8c6bf31..c6d2de0 100644
--- a/tools/cc90hfe/src/encode.c
+++ b/tools/cc90hfe/src/encode.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 François Mouret
+ *  Copyright (C) 2012-2018 François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/errors.c b/tools/cc90hfe/src/errors.c
index 038b4ef..341fe43 100644
--- a/tools/cc90hfe/src/errors.c
+++ b/tools/cc90hfe/src/errors.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 François Mouret
+ *  Copyright (C) 2012-2018 François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/hfe.c b/tools/cc90hfe/src/hfe.c
index 9b3fde3..b1fd926 100644
--- a/tools/cc90hfe/src/hfe.c
+++ b/tools/cc90hfe/src/hfe.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 François Mouret
+ *  Copyright (C) 2012-2018 François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/ini.c b/tools/cc90hfe/src/ini.c
index c5e658b..0a45e79 100644
--- a/tools/cc90hfe/src/ini.c
+++ b/tools/cc90hfe/src/ini.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 François Mouret
+ *  Copyright (C) 2012-2018 François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/linux/gui.c b/tools/cc90hfe/src/linux/gui.c
index e6e5cf5..638f106 100644
--- a/tools/cc90hfe/src/linux/gui.c
+++ b/tools/cc90hfe/src/linux/gui.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/linux/gui/about.c b/tools/cc90hfe/src/linux/gui/about.c
index da50361..4ec31e1 100644
--- a/tools/cc90hfe/src/linux/gui/about.c
+++ b/tools/cc90hfe/src/linux/gui/about.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -48,7 +48,7 @@ void about_Callback (GtkButton *button, gpointer user_data)
     gtk_show_about_dialog (GTK_WINDOW(main_window),
                            "program-name", PROG_NAME,
                            "version", "version "PROG_VERSION_STRING,
-                           "copyright", "Copyright Â© 2012-2017"PROG_CREATION_YEAR,
+                           "copyright", "Copyright Â© 2012-2018"PROG_CREATION_YEAR,
                            "website", PROG_WEB_SITE,
                            "website-label", is_fr?PROG_NAME" sur SourceForge (Teo module)"
                                                  :PROG_NAME" on SourceForge (Teo module)",
diff --git a/tools/cc90hfe/src/linux/gui/archive.c b/tools/cc90hfe/src/linux/gui/archive.c
index 9ab3aa4..54520a1 100644
--- a/tools/cc90hfe/src/linux/gui/archive.c
+++ b/tools/cc90hfe/src/linux/gui/archive.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/linux/gui/extract.c b/tools/cc90hfe/src/linux/gui/extract.c
index be577ee..988c30b 100644
--- a/tools/cc90hfe/src/linux/gui/extract.c
+++ b/tools/cc90hfe/src/linux/gui/extract.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/linux/gui/install.c b/tools/cc90hfe/src/linux/gui/install.c
index b3e7c30..d6d0724 100644
--- a/tools/cc90hfe/src/linux/gui/install.c
+++ b/tools/cc90hfe/src/linux/gui/install.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/linux/port.c b/tools/cc90hfe/src/linux/port.c
index 468b15f..aaaaf1f 100644
--- a/tools/cc90hfe/src/linux/port.c
+++ b/tools/cc90hfe/src/linux/port.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/linux/progress.c b/tools/cc90hfe/src/linux/progress.c
index dcad341..31aca82 100644
--- a/tools/cc90hfe/src/linux/progress.c
+++ b/tools/cc90hfe/src/linux/progress.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/linux/serial.c b/tools/cc90hfe/src/linux/serial.c
index 2b7004d..2417b79 100644
--- a/tools/cc90hfe/src/linux/serial.c
+++ b/tools/cc90hfe/src/linux/serial.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/main.c b/tools/cc90hfe/src/main.c
index b4771f4..74fe64f 100644
--- a/tools/cc90hfe/src/main.c
+++ b/tools/cc90hfe/src/main.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 François Mouret
+ *  Copyright (C) 2012-2018 François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/option.c b/tools/cc90hfe/src/option.c
index 314c852..9e7e4a9 100644
--- a/tools/cc90hfe/src/option.c
+++ b/tools/cc90hfe/src/option.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 François Mouret
+ *  Copyright (C) 2012-2018 François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/std.c b/tools/cc90hfe/src/std.c
index e9ebc5b..26b7295 100644
--- a/tools/cc90hfe/src/std.c
+++ b/tools/cc90hfe/src/std.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 François Mouret
+ *  Copyright (C) 2012-2018 François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/win/gui.c b/tools/cc90hfe/src/win/gui.c
index 0935759..07df2cb 100644
--- a/tools/cc90hfe/src/win/gui.c
+++ b/tools/cc90hfe/src/win/gui.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret, Samuel Devulder
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret, Samuel Devulder
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/win/gui/about.c b/tools/cc90hfe/src/win/gui/about.c
index 32406ff..46da7cd 100644
--- a/tools/cc90hfe/src/win/gui/about.c
+++ b/tools/cc90hfe/src/win/gui/about.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/win/gui/archive.c b/tools/cc90hfe/src/win/gui/archive.c
index 35249f3..7d7ea40 100644
--- a/tools/cc90hfe/src/win/gui/archive.c
+++ b/tools/cc90hfe/src/win/gui/archive.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/win/gui/extract.c b/tools/cc90hfe/src/win/gui/extract.c
index 4e1202d..56a6bae 100644
--- a/tools/cc90hfe/src/win/gui/extract.c
+++ b/tools/cc90hfe/src/win/gui/extract.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/win/gui/install.c b/tools/cc90hfe/src/win/gui/install.c
index 3d45372..52b9f3e 100644
--- a/tools/cc90hfe/src/win/gui/install.c
+++ b/tools/cc90hfe/src/win/gui/install.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/win/port.c b/tools/cc90hfe/src/win/port.c
index e90c5f9..d55e62a 100644
--- a/tools/cc90hfe/src/win/port.c
+++ b/tools/cc90hfe/src/win/port.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/win/progress.c b/tools/cc90hfe/src/win/progress.c
index 38397c7..c474226 100644
--- a/tools/cc90hfe/src/win/progress.c
+++ b/tools/cc90hfe/src/win/progress.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/win/resource.rc b/tools/cc90hfe/src/win/resource.rc
index 9e2d9ab..7033f60 100644
--- a/tools/cc90hfe/src/win/resource.rc
+++ b/tools/cc90hfe/src/win/resource.rc
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff --git a/tools/cc90hfe/src/win/serial.c b/tools/cc90hfe/src/win/serial.c
index 542ece7..827b536 100644
--- a/tools/cc90hfe/src/win/serial.c
+++ b/tools/cc90hfe/src/win/serial.c
@@ -2,7 +2,7 @@
  * cc90hfe (c) Teo Developers
  *********************************************************
  *
- *  Copyright (C) 2012-2017 Yves Charriau, François Mouret
+ *  Copyright (C) 2012-2018 Yves Charriau, François Mouret
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
-- 
2.17.1


From b757fb519dc742efa57483af81caa540d5ec0308 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Sun, 8 Apr 2018 19:14:29 +0200
Subject: [PATCH 09/33] Improvement of the disk controller (thanks to emulix75)

track.curr and track.last must not be cleared until at least a cold reset of
the computer, because the registers $6052 and $6254, which are the number of
the current track respectively for the controlers 0 and 1, needed to move the
drive heads, are not cleared until a cold reset is done.
---
 src/media/disk/daccess.c | 2 --
 src/media/disk/fd.c      | 2 --
 src/media/disk/hfe.c     | 2 --
 src/media/disk/sap.c     | 2 --
 src/teo.c                | 8 ++++++++
 5 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/src/media/disk/daccess.c b/src/media/disk/daccess.c
index 8d8c80c..690c204 100644
--- a/src/media/disk/daccess.c
+++ b/src/media/disk/daccess.c
@@ -264,8 +264,6 @@ int daccess_LoadDisk (int drive, const char filename[])
         disk[drive].track_count = TEO_DISK_DD_TRACK_NUMBER;
         disk[drive].track_size = TEO_DISK_DD_TRACK_SIZE;
         disk[drive].byte_rate = TEO_DISK_DD_BYTE_RATE;
-        disk[drive].drv->track.curr = 0;
-        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
 
         /* update parameters */
         teo.disk[drive].file = std_free (teo.disk[drive].file);
diff --git a/src/media/disk/fd.c b/src/media/disk/fd.c
index ad296a1..63774d9 100644
--- a/src/media/disk/fd.c
+++ b/src/media/disk/fd.c
@@ -369,8 +369,6 @@ int fd_LoadDisk (int drive, const char filename[])
         }
         disk[drive].sector_size  = fd_list[fd_type].sector_size;
         disk[drive].track_count  = fd_list[fd_type].track_count;
-        disk[drive].drv->track.curr = 0;
-        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
         disk[drive].state = TEO_DISK_ACCESS_FD;
         disk[drive].write_protect = FALSE;
         disk[drive].ReadSector = NULL;
diff --git a/src/media/disk/hfe.c b/src/media/disk/hfe.c
index 20c6ae7..9e9b264 100644
--- a/src/media/disk/hfe.c
+++ b/src/media/disk/hfe.c
@@ -726,8 +726,6 @@ int hfe_LoadDisk(int drive, const char filename[])
                 break;
         }
         disk[drive].track_count = hfe_hd.number_of_track;
-        disk[drive].drv->track.curr = 0;
-        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
         disk[drive].state = TEO_DISK_ACCESS_HFE;
         disk[drive].write_protect = (hfe_hd.write_allowed != 0xff)?TRUE:FALSE;
         disk[drive].ReadSector = NULL;
diff --git a/src/media/disk/sap.c b/src/media/disk/sap.c
index 0fbe4fc..b3fbd5c 100644
--- a/src/media/disk/sap.c
+++ b/src/media/disk/sap.c
@@ -494,8 +494,6 @@ int sap_LoadDisk(int drive, const char filename[])
                 disk[drive].WriteTrack = write_fm_track;
                 break;
         }
-        disk[drive].drv->track.curr = 0;
-        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
         disk[drive].state = TEO_DISK_ACCESS_SAP;
         disk[drive].write_protect = FALSE;
         disk[drive].ReadSector = NULL;
diff --git a/src/teo.c b/src/teo.c
index ba0df67..8059e74 100644
--- a/src/teo.c
+++ b/src/teo.c
@@ -361,6 +361,8 @@ void teo_Reset(void)
  */
 void teo_ColdReset(void)
 {
+    int drive;
+
     /* initialisation du PIA 6846 système */
     mc6846_Init(&mc6846, 0x80, 0xE5, 0x3D);
 
@@ -403,6 +405,12 @@ void teo_ColdReset(void)
 
     STORE_BYTE(0x60FF, 0x00);
 
+    for (drive=0; drive<NBDRIVE; drive+=2)
+    {
+        disk[drive].drv->track.curr = 0;
+        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
+    }
+
     teo_Reset();
 }
 
-- 
2.17.1


From 319aa72b96c29c61b9e297263c2dad87b90254e8 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Sun, 8 Apr 2018 19:22:41 +0200
Subject: [PATCH 10/33] fonctions inlined and not inlined must not be mixed

---
 include/hardware.h               |  5 ++++-
 include/mc68xx/mc6821.h          | 12 ++++++++++++
 src/media/disk/controlr/thmfc1.c |  1 +
 3 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/include/hardware.h b/include/hardware.h
index fbfd262..b947631 100644
--- a/include/hardware.h
+++ b/include/hardware.h
@@ -76,7 +76,7 @@ extern struct MOTHERBOARD mb;
 
 extern mc6809_clock_t screen_clock;
 
-
+#ifndef DEBUG
 INLINE void DrawGPL(int addr)
 {
     int pt,col;
@@ -89,6 +89,9 @@ INLINE void DrawGPL(int addr)
 
     teo_DrawGPL(mode_page.lgamod, addr, pt, col);
 }
+#else
+extern void DrawGPL(int addr);
+#endif
 
 extern void hardware_Init(void);
 extern void hardware_StoreByte(int addr, int val);
diff --git a/include/mc68xx/mc6821.h b/include/mc68xx/mc6821.h
index bef34a6..857aa63 100644
--- a/include/mc68xx/mc6821.h
+++ b/include/mc68xx/mc6821.h
@@ -53,6 +53,7 @@ struct MC6821_PIA {
     struct MC6821_PORT portb;
 };
 
+#ifndef DEBUG
 
 INLINE void mc6821_WriteCommand(struct MC6821_PORT *port, int val)
 {
@@ -101,4 +102,15 @@ INLINE void mc6821_Init(struct MC6821_PORT *port, int cr, int idr)
     port->idr = idr;
 }
 
+#else
+
+extern void mc6821_WriteCommand(struct MC6821_PORT *port, int val);
+extern int mc6821_ReadCommand(struct MC6821_PORT *port);
+extern void mc6821_WriteData(struct MC6821_PORT *port, int val);
+extern int mc6821_ReadPort(struct MC6821_PORT *port);
+extern int mc6821_ReadData(struct MC6821_PORT *port);
+extern void mc6821_Init(struct MC6821_PORT *port, int cr, int idr);
+
+#endif
+
 #endif
diff --git a/src/media/disk/controlr/thmfc1.c b/src/media/disk/controlr/thmfc1.c
index 31c455a..f5324b5 100644
--- a/src/media/disk/controlr/thmfc1.c
+++ b/src/media/disk/controlr/thmfc1.c
@@ -252,6 +252,7 @@
 
 #if 0
 #define DO_PRINT  1      /* if output wanted */
+static struct MC6809_REGS regs;
 #endif
 
 static int disk_led = FALSE;
-- 
2.17.1


From 0de97c0cf6436d4fd4e30447a6a6dfc651e6406e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Mon, 9 Apr 2018 13:59:48 +0200
Subject: [PATCH 11/33] Avoiding other programs sound interferences not needed
 anymore?

If sound is silenced for $E7CF, it sounds scratched.
---
 src/hardware.c | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/src/hardware.c b/src/hardware.c
index 4cad8fd..9eaf7f2 100644
--- a/src/hardware.c
+++ b/src/hardware.c
@@ -199,10 +199,12 @@ static void SetDeviceRegister(int addr, int val)
             /* $E7C1 generates sound only if b3 state changes */
             if (((mc6846.crc&0x30) == 0x30)
              && ((mc6846.crc&8) != (data&8)))
+            {
                 teo_PutSoundByte(mc6809_clock(),
                                  mc6846.crc&8
                                    ? 0x00
                                    : (mc6821_ReadPort(&pia_ext.portb)&0x3F)<<2);
+            }
             break;
 
         case 0xE7C2:
@@ -338,9 +340,6 @@ static void SetDeviceRegister(int addr, int val)
 
         case 0xE7CF:
             mc6821_WriteCommand(&pia_ext.portb, val);
-            /* To avoid other programs sound interferences */
-            if (((val & 4) != 0) && (teo_SilenceSound != NULL))
-                teo_SilenceSound();
             break;
 
         /* Gate Array lecteur de disquettes */
-- 
2.17.1


From f8c95cfed3857d95991cc26218b4f208a461e30b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Mon, 9 Apr 2018 17:07:42 +0200
Subject: [PATCH 12/33] Restore previous state to fix commit comments

---
 src/media/disk/daccess.c | 2 ++
 src/media/disk/fd.c      | 2 ++
 src/media/disk/hfe.c     | 2 ++
 src/media/disk/sap.c     | 2 ++
 src/teo.c                | 8 --------
 5 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/src/media/disk/daccess.c b/src/media/disk/daccess.c
index 690c204..8d8c80c 100644
--- a/src/media/disk/daccess.c
+++ b/src/media/disk/daccess.c
@@ -264,6 +264,8 @@ int daccess_LoadDisk (int drive, const char filename[])
         disk[drive].track_count = TEO_DISK_DD_TRACK_NUMBER;
         disk[drive].track_size = TEO_DISK_DD_TRACK_SIZE;
         disk[drive].byte_rate = TEO_DISK_DD_BYTE_RATE;
+        disk[drive].drv->track.curr = 0;
+        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
 
         /* update parameters */
         teo.disk[drive].file = std_free (teo.disk[drive].file);
diff --git a/src/media/disk/fd.c b/src/media/disk/fd.c
index 63774d9..ad296a1 100644
--- a/src/media/disk/fd.c
+++ b/src/media/disk/fd.c
@@ -369,6 +369,8 @@ int fd_LoadDisk (int drive, const char filename[])
         }
         disk[drive].sector_size  = fd_list[fd_type].sector_size;
         disk[drive].track_count  = fd_list[fd_type].track_count;
+        disk[drive].drv->track.curr = 0;
+        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
         disk[drive].state = TEO_DISK_ACCESS_FD;
         disk[drive].write_protect = FALSE;
         disk[drive].ReadSector = NULL;
diff --git a/src/media/disk/hfe.c b/src/media/disk/hfe.c
index 9e9b264..20c6ae7 100644
--- a/src/media/disk/hfe.c
+++ b/src/media/disk/hfe.c
@@ -726,6 +726,8 @@ int hfe_LoadDisk(int drive, const char filename[])
                 break;
         }
         disk[drive].track_count = hfe_hd.number_of_track;
+        disk[drive].drv->track.curr = 0;
+        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
         disk[drive].state = TEO_DISK_ACCESS_HFE;
         disk[drive].write_protect = (hfe_hd.write_allowed != 0xff)?TRUE:FALSE;
         disk[drive].ReadSector = NULL;
diff --git a/src/media/disk/sap.c b/src/media/disk/sap.c
index b3fbd5c..0fbe4fc 100644
--- a/src/media/disk/sap.c
+++ b/src/media/disk/sap.c
@@ -494,6 +494,8 @@ int sap_LoadDisk(int drive, const char filename[])
                 disk[drive].WriteTrack = write_fm_track;
                 break;
         }
+        disk[drive].drv->track.curr = 0;
+        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
         disk[drive].state = TEO_DISK_ACCESS_SAP;
         disk[drive].write_protect = FALSE;
         disk[drive].ReadSector = NULL;
diff --git a/src/teo.c b/src/teo.c
index 8059e74..ba0df67 100644
--- a/src/teo.c
+++ b/src/teo.c
@@ -361,8 +361,6 @@ void teo_Reset(void)
  */
 void teo_ColdReset(void)
 {
-    int drive;
-
     /* initialisation du PIA 6846 système */
     mc6846_Init(&mc6846, 0x80, 0xE5, 0x3D);
 
@@ -405,12 +403,6 @@ void teo_ColdReset(void)
 
     STORE_BYTE(0x60FF, 0x00);
 
-    for (drive=0; drive<NBDRIVE; drive+=2)
-    {
-        disk[drive].drv->track.curr = 0;
-        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
-    }
-
     teo_Reset();
 }
 
-- 
2.17.1


From e216b6b7b0cc372a977849ccf83bab8f86e84e71 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Mon, 9 Apr 2018 17:08:57 +0200
Subject: [PATCH 13/33] Improvement of the disk controller (thanks to emulix75)

track.curr and track.last must not be cleared until at least a cold reset of
the computer, because the registers $6052 and $6054, which are the number of
the current track respectively for the controlers 0 and 1, needed to move the
drive heads, are not cleared until a cold reset is done.
---
 src/media/disk/daccess.c | 2 --
 src/media/disk/fd.c      | 2 --
 src/media/disk/hfe.c     | 2 --
 src/media/disk/sap.c     | 2 --
 src/teo.c                | 8 ++++++++
 5 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/src/media/disk/daccess.c b/src/media/disk/daccess.c
index 8d8c80c..690c204 100644
--- a/src/media/disk/daccess.c
+++ b/src/media/disk/daccess.c
@@ -264,8 +264,6 @@ int daccess_LoadDisk (int drive, const char filename[])
         disk[drive].track_count = TEO_DISK_DD_TRACK_NUMBER;
         disk[drive].track_size = TEO_DISK_DD_TRACK_SIZE;
         disk[drive].byte_rate = TEO_DISK_DD_BYTE_RATE;
-        disk[drive].drv->track.curr = 0;
-        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
 
         /* update parameters */
         teo.disk[drive].file = std_free (teo.disk[drive].file);
diff --git a/src/media/disk/fd.c b/src/media/disk/fd.c
index ad296a1..63774d9 100644
--- a/src/media/disk/fd.c
+++ b/src/media/disk/fd.c
@@ -369,8 +369,6 @@ int fd_LoadDisk (int drive, const char filename[])
         }
         disk[drive].sector_size  = fd_list[fd_type].sector_size;
         disk[drive].track_count  = fd_list[fd_type].track_count;
-        disk[drive].drv->track.curr = 0;
-        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
         disk[drive].state = TEO_DISK_ACCESS_FD;
         disk[drive].write_protect = FALSE;
         disk[drive].ReadSector = NULL;
diff --git a/src/media/disk/hfe.c b/src/media/disk/hfe.c
index 20c6ae7..9e9b264 100644
--- a/src/media/disk/hfe.c
+++ b/src/media/disk/hfe.c
@@ -726,8 +726,6 @@ int hfe_LoadDisk(int drive, const char filename[])
                 break;
         }
         disk[drive].track_count = hfe_hd.number_of_track;
-        disk[drive].drv->track.curr = 0;
-        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
         disk[drive].state = TEO_DISK_ACCESS_HFE;
         disk[drive].write_protect = (hfe_hd.write_allowed != 0xff)?TRUE:FALSE;
         disk[drive].ReadSector = NULL;
diff --git a/src/media/disk/sap.c b/src/media/disk/sap.c
index 0fbe4fc..b3fbd5c 100644
--- a/src/media/disk/sap.c
+++ b/src/media/disk/sap.c
@@ -494,8 +494,6 @@ int sap_LoadDisk(int drive, const char filename[])
                 disk[drive].WriteTrack = write_fm_track;
                 break;
         }
-        disk[drive].drv->track.curr = 0;
-        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
         disk[drive].state = TEO_DISK_ACCESS_SAP;
         disk[drive].write_protect = FALSE;
         disk[drive].ReadSector = NULL;
diff --git a/src/teo.c b/src/teo.c
index ba0df67..8059e74 100644
--- a/src/teo.c
+++ b/src/teo.c
@@ -361,6 +361,8 @@ void teo_Reset(void)
  */
 void teo_ColdReset(void)
 {
+    int drive;
+
     /* initialisation du PIA 6846 système */
     mc6846_Init(&mc6846, 0x80, 0xE5, 0x3D);
 
@@ -403,6 +405,12 @@ void teo_ColdReset(void)
 
     STORE_BYTE(0x60FF, 0x00);
 
+    for (drive=0; drive<NBDRIVE; drive+=2)
+    {
+        disk[drive].drv->track.curr = 0;
+        disk[drive].drv->track.last = TEO_DISK_INVALID_NUMBER;
+    }
+
     teo_Reset();
 }
 
-- 
2.17.1


From 730a9d51f2b9bd74ee5defc5c0145641d774d8a8 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Thu, 12 Apr 2018 15:26:50 +0200
Subject: [PATCH 14/33] Remove teo.desktop from cc90hfe DEBIAN

Why? Don't know. It wasn't supposed to be there.
---
 .../usr/share/applications/teo.desktop        | 656 ------------------
 1 file changed, 656 deletions(-)
 delete mode 100644 misc/pack/repo/linux/debian/cc90hfe/usr/share/applications/teo.desktop

diff --git a/misc/pack/repo/linux/debian/cc90hfe/usr/share/applications/teo.desktop b/misc/pack/repo/linux/debian/cc90hfe/usr/share/applications/teo.desktop
deleted file mode 100644
index cea5940..0000000
--- a/misc/pack/repo/linux/debian/cc90hfe/usr/share/applications/teo.desktop
+++ /dev/null
@@ -1,656 +0,0 @@
-#!/bin/bash
-
-set -e
-
-#----------------------------------------------------------------
-#
-#              Create packages for Teo and Cc90hfe
-#
-#----------------------------------------------------------------
-
-if [ `expr match $PWD '.*/teoemulator-code$'` = 0 ]
-   then
-      echo "Usage: ./misc/pack/pack.sh from teoemulator-code/ folder"
-      exit 1
-fi
-
-# always set TMPDIR to something writable into!
-if [ -z $TMPDIR ]; then
-   TMPDIR="/tmp"
-fi
-
-teo_version='1.8.4'
-cc90hfe_version='0.7.0'
-pack_dir="teoemulator-code/misc/pack"
-tmp_pack_dir="teoemulator-code/misc/pack"
-zip_options="-q -9"
-gzip_options="-9"
-
-# list of system files
-system_files="
-teo/system/icons/*.ico
-teo/system/rom/*.rom
-teo/system/printer/042/*.txt
-teo/system/printer/055/*.txt
-teo/system/printer/582/*.txt
-teo/system/printer/600/*.txt
-teo/system/printer/612/*.txt"
-
-# list of common files for executable packages + users directories
-common_exec="
-$system_files
-teo/disk
-teo/memo
-teo/cass"
-
-# list of source files
-source_files="
-$system_files
-teo/doc/wiki/*
-teo/src
-teo/include
-teo/tests
-teo/tools/sap
-teo/tools/k7tools
-teo/tools/cc90hfe/include
-teo/tools/cc90hfe/obj/linux/makefile.dep
-teo/tools/cc90hfe/obj/mingw32/makefile.dep
-teo/tools/cc90hfe/src
-teo/tools/cc90hfe/makefile.*
-teo/tools/cc90hfe/fix*.*
-teo/obj/linux/makefile.dep
-teo/obj/djgpp/makefile.dep
-teo/obj/mingw32/makefile.dep
-teo/misc/fix*.sh
-teo/misc/fixver/*.sh
-teo/misc/pack/*.txt
-teo/misc/pack/*.bat
-teo/misc/pack/*.sh
-teo/misc/pack/inno/*.iss
-teo/misc/pack/inno/*.bmp
-teo/misc/pack/debian
-teo/cc90.*
-teo/empty.hfe
-teo/change-*.log
-teo/licence-*.txt
-teo/README.txt
-teo/LISEZMOI.txt
-teo/fix*.*
-teo/makefile.*
-teo/allegro.cfg
-teo/language.dat
-teo/keyboard.dat
-teo/alleg40.dll
-teo/zlib1.dll
-teo/libpng3.dll"
-
-
-
-######################################################################
-echo "Preparing working directories..."
-#---------------------------------------------------------------------
-#   Copy to temporary folder
-#---------------------------------------------------------------------
-cd ..
-current_folder=$PWD
-pack_storage="$current_folder/$pack_dir"
-rm -f -r $TMPDIR/teo
-mkdir $TMPDIR/teo
-cp -r ./teoemulator-code/* $TMPDIR/teo
-cd $TMPDIR
-
-#---------------------------------------------------------------------
-#   Convert files from DOS to UNIX
-#---------------------------------------------------------------------
-cd teo
-chmod +x ./autogen.sh
-./autogen.sh
-cd ..
-
-#---------------------------------------------------------------------
-#   Clean user directories
-#---------------------------------------------------------------------
-rm -f -r ./disk
-rm -f -r ./memo
-rm -f -r ./cass
-#---------------------------------------------------------------------
-#   Clean package files
-#---------------------------------------------------------------------
-rm -f $pack_storage/linux/*.tar*
-rm -f $pack_storage/linux/*.deb
-rm -f $pack_storage/windows/*.zip
-rm -f $pack_storage/msdos/*.zip
-#---------------------------------------------------------------------
-#   Clean object files
-#---------------------------------------------------------------------
-rm -f -r ./teo/obj/mingw32
-rm -f -r ./teo/obj/djgpp
-rm -f -r ./teo/obj/linux
-mkdir ./teo/obj/mingw32
-mkdir ./teo/obj/djgpp
-mkdir ./teo/obj/linux
-#---------------------------------------------------------------------
-#   Force MsDos file and directory names to lowercase
-#---------------------------------------------------------------------
-name_to_lowercase()
-{
-    if [ $1 != ${1,,*} ]
-        then
-            mv $1 ${1,,*}
-    fi
-}
-
-if [ -e "teo/misc/pack/MSDOS" ]
-    then
-        name_to_lowercase "teo/misc/pack/MSDOS"
-fi
-if [ -e "teo/misc/pack/msdos/EN" ]
-    then
-        name_to_lowercase "teo/misc/pack/msdos/EN"
-fi
-if [ -e "teo/misc/pack/msdos/FR" ]
-    then
-        name_to_lowercase "teo/misc/pack/msdos/FR"
-fi
-for i in teo/misc/pack/msdos/fr/* teo/misc/pack/msdos/en/*
-    do
-         name_to_lowercase $i
-    done
-#---------------------------------------------------------------------
-#   Copy makefile.dep's
-#---------------------------------------------------------------------
-if [ -e ./teo/misc/pack/windows/fr/teo.dep ]
-    then
-        cp -f ./teo/misc/pack/windows/fr/teo.dep ./teo/obj/mingw32/makefile.dep
-fi
-if [ -e ./teo/misc/pack/msdos/fr/teo.dep ]
-    then
-        cp -f ./teo/misc/pack/msdos/fr/teo.dep ./teo/obj/djgpp/makefile.dep
-fi
-if [ -e ./teo/misc/pack/windows/fr/cc90hfe.dep ]
-    then
-        cp -f ./teo/misc/pack/windows/fr/cc90hfe.dep ./teo/tools/cc90hfe/obj/mingw32/makefile.dep
-fi
-
-
-
-######################################################################
-#---------------------------------------------------------------------
-#   Function to build DEBIAN packages
-#---------------------------------------------------------------------
-build_debian_package()
-{
-    local unpacked_size
-
-    cp ~/$1/DEBIAN/control control.tmp
-    unpacked_size=$(echo $(du -ks ~/$1) | sed 's/\([0-9]*\).*/\1/');
-    sed -e 's/Installed-Size:.*/Installed-Size: '$unpacked_size'/g' control.tmp > ~/$1/DEBIAN/control;
-    rm control.tmp
-
-    # Update permissions
-    find ~/$1 -type d -exec chmod 755 {} \;
-    find ~/$1 -type f -exec chmod 644 {} \;
-    sudo chmod +x ~/$1/usr/games/*
-    sudo chown -R root ~/$1
-    sudo chgrp -R root ~/$1
-    sudo chown $USER   ~/$1
-    sudo chgrp $USER   ~/$1
-
-    # Create DEBIAN package
-    sudo dpkg-deb --build ~/$1
-    sudo cp ~/$1.deb $2
-
-    # Clean DEBIAN file and DEBIAN folder
-    sudo rm -r -f ~/$1
-    sudo rm -r -f ~/$1.deb
-}
-
-
-
-######################################################################
-echo "Preparing executable for Teo DEBIAN..."
-#---------------------------------------------------------------------
-#   Compile Teo
-#---------------------------------------------------------------------
-cd teo
-make veryclean
-make DEBIANBUILD=1
-make depend
-cd ..
-#---------------------------------------------------------------------
-#   Compile SapTools
-#---------------------------------------------------------------------
-cd teo/tools/sap
-make clean
-make
-cd ../../..
-cp teo/tools/sap/sap2  teo/
-cp teo/tools/sap/sapfs teo/
-#---------------------------------------------------------------------
-#   Compile K7Tools
-#---------------------------------------------------------------------
-cd teo/tools/k7tools
-make clean
-make
-cd ../../..
-cp teo/tools/k7tools/wav2k7 teo/
-
-
-
-######################################################################
-echo "Creating Teo DEBIAN package..."
-prog_name=teo-$teo_version-i586
-#---------------------------------------------------------------------
-#   Transfert DEBIAN file structure
-#---------------------------------------------------------------------
-sudo rm -r -f ~/$prog_name
-cp -r $pack_storage/linux/debian/teo ~
-mv -f ~/teo ~/$prog_name
-#---------------------------------------------------------------------
-#   Create missing folders
-#---------------------------------------------------------------------
-mkdir ~/$prog_name/usr/games/
-mkdir ~/$prog_name/usr/share/doc
-mkdir ~/$prog_name/usr/share/doc/teo
-mkdir ~/$prog_name/usr/share/teo
-mkdir ~/$prog_name/usr/share/teo/system
-mkdir ~/$prog_name/usr/share/teo/doc
-mkdir ~/$prog_name/usr/share/teo/doc/images
-#---------------------------------------------------------------------
-#   Copy files into file structure
-#---------------------------------------------------------------------
-cp teo/teo            ~/$prog_name/usr/games/
-cp teo/sap2           ~/$prog_name/usr/games/
-cp teo/sapfs          ~/$prog_name/usr/games/
-cp teo/wav2k7         ~/$prog_name/usr/games/
-cp -r teo/system      ~/$prog_name/usr/share/teo
-cp teo/empty.hfe      ~/$prog_name/usr/share/teo
-cp teo/doc/images/*.* ~/$prog_name/usr/share/teo/doc/images
-cp teo/doc/doc.css    ~/$prog_name/usr/share/teo/doc
-cp teo/doc/*.htm      ~/$prog_name/usr/share/teo/doc
-cp teo/README.txt     ~/$prog_name/usr/share/doc/teo/README.txt
-cp teo/licence-en.txt ~/$prog_name/usr/share/doc/teo/copyright
-cp teo/change-en.log  ~/$prog_name/usr/share/doc/teo/changelog
-
-#---------------------------------------------------------------------
-#   Build DEBIAN package
-#---------------------------------------------------------------------
-build_debian_package $prog_name $pack_storage/linux
-
-
-
-######################################################################
-echo "Preparing executable for Cc90hfe DEBIAN..."
-#---------------------------------------------------------------------
-#   Compile Cc90hfe
-#---------------------------------------------------------------------
-cd teo/tools/cc90hfe
-./fixunix.sh
-make veryclean
-make DEBIANBUILD=1
-make depend
-cd ../../..
-
-
-
-######################################################################
-echo "Creating Cc90hfe DEBIAN package..."
-prog_name="cc90hfe-$cc90hfe_version-i586"
-#---------------------------------------------------------------------
-#   Transfert DEBIAN file structure
-#---------------------------------------------------------------------
-sudo rm -r -f ~/$prog_name
-cp -r $pack_storage/linux/debian/cc90hfe ~
-mv -f ~/cc90hfe ~/$prog_name
-#---------------------------------------------------------------------
-#   Create missing folders
-#---------------------------------------------------------------------
-mkdir ~/$prog_name/usr/games/
-mkdir ~/$prog_name/usr/share/cc90hfe
-mkdir ~/$prog_name/usr/share/cc90hfe/doc
-mkdir ~/$prog_name/usr/share/cc90hfe/doc/images
-#---------------------------------------------------------------------
-#   Copy files into file structure
-#---------------------------------------------------------------------
-cp teo/tools/cc90hfe/cc90hfe ~/$prog_name/usr/games/
-cp teo/cc90.sap              ~/$prog_name/usr/share/cc90hfe
-cp teo/cc90.fd               ~/$prog_name/usr/share/cc90hfe
-cp teo/cc90.hfe              ~/$prog_name/usr/share/cc90hfe
-cp teo/doc/doc.css           ~/$prog_name/usr/share/cc90hfe/doc
-cp teo/doc/images/*.*        ~/$prog_name/usr/share/cc90hfe/doc/images
-cp teo/doc/cc90*.htm         ~/$prog_name/usr/share/cc90hfe/doc
-move_dir="$prog_name/usr/share/cc90hfe/doc"
-mv ~/$move_dir/cc90hfe_en.htm ~/$move_dir/index.htm
-mv ~/$move_dir/cc90hfe_fr.htm ~/$move_dir/index_fr.htm
-#---------------------------------------------------------------------
-#   Build DEBIAN package
-#---------------------------------------------------------------------
-build_debian_package $prog_name $pack_storage/linux
-
-
-
-######################################################################
-echo "Creating Teo TAR.GZ package..."
-#---------------------------------------------------------------------
-#   Create media folders
-#---------------------------------------------------------------------
-mkdir teo/disk
-mkdir teo/memo
-mkdir teo/cass
-#---------------------------------------------------------------------
-#   Compile Teo
-#---------------------------------------------------------------------
-cd teo
-make veryclean
-make
-make depend
-cd ..
-#---------------------------------------------------------------------
-#   Compile saptools
-#---------------------------------------------------------------------
-cd teo/tools/sap
-make clean
-make
-cd ../../..
-cp teo/tools/sap/sap2  teo/
-cp teo/tools/sap/sapfs teo/
-#---------------------------------------------------------------------
-#    Compile k7tools
-#---------------------------------------------------------------------
-cd teo/tools/k7tools
-make clean
-make
-cd ../../..
-cp teo/tools/k7tools/wav2k7 teo/
-#---------------------------------------------------------------------
-#   Compile cc90hfe
-#---------------------------------------------------------------------
-cd teo/tools/cc90hfe
-./fixunix.sh
-make veryclean
-make
-make depend
-cd ../../..
-cp teo/tools/cc90hfe/cc90hfe teo/
-#---------------------------------------------------------------------
-#   Create executable package
-#---------------------------------------------------------------------
-exec_list="
-teo/teo
-teo/sap2
-teo/sapfs
-teo/wav2k7
-teo/cc90hfe
-teo/cc90.sap
-teo/cc90.fd
-teo/cc90.hfe
-teo/empty.hfe
-teo/doc/images/*.*
-teo/doc/*.htm
-teo/doc/*.css
-teo/change-*.log
-teo/licence-*.txt
-teo/README.txt
-teo/LISEZMOI.txt"
-pack_file="$pack_storage/linux/teo-$teo_version-i586.tar"
-tar -cf $pack_file $common_exec $exec_list
-gzip $gzip_options $pack_file
-
-
-
-######################################################################
-echo "Clean Linux executables..."
-#---------------------------------------------------------------------
-#   Clean Teo
-#---------------------------------------------------------------------
-cd teo
-make clean
-cd ..
-#---------------------------------------------------------------------
-#   Clean saptools
-#---------------------------------------------------------------------
-cd teo/tools/sap
-make clean
-cd ../../..
-rm teo/sap2
-rm teo/sapfs
-#---------------------------------------------------------------------
-#   Clean k7tools
-#---------------------------------------------------------------------
-cd teo/tools/k7tools
-make clean
-cd ../../..
-rm teo/wav2k7
-#---------------------------------------------------------------------
-#   Clean cc90hfe
-#---------------------------------------------------------------------
-cd teo/tools/cc90hfe
-make clean
-cd ../../..
-rm teo/cc90hfe
-
-echo "Creating TAR.GZ package for sources..."
-pack_doc="
-teo/doc/images/*.*
-teo/doc/*.htm
-teo/doc/*.css"
-pack_file="$pack_storage/linux/teo-$teo_version-src.tar"
-if [ -e "teo/obj/djgpp/makefile.dep" ]
-    then
-        tar -cf $pack_file $source_files $pack_doc
-        gzip $gzip_options $pack_file
-fi
-
-
-
-######################################################################
-#---------------------------------------------------------------------
-#   Convert files from UNIX to DOS / functions for docs
-#---------------------------------------------------------------------
-cd teo
-./fixdoscr.sh
-cd ..
-
-open_doc()
-{
-    local i
-    rm -f -r teo/doc_tmp
-    cp -r teo/doc teo/doc_tmp
-
-    for i in teo/doc/*.htm
-    do
-        if [ ! ${i##*_} = "$1.htm" ]
-          then
-            rm "$i"
-        fi
-    done
-    mv teo/doc/welcome_$1.htm teo/doc/index.htm
-}
-
-close_doc()
-{
-    rm -f -r teo/doc
-    mv teo/doc_tmp/ teo/doc
-}
-
-
-
-######################################################################
-#---------------------------------------------------------------------
-#   List of files to add to MsDos package
-#---------------------------------------------------------------------
-exec_list="
-teo/language.dat
-teo/keyboard.dat
-teo/teo.exe
-teo/sap2.exe
-teo/sapfs.exe
-teo/wav2k7.exe
-teo/cwsdpmi.exe
-teo/allegro.cfg
-teo/alleg40.dll
-teo/CHANGES.TXT
-teo/LICENCE.TXT
-teo/empty.hfe
-teo/doc/*.htm
-teo/doc/images/*.*
-teo/doc/*.css"
-
-
-
-######################################################################
-echo "Creating ZIP packages for MSDOS executables in French..."
-pack_file="$pack_storage/msdos/teo-$teo_version-dosexe-fr.zip"
-if [ -e "teo/misc/pack/msdos/fr/teo.exe" ]
-    then
-        open_doc "fr"
-        cp teo/misc/pack/msdos/fr/teo.exe    teo/
-        cp teo/misc/pack/msdos/fr/sap2.exe   teo/
-        cp teo/misc/pack/msdos/fr/sapfs.exe  teo/
-        cp teo/misc/pack/msdos/fr/wav2k7.exe teo/
-        cp teo/misc/pack/msdos/fr/wav2k7.exe teo/
-        cp teo/change-fr.log       teo/CHANGES.TXT
-        cp teo/licence-fr.txt      teo/LICENCE.TXT
-        zip -r $zip_options $pack_file $common_exec $exec_list LISEZMOI.txt
-        rm teo/teo.exe
-        rm teo/sap2.exe
-        rm teo/sapfs.exe
-        rm teo/wav2k7.exe
-        rm teo/CHANGES.TXT
-        rm teo/LICENCE.TXT
-        close_doc
-fi
-
-
-
-######################################################################
-echo "Creating ZIP packages for MSDOS executables in English..."
-pack_file="$pack_storage/msdos/teo-$teo_version-dosexe-en.zip"
-if [ -e "teo/misc/pack/msdos/en/teo.exe" ]
-    then
-        open_doc "en"
-        cp teo/misc/pack/msdos/en/teo.exe    teo/
-        cp teo/misc/pack/msdos/en/sap2.exe   teo/
-        cp teo/misc/pack/msdos/en/sapfs.exe  teo/
-        cp teo/misc/pack/msdos/en/wav2k7.exe teo/
-        cp teo/change-en.log       teo/CHANGES.TXT
-        cp teo/licence-en.txt      teo/LICENCE.TXT
-        zip -r $zip_options $pack_file $common_exec $exec_list README.txt
-        rm teo/teo.exe
-        rm teo/sap2.exe
-        rm teo/sapfs.exe
-        rm teo/wav2k7.exe
-        rm teo/CHANGES.TXT
-        rm teo/LICENCE.TXT
-        close_doc
-fi
-
-
-
-######################################################################
-#---------------------------------------------------------------------
-#   List of files to add to Windows package
-#---------------------------------------------------------------------
-exec_list="
-teo/language.dat
-teo/keyboard.dat
-teo/teow.exe
-teo/sap2.exe
-teo/sapfs.exe
-teo/wav2k7.exe
-teo/cc90hfe.exe
-teo/cc90hfe-com.exe
-teo/cc90.sap
-teo/cc90.fd
-teo/cc90.hfe
-teo/empty.hfe
-teo/allegro.cfg
-teo/alleg40.dll
-teo/zlib1.dll
-teo/libpng3.dll
-teo/CHANGES.TXT
-teo/LICENCE.TXT
-teo/README.TXT
-teo/doc/*.htm
-teo/doc/images/*.*
-teo/doc/*.css"
-
-
-
-######################################################################
-echo "Creating ZIP packages for Windows executables in French..."
-packFile="$pack_storage/windows/teo-$teo_version-winexe-fr.zip"
-if [ -e "teo/misc/pack/windows/fr/teow.exe" ]
-    then
-        open_doc "fr"
-        cp teo/misc/pack/windows/fr/teow.exe      teo/
-        cp teo/misc/pack/windows/fr/cc90hfe.exe   teo/
-        cp teo/misc/pack/windows/fr/cc90hfe-com.exe teo/
-        cp teo/misc/pack/msdos/fr/sap2.exe        teo/
-        cp teo/misc/pack/msdos/fr/sapfs.exe       teo/
-        cp teo/misc/pack/msdos/fr/wav2k7.exe      teo/
-        cp teo/change-fr.log  teo/CHANGES.TXT
-        cp teo/licence-fr.txt teo/LICENCE.TXT
-        zip -r $zip_options $packFile $common_exec $exec_list LISEZMOI.txt
-        rm teo/teow.exe
-        rm teo/sap2.exe
-        rm teo/sapfs.exe
-        rm teo/wav2k7.exe
-        rm teo/cc90hfe.exe
-        rm teo/cc90hfe-com.exe
-        rm teo/CHANGES.TXT
-        rm teo/LICENCE.TXT
-        close_doc
-fi
-
-
-
-######################################################################
-echo "Creating ZIP packages for Windows executables in English..."
-packFile="$pack_storage/windows/teo-$teo_version-winexe-en.zip"
-if [ -e "teo/misc/pack/windows/en/teow.exe" ]
-    then
-        open_doc "en"
-        cp teo/misc/pack/windows/en/teow.exe      teo/
-        cp teo/misc/pack/windows/en/cc90hfe.exe   teo/
-        cp teo/misc/pack/windows/en/cc90hfe-com.exe teo/
-        cp teo/misc/pack/msdos/en/sap2.exe        teo/
-        cp teo/misc/pack/msdos/en/sapfs.exe       teo/
-        cp teo/misc/pack/msdos/en/wav2k7.exe      teo/
-        cp teo/change-en.log  teo/CHANGES.TXT
-        cp teo/licence-en.txt teo/LICENCE.TXT
-        zip -r $zip_options $packFile $common_exec $exec_list README.txt
-        rm teo/teow.exe
-        rm teo/sap2.exe
-        rm teo/sapfs.exe
-        rm teo/wav2k7.exe
-        rm teo/cc90hfe.exe
-        rm teo/cc90hfe-com.exe
-        rm teo/CHANGES.TXT
-        rm teo/LICENCE.TXT
-        close_doc
-fi
-
-
-
-######################################################################
-echo "Creating ZIP package for sources..."
-packFile="$pack_storage/teo-$teo_version-src.zip"
-doc_files="
-teo/doc/*.htm
-teo/doc/images/*.*
-teo/doc/*.css"
-zip -r $zip_options $packFile $source_files $doc_files
-
-
-
-######################################################################
-echo "Clean working directories..."
-rm -r ./teo
-cd $current_folder/teoemulator-code
-
-
-
-######################################################################
-echo "Packages created in ./misc/pack/!"
-
-- 
2.17.1


From 7ddce9d13219bc1621028a0a40d4ad52ea79bd9e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fran=C3=A7ois=20Mouret?= <unknown>
Date: Sat, 14 Apr 2018 10:32:09 +0200
Subject: [PATCH 15/33] Add parent window for MessageBox() under Windows
 (thanks to emulix75)

... otherwise, the MessageBox() could not appear on screen.
---
 src/win/wmain.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/win/wmain.c b/src/win/wmain.c
index 47081fd..5458bc5 100644
--- a/src/win/wmain.c
+++ b/src/win/wmain.c
@@ -287,7 +287,7 @@ void main_DisplayMessage(const char msg[])
 {
     if (windowed_mode)
     {
-        MessageBox(NULL, (const char*)msg, is_fr?"Teo - Erreur":"Teo - Error",
+        MessageBox(prog_win, (const char*)msg, is_fr?"Teo - Erreur":"Teo - Error",
                     MB_OK | MB_ICONERROR);
     }
     else
-- 
2.17.1


From a0534955e625a56519c0032f269707f90149f46c Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Sun, 10 Jun 2018 12:45:07 +0200
Subject: [PATCH 16/33] linux: Remove unused variables
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

src/linux/udisplay.c: In function âudisplay_Initâ:
src/linux/udisplay.c:389:21: warning: unused variable âret3â [-Wunused-variable]
     int ret1, ret2, ret3;
                     ^~~~
src/linux/udisplay.c:389:15: warning: unused variable âret2â [-Wunused-variable]
     int ret1, ret2, ret3;
               ^~~~
src/linux/udisplay.c:389:9: warning: unused variable âret1â [-Wunused-variable]
     int ret1, ret2, ret3;
         ^~~~
---
 src/linux/udisplay.c | 1 -
 1 file changed, 1 deletion(-)

diff --git a/src/linux/udisplay.c b/src/linux/udisplay.c
index e124d0c..32aed1d 100644
--- a/src/linux/udisplay.c
+++ b/src/linux/udisplay.c
@@ -387,7 +387,6 @@ visibility_notify_event (GtkWidget *widget, GdkEvent *event, gpointer user_data)
 void udisplay_Init(void)
 {
     int i;
-    int ret1, ret2, ret3;
 
     /* Connexion au serveur X */
     display=gdk_x11_get_default_xdisplay();
-- 
2.17.1


From a0c4e9fac1b20d8ffc1496d03c23a4e08f0dfa73 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Sun, 10 Jun 2018 12:46:17 +0200
Subject: [PATCH 17/33] sap: Fix warning in Linux floppy backend
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

src/linux/ufloppy.c: In function âopen_floppyâ:
src/linux/ufloppy.c:104:48: warning: â%dâ directive output may be truncated writing between 1 and 11 bytes into a region of size 9 [-Wformat-truncation=]
     snprintf(dev_str, sizeof(dev_str), "/dev/fd%d", drive);
                                                ^~
src/linux/ufloppy.c:104:40: note: directive argument in the range [-1073741824, 1073741823]
     snprintf(dev_str, sizeof(dev_str), "/dev/fd%d", drive);
                                        ^~~~~~~~~~~
src/linux/ufloppy.c:104:5: note: âsnprintfâ output between 9 and 19 bytes into a destination of size 16
     snprintf(dev_str, sizeof(dev_str), "/dev/fd%d", drive);
     ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
---
 tools/sap/lfloppy.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/tools/sap/lfloppy.c b/tools/sap/lfloppy.c
index 1ad877e..e5ee986 100644
--- a/tools/sap/lfloppy.c
+++ b/tools/sap/lfloppy.c
@@ -72,6 +72,9 @@ static int OpenDrive(int drive, int density)
 {
    char dev_str[16]="";
 
+   if (drive > (1 << 5))
+       return 0;
+
    snprintf(dev_str, sizeof(dev_str), "/dev/fd%d", drive);
 
    if ((fd[drive]=open(dev_str, O_RDWR | O_NDELAY))<0)
-- 
2.17.1


From 3a4b5e7d0ee2a8fd270eb729c3515cd85b245588 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Fri, 15 Jun 2018 18:59:31 +0200
Subject: [PATCH 18/33] linux: Force the use of X11

Otherwise GTK+ would try to use the Wayland backend on Wayland, and we
would crash very early.
---
 makefile.lnx      | 4 ++--
 src/linux/umain.c | 1 +
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/makefile.lnx b/makefile.lnx
index b391335..9281fbc 100644
--- a/makefile.lnx
+++ b/makefile.lnx
@@ -41,8 +41,8 @@ ifdef DEBIANBUILD
 CFLAGS += -DDEBIAN_BUILD
 endif
 
-CFLAGS += `pkg-config gtk+-3.0 --cflags` -DGDK_VERSION_MAX_ALLOWED=GDK_VERSION_3_10 -DGDK_VERSION_MIN_REQUIRED=GDK_VERSION_3_10
-LIB = `pkg-config gtk+-3.0 --libs` -lasound -lpng -lz -lX11 -lXext
+CFLAGS += `pkg-config gtk+-x11-3.0 --cflags` -DGDK_VERSION_MAX_ALLOWED=GDK_VERSION_3_10 -DGDK_VERSION_MIN_REQUIRED=GDK_VERSION_3_10
+LIB = `pkg-config gtk+-x11-3.0 --libs` -lasound -lpng -lz -lX11 -lXext
 
 # ------ plateform-dependant objects and executables ------
 
diff --git a/src/linux/umain.c b/src/linux/umain.c
index 208fbdd..cfb10e3 100644
--- a/src/linux/umain.c
+++ b/src/linux/umain.c
@@ -303,6 +303,7 @@ int main(int argc, char *argv[])
     setlocale(LC_ALL, "");
     is_fr = (strncmp(lang,"fr",2)==0) ? -1 : 0;
 
+    g_setenv ("GDK_BACKEND", "x11", TRUE);
     gtk_init (&argc, &argv);     /* Initialisation gtk */
     ini_Load();                  /* Charge les paramètres par défaut */
     ReadCommandLine(argc, argv); /* Récupération des options */
-- 
2.17.1


From f415ade2dec61d35d8cc3b7915473ea44126d8fe Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Fri, 15 Jun 2018 22:49:08 +0200
Subject: [PATCH 19/33] Revert "linux: Remove unused variables"

This reverts commit a0534955e625a56519c0032f269707f90149f46c.
---
 src/linux/udisplay.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/linux/udisplay.c b/src/linux/udisplay.c
index 32aed1d..e124d0c 100644
--- a/src/linux/udisplay.c
+++ b/src/linux/udisplay.c
@@ -387,6 +387,7 @@ visibility_notify_event (GtkWidget *widget, GdkEvent *event, gpointer user_data)
 void udisplay_Init(void)
 {
     int i;
+    int ret1, ret2, ret3;
 
     /* Connexion au serveur X */
     display=gdk_x11_get_default_xdisplay();
-- 
2.17.1


From 1d1df1d329567b7926cc8650f7f7d0a4735ffeb6 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Tue, 19 Jun 2018 21:39:55 +0200
Subject: [PATCH 20/33] memo: Fix loading LOGO MEMO7 cartridge

Ignore leading NUL characters at the start of MEMO7 cartridges, both
when verifying the ROM, and getting its label.

Cartridges should normally start with a space character, and include a
finishing 'x40' character at the end of that label, but the LOGO ROM
seems to have leading NUL-bytes that the emulator will happily ignore
and still start the ROM.
---
 src/media/memo.c | 23 +++++++++++++++++------
 1 file changed, 17 insertions(+), 6 deletions(-)

diff --git a/src/media/memo.c b/src/media/memo.c
index 92ddb28..f6c22a7 100644
--- a/src/media/memo.c
+++ b/src/media/memo.c
@@ -102,11 +102,15 @@ int memo_IsMemo (const char filename[])
         return TEO_ERROR_MEMO_HEADER_CHECKSUM;
 
     /* first character */
-    if (memo_header[0] != ' ')
+    for (i = 0; i < 26; i++)
+        if (memo_header[i] == ' ')
+          break;
+
+    if (memo_header[i] != ' ')
         return TEO_ERROR_MEMO_HEADER_NAME;
 
     /* vérifie la présence du terminateur du nom de cartouche */
-    for (i = 1; i < 25; i++)
+    for (; i < 26; i++)
        if (memo_header[i] < ' ')
            break;
     if (memo_header[i] != '\x04')
@@ -140,7 +144,7 @@ void memo_Eject(void)
 int memo_Load(const char filename[])
 {
     int err;
-    register int i;
+    register int i, offset;
     FILE *file;
     size_t length;
     char memo_name[32] = "";
@@ -170,9 +174,16 @@ int memo_Load(const char filename[])
     fclose(file);
 
     /* récupération du label et du nom de fichier */
-    i = strcspn ((char*)mem.cart.bank[0]+1, "\04");
-    if (i>0)
-        strncpy (memo_name, (char*)mem.cart.bank[0]+1, i);
+    for (offset = 0; offset < 26; offset++)
+        if (mem.cart.bank[0][offset] != (uint8) '\0' &&
+            mem.cart.bank[0][offset] != (uint8) ' ')
+            break;
+    if (mem.cart.bank[0][offset] != (uint8) '\0')
+    {
+        i = strcspn ((char*)mem.cart.bank[0]+offset, "\04");
+        if (i>0)
+            strncpy (memo_name, (char*)mem.cart.bank[0]+offset, i);
+    }
     teo.memo.label = std_free (teo.memo.label);
     teo.memo.label = std_strdup_printf ("%s", memo_name);
     teo.memo.file  = std_free (teo.memo.file);
-- 
2.17.1


From 61a1f7a4c4ed4b4cdf824fefc2ba34cce50e6d9f Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Tue, 19 Jun 2018 21:41:03 +0200
Subject: [PATCH 21/33] memo: Fix typo in comment

---
 src/media/memo.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/media/memo.c b/src/media/memo.c
index f6c22a7..ac195a4 100644
--- a/src/media/memo.c
+++ b/src/media/memo.c
@@ -149,7 +149,7 @@ int memo_Load(const char filename[])
     size_t length;
     char memo_name[32] = "";
 
-    /* vérificiation du format de la cartouche */
+    /* vérification du format de la cartouche */
     if ((err = memo_IsMemo(filename)) < 0)
         return error_Message(err, filename);
 
-- 
2.17.1


From 04e65bb37dcf952a23366e9517f3483e336eb118 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Tue, 19 Jun 2018 21:38:42 +0200
Subject: [PATCH 22/33] linux: Fix crash when initialising colours

When run in debug mode under valgrind, we crash because we try to
initialise the flags of the wrong colour array.

==23613== Invalid write of size 1
==23613==    at 0x42381E: BuildXColorBuffer (ugraphic.c:94)
==23613==    by 0x424F80: ugraphic_Init (ugraphic.c:586)
==23613==    by 0x425EEE: main (umain.c:342)
==23613==  Address 0x65b00e is not stack'd, malloc'd or (recently) free'd
==23613==
==23613==
==23613== Process terminating with default action of signal 11 (SIGSEGV): dumping core
==23613==  Access not within mapped region at address 0x65B00E
==23613==    at 0x42381E: BuildXColorBuffer (ugraphic.c:94)
==23613==    by 0x424F80: ugraphic_Init (ugraphic.c:586)
==23613==    by 0x425EEE: main (umain.c:342)
---
 src/linux/ugraphic.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/linux/ugraphic.c b/src/linux/ugraphic.c
index 591b02e..ad1ebd3 100644
--- a/src/linux/ugraphic.c
+++ b/src/linux/ugraphic.c
@@ -90,7 +90,7 @@ static void BuildXColorBuffer(void)
     	xcolorBuf[index].red   = 0x101*gamma[r];
     	xcolorBuf[index].green = 0x101*gamma[g];
     	xcolorBuf[index].blue  = 0x101*gamma[b];
-	xcolor[index].flags=DoRed|DoGreen|DoBlue;
+	xcolorBuf[index].flags=DoRed|DoGreen|DoBlue;
         XAllocColor(display, colormap, &xcolorBuf[index]);
     }
 
-- 
2.17.1


From 03cf92ba35309302a3cb4d015683c392bb1b9335 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Thu, 21 Jun 2018 15:05:10 +0200
Subject: [PATCH 23/33] linux: Remove Version entry from desktop file

The version field is for the version of the desktop entry specification
that the desktop file conforms to, not the version of the software:
https://specifications.freedesktop.org/desktop-entry-spec/desktop-entry-spec-latest.html#recognized-keys

"
Version of the Desktop Entry Specification that the desktop entry conforms
with. Entries that confirm with this version of the specification should
use 1.1. Note that the version field is not required to be present.
"
---
 .../repo/linux/debian/teo/usr/share/applications/teo.desktop     | 1 -
 1 file changed, 1 deletion(-)

diff --git a/misc/pack/repo/linux/debian/teo/usr/share/applications/teo.desktop b/misc/pack/repo/linux/debian/teo/usr/share/applications/teo.desktop
index 5b9d8bd..06aa84d 100644
--- a/misc/pack/repo/linux/debian/teo/usr/share/applications/teo.desktop
+++ b/misc/pack/repo/linux/debian/teo/usr/share/applications/teo.desktop
@@ -1,5 +1,4 @@
 [Desktop Entry]
-Version=1.8.5
 Name=Teo emulator
 Name[fr]=Emulateur Teo
 GenericName=Teo emulator
-- 
2.17.1


From 7e4d211f755657b8b944afc290651650e0176493 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Thu, 21 Jun 2018 15:15:08 +0200
Subject: [PATCH 24/33] misc: Remove Version change in teo.sh

As we've shown, the Version field in the desktop file isn't the
application's version, so don't try to change it.
---
 misc/fixver/teo.sh | 2 --
 1 file changed, 2 deletions(-)

diff --git a/misc/fixver/teo.sh b/misc/fixver/teo.sh
index 557d30b..3010115 100755
--- a/misc/fixver/teo.sh
+++ b/misc/fixver/teo.sh
@@ -98,8 +98,6 @@ echo "s/^\#define TEOVERSION\([ \t]*\)\(['\"]\)[0-9\.]*['\"]\(.*\)/\#define TEOV
 sed_file misc/pack/repo/windows/inno/teo-setup.iss
 echo "s/^teo_version=[ \t]*\(['\"]\)[0-9\.]*['\"]\(.*\)/teo_version=\1$verstr\1\2/" > $TMPDIR/fixver.sed
 sed_file misc/pack/pack.sh
-echo "s/^Version[ \t]*=[ \t]*[0-9\.]*/Version=$verstr/" > $TMPDIR/fixver.sed
-sed_file misc/pack/repo/linux/debian/teo/usr/share/applications/teo.desktop
 echo "s/^Version[ \t]*:[ \t]*[0-9\.]*/Version: $verstr/" > $TMPDIR/fixver.sed
 sed_file misc/pack/repo/linux/debian/teo/DEBIAN/control
 
-- 
2.17.1


From c8c21b160892111fbe9dfb37ff6d32e268c2245e Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Thu, 21 Jun 2018 15:14:01 +0200
Subject: [PATCH 25/33] linux: Rename desktop and icon files

To be namespaced as expected from modern Linux applications. This makes
sure that Teo's name is unique amongst applications.
---
 .../{teo.desktop => net.sourceforge.Teo.desktop}    |   2 +-
 .../pixmaps/{teo.png => net.sourceforge.Teo.png}    | Bin
 2 files changed, 1 insertion(+), 1 deletion(-)
 rename misc/pack/repo/linux/debian/teo/usr/share/applications/{teo.desktop => net.sourceforge.Teo.desktop} (94%)
 rename misc/pack/repo/linux/debian/teo/usr/share/pixmaps/{teo.png => net.sourceforge.Teo.png} (100%)

diff --git a/misc/pack/repo/linux/debian/teo/usr/share/applications/teo.desktop b/misc/pack/repo/linux/debian/teo/usr/share/applications/net.sourceforge.Teo.desktop
similarity index 94%
rename from misc/pack/repo/linux/debian/teo/usr/share/applications/teo.desktop
rename to misc/pack/repo/linux/debian/teo/usr/share/applications/net.sourceforge.Teo.desktop
index 06aa84d..9346ab7 100644
--- a/misc/pack/repo/linux/debian/teo/usr/share/applications/teo.desktop
+++ b/misc/pack/repo/linux/debian/teo/usr/share/applications/net.sourceforge.Teo.desktop
@@ -10,7 +10,7 @@ MimeType=application/x-sap-file;application/x-hfe-file;application/x-fd-file;
 Categories=GNOME;GTK;Game;Emulator;
 Exec=/usr/games/teo
 Terminal=false
-Icon=teo.png
+Icon=net.sourceforge.Teo.png
 X-Ayatana-Desktop-Shortcuts=Reset;
 
 [Reset Shortcut Group]
diff --git a/misc/pack/repo/linux/debian/teo/usr/share/pixmaps/teo.png b/misc/pack/repo/linux/debian/teo/usr/share/pixmaps/net.sourceforge.Teo.png
similarity index 100%
rename from misc/pack/repo/linux/debian/teo/usr/share/pixmaps/teo.png
rename to misc/pack/repo/linux/debian/teo/usr/share/pixmaps/net.sourceforge.Teo.png
-- 
2.17.1


From 4efe6e93a0458a98a7b2db28f8ea9bf89de6096a Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Thu, 21 Jun 2018 16:00:50 +0200
Subject: [PATCH 26/33] linux: Add AppStream metadata

This will be used in interfaces like GNOME Software to present
third-party applications.
---
 .../metainfo/net.sourceforge.Teo.appdata.xml  | 25 +++++++++++++++++++
 1 file changed, 25 insertions(+)
 create mode 100644 misc/pack/repo/linux/debian/teo/usr/share/metainfo/net.sourceforge.Teo.appdata.xml

diff --git a/misc/pack/repo/linux/debian/teo/usr/share/metainfo/net.sourceforge.Teo.appdata.xml b/misc/pack/repo/linux/debian/teo/usr/share/metainfo/net.sourceforge.Teo.appdata.xml
new file mode 100644
index 0000000..74ce234
--- /dev/null
+++ b/misc/pack/repo/linux/debian/teo/usr/share/metainfo/net.sourceforge.Teo.appdata.xml
@@ -0,0 +1,25 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- Copyright 2018 Bastien Nocera <hadess@hadess.net> -->
+<component type="desktop">
+  <id>net.sourceforge.Teo.desktop</id>
+  <name>Teo</name>
+  <name xml:lang="fr">Teo</name>
+  <summary>Thomson TO8D emulator</summary>
+  <summary xml:lang="fr">Ãmulateur Thomson TO8D</summary>
+  <metadata_license>CC0-1.0</metadata_license>
+  <project_license>GPL-2.0+</project_license>
+  <description>
+    <p>
+      Teo is an emulator of the Thomson TO8D 8-bit micro-computer.
+    </p>
+    <p xml:lang="fr">Teo est un Ã©mulateur de l'ordinateur 8-bits Thomson TO8D.</p>
+  </description>
+  <url type="homepage">https://sourceforge.net/projects/teoemulator/</url>
+  <screenshots>
+    <screenshot type="default" width="354" height="234">https://a.fsdn.com/con/app/proj/teoemulator/screenshots/teo.png/max/max/1</screenshot>
+    <screenshot type="default" width="354" height="234">https://a.fsdn.com/con/app/proj/teoemulator/screenshots/teos2.png/max/max/1</screenshot>
+    <screenshot type="default" width="354" height="234">https://a.fsdn.com/con/app/proj/teoemulator/screenshots/teos3.png/max/max/1</screenshot>
+    <screenshot type="default" width="354" height="234">https://a.fsdn.com/con/app/proj/teoemulator/screenshots/teos4.png/max/max/1</screenshot>
+  </screenshots>
+  <updatecontact>hadess@hadess.net</updatecontact>
+</component>
-- 
2.17.1


From 8f16a7188d109099c131addb823909ca8dce23f6 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Thu, 21 Jun 2018 16:08:36 +0200
Subject: [PATCH 27/33] linux: Remove extension from Icon entry in .desktop
 file

From desktop-file-validate:
WARNING: Failed to validate desktop file ...share/applications/net.sourceforge.Teo.desktop:
...share/applications/net.sourceforge.Teo.desktop: error: (will be
fatal in the future): value "net.sourceforge.Teo.png" for key "Icon"
in group "Desktop Entry" is an icon name with an extension, but there
should be no extension as described in the Icon Theme Specification if
the value is not an absolute path
---
 .../teo/usr/share/applications/net.sourceforge.Teo.desktop      | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/misc/pack/repo/linux/debian/teo/usr/share/applications/net.sourceforge.Teo.desktop b/misc/pack/repo/linux/debian/teo/usr/share/applications/net.sourceforge.Teo.desktop
index 9346ab7..22dc210 100644
--- a/misc/pack/repo/linux/debian/teo/usr/share/applications/net.sourceforge.Teo.desktop
+++ b/misc/pack/repo/linux/debian/teo/usr/share/applications/net.sourceforge.Teo.desktop
@@ -10,7 +10,7 @@ MimeType=application/x-sap-file;application/x-hfe-file;application/x-fd-file;
 Categories=GNOME;GTK;Game;Emulator;
 Exec=/usr/games/teo
 Terminal=false
-Icon=net.sourceforge.Teo.png
+Icon=net.sourceforge.Teo
 X-Ayatana-Desktop-Shortcuts=Reset;
 
 [Reset Shortcut Group]
-- 
2.17.1


From 982e6cd082bed2dd019575020aba27ccf20ac046 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Fri, 22 Jun 2018 12:48:21 +0200
Subject: [PATCH 28/33] linux: Update mime-types with upstream

All the mime-types used by Teo are now upstream, including aliases for
the old mime-types Teo used. The teo.xml mime-type file now includes all
those upstream changes.

This also adds cassette and Memo7 mime-types as handled through the
.desktop file so cassettes and cartridges can be launched from
the file manager directly.
---
 .../applications/net.sourceforge.Teo.desktop  |  2 +-
 .../teo/usr/share/mime/packages/teo.xml       | 63 +++++++++++--------
 2 files changed, 39 insertions(+), 26 deletions(-)

diff --git a/misc/pack/repo/linux/debian/teo/usr/share/applications/net.sourceforge.Teo.desktop b/misc/pack/repo/linux/debian/teo/usr/share/applications/net.sourceforge.Teo.desktop
index 22dc210..278a954 100644
--- a/misc/pack/repo/linux/debian/teo/usr/share/applications/net.sourceforge.Teo.desktop
+++ b/misc/pack/repo/linux/debian/teo/usr/share/applications/net.sourceforge.Teo.desktop
@@ -6,7 +6,7 @@ GenericName[fr]=Emulateur Teo
 Comment=TO8D microcomputer emulator
 Comment[fr]=Emulateur de l'ordinateur TO8D
 Type=Application
-MimeType=application/x-sap-file;application/x-hfe-file;application/x-fd-file;
+MimeType=application/x-thomson-sap-image;application/x-hfe-floppy-image;application/x-raw-floppy-disk-image;application/x-thomson-cartridge-memo7;application/x-thomson-cassette;
 Categories=GNOME;GTK;Game;Emulator;
 Exec=/usr/games/teo
 Terminal=false
diff --git a/misc/pack/repo/linux/debian/teo/usr/share/mime/packages/teo.xml b/misc/pack/repo/linux/debian/teo/usr/share/mime/packages/teo.xml
index 760b378..bcbc667 100644
--- a/misc/pack/repo/linux/debian/teo/usr/share/mime/packages/teo.xml
+++ b/misc/pack/repo/linux/debian/teo/usr/share/mime/packages/teo.xml
@@ -1,29 +1,42 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info">
-
-	<!-- SAP files -->
-	<mime-type type="application/x-sap-file">
-		<comment>SAP format for Teo</comment>
-		<acronym>SAP</acronym>
-		<glob weight="50" pattern="*.sap"/>
-		<glob weight="50" pattern="*.SAP"/>
-	</mime-type>
-
-	<!-- HFE files -->
-	<mime-type type="application/x-hfe-file">
-		<comment>HFE format for Teo</comment>
-		<acronym>HFE</acronym>
-		<glob weight="50" pattern="*.hfe"/>
-		<glob weight="50" pattern="*.HFE"/>
-	</mime-type>
-
-	<!-- FD files -->
-	<mime-type type="application/x-fd-file">
-		<comment>FD format for Teo</comment>
-		<acronym>FD</acronym>
-		<glob weight="50" pattern="*.fd"/>
-		<glob weight="50" pattern="*.FD"/>
-	</mime-type>
-
+  <mime-type type="application/x-thomson-cartridge-memo7">
+    <_comment>Thomson MÃ©mo7 cartridge</_comment>
+    <generic-icon name="application-x-executable"/>
+    <glob pattern="*.m7"/>
+  </mime-type>
+  <mime-type type="application/x-thomson-cassette">
+    <_comment>Thomson cassette</_comment>
+    <generic-icon name="application-x-executable"/>
+    <glob pattern="*.k7"/>
+  </mime-type>
+  <mime-type type="application/x-hfe-floppy-image">
+    <_comment>HFE floppy disk image</_comment>
+    <acronym>HFE</acronym>
+    <expanded-acronym>HxC Floppy Emulator</expanded-acronym>
+    <generic-icon name="application-x-executable"/>
+    <glob pattern="*.hfe"/>
+    <magic>
+      <match offset="0" type="string" value="HXCPICFE"/>
+    </magic>
+    <alias type="application/x-hfe-file"/>
+  </mime-type>
+  <mime-type type="application/x-thomson-sap-image">
+    <_comment>SAP Thomson floppy disk image</_comment>
+    <acronym>SAP</acronym>
+    <expanded-acronym>SystÃ¨me d'Archivage Pukall</expanded-acronym>
+    <generic-icon name="application-x-executable"/>
+    <glob pattern="*.sap"/>
+    <magic>
+      <match offset="1" type="string" value="SYSTEME D'ARCHIVAGE PUKALL S.A.P. (c) Alexandre PUKALL Avril 1998"/>
+    </magic>
+    <alias type="application/x-sap-file"/>
+  </mime-type>
+  <mime-type type="application/x-raw-floppy-disk-image">
+    <_comment>Floppy disk image</_comment>
+    <sub-class-of type="application/x-raw-disk-image"/>
+    <alias type="application/x-fd-file"/>
+    <glob pattern="*.fd"/>
+  </mime-type>
 </mime-info>
 
-- 
2.17.1


From 33712a88dea2f29421815519e1970c25b3e2aa17 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Fri, 22 Jun 2018 12:51:36 +0200
Subject: [PATCH 29/33] media: Make list of floppy types extensible

Replace magic number "7" with a macro.
---
 src/media/disk/fd.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/src/media/disk/fd.c b/src/media/disk/fd.c
index 63774d9..845d7de 100644
--- a/src/media/disk/fd.c
+++ b/src/media/disk/fd.c
@@ -81,7 +81,8 @@ static struct FD_LIST fd_list[] = {
 static int fd_type = 3;
 static uint8 sector_buffer[TEO_DISK_DD_SECTOR_SIZE];
 
-
+#define N_ELEMENTS(arr) (sizeof (arr) / sizeof ((arr)[0]))
+#define NUM_FD_TYPES N_ELEMENTS(fd_list)
 
 #ifdef DO_PRINT
 /* display_track :
@@ -301,7 +302,7 @@ static int file_protection (const char filename[], int protection)
         /* check size of file */
         file_size = std_FileSize(filename);
         for (fd_type=0; file_size != fd_list[fd_type].file_size; fd_type++)
-           if (fd_type == 7)
+           if (fd_type == (NUM_FD_TYPES - 1))
                return error_Message (TEO_ERROR_FILE_FORMAT, filename);
 
         /* check name of file */
-- 
2.17.1


From 8e9ed29c0a0f609bd3c7da0cfbbd342b0a57bd23 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Fri, 22 Jun 2018 16:16:36 +0200
Subject: [PATCH 30/33] appdata: Add OARS metadata

From the Open Age Ratings Service:
https://hughsie.github.io/oars/
---
 .../teo/usr/share/metainfo/net.sourceforge.Teo.appdata.xml       | 1 +
 1 file changed, 1 insertion(+)

diff --git a/misc/pack/repo/linux/debian/teo/usr/share/metainfo/net.sourceforge.Teo.appdata.xml b/misc/pack/repo/linux/debian/teo/usr/share/metainfo/net.sourceforge.Teo.appdata.xml
index 74ce234..09ac215 100644
--- a/misc/pack/repo/linux/debian/teo/usr/share/metainfo/net.sourceforge.Teo.appdata.xml
+++ b/misc/pack/repo/linux/debian/teo/usr/share/metainfo/net.sourceforge.Teo.appdata.xml
@@ -22,4 +22,5 @@
     <screenshot type="default" width="354" height="234">https://a.fsdn.com/con/app/proj/teoemulator/screenshots/teos4.png/max/max/1</screenshot>
   </screenshots>
   <updatecontact>hadess@hadess.net</updatecontact>
+  <content_rating type="oars-1.0" />
 </component>
-- 
2.17.1


From a12b70c9be24da807c0c05395b632bc4d346a6f4 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Sat, 23 Jun 2018 16:48:18 +0200
Subject: [PATCH 31/33] linux: Add another glob for Raw Floppy Disk Images

To support *.qd files as well as *.fd
---
 misc/pack/repo/linux/debian/teo/usr/share/mime/packages/teo.xml | 1 +
 1 file changed, 1 insertion(+)

diff --git a/misc/pack/repo/linux/debian/teo/usr/share/mime/packages/teo.xml b/misc/pack/repo/linux/debian/teo/usr/share/mime/packages/teo.xml
index bcbc667..6469d7b 100644
--- a/misc/pack/repo/linux/debian/teo/usr/share/mime/packages/teo.xml
+++ b/misc/pack/repo/linux/debian/teo/usr/share/mime/packages/teo.xml
@@ -37,6 +37,7 @@
     <sub-class-of type="application/x-raw-disk-image"/>
     <alias type="application/x-fd-file"/>
     <glob pattern="*.fd"/>
+    <glob pattern="*.qd"/>
   </mime-type>
 </mime-info>
 
-- 
2.17.1


From 95c4bd43b7e20df5217b963930235eb8de7c64a0 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Sat, 23 Jun 2018 16:49:11 +0200
Subject: [PATCH 32/33] linux: Use mime-types instead of patterns

Those will be more precise, as magic might be applied, and the
mime-types we ship are sufficiently new to cover this usage.
---
 src/linux/ugui/ucass.c |  3 +--
 src/linux/ugui/udisk.c | 11 +++--------
 src/linux/ugui/umemo.c |  3 +--
 3 files changed, 5 insertions(+), 12 deletions(-)

diff --git a/src/linux/ugui/ucass.c b/src/linux/ugui/ucass.c
index c9657f1..b4f2a81 100644
--- a/src/linux/ugui/ucass.c
+++ b/src/linux/ugui/ucass.c
@@ -332,8 +332,7 @@ static void open_file (GtkButton *button, gpointer data)
                  is_fr?"_Ouvrir":"_Open", GTK_RESPONSE_ACCEPT, NULL);
         filter = gtk_file_filter_new ();
         gtk_file_filter_set_name (filter, is_fr?"Fichiers cassette (.k7)":"Tape files (.k7)");
-        gtk_file_filter_add_pattern (filter, "*.k7");
-        gtk_file_filter_add_pattern (filter, "*.K7");
+        gtk_file_filter_add_mime_type (filter, "application/x-thomson-cassette");
         gtk_file_chooser_add_filter ((GtkFileChooser *)dialog, filter);
 
         /* Attend que le dialog ait tout assimilé */
diff --git a/src/linux/ugui/udisk.c b/src/linux/ugui/udisk.c
index d06f066..d6e9c8a 100644
--- a/src/linux/ugui/udisk.c
+++ b/src/linux/ugui/udisk.c
@@ -317,14 +317,9 @@ static void open_file (GtkButton *button, struct FILE_VECTOR *vector)
         filter = gtk_file_filter_new ();
         gtk_file_filter_set_name (filter, is_fr?"Fichiers disquette"
                                                :"Disk files");
-        gtk_file_filter_add_pattern (filter, "*.sap");
-        gtk_file_filter_add_pattern (filter, "*.SAP");
-        gtk_file_filter_add_pattern (filter, "*.hfe");
-        gtk_file_filter_add_pattern (filter, "*.HFE");
-        gtk_file_filter_add_pattern (filter, "*.fd");
-        gtk_file_filter_add_pattern (filter, "*.FD");
-        gtk_file_filter_add_pattern (filter, "*.qd");
-        gtk_file_filter_add_pattern (filter, "*.QD");
+        gtk_file_filter_add_mime_type (filter, "application/x-thomson-sap-image");
+        gtk_file_filter_add_mime_type (filter, "application/x-hfe-floppy-image");
+        gtk_file_filter_add_mime_type (filter, "application/x-raw-floppy-disk-image");
         gtk_file_chooser_add_filter ((GtkFileChooser *)dialog, filter);
 
         /* Attend que le dialog ait tout assimilé */
diff --git a/src/linux/ugui/umemo.c b/src/linux/ugui/umemo.c
index 067e451..b81de33 100644
--- a/src/linux/ugui/umemo.c
+++ b/src/linux/ugui/umemo.c
@@ -210,8 +210,7 @@ static void open_file (GtkButton *button, gpointer data)
                  is_fr?"_Ouvrir":"_Open", GTK_RESPONSE_ACCEPT, NULL);
         filter = gtk_file_filter_new ();
         gtk_file_filter_set_name (filter, is_fr?"Fichiers cartouche (.m7)":"Cartridge files (.m7)");
-        gtk_file_filter_add_pattern (filter, "*.m7");
-        gtk_file_filter_add_pattern (filter, "*.M7");
+        gtk_file_filter_add_mime_type (filter, "application/x-thomson-cartridge-memo7");
         gtk_file_chooser_add_filter ((GtkFileChooser *)dialog, filter);
 
         /* Attend que le dialog ait tout assimilé */
-- 
2.17.1


From bf1f757ad5e410c515f3e40aa218d4e8bead8da7 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Sat, 23 Jun 2018 16:50:18 +0200
Subject: [PATCH 33/33] cc90hfe: Use mime-types for filters on Linux

---
 tools/cc90hfe/src/linux/gui/archive.c | 3 +--
 tools/cc90hfe/src/linux/gui/extract.c | 3 +--
 2 files changed, 2 insertions(+), 4 deletions(-)

diff --git a/tools/cc90hfe/src/linux/gui/archive.c b/tools/cc90hfe/src/linux/gui/archive.c
index 54520a1..d0ab640 100644
--- a/tools/cc90hfe/src/linux/gui/archive.c
+++ b/tools/cc90hfe/src/linux/gui/archive.c
@@ -72,8 +72,7 @@ static char *open_write_hfe_file (void)
     /* add filters */
     filter = gtk_file_filter_new ();
     gtk_file_filter_set_name (filter, is_fr?"Fichiers HFE":"HFE files");
-    gtk_file_filter_add_pattern (filter, "*.hfe");
-    gtk_file_filter_add_pattern (filter, "*.HFE");
+    gtk_file_filter_add_mime_type (filter, "application/x-hfe-floppy-image");
     gtk_file_chooser_add_filter (GTK_FILE_CHOOSER (dialog), filter);
 
     /* waits for construction to be finished */
diff --git a/tools/cc90hfe/src/linux/gui/extract.c b/tools/cc90hfe/src/linux/gui/extract.c
index 988c30b..cdb7278 100644
--- a/tools/cc90hfe/src/linux/gui/extract.c
+++ b/tools/cc90hfe/src/linux/gui/extract.c
@@ -73,8 +73,7 @@ static char *open_read_hfe_file (void)
     /* add filters */
     filter = gtk_file_filter_new ();
     gtk_file_filter_set_name (filter, is_fr?"Fichiers HFE":"HFE files");
-    gtk_file_filter_add_pattern (filter, "*.hfe");
-    gtk_file_filter_add_pattern (filter, "*.HFE");
+    gtk_file_filter_add_mime_type (filter, "application/x-hfe-floppy-image");
     gtk_file_chooser_add_filter (GTK_FILE_CHOOSER (dialog), filter);
 
     /* waits for construction to be finished */
-- 
2.17.1

